<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <!-- iOS Optimizations -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" sizes="180x180" href="logo-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logo-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logo-120.png">
    <style>
        /* ═══════════════════════════════════════════════════════════════
       iOS OPTIMIZATIONS
       ═══════════════════════════════════════════════════════════════ */
        body {
            overscroll-behavior-y: contain;
            /* 3. Scroll Bounce */
            -webkit-overflow-scrolling: touch;
        }

        input,
        select,
        textarea {
            font-size: 16px !important;
            /* 4. Input Focus Zoom */
        }

        /* 7. Performance Optimizations */
        .card:hover {
            transform: translateY(-2px);
            will-change: transform;
        }

        /* 6. Dark Mode Auto-Detection */
    </style>
</head>

<body>
    <style>
        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC DESIGN SYSTEM - Soft UI v1.0
   Tüm uygulama için Neumorphic tasarım stilleri
   ═══════════════════════════════════════════════════════════════════════════ */

        :root {
            /* ─── Neumorphic Base Colors ─── */
            --nm-bg: #dde2e9;
            --nm-bg-secondary: #d1d9e6;
            --nm-text: #2d3436;
            --nm-text-secondary: #636e72;

            /* ─── Neumorphic Shadows - Light Mode ─── */
            --nm-shadow-light: -6px -6px 14px rgba(255, 255, 255, 0.7);
            --nm-shadow-dark: 6px 6px 14px rgba(163, 177, 198, 0.5);
            --nm-shadow-light-sm: -3px -3px 7px rgba(255, 255, 255, 0.7);
            --nm-shadow-dark-sm: 3px 3px 7px rgba(163, 177, 198, 0.5);

            /* ─── Neumorphic Inset Shadows ─── */
            --nm-inset-light: inset -4px -4px 8px rgba(255, 255, 255, 0.7);
            --nm-inset-dark: inset 4px 4px 8px rgba(163, 177, 198, 0.5);

            /* ─── Accent Colors (Kırmızı/Mavi) ─── */
            --nm-accent-red: #e74c3c;
            --nm-accent-red-gradient: linear-gradient(145deg, #ff6b6b, #e74c3c);
            --nm-accent-blue: #3498db;
            --nm-accent-blue-gradient: linear-gradient(145deg, #74b9ff, #3498db);
            --nm-accent-green: #27ae60;
            --nm-accent-green-gradient: linear-gradient(145deg, #55efc4, #27ae60);
            --nm-accent-yellow: #f39c12;

            /* ─── Border Radius ─── */
            --nm-radius-sm: 12px;
            --nm-radius-md: 20px;
            --nm-radius-lg: 28px;
            --nm-radius-pill: 50px;
        }

        /* ─── Dark Mode Variables ─── */
        html.dark {
            --nm-bg: #0f1629;
            --nm-bg-secondary: #1e293b;
            --nm-text: #f1f5f9;
            --nm-text-secondary: #94a3b8;

            /* Karanlık modda beyaz ışık - Depth Effect için eklendi */
            --nm-shadow-light: -4px -4px 12px rgba(255, 255, 255, 0.03);
            --nm-shadow-dark: 6px 6px 16px rgba(0, 0, 0, 0.6);
            --nm-shadow-light-sm: -3px -3px 8px rgba(255, 255, 255, 0.03);
            --nm-shadow-dark-sm: 4px 4px 12px rgba(0, 0, 0, 0.4);

            --nm-inset-light: inset -2px -2px 6px rgba(255, 255, 255, 0.03);
            --nm-inset-dark: inset 4px 4px 10px rgba(0, 0, 0, 0.5);

            /* Karanlık mod için özel border */
            --nm-border: 1px solid rgba(255, 255, 255, 0.06);
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   BODY & BACKGROUND
   ═══════════════════════════════════════════════════════════════════════════ */
        body {
            background: var(--nm-bg) !important;
            color: var(--nm-text) !important;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Override existing backgrounds */
        .app-container,
        #app,
        main,
        [data-page] {
            background: var(--nm-bg) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC CARDS
   ═══════════════════════════════════════════════════════════════════════════ */
        .glass-card,
        .glass-card-strong,
        .card,
        .weekly-comparison-card,
        .savings-suggestion-card,
        .filter-modal-content,
        .fingo-analytics-modal,
        [class*="card"] {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-md) !important;
            box-shadow: var(--nm-shadow-dark), var(--nm-shadow-light) !important;
            border: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        /* Card hover effect */
        .glass-card:hover,
        .card:hover,
        [class*="card"]:hover {
            box-shadow: 8px 8px 18px rgba(163, 177, 198, 0.55), -8px -8px 18px rgba(255, 255, 255, 0.75) !important;
        }

        html.dark .glass-card:hover,
        html.dark .card:hover {
            box-shadow: 10px 10px 24px rgba(0, 0, 0, 0.5) !important;
            border: var(--nm-border) !important;
        }

        /* Pressed/Active card state */
        .card.active,
        .glass-card.active,
        [class*="card"].active {
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC BUTTONS
   ═══════════════════════════════════════════════════════════════════════════ */
        button,
        .btn,
        [class*="btn-"],
        .action-btn,
        .nav-item,
        .filter-chip {
            background: var(--nm-bg) !important;
            border-radius: 10px !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            border: none !important;
            color: var(--nm-text) !important;
            transition: all 0.2s ease !important;
            cursor: pointer;
        }

        button:hover,
        .btn:hover,
        [class*="btn-"]:hover {
            box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.55), -5px -5px 10px rgba(255, 255, 255, 0.75) !important;
        }

        /* Avatar ve + butonu için kare gölge kaldırma */
        .w-14.h-14.rounded-full.flex.items-center.justify-center {
            border-radius: 50% !important;
            box-shadow: none !important;
            background: transparent !important;
        }

        #nav-add {
            border-radius: 50% !important;
            box-shadow: none !important;
            background: transparent !important;
        }

        html.dark button:hover,
        html.dark .btn:hover {
            box-shadow: 6px 6px 14px rgba(0, 0, 0, 0.5) !important;
        }

        /* Pressed state - inset shadow */
        button:active,
        .btn:active,
        [class*="btn-"]:active {
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            transform: scale(0.98);
        }

        /* Primary Button (Blue) */
        .btn-primary,
        button[type="submit"],
        .action-btn-primary,
        .primary-btn {
            background: var(--nm-accent-blue-gradient) !important;
            color: white !important;
            box-shadow: 4px 4px 12px rgba(52, 152, 219, 0.4), -2px -2px 8px rgba(255, 255, 255, 0.3) !important;
        }

        .btn-primary:hover,
        button[type="submit"]:hover {
            box-shadow: 6px 6px 16px rgba(52, 152, 219, 0.5), -3px -3px 10px rgba(255, 255, 255, 0.4) !important;
        }

        /* Danger Button (Red) */
        .btn-danger,
        .delete-btn,
        .remove-btn {
            background: var(--nm-accent-red-gradient) !important;
            color: white !important;
            box-shadow: 4px 4px 12px rgba(231, 76, 60, 0.4), -2px -2px 8px rgba(255, 255, 255, 0.3) !important;
        }

        /* Success Button (Green) */
        .btn-success,
        .save-btn,
        .confirm-btn {
            background: var(--nm-accent-green-gradient) !important;
            color: white !important;
            box-shadow: 4px 4px 12px rgba(39, 174, 96, 0.4), -2px -2px 8px rgba(255, 255, 255, 0.3) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC INPUT FIELDS
   ═══════════════════════════════════════════════════════════════════════════ */
        input,
        textarea,
        select,
        .input-field {
            background: var(--nm-bg) !important;
            border: none !important;
            border-radius: var(--nm-radius-sm) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            color: var(--nm-text) !important;
            padding: 14px 18px !important;
            transition: all 0.2s ease !important;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light), 0 0 0 3px rgba(52, 152, 219, 0.3) !important;
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--nm-text-secondary) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC NAVIGATION BAR
   ═══════════════════════════════════════════════════════════════════════════ */
        nav,
        .bottom-nav,
        .nav-bar,
        #main-nav,
        [class*="nav"] {
            background: var(--nm-bg) !important;
            box-shadow: 0 -8px 20px rgba(163, 177, 198, 0.4), 0 -4px 10px rgba(255, 255, 255, 0.6) !important;
            border-radius: var(--nm-radius-lg) var(--nm-radius-lg) 0 0 !important;
            border: none !important;
        }

        html.dark nav,
        html.dark .bottom-nav,
        html.dark [class*="nav"] {
            box-shadow: 0 -8px 20px rgba(10, 10, 20, 0.5), 0 -4px 10px rgba(40, 40, 60, 0.4) !important;
        }

        /* Nav items */
        .nav-item {
            background: transparent !important;
            box-shadow: none !important;
            border-radius: var(--nm-radius-md) !important;
        }

        .nav-item:hover {
            background: var(--nm-bg-secondary) !important;
        }

        .nav-item.active {
            background: var(--nm-bg) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
        }

        .nav-item.active svg,
        .nav-item.active span {
            color: var(--nm-accent-blue) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC FILTER CHIPS / PILLS
   ═══════════════════════════════════════════════════════════════════════════ */
        .filter-chip,
        .chip,
        .pill,
        .tag,
        [class*="chip"] {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-pill) !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            padding: 10px 20px !important;
            color: var(--nm-text) !important;
            border: none !important;
        }

        .filter-chip.active,
        .chip.active,
        [class*="chip"].active {
            background: var(--nm-accent-red-gradient) !important;
            color: white !important;
            box-shadow: 3px 3px 8px rgba(231, 76, 60, 0.4) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC MODALS - KAPSAMLI LIGHT/DARK MODE STİLLERİ
   ═══════════════════════════════════════════════════════════════════════════ */

        /* ─── LIGHT MODE MODAL CONTAINER ─── */
        .modal-content,
        .modal-card,
        .dialog,
        .glass-card,
        [class*="modal"]>div:not([class*="backdrop"]):not([class*="bg-black"]) {
            background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(0, 0, 0, 0.06) !important;
        }

        /* ─── DARK MODE MODAL CONTAINER (BEYAZ IŞIK TAMAMEN YOK) ─── */
        html.dark .modal-content,
        html.dark .modal-card,
        html.dark .dialog,
        html.dark .glass-card,
        html.dark [class*="modal"]>div:not([class*="backdrop"]):not([class*="bg-black"]) {
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
        }

        /* ─── TÜM MODAL ID'LERİ - LIGHT MODE ─── */
        #savings-detail-modal>div:not(.absolute),
        #notes-modal>div,
        #add-card-modal>div,
        #add-funds-modal>div,
        #confirm-modal>div,
        #currency-converter-modal>div,
        #loan-calculator-modal>div,
        #add-goal-modal>div,
        #profile-modal>div,
        #theme-modal>div,
        #stock-detail-modal>div,
        #premium-modal>div,
        #detailed-stats-modal>div:not(.absolute),
        #budget-modal>div,
        #category-modal>div,
        #nft-detail-modal>div,
        #badge-celebration-modal>div,
        #badge-gallery-modal>div,
        #ocr-confirm-modal>div,
        #recurring-manager-modal>div,
        #premium-paywall-modal>div,
        #widget-info-modal>div,
        #insight-detail-modal>div:not(.absolute),
        #dna-detail-modal>div:not(.absolute) {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%) !important;
            border-radius: 28px !important;
            box-shadow:
                0 25px 60px -15px rgba(0, 0, 0, 0.18),
                0 10px 30px -10px rgba(0, 0, 0, 0.1) !important;
            border: 1px solid rgba(0, 0, 0, 0.06) !important;
        }

        /* ─── TÜM MODAL ID'LERİ - DARK MODE ─── */
        html.dark #savings-detail-modal>div:not(.absolute),
        html.dark #notes-modal>div,
        html.dark #add-card-modal>div,
        html.dark #add-funds-modal>div,
        html.dark #confirm-modal>div,
        html.dark #currency-converter-modal>div,
        html.dark #loan-calculator-modal>div,
        html.dark #add-goal-modal>div,
        html.dark #profile-modal>div,
        html.dark #theme-modal>div,
        html.dark #stock-detail-modal>div,
        html.dark #premium-modal>div,
        html.dark #detailed-stats-modal>div:not(.absolute),
        html.dark #budget-modal>div,
        html.dark #category-modal>div,
        html.dark #nft-detail-modal>div,
        html.dark #badge-celebration-modal>div,
        html.dark #badge-gallery-modal>div,
        html.dark #ocr-confirm-modal>div,
        html.dark #recurring-manager-modal>div,
        html.dark #premium-paywall-modal>div,
        html.dark #widget-info-modal>div,
        html.dark #insight-detail-modal>div:not(.absolute),
        html.dark #dna-detail-modal>div:not(.absolute) {
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%) !important;
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.7) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
        }

        /* ─── MODAL BACKDROP/OVERLAY ─── */
        .modal-overlay,
        [id*="modal"]>.absolute.inset-0.bg-black,
        [id*="modal"]>div[class*="bg-black"] {
            background: rgba(0, 0, 0, 0.4) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
        }

        html.dark .modal-overlay,
        html.dark [id*="modal"]>.absolute.inset-0.bg-black,
        html.dark [id*="modal"]>div[class*="bg-black"] {
            background: rgba(0, 0, 0, 0.7) !important;
        }

        /* ─── MODAL İÇİ KARTLAR - LIGHT MODE ─── */
        [id*="modal"] .glass-card,
        [id*="modal"] [class*="card"],
        .modal-inner-card {
            background: rgba(255, 255, 255, 0.8) !important;
            border: 1px solid rgba(0, 0, 0, 0.06) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
        }

        /* ─── MODAL İÇİ KARTLAR - DARK MODE ─── */
        html.dark [id*="modal"] .glass-card,
        html.dark [id*="modal"] [class*="card"],
        html.dark .modal-inner-card {
            background: rgba(30, 41, 59, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.06) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }

        /* ─── MODAL CLOSE BUTTON ─── */
        .modal-close,
        .close-btn,
        [id*="modal"] button[class*="rounded-full"][class*="close"],
        [id*="modal"] button[onclick*="close"] {
            background: rgba(241, 245, 249, 0.9) !important;
            border: 1px solid rgba(0, 0, 0, 0.08) !important;
            border-radius: 50% !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.2s ease !important;
        }

        html.dark .modal-close,
        html.dark .close-btn,
        html.dark [id*="modal"] button[class*="rounded-full"][class*="close"],
        html.dark [id*="modal"] button[onclick*="close"] {
            background: rgba(51, 65, 85, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }

        .modal-close:hover,
        .close-btn:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            color: white !important;
            border: none !important;
        }

        /* ─── MODAL INPUT FIELDS ─── */
        [id*="modal"] input,
        [id*="modal"] textarea,
        [id*="modal"] select {
            background: rgba(241, 245, 249, 0.9) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05) !important;
        }

        html.dark [id*="modal"] input,
        html.dark [id*="modal"] textarea,
        html.dark [id*="modal"] select {
            background: rgba(30, 41, 59, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2) !important;
            color: #f1f5f9 !important;
        }

        /* ─── MODAL PRİMARY BUTTONS ─── */
        [id*="modal"] button[class*="bg-indigo"],
        [id*="modal"] button[class*="bg-blue"],
        [id*="modal"] button[class*="bg-gradient"] {
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4) !important;
        }

        html.dark [id*="modal"] button[class*="bg-indigo"],
        html.dark [id*="modal"] button[class*="bg-blue"],
        html.dark [id*="modal"] button[class*="bg-gradient"] {
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3) !important;
        }

        /* ─── MODAL SECONDARY BUTTONS ─── */
        [id*="modal"] button[class*="bg-gray-100"],
        [id*="modal"] button[class*="bg-gray-50"] {
            background: rgba(241, 245, 249, 0.9) !important;
            border: 1px solid rgba(0, 0, 0, 0.08) !important;
        }

        html.dark [id*="modal"] button[class*="bg-gray-100"],
        html.dark [id*="modal"] button[class*="bg-gray-50"],
        html.dark [id*="modal"] button[class*="bg-gray-800"] {
            background: rgba(51, 65, 85, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            color: #e2e8f0 !important;
        }

        /* ─── TÜM MODAL BUTONLARI DİKDÖRTGEN YAPMA ─── */
        [id*="modal"] button:not(.modal-close):not(.close-btn):not([class*="rounded-full"]) {
            border-radius: 8px !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   BUGÜNÜN İÇGÖRÜSÜ - INSIGHT/WIDGET KARTLARI DARK MODE FIX
   ═══════════════════════════════════════════════════════════════════════════ */

        /* ─── LIGHT MODE INSIGHT CARDS ─── */
        .insight-card,
        .widget-card-apple,
        .soft-card,
        [class*="insight"] [class*="card"]:not(.insight-card-body),
        #insight-carousel>div {
            background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%) !important;
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.08),
                0 2px 8px rgba(0, 0, 0, 0.04) !important;
            border: 1px solid rgba(0, 0, 0, 0.05) !important;
            border-radius: 20px !important;
        }

        /* ─── INSIGHT CARD BODY - Buzlu cam dikdörtgen kaldırıldı ─── */
        .insight-card-body,
        .insight-card .insight-card-body,
        [class*="insight"] .insight-card-body {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            border-radius: 0 !important;
            backdrop-filter: none !important;
        }

        /* ─── DARK MODE INSIGHT CARDS - BEYAZ IŞIK TAMAMEN KALDIRILDI ─── */
        html.dark .insight-card,
        html.dark .widget-card-apple,
        html.dark .soft-card,
        html.dark [class*="insight"] [class*="card"]:not(.insight-card-body),
        html.dark #insight-carousel>div {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%) !important;
            /* Depth Effect - Double Shadow */
            box-shadow:
                6px 6px 16px rgba(0, 0, 0, 0.6),
                -4px -4px 12px rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }

        /* ─── DARK MODE INSIGHT CARD BODY - Buzlu cam dikdörtgen kaldırıldı ─── */
        html.dark .insight-card-body,
        html.dark .insight-card .insight-card-body,
        html.dark [class*="insight"] .insight-card-body {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* ─── INSIGHT CARD TEXT COLORS ─── */
        .insight-card h4,
        .widget-card-apple h4,
        .soft-card h4 {
            color: #1e293b !important;
        }

        html.dark .insight-card h4,
        html.dark .widget-card-apple h4,
        html.dark .soft-card h4 {
            color: #f1f5f9 !important;
        }

        .insight-card p,
        .widget-card-apple p,
        .soft-card p {
            color: #64748b !important;
        }

        html.dark .insight-card p,
        html.dark .widget-card-apple p,
        html.dark .soft-card p {
            color: #94a3b8 !important;
        }

        /* ─── INSIGHT CAROUSEL CONTAINER ─── */
        #insight-carousel {
            background: transparent !important;
        }

        /* ─── INSIGHT CARD ICON WRAPPER ─── */
        .insight-card>div:first-child,
        .widget-card-apple>div:first-child {
            background: linear-gradient(145deg, #f8fafc, #e2e8f0) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
        }

        html.dark .insight-card>div:first-child,
        html.dark .widget-card-apple>div:first-child {
            background: linear-gradient(145deg, #334155, #475569) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }

        /* ─── INSIGHT CARD ARROW/CHEVRON BUTTON ─── */
        .insight-card button,
        .widget-card-apple button {
            background: rgba(99, 102, 241, 0.1) !important;
            border: none !important;
        }

        html.dark .insight-card button,
        html.dark .widget-card-apple button {
            background: rgba(99, 102, 241, 0.2) !important;
        }

        /* ─── INSIGHT CARD PILL/VALUE ELEMENT - GİZLENDİ ─── */
        /* Yazıyla kesişen yeşil pill dikdörtgen sorunu düzeltildi */
        .insight-value,
        #insight-carousel .insight-value,
        .insight-card .insight-value,
        .widget-card-apple .insight-value {
            display: none !important;
        }

        /* Title başlık görünsün, border kaldırıldı */
        .insight-card .insight-card-title,
        .widget-card-apple .insight-card-title,
        #insight-carousel .insight-card-title {
            display: block !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Insight card body düzeni düzeltildi */
        .insight-card .insight-card-body,
        .widget-card-apple .insight-card-body {
            display: flex !important;
            flex-direction: column !important;
            gap: 4px !important;
        }

        /* Insight description düzeni */
        .insight-card .insight-desc,
        .widget-card-apple .insight-desc {
            margin-top: 0 !important;
            line-height: 1.5 !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC TOGGLES / SWITCHES
   ═══════════════════════════════════════════════════════════════════════════ */
        .toggle,
        .switch,
        [type="checkbox"] {
            background: var(--nm-bg) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            border-radius: var(--nm-radius-pill) !important;
        }

        .toggle.active,
        .switch.active,
        [type="checkbox"]:checked {
            background: var(--nm-accent-blue-gradient) !important;
            box-shadow: 3px 3px 8px rgba(52, 152, 219, 0.4) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC PROGRESS BARS
   ═══════════════════════════════════════════════════════════════════════════ */
        .progress-bar,
        .progress,
        [class*="progress"] {
            background: var(--nm-bg) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            border-radius: var(--nm-radius-pill) !important;
            overflow: hidden;
        }

        .progress-bar-fill,
        .progress-fill,
        [class*="progress"]>div {
            background: var(--nm-accent-blue-gradient) !important;
            border-radius: var(--nm-radius-pill) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC ICONS & AVATARS
   ═══════════════════════════════════════════════════════════════════════════ */
        .icon-container,
        .icon-circle {
            background: var(--nm-bg) !important;
            border-radius: 50% !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
        }

        /* Avatar'lardan neumorphic gölgeyi kaldır - kare görünümü önle */
        .avatar,
        .user-avatar,
        .profile-avatar,
        [class*="avatar"] {
            box-shadow: none !important;
            border-radius: 50% !important;
            background: transparent !important;
        }


        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC SCROLLBAR
   ═══════════════════════════════════════════════════════════════════════════ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--nm-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--nm-bg-secondary);
            border-radius: 10px;
            box-shadow: inset 2px 2px 4px rgba(163, 177, 198, 0.3), inset -2px -2px 4px rgba(255, 255, 255, 0.3);
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC SPECIAL ELEMENTS
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Date picker days (like in the reference image) */
        .day-item,
        .calendar-day,
        [class*="day"] {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            transition: all 0.2s ease !important;
        }

        .day-item.today,
        .day-item.selected,
        .calendar-day.selected,
        [class*="day"].active {
            background: var(--nm-accent-red-gradient) !important;
            color: white !important;
            box-shadow: 4px 4px 10px rgba(231, 76, 60, 0.4) !important;
        }

        /* FAB Button */
        .fab,
        .floating-btn,
        #add-transaction-fab {
            background: var(--nm-accent-blue-gradient) !important;
            border-radius: 50% !important;
            box-shadow: 6px 6px 14px rgba(52, 152, 219, 0.5), -4px -4px 10px rgba(255, 255, 255, 0.4) !important;
            color: white !important;
        }

        .fab:active,
        .floating-btn:active {
            box-shadow: inset 4px 4px 8px rgba(30, 100, 150, 0.5), inset -4px -4px 8px rgba(100, 180, 255, 0.3) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   NEUMORPHIC ANIMATIONS
   ═══════════════════════════════════════════════════════════════════════════ */
        @keyframes nm-pulse {

            0%,
            100% {
                box-shadow: var(--nm-shadow-dark), var(--nm-shadow-light);
            }

            50% {
                box-shadow: 8px 8px 18px rgba(163, 177, 198, 0.6), -8px -8px 18px rgba(255, 255, 255, 0.8);
            }
        }

        .nm-pulse {
            animation: nm-pulse 2s infinite ease-in-out;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   HEADER & TOP BAR
   ═══════════════════════════════════════════════════════════════════════════ */
        header,
        .header,
        .top-bar,
        [class*="header"] {
            background: var(--nm-bg) !important;
            box-shadow: 0 6px 16px rgba(163, 177, 198, 0.4), 0 3px 8px rgba(255, 255, 255, 0.6) !important;
        }

        html.dark header,
        html.dark .header {
            box-shadow: 0 6px 16px rgba(10, 10, 20, 0.5), 0 3px 8px rgba(40, 40, 60, 0.4) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   TEXT STYLING
   ═══════════════════════════════════════════════════════════════════════════ */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: var(--nm-text) !important;
        }

        p,
        span,
        label {
            color: var(--nm-text-secondary) !important;
        }

        /* Amount displays */
        .amount,
        .price,
        .value,
        [class*="amount"],
        [class*="price"] {
            color: var(--nm-text) !important;
            font-weight: 700 !important;
        }

        .amount.positive,
        .income-amount {
            color: var(--nm-accent-green) !important;
        }

        .amount.negative,
        .expense-amount {
            color: var(--nm-accent-red) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   DIVIDERS & BORDERS
   ═══════════════════════════════════════════════════════════════════════════ */
        hr,
        .divider,
        [class*="border"] {
            border-color: rgba(163, 177, 198, 0.3) !important;
        }

        html.dark hr,
        html.dark .divider {
            border-color: rgba(40, 40, 60, 0.5) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   KÜÇÜK ELEMENTLERDEN GÖLGE KALDIRMA
   Indicator dots, badges, küçük tags - bunlar neumorphic olmamalı
   ═══════════════════════════════════════════════════════════════════════════ */
        .dot,
        .indicator,
        .indicator-dot,
        .pagination-dot,
        .badge,
        .status-dot,
        .status-indicator,
        [class*="indicator"],
        [class*="dot"]:not([class*="dotted"]),
        [class*="badge"],
        .insight-dot,
        .carousel-dot,
        .slider-dot,
        .swiper-pagination-bullet {
            box-shadow: none !important;
            border-radius: 50% !important;
        }

        /* Section header labels - düz görünüm */
        .section-title,
        .section-header,
        [class*="section-title"],
        [class*="insight"] h3,
        [class*="insight"] h4,
        [class*="insight-header"] {
            box-shadow: none !important;
            background: transparent !important;
        }

        /* Emoji ve icon badges */
        .emoji-badge,
        .icon-badge,
        [class*="emoji"] {
            box-shadow: none !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   MODAL İÇİ ELEMENTLER - KARE GÖLGE DÜZELTME
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Kategori chip'leri / filter kategorileri */
        .category-chip,
        .category-btn,
        .category-item,
        .filter-chip,
        .filter-btn,
        .chip,
        [class*="category-"],
        [class*="filter-chip"],
        [class*="chip-"] {
            box-shadow: none !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .category-chip.active,
        .category-btn.active,
        .filter-chip.active,
        .chip.active {
            background: var(--nm-accent-red-gradient) !important;
            border: none !important;
        }

        /* Tab butonları */
        .tab,
        .tab-btn,
        .tab-button,
        .tab-item,
        [class*="tab-"],
        [role="tab"] {
            box-shadow: none !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .tab.active,
        .tab-btn.active,
        .tab-button.active,
        [role="tab"][aria-selected="true"] {
            background: var(--nm-accent-blue-gradient) !important;
            border: none !important;
        }

        /* Chat suggestion butonları */
        .suggestion,
        .suggestion-btn,
        .suggestion-chip,
        .quick-reply,
        [class*="suggestion"],
        [class*="quick-reply"] {
            box-shadow: none !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: var(--nm-radius-md) !important;
        }

        /* Insight kart icon container'ları */
        .insight-icon,
        .card-icon,
        .stat-icon,
        [class*="insight"] .icon,
        [class*="insight-icon"],
        [class*="card-icon"] {
            box-shadow: none !important;
            border-radius: var(--nm-radius-lg) !important;
        }

        /* Input ve date picker'lar */
        .date-input,
        .date-picker,
        .amount-input,
        [type="date"],
        [class*="date-"],
        [class*="amount-input"] {
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            border: none !important;
        }

        /* Chat bubble'lar */
        .chat-bubble,
        .message-bubble,
        .ai-message,
        [class*="message"],
        [class*="bubble"] {
            box-shadow: none !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
        }

        /* Modal close button - yuvarlak olsun */
        .modal-close,
        .close-btn,
        [class*="close"] {
            border-radius: 50% !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   MODAL & OVERLAY STİLLERİ
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Modal overlay - soft blur background */
        .modal-overlay,
        .overlay,
        [class*="overlay"]:not([class*="gradient"]) {
            background: rgba(0, 0, 0, 0.4) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
        }

        html.dark .modal-overlay,
        html.dark .overlay,
        html.dark [class*="overlay"]:not([class*="gradient"]) {
            background: rgba(0, 0, 0, 0.6) !important;
        }

        /* Modal container - full neumorphic */
        .modal,
        .modal-content,
        .popup,
        .dialog,
        .bottom-sheet {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow:
                12px 12px 24px rgba(0, 0, 0, 0.15),
                -12px -12px 24px rgba(255, 255, 255, 0.7) !important;
            border: none !important;
        }

        /* Karanlık mod - BEYAZ IŞIK/GLOW TAMAMEN KALDIRILDI */
        html.dark .modal,
        html.dark .modal-content,
        html.dark .popup,
        html.dark .dialog,
        html.dark .bottom-sheet {
            background: #0f172a !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
        }

        /* Modal header & footer */
        .modal-header,
        .modal-footer,
        .popup-header,
        .dialog-header {
            background: transparent !important;
            border: none !important;
            padding: 16px 20px !important;
        }

        /* Toast / Snackbar notifications - Exclude Dynamic Island Toast and ALL its children */
        .toast:not(.dynamic-island-toast):not([class*="dynamic-island-toast-"]),
        .snackbar,
        .notification,
        [class*="toast"]:not([class*="dynamic-island"]),
        [class*="snackbar"] {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-md) !important;
            box-shadow: var(--nm-shadow-dark), var(--nm-shadow-light) !important;
            color: var(--nm-text) !important;
            border: none !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   LİSTE ELEMENTLERİ
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Transaction & list items - subtle inset effect */
        .transaction-item,
        .list-item,
        .list-row,
        .settings-item,
        .setting-row {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-md) !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            margin-bottom: 12px !important;
            padding: 14px 16px !important;
            border: none !important;
            transition: all 0.2s ease !important;
        }

        .transaction-item:active,
        .list-item:active {
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
        }

        /* Dropdown & Select */
        .dropdown,
        .dropdown-menu,
        .select-menu,
        select {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-md) !important;
            box-shadow: var(--nm-shadow-dark), var(--nm-shadow-light) !important;
            border: none !important;
            color: var(--nm-text) !important;
        }

        select option {
            background: var(--nm-bg) !important;
            color: var(--nm-text) !important;
            padding: 10px !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   GELİŞMİŞ FORM ELEMENTLERİ
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Checkbox - Neumorphic style */
        input[type="checkbox"] {
            appearance: none !important;
            -webkit-appearance: none !important;
            width: 24px !important;
            height: 24px !important;
            background: var(--nm-bg) !important;
            border-radius: 8px !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            cursor: pointer !important;
            position: relative !important;
            transition: all 0.2s ease !important;
        }

        input[type="checkbox"]:checked {
            background: var(--nm-accent-blue-gradient) !important;
            box-shadow:
                2px 2px 6px rgba(52, 152, 219, 0.4),
                -2px -2px 6px rgba(255, 255, 255, 0.2) !important;
        }

        input[type="checkbox"]:checked::after {
            content: '✓' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            color: white !important;
            font-size: 14px !important;
            font-weight: bold !important;
        }

        /* Radio button - Neumorphic style */
        input[type="radio"] {
            appearance: none !important;
            -webkit-appearance: none !important;
            width: 24px !important;
            height: 24px !important;
            background: var(--nm-bg) !important;
            border-radius: 50% !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            cursor: pointer !important;
            position: relative !important;
            transition: all 0.2s ease !important;
        }

        input[type="radio"]:checked {
            background: var(--nm-bg) !important;
        }

        input[type="radio"]:checked::after {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 12px !important;
            height: 12px !important;
            background: var(--nm-accent-blue-gradient) !important;
            border-radius: 50% !important;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.5) !important;
        }

        /* Toggle switch - Neumorphic style */
        .toggle,
        .switch,
        [class*="toggle-switch"],
        [class*="switch-"] {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-pill) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            border: none !important;
            transition: all 0.3s ease !important;
        }

        .toggle.active,
        .switch.active,
        .toggle.on,
        .switch.on,
        [class*="toggle-switch"].active {
            background: var(--nm-accent-green-gradient) !important;
            box-shadow:
                inset 2px 2px 4px rgba(0, 100, 60, 0.3),
                inset -2px -2px 4px rgba(100, 255, 200, 0.2) !important;
        }

        /* Toggle knob */
        .toggle-knob,
        .switch-knob,
        [class*="toggle"] .knob,
        [class*="switch"] .knob {
            background: var(--nm-bg) !important;
            border-radius: 50% !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
        }

        /* Range slider - Neumorphic style */
        input[type="range"] {
            appearance: none !important;
            -webkit-appearance: none !important;
            background: var(--nm-bg) !important;
            height: 10px !important;
            border-radius: var(--nm-radius-pill) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            outline: none !important;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none !important;
            -webkit-appearance: none !important;
            width: 24px !important;
            height: 24px !important;
            background: var(--nm-accent-blue-gradient) !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            box-shadow:
                3px 3px 8px rgba(52, 152, 219, 0.4),
                -2px -2px 6px rgba(255, 255, 255, 0.3) !important;
            transition: transform 0.2s ease !important;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1) !important;
        }

        /* Textarea - Neumorphic inset */
        textarea {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-md) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            border: none !important;
            color: var(--nm-text) !important;
            padding: 14px 16px !important;
            resize: vertical !important;
            transition: all 0.2s ease !important;
        }

        textarea:focus {
            outline: none !important;
            box-shadow:
                var(--nm-inset-dark),
                var(--nm-inset-light),
                0 0 0 3px rgba(52, 152, 219, 0.2) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   STATE & FEEDBACK STİLLERİ
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Loading spinner container */
        .loading,
        .spinner-container,
        [class*="loading"] {
            background: var(--nm-bg) !important;
        }

        /* Spinner itself */
        .spinner,
        [class*="spinner"]:not(.spinner-container) {
            border-color: var(--nm-bg-secondary) !important;
            border-top-color: var(--nm-accent-blue) !important;
        }

        /* Skeleton loading */
        .skeleton,
        [class*="skeleton"] {
            background: linear-gradient(90deg,
                    var(--nm-bg) 0%,
                    var(--nm-bg-secondary) 50%,
                    var(--nm-bg) 100%) !important;
            background-size: 200% 100% !important;
            animation: skeleton-shimmer 1.5s infinite !important;
            border-radius: var(--nm-radius-sm) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
        }

        @keyframes skeleton-shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Empty state */
        .empty-state,
        .no-data,
        [class*="empty"] {
            color: var(--nm-text-secondary) !important;
        }

        .empty-state .icon,
        .no-data .icon {
            opacity: 0.5 !important;
        }

        /* Tooltip */
        .tooltip,
        [class*="tooltip"],
        [data-tooltip]::after {
            background: var(--nm-bg) !important;
            color: var(--nm-text) !important;
            border-radius: var(--nm-radius-sm) !important;
            box-shadow: var(--nm-shadow-dark), var(--nm-shadow-light) !important;
            border: none !important;
            padding: 8px 12px !important;
            font-size: 13px !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   TEXT & ICON OKUNABİLİRLİK - LIGHT MODE
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Daha koyu primary text */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .title,
        .heading,
        [class*="title"],
        [class*="heading"] {
            color: #1a1a2e !important;
            font-weight: 700 !important;
        }

        /* Secondary text - daha okunabilir */
        p,
        span,
        label,
        .subtitle,
        .description,
        .text,
        [class*="subtitle"],
        [class*="description"] {
            color: #4a5568 !important;
        }

        /* Tüm icon'lar - görünür renk */
        .icon,
        i,
        svg:not(.chart-svg),
        [class*="icon"]:not([class*="icon-container"]) {
            color: #2d3436 !important;
            opacity: 0.85 !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   TEXT & ICON OKUNABİLİRLİK - DARK MODE
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Dark mode - parlak primary text */
        html.dark h1,
        html.dark h2,
        html.dark h3,
        html.dark h4,
        html.dark h5,
        html.dark h6,
        html.dark .title,
        html.dark .heading,
        html.dark [class*="title"],
        html.dark [class*="heading"] {
            color: #f7fafc !important;
        }

        /* Dark mode - okunabilir secondary text */
        html.dark p,
        html.dark span,
        html.dark label,
        html.dark .subtitle,
        html.dark .description,
        html.dark .text,
        html.dark [class*="subtitle"],
        html.dark [class*="description"] {
            color: #cbd5e0 !important;
        }

        /* Dark mode - görünür icon'lar */
        html.dark .icon,
        html.dark i,
        html.dark svg:not(.chart-svg),
        html.dark [class*="icon"]:not([class*="icon-container"]) {
            color: #e2e8f0 !important;
            opacity: 0.9 !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   ACCENT RENK TUTARLILIĞI
   ═══════════════════════════════════════════════════════════════════════════ */

        /* Gelir/Pozitif - yeşil */
        .income,
        .positive,
        .success,
        [class*="income"],
        [class*="positive"],
        [class*="success"] {
            color: #27ae60 !important;
        }

        /* Gider/Negatif - kırmızı */
        .expense,
        .negative,
        .error,
        .danger,
        [class*="expense"],
        [class*="negative"],
        [class*="error"] {
            color: #e74c3c !important;
        }

        /* Link & primary action rengi */
        a:not(.btn):not(.button):not([class*="btn"]),
        .link,
        .primary-text {
            color: var(--nm-accent-blue) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   SEGMENT CONTROL & TAB BAR
   ═══════════════════════════════════════════════════════════════════════════ */

        .segment-control,
        .segmented-control,
        .tab-bar,
        [class*="segment"] {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            padding: 4px !important;
        }

        .segment-control .segment,
        .segment-item,
        .tab-bar-item {
            background: transparent !important;
            border-radius: var(--nm-radius-md) !important;
            color: var(--nm-text-secondary) !important;
            transition: all 0.3s ease !important;
            box-shadow: none !important;
        }

        .segment-control .segment.active,
        .segment-item.active,
        .tab-bar-item.active {
            background: var(--nm-bg) !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            color: var(--nm-text) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   CHART & GRAPH STILLERI
   ═══════════════════════════════════════════════════════════════════════════ */

        .chart-container,
        .graph-container,
        [class*="chart"]:not(canvas):not(svg) {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow: var(--nm-shadow-dark), var(--nm-shadow-light) !important;
            padding: 16px !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
   FOOTER & ACTION BAR
   ═══════════════════════════════════════════════════════════════════════════ */

        .footer,
        .action-bar,
        .bottom-bar:not(.nav-bar),
        [class*="footer"] {
            background: var(--nm-bg) !important;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08) !important;
        }

        html.dark .footer,
        html.dark .action-bar,
        html.dark .bottom-bar:not(.nav-bar),
        html.dark [class*="footer"] {
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
       BLOB KALDIRMA (Navigasyon barı için)
    ═══════════════════════════════════════════════════════════════════════════ */
        .animate-blob,
        .blob,
        [class*="blob"] {
            display: none !important;
            animation: none !important;
            opacity: 0 !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
       MINI BADGE - İŞLEM AÇIKLAMA ETİKETİ
       Elips yerine kare köşeli (rounded rectangle) görünüm
    ═══════════════════════════════════════════════════════════════════════════ */
        .mini-badge,
        .mini-badge--note,
        [class*="mini-badge"] {
            border-radius: 6px !important;
            /* Elips yerine hafif yuvarlak köşe */
            padding: 2px 8px !important;
            background: rgba(99, 102, 241, 0.12) !important;
            /* Açık indigo arka plan */
            color: #4F46E5 !important;
            /* Indigo metin */
            font-size: 10px !important;
            font-weight: 500 !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 3px !important;
            border: 1px solid rgba(99, 102, 241, 0.2) !important;
        }

        /* Dark mode için mini-badge */
        html.dark .mini-badge,
        html.dark .mini-badge--note,
        html.dark [class*="mini-badge"] {
            background: rgba(99, 102, 241, 0.2) !important;
            color: #A5B4FC !important;
            /* Açık indigo */
            border-color: rgba(99, 102, 241, 0.3) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
       SWIPE-TO-ACTION - İŞLEM KARTLARI
       Sola kaydır = Sil, Sağa kaydır = Düzenle
    ═══════════════════════════════════════════════════════════════════════════ */

        /* Ana container - overflow gizleme */
        /* ═══════════════════════════════════════════════════════════════════════════ */
        /* APPLE-STYLE SWIPE ACTIONS (Redesigned)                                      */
        /* ═══════════════════════════════════════════════════════════════════════════ */

        .swipe-container {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            margin-bottom: 8px;
            touch-action: pan-y;
            /* Allow vertical scroll, handle horizontal in JS */
            will-change: transform;
            background: #fff;
            /* Default background behind card */
        }

        /* Dark mode adjustment */
        @media (prefers-color-scheme: dark) {
            .swipe-container {
                background: #000;
            }
        }

        /* Action Layers Underlying the Card */
        /* These are absolute positioned. We will reveal them by manipulating z-index or visibility 
           based on gesture direction, OR just having them side-by-side behind user content 
           is tricky if width is dynamic. 
           
           Better strategy: 
           Two layers behind the content.
           Left Layer (Blue) -> Visible when swiping Right
           Right Layer (Red) -> Visible when swiping Left
        */

        .swipe-action-layer {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: white;
            padding: 0 24px;
            z-index: 1;
            /* Below content */
        }

        .swipe-action-delete {
            justify-content: flex-end;
            /* Icon on the right */
            background: #FF3B30;
            /* iOS Destructive Red */
            background: linear-gradient(to left, #FF3B30, #ff4d42);
        }

        .swipe-action-edit {
            justify-content: flex-start;
            /* Icon on the left */
            background: #007AFF;
            /* iOS Blue */
            background: linear-gradient(to right, #007AFF, #0a84ff);
        }

        .swipe-action-icon-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s ease;
        }

        .swipe-action-icon {
            font-size: 20px;
        }

        /* The content card that moves */
        .swipe-content {
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
            /* Default reset transition */
        }

        /* Dark mode card */
        @media (prefers-color-scheme: dark) {
            .swipe-content {
                background: rgba(28, 28, 30, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }
        }

        /* Kart içeriği - Swipe edilebilir */
        .swipe-card {
            position: relative;
            z-index: 2;
            background: var(--nm-bg, #f0f4f8);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
            cursor: grab;
        }

        .swipe-card:active {
            cursor: grabbing;
        }

        .swipe-card.swiping {
            transition: none;
        }

        .swipe-card.returning {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Dark mode stilleri */
        html.dark .swipe-card {
            background: var(--nm-bg-dark, #1a1a2e);
        }

        html.dark .swipe-action-delete {
            background: linear-gradient(135deg, #C53030 0%, #9B2C2C 50%, #742A2A 100%);
        }

        html.dark .swipe-action-edit {
            background: linear-gradient(135deg, #5B21B6 0%, #6D28D9 50%, #7C3AED 100%);
        }

        /* Swipe hint animasyonu - İlk kullanım için */
        @keyframes swipeHint {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-15px);
            }

            50% {
                transform: translateX(15px);
            }

            75% {
                transform: translateX(0);
            }
        }

        .swipe-card.hint {
            animation: swipeHint 1.5s ease-in-out;
        }

        /* Swipe progress indicator */
        .swipe-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 40px;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s ease, width 0.2s ease;
        }

        .swipe-container:hover .swipe-indicator {
            opacity: 0.5;
        }

        .swipe-indicator-left {
            right: 8px;
            background: linear-gradient(to bottom, #FF6B6B, #DC3545);
        }

        .swipe-indicator-right {
            left: 8px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
        }

        /* Confirmed state - aksiyona karar verildiğinde */
        .swipe-action-delete.confirmed,
        .swipe-action-edit.confirmed {
            width: 100%;
        }

        .swipe-action-delete.confirmed .swipe-action-btn .swipe-icon,
        .swipe-action-edit.confirmed .swipe-action-btn .swipe-icon {
            transform: scale(1.3);
        }

        /* Mevcut küçük butonları gizle (swipe varsa) */
        .swipe-container .tx-actions-small {
            display: none !important;
        }


        /* ═══════════════════════════════════════════════════════════════════════════
       TAKSİTLER - NEUMORPHIC ÖZEL STİLLER
       Kredi ve Kredi Kartı Taksit Takip Sistemi
       ═══════════════════════════════════════════════════════════════════════════ */

        /* ─── Taksitler Tab Container ─── */
        .nm-installment-tabs {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            padding: 6px !important;
        }

        .nm-installment-tabs button {
            background: transparent !important;
            box-shadow: none !important;
            border-radius: var(--nm-radius-md) !important;
            padding: 12px 16px !important;
            font-weight: 600 !important;
            color: var(--nm-text-secondary) !important;
            transition: all 0.3s ease !important;
        }

        .nm-installment-tabs button.active {
            background: var(--nm-bg) !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            color: var(--nm-accent-blue) !important;
        }

        html.dark .nm-installment-tabs button.active {
            box-shadow: var(--nm-shadow-dark-sm) !important;
            color: #818cf8 !important;
        }

        /* ─── Taksit Tip Seçici (Modal İçinde) ─── */
        .nm-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .nm-type-btn {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-md) !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            padding: 16px 12px !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            gap: 6px !important;
            border: 2px solid transparent !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }

        .nm-type-btn:hover {
            transform: translateY(-2px) !important;
        }

        .nm-type-btn.active {
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            border-color: var(--nm-accent-blue) !important;
        }

        .nm-type-btn.active.credit-card {
            border-color: #6366f1 !important;
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.1), transparent) !important;
        }

        .nm-type-btn.active.loan {
            border-color: #10b981 !important;
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), transparent) !important;
        }

        html.dark .nm-type-btn {
            box-shadow: var(--nm-shadow-dark-sm) !important;
        }

        html.dark .nm-type-btn.active {
            box-shadow: var(--nm-inset-dark) !important;
        }

        /* ─── Taksit Özet Kartı ─── */
        .nm-installment-summary {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow: var(--nm-shadow-dark), var(--nm-shadow-light) !important;
            padding: 20px !important;
            margin-bottom: 16px !important;
            position: relative !important;
            overflow: hidden !important;
        }

        html.dark .nm-installment-summary {
            box-shadow: var(--nm-shadow-dark) !important;
            border: 1px solid rgba(255, 255, 255, 0.06) !important;
        }

        .nm-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .nm-summary-stat {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-md) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            padding: 12px 16px !important;
            text-align: center !important;
        }

        html.dark .nm-summary-stat {
            box-shadow: var(--nm-inset-dark) !important;
        }

        /* ─── Taksit Kartları ─── */
        .nm-installment-card {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            padding: 16px !important;
            margin-bottom: 12px !important;
            border-left: 4px solid transparent !important;
            transition: all 0.3s ease !important;
        }

        .nm-installment-card:hover {
            transform: translateY(-2px) !important;
            box-shadow: var(--nm-shadow-dark), var(--nm-shadow-light) !important;
        }

        html.dark .nm-installment-card {
            box-shadow: var(--nm-shadow-dark-sm) !important;
            border: 1px solid rgba(255, 255, 255, 0.04) !important;
            border-left: 4px solid transparent !important;
        }

        html.dark .nm-installment-card:hover {
            box-shadow: var(--nm-shadow-dark) !important;
        }

        /* Tip bazlı border renkleri */
        .nm-installment-card.credit-card {
            border-left-color: #6366f1 !important;
        }

        .nm-installment-card.loan {
            border-left-color: #10b981 !important;
        }

        /* ─── Taksit Progress Bar ─── */
        .nm-progress-container {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-pill) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            height: 10px !important;
            overflow: hidden !important;
            margin: 12px 0 !important;
        }

        html.dark .nm-progress-container {
            box-shadow: var(--nm-inset-dark) !important;
        }

        .nm-progress-fill {
            height: 100% !important;
            border-radius: var(--nm-radius-pill) !important;
            transition: width 0.5s ease !important;
        }

        .nm-progress-fill.credit-card {
            background: linear-gradient(90deg, #6366f1, #8b5cf6) !important;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5) !important;
        }

        .nm-progress-fill.loan {
            background: linear-gradient(90deg, #10b981, #34d399) !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5) !important;
        }

        .nm-progress-fill.complete {
            background: linear-gradient(90deg, #10b981, #34d399) !important;
        }

        /* ─── Taksit Ödeme Butonu ─── */
        .nm-pay-btn {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-md) !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            padding: 10px 16px !important;
            width: 100% !important;
            font-weight: 600 !important;
            color: var(--nm-accent-blue) !important;
            transition: all 0.2s ease !important;
            margin-top: 12px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
        }

        .nm-pay-btn:hover {
            transform: translateY(-1px) !important;
        }

        .nm-pay-btn:active {
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            transform: translateY(0) !important;
        }

        html.dark .nm-pay-btn {
            box-shadow: var(--nm-shadow-dark-sm) !important;
            color: #818cf8 !important;
        }

        html.dark .nm-pay-btn:active {
            box-shadow: var(--nm-inset-dark) !important;
        }

        /* ─── Boş Durum Kartı ─── */
        .nm-empty-state {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-lg) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            padding: 40px 20px !important;
            text-align: center !important;
        }

        html.dark .nm-empty-state {
            box-shadow: var(--nm-inset-dark) !important;
        }

        .nm-empty-state .icon-wrapper {
            width: 64px !important;
            height: 64px !important;
            background: var(--nm-bg) !important;
            border-radius: 50% !important;
            box-shadow: var(--nm-shadow-dark-sm), var(--nm-shadow-light-sm) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin: 0 auto 16px !important;
            font-size: 28px !important;
        }

        html.dark .nm-empty-state .icon-wrapper {
            box-shadow: var(--nm-shadow-dark-sm) !important;
        }

        /* ─── Tip Badge'leri ─── */
        .nm-type-badge {
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            padding: 4px 10px !important;
            border-radius: var(--nm-radius-pill) !important;
            font-size: 10px !important;
            font-weight: 700 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .nm-type-badge.credit-card {
            background: rgba(99, 102, 241, 0.15) !important;
            color: #6366f1 !important;
        }

        .nm-type-badge.loan {
            background: rgba(16, 185, 129, 0.15) !important;
            color: #10b981 !important;
        }

        html.dark .nm-type-badge.credit-card {
            background: rgba(99, 102, 241, 0.25) !important;
            color: #a5b4fc !important;
        }

        html.dark .nm-type-badge.loan {
            background: rgba(16, 185, 129, 0.25) !important;
            color: #6ee7b7 !important;
        }

        /* ─── Özet İstatistik Satırları ─── */
        .nm-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        html.dark .nm-summary-row {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        .nm-summary-row:last-child {
            border-bottom: none;
        }

        /* ─── Taksit Detay Bilgileri ─── */
        .nm-installment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .nm-detail-item {
            background: var(--nm-bg) !important;
            border-radius: var(--nm-radius-sm) !important;
            box-shadow: var(--nm-inset-dark), var(--nm-inset-light) !important;
            padding: 10px 12px !important;
        }

        html.dark .nm-detail-item {
            box-shadow: var(--nm-inset-dark) !important;
        }
    </style>


    <script>
        // Tema algılama - FOUC'u önlemek için inline çalışır
        (function () {
            const savedTheme = localStorage.getItem('app_theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Dark modunu uygula: kaydedilen tema dark ise, veya sistem dark ise ve kaydedilen tema light değilse
            if (savedTheme === 'dark' || (savedTheme === 'system' && prefersDark) || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- ═══════════════════════════════════════════════════════════════════════════
     FINGO CORE INFRASTRUCTURE - Error Handling, Logging, Network, Lifecycle
     ═══════════════════════════════════════════════════════════════════════════ -->
    <script>
        (function () {
            'use strict';

            // ─────────────────────────────────────────────────────────────────────
            // 1. FINGO LOGGER - Merkezi Logging Sistemi
            // ─────────────────────────────────────────────────────────────────────
            const FingoLogger = {
                _logs: [],
                _maxLogs: 100,

                _timestamp() {
                    return new Date().toISOString().substr(11, 12);
                },

                _store(level, tag, msg, extra) {
                    const entry = { time: this._timestamp(), level, tag, msg, extra };
                    this._logs.push(entry);
                    if (this._logs.length > this._maxLogs) this._logs.shift();
                },

                info(tag, msg, extra = null) {
                    this._store('INFO', tag, msg, extra);
                    console.log(`%c[${tag}]%c ${msg}`, 'color:#3b82f6;font-weight:bold', 'color:inherit', extra || '');
                },

                warn(tag, msg, extra = null) {
                    this._store('WARN', tag, msg, extra);
                    console.warn(`%c[${tag}]%c ⚠️ ${msg}`, 'color:#f59e0b;font-weight:bold', 'color:inherit', extra || '');
                },

                error(tag, msg, err = null) {
                    this._store('ERROR', tag, msg, err);
                    console.error(`%c[${tag}]%c ❌ ${msg}`, 'color:#ef4444;font-weight:bold', 'color:inherit', err || '');
                },

                getLogs() {
                    return [...this._logs];
                },

                exportLogs() {
                    return JSON.stringify(this._logs, null, 2);
                }
            };

            // ─────────────────────────────────────────────────────────────────────
            // 2. GLOBAL ERROR HANDLER - Tüm Hataları Yakala
            // ─────────────────────────────────────────────────────────────────────
            window.onerror = function (message, source, lineno, colno, error) {
                FingoLogger.error('UNCAUGHT', `${message} at ${source}:${lineno}:${colno}`, error?.stack);

                // Kritik hatalarda kullanıcıya bildirim (opsiyonel)
                if (error && error.message && !error.message.includes('Script error')) {
                    // Sessiz hata - production'da toast gösterilebilir
                }

                return false; // Tarayıcı default davranışı devam etsin
            };

            window.addEventListener('unhandledrejection', function (event) {
                const reason = event.reason;
                const msg = reason?.message || String(reason);
                FingoLogger.error('PROMISE', `Unhandled rejection: ${msg}`, reason?.stack);
            });

            // ─────────────────────────────────────────────────────────────────────
            // 3. SAFE FETCH - Network Resilience (Retry + Timeout)
            // ─────────────────────────────────────────────────────────────────────
            async function safeFetch(url, options = {}, config = {}) {
                const {
                    retries = 3,
                    timeout = 10000,
                    backoff = 1000,
                    onRetry = null
                } = config;

                let lastError;

                for (let attempt = 1; attempt <= retries; attempt++) {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);

                    try {
                        const response = await fetch(url, {
                            ...options,
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        FingoLogger.info('NETWORK', `✓ ${options.method || 'GET'} ${url} (attempt ${attempt})`);
                        return response;

                    } catch (err) {
                        clearTimeout(timeoutId);
                        lastError = err;

                        const isAbort = err.name === 'AbortError';
                        const isNetworkError = err.message.includes('Failed to fetch') ||
                            err.message.includes('NetworkError');

                        FingoLogger.warn('NETWORK', `Attempt ${attempt}/${retries} failed: ${url}`, err.message);

                        if (attempt < retries && (isAbort || isNetworkError || err.message.startsWith('HTTP 5'))) {
                            const delay = backoff * Math.pow(2, attempt - 1);
                            if (onRetry) onRetry(attempt, delay);
                            await new Promise(r => setTimeout(r, delay));
                        } else {
                            break;
                        }
                    }
                }

                FingoLogger.error('NETWORK', `Failed after ${retries} attempts: ${url}`, lastError?.message);
                throw lastError;
            }

            // ─────────────────────────────────────────────────────────────────────
            // 4. APP LIFECYCLE MANAGER
            // ─────────────────────────────────────────────────────────────────────
            const AppLifecycle = {
                _readyCallbacks: [],
                _errorCallbacks: [],
                _offlineCallbacks: [],
                _onlineCallbacks: [],
                _isReady: false,
                _isOnline: navigator.onLine,

                onReady(callback) {
                    if (this._isReady) {
                        callback();
                    } else {
                        this._readyCallbacks.push(callback);
                    }
                },

                onError(callback) {
                    this._errorCallbacks.push(callback);
                },

                onOffline(callback) {
                    this._offlineCallbacks.push(callback);
                    if (!this._isOnline) callback();
                },

                onOnline(callback) {
                    this._onlineCallbacks.push(callback);
                },

                _triggerReady() {
                    this._isReady = true;
                    this._readyCallbacks.forEach(cb => {
                        try { cb(); } catch (e) { FingoLogger.error('LIFECYCLE', 'Ready callback failed', e); }
                    });
                    FingoLogger.info('LIFECYCLE', '✓ App ready');
                },

                _triggerError(error) {
                    this._errorCallbacks.forEach(cb => {
                        try { cb(error); } catch (e) { FingoLogger.error('LIFECYCLE', 'Error callback failed', e); }
                    });
                },

                getStatus() {
                    return {
                        isReady: this._isReady,
                        isOnline: this._isOnline,
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    };
                }
            };

            // Network status listeners
            window.addEventListener('online', () => {
                AppLifecycle._isOnline = true;
                AppLifecycle._onlineCallbacks.forEach(cb => cb());
                FingoLogger.info('NETWORK', '✓ Connection restored');
            });

            window.addEventListener('offline', () => {
                AppLifecycle._isOnline = false;
                AppLifecycle._offlineCallbacks.forEach(cb => cb());
                FingoLogger.warn('NETWORK', '⚠️ Connection lost');
            });

            // DOM Ready trigger
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => AppLifecycle._triggerReady());
            } else {
                AppLifecycle._triggerReady();
            }

            // ─────────────────────────────────────────────────────────────────────
            // EXPOSE GLOBALLY
            // ─────────────────────────────────────────────────────────────────────
            window.FingoLogger = FingoLogger;
            window.safeFetch = safeFetch;
            window.AppLifecycle = AppLifecycle;

            FingoLogger.info('CORE', '✓ Fingo Core Infrastructure loaded');
        })();
    </script>

    <!-- ═══════════════════════════════════════════════════════════════════════════
     FINGO DATA VALIDATION - Input Validation & Sanitization
     ═══════════════════════════════════════════════════════════════════════════ -->
    <script>
        (function () {
            'use strict';

            const FingoValidator = {
                // ─────────────────────────────────────────────────────────────────
                // REQUIRED - Boş değer kontrolü
                // ─────────────────────────────────────────────────────────────────
                required(value, fieldName = 'Alan') {
                    if (value === null || value === undefined || String(value).trim() === '') {
                        return { valid: false, error: `${fieldName} boş bırakılamaz` };
                    }
                    return { valid: true, value: String(value).trim() };
                },

                // ─────────────────────────────────────────────────────────────────
                // EMAIL - Email format kontrolü
                // ─────────────────────────────────────────────────────────────────
                email(value) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    const trimmed = String(value || '').trim().toLowerCase();

                    if (!trimmed) {
                        return { valid: false, error: 'Email adresi gerekli' };
                    }
                    if (!emailRegex.test(trimmed)) {
                        return { valid: false, error: 'Geçersiz email formatı' };
                    }
                    return { valid: true, value: trimmed };
                },

                // ─────────────────────────────────────────────────────────────────
                // NUMBER - Sayı kontrolü (min/max opsiyonel)
                // ─────────────────────────────────────────────────────────────────
                number(value, { min = -Infinity, max = Infinity, fieldName = 'Değer' } = {}) {
                    const num = parseFloat(value);

                    if (isNaN(num)) {
                        return { valid: false, error: `${fieldName} geçerli bir sayı olmalı` };
                    }
                    if (num < min) {
                        return { valid: false, error: `${fieldName} en az ${min} olmalı` };
                    }
                    if (num > max) {
                        return { valid: false, error: `${fieldName} en fazla ${max} olabilir` };
                    }
                    return { valid: true, value: num };
                },

                // ─────────────────────────────────────────────────────────────────
                // CURRENCY - Para birimi kontrolü (pozitif sayı)
                // ─────────────────────────────────────────────────────────────────
                currency(value, { max = 999999999, fieldName = 'Tutar' } = {}) {
                    // Türkçe format desteği: "1.234,56" → "1234.56"
                    const cleaned = String(value || '')
                        .replace(/\s/g, '')
                        .replace(/\./g, '')
                        .replace(',', '.');

                    const num = parseFloat(cleaned);

                    if (isNaN(num)) {
                        return { valid: false, error: `${fieldName} geçerli bir tutar olmalı` };
                    }
                    if (num < 0) {
                        return { valid: false, error: `${fieldName} negatif olamaz` };
                    }
                    if (num > max) {
                        return { valid: false, error: `${fieldName} çok yüksek` };
                    }
                    return { valid: true, value: Math.round(num * 100) / 100 };
                },

                // ─────────────────────────────────────────────────────────────────
                // DATE - Tarih kontrolü
                // ─────────────────────────────────────────────────────────────────
                date(value, { future = true, past = true } = {}) {
                    const dateVal = new Date(value);

                    if (isNaN(dateVal.getTime())) {
                        return { valid: false, error: 'Geçersiz tarih formatı' };
                    }

                    const now = new Date();
                    now.setHours(0, 0, 0, 0);

                    if (!future && dateVal > now) {
                        return { valid: false, error: 'Gelecek tarih seçilemez' };
                    }
                    if (!past && dateVal < now) {
                        return { valid: false, error: 'Geçmiş tarih seçilemez' };
                    }

                    return { valid: true, value: dateVal.toISOString().split('T')[0] };
                },

                // ─────────────────────────────────────────────────────────────────
                // SANITIZE - XSS koruması için HTML temizleme
                // ─────────────────────────────────────────────────────────────────
                sanitize(value) {
                    if (value === null || value === undefined) return '';

                    return String(value)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#x27;')
                        .replace(/\//g, '&#x2F;');
                },

                // ─────────────────────────────────────────────────────────────────
                // VALIDATE FORM - Birden fazla alan kontrolü
                // ─────────────────────────────────────────────────────────────────
                validateForm(fields) {
                    const errors = [];
                    const values = {};

                    for (const [key, config] of Object.entries(fields)) {
                        const { value, type, options = {} } = config;
                        let result;

                        switch (type) {
                            case 'required':
                                result = this.required(value, options.fieldName);
                                break;
                            case 'email':
                                result = this.email(value);
                                break;
                            case 'number':
                                result = this.number(value, options);
                                break;
                            case 'currency':
                                result = this.currency(value, options);
                                break;
                            case 'date':
                                result = this.date(value, options);
                                break;
                            default:
                                result = { valid: true, value };
                        }

                        if (!result.valid) {
                            errors.push({ field: key, error: result.error });
                        } else {
                            values[key] = result.value;
                        }
                    }

                    return {
                        valid: errors.length === 0,
                        errors,
                        values
                    };
                }
            };

            // Expose globally
            window.FingoValidator = FingoValidator;

            if (window.FingoLogger) {
                window.FingoLogger.info('VALIDATOR', '✓ Data Validation module loaded');
            }
        })();
    </script>

    <!-- ═══════════════════════════════════════════════════════════════════════════
     SERVICE WORKER REGISTRATION
     ═══════════════════════════════════════════════════════════════════════════ -->
    <script>
        (function () {
            'use strict';

            // Service Worker registration (only in production/HTTPS)
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', async () => {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js', {
                            scope: '/'
                        });

                        if (window.FingoLogger) {
                            window.FingoLogger.info('SW', '✓ Service Worker registered', registration.scope);
                        }

                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (window.FingoLogger) {
                                        window.FingoLogger.info('SW', 'New version available');
                                    }
                                }
                            });
                        });

                    } catch (err) {
                        if (window.FingoLogger) {
                            window.FingoLogger.warn('SW', 'Registration failed', err.message);
                        }
                    }
                });
            }
        })();
    </script>


    <!-- ═══════════════════════════════════════════════════════════════════════════
     FINGO MOBILE NATIVE FEATURES - Capacitor Plugin Wrappers
     ═══════════════════════════════════════════════════════════════════════════ -->
    <script>
        (function () {
            'use strict';

            // Helper: Check if running in Capacitor native environment
            const isNative = () => window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform();
            const getPlugin = (name) => window.Capacitor?.Plugins?.[name];

            // ═══════════════════════════════════════════════════════════════════════
            // 1. FINGO HAPTICS - Dokunma Titreşimi
            // ═══════════════════════════════════════════════════════════════════════
            const FingoHaptics = {
                _enabled: true,

                // Toggle haptics
                setEnabled(enabled) {
                    this._enabled = enabled;
                    if (window.FingoLogger) FingoLogger.info('HAPTICS', enabled ? 'Enabled' : 'Disabled');
                },

                // Light impact (button taps)
                light() {
                    if (!this._enabled || !isNative()) return;
                    try {
                        getPlugin('Haptics')?.impact({ style: 'light' });
                    } catch (e) { /* silent */ }
                },

                // Medium impact (selections)
                medium() {
                    if (!this._enabled || !isNative()) return;
                    try {
                        getPlugin('Haptics')?.impact({ style: 'medium' });
                    } catch (e) { /* silent */ }
                },

                // Heavy impact (important actions)
                heavy() {
                    if (!this._enabled || !isNative()) return;
                    try {
                        getPlugin('Haptics')?.impact({ style: 'heavy' });
                    } catch (e) { /* silent */ }
                },

                // Success notification
                success() {
                    if (!this._enabled || !isNative()) return;
                    try {
                        getPlugin('Haptics')?.notification({ type: 'success' });
                    } catch (e) { /* silent */ }
                },

                // Warning notification
                warning() {
                    if (!this._enabled || !isNative()) return;
                    try {
                        getPlugin('Haptics')?.notification({ type: 'warning' });
                    } catch (e) { /* silent */ }
                },

                // Error notification
                error() {
                    if (!this._enabled || !isNative()) return;
                    try {
                        getPlugin('Haptics')?.notification({ type: 'error' });
                    } catch (e) { /* silent */ }
                },

                // Selection change (list scrolling)
                selection() {
                    if (!this._enabled || !isNative()) return;
                    try {
                        getPlugin('Haptics')?.selectionStart();
                        getPlugin('Haptics')?.selectionChanged();
                        getPlugin('Haptics')?.selectionEnd();
                    } catch (e) { /* silent */ }
                }
            };

            // ═══════════════════════════════════════════════════════════════════════
            // 2. FINGO STATUS BAR - Durum Çubuğu Kontrolü
            // ═══════════════════════════════════════════════════════════════════════
            const FingoStatusBar = {
                // Set style (light/dark content)
                async setStyle(style = 'dark') {
                    if (!isNative()) return;
                    try {
                        // style: 'dark' = dark icons (for light bg), 'light' = light icons (for dark bg)
                        await getPlugin('StatusBar')?.setStyle({ style: style.toUpperCase() });
                    } catch (e) {
                        if (window.FingoLogger) FingoLogger.warn('STATUSBAR', 'setStyle failed', e);
                    }
                },

                // Set background color
                async setBackgroundColor(color) {
                    if (!isNative()) return;
                    try {
                        await getPlugin('StatusBar')?.setBackgroundColor({ color });
                    } catch (e) { /* silent */ }
                },

                // Hide status bar
                async hide() {
                    if (!isNative()) return;
                    try {
                        await getPlugin('StatusBar')?.hide();
                    } catch (e) { /* silent */ }
                },

                // Show status bar
                async show() {
                    if (!isNative()) return;
                    try {
                        await getPlugin('StatusBar')?.show();
                    } catch (e) { /* silent */ }
                },

                // Set overlay (content goes under status bar)
                async setOverlay(overlay = true) {
                    if (!isNative()) return;
                    try {
                        await getPlugin('StatusBar')?.setOverlaysWebView({ overlay });
                    } catch (e) { /* silent */ }
                },

                // Apply theme-based style
                applyTheme() {
                    const isDark = document.documentElement.classList.contains('dark');
                    this.setStyle(isDark ? 'LIGHT' : 'DARK');
                    this.setBackgroundColor(isDark ? '#030014' : '#F4F6F9');
                }
            };

            // ═══════════════════════════════════════════════════════════════════════
            // 3. FINGO KEYBOARD - Klavye Yönetimi
            // ═══════════════════════════════════════════════════════════════════════
            const FingoKeyboard = {
                _listeners: [],

                // Initialize keyboard listeners
                init() {
                    if (!isNative()) return;

                    const Keyboard = getPlugin('Keyboard');
                    if (!Keyboard) return;

                    // Keyboard will show
                    Keyboard.addListener('keyboardWillShow', (info) => {
                        document.documentElement.style.setProperty('--keyboard-height', `${info.keyboardHeight}px`);
                        document.body.classList.add('keyboard-open');
                        this._listeners.forEach(cb => cb('show', info.keyboardHeight));
                        if (window.FingoLogger) FingoLogger.info('KEYBOARD', `Opened: ${info.keyboardHeight}px`);
                    });

                    // Keyboard will hide
                    Keyboard.addListener('keyboardWillHide', () => {
                        document.documentElement.style.setProperty('--keyboard-height', '0px');
                        document.body.classList.remove('keyboard-open');
                        this._listeners.forEach(cb => cb('hide', 0));
                        if (window.FingoLogger) FingoLogger.info('KEYBOARD', 'Closed');
                    });

                    if (window.FingoLogger) FingoLogger.info('KEYBOARD', '✓ Initialized');
                },

                // Subscribe to keyboard events
                onKeyboard(callback) {
                    this._listeners.push(callback);
                },

                // Hide keyboard programmatically
                async hide() {
                    if (!isNative()) return;
                    try {
                        await getPlugin('Keyboard')?.hide();
                    } catch (e) { /* silent */ }
                },

                // Show keyboard (focuses active element)
                async show() {
                    if (!isNative()) return;
                    try {
                        await getPlugin('Keyboard')?.show();
                    } catch (e) { /* silent */ }
                },

                // Set accessory bar visibility (iOS)
                async setAccessoryBarVisible(visible = true) {
                    if (!isNative()) return;
                    try {
                        await getPlugin('Keyboard')?.setAccessoryBarVisible({ isVisible: visible });
                    } catch (e) { /* silent */ }
                },

                // Set resize mode
                async setResizeMode(mode = 'native') {
                    if (!isNative()) return;
                    try {
                        // mode: 'native', 'body', 'ionic', 'none'
                        await getPlugin('Keyboard')?.setResizeMode({ mode });
                    } catch (e) { /* silent */ }
                }
            };

            // ═══════════════════════════════════════════════════════════════════════
            // 4. FINGO SPLASH SCREEN - Splash Kontrolü
            // ═══════════════════════════════════════════════════════════════════════
            const FingoSplash = {
                // Hide splash screen
                async hide(fadeOutDuration = 300) {
                    if (!isNative()) return;
                    try {
                        await getPlugin('SplashScreen')?.hide({ fadeOutDuration });
                        if (window.FingoLogger) FingoLogger.info('SPLASH', '✓ Hidden');
                    } catch (e) {
                        if (window.FingoLogger) FingoLogger.warn('SPLASH', 'Hide failed', e);
                    }
                },

                // Show splash screen
                async show(showDuration = 2000, autoHide = true) {
                    if (!isNative()) return;
                    try {
                        await getPlugin('SplashScreen')?.show({ showDuration, autoHide });
                    } catch (e) { /* silent */ }
                }
            };

            // ═══════════════════════════════════════════════════════════════════════
            // 5. FINGO APP STATE - Uygulama Durumu
            // ═══════════════════════════════════════════════════════════════════════
            const FingoAppState = {
                _foregroundCallbacks: [],
                _backgroundCallbacks: [],
                _isActive: true,

                // Initialize app state listeners
                init() {
                    if (!isNative()) {
                        // Web fallback using visibility API
                        document.addEventListener('visibilitychange', () => {
                            if (document.hidden) {
                                this._handleBackground();
                            } else {
                                this._handleForeground();
                            }
                        });
                        return;
                    }

                    const App = getPlugin('App');
                    if (!App) return;

                    App.addListener('appStateChange', ({ isActive }) => {
                        if (isActive) {
                            this._handleForeground();
                        } else {
                            this._handleBackground();
                        }
                    });

                    // Handle URL open (deep links)
                    App.addListener('appUrlOpen', (data) => {
                        if (window.FingoLogger) FingoLogger.info('APPSTATE', 'URL opened:', data.url);
                    });

                    // Handle back button (Android)
                    App.addListener('backButton', () => {
                        if (window.FingoLogger) FingoLogger.info('APPSTATE', 'Back button pressed');
                        // Can be overridden for custom behavior
                    });

                    if (window.FingoLogger) FingoLogger.info('APPSTATE', '✓ Initialized');
                },

                _handleForeground() {
                    this._isActive = true;
                    if (window.FingoLogger) FingoLogger.info('APPSTATE', '→ Foreground');
                    this._foregroundCallbacks.forEach(cb => {
                        try { cb(); } catch (e) { /* silent */ }
                    });
                },

                _handleBackground() {
                    this._isActive = false;
                    if (window.FingoLogger) FingoLogger.info('APPSTATE', '→ Background');
                    this._backgroundCallbacks.forEach(cb => {
                        try { cb(); } catch (e) { /* silent */ }
                    });
                },

                // Subscribe to foreground event
                onForeground(callback) {
                    this._foregroundCallbacks.push(callback);
                },

                // Subscribe to background event
                onBackground(callback) {
                    this._backgroundCallbacks.push(callback);
                },

                // Check if app is currently active
                isActive() {
                    return this._isActive;
                },

                // Exit app (Android only)
                async exitApp() {
                    if (!isNative()) return;
                    try {
                        await getPlugin('App')?.exitApp();
                    } catch (e) { /* silent */ }
                }
            };

            // ═══════════════════════════════════════════════════════════════════════
            // 6. FINGO SHARE - Native Paylaşım
            // ═══════════════════════════════════════════════════════════════════════
            const FingoShare = {
                // Share text
                async text(options) {
                    const { title = '', text = '', url = '', dialogTitle = 'Paylaş' } = options;

                    if (!isNative()) {
                        // Web fallback
                        if (navigator.share) {
                            try {
                                await navigator.share({ title, text, url });
                                return { success: true };
                            } catch (e) {
                                return { success: false, error: e.message };
                            }
                        }
                        return { success: false, error: 'Share not supported' };
                    }

                    try {
                        await getPlugin('Share')?.share({ title, text, url, dialogTitle });
                        FingoHaptics.success();
                        return { success: true };
                    } catch (e) {
                        return { success: false, error: e.message };
                    }
                },

                // Share transaction summary
                async shareTransaction(transaction) {
                    const type = transaction.type === 'income' ? 'Gelir' : 'Gider';
                    const amount = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(transaction.amount);

                    return await this.text({
                        title: `Fingo - ${type}`,
                        text: `${type}: ${amount}\nKategori: ${transaction.category}\nTarih: ${transaction.date}`,
                        dialogTitle: 'İşlemi Paylaş'
                    });
                },

                // Check if can share
                canShare() {
                    return isNative() || !!navigator.share;
                }
            };

            // ═══════════════════════════════════════════════════════════════════════
            // 7. FINGO BIOMETRIC - Biyometrik Kimlik Doğrulama
            // ═══════════════════════════════════════════════════════════════════════
            const FingoBiometric = {
                _available: null,

                // Check if biometric is available
                async isAvailable() {
                    if (this._available !== null) return this._available;

                    if (!isNative()) {
                        this._available = false;
                        return false;
                    }

                    try {
                        const result = await getPlugin('BiometricAuth')?.isAvailable();
                        this._available = result?.isAvailable || false;
                        if (window.FingoLogger) {
                            FingoLogger.info('BIOMETRIC', this._available ? '✓ Available' : 'Not available');
                        }
                        return this._available;
                    } catch (e) {
                        this._available = false;
                        return false;
                    }
                },

                // Authenticate with biometric
                async authenticate(reason = 'Kimliğinizi doğrulayın') {
                    if (!isNative()) {
                        return { success: false, error: 'Biometric not available' };
                    }

                    try {
                        const result = await getPlugin('BiometricAuth')?.authenticate({
                            reason,
                            title: 'Fingo Güvenlik',
                            subtitle: 'Devam etmek için kimliğinizi doğrulayın',
                            negativeButtonText: 'İptal'
                        });

                        if (result?.verified) {
                            FingoHaptics.success();
                            if (window.FingoLogger) FingoLogger.info('BIOMETRIC', '✓ Authenticated');
                            return { success: true };
                        } else {
                            FingoHaptics.error();
                            return { success: false, error: 'Authentication failed' };
                        }
                    } catch (e) {
                        FingoHaptics.error();
                        if (window.FingoLogger) FingoLogger.warn('BIOMETRIC', 'Auth failed', e);
                        return { success: false, error: e.message };
                    }
                },

                // Get biometric type (face, fingerprint, etc.)
                async getBiometryType() {
                    if (!isNative()) return 'none';

                    try {
                        const result = await getPlugin('BiometricAuth')?.getBiometryType();
                        // Returns: 'faceId', 'touchId', 'fingerprintAuthentication', 'irisAuthentication', 'none'
                        return result?.biometryType || 'none';
                    } catch (e) {
                        return 'none';
                    }
                }
            };

            // ═══════════════════════════════════════════════════════════════════════
            // INITIALIZATION & AUTO-SETUP
            // ═══════════════════════════════════════════════════════════════════════

            // Auto-initialize modules when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initMobileModules);
            } else {
                initMobileModules();
            }

            function initMobileModules() {
                // Initialize keyboard handling
                FingoKeyboard.init();

                // Initialize app state listeners
                FingoAppState.init();

                // Apply initial status bar theme
                FingoStatusBar.applyTheme();

                // Hide splash screen when app is ready
                setTimeout(() => FingoSplash.hide(300), 100);

                // Watch for theme changes
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'class') {
                            FingoStatusBar.applyTheme();
                        }
                    });
                });
                observer.observe(document.documentElement, { attributes: true });

                // Sync data when returning to foreground
                FingoAppState.onForeground(() => {
                    // Trigger data refresh if needed
                    if (typeof window.refreshDashboard === 'function') {
                        window.refreshDashboard();
                    }
                });

                if (window.FingoLogger) {
                    FingoLogger.info('MOBILE', '✓ All mobile modules initialized');
                }
            }

            // ═══════════════════════════════════════════════════════════════════════
            // GLOBAL EXPORTS
            // ═══════════════════════════════════════════════════════════════════════
            window.FingoHaptics = FingoHaptics;
            window.FingoStatusBar = FingoStatusBar;
            window.FingoKeyboard = FingoKeyboard;
            window.FingoSplash = FingoSplash;
            window.FingoAppState = FingoAppState;
            window.FingoShare = FingoShare;
            window.FingoBiometric = FingoBiometric;

            // Convenience: Add haptics to common UI elements
            document.addEventListener('click', (e) => {
                const target = e.target.closest('button, [role="button"], .clickable, [onclick]');
                if (target && !target.dataset.noHaptic) {
                    FingoHaptics.light();
                }
            }, { passive: true });

        })();
    </script>


    <script>
        // iOS Safari vh zıplamasını engellemek için --app-vh helper (THROTTLED)
        (function () {
            let raf = 0;
            let last = 0;

            function applyVH() {
                raf = 0;
                const h = (window.visualViewport?.height || window.innerHeight);
                // Aynı değeri tekrar set etme (çok önemli)
                if (Math.abs(h - last) < 1) return;
                last = h;
                document.documentElement.style.setProperty('--app-vh', (h * 0.01) + 'px');
            }

            function onResize() {
                if (raf) return;
                raf = requestAnimationFrame(applyVH);
            }

            // İlk set
            applyVH();

            // Passive + raf throttle
            window.addEventListener('resize', onResize, { passive: true });
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', onResize, { passive: true });
                window.visualViewport.addEventListener('scroll', onResize, { passive: true }); // iOS adres çubuğu zıplaması için
            }
        })();
    </script>

    <script>
        // Performance Mode detection (auto-enable on mobile/low-end devices)
        (function () {
            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            const isSmallScreen = window.matchMedia('(max-width: 768px)').matches;
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // Düşük cihaz sinyalleri (destek varsa)
            const lowMem = (navigator.deviceMemory && navigator.deviceMemory <= 4);
            const lowCPU = (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4);

            // Mobilde perf mode'u default aç (özellikle düşük sinyal varsa)
            const enablePerf = (isTouch && isSmallScreen) || prefersReducedMotion || lowMem || lowCPU;

            if (enablePerf) {
                document.documentElement.classList.add('perf');
            }
        })();
    </script>

    <script>
        // ✅ PERF PATCH: FPS-based performance tier (perf2) for extreme cases
        (function () {
            let frames = 0, last = performance.now(), lowStreak = 0;
            function tick(now) {
                frames++;
                if (now - last >= 1000) {
                    const fps = (frames * 1000) / (now - last);
                    frames = 0; last = now;
                    if (fps < 45) lowStreak++;
                    else lowStreak = Math.max(0, lowStreak - 1);
                    if (lowStreak >= 3 && !document.documentElement.classList.contains('perf2')) {
                        document.documentElement.classList.add('perf2');
                        console.log('[PERF] ⚠️ Low FPS detected, enabling perf2 mode');
                    }
                }
                requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        })();
    </script>

    <head>
        <meta charset="UTF-8">
        <meta name="color-scheme" content="dark light">
        <!-- Mobile Viewport - viewport-fit=cover for notched devices (iPhone X+, Android punch-hole) -->
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <title>Fingenda - Premium Finans</title>

        <!-- iOS/Apple Specific Meta Tags -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="Fingenda">
        <meta name="format-detection" content="telephone=no">
        <link rel="apple-touch-icon" href="Logo.jpg">
        <link rel="apple-touch-icon" sizes="180x180" href="Logo.jpg">
        <link rel="apple-touch-startup-image" href="Logo.jpg">

        <!-- Android/Chrome Specific Meta Tags -->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#4F46E5" media="(prefers-color-scheme: light)">
        <meta name="theme-color" content="#1a1625" media="(prefers-color-scheme: dark)">
        <meta name="msapplication-TileColor" content="#4F46E5">
        <meta name="msapplication-navbutton-color" content="#4F46E5">

        <!-- Favicon -->
        <link rel="icon" type="image/jpeg" href="Logo.jpg">
        <link rel="shortcut icon" type="image/jpeg" href="Logo.jpg">

        <!-- PWA Manifest -->
        <link rel="manifest" href="manifest.json">


        <!-- Tailwind CSS (Dark Mode Enabled) -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- PATCH: Tesseract.js removed from head - lazy loaded via ensureTesseract() -->
        <script>
            // CAPACITOR STORAGE WRAPPER (localStorage yerine bunu kullanacağız)
            const AppStorage = {
                async get(key) {
                    // Eğer Capacitor ortamındaysak ve Preferences plugini yüklüyse
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) {
                        const { value } = await window.Capacitor.Plugins.Preferences.get({ key });
                        return value;
                    }
                    // Değilse tarayıcı hafızasını kullan (Fallback)
                    return localStorage.getItem(key);
                },
                async set(key, value) {
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) {
                        await window.Capacitor.Plugins.Preferences.set({ key, value });
                    } else {
                        localStorage.setItem(key, value);
                    }
                },
                async remove(key) {
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) {
                        await window.Capacitor.Plugins.Preferences.remove({ key });
                    } else {
                        localStorage.removeItem(key);
                    }
                },
                async clear() {
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) {
                        await window.Capacitor.Plugins.Preferences.clear();
                    } else {
                        localStorage.clear();
                    }
                }
            };

            const APP_YEAR = new Date().getFullYear(); // Dinamik Yıl Yapısı

            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            soft: {
                                bg: '#F0F4F8',
                                card: 'rgba(255, 255, 255, 0.65)',
                                input: 'rgba(255, 255, 255, 0.5)',
                                text: '#111827'
                            },
                            dark: { bg: '#000000', card: '#1C1C1E', text: '#F2F2F7' }
                        },
                        fontFamily: {
                            'soft': ['"Nunito"', 'sans-serif'],
                            'body': ['"Inter"', 'sans-serif']
                        },
                        animation: {
                            'blob': 'blob 10s infinite',
                            'fade-in': 'fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                            'spin-slow': 'spin 4s linear infinite',
                            'float': 'float 7s ease-in-out infinite',
                            'aurora': 'aurora 20s linear infinite',
                            'slide-up': 'slideUp 0.4s ease-out forwards',
                        },
                        keyframes: {
                            blob: {
                                '0%': { transform: 'translate(0px, 0px) scale(1)' },
                                '33%': { transform: 'translate(30px, -50px) scale(1.2)' },
                                '66%': { transform: 'translate(-20px, 20px) scale(0.8)' },
                                '100%': { transform: 'translate(0px, 0px) scale(1)' },
                            },
                            fadeIn: {
                                '0%': { opacity: '0', transform: 'translateY(10px)' },
                                '100%': { opacity: '1', transform: 'translateY(0)' },
                            },
                            slideUp: {
                                '0%': { opacity: '0', transform: 'translateY(20px)' },
                                '100%': { opacity: '1', transform: 'translateY(0)' },
                            },
                            float: {
                                '0%, 100%': { transform: 'translateY(0)' },
                                '50%': { transform: 'translateY(-15px)' },
                            },
                            aurora: {
                                '0%': { backgroundPosition: '0% 50%' },
                                '50%': { backgroundPosition: '100% 50%' },
                                '100%': { backgroundPosition: '0% 50%' },
                            }
                        }
                    }
                }
            }
        </script>

        <style>
            /* FX icon - Light mode defaults (scoped to icon) */
            .fx-exchange-3d {
                display: block;
                transform: translateZ(0);

                /* Ana coin gradient - Light mode */
                --fx-stop1: #10b981;
                --fx-stop2: #22c55e;
                --fx-stop3: #14b8a6;

                /* Gloss */
                --fx-gloss1: rgba(255, 255, 255, 0.85);
                --fx-gloss2: rgba(255, 255, 255, 0.00);

                /* İşaret/ok rengi */
                --fx-coinMark: rgba(255, 255, 255, 0.95);

                /* Dış cam halka */
                --fx-coinGlass: rgba(255, 255, 255, 0.55);

                /* Gölge */
                --fx-shadow: rgba(0, 0, 0, 0.22);
            }

            /* FX icon - Dark mode overrides */
            html.dark .fx-exchange-3d {
                --fx-stop1: #4f46e5;
                --fx-stop2: #7c3aed;
                --fx-stop3: #22c55e;

                --fx-gloss1: rgba(255, 255, 255, 0.35);
                --fx-gloss2: rgba(255, 255, 255, 0.00);

                --fx-coinMark: rgba(255, 255, 255, 0.95);
                --fx-coinGlass: rgba(255, 255, 255, 0.08);
                --fx-shadow: rgba(0, 0, 0, 0.35);
            }
        </style>

        <!-- Chart.js & Plugins (Grafik Kütüphaneleri) -->
        <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
        <!-- TensorFlow.js removed - not used, lazy-load if needed via ensureTF() -->

        <!-- Google Fonts -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Nunito:wght@600;700;800;900&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap"
            rel="stylesheet">

        <!-- Marked for Markdown parsing (AI yanıtları için) -->
        <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

        <!-- jsPDF & AutoTable (PDF Raporlama için) -->
        <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script defer
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

        <!-- Vanilla Tilt (3D Parallax Effects) -->
        <script defer src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    // ✅ PERF PATCH: Skip VanillaTilt on mobile/touch/perf devices
                    const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                    const isPerf = document.documentElement.classList.contains('perf') ||
                        document.documentElement.classList.contains('perf2');
                    if (isTouch || isPerf) {
                        console.log('[PERF] VanillaTilt disabled (touch/perf device)');
                        return;
                    }

                    if (typeof VanillaTilt !== 'undefined') {
                        VanillaTilt.init(document.querySelectorAll(".soft-card"), {
                            max: 5,
                            speed: 400,
                            glare: true,
                            "max-glare": 0.2,
                            scale: 1.02
                        });
                        VanillaTilt.init(document.querySelectorAll(".tilt-card"), {
                            max: 10,
                            speed: 400,
                            glare: true,
                            "max-glare": 0.3
                        });
                    }
                }, 500);
            })
        </script>

        <!-- 1. KONFETİ CDN EKLEME -->
        <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

        <!-- Google Generative AI Import Map -->
        <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

        <style>
            /* ============================================== */
            /* MOBILE PLATFORM OPTIMIZATIONS                 */
            /* iOS & Android Safe Areas + Touch Support      */
            /* ============================================== */

            /* === SAFE AREA CSS VARIABLES (Notched Devices) === */
            :root {
                --safe-area-top: env(safe-area-inset-top, 0px);
                --safe-area-right: env(safe-area-inset-right, 0px);
                --safe-area-bottom: env(safe-area-inset-bottom, 0px);
                --safe-area-left: env(safe-area-inset-left, 0px);
                --micro-feedback-bottom: calc(var(--safe-area-bottom, 20px) + 90px);
                --app-vh: 1vh;
                /* PATCH: Dynamic vh for iOS */

                /* FingoBrain V4 Design System variables are defined below in the
               html.dark / html:not(.dark) scoped blocks (~line 15240+) */
            }

            /* PATCH: Modal Open - Body Scroll Lock (iOS stable) */
            body.modal-open {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
            }

            /* === SAFE-AREA AWARE CLOSE BUTTON (iOS / Notched Devices Fix) === */
            .safe-close-btn {
                position: fixed !important;
                top: calc(var(--safe-area-top) + 12px) !important;
                right: calc(var(--safe-area-right) + 12px) !important;
                z-index: 99999 !important;
                pointer-events: auto;
                touch-action: manipulation;
                width: 44px;
                height: 44px;
                border-radius: 9999px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: rgba(255, 255, 255, 0.8);
                transition: all 0.2s ease;
            }

            .safe-close-btn:hover {
                background: rgba(255, 255, 255, 0.25);
                transform: scale(1.05);
            }

            .safe-close-btn:active {
                transform: scale(0.95);
            }

            /* Light mode variant */
            html:not(.dark) .safe-close-btn {
                background: rgba(0, 0, 0, 0.08);
                border-color: rgba(0, 0, 0, 0.1);
                color: rgba(0, 0, 0, 0.6);
            }

            html:not(.dark) .safe-close-btn:hover {
                background: rgba(0, 0, 0, 0.15);
                color: rgba(239, 68, 68, 0.9);
            }

            /* === GLOBAL MOBILE OPTIMIZATIONS === */
            * {
                /* Remove tap highlight on iOS */
                -webkit-tap-highlight-color: transparent;
                /* Prevent text selection on UI elements */
                -webkit-touch-callout: none;
            }

            html {
                /* Prevent elastic overscroll on iOS */
                overscroll-behavior: none;
                /* Smoother scrolling */
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }

            body {
                /* Prevent pull-to-refresh */
                overscroll-behavior-y: contain;
                /* Fix iOS input zoom */
                -webkit-text-size-adjust: 100%;
                /* GPU acceleration */
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                /* Prevent rubber-banding on iOS */
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            /* === TOUCH OPTIMIZATIONS === */
            button,
            a,
            [onclick],
            .clickable {
                /* Faster touch response */
                touch-action: manipulation;
                /* Prevent double-tap zoom */
                -ms-touch-action: manipulation;
                /* Allow text selection only on content */
                -webkit-user-select: none;
                user-select: none;
            }

            input,
            textarea,
            select {
                /* Allow normal touch on form elements */
                touch-action: auto;
                -webkit-user-select: text;
                user-select: text;
                /* Prevent zoom on input focus (iOS) */
                font-size: 16px !important;
            }

            /* === HARDWARE ACCELERATION === */
            .hw-accelerated {
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                will-change: transform;
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
            }

            /* === SCROLLABLE CONTAINERS (Native Feel) === */
            .mobile-scroll {
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                /* Momentum scrolling */
                scroll-snap-type: y proximity;
            }

            /* Hide scrollbar on mobile but keep functionality */
            .mobile-scroll::-webkit-scrollbar {
                width: 0;
                height: 0;
                display: none;
            }

            /* === SAFE AREA PADDING UTILITIES === */
            .pt-safe {
                padding-top: var(--safe-area-top);
            }

            .pb-safe {
                padding-bottom: var(--safe-area-bottom);
            }

            .pl-safe {
                padding-left: var(--safe-area-left);
            }

            .pr-safe {
                padding-right: var(--safe-area-right);
            }

            .px-safe {
                padding-left: var(--safe-area-left);
                padding-right: var(--safe-area-right);
            }

            .py-safe {
                padding-top: var(--safe-area-top);
                padding-bottom: var(--safe-area-bottom);
            }

            .mt-safe {
                margin-top: var(--safe-area-top);
            }

            .mb-safe {
                margin-bottom: var(--safe-area-bottom);
            }

            /* ═══════════════════════════════════════════════════════════════════════════
           APPLE AWARD DESIGN SYSTEM v2 - SOFT NEUMORPHISM + FROSTED GLASS + CAPSULE
           ═══════════════════════════════════════════════════════════════════════════ */

            /* ─────────────────────────────────────────────────────────────────────────
           DESIGN TOKENS - LIGHT MODE (TRENDORA MINIMAL STYLE)
           ───────────────────────────────────────────────────────────────────────── */
            :root {
                /* === SPACING GRID (8px base) === */
                --neo-space-1: 4px;
                --neo-space-2: 8px;
                --neo-space-3: 12px;
                --neo-space-4: 16px;
                --neo-space-5: 20px;
                --neo-space-6: 24px;
                --neo-space-8: 32px;
                --neo-space-10: 40px;
                --neo-space-12: 48px;

                /* === RADIUS (Trendora - Softer) === */
                --neo-r-base: 20px;
                --neo-r-card: 24px;
                --neo-r-sheet: 32px;
                --neo-r-capsule: 9999px;
                --neo-r-sm: 14px;

                /* === TYPOGRAPHY (Modern Stack) === */
                --neo-font: 'Inter', 'SF Pro Display', system-ui, -apple-system, sans-serif;
                --neo-font-heading: 'Inter', 'SF Pro Display', sans-serif;

                --neo-text-xs: 11px;
                --neo-text-sm: 13px;
                --neo-text-base: 15px;
                --neo-text-lg: 17px;
                --neo-text-xl: 22px;
                --neo-text-2xl: 28px;
                --neo-text-3xl: 34px;

                --neo-weight-regular: 400;
                --neo-weight-medium: 500;
                --neo-weight-semibold: 600;
                --neo-weight-bold: 700;
                --neo-weight-black: 800;

                /* === COLORS - LIGHT MODE (TRENDORA MINIMAL) === */
                --neo-bg: #FAFAFA;
                /* Clean light gray */
                --neo-bg-elevated: #FFFFFF;
                --neo-bg-secondary: #F5F5F5;
                --neo-surface: rgba(255, 255, 255, 0.95);
                /* More opaque for clarity */
                --neo-surface-elevated: rgba(255, 255, 255, 0.98);

                --neo-stroke: rgba(0, 0, 0, 0.06);
                /* Very subtle stroke */
                --neo-stroke-strong: rgba(0, 0, 0, 0.10);

                --neo-text-primary: #1A1A1A;
                /* Rich Black */
                --neo-text-secondary: #4A4A4A;
                /* Warm Dark Gray */
                --neo-text-tertiary: #6E6E6E;
                /* Medium Gray */
                --neo-text-muted: #9E9E9E;

                /* Accent Colors - Trendora Olive Palette */
                --neo-accent: #5C6B4A;
                /* Olive Green - Primary */
                --neo-accent-soft: rgba(92, 107, 74, 0.10);
                --neo-accent-purple: #6B5C7B;
                /* Muted Purple */
                --neo-accent-indigo: #5A6B7B;
                /* Slate Blue */
                --neo-accent-secondary: #E86A33;
                /* Orange accent */
                --neo-accent-secondary-soft: rgba(232, 106, 51, 0.12);

                --neo-success: #4CAF50;
                /* Clean Green */
                --neo-success-soft: rgba(76, 175, 80, 0.12);
                --neo-danger: #E53935;
                /* Clean Red */
                --neo-danger-soft: rgba(229, 57, 53, 0.12);
                --neo-warning: #FB8C00;
                /* Warm Orange */
                --neo-warning-soft: rgba(251, 140, 0, 0.12);

                /* === SHADOWS - TRENDORA MINIMAL (Very Soft) === */
                --neo-shadow-ambient: 0 1px 3px rgba(0, 0, 0, 0.02), 0 2px 8px rgba(0, 0, 0, 0.03);
                --neo-shadow-lift: 0 4px 12px rgba(0, 0, 0, 0.04), 0 2px 4px rgba(0, 0, 0, 0.02);
                --neo-shadow-soft: 0 1px 2px rgba(0, 0, 0, 0.02), 0 2px 6px rgba(0, 0, 0, 0.03);
                --neo-shadow-inset: inset 0 1px 2px rgba(0, 0, 0, 0.02);
                --neo-shadow-inner-highlight: inset 0 1px 0 rgba(255, 255, 255, 0.8);
                --neo-shadow-inner-glow: none;
                --neo-shadow-float: 0 8px 24px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.03);
                --neo-shadow-pressed: inset 0 1px 3px rgba(0, 0, 0, 0.04);

                /* === GLASS / FROSTED (TRENDORA - Minimal Glass) === */
                --glass-bg: rgba(255, 255, 255, 0.92);
                --glass-bg-elevated: rgba(255, 255, 255, 0.96);
                --glass-bg-strong: rgba(255, 255, 255, 0.98);
                --glass-bg-subtle: rgba(255, 255, 255, 0.75);
                --glass-blur: blur(16px);
                --glass-saturate: saturate(120%);
                /* Less aggressive */
                --glass-border: rgba(0, 0, 0, 0.04);
                --glass-border-strong: rgba(0, 0, 0, 0.08);
                --glass-depth-gradient: linear-gradient(180deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 100%);
                --glass-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                --glass-shadow-elevated: 0 8px 24px rgba(0, 0, 0, 0.05);

                /* Trendora Gradients */
                --gradient-primary: linear-gradient(135deg, #5C6B4A 0%, #7A8B6A 100%);
                --gradient-soft: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 250, 250, 0.8) 100%);
                --gradient-subtle: linear-gradient(180deg, rgba(255, 255, 255, 0.5) 0%, rgba(255, 255, 255, 0.2) 100%);
                --gradient-accent: linear-gradient(135deg, #5C6B4A 0%, #4A5548 100%);

                /* === TRANSITIONS (Trendora - Smooth & Fast) === */
                --neo-ease: cubic-bezier(0.4, 0, 0.2, 1);
                /* Material standard */
                --neo-ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
                /* Subtle bounce */
                --neo-ease-out: cubic-bezier(0.0, 0, 0.2, 1);
                --neo-duration-fast: 150ms;
                --neo-duration: 250ms;
                --neo-duration-slow: 350ms;

                /* === TOUCH TARGETS === */
                --neo-touch-min: 44px;
                --neo-touch-comfortable: 56px;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           DESIGN TOKENS - DARK MODE (TRENDORA MINIMAL DARK)
           ───────────────────────────────────────────────────────────────────────── */
            html.dark {
                /* === COLORS - DARK MODE (Trendora Warm Dark) === */
                --neo-bg: #1C1C1E;
                /* iOS Dark */
                --neo-bg-elevated: #2C2C2E;
                /* Elevated Surface */
                --neo-bg-secondary: #242426;
                --neo-surface: rgba(44, 44, 46, 0.92);
                --neo-surface-elevated: rgba(58, 58, 60, 0.95);
                --neo-stroke: rgba(255, 255, 255, 0.08);
                --neo-stroke-strong: rgba(255, 255, 255, 0.14);
                --neo-text-primary: #FAFAFA;
                --neo-text-secondary: #A0A0A0;
                --neo-text-tertiary: #707070;
                --neo-text-muted: #505050;

                /* Accent Colors - Trendora Olive (Light version for dark mode) */
                --neo-accent: #8DA373;
                /* Light Olive */
                --neo-accent-soft: rgba(141, 163, 115, 0.15);
                --neo-accent-purple: #9D8DAD;
                /* Light Muted Purple */
                --neo-accent-indigo: #8A9BAB;
                /* Light Slate Blue */
                --neo-accent-secondary: #FF8A50;
                /* Lighter Orange */
                --neo-accent-secondary-soft: rgba(255, 138, 80, 0.15);

                --neo-success: #66BB6A;
                /* Light Green */
                --neo-success-soft: rgba(102, 187, 106, 0.18);
                --neo-danger: #EF5350;
                /* Light Red */
                --neo-danger-soft: rgba(239, 83, 80, 0.18);
                --neo-warning: #FFA726;
                /* Light Orange */
                --neo-warning-soft: rgba(255, 167, 38, 0.18);

                /* === SHADOWS - TRENDORA MINIMAL DARK === */
                --neo-shadow-ambient: 0 2px 8px rgba(0, 0, 0, 0.25);
                --neo-shadow-lift: 0 4px 16px rgba(0, 0, 0, 0.30);
                --neo-shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.20);
                --neo-shadow-inset: inset 0 1px 2px rgba(0, 0, 0, 0.15);
                --neo-shadow-inner-highlight: inset 0 1px 0 rgba(255, 255, 255, 0.06);
                --neo-shadow-inner-glow: none;
                --neo-shadow-float: 0 8px 32px rgba(0, 0, 0, 0.40);
                --neo-shadow-pressed: inset 0 2px 4px rgba(0, 0, 0, 0.25);

                /* === GLASS / FROSTED - DARK (TRENDORA) === */
                --glass-bg: rgba(44, 44, 46, 0.88);
                --glass-bg-elevated: rgba(58, 58, 60, 0.92);
                --glass-bg-strong: rgba(70, 70, 72, 0.95);
                --glass-bg-subtle: rgba(44, 44, 46, 0.70);
                --glass-border: rgba(255, 255, 255, 0.06);
                --glass-border-strong: rgba(255, 255, 255, 0.10);
                --glass-depth-gradient: linear-gradient(180deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0) 100%);
                --glass-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
                --glass-shadow-elevated: 0 8px 32px rgba(0, 0, 0, 0.35);

                /* Trendora Dark Gradients */
                --gradient-primary: linear-gradient(135deg, #8DA373 0%, #6B8B5A 100%);
                --gradient-accent: linear-gradient(135deg, #8DA373 0%, #7A9B6A 100%);
            }

            /* ═══════════════════════════════════════════════════════════════
           ✅ PERF PATCH: PERFORMANCE MODE CSS OVERRIDES
           ═══════════════════════════════════════════════════════════════ */

            /* Glass blur reduction for perf mode */
            html.perf {
                --glass-blur: blur(12px);
            }

            html.perf2 {
                --glass-blur: blur(0px);
            }

            /* Increase opacity when blur is reduced to maintain visual appearance */
            html.perf2 {
                --glass-bg: rgba(20, 24, 40, 0.88);
            }

            html.perf2:not(.dark) {
                --glass-bg: rgba(255, 255, 255, 0.92);
            }

            /* Disable expensive animations in perf mode */
            html.perf .soft-surface::before,
            html.perf body::before,
            html.perf body::after,
            html.perf #app-container::before {
                animation: none !important;
            }

            /* PERF2: Extreme optimization - kill all blurs and heavy shadows */
            html.perf2 .soft-card,
            html.perf2 .glass-card,
            html.perf2 .capsule,
            html.perf2 .capsule-item {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            html.perf2 .soft-surface::before,
            html.perf2 body::before,
            html.perf2 body::after {
                filter: blur(0px) !important;
                opacity: 0.15 !important;
                animation: none !important;
            }

            /* Content-visibility for offscreen screens (render optimization) */
            html.perf [id^="screen-"].hidden,
            html.perf2 [id^="screen-"].hidden {
                content-visibility: auto;
                contain-intrinsic-size: 0 800px;
            }

            /* GPU acceleration hints for animated elements */
            html.perf .soft-card,
            html.perf2 .soft-card,
            html.perf .glass-card,
            html.perf2 .glass-card {
                will-change: transform;
                transform: translateZ(0);
            }

            /* ═══════════════════════════════════════════════════════════════
           ✅ RESTORE FROSTED GLASS FOR HEADER & NAV (Override Perf Mode)
           ═══════════════════════════════════════════════════════════════ */
            /* Force blur on header and nav even if perf mode is on */
            html.perf #main-header,
            html.perf2 #main-header,
            html.perf #main-nav,
            html.perf2 #main-nav {
                backdrop-filter: blur(32px) saturate(200%) brightness(1.05) !important;
                -webkit-backdrop-filter: blur(32px) saturate(200%) brightness(1.05) !important;
            }

            /* Light Mode Specifics */
            html.perf #main-header,
            html.perf2 #main-header,
            html.perf #main-nav,
            html.perf2 #main-nav {
                background: rgba(255, 255, 255, 0.3) !important;
            }

            /* Dark Mode Override */
            html.dark.perf #main-header,
            html.dark.perf2 #main-header,
            html.dark.perf #main-nav,
            html.dark.perf2 #main-nav {
                background: rgba(15, 23, 42, 0.3) !important;
                backdrop-filter: blur(32px) saturate(180%) brightness(0.95) !important;
                -webkit-backdrop-filter: blur(32px) saturate(180%) brightness(0.95) !important;
            }

            /* Disable 3D transforms and complex animations in perf2 */
            html.perf2 .animate-float-3d,
            html.perf2 .animate-float,
            html.perf2 .tilt-card,
            html.perf2 .card-3d {
                animation: none !important;
                transform: none !important;
            }

            /* Reduce transition complexity in perf mode */
            html.perf .soft-card,
            html.perf2 .soft-card {
                transition: transform 0.2s ease, opacity 0.2s ease !important;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - SOFT SURFACE (Page Background)
           ───────────────────────────────────────────────────────────────────────── */
            .soft-surface {
                background: transparent;
                min-height: 100%;
            }

            .soft-surface::before {
                content: '';
                position: fixed;
                inset: 0;
                pointer-events: none;
                /* TRENDORA: Clean minimal background - Light Mode */
                background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 50%, #F0F0F0 100%);
                opacity: 1;
                z-index: -1;
            }

            /* ═══════════════════════════════════════════════════════════════════════════
           BOTTOM SHEET / MODAL ARKA PLAN DÜZELTMESİ
           ═══════════════════════════════════════════════════════════════════════════ */

            /* Genel Bottom Sheet Sınıfları */
            .bottom-sheet,
            .sheet-content,
            .modal-content,
            [class*="bottom-sheet"] {
                /* Arka planı tamamen opak (mat) beyaz yap */
                background-color: #ffffff !important;

                /* Şeffaflığı önle */
                opacity: 1 !important;

                /* Varsa bulanıklık efektini kaldır ki net görünsün */
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;

                /* İçeriğin arkasının görünmemesi için z-index ayarı */
                z-index: 9999;
            }

            /* Dark mode için koyu arka plan */
            html.dark .bottom-sheet,
            html.dark .sheet-content,
            html.dark .modal-content,
            html.dark [class*="bottom-sheet"] {
                background-color: #1e1e1e !important;
            }

            /* Grafiklerin olduğu kapsayıcıların da şeffaf olmadığından emin olalım */
            #assetAllocationChart,
            #expenseAnalysisChart,
            #incomeAnalysisChart {
                background-color: #ffffff;
                /* Grafik zeminini de beyaz yapar */
                border-radius: 12px;
                /* Köşeleri yumuşatır, estetiği korur */
            }

            html.dark #assetAllocationChart,
            html.dark #expenseAnalysisChart,
            html.dark #incomeAnalysisChart {
                background-color: #1e1e1e;
                /* Koyu temada grafik zemini */
            }

            html.dark .soft-surface::before {
                /* TRENDORA: Clean dark background - Dark Mode */
                background: linear-gradient(180deg, #1C1C1E 0%, #242426 50%, #2C2C2E 100%);
                opacity: 1;
            }

            /* ═══════════════════════════════════════════════════════════════════════════
           ADVANCED FILTER MODAL - DARK MODE COMPATIBLE
           ═══════════════════════════════════════════════════════════════════════════ */

            /* Modal Content Container */
            .filter-modal-content {
                background: #ffffff;
                border-radius: 32px 32px 0 0;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15);
                max-height: 85vh;
                overflow-y: auto;
            }

            html.dark .filter-modal-content {
                background: #1c1c1e;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            }

            /* Filter Section */
            .filter-section {
                margin-bottom: 24px;
            }

            /* Filter Label */
            .filter-label {
                display: block;
                font-size: 12px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: #6b7280;
                margin-bottom: 12px;
            }

            html.dark .filter-label {
                color: #9ca3af;
            }

            /* Filter Chip Group */
            .filter-chip-group {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                padding: 16px;
                background: #f3f4f6;
                border-radius: 16px;
                border: 1px solid #e5e7eb;
            }

            html.dark .filter-chip-group {
                background: rgba(30, 30, 45, 0.9);
                border-color: rgba(255, 255, 255, 0.12);
            }

            /* Filter Chip */
            .filter-chip {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 10px 16px;
                border-radius: 12px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 1px solid transparent;
                background: #ffffff;
                color: #374151;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            }

            html.dark .filter-chip {
                background: rgba(45, 45, 65, 0.95);
                color: #e5e7eb;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                border-color: rgba(139, 92, 246, 0.25);
            }

            .filter-chip:hover {
                background: #f3f4f6;
                transform: translateY(-1px);
            }

            html.dark .filter-chip:hover {
                background: #3d3d4a;
            }

            .filter-chip.active {
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                color: #ffffff;
                border-color: transparent;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
            }

            html.dark .filter-chip.active {
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                color: #ffffff;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            }

            /* AG Input (Filter Inputs) */
            .ag-input {
                width: 100%;
                padding: 14px 16px;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 500;
                border: 1px solid #e5e7eb;
                background: #ffffff;
                color: #1f2937;
                transition: all 0.2s ease;
            }

            html.dark .ag-input {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.15);
                color: #f3f4f6;
            }

            .ag-input::placeholder {
                color: #9ca3af;
            }

            html.dark .ag-input::placeholder {
                color: #6b7280;
            }

            .ag-input:focus {
                outline: none;
                border-color: #6366f1;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
            }

            html.dark .ag-input:focus {
                border-color: #818cf8;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
            }

            /* Date Input Dark Mode Fix */
            html.dark .ag-input[type="date"]::-webkit-calendar-picker-indicator {
                filter: invert(1);
            }

            /* Filter Range Row */
            .filter-range-row {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - SOFT CARD (Neumorphic Glass Card)
           ───────────────────────────────────────────────────────────────────────── */
            .soft-card {
                position: relative;
                background: var(--neo-bg-elevated);
                backdrop-filter: var(--glass-blur);
                -webkit-backdrop-filter: var(--glass-blur);
                border-radius: var(--neo-r-card);
                border: 1px solid var(--glass-border);
                box-shadow: var(--neo-shadow-soft);
                padding: var(--neo-space-5);
                transition: transform var(--neo-duration-fast) var(--neo-ease),
                    box-shadow var(--neo-duration-fast) var(--neo-ease),
                    background-color var(--neo-duration-fast) var(--neo-ease);
            }

            .soft-card::before {
                content: '';
                position: absolute;
                inset: 0;
                border-radius: inherit;
                background: var(--glass-depth-gradient);
                pointer-events: none;
                opacity: 0.5;
            }

            /* Trendora Hover Effect */
            .soft-card:hover {
                transform: translateY(-2px) scale(1.01);
                box-shadow: var(--neo-shadow-lift);
            }

            .soft-card:active {
                transform: scale(0.98);
                box-shadow: var(--neo-shadow-pressed);
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - CAPSULE (Pill Shape)
           ───────────────────────────────────────────────────────────────────────── */
            .capsule {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: var(--neo-touch-min);
                padding: 0 var(--neo-space-5);
                border-radius: var(--neo-r-capsule);
                background: var(--glass-bg);
                backdrop-filter: var(--glass-blur);
                -webkit-backdrop-filter: var(--glass-blur);
                border: 1px solid var(--neo-stroke);
                box-shadow: var(--neo-shadow-inner-highlight);
                font-size: var(--neo-text-base);
                font-weight: var(--neo-weight-medium);
                color: var(--neo-text-primary);
                transition: all var(--neo-duration-fast) var(--neo-ease);
            }

            .capsule:active {
                transform: scale(0.97);
                box-shadow: var(--neo-shadow-pressed);
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - CAPSULE ITEM (List Row)
           ───────────────────────────────────────────────────────────────────────── */
            .capsule-item {
                display: flex;
                align-items: center;
                gap: var(--neo-space-3);
                min-height: var(--neo-touch-comfortable);
                padding: var(--neo-space-4) var(--neo-space-5);
                border-radius: var(--neo-r-base);
                background: var(--glass-bg);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid var(--neo-stroke);
                box-shadow: var(--neo-shadow-soft), var(--neo-shadow-inner-highlight);
                transition: all var(--neo-duration-fast) var(--neo-ease);
                cursor: pointer;
            }

            .capsule-item:active {
                transform: scale(0.985);
                background: var(--glass-bg-elevated);
            }

            .capsule-item .item-icon {
                width: 40px;
                height: 40px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                flex-shrink: 0;
            }

            .capsule-item .item-content {
                flex: 1;
                min-width: 0;
            }

            .capsule-item .item-title {
                font-size: var(--neo-text-base);
                font-weight: var(--neo-weight-semibold);
                color: var(--neo-text-primary);
                line-height: 1.3;
            }

            .capsule-item .item-subtitle {
                font-size: var(--neo-text-sm);
                color: var(--neo-text-secondary);
                line-height: 1.3;
            }

            .capsule-item .item-value {
                font-size: var(--neo-text-lg);
                font-weight: var(--neo-weight-bold);
                color: var(--neo-text-primary);
            }

            .capsule-item .item-chevron {
                width: 20px;
                height: 20px;
                color: var(--neo-text-tertiary);
            }

            /* ─────────────────────────────────────────────────────────────────────────
           PHASE 2: 3D UNIVERSE UTILITIES
           ───────────────────────────────────────────────────────────────────────── */

            /* 1. Parallax Card with Depth */
            .tilt-card {
                transform-style: preserve-3d;
                transform: perspective(1000px);
            }

            .tilt-inner {
                transform: translateZ(20px);
            }

            /* 2. Advanced 3D Icons */
            .icon-3d-wrapper {
                position: relative;
                transform-style: preserve-3d;
                transition: transform 0.3s var(--neo-ease);
            }

            .icon-3d-layer {
                position: absolute;
                inset: 0;
                backface-visibility: hidden;
            }

            /* Cinema Grade Animations */
            @keyframes float-3d {

                0%,
                100% {
                    transform: translateY(0) rotateX(0) rotateY(0);
                }

                50% {
                    transform: translateY(-12px) rotateX(5deg) rotateY(5deg);
                }
            }

            .animate-float-3d {
                animation: float-3d 6s ease-in-out infinite;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           PHASE 2: 3D UNIVERSE UTILITIES
           ───────────────────────────────────────────────────────────────────────── */

            /* 1. Parallax Card with Depth */
            .tilt-card {
                transform-style: preserve-3d;
                transform: perspective(1000px);
            }

            .tilt-inner {
                transform: translateZ(20px);
            }

            /* 2. Advanced 3D Icons */
            .icon-3d-wrapper {
                position: relative;
                transform-style: preserve-3d;
                transition: transform 0.3s var(--neo-ease);
            }

            .icon-3d-layer {
                position: absolute;
                inset: 0;
                backface-visibility: hidden;
            }

            .icon-3d-layer:nth-child(1) {
                transform: translateZ(0px);
                opacity: 0.8;
                filter: blur(4px);
            }

            .icon-3d-layer:nth-child(2) {
                transform: translateZ(10px);
            }

            .icon-3d-layer:nth-child(3) {
                transform: translateZ(20px);
                filter: brightness(1.2);
            }

            /* Cinema Grade Animations */
            @keyframes float-3d {

                0%,
                100% {
                    transform: translateY(0) rotateX(0) rotateY(0);
                }

                50% {
                    transform: translateY(-12px) rotateX(5deg) rotateY(5deg);
                }
            }

            .animate-float-3d {
                animation: float-3d 6s ease-in-out infinite;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           PHASE 3: MOTION & PHYSICS - TRENDORA MINIMAL
           ───────────────────────────────────────────────────────────────────────── */

            /* 1. Smooth Modal Animation */
            @keyframes modal-spring-in {
                0% {
                    transform: translateY(30px);
                    opacity: 0;
                }

                100% {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-open .modal-content,
            .sheet-open .sheet-content {
                animation: modal-spring-in 0.25s ease-out forwards;
            }

            /* 2. Staggered List entry - TRENDORA MINIMAL */
            @keyframes list-slide-in {
                from {
                    opacity: 0;
                    transform: translateY(12px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .capsule-item {
                animation: list-slide-in 0.3s ease-out forwards;
                opacity: 0;
            }

            /* Stagger delays - faster */
            .capsule-item:nth-child(1) {
                animation-delay: 0.02s;
            }

            .capsule-item:nth-child(2) {
                animation-delay: 0.04s;
            }

            .capsule-item:nth-child(3) {
                animation-delay: 0.06s;
            }

            .capsule-item:nth-child(4) {
                animation-delay: 0.08s;
            }

            .capsule-item:nth-child(5) {
                animation-delay: 0.10s;
            }

            .capsule-item:nth-child(6) {
                animation-delay: 0.12s;
            }

            .capsule-item:nth-child(7) {
                animation-delay: 0.14s;
            }

            .capsule-item:nth-child(8) {
                animation-delay: 0.16s;
            }

            .capsule-item:nth-child(9) {
                animation-delay: 0.18s;
            }

            .capsule-item:nth-child(10) {
                animation-delay: 0.20s;
            }

            /* 3. Magnetic Button Effect */
            .magnetic-btn {
                transition: transform 0.15s ease, box-shadow 0.15s ease;
            }

            .magnetic-btn:active {
                transform: scale(0.95);
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - SOFT BUTTON (Primary/Secondary) - TRENDORA STYLE
           ───────────────────────────────────────────────────────────────────────── */
            .soft-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--neo-space-2);
                min-height: var(--neo-touch-min);
                padding: 0 var(--neo-space-6);
                border-radius: var(--neo-r-capsule);
                font-size: var(--neo-text-base);
                font-weight: var(--neo-weight-semibold);
                font-family: var(--neo-font);
                border: none;
                cursor: pointer;
                transition: transform 0.15s ease, box-shadow 0.2s ease, background-color 0.2s ease;
                user-select: none;
                -webkit-user-select: none;
            }

            .soft-btn:hover {
                transform: translateY(-1px);
            }

            .soft-btn:active {
                transform: scale(0.97);
            }

            /* Primary Button - Trendora Olive */
            .soft-btn-primary {
                background: var(--neo-accent);
                color: white;
                box-shadow: 0 4px 12px rgba(92, 107, 74, 0.25);
            }

            .soft-btn-primary:hover {
                background: #4A5548;
                box-shadow: 0 6px 16px rgba(92, 107, 74, 0.30);
            }

            .soft-btn-primary:active {
                box-shadow: 0 2px 6px rgba(92, 107, 74, 0.20);
            }

            /* Secondary Button - Trendora Minimal */
            .soft-btn-secondary {
                background: var(--neo-bg-elevated);
                color: var(--neo-text-primary);
                border: 1px solid var(--neo-stroke-strong);
                box-shadow: var(--neo-shadow-soft);
            }

            .soft-btn-secondary:hover {
                background: var(--neo-bg-secondary);
                box-shadow: var(--neo-shadow-lift);
            }

            .soft-btn-secondary:active {
                background: var(--neo-bg-secondary);
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - CHIP BADGE (Pro/Free/New) - TRENDORA STYLE
           ───────────────────────────────────────────────────────────────────────── */
            .chip-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 4px 10px;
                border-radius: 6px;
                font-size: var(--neo-text-xs);
                font-weight: var(--neo-weight-semibold);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                transition: transform 0.15s ease;
            }

            .chip-badge:hover {
                transform: scale(1.05);
            }

            /* Pro Badge - Trendora Olive/Gold */
            .chip-badge-pro {
                background: linear-gradient(135deg, #5C6B4A, #7A8B64);
                color: white;
                box-shadow: 0 2px 6px rgba(92, 107, 74, 0.25);
            }

            /* Free Badge - Soft Gray */
            .chip-badge-free {
                background: var(--neo-bg-tertiary);
                color: var(--neo-text-secondary);
            }

            /* New Badge - Soft Orange */
            .chip-badge-new {
                background: rgba(224, 123, 76, 0.15);
                color: var(--neo-accent-orange);
            }

            /* Danger Badge */
            .chip-badge-danger {
                background: var(--neo-danger-soft);
                color: var(--neo-danger);
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - ICON BUBBLE (Round Icon Container) - TRENDORA STYLE
           ───────────────────────────────────────────────────────────────────────── */
            .icon-bubble {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                border-radius: 12px;
                background: var(--neo-bg-secondary);
                border: 1px solid var(--neo-stroke);
                box-shadow: var(--neo-shadow-soft);
                font-size: 20px;
                flex-shrink: 0;
                transition: transform 0.15s ease, box-shadow 0.2s ease;
            }

            .icon-bubble:hover {
                transform: scale(1.05);
                box-shadow: var(--neo-shadow-lift);
            }

            .icon-bubble-sm {
                width: 36px;
                height: 36px;
                border-radius: 10px;
                font-size: 16px;
            }

            .icon-bubble-lg {
                width: 56px;
                height: 56px;
                border-radius: 18px;
                font-size: 26px;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           DESIGN IMPROVEMENT: RIPPLE EFFECT (Material-Style Touch Feedback)
           ───────────────────────────────────────────────────────────────────────── */
            .ripple-container {
                position: relative;
                overflow: hidden;
            }

            .ripple-container::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 70%);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                opacity: 0;
                transition: width 0.5s ease, height 0.5s ease, opacity 0.3s ease;
                pointer-events: none;
            }

            .ripple-container:active::after {
                width: 200%;
                height: 200%;
                opacity: 1;
                transition: width 0s, height 0s, opacity 0s;
            }

            html.dark .ripple-container::after {
                background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            }

            /* Auto-apply ripple to common interactive elements */
            .soft-btn,
            .soft-card,
            .capsule,
            .widget-card-apple,
            .nav-item {
                position: relative;
                overflow: hidden;
            }

            .soft-btn::after,
            .soft-card::after,
            .widget-card-apple::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 60%);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                opacity: 0;
                transition: width 0.6s ease-out, height 0.6s ease-out, opacity 0.4s ease;
                pointer-events: none;
                z-index: 1;
            }

            .soft-btn:active::after,
            .soft-card:active::after,
            .widget-card-apple:active::after {
                width: 300%;
                height: 300%;
                opacity: 1;
                transition: width 0s, height 0s, opacity 0s;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           DESIGN IMPROVEMENT: PREMIUM GLASS SCROLLBAR
           ───────────────────────────────────────────────────────────────────────── */
            /* Webkit browsers (Chrome, Safari, Edge) */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: rgba(148, 163, 184, 0.3);
                border-radius: 10px;
                transition: background 0.2s ease;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: rgba(148, 163, 184, 0.5);
            }

            html.dark ::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.15);
            }

            html.dark ::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.25);
            }

            /* Hide scrollbar on mobile for cleaner look */
            @media (max-width: 768px) {
                ::-webkit-scrollbar {
                    width: 0;
                    height: 0;
                }
            }

            /* Firefox */
            * {
                scrollbar-width: thin;
                scrollbar-color: rgba(148, 163, 184, 0.3) transparent;
            }

            html.dark * {
                scrollbar-color: rgba(255, 255, 255, 0.15) transparent;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           DESIGN IMPROVEMENT: ENHANCED FOCUS RING (Accessibility Glow)
           ───────────────────────────────────────────────────────────────────────── */
            /* Remove default outline */
            *:focus {
                outline: none;
            }

            /* Focus States - TRENDORA STYLE */
            button:focus-visible,
            a:focus-visible,
            input:focus-visible,
            select:focus-visible,
            textarea:focus-visible,
            [tabindex]:focus-visible {
                outline: none;
                box-shadow:
                    0 0 0 2px rgba(92, 107, 74, 0.3),
                    0 0 12px rgba(92, 107, 74, 0.1),
                    var(--neo-shadow-soft) !important;
                transition: box-shadow 0.15s ease !important;
            }

            html.dark button:focus-visible,
            html.dark a:focus-visible,
            html.dark input:focus-visible,
            html.dark select:focus-visible,
            html.dark textarea:focus-visible,
            html.dark [tabindex]:focus-visible {
                box-shadow:
                    0 0 0 2px rgba(141, 163, 115, 0.35),
                    0 0 15px rgba(141, 163, 115, 0.15),
                    var(--neo-shadow-soft) !important;
            }

            /* Reduced motion preference */
            @media (prefers-reduced-motion: reduce) {

                .ripple-container::after,
                .soft-btn::after,
                .soft-card::after,
                .widget-card-apple::after {
                    display: none;
                }
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - GLASS SHEET (Modal Background) - TRENDORA STYLE
           ───────────────────────────────────────────────────────────────────────── */
            .glass-sheet {
                background: var(--neo-bg-elevated);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-radius: var(--neo-r-sheet);
                border: 1px solid var(--neo-stroke);
                box-shadow: var(--neo-shadow-float);
            }

            .glass-sheet::before {
                content: '';
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                border-radius: 2px;
                background: var(--neo-stroke-strong);
                margin-top: 10px;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           UTILITY CLASSES - SEARCH CAPSULE - TRENDORA STYLE
           ───────────────────────────────────────────────────────────────────────── */
            .search-capsule {
                position: relative;
                display: flex;
                align-items: center;
                gap: var(--neo-space-3);
                height: var(--neo-touch-comfortable);
                padding: 0 var(--neo-space-5);
                border-radius: 12px;
                background: var(--neo-bg-secondary);
                border: 1px solid var(--neo-stroke);
                box-shadow: var(--neo-shadow-inset);
                transition: border-color 0.2s ease, box-shadow 0.2s ease;
            }

            .search-capsule:focus-within {
                border-color: var(--neo-accent);
                box-shadow: 0 0 0 2px rgba(92, 107, 74, 0.15);
            }

            .search-capsule input {
                flex: 1;
                background: transparent;
                border: none;
                outline: none;
                font-size: var(--neo-text-base);
                color: var(--neo-text-primary);
            }

            .search-capsule input::placeholder {
                color: var(--neo-text-tertiary);
            }

            .search-capsule .search-icon {
                width: 20px;
                height: 20px;
                color: var(--neo-text-tertiary);
            }

            /* ─────────────────────────────────────────────────────────────────────────
           PERFORMANCE MODE - REDUCED EFFECTS
           ───────────────────────────────────────────────────────────────────────── */
            html.perf .soft-card,
            html.perf .capsule,
            html.perf .capsule-item,
            html.perf .soft-btn,
            html.perf .icon-bubble,
            html.perf .glass-sheet,
            html.perf .search-capsule {
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            }

            html.perf .soft-card::before,
            html.perf .glass-sheet::before {
                display: none;
            }

            @media (prefers-reduced-motion: reduce) {

                .soft-card,
                .capsule,
                .capsule-item,
                .soft-btn {
                    transition: none !important;
                }
            }

            /* ─────────────────────────────────────────────────────────────────────────
           TYPOGRAPHY HELPERS
           ───────────────────────────────────────────────────────────────────────── */
            .neo-title {
                font-size: var(--neo-text-xl);
                font-weight: var(--neo-weight-semibold);
                color: var(--neo-text-primary);
                line-height: 1.3;
            }

            .neo-subtitle {
                font-size: var(--neo-text-base);
                font-weight: var(--neo-weight-medium);
                color: var(--neo-text-secondary);
                line-height: 1.4;
            }

            .neo-caption {
                font-size: var(--neo-text-sm);
                color: var(--neo-text-tertiary);
                line-height: 1.4;
            }

            .neo-value {
                font-size: var(--neo-text-2xl);
                font-weight: var(--neo-weight-bold);
                color: var(--neo-text-primary);
                letter-spacing: -0.5px;
            }

            .neo-value-lg {
                font-size: var(--neo-text-3xl);
                font-weight: var(--neo-weight-bold);
                color: var(--neo-text-primary);
                letter-spacing: -0.75px;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           HAIRLINE DIVIDER
           ───────────────────────────────────────────────────────────────────────── */
            .neo-divider {
                height: 1px;
                background: var(--neo-stroke);
                margin: var(--neo-space-4) 0;
            }

            .neo-divider-inset {
                margin-left: 56px;
            }

            /* ─────────────────────────────────────────────────────────────────────────
           COMPONENT OVERRIDES - Apply neo-tokens to existing components
           ───────────────────────────────────────────────────────────────────────── */

            /* Glass Card - Enhanced with neo-tokens */
            .glass-card {
                background: var(--glass-bg) !important;
                backdrop-filter: var(--glass-blur) var(--glass-saturate) !important;
                -webkit-backdrop-filter: var(--glass-blur) var(--glass-saturate) !important;
                border: 1px solid var(--glass-border) !important;
                box-shadow:
                    var(--neo-shadow-ambient),
                    var(--neo-shadow-inner-highlight),
                    var(--neo-shadow-inner-glow) !important;
            }

            /* Widget Card Apple - Enhanced */
            .widget-card-apple {
                background: var(--glass-bg) !important;
                backdrop-filter: var(--glass-blur) var(--glass-saturate) !important;
                -webkit-backdrop-filter: var(--glass-blur) var(--glass-saturate) !important;
                border-radius: var(--neo-r-card) !important;
                border: 1px solid var(--glass-border) !important;
                box-shadow:
                    var(--neo-shadow-lift),
                    var(--neo-shadow-inner-highlight) !important;
                transition: transform var(--neo-duration) var(--neo-ease),
                    box-shadow var(--neo-duration) var(--neo-ease) !important;
            }

            .widget-card-apple:active {
                transform: scale(0.98) !important;
                box-shadow: var(--neo-shadow-pressed), var(--neo-shadow-inner-highlight) !important;
            }

            /* PW Widget (Premium Widgets) - Enhanced with neo-tokens */
            .pw-widget {
                background: var(--glass-bg) !important;
                backdrop-filter: var(--glass-blur) var(--glass-saturate) !important;
                -webkit-backdrop-filter: var(--glass-blur) var(--glass-saturate) !important;
                border: 1px solid var(--glass-border) !important;
                box-shadow:
                    var(--neo-shadow-ambient),
                    var(--neo-shadow-inner-highlight),
                    var(--neo-shadow-inner-glow) !important;
            }

            /* Transaction List Items - Capsule Style */
            .transaction-card,
            .transaction-item {
                background: var(--glass-bg) !important;
                backdrop-filter: blur(12px) !important;
                -webkit-backdrop-filter: blur(12px) !important;
                border-radius: var(--neo-r-base) !important;
                border: 1px solid var(--neo-stroke) !important;
                box-shadow: var(--neo-shadow-soft), var(--neo-shadow-inner-highlight) !important;
                transition: all var(--neo-duration-fast) var(--neo-ease) !important;
            }

            .transaction-card:active,
            .transaction-item:active {
                transform: scale(0.985) !important;
                background: var(--glass-bg-elevated) !important;
            }

            /* Header Badge - Chip Style */
            #user-plan-badge {
                padding: 4px 10px !important;
                border-radius: var(--neo-r-capsule) !important;
                font-size: var(--neo-text-xs) !important;
                font-weight: var(--neo-weight-bold) !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
            }

            /* Month Selector Pills - Capsule Style */
            .month-pill,
            [class*="month-"] button {
                min-height: 36px !important;
                padding: 0 16px !important;
                border-radius: var(--neo-r-capsule) !important;
                background: var(--glass-bg) !important;
                border: 1px solid var(--neo-stroke) !important;
                font-weight: var(--neo-weight-medium) !important;
                transition: all var(--neo-duration-fast) var(--neo-ease) !important;
            }

            /* Modal/Sheet Components - Glass Sheet */
            .modal-content,
            [class*="modal"]>div[class*="bg-white"],
            [class*="modal"]>div[class*="bg-gray"] {
                background: var(--glass-bg-elevated) !important;
                backdrop-filter: blur(40px) var(--glass-saturate) !important;
                -webkit-backdrop-filter: blur(40px) var(--glass-saturate) !important;
                border-radius: var(--neo-r-sheet) !important;
                border: 1px solid var(--glass-border) !important;
                box-shadow: var(--neo-shadow-float) !important;
            }

            /* Bottom Navigation - Floating Glass */
            #app-nav,
            .bottom-nav {
                background: var(--glass-bg-elevated) !important;
                backdrop-filter: blur(24px) var(--glass-saturate) !important;
                -webkit-backdrop-filter: blur(24px) var(--glass-saturate) !important;
                border-radius: var(--neo-r-card) !important;
                border: 1px solid var(--glass-border) !important;
                box-shadow: var(--neo-shadow-float) !important;
            }

            /* CTA Buttons - Apple Style */
            .btn-primary,
            button[class*="bg-indigo"],
            button[class*="bg-purple"] {
                background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%) !important;
                border-radius: var(--neo-r-capsule) !important;
                box-shadow:
                    0 4px 16px rgba(0, 122, 255, 0.30),
                    0 1px 3px rgba(0, 0, 0, 0.08),
                    var(--neo-shadow-inner-highlight) !important;
                min-height: var(--neo-touch-min) !important;
                font-weight: var(--neo-weight-semibold) !important;
                transition: all var(--neo-duration-fast) var(--neo-ease) !important;
            }

            .btn-primary:active,
            button[class*="bg-indigo"]:active,
            button[class*="bg-purple"]:active {
                transform: scale(0.97) !important;
                box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25) !important;
            }

            /* Card Headers - Typography */
            .section-title,
            .section-title-premium {
                font-size: var(--neo-text-xl) !important;
                font-weight: var(--neo-weight-semibold) !important;
                color: var(--neo-text-primary) !important;
                letter-spacing: -0.3px !important;
            }

            /* Value Display - Typography */
            #display-balance,
            #display-savings-total,
            #display-income,
            #display-expense {
                font-size: var(--neo-text-2xl) !important;
                font-weight: var(--neo-weight-bold) !important;
                color: var(--neo-text-primary) !important;
                letter-spacing: -0.5px !important;
            }

            /* Label Text - Typography */
            .pw-title,
            [class*="tracking-widest"][class*="uppercase"] {
                font-size: var(--neo-text-xs) !important;
                font-weight: var(--neo-weight-bold) !important;
                letter-spacing: 1px !important;
            }

            /* ═══════════════════════════════════════════════════════════════════════════
           PREMIUM LIGHT MODE ENHANCEMENTS - Apple Aesthetic
           ═══════════════════════════════════════════════════════════════════════════ */

            /* Light Mode Card Enhancement */
            :root .widget-card-apple,
            :root .pw-widget,
            :root .transaction-card,
            :root .transaction-item {
                background: rgba(255, 255, 255, 0.82) !important;
                border: 1px solid rgba(255, 255, 255, 0.9) !important;
                box-shadow:
                    0 2px 8px rgba(0, 0, 0, 0.03),
                    0 8px 24px rgba(0, 0, 0, 0.05),
                    inset 0 1px 1px rgba(255, 255, 255, 0.95) !important;
            }

            /* Dark Mode Card Enhancement - Fix for Gelir/Gider widgets */
            html.dark .widget-card-apple,
            html.dark .pw-widget,
            html.dark .transaction-card,
            html.dark .transaction-item {
                background: rgba(30, 30, 40, 0.75) !important;
                border: 1px solid rgba(255, 255, 255, 0.08) !important;
                box-shadow:
                    0 4px 16px rgba(0, 0, 0, 0.25),
                    0 12px 40px rgba(0, 0, 0, 0.20),
                    inset 0 1px 0 rgba(255, 255, 255, 0.06) !important;
            }

            /* Light Mode Input Enhancement */
            :root .modern-input,
            :root input[type="text"],
            :root input[type="number"],
            :root input[type="email"],
            :root select {
                background: rgba(255, 255, 255, 0.85) !important;
                border: 1px solid rgba(220, 225, 235, 0.8) !important;
                box-shadow:
                    0 1px 3px rgba(0, 0, 0, 0.02),
                    inset 0 1px 2px rgba(255, 255, 255, 0.9) !important;
                color: #1A1A1A !important;
            }

            :root .modern-input:focus,
            :root input:focus,
            :root select:focus {
                border-color: #007AFF !important;
                box-shadow:
                    0 0 0 3px rgba(0, 122, 255, 0.15),
                    0 1px 3px rgba(0, 0, 0, 0.02) !important;
            }

            /* Light Mode Modal Enhancement */
            :root .modal-content,
            :root [class*="modal"]>div[class*="bg-white"],
            :root .bottom-sheet,
            :root .sheet-content {
                background: rgba(255, 255, 255, 0.92) !important;
                border: 1px solid rgba(255, 255, 255, 0.95) !important;
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.08),
                    0 24px 64px rgba(0, 0, 0, 0.06) !important;
            }

            /* Light Mode Header & Nav Enhancement */
            :root #main-header,
            :root #main-nav {
                background: rgba(255, 255, 255, 0.78) !important;
                border: 1px solid rgba(255, 255, 255, 0.88) !important;
                box-shadow:
                    0 2px 12px rgba(0, 0, 0, 0.03),
                    0 8px 24px rgba(0, 0, 0, 0.04) !important;
            }

            /* Light Mode Chip/Pill Enhancement */
            :root .month-pill,
            :root [class*="chip"],
            :root .subchip {
                background: rgba(255, 255, 255, 0.9) !important;
                border: 1px solid rgba(220, 225, 235, 0.7) !important;
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03) !important;
            }

            /* Dark Mode Override for Subchips */
            html.dark .subchip {
                background: rgba(30, 41, 59, 0.8) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                color: rgba(255, 255, 255, 0.9) !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3) !important;
            }

            /* Light Mode Active States */
            :root .month-pill.active,
            :root [class*="chip"].active,
            :root .subchip.active {
                background: linear-gradient(135deg, #007AFF, #5856D6) !important;
                border-color: transparent !important;
                color: #ffffff !important;
                box-shadow: 0 2px 8px rgba(0, 122, 255, 0.30) !important;
            }

            /* Light Mode Text Refinements */
            :root .section-title,
            :root .section-title-premium {
                color: #1A1A1A !important;
            }

            :root .pw-title,
            :root [class*="text-gray-500"],
            :root [class*="text-slate-500"] {
                color: #6B6B70 !important;
            }

            /* Performance Mode Overrides */
            html.perf .glass-card,
            html.perf .widget-card-apple,
            html.perf .pw-widget,
            html.perf .transaction-card,
            html.perf .modal-content {
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            }

            /* Money Formatting Styles */
            .currency {
                margin-left: 4px;
                opacity: 0.8;
                font-weight: 600;
                font-size: 0.9em;
                display: inline-block;
            }

            .amount {
                font-variant-numeric: tabular-nums;
                letter-spacing: -0.02em;
            }

            @media (max-width: 480px) {
                .amount {
                    font-size: 100%;
                }
            }

            /* === Money inline (amount + currency) === */
            .money-inline {
                display: inline-flex;
                align-items: baseline;
                gap: 8px;
                white-space: nowrap;
                /* satır kırılmasını engelle */
                overflow: visible !important;
                /* olası kesilmeyi engelle */
                text-overflow: clip !important;
                max-width: 100%;
                font-variant-numeric: tabular-nums;
                letter-spacing: -0.02em;
            }

            .money-inline .money-amount {
                font-weight: 800;
                line-height: 1;
            }

            .money-inline .money-currency {
                font-weight: 800;
                line-height: 1;
                opacity: .95;
                transform: translateY(1px);
                font-size: .92em;
                /* ₺ biraz daha küçük, premium görünür */
            }

            /* Gelir/Gider kartı için responsive font (mobilde sığdırır) */
            .money-inline--lg {
                font-size: clamp(22px, 6.3vw, 34px);
            }

            /* 360px altı ekstra sıkışma fix */
            @media (max-width:360px) {
                .money-inline--lg {
                    font-size: clamp(20px, 6.2vw, 30px);
                }
            }

            /* ═══════════════════════════════════════════════════════════════════════════
           SWIPE-TO-ACTION STYLES - Premium Mobile Gestures
           ═══════════════════════════════════════════════════════════════════════════ */

            /* Swipe Container - Wrapper for swipe functionality */
            .swipe-container {
                position: relative;
                overflow: hidden;
                border-radius: var(--neo-r-base, 16px);
                margin-bottom: 8px;
                touch-action: pan-y;
            }

            /* Swipe Actions Background Layer */
            .swipe-actions {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                justify-content: space-between;
                align-items: stretch;
                pointer-events: none;
                border-radius: inherit;
                overflow: hidden;
            }

            /* Delete Action (Left side - revealed when swiping left) */
            .swipe-action-delete {
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 80px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%);
                opacity: 0;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease;
                border-radius: 0 var(--neo-r-base, 16px) var(--neo-r-base, 16px) 0;
            }

            .swipe-action-delete.visible {
                opacity: 1;
                transform: translateX(0);
                pointer-events: auto;
            }

            .swipe-action-delete-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                background: transparent;
                border: none;
                cursor: pointer;
                color: #ffffff;
                font-size: 24px;
                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .swipe-action-delete-btn:active {
                transform: scale(0.9);
            }

            .swipe-action-delete-btn svg {
                width: 28px;
                height: 28px;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            }

            /* Edit Action (Right side - revealed when swiping right) */
            .swipe-action-edit {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 80px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
                opacity: 0;
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease;
                border-radius: var(--neo-r-base, 16px) 0 0 var(--neo-r-base, 16px);
            }

            .swipe-action-edit.visible {
                opacity: 1;
                transform: translateX(0);
                pointer-events: auto;
            }

            .swipe-action-edit-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                background: transparent;
                border: none;
                cursor: pointer;
                color: #ffffff;
                font-size: 24px;
                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .swipe-action-edit-btn:active {
                transform: scale(0.9);
            }

            .swipe-action-edit-btn svg {
                width: 28px;
                height: 28px;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            }

            /* Swipeable Content - The transaction card itself */
            .swipe-content {
                position: relative;
                z-index: 2;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                will-change: transform;
                background: var(--glass-bg);
                border-radius: inherit;
            }

            .swipe-content.swiping {
                transition: none;
            }

            .swipe-content.swiped-left {
                transform: translateX(-80px);
            }

            .swipe-content.swiped-right {
                transform: translateX(80px);
            }

            /* Dark Mode Adjustments */
            html.dark .swipe-action-delete {
                background: linear-gradient(135deg, #FF453A 0%, #FF6961 100%);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 4px 12px rgba(255, 69, 58, 0.3);
            }

            html.dark .swipe-action-edit {
                background: linear-gradient(135deg, #0A84FF 0%, #64D2FF 100%);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 4px 12px rgba(10, 132, 255, 0.3);
            }

            /* Light Mode Enhancement */
            :root .swipe-action-delete {
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 4px 12px rgba(255, 59, 48, 0.25);
            }

            :root .swipe-action-edit {
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 4px 12px rgba(0, 122, 255, 0.25);
            }

            /* Haptic-like visual feedback */
            .swipe-container.haptic .swipe-content {
                animation: swipeHaptic 0.15s ease-out;
            }

            @keyframes swipeHaptic {

                0%,
                100% {
                    transform: translateX(var(--swipe-x, 0));
                }

                50% {
                    transform: translateX(calc(var(--swipe-x, 0) + 5px));
                }
            }

            /* Action Icon Labels */
            .swipe-action-label {
                position: absolute;
                bottom: 8px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 9px;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.9);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                white-space: nowrap;
            }

            /* Hide inline action buttons when swipe is available (mobile only) */
            @media (max-width: 768px) {
                .swipe-container .transaction-inline-actions {
                    display: none !important;
                }
            }

            /* Show inline buttons on desktop */
            @media (min-width: 769px) {
                .swipe-container .swipe-actions {
                    display: none;
                }

                .swipe-content {
                    transform: none !important;
                }
            }

            /* Bounce animation when returning to center */
            .swipe-content.bouncing {
                animation: swipeBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            @keyframes swipeBounce {
                0% {
                    transform: translateX(var(--bounce-from, 0));
                }

                60% {
                    transform: translateX(calc(var(--bounce-from, 0) * -0.1));
                }

                100% {
                    transform: translateX(0);
                }
            }

            /* Threshold indicator glow */
            .swipe-action-delete.threshold-reached {
                background: linear-gradient(135deg, #FF2D20 0%, #FF5252 100%);
                box-shadow: 0 0 20px rgba(255, 45, 32, 0.5);
            }

            .swipe-action-edit.threshold-reached {
                background: linear-gradient(135deg, #0066FF 0%, #00A3FF 100%);
                box-shadow: 0 0 20px rgba(0, 102, 255, 0.5);
            }

            html.dark .swipe-action-delete.threshold-reached {
                box-shadow: 0 0 25px rgba(255, 69, 58, 0.6);
            }

            html.dark .swipe-action-edit.threshold-reached {
                box-shadow: 0 0 25px rgba(10, 132, 255, 0.6);
            }

            /* === Crown Badge Pulse Animation === */
            @keyframes crownPulse {

                0%,
                100% {
                    transform: scale(1);
                    filter: brightness(1);
                }

                50% {
                    transform: scale(1.08);
                    filter: brightness(1.2);
                }
            }

            /* DISABLE PULL-TO-REFRESH */
            html,
            body {
                overscroll-behavior-y: none;
                overscroll-behavior: none;
            }

            /* =========================================================
           SAFE MODE (SMART BLUR) - Strong Blur + Tap to Resume
           ========================================================= */

            /* Güvenli mod aktifken ana içeriği flulaştır */
            html.safe-mode-active #app-container {
                filter: blur(18px) saturate(0.85) brightness(0.85);
                transform: scale(1.01);
                transition: filter 220ms ease, transform 220ms ease;
                will-change: filter, transform;
            }

            /* Perf / reduced motion modlarında daha hafif (takılma olmasın) */
            html.perf.safe-mode-active #app-container {
                filter: blur(12px) saturate(0.9) brightness(0.9);
                transform: none;
            }

            @media (prefers-reduced-motion: reduce) {
                html.safe-mode-active #app-container {
                    filter: blur(12px) saturate(0.9) brightness(0.9);
                    transform: none;
                }
            }

            /* Overlay'in blur katmanını güçlendir (backdrop-filter) */
            #blur-overlay .safe-blur-layer {
                backdrop-filter: blur(38px) saturate(180%);
                -webkit-backdrop-filter: blur(38px) saturate(180%);
                /* Dark mode: biraz daha karanlık cam */
                background: rgba(0, 0, 0, 0.45);
            }

            /* Light mode: daha açık cam */
            html:not(.dark) #blur-overlay .safe-blur-layer {
                background: rgba(255, 255, 255, 0.55);
            }

            /* Overlay görünüm animasyonu */
            #blur-overlay {
                -webkit-tap-highlight-color: transparent;
            }

            /* ============================================== */
            /* ULTRA PREMIUM GLASSMORPHISM THEME             */
            /* Enhanced Readability & 3D Effects             */
            /* ============================================== */

            /* === SMOOTH THEME TRANSITION === */
            *,
            *::before,
            *::after {
                transition:
                    background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                    border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                    box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                    color 0.3s ease;
            }

            /* Exclude elements that need instant transitions */
            .no-transition,
            .nav-liquid-blob,
            .ripple,
            [class*="animate-"] {
                transition: none !important;
            }

            /* Temporary class to disable transitions during page load */
            .theme-transitioning * {
                transition-duration: 0s !important;
            }

            /* === AYDINILIK MOD (Varsayılan) - Premium Apple Aesthetic === */
            :root {
                /* Arka Plan - Warm Premium Gradient */
                --bg-gradient-start: #FAFBFC;
                --bg-gradient-mid: #F5F7FA;
                --bg-gradient-end: #EEF2F7;
                --bg-orb-1: rgba(99, 102, 241, 0.08);
                --bg-orb-2: rgba(139, 92, 246, 0.06);
                --bg-orb-3: rgba(6, 182, 212, 0.05);

                /* Cam Yüzeyler - Premium Apple Glass */
                --glass-bg: rgba(255, 255, 255, 0.78);
                --glass-bg-strong: rgba(255, 255, 255, 0.88);
                --glass-bg-subtle: rgba(255, 255, 255, 0.55);
                --glass-border: rgba(255, 255, 255, 0.85);
                --glass-border-strong: rgba(220, 225, 235, 0.6);
                --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.04), 0 1px 4px rgba(0, 0, 0, 0.02);
                --glass-shadow-elevated: 0 12px 48px rgba(0, 0, 0, 0.08), 0 4px 16px rgba(0, 0, 0, 0.04);
                --glass-blur: blur(24px);

                /* Yazı Renkleri - High Contrast Apple Style */
                --text-primary: #1A1A1A;
                --text-secondary: #3C3C43;
                --text-muted: #6B6B70;
                --text-light: #8E8E93;
                --text-on-accent: #ffffff;

                /* Accent Renkler - Apple Vibrant */
                --accent-primary: #007AFF;
                --accent-secondary: #5856D6;
                --accent-tertiary: #5E5CE6;
                --accent-success: #30D158;
                --accent-warning: #FF9F0A;
                --accent-danger: #FF3B30;
                --accent-glow: rgba(0, 122, 255, 0.25);
                --accent-glow-strong: rgba(0, 122, 255, 0.45);

                /* 3D Efektler - Soft & Refined */
                --shadow-3d-light: 0 2px 4px rgba(0, 0, 0, 0.02), 0 8px 16px rgba(0, 0, 0, 0.04);
                --shadow-3d-medium: 0 4px 12px rgba(0, 0, 0, 0.04), 0 16px 32px rgba(0, 0, 0, 0.06);
                --shadow-3d-heavy: 0 8px 24px rgba(0, 0, 0, 0.06), 0 24px 48px rgba(0, 0, 0, 0.08);
                --shadow-inset: inset 0 1px 2px rgba(255, 255, 255, 0.9), inset 0 -1px 2px rgba(0, 0, 0, 0.03);

                /* Genel */
                --card-radius: 28px;
                --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                --transition-bounce: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            /* === KARANLIK MOD - Ultra Premium === */
            html.dark {
                /* Arka Plan - Derin Gradientler */
                --bg-gradient-start: #0a0a12;
                --bg-gradient-mid: #0f0f1a;
                --bg-gradient-end: #141428;
                --bg-orb-1: rgba(99, 102, 241, 0.2);
                --bg-orb-2: rgba(139, 92, 246, 0.18);
                --bg-orb-3: rgba(6, 182, 212, 0.12);

                /* === FX: 3D Exchange Icon theme variables (Light/Dark) === */
                /* Light mode: daha “premium ama temiz”, aşırı neon değil */
                --fx-stop1: rgba(80, 120, 255, 0.95);
                --fx-stop2: rgba(130, 90, 255, 0.95);
                --fx-stop3: rgba(40, 200, 210, 0.95);

                --fx-gloss1: rgba(255, 255, 255, 0.55);
                --fx-gloss2: rgba(255, 255, 255, 0.00);

                --fx-shadow: rgba(0, 0, 0, 0.22);
                --fx-innerAlpha: 0.35;

                --fx-coinGlass: rgba(255, 255, 255, 0.12);
                --fx-coinMark: rgba(255, 255, 255, 0.92);

                /* Cam Yüzeyler - Derin & Zengin */
                --glass-bg: rgba(255, 255, 255, 0.06);
                --glass-bg-strong: rgba(255, 255, 255, 0.1);
                --glass-bg-subtle: rgba(255, 255, 255, 0.03);
                --glass-border: rgba(255, 255, 255, 0.1);
                --glass-border-strong: rgba(255, 255, 255, 0.18);
                --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3);
                --glass-shadow-elevated: 0 20px 60px rgba(0, 0, 0, 0.6), 0 8px 24px rgba(0, 0, 0, 0.4);

                /* Yazı Renkleri - Net Okunabilirlik */
                --text-primary: #f8fafc;
                --text-secondary: #e2e8f0;
                --text-muted: #94a3b8;
                --text-light: #64748b;

                /* Accent Renkler - Neon Glow */
                --accent-primary: #818cf8;
                --accent-secondary: #a78bfa;
                --accent-tertiary: #22d3ee;
                --accent-success: #34d399;
                --accent-warning: #fbbf24;
                --accent-danger: #f87171;
                --accent-glow: rgba(129, 140, 248, 0.35);
                --accent-glow-strong: rgba(129, 140, 248, 0.55);

                /* 3D Efektler - Daha Derin */
                --shadow-3d-light: 0 4px 8px rgba(0, 0, 0, 0.3), 0 10px 20px rgba(0, 0, 0, 0.2);
                --shadow-3d-medium: 0 10px 30px rgba(0, 0, 0, 0.4), 0 20px 50px rgba(0, 0, 0, 0.3);
                --shadow-3d-heavy: 0 20px 60px rgba(0, 0, 0, 0.5), 0 30px 80px rgba(0, 0, 0, 0.4);
                --shadow-inset: inset 0 2px 4px rgba(255, 255, 255, 0.1), inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            }

            /* === MOBİL KARANLIK MOD FİX (ÖNEMLİ) === */
            /* Tailwind ve Glass sınıflarını karanlık modda zorla override et */
            html.dark body {
                background: linear-gradient(135deg, #020617 0%, #0f172a 100%) !important;
                color: #f8fafc !important;

                /* Dark mode: glow biraz daha belirgin */
                --fx-stop1: rgba(160, 200, 255, 0.98);
                --fx-stop2: rgba(170, 120, 255, 0.98);
                --fx-stop3: rgba(80, 235, 240, 0.98);

                --fx-gloss1: rgba(255, 255, 255, 0.60);
                --fx-gloss2: rgba(255, 255, 255, 0.00);

                --fx-shadow: rgba(0, 0, 0, 0.35);
                --fx-innerAlpha: 0.48;

                --fx-coinGlass: rgba(255, 255, 255, 0.10);
                --fx-coinMark: rgba(255, 255, 255, 0.95);
            }

            /* Glass Card Fix - Beyazlığı engelle */
            /* NOT: #main-nav hariç tutuldu - navigasyon barı şeffaf kalmalı */
            html.dark .glass-card:not(#main-nav),
            html.dark .glass-card-strong:not(#main-nav),
            html.dark .glass-card-light:not(#main-nav) {
                background-color: rgba(15, 23, 42, 0.75) !important;
                /* Koyu Slate tonu */
                background-image: none !important;
                /* Varsa gradienti kaldır */
                border-color: rgba(255, 255, 255, 0.08) !important;
                box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5) !important;
            }

            /* Tailwind bg-white sınıflarını karanlık modda transparan/koyu yap */
            html.dark .bg-white {
                background-color: rgba(30, 41, 59, 0.6) !important;
                border-color: rgba(255, 255, 255, 0.05) !important;
            }

            html.dark .bg-gray-50,
            html.dark .bg-slate-50,
            html.dark .bg-zinc-50 {
                background-color: rgba(15, 23, 42, 0.5) !important;
            }

            /* Metin renklerini düzelt (Koyu metinleri açık yap) */
            html.dark .text-gray-900,
            html.dark .text-slate-900,
            html.dark .text-zinc-900,
            html.dark .text-black {
                color: #f1f5f9 !important;
            }

            html.dark .text-gray-800,
            html.dark .text-slate-800,
            html.dark .text-gray-700 {
                color: #cbd5e1 !important;
            }

            html.dark .text-gray-600,
            html.dark .text-slate-600 {
                color: #94a3b8 !important;
            }

            /* Input alanlarını düzelt */
            html.dark input,
            html.dark select,
            html.dark textarea {
                background-color: rgba(15, 23, 42, 0.8) !important;
                color: white !important;
                border-color: rgba(255, 255, 255, 0.1) !important;
            }

            /* FIX: bg-transparent select'lerde (özellikle prefix currency select) koyu kutu oluşmasın */
            html.dark select.bg-transparent,
            html:not(.dark) select.bg-transparent {
                background-color: transparent !important;
                background: transparent !important;
            }

            /* Extra güvenlik: sadece bu alan (TRY) için nokta atışı */
            #input-currency {
                background-color: transparent !important;
                background: transparent !important;
            }

            /* === MOBİL AYDINLIK MOD FİX (ÖNEMLİ) === */
            /* Aydınlık modu da benzer şekilde garantiye alıyoruz */
            html:not(.dark),
            html:not(.dark) body {
                background-color: #f0f4f8 !important;
                background: linear-gradient(135deg, #f0f4f8 0%, #dce4ef 100%) !important;
                color: #0f172a !important;
                min-height: 100vh;
            }

            /* Glass Card Fix - Aydınlık */
            /* NOT: #main-nav hariç tutuldu - navigasyon barı şeffaf kalmalı */
            html:not(.dark) .glass-card:not(#main-nav),
            html:not(.dark) .glass-card-strong:not(#main-nav),
            html:not(.dark) .glass-card-light:not(#main-nav) {
                background-color: rgba(255, 255, 255, 0.75) !important;
                border-color: rgba(255, 255, 255, 0.6) !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08) !important;
                color: #0f172a !important;
            }

            /* Metin renklerini düzelt (Aydınlık) */
            html:not(.dark) .text-white {
                color: #ffffff !important;
                /* text-white her zaman beyaz kalsın */
            }

            html:not(.dark) .text-gray-900,
            html:not(.dark) .text-slate-900,
            html:not(.dark) .text-zinc-900,
            html:not(.dark) .text-primary {
                color: #0f172a !important;
            }

            html:not(.dark) .text-gray-600,
            html:not(.dark) .text-slate-600,
            html:not(.dark) .text-secondary {
                color: #475569 !important;
            }

            /* Input alanlarını düzelt (Aydınlık) */
            html:not(.dark) input,
            html:not(.dark) select,
            html:not(.dark) textarea {
                background-color: rgba(255, 255, 255, 0.8) !important;
                color: #0f172a !important;
                border-color: rgba(0, 0, 0, 0.1) !important;
            }

            /* === GÖRSEL RENDER HATALARI İÇİN GLOBAL FİX (Mobil Kare Arkaplan Sorunu) === */
            /* Mobilde ve WebKit'te border-radius + overflow-hidden + backdrop-filter kombinasyonunu düzeltir */
            .glass-card,
            .card-3d,
            .premium-3d-card {
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                background-clip: padding-box;
                -webkit-background-clip: padding-box;
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
            }

            /* Pseudo-elementlerin taşmasını kesin engelle */
            .glass-card::before,
            .glass-card::after {
                border-radius: inherit;
                z-index: -1;
            }

            /* Mobilde 3D transformları basitleştir (Kare artefaktların ana sebebi) */
            @media (max-width: 768px) {

                .card-3d,
                .premium-3d-card,
                .glass-card {
                    transform-style: flat !important;
                    perspective: none !important;
                }

                /* Mobilde kartın arkasındaki kare gölgeyi temizle - Daha hafif gölge */
                .glass-card {
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05) !important;
                }

                html.dark .glass-card {
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4) !important;
                }

                /* === MOBİL BLUR GLOW FİX (Kare artefakt çözümü) === */
                /* Blur efektli glow arka planları mobilde tamamen gizle */
                .glass-card>div[class*="blur-"],
                .glass-card>div[class*="blur-3xl"],
                .glass-card>.absolute[class*="blur"],
                [class*="blur-[60px]"],
                [class*="blur-[50px]"] {
                    display: none !important;
                }

                /* Kartlara clip-path ekle - blur taşmasını kesin önle */
                .glass-card {
                    clip-path: inset(0 round 28px);
                    -webkit-clip-path: inset(0 round 28px);
                    overflow: hidden !important;
                }

                /* Grid container izolasyonu */
                #screen-dashboard .grid {
                    overflow: hidden;
                    isolation: isolate;
                }

                /* ═══════════════════════════════════════════════════════════════════════════
               YENİ İŞLEM FORMU - PREMİUM SOLID CARD DESIGN
               Clean Shadows, No Glassmorphism, Light/Dark Mode Uyumlu
               ═══════════════════════════════════════════════════════════════════════════ */

                /* ────────────────────────────────────────────────────────────────────────────
               1. ANA CONTAINER ARKAPLAN
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add {
                    background: linear-gradient(175deg, #f8fafc 0%, #f1f5f9 40%, #e2e8f0 100%);
                    position: relative;
                }

                html.dark #screen-add {
                    background: linear-gradient(175deg, #0f172a 0%, #1e1b4b 50%, #0f0d24 100%);
                }

                /* Subtle grain texture overlay */
                #screen-add::before {
                    content: '';
                    position: absolute;
                    inset: 0;
                    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
                    opacity: 0.02;
                    pointer-events: none;
                    z-index: 0;
                }

                html.dark #screen-add::before {
                    opacity: 0.03;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               2. SAYFA BAŞLIĞI
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add>div:first-child {
                    position: relative;
                    z-index: 1;
                }

                #screen-add>div:first-child h3 {
                    color: #1e293b !important;
                    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
                }

                html.dark #screen-add>div:first-child h3 {
                    color: #f1f5f9 !important;
                    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                }

                #screen-add>div:first-child p {
                    color: #64748b !important;
                }

                html.dark #screen-add>div:first-child p {
                    color: #94a3b8 !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               3. PRO BUTONLARI (Fiş Tara / Sesle Ekle)
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add .animate-fade-in {
                    position: relative;
                    z-index: 1;
                }

                #screen-add .animate-fade-in button {
                    background: #ffffff !important;
                    border: 1.5px solid #e2e8f0 !important;
                    box-shadow:
                        0 4px 12px rgba(0, 0, 0, 0.04),
                        0 1px 3px rgba(0, 0, 0, 0.06) !important;
                    transition: all 0.25s ease !important;
                }

                #screen-add .animate-fade-in button:hover {
                    transform: translateY(-2px) !important;
                    box-shadow:
                        0 8px 20px rgba(99, 102, 241, 0.12),
                        0 2px 6px rgba(0, 0, 0, 0.06) !important;
                }

                #screen-add .animate-fade-in button:active {
                    transform: translateY(0) scale(0.98) !important;
                }

                html.dark #screen-add .animate-fade-in button {
                    background: #1e1e35 !important;
                    border: 1.5px solid #3d3d6b !important;
                    box-shadow:
                        0 4px 16px rgba(0, 0, 0, 0.3),
                        0 1px 4px rgba(0, 0, 0, 0.2) !important;
                }

                html.dark #screen-add .animate-fade-in button:hover {
                    border-color: #6366f1 !important;
                    box-shadow:
                        0 8px 24px rgba(99, 102, 241, 0.2),
                        0 2px 8px rgba(0, 0, 0, 0.3) !important;
                }

                /* PRO Badge */
                #screen-add .animate-fade-in button>div:first-child>div {
                    box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3) !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               4. ANA FORM KARTI (Glass Card Override)
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add .glass-card {
                    background: #ffffff !important;
                    backdrop-filter: none !important;
                    -webkit-backdrop-filter: none !important;
                    border: none !important;
                    border-radius: 32px !important;
                    box-shadow:
                        0 0 0 1px rgba(0, 0, 0, 0.03),
                        0 2px 4px rgba(0, 0, 0, 0.02),
                        0 8px 16px rgba(0, 0, 0, 0.04),
                        0 16px 32px rgba(0, 0, 0, 0.04),
                        0 32px 64px rgba(0, 0, 0, 0.02) !important;
                    position: relative;
                    z-index: 1;
                    overflow: visible !important;
                }

                html.dark #screen-add .glass-card {
                    background: #1e1e35 !important;
                    box-shadow:
                        0 0 0 1px rgba(255, 255, 255, 0.05),
                        0 4px 8px rgba(0, 0, 0, 0.2),
                        0 12px 24px rgba(0, 0, 0, 0.25),
                        0 24px 48px rgba(0, 0, 0, 0.2),
                        0 0 60px rgba(99, 102, 241, 0.05) !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               5. GİDER / GELİR TOGGLE BUTONLARI
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add #btn-type-expense,
                #screen-add #btn-type-income {
                    border-radius: 20px !important;
                    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
                    position: relative !important;
                    z-index: 10 !important;
                    cursor: pointer !important;
                    pointer-events: auto !important;
                    overflow: hidden !important;
                }

                /* Gider Butonu - Sadece Aktifse (bg-gray-100 değilse) */
                #screen-add #btn-type-expense:not(.bg-gray-100\/50) {
                    background: linear-gradient(145deg, #fef2f2, #fee2e2) !important;
                    border: 2px solid #fca5a5 !important;
                    box-shadow:
                        0 4px 12px rgba(239, 68, 68, 0.15),
                        0 2px 4px rgba(239, 68, 68, 0.1),
                        inset 0 -2px 4px rgba(239, 68, 68, 0.05) !important;
                    color: #dc2626 !important;
                }

                #screen-add #btn-type-expense:not(.bg-gray-100\/50) span:first-child {
                    filter: none !important;
                    opacity: 1 !important;
                }

                html.dark #screen-add #btn-type-expense:not(.bg-gray-100\/50) {
                    background: linear-gradient(145deg, rgba(127, 29, 29, 0.3), rgba(153, 27, 27, 0.2)) !important;
                    border: 2px solid rgba(239, 68, 68, 0.4) !important;
                    box-shadow:
                        0 4px 16px rgba(239, 68, 68, 0.2),
                        0 2px 6px rgba(0, 0, 0, 0.3) !important;
                    color: #f87171 !important;
                }

                /* Gelir Butonu - Sadece Aktifse */
                /* Not: Gelir butonu aktif olduğunda bg-gray-100/50 sınıfı kaldırılır */
                #screen-add #btn-type-income:not(.bg-gray-100\/50) {
                    background: linear-gradient(145deg, #ecfdf5, #d1fae5) !important;
                    border: 2px solid #6ee7b7 !important;
                    box-shadow:
                        0 4px 12px rgba(16, 185, 129, 0.15),
                        0 2px 4px rgba(16, 185, 129, 0.1),
                        inset 0 -2px 4px rgba(16, 185, 129, 0.05) !important;
                    color: #059669 !important;
                }

                #screen-add #btn-type-income:not(.bg-gray-100\/50) span:first-child {
                    filter: none !important;
                    opacity: 1 !important;
                }

                html.dark #screen-add #btn-type-income:not(.bg-gray-100\/50) {
                    background: linear-gradient(145deg, rgba(6, 78, 59, 0.3), rgba(6, 95, 70, 0.2)) !important;
                    border: 2px solid rgba(16, 185, 129, 0.4) !important;
                    box-shadow:
                        0 4px 16px rgba(16, 185, 129, 0.2),
                        0 2px 6px rgba(0, 0, 0, 0.3) !important;
                    color: #34d399 !important;
                }

                /* Pasif Durum (Ortak) */
                #screen-add #btn-type-expense.bg-gray-100\/50,
                #screen-add #btn-type-income.bg-gray-100\/50 {
                    background: #f1f5f9 !important;
                    border: 2px solid transparent !important;
                    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03) !important;
                    color: #94a3b8 !important;
                    transform: scale(0.98) !important;
                }

                #screen-add #btn-type-expense.bg-gray-100\/50 span:first-child,
                #screen-add #btn-type-income.bg-gray-100\/50 span:first-child {
                    filter: grayscale(1) !important;
                    opacity: 0.5 !important;
                }

                html.dark #screen-add #btn-type-expense.bg-gray-100\/50,
                html.dark #screen-add #btn-type-income.bg-gray-100\/50 {
                    background: rgba(30, 30, 60, 0.5) !important;
                    color: #64748b !important;
                    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2) !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               6. TUTAR INPUT ALANI
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add #input-amount {
                    background: #f8fafc !important;
                    border: 2px solid #e2e8f0 !important;
                    border-radius: 24px !important;
                    font-size: 2rem !important;
                    font-weight: 800 !important;
                    letter-spacing: -0.02em !important;
                    color: #1e293b !important;
                    box-shadow:
                        inset 0 2px 4px rgba(0, 0, 0, 0.02) !important;
                    transition: all 0.25s ease !important;
                }

                #screen-add #input-amount::placeholder {
                    color: #cbd5e1 !important;
                    font-weight: 600 !important;
                }

                #screen-add #input-amount:focus {
                    background: #ffffff !important;
                    border-color: #6366f1 !important;
                    box-shadow:
                        0 0 0 4px rgba(99, 102, 241, 0.1),
                        inset 0 1px 2px rgba(0, 0, 0, 0.02) !important;
                }

                html.dark #screen-add #input-amount {
                    background: #252545 !important;
                    border: 2px solid #3d3d6b !important;
                    color: #f1f5f9 !important;
                    box-shadow:
                        inset 0 2px 6px rgba(0, 0, 0, 0.15) !important;
                }

                html.dark #screen-add #input-amount::placeholder {
                    color: #64748b !important;
                }

                html.dark #screen-add #input-amount:focus {
                    background: #2a2a50 !important;
                    border-color: #818cf8 !important;
                    box-shadow:
                        0 0 0 4px rgba(129, 140, 248, 0.15),
                        inset 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                }

                /* Currency Select */
                #screen-add #input-currency {
                    color: #6366f1 !important;
                    font-weight: 700 !important;
                }

                html.dark #screen-add #input-currency {
                    color: #818cf8 !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               7. TARİH VE KATEGORİ INPUT'LARI
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add input[type="month"],
                #screen-add #input-category {
                    background: #f8fafc !important;
                    border: 1.5px solid #e2e8f0 !important;
                    border-radius: 16px !important;
                    color: #334155 !important;
                    font-weight: 600 !important;
                    box-shadow:
                        0 1px 2px rgba(0, 0, 0, 0.02),
                        inset 0 1px 2px rgba(0, 0, 0, 0.02) !important;
                    transition: all 0.2s ease !important;
                }

                #screen-add input[type="month"]:focus,
                #screen-add #input-category:focus {
                    background: #ffffff !important;
                    border-color: #6366f1 !important;
                    box-shadow:
                        0 0 0 3px rgba(99, 102, 241, 0.1),
                        0 2px 4px rgba(99, 102, 241, 0.05) !important;
                }

                html.dark #screen-add input[type="month"],
                html.dark #screen-add #input-category {
                    background: #252545 !important;
                    border: 1.5px solid #3d3d6b !important;
                    color: #e2e8f0 !important;
                    box-shadow:
                        inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                }

                html.dark #screen-add input[type="month"]:focus,
                html.dark #screen-add #input-category:focus {
                    background: #2a2a50 !important;
                    border-color: #818cf8 !important;
                    box-shadow:
                        0 0 0 3px rgba(129, 140, 248, 0.12) !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               8. NOT / AÇIKLAMA INPUT'U
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add #input-desc {
                    background: #f8fafc !important;
                    border: 1.5px solid #e2e8f0 !important;
                    border-radius: 16px !important;
                    color: #334155 !important;
                    transition: all 0.2s ease !important;
                }

                #screen-add #input-desc::placeholder {
                    color: #94a3b8 !important;
                }

                #screen-add #input-desc:focus {
                    background: #ffffff !important;
                    border-color: #a855f7 !important;
                    box-shadow:
                        0 0 0 3px rgba(168, 85, 247, 0.1) !important;
                }

                html.dark #screen-add #input-desc {
                    background: #252545 !important;
                    border: 1.5px solid #3d3d6b !important;
                    color: #e2e8f0 !important;
                }

                html.dark #screen-add #input-desc:focus {
                    background: #2a2a50 !important;
                    border-color: #c084fc !important;
                    box-shadow:
                        0 0 0 3px rgba(192, 132, 252, 0.12) !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               9. TEKRARLAMA OPSIYONLARI KARTI
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add .bg-gray-50.dark\:bg-white\/5 {
                    background: #f1f5f9 !important;
                    border: 1px solid #e2e8f0 !important;
                    border-radius: 20px !important;
                }

                html.dark #screen-add .bg-gray-50.dark\:bg-white\/5 {
                    background: #1a1a35 !important;
                    border: 1px solid #2d2d55 !important;
                }

                /* Toggle Switch Stilleri */
                #screen-add .peer-checked\:bg-blue-600 {
                    transition: background-color 0.25s ease !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               10. KAYDET BUTONU
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add #save-btn {
                    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #9333ea 100%) !important;
                    border: none !important;
                    border-radius: 20px !important;
                    font-size: 1.1rem !important;
                    font-weight: 800 !important;
                    letter-spacing: 0.02em !important;
                    box-shadow:
                        0 4px 14px rgba(79, 70, 229, 0.35),
                        0 8px 24px rgba(124, 58, 237, 0.25),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15),
                        inset 0 -2px 0 rgba(0, 0, 0, 0.1) !important;
                    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
                }

                #screen-add #save-btn:hover {
                    background: linear-gradient(135deg, #4338ca 0%, #6d28d9 50%, #7e22ce 100%) !important;
                    transform: translateY(-3px) scale(1.02) !important;
                    box-shadow:
                        0 8px 20px rgba(79, 70, 229, 0.4),
                        0 14px 40px rgba(124, 58, 237, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
                }

                #screen-add #save-btn:active {
                    transform: translateY(-1px) scale(0.99) !important;
                    box-shadow:
                        0 2px 8px rgba(79, 70, 229, 0.4),
                        0 4px 16px rgba(124, 58, 237, 0.25) !important;
                }

                /* Button Icon Animation */
                #screen-add #save-btn svg {
                    transition: transform 0.3s ease !important;
                }

                #screen-add #save-btn:hover svg {
                    transform: translateX(4px) !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               11. İPTAL BUTONU
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add #cancel-edit-btn {
                    background: #f1f5f9 !important;
                    border: 1.5px solid #e2e8f0 !important;
                    color: #64748b !important;
                    border-radius: 16px !important;
                    font-weight: 700 !important;
                    transition: all 0.2s ease !important;
                }

                #screen-add #cancel-edit-btn:hover {
                    background: #e2e8f0 !important;
                    border-color: #cbd5e1 !important;
                    color: #475569 !important;
                }

                html.dark #screen-add #cancel-edit-btn {
                    background: #252545 !important;
                    border: 1.5px solid #3d3d6b !important;
                    color: #94a3b8 !important;
                }

                html.dark #screen-add #cancel-edit-btn:hover {
                    background: #2d2d55 !important;
                    border-color: #4d4d7b !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               12. LABEL STİLLERİ
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add label {
                    color: #64748b !important;
                    font-weight: 700 !important;
                    letter-spacing: 0.08em !important;
                }

                html.dark #screen-add label {
                    color: #94a3b8 !important;
                }

                /* Focus içindeki label renk değişimi */
                #screen-add .group:focus-within label {
                    color: #6366f1 !important;
                }

                html.dark #screen-add .group:focus-within label {
                    color: #818cf8 !important;
                }

                /* ────────────────────────────────────────────────────────────────────────────
               13. BAŞARI MESAJI
               ──────────────────────────────────────────────────────────────────────────── */
                #screen-add #transaction-feedback>div {
                    background: #ecfdf5 !important;
                    border: 1.5px solid #a7f3d0 !important;
                    border-radius: 16px !important;
                }

                html.dark #screen-add #transaction-feedback>div {
                    background: rgba(16, 185, 129, 0.1) !important;
                    border: 1.5px solid rgba(52, 211, 153, 0.3) !important;
                }

                /* === MOBİL OPTİMİZASYON - TÜM SON DEĞİŞİKLİKLER === */

                /* 1. BLOB ANİMASYONLARI - Mobilde basitleştir */
                body::before,
                body::after,
                #app-container::before {
                    /* Mobilde daha küçük boyut */
                    width: 35vw !important;
                    height: 35vw !important;
                    /* Animasyonları basitleştir - performans için */
                    animation: liquidFloat 25s ease-in-out infinite !important;
                    /* Diğer animasyonları kaldır */
                    filter: blur(40px) !important;
                    opacity: 0.6 !important;
                }

                /* Blob morph ve color shift'i mobilde kapat */
                @keyframes liquidMorph {

                    0%,
                    100% {
                        border-radius: 50%;
                    }
                }

                @keyframes colorShift {

                    0%,
                    100% {
                        filter: blur(40px);
                    }
                }

                /* 2. PREMİUM MODAL - Mobil optimizasyon */
                #premium-modal>div {
                    max-height: 90vh;
                    overflow-y: auto;
                    margin: 16px;
                }

                #premium-modal .premium-crown {
                    width: 80px !important;
                    height: 80px !important;
                }

                #premium-modal h3 {
                    font-size: 1.5rem !important;
                }

                /* Premium modal feature list - daha kompakt */
                #premium-modal .space-y-3>div {
                    padding: 10px !important;
                }

                /* 3. AUTOPILOT PREMIUM GATE - Mobil */
                #autopilot-premium-gate .premium-crown {
                    width: 100px !important;
                    height: 100px !important;
                }

                #autopilot-premium-gate h2 {
                    font-size: 1.75rem !important;
                }

                #autopilot-premium-gate .flex-wrap {
                    gap: 6px !important;
                }

                /* Animated orbs mobilde gizle veya küçült */
                #autopilot-premium-gate [class*="blur-[80px]"] {
                    display: none !important;
                }

                /* 4. NAVİGASYON BAR - Touch-friendly */
                #main-nav {
                    padding: 8px 4px !important;
                }

                .nav-item {
                    min-width: 52px !important;
                    min-height: 52px !important;
                }

                /* Nav blob mobilde daha basit */
                .nav-liquid-blob {
                    box-shadow:
                        0 0 30px rgba(99, 102, 241, 0.4),
                        0 8px 20px rgba(0, 0, 0, 0.15) !important;
                }

                /* Ortadaki + butonu mobilde daha küçük */
                #nav-add>div {
                    width: 56px !important;
                    height: 56px !important;
                }

                #nav-add {
                    margin-top: -24px !important;
                }

                /* 5. HEADER BADGE - Mobil görünürlük */
                #user-plan-badge {
                    font-size: 9px !important;
                    padding: 4px 8px !important;
                }

                /* Privacy toggle ve upgrade button */
                #btn-privacy-toggle,
                #btn-header-upgrade {
                    padding: 6px !important;
                }

                /* 6. FINGO AUTOPILOT - Kompakt layout */
                #screen-wallet .px-2 {
                    padding-left: 8px !important;
                    padding-right: 8px !important;
                }

                /* Kredi hesaplayıcı ve döviz çevirici - daha kompakt */
                #screen-wallet input {
                    padding: 10px !important;
                    font-size: 14px !important;
                }

                /* 7. GENEL MOBİL PERFORMANS */
                /* Gereksiz animasyonları mobilde devre dışı bırak */
                .animate-pulse-slow {
                    animation-duration: 4s !important;
                }

                /* Gölgeleri hafiflet */
                .glass-card {
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08) !important;
                }

                html.dark .glass-card {
                    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3) !important;
                }

                /* 8. PROFİL MODAL - Mobil Estetik Düzeltmeleri */

                /* === PROFIL MODAL - MOBIL DESKTOP-LIKE FIX === */
                /* ============================= */
                /* PROFILE MODAL - MOBILE DESKTOP-LIKE FIX */
                /* Centered card, single scroll, footer visible */
                /* ============================= */
                @media (max-width: 768px),
                (max-height: 740px) {

                    /* Safe area variables */
                    :root {
                        --safe-top: env(safe-area-inset-top, 0px);
                        --safe-bottom: env(safe-area-inset-bottom, 0px);
                        --app-vh: 1vh;
                    }

                    /* 1) Overlay: CENTERED, scroll kapalı */
                    #profile-modal {
                        display: flex !important;
                        align-items: center !important;
                        /* ORTALI - flex-start DEĞİL */
                        justify-content: center !important;

                        /* Tam ekran yükseklik */
                        height: calc(var(--app-vh, 1vh) * 100) !important;

                        /* Safe area + küçük boşluk */
                        padding-top: calc(var(--safe-top) + 12px) !important;
                        padding-bottom: calc(var(--safe-bottom) + 12px) !important;
                        padding-left: max(10px, env(safe-area-inset-left, 0px)) !important;
                        padding-right: max(10px, env(safe-area-inset-right, 0px)) !important;

                        /* OVERLAY SCROLL KAPALI: tek scroll içerikte */
                        overflow: hidden !important;
                    }

                    /* 2) Kart: ekrana sığan, flex column */
                    #profile-modal>div.glass-card {
                        width: min(520px, calc(100vw - 20px)) !important;

                        /* Net yükseklik (iOS için daha stabil) */
                        height: calc((var(--app-vh, 1vh) * 100) - 24px - var(--safe-top) - var(--safe-bottom)) !important;
                        max-height: none !important;

                        margin: 0 auto !important;

                        /* Kart scroll olmayacak, içerik scroll olacak */
                        overflow: hidden !important;
                        display: flex !important;
                        flex-direction: column !important;
                    }

                    /* DVH destekleyen tarayıcılar için */
                    @supports (height: 100dvh) {
                        #profile-modal {
                            height: 100dvh !important;
                        }

                        #profile-modal>div.glass-card {
                            height: calc(100dvh - 24px - var(--safe-top) - var(--safe-bottom)) !important;
                        }
                    }

                    /* 3) İçerik scroll alanı: TEK SCROLL BURADA */
                    #profile-modal .custom-scroll {
                        flex: 1 1 auto !important;
                        min-height: 0 !important;
                        overflow-y: auto !important;
                        -webkit-overflow-scrolling: touch !important;
                        overscroll-behavior: contain !important;
                    }

                    /* 4) Settings tab: kendi scrollu iptal, ana scroll'a bırak */
                    #profile-tab-settings {
                        max-height: none !important;
                        overflow: visible !important;
                        padding-bottom: 0 !important;
                    }

                    /* 5) Footer: sticky iptal, flex kolon içinde doğal pozisyon */
                    #profile-modal .shrink-0 {
                        flex-shrink: 0 !important;
                    }

                    /* 6) X butonu: ABSOLUTE (fixed değil), kart içinde */
                    #profile-modal .profile-close-btn {
                        position: absolute !important;
                        top: 12px !important;
                        right: 12px !important;
                        z-index: 50 !important;

                        /* Parmak hedefi */
                        width: 44px !important;
                        height: 44px !important;
                        min-width: 44px !important;
                        min-height: 44px !important;

                        display: inline-flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                    }
                }


                /* Dark Mode Profile Modal - Glass Effect Fix */
                html.dark #profile-modal>div.glass-card {
                    /* çok opak olmasın; cam gibi kalsın */
                    background: rgba(15, 23, 42, 0.72) !important;
                    backdrop-filter: blur(18px) saturate(140%) !important;
                }

                /* Sekme butonları container - Daha iyi görünüm */
                #profile-modal .flex.justify-between.items-center.py-2 {
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    gap: 4px !important;
                    padding: 6px !important;
                    border-radius: 16px !important;
                    margin: 12px 0 !important;
                }

                /* Sekme butonları - Premium stil */
                #tab-info,
                #tab-settings,
                #tab-data {
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    min-height: 40px !important;
                    padding: 8px 12px !important;
                    font-size: 12px !important;
                    border-radius: 12px !important;
                    align-items: center !important;
                    justify-content: center !important;
                }

                /* Aktif sekme stili */
                #tab-info.active,
                #tab-settings.active,
                #tab-data.active {
                    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)) !important;
                    color: white !important;
                }

                /* Profil içerik alanı */
                #profile-modal div[class*="max-h"] {
                    max-height: 50vh !important;
                    overflow-y: auto !important;
                    padding-right: 4px !important;
                }

                /* Avatar - Küçültülmüş */
                #profile-modal .w-20.h-20,
                #profile-modal [class*="w-20"][class*="h-20"] {
                    width: 56px !important;
                    height: 56px !important;
                }

                #profile-modal h3.text-xl {
                    font-size: 1rem !important;
                    margin-bottom: 8px !important;
                }

                /* Profile Modal Input - Estetik düzeltme */
                #profile-modal input,
                #profile-modal select {
                    border-radius: 12px !important;
                    padding: 12px 16px !important;
                    font-size: 14px !important;
                    border: 1px solid rgba(0, 0, 0, 0.1) !important;
                }

                html.dark #profile-modal input,
                html.dark #profile-modal select {
                    background: rgba(30, 41, 59, 0.9) !important;
                    border-color: rgba(255, 255, 255, 0.15) !important;
                    color: #f8fafc !important;
                }

                html:not(.dark) #profile-modal input,
                html:not(.dark) #profile-modal select {
                    background: rgba(255, 255, 255, 0.95) !important;
                    border-color: rgba(0, 0, 0, 0.1) !important;
                    color: #0f172a !important;
                }

                /* Avatar grid - Daha kompakt */
                #profile-modal #avatar-selection {
                    gap: 8px !important;
                    padding: 8px !important;
                }

                #profile-modal #avatar-selection>div,
                #profile-modal #avatar-selection>button {
                    width: 44px !important;
                    height: 44px !important;
                }

                /* Label stilleri */
                #profile-modal label,
                #profile-modal h4 {
                    font-size: 11px !important;
                    margin-bottom: 6px !important;
                }

                html.dark #profile-modal label,
                html.dark #profile-modal h4 {
                    color: #94a3b8 !important;
                }

                /* ============================================= */
                /* 9. MOBİL KARANLIK MOD OVERRIDE'LAR (KRİTİK!) */
                /* ============================================= */

                /* Body arka planı - Mobilde Karanlık */
                html.dark body {
                    background: linear-gradient(135deg, #020617 0%, #0f172a 100%) !important;
                    background-color: #020617 !important;
                    color: #f8fafc !important;
                }

                /* Glass Card - Mobilde Karanlık */
                html.dark .glass-card,
                html.dark .glass-card-strong,
                html.dark .glass-card-light {
                    background: rgba(15, 23, 42, 0.85) !important;
                    background-color: rgba(15, 23, 42, 0.85) !important;
                    border-color: rgba(255, 255, 255, 0.1) !important;
                    color: #f8fafc !important;
                }

                /* Tailwind bg-white ve bg-gray sınıfları - Mobil Karanlık */
                html.dark .bg-white,
                html.dark .bg-gray-50,
                html.dark .bg-slate-50,
                html.dark .bg-zinc-50 {
                    background: rgba(30, 41, 59, 0.8) !important;
                    background-color: rgba(30, 41, 59, 0.8) !important;
                }

                html.dark .bg-gray-100,
                html.dark .bg-slate-100 {
                    background: rgba(51, 65, 85, 0.6) !important;
                    background-color: rgba(51, 65, 85, 0.6) !important;
                }

                /* Metinler - Mobil Karanlık */
                html.dark .text-gray-900,
                html.dark .text-slate-900,
                html.dark .text-gray-800,
                html.dark .text-slate-800,
                html.dark .text-black,
                html.dark [style*="color: #0f172a"],
                html.dark [style*="color: #1e293b"] {
                    color: #f1f5f9 !important;
                }

                html.dark .text-gray-700,
                html.dark .text-gray-600,
                html.dark .text-slate-600,
                html.dark .text-gray-500,
                html.dark [style*="color: #374151"],
                html.dark [style*="color: #4b5563"] {
                    color: #94a3b8 !important;
                }

                /* Input ve Select - Mobil Karanlık */
                html.dark input,
                html.dark select,
                html.dark textarea,
                html.dark .modern-input {
                    background: rgba(15, 23, 42, 0.9) !important;
                    background-color: rgba(15, 23, 42, 0.9) !important;
                    color: #f8fafc !important;
                    border-color: rgba(255, 255, 255, 0.15) !important;
                }

                /* Header - Mobil Karanlık - Frosted Glass */
                html.dark #main-header {
                    background: rgba(15, 23, 42, 0.3) !important;
                    backdrop-filter: blur(32px) saturate(180%) brightness(0.95) !important;
                    -webkit-backdrop-filter: blur(32px) saturate(180%) brightness(0.95) !important;
                    border-color: rgba(255, 255, 255, 0.12) !important;
                }

                /* Nav Bar - Mobil Karanlık - Frosted Glass */
                html.dark #main-nav {
                    background: rgba(15, 23, 42, 0.3) !important;
                    backdrop-filter: blur(32px) saturate(180%) brightness(0.95) !important;
                    -webkit-backdrop-filter: blur(32px) saturate(180%) brightness(0.95) !important;
                    border-color: rgba(255, 255, 255, 0.12) !important;
                }

                /* Modals - Mobil Karanlık */
                html.dark #profile-modal>div,
                html.dark #premium-modal>div,
                html.dark #theme-modal>div,
                html.dark .modal-overlay>div {
                    background: rgba(15, 23, 42, 0.95) !important;
                    color: #f8fafc !important;
                }

                /* ✅ FIX: Rozet/NFT 3D modalında altta görünen ekstra dikdörtgen paneli kaldır */
                html.dark #nft-detail-modal.modal-overlay>div {
                    background: transparent !important;
                    box-shadow: none !important;
                    border: none !important;
                }

                /* Placeholder text - Mobil Karanlık */
                html.dark ::placeholder {
                    color: #64748b !important;
                    opacity: 1 !important;
                }

                /* Butonlar - Mobil Karanlık */
                html.dark button[class*="bg-gray-100"],
                html.dark button[class*="bg-gray-50"] {
                    background: rgba(51, 65, 85, 0.8) !important;
                    color: #e2e8f0 !important;
                }

                /* Chart ve grafik alanları - Mobil Karanlık */
                html.dark #screen-dashboard,
                html.dark #screen-notes,
                html.dark #screen-wallet,
                html.dark #screen-add {
                    color: #f8fafc !important;
                }

                /* Label ve small text - Mobil Karanlık */
                html.dark label,
                html.dark h4,
                html.dark h3,
                html.dark h2 {
                    color: #e2e8f0 !important;
                }

                html.dark p {
                    color: #cbd5e1 !important;
                }
            }




            /* === ANIMASYONLU ARKA PLAN === */
            body {
                font-family: 'Inter', system-ui, -apple-system, sans-serif;
                background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
                color: var(--text-primary);
                min-height: 100vh;
                overflow-x: hidden;
                -webkit-tap-highlight-color: transparent;
                transition: var(--transition-smooth);
            }

            /* === PREMIUM LIQUID GLASS ORBS - 3D Efekt === */
            body::before,
            body::after {
                content: '';
                position: fixed;
                z-index: -1;
                /* Morph animasyonu - organik şekil değişimi */
                animation:
                    liquidFloat 20s ease-in-out infinite,
                    liquidMorph 15s ease-in-out infinite,
                    colorShift 30s ease-in-out infinite;
            }

            body::before {
                width: 55vw;
                height: 55vw;
                /* Radial gradient - 3D derinlik hissi */
                background:
                    radial-gradient(ellipse at 30% 30%, rgba(139, 92, 246, 0.8) 0%, transparent 50%),
                    radial-gradient(ellipse at 70% 60%, rgba(99, 102, 241, 0.6) 0%, transparent 45%),
                    radial-gradient(ellipse at 50% 50%, var(--bg-orb-1) 0%, transparent 70%);
                top: -25%;
                right: -25%;
                filter: blur(60px);
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
                animation-delay: 0s, 0s, 0s;
                /* Glassmorphism iç glow */
                box-shadow:
                    inset 0 0 100px rgba(139, 92, 246, 0.3),
                    0 0 80px rgba(99, 102, 241, 0.2);
            }

            body::after {
                width: 45vw;
                height: 45vw;
                background:
                    radial-gradient(ellipse at 60% 40%, rgba(168, 85, 247, 0.7) 0%, transparent 45%),
                    radial-gradient(ellipse at 30% 70%, rgba(236, 72, 153, 0.5) 0%, transparent 50%),
                    radial-gradient(ellipse at 50% 50%, var(--bg-orb-2) 0%, transparent 65%);
                bottom: -20%;
                left: -20%;
                filter: blur(70px);
                border-radius: 40% 60% 70% 30% / 40% 70% 30% 60%;
                animation-delay: -8s, -5s, -15s;
                box-shadow:
                    inset 0 0 80px rgba(168, 85, 247, 0.25),
                    0 0 60px rgba(236, 72, 153, 0.15);
            }

            /* Üçüncü Orb - Merkez */
            #app-container::before {
                content: '';
                position: fixed;
                width: 40vw;
                height: 40vw;
                background:
                    radial-gradient(ellipse at 40% 30%, rgba(59, 130, 246, 0.6) 0%, transparent 40%),
                    radial-gradient(ellipse at 60% 70%, rgba(147, 51, 234, 0.4) 0%, transparent 50%),
                    radial-gradient(ellipse at 50% 50%, var(--bg-orb-3) 0%, transparent 60%);
                top: 35%;
                left: 50%;
                transform: translateX(-50%);
                border-radius: 50% 50% 40% 60% / 40% 60% 50% 50%;
                filter: blur(80px);
                z-index: -1;
                animation:
                    liquidFloat 25s ease-in-out infinite reverse,
                    liquidMorph 20s ease-in-out infinite reverse,
                    colorShift 25s ease-in-out infinite reverse;
                animation-delay: -5s, -10s, -8s;
                box-shadow:
                    inset 0 0 60px rgba(59, 130, 246, 0.2),
                    0 0 50px rgba(147, 51, 234, 0.1);
            }

            /* Liquid Float - Organik hareket */
            @keyframes liquidFloat {

                0%,
                100% {
                    transform: translate(0, 0) scale(1) rotate(0deg);
                }

                20% {
                    transform: translate(3%, 8%) scale(1.03) rotate(2deg);
                }

                40% {
                    transform: translate(-4%, 4%) scale(0.97) rotate(-1deg);
                }

                60% {
                    transform: translate(6%, -3%) scale(1.02) rotate(1deg);
                }

                80% {
                    transform: translate(-2%, -6%) scale(0.98) rotate(-2deg);
                }
            }

            /* Liquid Morph - Şekil değişimi (lav lambası efekti) */
            @keyframes liquidMorph {

                0%,
                100% {
                    border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
                }

                25% {
                    border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
                }

                50% {
                    border-radius: 50% 60% 30% 60% / 30% 40% 70% 50%;
                }

                75% {
                    border-radius: 40% 50% 60% 50% / 60% 50% 40% 60%;
                }
            }

            /* Color Shift - Renk geçişi */
            @keyframes colorShift {

                0%,
                100% {
                    filter: blur(60px) hue-rotate(0deg) saturate(1);
                }

                33% {
                    filter: blur(70px) hue-rotate(15deg) saturate(1.1);
                }

                66% {
                    filter: blur(55px) hue-rotate(-10deg) saturate(0.95);
                }
            }

            /* Eski float animasyonu kaldırıldı - yenisi liquidFloat */

            /* Yeni İşlem ekranında orb'ları gizle */
            body.hide-orbs::before,
            body.hide-orbs::after {
                opacity: 0 !important;
                visibility: hidden !important;
                transition: opacity 0.3s ease, visibility 0.3s ease;
            }

            body.hide-orbs #app-container::before {
                opacity: 0 !important;
                visibility: hidden !important;
            }

            /* === ULTRA PREMIUM GLASSMORPHISM KARTLAR === */
            .glass-card {
                background: var(--glass-bg);
                backdrop-filter: var(--glass-blur);
                -webkit-backdrop-filter: var(--glass-blur);
                border: 1px solid var(--glass-border);
                border-radius: var(--card-radius);
                box-shadow: var(--glass-shadow), var(--shadow-inset);
                transition: var(--transition-smooth);
                position: relative;
            }

            .glass-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 255, 255, 0.5),
                        transparent);
                border-radius: var(--card-radius) var(--card-radius) 0 0;
            }

            html.dark .glass-card::before {
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 255, 255, 0.15),
                        transparent);
            }

            .glass-card:hover {
                transform: translateY(-6px) scale(1.01);
                box-shadow: var(--shadow-3d-medium), var(--shadow-inset);
                border-color: var(--accent-primary);
            }

            .glass-card-strong {
                background: var(--glass-bg-strong);
                backdrop-filter: blur(30px) saturate(180%);
                -webkit-backdrop-filter: blur(30px) saturate(180%);
                box-shadow: var(--glass-shadow-elevated), var(--shadow-inset);
            }

            /* === GELIŞMIŞ 3D EFEKTLER === */
            .card-3d {
                transform-style: preserve-3d;
                perspective: 1000px;
                transition: var(--transition-bounce);
            }

            .card-3d:hover {
                transform: rotateX(5deg) rotateY(-5deg) translateZ(30px);
                box-shadow: var(--shadow-3d-heavy);
            }

            /* Ultra Glow Efekti */
            .glow {
                position: relative;
                overflow: visible;
            }

            .glow::after {
                content: '';
                position: absolute;
                inset: -4px;
                background: linear-gradient(135deg,
                        var(--accent-primary),
                        var(--accent-secondary),
                        var(--accent-tertiary),
                        var(--accent-primary));
                background-size: 300% 300%;
                border-radius: inherit;
                z-index: -1;
                opacity: 0;
                filter: blur(20px);
                transition: opacity 0.4s ease, filter 0.4s ease;
                animation: glow-pulse 4s ease-in-out infinite;
            }

            @keyframes glow-pulse {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            .glow:hover::after {
                opacity: 0.7;
                filter: blur(25px);
            }

            /* === TİPOGRAFİ GELİŞTİRMELERİ === */
            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                color: var(--text-primary);
                font-weight: 700;
                letter-spacing: -0.02em;
                line-height: 1.2;
            }

            p {
                color: var(--text-secondary);
                line-height: 1.6;
            }

            /* Okunabilir Yazı Stilleri */
            .text-readable {
                color: var(--text-primary);
                font-weight: 500;
                letter-spacing: -0.01em;
            }

            .text-subtle {
                color: var(--text-muted);
                font-weight: 400;
            }

            /* Sayı ve Para Gösterimi */
            .text-amount {
                font-variant-numeric: tabular-nums;
                font-weight: 700;
                letter-spacing: -0.02em;
            }

            .text-amount-large {
                font-size: 2rem;
                font-weight: 800;
                background: linear-gradient(135deg, var(--text-primary), var(--accent-primary));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            html.dark .text-amount-large {
                background: linear-gradient(135deg, var(--text-primary), var(--accent-secondary));
                -webkit-background-clip: text;
                background-clip: text;
            }

            /* === FLOATING HEADER - Buzlu Cam Efekti === */
            #main-header {
                position: relative;
                transform: translateZ(0);
                animation: float-gentle 6s ease-in-out infinite;

                /* Light Mode - Enhanced Frosted Glass */
                background: rgba(255, 255, 255, 0.5);
                backdrop-filter: blur(32px) saturate(200%) brightness(1.05);
                -webkit-backdrop-filter: blur(32px) saturate(200%) brightness(1.05);
                border: 1px solid rgba(255, 255, 255, 0.6);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.7);
                border-radius: 24px;
            }

            /* Dark Mode Header - Enhanced Frosted Glass */
            html.dark #main-header {
                background: rgba(15, 23, 42, 0.45) !important;
                backdrop-filter: blur(32px) saturate(180%) brightness(0.95) !important;
                -webkit-backdrop-filter: blur(32px) saturate(180%) brightness(0.95) !important;
                border-color: rgba(255, 255, 255, 0.12) !important;
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    0 0 60px rgba(129, 140, 248, 0.12),
                    inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
            }

            @keyframes float-gentle {

                0%,
                100% {
                    transform: translateY(0px);
                }

                50% {
                    transform: translateY(-3px);
                }
            }

            #main-header::before {
                content: '';
                position: absolute;
                inset: -1px;
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary), var(--accent-tertiary));
                border-radius: inherit;
                z-index: -1;
                opacity: 0.1;
                filter: blur(25px);
            }

            /* === iOS 26 LIQUID GLASS NAVİGASYON === */
            .nav-liquid-blob {
                position: absolute;
                height: 56px;
                border-radius: 28px;
                transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
                z-index: 0;
                pointer-events: none;
                transform-style: preserve-3d;
            }

            /* Blob Hidden State (for add screen) */
            .nav-liquid-blob.blob-hidden {
                opacity: 0 !important;
                visibility: hidden !important;
                transform: scale(0) translateY(20px) !important;
                pointer-events: none;
                box-shadow: none !important;
            }

            /* ULTRA REALISTIC 3D LIQUID GLASS - Light Mode */
            .nav-liquid-blob {
                /* Multi-layer liquid glass gradient with refraction */
                background:
                    /* Caustic light pattern */
                    radial-gradient(ellipse 80% 50% at 50% 0%, rgba(255, 255, 255, 0.9) 0%, transparent 50%),
                    /* Secondary caustic */
                    radial-gradient(ellipse 60% 40% at 30% 20%, rgba(255, 255, 255, 0.5) 0%, transparent 40%),
                    radial-gradient(ellipse 60% 40% at 70% 30%, rgba(255, 255, 255, 0.4) 0%, transparent 40%),
                    /* Base liquid glass */
                    linear-gradient(180deg,
                        rgba(255, 255, 255, 0.98) 0%,
                        rgba(255, 255, 255, 0.7) 30%,
                        rgba(240, 245, 255, 0.8) 60%,
                        rgba(230, 240, 255, 0.75) 100%);
                /* Ultra-realistic multi-layer glass shadow */
                box-shadow:
                    /* Outer ambient glow */
                    0 0 60px rgba(99, 102, 241, 0.5),
                    0 0 100px rgba(139, 92, 246, 0.35),
                    0 0 140px rgba(99, 102, 241, 0.2),
                    /* 3D floating shadow */
                    0 20px 40px rgba(99, 102, 241, 0.35),
                    0 10px 25px rgba(0, 0, 0, 0.15),
                    0 5px 12px rgba(99, 102, 241, 0.25),
                    /* Liquid glass inner reflections */
                    inset 0 3px 5px rgba(255, 255, 255, 1),
                    inset 0 8px 15px rgba(255, 255, 255, 0.85),
                    inset 0 15px 30px rgba(255, 255, 255, 0.5),
                    /* Bottom liquid shadow */
                    inset 0 -5px 10px rgba(99, 102, 241, 0.15),
                    inset 0 -2px 5px rgba(0, 0, 0, 0.08);
                /* Premium glass blur */
                backdrop-filter: blur(30px) saturate(220%) brightness(1.08);
                -webkit-backdrop-filter: blur(30px) saturate(220%) brightness(1.08);
                /* Liquid glass border - simple solid border (border-image breaks border-radius) */
                border: 1.5px solid rgba(255, 255, 255, 0.8);
                border-top-color: rgba(255, 255, 255, 1);
                border-bottom-color: rgba(200, 210, 240, 0.4);
                /* Subtle morphing animation */
                animation: liquidMorph 8s ease-in-out infinite;
            }


            @keyframes liquidMorph {

                0%,
                100% {
                    border-radius: 28px 28px 28px 28px;
                }

                25% {
                    border-radius: 30px 26px 28px 28px;
                }

                50% {
                    border-radius: 26px 30px 26px 30px;
                }

                75% {
                    border-radius: 28px 28px 30px 26px;
                }
            }



            /* ULTRA REALISTIC 3D LIQUID GLASS - Dark Mode */
            html.dark .nav-liquid-blob {
                /* Multi-layer holographic glass gradient */
                background:
                    /* Üst yansıma katmanı */
                    linear-gradient(180deg,
                        rgba(255, 255, 255, 0.25) 0%,
                        rgba(255, 255, 255, 0) 40%),
                    /* Holographic gradient */
                    linear-gradient(145deg,
                        rgba(255, 255, 255, 0.18) 0%,
                        rgba(129, 140, 248, 0.15) 25%,
                        rgba(167, 139, 250, 0.12) 50%,
                        rgba(139, 92, 246, 0.1) 75%,
                        rgba(99, 102, 241, 0.08) 100%);
                /* Ultra neon 3D shadow system */
                box-shadow:
                    /* Multi-layer neon glow */
                    0 0 50px rgba(129, 140, 248, 0.6),
                    0 0 100px rgba(129, 140, 248, 0.45),
                    0 0 150px rgba(167, 139, 250, 0.3),
                    0 0 200px rgba(99, 102, 241, 0.2),
                    /* 3D depth shadows */
                    0 15px 40px rgba(129, 140, 248, 0.5),
                    0 8px 25px rgba(0, 0, 0, 0.5),
                    0 4px 12px rgba(167, 139, 250, 0.4),
                    /* Inner glass reflections */
                    inset 0 2px 4px rgba(255, 255, 255, 0.3),
                    inset 0 6px 12px rgba(255, 255, 255, 0.15),
                    inset 0 12px 24px rgba(129, 140, 248, 0.1),
                    /* Inner bottom depth */
                    inset 0 -4px 8px rgba(0, 0, 0, 0.4),
                    inset 0 -2px 4px rgba(129, 140, 248, 0.25);
                /* Premium glass border */
                border: 1.5px solid rgba(255, 255, 255, 0.2);
                border-top-color: rgba(255, 255, 255, 0.35);
                border-bottom-color: rgba(129, 140, 248, 0.3);
            }


            /* Nav Icon Size Enhancement */
            .nav-icon-box {
                width: 48px;
                height: 48px;
            }

            .nav-icon-box svg {
                width: 26px !important;
                height: 26px !important;
            }

            /* === NAVİGASYON TIKLANMA FİXİ === */
            /* Buton tıklama alanını genişlet ve izole et */
            .nav-item {
                isolation: isolate;
                position: relative;
                /* Minimum touch target: 48px (zaten w-14 = 56px var) */
                min-width: 56px;
                min-height: 56px;
                /* Butonlar arası çakışmayı önle */
                margin: 0 2px;
            }

            /* Tıklama alanını genişletmek için pseudo-element */
            .nav-item::before {
                content: '';
                position: absolute;
                inset: -8px;
                z-index: 0;
            }

            /* Icon box'ın tıklamaları engellemediğinden emin ol */
            .nav-icon-box {
                pointer-events: none;
            }

            /* SVG ikonlarının da tıklamayı engellemediğinden emin ol */
            .nav-item svg {
                pointer-events: none;
            }

            /* Active Nav Item */
            .nav-item.active .nav-icon-box {
                background: transparent !important;
                border: none !important;
                transform: scale(1.2);
                box-shadow: none;
            }

            .nav-item.active .nav-icon-box svg {
                width: 28px !important;
                height: 28px !important;
                color: var(--accent-primary) !important;
                stroke: var(--accent-primary) !important;
                filter: drop-shadow(0 0 12px var(--accent-glow-strong));
                transform: scale(1.15);
            }


            /* Jelly Bounce Animation */
            @keyframes jelly-bounce {
                0% {
                    transform: scale(1, 1);
                }

                30% {
                    transform: scale(1.15, 0.9);
                }

                50% {
                    transform: scale(0.95, 1.05);
                }

                70% {
                    transform: scale(1.05, 0.95);
                }

                100% {
                    transform: scale(1, 1);
                }
            }

            .nav-item:active {
                animation: jelly-bounce 0.4s ease;
            }

            /* === MICRO-INTERACTIONS: RIPPLE EFFECT === */
            .ripple-container {
                position: relative;
                overflow: hidden;
            }

            .ripple {
                position: absolute;
                border-radius: 50%;
                background: radial-gradient(circle, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 70%);
                transform: scale(0);
                animation: rippleEffect 0.6s ease-out forwards;
                pointer-events: none;
                z-index: 100;
            }

            @keyframes rippleEffect {
                0% {
                    transform: scale(0);
                    opacity: 1;
                }

                100% {
                    transform: scale(4);
                    opacity: 0;
                }
            }

            /* Dark Mode Ripple */
            html.dark .ripple {
                background: radial-gradient(circle, rgba(129, 140, 248, 0.5) 0%, rgba(129, 140, 248, 0) 70%);
            }

            /* === MICRO-INTERACTIONS: BUTTON EFFECTS === */
            .btn-interactive {
                position: relative;
                overflow: hidden;
                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1),
                    box-shadow 0.2s ease;
            }

            .btn-interactive:hover {
                transform: translateY(-2px) scale(1.02);
            }

            .btn-interactive:active {
                transform: translateY(1px) scale(0.98);
            }

            /* Bounce Effect */
            .btn-bounce {
                transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .btn-bounce:active {
                animation: bouncePress 0.4s ease;
            }

            @keyframes bouncePress {
                0% {
                    transform: scale(1);
                }

                30% {
                    transform: scale(0.92);
                }

                50% {
                    transform: scale(1.05);
                }

                70% {
                    transform: scale(0.98);
                }

                100% {
                    transform: scale(1);
                }
            }

            /* Glow Pulse on Hover */
            .btn-glow:hover {
                box-shadow: 0 0 20px var(--accent-glow),
                    0 0 40px var(--accent-glow-strong);
            }

            /* Press Effect */
            .btn-press:active {
                transform: scale(0.95);
                filter: brightness(0.9);
            }

            /* Card Hover Lift */
            .card-lift {
                transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
                    box-shadow 0.3s ease;
            }

            .card-lift:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }

            html.dark .card-lift:hover {
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4),
                    0 0 60px var(--accent-glow);
            }

            /* === WIDGET DRAG & DROP STYLES === */
            .dashboard-widget {
                cursor: grab;
                transition: transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;
            }

            .dashboard-widget:active {
                cursor: grabbing;
            }

            .widget-dragging {
                opacity: 0.5;
                transform: scale(1.02) rotate(1deg);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                z-index: 1000;
            }

            .widget-drag-over {
                transform: scale(0.98);
                border: 2px dashed var(--accent-primary) !important;
                background: rgba(99, 102, 241, 0.1) !important;
            }

            html.dark .widget-drag-over {
                background: rgba(129, 140, 248, 0.15) !important;
            }

            /* Widget placeholder animation */
            @keyframes widgetPulse {

                0%,
                100% {
                    border-color: var(--accent-primary);
                }

                50% {
                    border-color: var(--accent-secondary);
                }
            }

            .widget-drag-over {
                animation: widgetPulse 1s ease-in-out infinite;
            }


            /* 3D Morph Transition - Enhanced Organic Liquid */
            @keyframes liquid-morph {
                0% {
                    border-radius: 24px;
                    transform: translateY(-50%) scale(1) rotate(0deg);
                }

                15% {
                    border-radius: 26px 22px 28px 20px;
                    transform: translateY(-50%) scale(1.02, 0.96) rotate(0.5deg);
                }

                30% {
                    border-radius: 22px 28px 20px 26px;
                    transform: translateY(-50%) scale(0.98, 1.04) rotate(-0.5deg);
                }

                45% {
                    border-radius: 28px 20px 26px 22px;
                    transform: translateY(-50%) scale(1.01, 0.99) rotate(0.3deg);
                }

                60% {
                    border-radius: 20px 26px 22px 28px;
                    transform: translateY(-50%) scale(0.99, 1.01) rotate(-0.3deg);
                }

                75% {
                    border-radius: 25px 23px 27px 21px;
                    transform: translateY(-50%) scale(1.005, 0.995) rotate(0.1deg);
                }

                100% {
                    border-radius: 24px;
                    transform: translateY(-50%) scale(1) rotate(0deg);
                }
            }

            /* Ultra Realistic Liquid Wobble */
            @keyframes liquid-wobble {

                0%,
                100% {
                    border-radius: 24px;
                    transform: translateY(-50%) scale(1);
                }

                10% {
                    border-radius: 26px 22px 26px 22px;
                    transform: translateY(-50%) scale(1.08, 0.92);
                }

                20% {
                    border-radius: 22px 26px 22px 26px;
                    transform: translateY(-50%) scale(0.94, 1.06);
                }

                30% {
                    border-radius: 25px 23px 25px 23px;
                    transform: translateY(-50%) scale(1.04, 0.96);
                }

                40% {
                    border-radius: 23px 25px 23px 25px;
                    transform: translateY(-50%) scale(0.97, 1.03);
                }

                50% {
                    border-radius: 24px 24px 24px 24px;
                    transform: translateY(-50%) scale(1.02, 0.98);
                }

                60% {
                    border-radius: 24px;
                    transform: translateY(-50%) scale(0.99, 1.01);
                }

                70% {
                    transform: translateY(-50%) scale(1.01, 0.99);
                }

                80% {
                    transform: translateY(-50%) scale(0.995, 1.005);
                }

                90% {
                    transform: translateY(-50%) scale(1.002, 0.998);
                }
            }

            /* Liquid Settle Animation - Spring Physics */
            @keyframes liquid-settle {
                0% {
                    transform: translateY(-50%) scale(1.1, 0.9);
                    filter: blur(0.5px);
                }

                20% {
                    transform: translateY(-50%) scale(0.92, 1.08);
                    filter: blur(0.3px);
                }

                40% {
                    transform: translateY(-50%) scale(1.05, 0.95);
                    filter: blur(0.2px);
                }

                60% {
                    transform: translateY(-50%) scale(0.97, 1.03);
                    filter: blur(0.1px);
                }

                80% {
                    transform: translateY(-50%) scale(1.02, 0.98);
                    filter: blur(0px);
                }

                100% {
                    transform: translateY(-50%) scale(1);
                    filter: blur(0px);
                }
            }

            /* === ULTRA PREMIUM iOS 26 LIQUID GLASS === */
            .nav-dragging {
                cursor: grabbing !important;
            }

            .nav-dragging .nav-liquid-blob {
                transition: none !important;
            }

            /* ULTRA 3D Liquid Glass - Sürükleme Aktif */
            .nav-liquid-blob.drag-active {
                height: 56px;
                border-radius: 28px;
                /* Çok katmanlı cam efekti */
                background:
                    linear-gradient(135deg,
                        rgba(255, 255, 255, 0.9) 0%,
                        rgba(255, 255, 255, 0.4) 40%,
                        rgba(255, 255, 255, 0.2) 100%) !important;
                /* Çok katmanlı 3D gölge sistemi */
                box-shadow:
                    /* Dış glow */
                    0 0 80px rgba(99, 102, 241, 0.6),
                    0 0 120px rgba(139, 92, 246, 0.4),
                    /* Derinlik gölgesi */
                    0 20px 60px rgba(0, 0, 0, 0.3),
                    0 10px 30px rgba(99, 102, 241, 0.5),
                    /* İç highlight - üst */
                    inset 0 3px 6px rgba(255, 255, 255, 1),
                    inset 0 1px 2px rgba(255, 255, 255, 0.9),
                    /* İç gölge - alt */
                    inset 0 -4px 8px rgba(0, 0, 0, 0.15),
                    inset 0 -2px 4px rgba(99, 102, 241, 0.2) !important;
                /* Premium blur */
                backdrop-filter: blur(30px) saturate(200%) brightness(1.1);
                -webkit-backdrop-filter: blur(30px) saturate(200%) brightness(1.1);
                /* 3D Transform */
                transform: translateY(-50%) scale(1.15) perspective(600px) rotateX(8deg);
                /* Cam kenarı */
                border: 1px solid rgba(255, 255, 255, 0.5);
            }

            /* Dark Mode Ultra Glass */
            html.dark .nav-liquid-blob.drag-active {
                background:
                    linear-gradient(135deg,
                        rgba(255, 255, 255, 0.35) 0%,
                        rgba(255, 255, 255, 0.15) 40%,
                        rgba(255, 255, 255, 0.05) 100%) !important;
                box-shadow:
                    /* Neon dış glow */
                    0 0 100px rgba(129, 140, 248, 0.7),
                    0 0 150px rgba(167, 139, 250, 0.5),
                    0 0 200px rgba(99, 102, 241, 0.3),
                    /* Derinlik */
                    0 20px 60px rgba(0, 0, 0, 0.5),
                    0 10px 30px rgba(129, 140, 248, 0.4),
                    /* İç highlight */
                    inset 0 3px 6px rgba(255, 255, 255, 0.4),
                    inset 0 1px 2px rgba(255, 255, 255, 0.3),
                    /* İç gölge */
                    inset 0 -4px 8px rgba(0, 0, 0, 0.3),
                    inset 0 -2px 4px rgba(129, 140, 248, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            /* Nav Bar 3D Transform - Sürükleme Sırasında */
            .nav-dragging #main-nav {
                transform: perspective(1000px) rotateX(3deg) translateZ(10px);
                box-shadow:
                    0 -5px 50px rgba(0, 0, 0, 0.2),
                    0 25px 80px var(--accent-glow),
                    0 0 150px rgba(99, 102, 241, 0.3);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            /* Premium Üst Yansıma (Specular Highlight) */
            .nav-liquid-blob::before {
                content: '';
                position: absolute;
                top: 2px;
                left: 8%;
                right: 8%;
                height: 50%;
                background: linear-gradient(180deg,
                        rgba(255, 255, 255, 0.8) 0%,
                        rgba(255, 255, 255, 0.4) 30%,
                        rgba(255, 255, 255, 0) 100%);
                border-radius: 24px 24px 50% 50%;
                pointer-events: none;
                opacity: 0.9;
            }

            /* Alt Yansıma (Secondary Reflection) */
            .nav-liquid-blob::after {
                content: '';
                position: absolute;
                bottom: 3px;
                left: 15%;
                right: 15%;
                height: 20%;
                background: linear-gradient(0deg,
                        rgba(255, 255, 255, 0.3) 0%,
                        rgba(255, 255, 255, 0) 100%);
                border-radius: 50% 50% 20px 20px;
                pointer-events: none;
                opacity: 0.6;
            }

            html.dark .nav-liquid-blob::before {
                background: linear-gradient(180deg,
                        rgba(255, 255, 255, 0.4) 0%,
                        rgba(255, 255, 255, 0.15) 30%,
                        rgba(255, 255, 255, 0) 100%);
                opacity: 0.7;
            }

            html.dark .nav-liquid-blob::after {
                background: linear-gradient(0deg,
                        rgba(255, 255, 255, 0.15) 0%,
                        rgba(255, 255, 255, 0) 100%);
                opacity: 0.4;
            }

            /* Sürükleme sırasında ikonların opacity'si */
            .nav-dragging .nav-item:not(.active) {
                opacity: 0.5;
                transform: scale(0.95);
                transition: all 0.2s ease;
            }

            .nav-dragging .nav-item.active {
                opacity: 1;
                transform: scale(1.05);
            }

            .nav-liquid-blob.morphing {
                animation: liquid-morph 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .nav-liquid-blob.wobbling {
                animation: liquid-wobble 0.7s cubic-bezier(0.22, 1, 0.36, 1);
            }

            .nav-liquid-blob.settling {
                animation: liquid-settle 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            /* === 3D JELLY STRETCH EFFECT - Enhanced === */
            .nav-liquid-blob.stretch-right {
                border-radius: 18px 38px 38px 18px !important;
                transform: translateY(-50%) scaleX(1.15) scaleY(0.9) !important;
            }

            .nav-liquid-blob.stretch-left {
                border-radius: 38px 18px 18px 38px !important;
                transform: translateY(-50%) scaleX(1.15) scaleY(0.9) !important;
            }

            /* Organic deformation during fast movement */
            .nav-liquid-blob.fast-move {
                filter: blur(0.8px);
                opacity: 0.95;
            }

            /* Jelly bounce-back animation - Enhanced Spring */
            .nav-liquid-blob.bounce-back {
                transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
                animation: liquid-settle 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            }

            /* Premium 3D shadow during drag */
            .nav-dragging .nav-liquid-blob {
                box-shadow:
                    0 15px 60px rgba(99, 102, 241, 0.6),
                    0 0 100px rgba(139, 92, 246, 0.4),
                    0 25px 80px rgba(0, 0, 0, 0.3),
                    inset 0 3px 6px rgba(255, 255, 255, 0.5),
                    inset 0 -4px 8px rgba(0, 0, 0, 0.15) !important;
            }

            html.dark .nav-dragging .nav-liquid-blob {
                box-shadow:
                    0 15px 80px rgba(129, 140, 248, 0.7),
                    0 0 120px rgba(167, 139, 250, 0.5),
                    0 25px 80px rgba(0, 0, 0, 0.5),
                    inset 0 3px 6px rgba(255, 255, 255, 0.3),
                    inset 0 -4px 8px rgba(0, 0, 0, 0.3) !important;
            }

            /* Nav Icon Box Styling */
            .nav-icon-box {
                transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .nav-label {
                transition: all 0.3s ease;
            }

            /* === LIQUID GLASS BUTONLAR === */
            .btn-glass {
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                color: white;
                border: none;
                border-radius: 16px;
                padding: 12px 24px;
                font-weight: 700;
                cursor: pointer;
                position: relative;
                overflow: hidden;
                transition: var(--transition-smooth);
                box-shadow: 0 4px 15px var(--accent-glow);
            }

            .btn-glass::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                transition: left 0.5s ease;
            }

            .btn-glass:hover {
                transform: translateY(-2px) scale(1.02);
                box-shadow: 0 8px 25px var(--accent-glow);
            }

            .btn-glass:hover::before {
                left: 100%;
            }

            /* === SHIMMER ANİMASYONU === */
            @keyframes shimmer {
                0% {
                    background-position: -200% 0;
                }

                100% {
                    background-position: 200% 0;
                }
            }

            .shimmer {
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
                background-size: 200% 100%;
                animation: shimmer 2s infinite;
            }

            /* === PREMIUM MINI-BADGE SYSTEM === */
            /* Apple Award UI / Glassmorphism styled micro-badges */

            @keyframes miniBadgeIn {
                0% {
                    opacity: 0;
                    transform: translateY(4px) scale(0.9);
                }

                100% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            @keyframes miniBadgeShimmer {
                0% {
                    background-position: -100% 0;
                }

                100% {
                    background-position: 200% 0;
                }
            }

            .mini-badge {
                display: inline-flex;
                align-items: center;
                gap: 3px;
                padding: 2px 7px;
                font-size: 9px;
                font-weight: 700;
                line-height: 1.3;
                border-radius: 9999px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                /* Glassmorphism base */
                background: var(--glass-bg);
                backdrop-filter: blur(8px) saturate(120%);
                -webkit-backdrop-filter: blur(8px) saturate(120%);
                border: 1px solid var(--glass-border);
                color: var(--text-secondary);
                /* iOS artefakt önleme */
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                background-clip: padding-box;
                -webkit-background-clip: padding-box;
                /* Giriş animasyonu */
                animation: miniBadgeIn 0.3s ease-out forwards;
                /* Touch active state */
                transition: transform 0.15s ease, opacity 0.15s ease;
                pointer-events: none;
            }

            .mini-badge:active {
                transform: translateZ(0) scale(0.98);
            }

            /* PRO Badge - Gold/Amber Premium Style */
            .mini-badge--pro {
                background: linear-gradient(135deg,
                        rgba(251, 191, 36, 0.9) 0%,
                        rgba(245, 158, 11, 0.95) 50%,
                        rgba(217, 119, 6, 0.9) 100%);
                background-size: 200% 100%;
                color: #1c1917;
                border: 1px solid rgba(251, 191, 36, 0.6);
                box-shadow:
                    0 1px 3px rgba(245, 158, 11, 0.3),
                    0 0 8px rgba(251, 191, 36, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3);
                font-size: 8px;
                letter-spacing: 0.5px;
                animation: miniBadgeIn 0.3s ease-out forwards, miniBadgeShimmer 3s ease-in-out infinite 1s;
            }

            html.dark .mini-badge--pro {
                background: linear-gradient(135deg,
                        rgba(251, 191, 36, 0.85) 0%,
                        rgba(245, 158, 11, 0.9) 50%,
                        rgba(234, 88, 12, 0.85) 100%);
                color: #0c0a09;
                border-color: rgba(251, 191, 36, 0.5);
                box-shadow:
                    0 1px 4px rgba(245, 158, 11, 0.4),
                    0 0 12px rgba(251, 191, 36, 0.25);
            }

            /* Auto-positioned PRO badge (absolute) */
            .mini-badge--pro-auto {
                position: absolute !important;
                top: 4px !important;
                right: 4px !important;
                z-index: 10;
                pointer-events: none;
            }

            /* NOTE Badge - Soft muted style */
            .mini-badge--note {
                background: var(--glass-bg-subtle, rgba(255, 255, 255, 0.5));
                color: var(--text-muted);
                border: 1px solid rgba(0, 0, 0, 0.06);
                font-size: 10px;
                font-weight: 600;
                max-width: 180px;
                overflow: hidden;
                text-overflow: ellipsis;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            }

            html.dark .mini-badge--note {
                background: rgba(255, 255, 255, 0.06);
                border-color: rgba(255, 255, 255, 0.08);
                color: var(--text-light);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            }

            /* Light mode visibility enhancement */
            html:not(.dark) .mini-badge--pro {
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            }

            html:not(.dark) .mini-badge--note {
                background: rgba(0, 0, 0, 0.04);
                color: #64748b;
            }

            /* === PULSE GLOW === */
            @keyframes pulse-glow {

                0%,
                100% {
                    box-shadow: 0 0 20px var(--accent-glow);
                }

                50% {
                    box-shadow: 0 0 40px var(--accent-glow), 0 0 60px var(--accent-glow);
                }
            }

            .pulse-glow {
                animation: pulse-glow 3s ease-in-out infinite;
            }

            /* === PREMIUM CROWN ANİMASYONU === */
            @keyframes crownPulse {

                0%,
                100% {
                    transform: scale(1) rotate(0deg);
                    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
                }

                25% {
                    transform: scale(1.1) rotate(-5deg);
                    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.6);
                }

                50% {
                    transform: scale(1.15) rotate(0deg);
                    box-shadow: 0 6px 20px rgba(234, 88, 12, 0.7);
                }

                75% {
                    transform: scale(1.1) rotate(5deg);
                    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.6);
                }
            }

            /* === TİPOGRAFİ - DEVASA BAŞLIKLAR === */
            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                font-family: 'Inter', system-ui, -apple-system, sans-serif;
                font-weight: 800;
                letter-spacing: -0.03em;
                line-height: 1.1;
                color: var(--text-primary);
            }

            /* Devasa Başlık Sınıfları */
            .text-giant {
                font-size: clamp(3rem, 8vw, 5rem);
                font-weight: 900;
                letter-spacing: -0.04em;
            }

            .text-large {
                font-size: clamp(2rem, 5vw, 3rem);
                font-weight: 800;
            }

            /* === BENTO GRID LAYOUT === */
            .bento-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--gap-grid);
            }

            .bento-card {
                background: var(--bg-surface);
                border-radius: var(--card-radius);
                border: 1px solid var(--border-subtle);
                padding: 24px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .bento-card:hover {
                border-color: var(--border-accent);
                transform: translateY(-2px);
            }

            .bento-card-large {
                grid-column: span 2;
            }

            @media (max-width: 640px) {
                .bento-grid {
                    grid-template-columns: 1fr;
                }

                .bento-card-large {
                    grid-column: span 1;
                }
            }

            /* === 3D WALLET KART EFEKTLERİ === */
            .perspective-1000 {
                perspective: 1000px;
            }

            .preserve-3d {
                transform-style: preserve-3d;
            }

            .wallet-3d-card {
                transform-style: preserve-3d;
                transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
            }

            .wallet-3d-card:hover {
                box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.4);
            }

            /* Kart Shine Efekti */
            .wallet-3d-card::before {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(105deg,
                        transparent 40%,
                        rgba(255, 255, 255, 0.1) 45%,
                        rgba(255, 255, 255, 0.15) 50%,
                        rgba(255, 255, 255, 0.1) 55%,
                        transparent 60%);
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
                border-radius: inherit;
            }

            .wallet-3d-card:hover::before {
                opacity: 1;
            }

            /* === FADE-IN ANİMASYONU (AURORA YERİNE) === */
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .animate-fadeIn {
                animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            }

            .animate-fadeIn-delay-1 {
                animation-delay: 0.1s;
                opacity: 0;
            }

            .animate-fadeIn-delay-2 {
                animation-delay: 0.2s;
                opacity: 0;
            }

            .animate-fadeIn-delay-3 {
                animation-delay: 0.3s;
                opacity: 0;
            }

            .animate-fadeIn-delay-4 {
                animation-delay: 0.4s;
                opacity: 0;
            }

            /* === GLASS PANEL - DEEP DARK VERSİYON === */
            .glass-panel {
                background: var(--bg-surface);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid var(--border-subtle);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            }

            /* === PROFILE MODAL SECTION CARDS === */
            .profile-section {
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                border-radius: 20px;
                padding: 16px;
            }

            html.dark .profile-section {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .profile-section-title {
                font-size: 11px;
                letter-spacing: 0.12em;
                text-transform: uppercase;
                opacity: 0.85;
                margin-bottom: 12px;
                font-weight: 700;
                color: var(--text-muted);
            }

            html.dark .profile-section-title {
                color: #94a3b8;
            }

            .profile-help {
                font-size: 11px;
                opacity: 0.65;
                margin-top: 10px;
                line-height: 1.4;
                color: var(--text-muted);
            }

            .profile-action-btn {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                padding: 14px 16px;
                border-radius: 16px;
                font-weight: 600;
                font-size: 14px;
                transition: all 0.2s ease;
                background: var(--glass-bg);
                border: 1px solid transparent;
            }

            .profile-action-btn:hover {
                background: var(--glass-bg-strong);
                border-color: var(--glass-border);
            }

            html.dark .profile-action-btn {
                background: rgba(255, 255, 255, 0.05);
            }

            html.dark .profile-action-btn:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .glass-card {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                border-radius: var(--card-radius);
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            }

            html.dark .glass-panel {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            }

            html.dark .glass-card {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            }

            /* Fixed Navigation Glass Style - Enhanced Frosted Glass */
            .glass-card-strong {
                background: rgba(255, 255, 255, 0.45);
                /* More translucent for visible blur effect */
                backdrop-filter: blur(32px) saturate(200%) brightness(1.05);
                -webkit-backdrop-filter: blur(32px) saturate(200%) brightness(1.05);
                border: 1px solid rgba(255, 255, 255, 0.5);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.6);
            }

            html.dark .glass-card-strong {
                background: rgba(15, 23, 42, 0.45);
                backdrop-filter: blur(32px) saturate(180%) brightness(0.95);
                -webkit-backdrop-filter: blur(32px) saturate(180%) brightness(0.95);
                border: 1px solid rgba(255, 255, 255, 0.12);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.08);
            }

            /* === MODERN INPUT - MONOKROM === */
            .modern-input {
                background: var(--bg-elevated);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid var(--border-subtle);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                color: var(--text-primary);
                border-radius: 16px;
            }

            .modern-input:focus {
                background: var(--bg-elevated);
                box-shadow: 0 0 0 2px var(--accent-dim);
                border-color: var(--accent);
                outline: none;
            }

            .modern-input::placeholder {
                color: var(--text-muted);
            }

            html.dark .modern-input {
                background: var(--bg-elevated);
                color: var(--text-primary);
                border-color: var(--border-subtle);
            }

            html.dark .modern-input:focus {
                background: var(--bg-elevated);
                border-color: var(--accent);
            }

            html.dark select option {
                background-color: #1f2937;
                color: #f3f4f6;
            }

            html.dark select {
                background-color: transparent;
            }

            html.dark #input-currency {
                background-color: transparent !important;
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                outline: none !important;
            }

            html.dark #input-currency option {
                background-color: #374151;
                color: #f9fafb;
            }

            /* === SCROLLBAR - MİNİMAL === */
            .custom-scroll::-webkit-scrollbar {
                width: 4px;
            }

            .custom-scroll::-webkit-scrollbar-track {
                background: transparent;
            }

            .custom-scroll::-webkit-scrollbar-thumb {
                background: var(--text-muted);
                border-radius: 4px;
            }

            html.dark .custom-scroll::-webkit-scrollbar-thumb {
                background: #333;
            }

            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }

            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            /* --- Premium Subcategory Chips Rail --- */
            #sub-category-chips.subchip-rail {
                display: flex;
                align-items: center;
                gap: 10px;

                /* yerleşim */
                padding: 10px 12px;
                margin-top: 10px;

                /* premium rail */
                border-radius: 18px;
                background: rgba(255, 255, 255, .58);
                border: 1px solid rgba(0, 0, 0, .06);
                backdrop-filter: blur(14px);
                -webkit-backdrop-filter: blur(14px);
                box-shadow: 0 14px 40px rgba(0, 0, 0, .08);

                /* scroll */
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
                scroll-padding-left: 12px;
            }

            /* rail kenarlarda soft fade */
            #sub-category-chips.subchip-rail::before,
            #sub-category-chips.subchip-rail::after {
                content: "";
                position: sticky;
                top: 0;
                width: 26px;
                height: 100%;
                pointer-events: none;
                flex: 0 0 auto;
                z-index: 2;
            }

            #sub-category-chips.subchip-rail::before {
                left: 0;
                background: linear-gradient(90deg, rgba(255, 255, 255, .85), rgba(255, 255, 255, 0));
            }

            #sub-category-chips.subchip-rail::after {
                right: 0;
                background: linear-gradient(270deg, rgba(255, 255, 255, .85), rgba(255, 255, 255, 0));
            }

            /* dark mode rail */
            html.dark #sub-category-chips.subchip-rail {
                background: rgba(2, 6, 23, .35);
                border: 1px solid rgba(148, 163, 184, .18);
                box-shadow: 0 18px 60px rgba(0, 0, 0, .55);
            }

            html.dark #sub-category-chips.subchip-rail::before {
                background: linear-gradient(90deg, rgba(2, 6, 23, .92), rgba(2, 6, 23, 0));
            }

            html.dark #sub-category-chips.subchip-rail::after {
                background: linear-gradient(270deg, rgba(2, 6, 23, .92), rgba(2, 6, 23, 0));
            }

            /* --- Chip Button --- */
            .subchip {
                flex: 0 0 auto;
                scroll-snap-align: start;

                padding: 9px 14px;
                border-radius: 999px;

                font-size: 12px;
                font-weight: 800;
                letter-spacing: .2px;

                background: rgba(255, 255, 255, .70);
                border: 1px solid rgba(0, 0, 0, .06);
                color: rgba(17, 24, 39, .78);

                box-shadow: 0 10px 22px rgba(0, 0, 0, .08);
                transform: translateZ(0);
                transition: transform .16s ease, box-shadow .16s ease, background .16s ease, color .16s ease, border-color .16s ease;
            }

            .subchip:active {
                transform: scale(.97);
            }

            .subchip:hover {
                box-shadow: 0 14px 26px rgba(0, 0, 0, .12);
            }

            html.dark .subchip {
                background: rgba(2, 6, 23, .40);
                border: 1px solid rgba(148, 163, 184, .22);
                color: rgba(226, 232, 240, .86);
                box-shadow: 0 16px 40px rgba(0, 0, 0, .55);
            }

            /* Active state: premium gradient + glow */
            .subchip.is-active {
                color: #fff;
                background: linear-gradient(135deg, rgba(99, 102, 241, 1), rgba(168, 85, 247, 1));
                border-color: rgba(255, 255, 255, .20);
                box-shadow: 0 18px 44px rgba(99, 102, 241, .28);
            }

            html.dark .subchip.is-active {
                background: linear-gradient(135deg, rgba(79, 70, 229, 1), rgba(168, 85, 247, 1));
                box-shadow: 0 20px 60px rgba(168, 85, 247, .22);
            }

            /* === NAVİGASYON - DEEp DARK === */
            .nav-blob {
                position: absolute;
                top: 50%;
                left: 0;
                width: 52px;
                height: 52px;
                background: var(--accent-dim);
                border-radius: 26px;
                filter: blur(12px);
                opacity: 0;
                z-index: 0;
                pointer-events: none;
                transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            }

            html.dark .nav-blob {
                background: var(--accent-dim);
                filter: blur(14px);
            }

            .nav-item.active svg {
                animation: jelly 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                stroke: var(--accent);
                stroke-width: 2.5px;
                filter: drop-shadow(0 0 8px var(--accent-dim));
            }

            html.dark .nav-item.active svg {
                stroke: var(--accent);
            }

            @keyframes jelly {
                0% {
                    transform: scale(1);
                }

                30% {
                    transform: scale(1.25) translateY(-2px);
                }

                40% {
                    transform: scale(0.75) translateY(2px);
                }

                50% {
                    transform: scale(1.15) translateY(-1px);
                }

                65% {
                    transform: scale(0.95) translateY(1px);
                }

                75% {
                    transform: scale(1.05);
                }

                100% {
                    transform: scale(1);
                }
            }

            /* === EKRAN GEÇİŞ EFEKTİ === */
            .screen-transition {
                animation: slideFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
                will-change: transform, opacity;
                backface-visibility: hidden;
            }

            @keyframes slideFade {
                0% {
                    opacity: 0;
                    transform: translateY(20px) scale(0.98);
                }

                100% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            /* === PROSE STİLLERİ === */
            .prose p {
                margin-bottom: 0.6em;
                font-size: 0.95rem;
                line-height: 1.6;
                color: var(--text-secondary);
            }

            .prose ul {
                list-style-type: disc;
                padding-left: 1.2em;
                margin-bottom: 0.6em;
            }

            .prose strong {
                color: var(--accent);
                font-weight: 700;
            }

            html.dark .prose strong {
                color: var(--accent);
            }

            /* === TEMA SEÇİM MODALI === */
            .theme-option.selected {
                border-color: var(--accent);
                background-color: var(--accent-dim);
                box-shadow: 0 0 15px var(--accent-dim);
            }

            html.dark .theme-option.selected {
                border-color: var(--accent);
                background-color: var(--accent-dim);
            }

            /* === AVATAR SEÇİMİ === */
            .avatar-option {
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                overflow: hidden;
                padding: 0;
                border: 2px solid transparent;
                background: var(--bg-elevated);
            }

            .avatar-option:hover {
                transform: scale(1.15);
                border-color: var(--border-subtle);
            }

            .avatar-option.selected {
                transform: scale(1.2);
                border-color: var(--accent);
                box-shadow: 0 4px 12px var(--accent-dim);
            }

            html.dark .avatar-option {
                background: var(--bg-elevated);
            }

            /* === PREMIUM 3D AVATAR STİLLERİ === */
            .premium-avatar-img {
                filter: drop-shadow(0 8px 12px rgba(0, 0, 0, 0.25));
                transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }

            .premium-avatar-img:hover {
                transform: scale(1.12) translateY(-4px);
                filter: drop-shadow(0 14px 20px rgba(0, 0, 0, 0.35));
            }

            /* Seçili avatar için Premium Gold Glow */
            .avatar-selected-glow {
                animation: premiumGlow 2s ease-in-out infinite alternate;
                box-shadow:
                    0 0 0 3px rgba(245, 158, 11, 0.4),
                    0 0 20px 4px rgba(245, 158, 11, 0.3),
                    0 8px 25px rgba(0, 0, 0, 0.25);
            }

            /* Premium badge için Neon Blue Glow */
            .avatar-premium-glow {
                position: relative;
            }

            .avatar-premium-glow::after {
                content: '👑';
                position: absolute;
                bottom: -6px;
                right: -6px;
                font-size: 14px;
                filter: drop-shadow(0 0 4px rgba(99, 102, 241, 0.8));
                animation: crownBounce 1.5s ease-in-out infinite;
                z-index: 30;
            }

            @keyframes premiumGlow {
                0% {
                    box-shadow:
                        0 0 0 3px rgba(245, 158, 11, 0.4),
                        0 0 15px 3px rgba(245, 158, 11, 0.25),
                        0 6px 20px rgba(0, 0, 0, 0.2);
                }

                100% {
                    box-shadow:
                        0 0 0 3px rgba(245, 158, 11, 0.6),
                        0 0 25px 6px rgba(245, 158, 11, 0.4),
                        0 10px 30px rgba(0, 0, 0, 0.3);
                }
            }

            @keyframes crownBounce {

                0%,
                100% {
                    transform: translateY(0) rotate(0deg);
                }

                50% {
                    transform: translateY(-3px) rotate(5deg);
                }
            }

            /* Dark mode için daha parlak glow */
            html.dark .avatar-selected-glow {
                box-shadow:
                    0 0 0 3px rgba(99, 102, 241, 0.5),
                    0 0 25px 6px rgba(99, 102, 241, 0.4),
                    0 8px 25px rgba(0, 0, 0, 0.4);
                animation: premiumGlowDark 2s ease-in-out infinite alternate;
            }

            @keyframes premiumGlowDark {
                0% {
                    box-shadow:
                        0 0 0 3px rgba(99, 102, 241, 0.5),
                        0 0 20px 4px rgba(99, 102, 241, 0.35),
                        0 6px 20px rgba(0, 0, 0, 0.35);
                }

                100% {
                    box-shadow:
                        0 0 0 3px rgba(139, 92, 246, 0.7),
                        0 0 30px 8px rgba(139, 92, 246, 0.5),
                        0 10px 30px rgba(0, 0, 0, 0.45);
                }
            }

            /* === TRUE 3D POP-OUT AVATAR EFEKTİ === */
            /* Container-Mask Yapısı: Alt kısım daire içinde, üst kısım dışarı taşıyor */

            /* Ana Wrapper - overflow: visible ile taşmaya izin */
            .avatar-pop-wrapper {
                position: relative;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: flex-end;
                justify-content: center;
                /* Taşmaya izin ver */
                overflow: visible;
            }

            /* Arka Plan Dairesi - Pseudo element olarak */
            .avatar-pop-wrapper::before {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                background: linear-gradient(135deg,
                        rgba(99, 102, 241, 0.15) 0%,
                        rgba(168, 85, 247, 0.25) 100%);
                z-index: 0;
                pointer-events: none;
            }

            /* Alt Maske Katmanı - Avatarın alt kısmını kesen yarım daire */
            .avatar-bottom-mask {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 55%;
                /* Dairenin alt yarısı */
                border-radius: 0 0 9999px 9999px;
                /* Sadece alt kısım yuvarlak */
                overflow: hidden;
                z-index: 1;
            }

            /* Alt maskedeki avatar kopyası (alt gövde) */
            .avatar-bottom-mask .avatar-pop-img-bottom {
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 88%;
                height: auto;
                object-fit: contain;
                pointer-events: none;
            }

            /* Üst Kısım - Dışarı taşan avatar (baş ve omuzlar) */
            .avatar-pop-img {
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 88%;
                height: auto;
                max-width: none;
                object-fit: contain;
                filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.35)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
                z-index: 2;
                pointer-events: none;
                transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            /* Hover'da yukarı çıksın ve gölge artsın */
            .header-avatar-wrap:hover .avatar-pop-img {
                transform: translateX(-50%) translateY(-6px) scale(1.05);
                filter: drop-shadow(0 14px 24px rgba(0, 0, 0, 0.4)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.25));
            }

            /* Premium glow ring efekti */
            .avatar-pop-wrapper::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: -3px;
                right: -3px;
                width: calc(100% + 6px);
                height: calc(100% + 6px);
                border-radius: 50%;
                background: linear-gradient(135deg,
                        rgba(99, 102, 241, 0.4) 0%,
                        rgba(168, 85, 247, 0.4) 50%,
                        rgba(236, 72, 153, 0.3) 100%);
                z-index: -1;
                opacity: 0;
                transition: opacity 0.3s ease;
                filter: blur(4px);
            }

            .header-avatar-wrap:hover .avatar-pop-wrapper::after {
                opacity: 1;
            }

            /* Fallback: Resim yoksa harf göster */
            .avatar-pop-fallback {
                font-size: 1.25rem;
                font-weight: 700;
                color: white;
                z-index: 1;
            }

            /* === CHAT STİLLERİ === */
            .chat-container-bg {
                background-image: radial-gradient(var(--text-muted) 1px, transparent 1px);
                background-size: 24px 24px;
                opacity: 0.03;
            }

            html.dark .chat-container-bg {
                background-image: radial-gradient(var(--text-muted) 1px, transparent 1px);
                opacity: 0.05;
            }

            .chat-bubble {
                max-width: 85%;
                padding: 16px 20px;
                border-radius: 20px;
                font-size: 0.95rem;
                line-height: 1.6;
                position: relative;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                animation: fadeInUp 0.4s ease-out forwards;
            }

            .chat-bubble.user {
                background: var(--accent);
                color: #000;
                border-bottom-right-radius: 4px;
                margin-left: auto;
            }

            .chat-bubble.ai {
                background: var(--bg-surface);
                color: var(--text-primary);
                border-bottom-left-radius: 4px;
                margin-right: auto;
                border: 1px solid var(--border-subtle);
            }

            html.dark .chat-bubble.ai {
                background: var(--bg-surface);
                color: var(--text-primary);
                border-color: var(--border-subtle);
            }

            /* === CHAT ÖNERİ KARTLARI === */
            .chat-suggestion-card {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border: 1px solid var(--border-subtle);
                background: var(--bg-surface);
            }

            .chat-suggestion-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                border-color: var(--border-accent);
            }

            /* === BOŞ DURUM === */
            .empty-state-icon {
                font-size: 3rem;
                margin-bottom: 1rem;
                opacity: 0.3;
                filter: grayscale(100%);
                transition: all 0.3s ease;
            }

            .empty-state:hover .empty-state-icon {
                opacity: 0.6;
                filter: grayscale(0%);
                transform: scale(1.1);
            }

            /* === TAB STİLLERİ === */
            .tab-btn.active {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                background: var(--bg-elevated);
                color: var(--accent);
                transform: translateY(-2px);
            }

            html.dark .tab-btn.active {
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
                background: var(--bg-elevated);
                color: var(--accent);
            }

            /* === PREMIUM TOAST NOTIFICATION SYSTEM === */
            :root {
                --toast-glass-bg: rgba(255, 255, 255, 0.92);
                --toast-glass-border: rgba(255, 255, 255, 0.5);
                --toast-glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
                --toast-text-primary: #1f2937;
                --toast-text-secondary: #6b7280;
                --toast-success: #10b981;
                --toast-error: #ef4444;
                --toast-warning: #f59e0b;
                --toast-info: #6366f1;
            }

            html.dark {
                --toast-glass-bg: rgba(30, 32, 48, 0.92);
                --toast-glass-border: rgba(255, 255, 255, 0.08);
                --toast-glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
                --toast-text-primary: #f3f4f6;
                --toast-text-secondary: #9ca3af;
            }

            /* Toast Container */
            .toast-shell {
                position: fixed;
                top: 1.5rem;
                right: 1.5rem;
                z-index: 10050;
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                pointer-events: none;
                max-width: min(380px, 92vw);
                padding-top: env(safe-area-inset-top, 0px);
            }

            @media (max-width: 640px) {
                .toast-shell {
                    top: auto;
                    right: auto;
                    bottom: calc(env(safe-area-inset-bottom, 0px) + 84px);
                    left: 50%;
                    transform: translateX(-50%);
                    max-width: min(92vw, 420px);
                }
            }

            /* Toast Card */
            .toast {
                pointer-events: auto;
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
                padding: 0.875rem 1rem;
                background: var(--toast-glass-bg);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border: 1px solid var(--toast-glass-border);
                border-radius: 1rem;
                box-shadow: var(--toast-glass-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                position: relative;
                overflow: hidden;
                min-width: 280px;
                max-width: 100%;
                cursor: grab;
                touch-action: pan-x;
                will-change: transform, opacity;
            }

            .toast:active {
                cursor: grabbing;
            }

            /* Accent stripe (sol kenar) */
            .toast::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                background: var(--toast-accent, var(--toast-info));
                border-radius: 4px 0 0 4px;
            }

            .toast--success {
                --toast-accent: var(--toast-success);
            }

            .toast--error {
                --toast-accent: var(--toast-error);
            }

            .toast--warning {
                --toast-accent: var(--toast-warning);
            }

            .toast--info {
                --toast-accent: var(--toast-info);
            }

            /* Icon */
            .toast__icon {
                flex-shrink: 0;
                width: 1.5rem;
                height: 1.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-left: 0.25rem;
            }

            .toast__icon svg {
                width: 100%;
                height: 100%;
            }

            .toast--success .toast__icon {
                color: var(--toast-success);
            }

            .toast--error .toast__icon {
                color: var(--toast-error);
            }

            .toast--warning .toast__icon {
                color: var(--toast-warning);
            }

            .toast--info .toast__icon {
                color: var(--toast-info);
            }

            /* Content */
            .toast__content {
                flex: 1;
                min-width: 0;
                padding-right: 0.5rem;
            }

            .toast__title {
                font-weight: 600;
                font-size: 0.875rem;
                line-height: 1.3;
                color: var(--toast-text-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .toast__msg {
                font-size: 0.8125rem;
                line-height: 1.4;
                color: var(--toast-text-secondary);
                margin-top: 0.125rem;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            /* Close Button */
            .toast__close {
                flex-shrink: 0;
                width: 1.75rem;
                height: 1.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 0.5rem;
                background: transparent;
                border: none;
                color: var(--toast-text-secondary);
                cursor: pointer;
                transition: background 0.15s, color 0.15s;
                font-size: 1rem;
                line-height: 1;
            }

            .toast__close:hover {
                background: rgba(0, 0, 0, 0.08);
                color: var(--toast-text-primary);
            }

            html.dark .toast__close:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            /* Progress Bar */
            .toast__progress {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: rgba(0, 0, 0, 0.06);
                overflow: hidden;
            }

            html.dark .toast__progress {
                background: rgba(255, 255, 255, 0.08);
            }

            .toast__progress-bar {
                height: 100%;
                background: var(--toast-accent, var(--toast-info));
                width: 100%;
                transform-origin: left;
                animation: toastProgressShrink var(--toast-duration, 3000ms) linear forwards;
            }

            /* Animations */
            @keyframes toastSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(16px) scale(0.96);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            @keyframes toastSlideOut {
                from {
                    opacity: 1;
                    transform: translateX(0) scale(1);
                    filter: blur(0);
                }

                to {
                    opacity: 0;
                    transform: translateX(80px) scale(0.95);
                    filter: blur(4px);
                }
            }

            @keyframes toastSwipeOut {
                to {
                    opacity: 0;
                    transform: translateX(var(--swipe-dir, 1) * 120%) scale(0.9);
                }
            }

            @keyframes toastProgressShrink {
                from {
                    transform: scaleX(1);
                }

                to {
                    transform: scaleX(0);
                }
            }

            .toast--entering {
                animation: toastSlideIn 0.35s cubic-bezier(0.21, 1.02, 0.73, 1) forwards;
            }

            .toast--leaving {
                animation: toastSlideOut 0.28s cubic-bezier(0.06, 0.71, 0.55, 1) forwards;
            }

            .toast--swiping {
                transition: none !important;
                animation: none !important;
            }

            .toast--swipe-out {
                animation: toastSwipeOut 0.25s ease-out forwards;
            }

            /* Reduced Motion */
            @media (prefers-reduced-motion: reduce) {
                .toast--entering {
                    animation: none;
                    opacity: 1;
                    transform: none;
                }

                .toast--leaving {
                    animation: none;
                    opacity: 0;
                }

                .toast__progress-bar {
                    animation: none;
                    transform: scaleX(0);
                }
            }

            /* Mobile adjustments */
            @media (max-width: 640px) {
                @keyframes toastSlideIn {
                    from {
                        opacity: 0;
                        transform: translateY(20px) scale(0.96);
                    }

                    to {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }

                @keyframes toastSlideOut {
                    from {
                        opacity: 1;
                        transform: translateY(0);
                    }

                    to {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                }
            }

            /* === CELEBRATION MODAL === */
            .celebration-modal {
                transition: opacity 0.2s ease, transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                transform: scale(0.95);
                opacity: 0;
                pointer-events: none;
            }

            .celebration-modal.visible {
                transform: scale(1);
                opacity: 1;
                pointer-events: auto;
            }

            /* === APPLE AWARD-WINNING SPLASH SCREEN === */
            #splash-screen {
                position: fixed;
                inset: 0;
                z-index: 99999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
                transition: opacity 0.8s ease, visibility 0.8s ease;
                overflow: hidden;
            }

            /* Premium Aurora Background */
            #splash-screen::before {
                content: '';
                position: absolute;
                inset: 0;
                background:
                    radial-gradient(ellipse 80% 50% at 20% 40%, rgba(120, 119, 198, 0.3), transparent 50%),
                    radial-gradient(ellipse 60% 40% at 80% 60%, rgba(255, 119, 198, 0.25), transparent 45%),
                    radial-gradient(ellipse 50% 80% at 50% 100%, rgba(120, 200, 255, 0.2), transparent 40%);
                animation: splash-aurora 8s ease-in-out infinite alternate;
                pointer-events: none;
            }

            html.dark #splash-screen::before {
                background:
                    radial-gradient(ellipse 80% 50% at 20% 40%, rgba(99, 102, 241, 0.4), transparent 50%),
                    radial-gradient(ellipse 60% 40% at 80% 60%, rgba(168, 85, 247, 0.35), transparent 45%),
                    radial-gradient(ellipse 50% 80% at 50% 100%, rgba(59, 130, 246, 0.25), transparent 40%);
            }

            @keyframes splash-aurora {
                0% {
                    opacity: 0.6;
                    transform: scale(1) rotate(0deg);
                }

                100% {
                    opacity: 1;
                    transform: scale(1.1) rotate(3deg);
                }
            }

            #splash-screen.hide {
                opacity: 0;
                visibility: hidden;
            }

            /* Premium Floating Orbs */
            .splash-orb {
                position: absolute;
                border-radius: 50%;
                filter: blur(60px);
                pointer-events: none;
                mix-blend-mode: screen;
            }

            html.dark .splash-orb {
                mix-blend-mode: lighten;
            }

            .splash-orb-1 {
                width: 350px;
                height: 350px;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.6), rgba(168, 85, 247, 0.4));
                top: -120px;
                right: -100px;
                animation: splash-float-1 10s ease-in-out infinite;
            }

            .splash-orb-2 {
                width: 280px;
                height: 280px;
                background: linear-gradient(135deg, rgba(236, 72, 153, 0.5), rgba(251, 146, 60, 0.3));
                bottom: -100px;
                left: -80px;
                animation: splash-float-2 12s ease-in-out infinite;
            }

            .splash-orb-3 {
                width: 220px;
                height: 220px;
                background: linear-gradient(135deg, rgba(52, 211, 153, 0.4), rgba(59, 130, 246, 0.3));
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                animation: splash-float-3 8s ease-in-out infinite;
            }

            @keyframes splash-float-1 {

                0%,
                100% {
                    transform: translate(0, 0) scale(1);
                    opacity: 0.5;
                }

                50% {
                    transform: translate(-40px, 50px) scale(1.2);
                    opacity: 0.8;
                }
            }

            @keyframes splash-float-2 {

                0%,
                100% {
                    transform: translate(0, 0) scale(1);
                    opacity: 0.4;
                }

                50% {
                    transform: translate(50px, -40px) scale(1.15);
                    opacity: 0.7;
                }
            }

            @keyframes splash-float-3 {

                0%,
                100% {
                    transform: translate(-50%, -50%) scale(1);
                    opacity: 0.3;
                }

                50% {
                    transform: translate(-50%, -60%) scale(1.3);
                    opacity: 0.5;
                }
            }

            /* Logo Container with 3D Float */
            .splash-logo-container {
                position: relative;
                display: flex;
                flex-direction: column;
                align-items: center;
                z-index: 10;
                animation: splash-container-float 6s ease-in-out infinite;
            }

            @keyframes splash-container-float {

                0%,
                100% {
                    transform: translateY(0);
                }

                50% {
                    transform: translateY(-12px);
                }
            }

            /* Premium Logo Icon with Rings */
            .splash-logo-icon {
                width: 150px;
                height: 150px;
                border-radius: 42px;
                background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.8));
                backdrop-filter: blur(30px);
                -webkit-backdrop-filter: blur(30px);
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 32px;
                position: relative;
                overflow: visible;
                box-shadow:
                    0 25px 60px rgba(99, 102, 241, 0.3),
                    0 10px 30px rgba(0, 0, 0, 0.1),
                    inset 0 -2px 6px rgba(0, 0, 0, 0.05),
                    inset 0 2px 0 rgba(255, 255, 255, 0.8);
                border: 2px solid rgba(255, 255, 255, 0.6);
                animation: splash-logo-entrance 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
                opacity: 0;
                transform: scale(0.5) translateY(40px);
            }

            html.dark .splash-logo-icon {
                background: linear-gradient(145deg, rgba(30, 30, 40, 0.9), rgba(20, 20, 30, 0.8));
                border: 2px solid rgba(255, 255, 255, 0.15);
                box-shadow:
                    0 30px 80px rgba(99, 102, 241, 0.4),
                    0 10px 40px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            @keyframes splash-logo-entrance {
                0% {
                    opacity: 0;
                    transform: scale(0.5) translateY(40px);
                }

                100% {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }

            /* Rotating Glow Ring */
            .splash-logo-icon::before {
                content: '';
                position: absolute;
                inset: -8px;
                border-radius: 50px;
                background: conic-gradient(from 0deg,
                        transparent,
                        rgba(99, 102, 241, 0.4),
                        rgba(168, 85, 247, 0.4),
                        rgba(236, 72, 153, 0.4),
                        transparent);
                animation: splash-ring-rotate 4s linear infinite;
                opacity: 0.5;
                filter: blur(10px);
            }

            html.dark .splash-logo-icon::before {
                background: conic-gradient(from 0deg,
                        transparent,
                        rgba(99, 102, 241, 0.25),
                        rgba(168, 85, 247, 0.25),
                        rgba(236, 72, 153, 0.25),
                        transparent);
                opacity: 0.4;
                filter: blur(15px);
            }


            @keyframes splash-ring-rotate {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            /* Outer Pulse Ring */
            .splash-logo-icon::after {
                content: '';
                position: absolute;
                inset: -20px;
                border-radius: 60px;
                border: 2px solid rgba(99, 102, 241, 0.3);
                animation: splash-pulse-ring 2s ease-in-out infinite;
            }

            @keyframes splash-pulse-ring {

                0%,
                100% {
                    transform: scale(0.95);
                    opacity: 0.5;
                }

                50% {
                    transform: scale(1.05);
                    opacity: 0.2;
                }
            }

            .splash-logo-icon img {
                width: 85%;
                height: 85%;
                border-radius: 32px;
                object-fit: cover;
                position: relative;
                z-index: 2;
            }

            .splash-logo-icon .icon-text {
                font-size: 3rem;
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                font-weight: 900;
                position: relative;
                z-index: 2;
            }

            /* Premium App Name with Animated Gradient */
            .splash-app-name {
                font-size: 3.2rem;
                font-weight: 900;
                background: linear-gradient(135deg,
                        #667eea 0%,
                        #a855f7 25%,
                        #ec4899 50%,
                        #a855f7 75%,
                        #667eea 100%);
                background-size: 300% 300%;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                letter-spacing: -0.04em;
                margin-bottom: 12px;
                line-height: 1.1;
                text-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
                animation:
                    splash-name-entrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s forwards,
                    splash-gradient-shift 6s ease-in-out infinite 1s;
                opacity: 0;
                transform: translateY(20px);
            }

            @keyframes splash-name-entrance {
                0% {
                    opacity: 0;
                    transform: translateY(20px);
                }

                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes splash-gradient-shift {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            /* Premium Tagline */
            .splash-tagline {
                font-size: 0.85rem;
                color: var(--text-muted);
                font-weight: 600;
                letter-spacing: 0.25em;
                text-transform: uppercase;
                opacity: 0;
                animation: splash-fade-up 0.6s ease 0.4s forwards;
                position: relative;
            }

            .splash-tagline::before,
            .splash-tagline::after {
                content: '—';
                margin: 0 12px;
                opacity: 0.4;
            }

            @keyframes splash-fade-up {
                0% {
                    opacity: 0;
                    transform: translateY(15px);
                }

                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Premium Ring Loader */
            .splash-loader {
                position: absolute;
                bottom: 100px;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                animation: splash-fade-up 0.6s ease 0.6s forwards;
            }

            .splash-loader-dot {
                width: 6px;
                height: 6px;
                margin: 0 4px;
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                border-radius: 50%;
                animation: splash-dot-pulse 1.2s ease-in-out infinite;
            }

            .splash-loader-dot:nth-child(1) {
                animation-delay: 0s;
            }

            .splash-loader-dot:nth-child(2) {
                animation-delay: 0.15s;
            }

            .splash-loader-dot:nth-child(3) {
                animation-delay: 0.3s;
            }

            @keyframes splash-dot-pulse {

                0%,
                80%,
                100% {
                    transform: scale(0.8);
                    opacity: 0.4;
                }

                40% {
                    transform: scale(1.4);
                    opacity: 1;
                }
            }

            /* Shimmer Effect */
            .splash-shimmer {
                position: absolute;
                top: 0;
                left: -150%;
                width: 150%;
                height: 100%;
                background: linear-gradient(90deg,
                        transparent 0%,
                        rgba(255, 255, 255, 0.25) 50%,
                        transparent 100%);
                animation: splash-shimmer-sweep 3s ease-in-out infinite;
                transform: skewX(-20deg);
                z-index: 3;
                filter: blur(4px);
            }

            html.dark .splash-shimmer {
                background: linear-gradient(90deg,
                        transparent 0%,
                        rgba(255, 255, 255, 0.06) 50%,
                        transparent 100%);
                filter: blur(8px);
            }

            @keyframes splash-shimmer-sweep {
                0% {
                    left: -150%;
                }

                50%,
                100% {
                    left: 150%;
                }
            }

            /* Premium Version Tag */
            .splash-version {
                position: absolute;
                bottom: 50px;
                font-size: 0.7rem;
                color: var(--text-light);
                font-weight: 600;
                letter-spacing: 0.15em;
                text-transform: uppercase;
                opacity: 0;
                animation: splash-fade-up 0.6s ease 0.8s forwards;
                padding: 6px 16px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border-radius: 20px;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            html.dark .splash-version {
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }


            /* === PREMIUM 3D WIDGET STYLES === */
            .widget-3d-container {
                perspective: 1000px;
                /* 3D derinlik algısı */
            }

            .widget-card-apple {
                position: relative;
                overflow: hidden;
                border-radius: 28px;
                /* Apple tarzı geniş yuvarlatma */
                background: var(--glass-bg);
                /* Mevcut temanızdaki değişken */
                backdrop-filter: blur(25px) saturate(120%);
                -webkit-backdrop-filter: blur(25px) saturate(120%);
                border: 1px solid rgba(255, 255, 255, 0.4);
                box-shadow:
                    0 15px 35px rgba(0, 0, 0, 0.05),
                    0 5px 15px rgba(0, 0, 0, 0.03),
                    inset 0 1px 0 rgba(255, 255, 255, 0.6);
                transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                /* Apple 'spring' efekti */
                transform-style: preserve-3d;
                /* Ensure proper clipping with 3D transforms */
                isolation: isolate;
            }

            html.dark .widget-card-apple {
                background: rgba(30, 30, 35, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow:
                    0 20px 40px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            /* Hover Efekti - Kart yukarı kalkar ve parlar */
            .widget-card-apple:hover {
                transform: translateY(-6px) scale(1.01);
                box-shadow:
                    0 25px 50px rgba(0, 0, 0, 0.1),
                    0 10px 20px rgba(99, 102, 241, 0.15);
                /* Hafif indigo glow */
            }

            html.dark .widget-card-apple:hover {
                box-shadow:
                    0 30px 60px rgba(0, 0, 0, 0.5),
                    0 0 30px rgba(99, 102, 241, 0.2);
            }

            /* 3D İkon Alanı */
            .widget-icon-3d {
                width: 52px;
                height: 52px;
                border-radius: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: white;
                transform: translateZ(20px);
                /* İkon karttan yukarıda durur */
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                background-size: 200% 200%;
                animation: gradientShift 6s ease infinite;
            }

            /* Gelir İkonu Gradient */
            .icon-income {
                background: linear-gradient(135deg, #10b981, #34d399);
                box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
            }

            /* Gider İkonu Gradient */
            .icon-expense {
                background: linear-gradient(135deg, #ef4444, #f87171);
                box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
            }

            /* === MOBILE FIX: Gelir/Gider Widget Cards === */
            /* Mobilde sıkışık görünümü düzeltir */
            @media (max-width: 640px) {

                /* Widget kartları için mobil padding optimizasyonu */
                .widget-card-apple {
                    padding: 14px !important;
                }

                /* İkon boyutunu mobilde küçült (52px -> 40px) */
                .widget-icon-3d {
                    width: 40px !important;
                    height: 40px !important;
                    border-radius: 14px !important;
                    font-size: 18px !important;
                    flex-shrink: 0;
                    /* İkonun küçülmesini engelle */
                }

                /* İkon içindeki SVG boyutunu küçült */
                .widget-icon-3d svg {
                    width: 18px !important;
                    height: 18px !important;
                }

                /* Ana tutar font boyutunu mobilde küçült */
                .widget-card-apple h3 {
                    /* Mobilde tutarı biraz küçült: daha ferah, premium görünüm */
                    font-size: 1.12rem !important;
                    /* 1.25rem -> 1.12rem */
                    line-height: 1.15 !important;
                    /* daha sıkı, taşmayı azaltır */
                    letter-spacing: -0.02em;
                    /* Apple hissi */
                    /* ₺ ve sayı aynı satırda kalsın */
                    white-space: nowrap;
                }

                /* Üst kısım flex container'ına gap ekle */
                .widget-card-apple .flex.justify-between.items-start {
                    gap: 8px;
                }

                /* Sol taraftaki text container'ın genişliğini sınırla */
                .widget-card-apple .flex.justify-between.items-start>div:first-child {
                    flex: 1;
                    min-width: 0;
                    /* Overflow kontrolü için */
                    padding-right: 4px;
                }

                /* Değişim badge ve alt metin */
                .widget-card-apple .mt-4.flex.items-center {
                    margin-top: 10px !important;
                }
            }

            /* 360px ve altı için ekstra küçültme (iPhone SE vb.) */
            @media (max-width: 360px) {
                .widget-card-apple {
                    padding: 12px !important;
                }

                .widget-icon-3d {
                    width: 36px !important;
                    height: 36px !important;
                    border-radius: 12px !important;
                }

                .widget-icon-3d svg {
                    width: 16px !important;
                    height: 16px !important;
                }

                .widget-card-apple h3 {
                    font-size: 1.00rem !important;
                    /* 1.1rem -> 1.00rem */
                    line-height: 1.12 !important;
                    letter-spacing: -0.02em;
                    white-space: nowrap;
                }

                .widget-card-apple p.text-xs {
                    font-size: 10px !important;
                }
            }

            /* ─────────────────────────────────────────────────────────────────────────
           ✅ ULTRA-COMPREHENSIVE iOS & MOBILE OPTIMIZATIONS (iPhone/Android)
           ───────────────────────────────────────────────────────────────────────── */

            /* 1. SAFE AREA HANDLING (Global Fix for Notch & Home Indicator) */
            :root {
                --sat: env(safe-area-inset-top, 0px);
                --sar: env(safe-area-inset-right, 0px);
                --sab: env(safe-area-inset-bottom, 20px);
                /* Default 20px fallback */
                --sal: env(safe-area-inset-left, 0px);
            }

            /* Bottom Navigation Bar - Push up from Home Indicator */
            #app-nav,
            .bottom-nav {
                padding-bottom: var(--sab) !important;
                height: calc(65px + var(--sab)) !important;
                box-sizing: content-box;
            }

            /* Main Container - Add bottom spacer so content isn't covered by Nav */
            #app-container,
            #screen-dashboard,
            #screen-transactions {
                padding-bottom: calc(90px + var(--sab)) !important;
            }

            /* Top Header / Modal - Avoid Notch */
            #premium-modal>div,
            .modal-content,
            .toast-shell {
                padding-top: var(--sat) !important;
            }

            /* 2. GRID OPTIMIZATION (Prevent "Cramped" layouts on iPhone SE/Mini) */
            /* For screens narrower than 380px, force 1-column layout for main grid */
            @media (max-width: 380px) {
                #screen-dashboard .grid.grid-cols-2 {
                    grid-template-columns: 1fr !important;
                    gap: 16px !important;
                }
            }

            /* 3. TEXT SAFETY (Prevent Overlaps) */
            .widget-card-apple h3,
            .neo-value,
            .amount {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                display: block;
            }

            /* Fix money-inline flex issues */
            .money-inline,
            .money-inline--lg {
                flex-wrap: nowrap;
                min-width: 0;
                max-width: 100%;
            }

            /* 4. INPUT ZOOM FIX (iOS zooms if font < 16px) */
            input,
            select,
            textarea {
                font-size: 16px !important;
            }

            /* 5. BODY SAFETY */
            body {
                overflow-x: hidden;
                /* Prevent horizontal scroll */
                -webkit-tap-highlight-color: transparent;
                /* Remove grey tap box */
            }

            /* 6. MODAL SCROLL SAFETY */
            body.modal-open {
                position: fixed;
                width: 100%;
                overflow: hidden;
            }

            /* Arka Plan "Blob" Efekti (Kartın içinde yüzen renk) */
            .widget-blob {
                position: absolute;
                top: 0;
                right: 0;
                width: 120px;
                height: 120px;
                border-radius: 50%;
                filter: blur(40px);
                opacity: 0.12;
                pointer-events: none;
                transition: all 0.5s ease;
                transform: translate(20%, -20%);
            }

            .widget-card-apple:hover .widget-blob {
                transform: translate(15%, -15%) scale(1.15);
                opacity: 0.18;
            }

            @keyframes gradientShift {
                0% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }

                100% {
                    background-position: 0% 50%;
                }
            }

            /* === HOLOGRAFİK & LISTE WIDGET STİLLERİ === */

            /* Yüzen Animasyon (Nefes Alma Efekti) */
            @keyframes floatIdle {

                0%,
                100% {
                    transform: translateY(0px);
                }

                50% {
                    transform: translateY(-5px);
                }
            }

            /* 1. GRAFİK KARTI (Holografik Panel) */
            .glass-panel-3d {
                background: rgba(255, 255, 255, 0.45);
                backdrop-filter: blur(30px) saturate(150%);
                -webkit-backdrop-filter: blur(30px) saturate(150%);
                border-radius: 32px;
                border: 1px solid rgba(255, 255, 255, 0.5);
                box-shadow:
                    0 20px 50px rgba(0, 0, 0, 0.05),
                    inset 0 0 20px rgba(255, 255, 255, 0.5);
                transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
                position: relative;
                overflow: hidden;
                animation: floatIdle 6s ease-in-out infinite;
            }

            html.dark .glass-panel-3d {
                background: rgba(30, 32, 40, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.05);
                box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            }

            /* Grafik Kartı Hover Efekti */
            .glass-panel-3d:hover {
                transform: translateY(-5px) scale(1.01);
                box-shadow:
                    0 30px 60px rgba(0, 0, 0, 0.1),
                    0 0 0 2px rgba(99, 102, 241, 0.3);
                animation-play-state: paused;
            }

            /* 2. SON İŞLEMLER LİSTESİ İÇİN STİL */
            .transaction-list-container {
                perspective: 1000px;
            }

            /* Liste Elemanları */
            .transaction-list-container .space-y-3>div,
            #recent-transactions-list>div {
                background: rgba(255, 255, 255, 0.6) !important;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.4);
                margin-bottom: 12px;
                border-radius: 20px;
                transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                transform-style: preserve-3d;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            }

            html.dark .transaction-list-container .space-y-3>div,
            html.dark #recent-transactions-list>div {
                background: rgba(45, 45, 50, 0.6) !important;
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            /* Liste Elemanı Hover (3D Tilt) */
            .transaction-list-container .space-y-3>div:hover,
            #recent-transactions-list>div:hover {
                transform: scale(1.02) translateX(5px) !important;
                background: rgba(255, 255, 255, 0.9) !important;
                box-shadow:
                    -10px 10px 20px rgba(0, 0, 0, 0.05),
                    0 0 15px rgba(99, 102, 241, 0.2);
                z-index: 10;
                cursor: pointer;
            }

            html.dark .transaction-list-container .space-y-3>div:hover,
            html.dark #recent-transactions-list>div:hover {
                background: rgba(60, 60, 70, 0.9) !important;
            }

            /* Başlıklar için şık stil */
            .section-title-premium {
                font-size: 1.1rem;
                font-weight: 800;
                background: linear-gradient(to right, #6366f1, #a855f7);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 1rem;
                display: inline-block;
                letter-spacing: -0.5px;
            }

            /* === EKSTRA WIDGET STİLLERİ (NET NAKİT, HEDEF, TAKSİT) === */

            /* Net Nakit Kartı - Platinum/Gold Efekt */
            .card-premium-balance {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
                backdrop-filter: blur(40px);
                -webkit-backdrop-filter: blur(40px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                position: relative;
                overflow: hidden;
                transition: all 0.5s ease;
            }

            html.dark .card-premium-balance {
                background: linear-gradient(135deg, rgba(40, 40, 50, 0.7), rgba(20, 20, 25, 0.8));
                border: 1px solid rgba(255, 215, 0, 0.15);
            }

            /* Arka planda dönen ışık efekti */
            .card-premium-balance::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 60%);
                animation: rotateSlow 10s linear infinite;
                pointer-events: none;
            }

            @keyframes rotateSlow {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            /* 3D Progress Bar (Tüp Görünümü) */
            .progress-3d-track {
                width: 100%;
                height: 12px;
                background: rgba(0, 0, 0, 0.05);
                border-radius: 10px;
                box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                overflow: hidden;
                position: relative;
            }

            html.dark .progress-3d-track {
                background: rgba(0, 0, 0, 0.3);
            }

            .progress-3d-fill {
                height: 100%;
                border-radius: 10px;
                position: relative;
                box-shadow: 0 0 10px currentColor;
                transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Taksit Kartları için Mini 3D Liste */
            .installment-card {
                background: rgba(255, 255, 255, 0.5);
                border-left: 4px solid #f59e0b;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                margin-bottom: 8px;
                padding: 12px;
                border-radius: 12px;
                transition: transform 0.3s;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            html.dark .installment-card {
                background: rgba(40, 40, 50, 0.6);
            }

            .installment-card:hover {
                transform: translateX(5px) scale(1.02);
                background: rgba(255, 255, 255, 0.8);
            }

            html.dark .installment-card:hover {
                background: rgba(60, 60, 70, 0.8);
            }

            /* === APPLE AWARD LIQUID GLASS WIDGET STYLES === */

            /* Tema tokenları */
            :root {
                --pw-radius: 26px;
                --pw-border: rgba(255, 255, 255, .16);
                --pw-shadow: 0 18px 60px rgba(0, 0, 0, .35);
                --pw-shadow-soft: 0 10px 30px rgba(0, 0, 0, .22);
                --pw-glass: rgba(255, 255, 255, .06);
                --pw-glass-strong: rgba(255, 255, 255, .10);
                --pw-text: rgba(255, 255, 255, .92);
                --pw-subtext: rgba(255, 255, 255, .62);
                /* motion vars */
                --rx: 0deg;
                --ry: 0deg;
                --mx: 50%;
                --my: 50%;
                --press: 1;
            }

            html:not(.dark) {
                --pw-border: rgba(0, 0, 0, .10);
                --pw-shadow: 0 18px 60px rgba(0, 0, 0, .12);
                --pw-shadow-soft: 0 10px 30px rgba(0, 0, 0, .10);
                --pw-glass: rgba(255, 255, 255, .70);
                --pw-glass-strong: rgba(255, 255, 255, .86);
                --pw-text: rgba(10, 14, 24, .92);
                --pw-subtext: rgba(10, 14, 24, .58);
            }

            /* Kart ana stil */
            .pw-widget.pw-glass {
                position: relative;
                border-radius: var(--pw-radius);
                border: 1px solid var(--pw-border);
                box-shadow: var(--pw-shadow);
                backdrop-filter: blur(18px) saturate(140%);
                -webkit-backdrop-filter: blur(18px) saturate(140%);
                transform-style: preserve-3d;
                overflow: hidden;
                transition: transform .28s cubic-bezier(.2, .9, .2, 1), box-shadow .28s cubic-bezier(.2, .9, .2, 1);
            }

            /* 3D tilt + press */
            .pw-widget.pw-tilt {
                transform:
                    perspective(1000px) rotateX(var(--rx)) rotateY(var(--ry)) scale(var(--press));
            }

            .pw-widget.pw-tilt.is-pressed {
                --press: .985;
                box-shadow: var(--pw-shadow-soft);
            }

            /* Apple Award specular/sheen/refraction katmanları */
            .pw-widget.pw-glass::before {
                content: "";
                position: absolute;
                inset: -2px;
                background:
                    radial-gradient(600px 220px at var(--mx) var(--my),
                        rgba(255, 255, 255, .30),
                        rgba(255, 255, 255, .10) 35%,
                        rgba(255, 255, 255, 0) 70%);
                opacity: .75;
                transform: translateZ(1px);
                pointer-events: none;
                z-index: 2;
            }

            .pw-widget.pw-glass::after {
                content: "";
                position: absolute;
                inset: 0;
                background:
                    radial-gradient(900px 300px at 20% 0%,
                        rgba(120, 160, 255, .22),
                        rgba(0, 0, 0, 0) 60%),
                    radial-gradient(900px 300px at 90% 10%,
                        rgba(180, 120, 255, .20),
                        rgba(0, 0, 0, 0) 65%),
                    linear-gradient(to bottom,
                        rgba(0, 0, 0, .08),
                        rgba(0, 0, 0, .22));
                opacity: .55;
                pointer-events: none;
                z-index: 1;
            }

            html:not(.dark) .pw-widget.pw-glass::after {
                background:
                    radial-gradient(900px 320px at 20% 0%,
                        rgba(120, 160, 255, .14),
                        rgba(255, 255, 255, 0) 60%),
                    radial-gradient(900px 320px at 90% 10%,
                        rgba(180, 120, 255, .12),
                        rgba(255, 255, 255, 0) 65%),
                    linear-gradient(to bottom,
                        rgba(255, 255, 255, .10),
                        rgba(0, 0, 0, .06));
                opacity: .85;
            }

            /* Derinlik katmanları */
            .pw-layer {
                position: relative;
                transform-style: preserve-3d;
            }

            .pw-layer--content {
                transform: translateZ(18px);
            }

            .pw-layer--icon {
                transform: translateZ(34px);
            }

            /* Kart türüne göre accent */
            .pw-widget--cash {
                --pw-accentA: rgba(120, 160, 255, .65);
                --pw-accentB: rgba(180, 120, 255, .55);
            }

            .pw-widget--savings {
                --pw-accentA: rgba(120, 255, 210, .55);
                --pw-accentB: rgba(120, 170, 255, .40);
            }

            .pw-widget--cash .pw-accent,
            .pw-widget--savings .pw-accent {
                position: absolute;
                inset: -40px;
                background:
                    radial-gradient(circle at 30% 20%, var(--pw-accentA), rgba(0, 0, 0, 0) 55%),
                    radial-gradient(circle at 80% 10%, var(--pw-accentB), rgba(0, 0, 0, 0) 60%);
                filter: blur(18px);
                opacity: .55;
                pointer-events: none;
                transform: translateZ(0px);
                z-index: 0;
            }

            /* Başlık/alt metin okunurluk */
            .pw-widget .pw-title {
                letter-spacing: .12em;
                font-weight: 700;
                color: var(--pw-subtext);
            }

            .pw-widget .pw-value {
                color: var(--pw-text);
                text-shadow: 0 10px 24px rgba(0, 0, 0, .22);
            }

            html:not(.dark) .pw-widget .pw-value {
                text-shadow: 0 10px 22px rgba(0, 0, 0, .08);
            }

            /* Perf ve Reduced Motion */
            html.perf .pw-widget.pw-tilt {
                transform: none !important;
            }

            html.perf .pw-widget.pw-glass::before {
                opacity: .45;
            }

            @media (prefers-reduced-motion: reduce) {
                .pw-widget.pw-tilt {
                    transform: none !important;
                }

                .pw-widget.pw-glass::before {
                    opacity: .45;
                }
            }

            /* ═══════════════════════════════════════════════════════════════════ */
            /* ONBOARDING OVERLAY - STACK OF CARDS (ob- prefix)                    */
            /* Premium 3D stacking cards with swipe-up dismiss & spring physics    */
            /* ═══════════════════════════════════════════════════════════════════ */

            /* Main Container */
            #ob-overlay {
                position: fixed;
                inset: 0;
                z-index: 99999;
                background: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                opacity: 1;
                transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                perspective: 1200px;
            }

            #ob-overlay.ob-fade-out {
                opacity: 0;
                pointer-events: none;
            }

            /* ─── Aurora Background Orbs ─── */
            .ob-aurora {
                position: absolute;
                inset: 0;
                pointer-events: none;
                overflow: hidden;
                transition: filter 1s ease;
            }

            .ob-orb {
                position: absolute;
                border-radius: 50%;
                filter: blur(100px);
                opacity: 0.8;
                animation: obOrbFloat 20s ease-in-out infinite;
            }

            .ob-orb-1 {
                width: 450px;
                height: 450px;
                top: -15%;
                left: -10%;
                background: radial-gradient(ellipse at center, rgba(139, 92, 246, 0.7), rgba(168, 85, 247, 0.4), transparent 70%);
                animation-delay: 0s;
            }

            .ob-orb-2 {
                width: 400px;
                height: 400px;
                bottom: -20%;
                right: -10%;
                background: radial-gradient(ellipse at center, rgba(236, 72, 153, 0.6), rgba(251, 191, 36, 0.35), transparent 70%);
                animation-delay: -7s;
            }

            .ob-orb-3 {
                width: 320px;
                height: 320px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: radial-gradient(ellipse at center, rgba(59, 130, 246, 0.5), rgba(147, 51, 234, 0.3), transparent 70%);
                animation-delay: -14s;
            }

            @keyframes obOrbFloat {

                0%,
                100% {
                    transform: translate(0, 0) scale(1);
                    opacity: 0.7;
                }

                25% {
                    transform: translate(30px, -20px) scale(1.05);
                    opacity: 0.9;
                }

                50% {
                    transform: translate(-20px, 30px) scale(0.95);
                    opacity: 0.8;
                }

                75% {
                    transform: translate(20px, 20px) scale(1.02);
                    opacity: 0.85;
                }
            }

            /* Gold Mode (Premium Card Active) */
            .ob-aurora.ob-gold-mode .ob-orb-1 {
                background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.7), rgba(218, 165, 32, 0.4), transparent 70%);
            }

            .ob-aurora.ob-gold-mode .ob-orb-2 {
                background: radial-gradient(ellipse at center, rgba(251, 191, 36, 0.7), rgba(245, 158, 11, 0.4), transparent 70%);
            }

            .ob-aurora.ob-gold-mode .ob-orb-3 {
                background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.5), rgba(184, 134, 11, 0.3), transparent 70%);
            }

            /* ─── Skip Button ─── */
            .ob-skip {
                position: absolute;
                top: max(20px, env(safe-area-inset-top, 20px));
                right: 20px;
                padding: 10px 22px;
                border-radius: 24px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                color: rgba(255, 255, 255, 0.85);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                z-index: 10;
                transition: all 0.3s ease;
            }

            .ob-skip:hover {
                background: rgba(255, 255, 255, 0.12);
                transform: scale(1.03);
            }

            /* ─── Card Stack Container ─── */
            .ob-stack {
                position: relative;
                width: min(380px, 90vw);
                height: min(600px, 85vh);
                transform-style: preserve-3d;
            }

            /* ─── Individual Card ─── */
            .ob-card {
                position: absolute;
                width: 100%;
                height: 100%;
                border-radius: 36px;
                background: linear-gradient(165deg,
                        rgba(255, 255, 255, 0.12) 0%,
                        rgba(255, 255, 255, 0.04) 50%,
                        rgba(255, 255, 255, 0.08) 100%);
                border: 1px solid rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(50px) saturate(180%);
                -webkit-backdrop-filter: blur(50px) saturate(180%);
                box-shadow:
                    0 40px 140px -30px rgba(0, 0, 0, 0.9),
                    0 20px 50px -15px rgba(99, 102, 241, 0.2),
                    0 8px 20px -5px rgba(168, 85, 247, 0.15),
                    0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                    0 2px 0 rgba(255, 255, 255, 0.18) inset;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 40px 28px 30px;
                box-sizing: border-box;
                cursor: grab;
                user-select: none;
                transform-style: preserve-3d;
                transition: transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1),
                    opacity 0.5s ease,
                    box-shadow 0.4s ease;
                will-change: transform, opacity;
            }

            .ob-card:active {
                cursor: grabbing;
            }

            /* Card Glass Shine */
            .ob-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 55%;
                border-radius: 36px 36px 0 0;
                background: linear-gradient(180deg,
                        rgba(255, 255, 255, 0.18) 0%,
                        rgba(255, 255, 255, 0.05) 40%,
                        rgba(255, 255, 255, 0) 100%);
                pointer-events: none;
                z-index: 1;
            }

            /* Holographic Sweep */
            .ob-card::after {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: linear-gradient(115deg,
                        transparent 15%,
                        rgba(255, 255, 255, 0.08) 35%,
                        rgba(168, 85, 247, 0.15) 42%,
                        rgba(59, 130, 246, 0.15) 50%,
                        rgba(34, 211, 238, 0.12) 58%,
                        rgba(255, 255, 255, 0.08) 65%,
                        transparent 85%);
                animation: obHoloSweep 5s ease-in-out infinite;
                pointer-events: none;
                border-radius: 36px;
                z-index: 0;
            }

            @keyframes obHoloSweep {

                0%,
                100% {
                    transform: translateX(-40%) rotate(-2deg);
                    opacity: 0.4;
                }

                50% {
                    transform: translateX(40%) rotate(4deg);
                    opacity: 1;
                }
            }

            /* ─── Card Dismiss Animation ─── */
            .ob-card.ob-dismissing {
                animation: obCardDismiss 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
                pointer-events: none;
            }

            @keyframes obCardDismiss {
                0% {
                    transform: translateY(0) scale(1) rotateX(0deg);
                    opacity: 1;
                }

                100% {
                    transform: translateY(-150vh) scale(0.8) rotateX(-15deg);
                    opacity: 0;
                }
            }

            /* Spring Pop for Next Card */
            .ob-card.ob-spring {
                animation: obSpring 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            @keyframes obSpring {
                0% {
                    transform: translateZ(-30px) scale(0.94) translateY(20px);
                }

                50% {
                    transform: translateZ(10px) scale(1.03) translateY(-5px);
                }

                100% {
                    transform: translateZ(0) scale(1) translateY(0);
                }
            }

            /* ─── Visual Section ─── */
            .ob-visual {
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 24px;
                height: 200px;
                width: 100%;
                z-index: 2;
            }

            .ob-glow {
                position: absolute;
                width: 240px;
                height: 240px;
                border-radius: 50%;
                background: radial-gradient(circle,
                        rgba(168, 85, 247, 0.25) 0%,
                        rgba(139, 92, 246, 0.15) 40%,
                        transparent 70%);
                filter: blur(30px);
                animation: obGlow 4s ease-in-out infinite alternate;
            }

            .ob-glow-brain {
                background: radial-gradient(circle,
                        rgba(59, 130, 246, 0.3) 0%,
                        rgba(99, 102, 241, 0.15) 40%,
                        transparent 70%);
            }

            .ob-glow-detective {
                background: radial-gradient(circle,
                        rgba(251, 191, 36, 0.25) 0%,
                        rgba(245, 158, 11, 0.15) 40%,
                        transparent 70%);
            }

            .ob-glow-gold {
                background: radial-gradient(circle,
                        rgba(255, 215, 0, 0.4) 0%,
                        rgba(218, 165, 32, 0.2) 40%,
                        transparent 70%);
            }

            @keyframes obGlow {
                0% {
                    transform: scale(1);
                    opacity: 0.7;
                }

                100% {
                    transform: scale(1.2);
                    opacity: 1;
                }
            }

            .ob-3d-img {
                max-width: 200px;
                max-height: 200px;
                object-fit: contain;
                filter:
                    drop-shadow(0 50px 100px rgba(168, 85, 247, 0.5)) drop-shadow(0 25px 50px rgba(0, 0, 0, 0.6));
                animation: obFloat 6s ease-in-out infinite;
            }

            .ob-emoji-fallback {
                display: none;
                font-size: 120px;
                filter:
                    drop-shadow(0 40px 80px rgba(168, 85, 247, 0.6)) drop-shadow(0 15px 30px rgba(0, 0, 0, 0.4));
                animation: obFloat 6s ease-in-out infinite;
            }

            @keyframes obFloat {

                0%,
                100% {
                    transform: translateY(0) rotate(0deg) scale(1);
                }

                25% {
                    transform: translateY(-14px) rotate(2deg) scale(1.02);
                }

                50% {
                    transform: translateY(-8px) rotate(0deg) scale(1);
                }

                75% {
                    transform: translateY(-12px) rotate(-2deg) scale(1.01);
                }
            }

            /* ─── Content Section ─── */
            .ob-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 0 12px;
                z-index: 2;
            }

            .ob-title {
                font-size: 32px;
                font-weight: 800;
                letter-spacing: -0.05em;
                line-height: 1.1;
                margin-bottom: 16px;
                background: linear-gradient(135deg,
                        rgba(255, 255, 255, 1) 0%,
                        rgba(220, 200, 255, 0.95) 50%,
                        rgba(168, 85, 247, 0.9) 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                animation: obTitleGlow 4s ease-in-out infinite alternate;
            }

            @keyframes obTitleGlow {
                0% {
                    filter: brightness(1) drop-shadow(0 0 8px rgba(168, 85, 247, 0.3));
                }

                100% {
                    filter: brightness(1.1) drop-shadow(0 0 20px rgba(168, 85, 247, 0.5));
                }
            }

            .ob-desc {
                font-size: 16px;
                font-weight: 500;
                line-height: 1.6;
                color: rgba(255, 255, 255, 0.7);
                max-width: 290px;
                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }

            /* ─── Progress Dots ─── */
            .ob-progress {
                display: flex;
                gap: 12px;
                margin-top: 24px;
                z-index: 2;
            }

            .ob-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .ob-dot.active {
                width: 28px;
                border-radius: 14px;
                background: linear-gradient(135deg, #a855f7, #ec4899, #fbbf24);
                background-size: 200% 200%;
                animation: obDotPulse 2s ease-in-out infinite, obDotGradient 3s ease infinite;
                box-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
                border-color: transparent;
            }

            @keyframes obDotPulse {

                0%,
                100% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.1);
                }
            }

            @keyframes obDotGradient {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            /* ─── Hint Section ─── */
            .ob-hint {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                margin-top: 20px;
                color: rgba(255, 255, 255, 0.5);
                font-size: 13px;
                font-weight: 600;
                letter-spacing: 0.02em;
                animation: obHintBounce 2s ease-in-out infinite;
                z-index: 2;
            }

            .ob-hint-icon {
                font-size: 22px;
                filter: drop-shadow(0 4px 10px rgba(168, 85, 247, 0.4));
            }

            @keyframes obHintBounce {

                0%,
                100% {
                    transform: translateY(0);
                    opacity: 0.5;
                }

                50% {
                    transform: translateY(-8px);
                    opacity: 1;
                }
            }

            /* ═══════════════════════════════════════════════════════════════════ */
            /* PREMIUM CARD (GOLD THEME)                                           */
            /* ═══════════════════════════════════════════════════════════════════ */

            .ob-card.ob-card-premium {
                background: linear-gradient(155deg,
                        #0a0a0a 0%,
                        #151515 50%,
                        #0d0d0d 100%) !important;
                border: 2px solid transparent !important;
                position: relative;
                box-shadow:
                    0 30px 80px rgba(0, 0, 0, 0.8),
                    0 0 60px rgba(255, 215, 0, 0.2),
                    0 0 120px rgba(255, 215, 0, 0.1),
                    inset 0 1px 0 rgba(255, 215, 0, 0.1) !important;
            }

            /* Animated Gold Border */
            .ob-card.ob-card-premium::before {
                content: '' !important;
                position: absolute !important;
                inset: -2px !important;
                border-radius: 38px !important;
                background: linear-gradient(var(--ob-gold-angle, 0deg),
                        #ffd700, #daa520, #b8860b, #daa520, #ffd700) !important;
                z-index: -1 !important;
                animation: obGoldBorderRotate 4s linear infinite !important;
                height: auto !important;
            }

            @keyframes obGoldBorderRotate {
                0% {
                    --ob-gold-angle: 0deg;
                }

                100% {
                    --ob-gold-angle: 360deg;
                }
            }

            @property --ob-gold-angle {
                syntax: '<angle>';
                initial-value: 0deg;
                inherits: false;
            }

            /* Gold Shimmer Overlay */
            .ob-card.ob-card-premium::after {
                content: '' !important;
                position: absolute !important;
                top: 0 !important;
                left: -100% !important;
                width: 50% !important;
                height: 100% !important;
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 215, 0, 0.15),
                        transparent) !important;
                animation: obGoldShimmer 3s ease-in-out infinite !important;
                border-radius: 36px !important;
                z-index: 1 !important;
            }

            @keyframes obGoldShimmer {
                0% {
                    left: -100%;
                }

                50%,
                100% {
                    left: 150%;
                }
            }

            /* Premium Title */
            .ob-title.ob-title-gold {
                background: linear-gradient(135deg, #fffbe8, #ffd700, #daa520, #ffd700) !important;
                background-size: 300% 300% !important;
                -webkit-background-clip: text !important;
                background-clip: text !important;
                -webkit-text-fill-color: transparent !important;
                animation: obGoldTextShift 4s ease infinite !important;
                filter: drop-shadow(0 4px 20px rgba(255, 215, 0, 0.4));
            }

            @keyframes obGoldTextShift {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            .ob-desc.ob-desc-premium {
                color: rgba(255, 255, 255, 0.9);
                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            }

            /* ─── CTA Buttons ─── */
            .ob-cta-group {
                width: 100%;
                padding: 0 16px;
                margin-top: 20px;
                display: flex;
                flex-direction: column;
                gap: 12px;
                z-index: 3;
            }

            .ob-cta-primary {
                position: relative;
                width: 100%;
                padding: 18px 24px;
                border: none;
                border-radius: 16px;
                background: linear-gradient(135deg, #ffd700 0%, #f59e0b 50%, #fbbf24 100%);
                background-size: 200% 200%;
                color: #1a1a1a;
                font-size: 17px;
                font-weight: 800;
                cursor: pointer;
                overflow: hidden;
                animation: obCtaPulse 2s ease-in-out infinite, obCtaGradientShift 3s ease infinite;
                box-shadow:
                    0 10px 40px rgba(255, 215, 0, 0.4),
                    0 4px 15px rgba(245, 158, 11, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .ob-cta-primary:hover {
                transform: scale(1.02) translateY(-2px);
                box-shadow:
                    0 15px 50px rgba(255, 215, 0, 0.5),
                    0 6px 20px rgba(245, 158, 11, 0.4);
            }

            @keyframes obCtaPulse {

                0%,
                100% {
                    box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
                }

                50% {
                    box-shadow: 0 15px 60px rgba(255, 215, 0, 0.6);
                }
            }

            @keyframes obCtaGradientShift {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            .ob-cta-shine {
                position: absolute;
                top: 0;
                left: -100%;
                width: 50%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
                animation: obShine 2.5s ease-in-out infinite;
            }

            @keyframes obShine {
                0% {
                    left: -100%;
                }

                50%,
                100% {
                    left: 150%;
                }
            }

            .ob-cta-text {
                position: relative;
                z-index: 1;
            }

            .ob-cta-secondary {
                background: transparent;
                border: none;
                color: rgba(255, 255, 255, 0.6);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                padding: 12px;
                transition: color 0.3s ease;
            }

            .ob-cta-secondary:hover {
                color: rgba(255, 255, 255, 0.9);
            }

            /* ═══════════════════════════════════════════════════════════════════ */
            /* CONFETTI                                                             */
            /* ═══════════════════════════════════════════════════════════════════ */

            .ob-confetti {
                position: absolute;
                inset: 0;
                pointer-events: none;
                z-index: 100;
                overflow: hidden;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .ob-confetti.active {
                opacity: 1;
            }

            .ob-confetti-piece {
                position: absolute;
                width: 10px;
                height: 10px;
                border-radius: 2px;
                top: -20px;
                animation: obConfettiFall 3s ease-out forwards;
            }

            @keyframes obConfettiFall {
                0% {
                    transform: translateY(0) rotate(0deg) scale(1);
                    opacity: 1;
                }

                100% {
                    transform: translateY(100vh) rotate(720deg) scale(0.5);
                    opacity: 0;
                }
            }

            /* ─── Performance & Reduced Motion ─── */
            @media (prefers-reduced-motion: reduce) {

                .ob-orb,
                .ob-3d-img,
                .ob-emoji-fallback,
                .ob-cta-primary,
                .ob-hint {
                    animation: none !important;
                }

                .ob-card {
                    transition-duration: 0.2s !important;
                }
            }

            html.perf #ob-overlay .ob-orb {
                filter: blur(50px) !important;
                animation-duration: 40s !important;
            }

            /* Individual Card - Ultra Premium */
            .holo-card {
                position: absolute;
                width: 100%;
                height: 100%;
                border-radius: 36px;
                background: linear-gradient(165deg,
                        rgba(255, 255, 255, 0.12) 0%,
                        rgba(255, 255, 255, 0.04) 50%,
                        rgba(255, 255, 255, 0.08) 100%);
                border: 1px solid rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(50px) saturate(180%);
                -webkit-backdrop-filter: blur(50px) saturate(180%);
                box-shadow: 0 40px 140px -30px rgba(0, 0, 0, 0.9),
                    0 20px 50px -15px rgba(99, 102, 241, 0.2),
                    0 8px 20px -5px rgba(168, 85, 247, 0.15),
                    0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                    0 2px 0 rgba(255, 255, 255, 0.18) inset,
                    0 -1px 0 rgba(0, 0, 0, 0.25) inset;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 44px 32px;
                box-sizing: border-box;
                cursor: grab;
                user-select: none;
                transform-style: preserve-3d;
                transition: transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1),
                    opacity 0.5s ease,
                    box-shadow 0.4s ease,
                    border-color 0.3s ease;
                will-change: transform,
                    opacity;
            }

            .holo-card:active {
                cursor: grabbing;
            }

            /* Card Glass Shine - Holographic Rainbow */
            .holo-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 55%;
                border-radius: 36px 36px 0 0;
                background: linear-gradient(180deg,
                        rgba(255, 255, 255, 0.18) 0%,
                        rgba(255, 255, 255, 0.05) 40%,
                        rgba(255, 255, 255, 0) 100%);
                pointer-events: none;
                z-index: 1;
            }

            /* Holographic Rainbow Sweep - Premium */
            .holo-card::after {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: linear-gradient(115deg,
                        transparent 15%,
                        rgba(255, 255, 255, 0.08) 35%,
                        rgba(168, 85, 247, 0.15) 42%,
                        rgba(139, 92, 246, 0.12) 46%,
                        rgba(59, 130, 246, 0.15) 50%,
                        rgba(34, 211, 238, 0.12) 54%,
                        rgba(16, 185, 129, 0.1) 58%,
                        rgba(255, 255, 255, 0.08) 65%,
                        transparent 85%);
                animation: holoSweep 5s ease-in-out infinite;
                pointer-events: none;
                border-radius: 36px;
                z-index: 0;
            }

            @keyframes holoSweep {

                0%,
                100% {
                    transform: translateX(-40%) rotate(-2deg);
                    opacity: 0.4;
                }

                50% {
                    transform: translateX(40%) rotate(4deg);
                    opacity: 1;
                }
            }

            /* Card Stacking Positions */
            .holo-card[data-index="0"] {
                z-index: 3;
                transform: translateZ(0px) scale(1);
            }

            .holo-card[data-index="1"] {
                z-index: 2;
                transform: translateZ(-30px) scale(0.94) translateY(20px);
                opacity: 0.7;
            }

            .holo-card[data-index="2"] {
                z-index: 1;
                transform: translateZ(-60px) scale(0.88) translateY(40px);
                opacity: 0.4;
            }

            /* Card Dismiss Animation */
            .holo-card.dismissing {
                animation: holo-card-dismiss 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
                pointer-events: none;
            }

            @keyframes holo-card-dismiss {
                0% {
                    transform: translateY(0) scale(1) rotateX(0deg);
                    opacity: 1;
                }

                100% {
                    transform: translateY(-150vh) scale(0.8) rotateX(-15deg);
                    opacity: 0;
                }
            }

            /* Spring Pop Animation for Next Card */
            .holo-card.spring-up {
                animation: holo-spring 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            @keyframes holo-spring {
                0% {
                    transform: translateZ(-30px) scale(0.94) translateY(20px);
                }

                50% {
                    transform: translateZ(10px) scale(1.02) translateY(-10px);
                }

                100% {
                    transform: translateZ(0px) scale(1) translateY(0);
                }
            }

            /* 3D Visual Container - Premium Overflow */
            .holo-visual {
                position: relative;
                width: 220px;
                height: 220px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 28px;
                margin-top: -70px;
                z-index: 10;
            }

            /* Glow Ring Behind Visual */
            .holo-visual::before {
                content: '';
                position: absolute;
                width: 180px;
                height: 180px;
                border-radius: 50%;
                background: radial-gradient(circle,
                        rgba(168, 85, 247, 0.25) 0%,
                        rgba(139, 92, 246, 0.15) 40%,
                        transparent 70%);
                filter: blur(30px);
                animation: visualGlow 4s ease-in-out infinite alternate;
            }

            @keyframes visualGlow {
                0% {
                    transform: scale(1);
                    opacity: 0.7;
                }

                100% {
                    transform: scale(1.2);
                    opacity: 1;
                }
            }

            .holo-3d-img {
                max-width: 240px;
                max-height: 240px;
                object-fit: contain;
                filter:
                    drop-shadow(0 50px 100px rgba(168, 85, 247, 0.5)) drop-shadow(0 25px 50px rgba(0, 0, 0, 0.6)) drop-shadow(0 10px 20px rgba(139, 92, 246, 0.3));
                animation: holo-float 6s ease-in-out infinite;
                transform-style: preserve-3d;
            }

            .holo-3d-emoji {
                font-size: 150px;
                filter:
                    drop-shadow(0 40px 80px rgba(168, 85, 247, 0.6)) drop-shadow(0 15px 30px rgba(0, 0, 0, 0.4));
                animation: holo-float 6s ease-in-out infinite;
            }

            @keyframes holo-float {

                0%,
                100% {
                    transform: translateY(0) rotate(0deg) scale(1);
                }

                25% {
                    transform: translateY(-16px) rotate(3deg) scale(1.02);
                }

                50% {
                    transform: translateY(-8px) rotate(0deg) scale(1);
                }

                75% {
                    transform: translateY(-14px) rotate(-3deg) scale(1.01);
                }
            }

            /* Card Content */
            .holo-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 0 12px;
            }

            .holo-title {
                font-size: 34px;
                font-weight: 800;
                letter-spacing: -0.05em;
                line-height: 1.05;
                margin-bottom: 18px;
                background: linear-gradient(135deg,
                        rgba(255, 255, 255, 1) 0%,
                        rgba(220, 200, 255, 0.95) 50%,
                        rgba(168, 85, 247, 0.9) 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                animation: titleGlow 4s ease-in-out infinite alternate;
                text-shadow: 0 8px 32px rgba(168, 85, 247, 0.3);
            }

            @keyframes titleGlow {
                0% {
                    filter: brightness(1) drop-shadow(0 0 8px rgba(168, 85, 247, 0.3));
                }

                100% {
                    filter: brightness(1.1) drop-shadow(0 0 20px rgba(168, 85, 247, 0.5));
                }
            }

            .holo-desc {
                font-size: 17px;
                font-weight: 500;
                line-height: 1.65;
                color: rgba(255, 255, 255, 0.7);
                max-width: 300px;
                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }

            /* Progress Indicator - Premium */
            .holo-progress {
                display: flex;
                gap: 14px;
                margin-top: 28px;
            }

            .holo-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
                position: relative;
            }

            .holo-dot.active {
                width: 28px;
                border-radius: 14px;
                background: linear-gradient(135deg, #a855f7, #ec4899, #fbbf24);
                background-size: 200% 200%;
                animation: dotPulse 2s ease-in-out infinite, dotGradient 3s ease infinite;
                box-shadow: 0 0 20px rgba(168, 85, 247, 0.6),
                    0 0 40px rgba(236, 72, 153, 0.4);
                border-color: transparent;
            }

            @keyframes dotPulse {

                0%,
                100% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.15);
                }
            }

            @keyframes dotGradient {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            /* CTA Button (Last Card) - Premium */
            .holo-cta {
                width: 100%;
                padding: 22px;
                margin-top: 28px;
                border: none;
                border-radius: 20px;
                font-size: 18px;
                font-weight: 800;
                letter-spacing: -0.02em;
                cursor: pointer;
                color: #000;
                background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 40%, #d97706 100%);
                background-size: 200% 200%;
                box-shadow:
                    0 0 50px rgba(251, 191, 36, 0.4),
                    0 18px 45px -15px rgba(251, 191, 36, 0.6),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4),
                    inset 0 -2px 0 rgba(0, 0, 0, 0.1);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                animation: holo-cta-pulse 2s ease-in-out infinite, ctaGradientFlow 3s ease infinite;
                position: relative;
                overflow: hidden;
            }

            /* Shine Effect on CTA */
            .holo-cta::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 60%;
                height: 100%;
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 255, 255, 0.5),
                        transparent);
                animation: ctaShine 3s ease-in-out infinite;
            }

            @keyframes ctaShine {
                0% {
                    left: -100%;
                }

                50%,
                100% {
                    left: 120%;
                }
            }

            @keyframes ctaGradientFlow {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            @keyframes holo-cta-pulse {

                0%,
                100% {
                    box-shadow:
                        0 0 50px rgba(251, 191, 36, 0.4),
                        0 18px 45px -15px rgba(251, 191, 36, 0.6);
                }

                50% {
                    box-shadow:
                        0 0 70px rgba(251, 191, 36, 0.6),
                        0 25px 55px -15px rgba(251, 191, 36, 0.75);
                }
            }

            .holo-cta:hover {
                transform: translateY(-4px) scale(1.02);
                filter: brightness(1.05);
            }

            .holo-cta:active {
                transform: scale(0.97);
                filter: brightness(0.95);
            }

            /* Swipe Hint - Premium */
            .holo-hint {
                position: absolute;
                bottom: -65px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                color: rgba(255, 255, 255, 0.5);
                font-size: 13px;
                font-weight: 500;
                letter-spacing: 0.02em;
                animation: holo-hint-bounce 2.5s ease-in-out infinite;
            }

            .holo-hint-arrow {
                font-size: 22px;
                animation: holo-arrow-up 1.2s ease-in-out infinite;
                filter: drop-shadow(0 2px 8px rgba(168, 85, 247, 0.4));
            }

            @keyframes holo-hint-bounce {

                0%,
                100% {
                    opacity: 0.4;
                    transform: translateX(-50%) translateY(0);
                }

                50% {
                    opacity: 0.8;
                    transform: translateX(-50%) translateY(-3px);
                }
            }

            @keyframes holo-arrow-up {

                0%,
                100% {
                    transform: translateY(0) scale(1);
                }

                50% {
                    transform: translateY(-10px) scale(1.1);
                }
            }

            /* Reduced Motion */
            @media (prefers-reduced-motion: reduce) {

                .holo-orb,
                .holo-3d-img,
                .holo-3d-emoji,
                .holo-cta,
                .holo-hint {
                    animation: none !important;
                }

                .holo-card {
                    transition-duration: 0.2s !important;
                }
            }

            /* Performance Mode */
            html.perf #fingo-hologram .holo-orb {
                filter: blur(50px) !important;
                animation-duration: 40s !important;
            }

            /* --- LIQUID 3D PIN EKRANI --- */
            .pin-glass-bg {
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
            }

            html.dark .pin-glass-bg {
                background: rgba(15, 23, 42, 0.90);
            }

            .liquid-key {
                width: 72px;
                height: 72px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                font-weight: 700;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;

                /* Light Mode: Dolgun, Beyaz, Yumuşak Gölge */
                background: linear-gradient(145deg, #ffffff, #f3f4f6);
                box-shadow: 6px 6px 12px rgba(166, 180, 200, 0.3),
                    -6px -6px 12px rgba(255, 255, 255, 0.8);
                color: #4b5563;
                border: 1px solid rgba(255, 255, 255, 0.6);
            }

            html.dark .liquid-key {
                /* Dark Mode: Koyu, Derinlikli, Hafif Parlama */
                background: linear-gradient(145deg, #1e293b, #0f172a);
                box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5),
                    -2px -2px 5px rgba(255, 255, 255, 0.05);
                color: #f1f5f9;
                border: 1px solid rgba(255, 255, 255, 0.05);
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
            }

            .liquid-key:active {
                transform: scale(0.92);
                box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.1);
            }

            html.dark .liquid-key:active {
                box-shadow: inset 4px 4px 10px rgba(0, 0, 0, 0.5);
            }

            /* Kilit İkonu Animasyonu */
            .lock-bounce {
                animation: lockBounce 2s infinite;
            }

            @keyframes lockBounce {

                0%,
                100% {
                    transform: translateY(0);
                }

                50% {
                    transform: translateY(-5px);
                }
            }

            /* --- ULTRA 3D NFT KARTLARI --- */
            .nft-card-container {
                perspective: 1000px;
                height: 180px;
                /* Kart Yüksekliği */
            }

            .nft-card {
                width: 100%;
                height: 100%;
                position: relative;
                transform-style: preserve-3d;
                transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.4s ease;
                border-radius: 20px;
                background: linear-gradient(145deg, #1e1e2e, #2d2d44);
            }

            /* Kilitli Durum */
            .nft-card.locked {
                filter: grayscale(100%) brightness(50%);
                cursor: not-allowed;
                border: 1px solid #4b5563;
                box-shadow: none;
            }

            /* Açık (Kazanılmış) Durum - Premium Efekt */
            .nft-card.unlocked {
                cursor: pointer;
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow:
                    0 10px 20px rgba(0, 0, 0, 0.5),
                    0 0 15px rgba(99, 102, 241, 0.3),
                    /* Mor Glow */
                    inset 0 0 20px rgba(255, 255, 255, 0.05);
            }

            .nft-card.unlocked:hover {
                transform: translateY(-10px) rotateX(5deg);
                box-shadow:
                    0 20px 40px rgba(0, 0, 0, 0.6),
                    0 0 30px rgba(99, 102, 241, 0.6),
                    inset 0 0 20px rgba(255, 255, 255, 0.1);
            }

            /* Kart İçeriği */
            .nft-content {
                position: absolute;
                inset: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                backface-visibility: hidden;
                padding: 10px;
            }

            .nft-shine {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
                border-radius: 20px;
                pointer-events: none;
            }

            /* --- ULTRA-PREMIUM CELEBRATION MODAL --- */
            .celebration-modal {
                position: fixed;
                inset: 0;
                z-index: 9999 !important;
                /* En üst katman */
                display: none;
                /* Varsayılan gizli */
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                opacity: 0;
                transition: opacity 0.4s ease;
            }

            /* === ULTRA-PREMIUM CELEBRATION MODAL V2 === */
            .celebration-modal {
                position: fixed;
                inset: 0;
                z-index: 9999 !important;
                display: none;
                align-items: center;
                justify-content: center;
                /* Animated gradient background */
                background:
                    radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.3) 0%, transparent 50%),
                    radial-gradient(circle at 70% 80%, rgba(168, 85, 247, 0.3) 0%, transparent 50%),
                    radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.95) 100%);
                backdrop-filter: blur(30px) saturate(150%);
                -webkit-backdrop-filter: blur(30px) saturate(150%);
                opacity: 0;
                transition: opacity 0.5s ease;
            }

            .celebration-modal.visible {
                display: flex !important;
                opacity: 1;
            }

            /* Kapanış glitch fix (iOS Safari backdrop-filter + pseudo-element layers) */
            .celebration-modal {
                will-change: opacity, transform;
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                contain: paint;
            }

            /* Kapanırken: hızlıca opacity 0, pointer-events kapalı */
            .celebration-modal.closing {
                opacity: 0 !important;
                pointer-events: none !important;
                transition: opacity 0.4s ease !important;
            }

            /* Kapanışta partikül layer'ını da öldür (iOS'ta takılı kalan arka planı engeller) */
            .celebration-modal.closing::before {
                animation: none !important;
                opacity: 0 !important;
            }

            /* Animated floating particles background */
            .celebration-modal::before {
                content: '';
                position: absolute;
                inset: 0;
                background-image:
                    radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.8) 0%, transparent 100%),
                    radial-gradient(2px 2px at 40% 70%, rgba(255, 255, 255, 0.6) 0%, transparent 100%),
                    radial-gradient(2px 2px at 60% 20%, rgba(255, 255, 255, 0.7) 0%, transparent 100%),
                    radial-gradient(2px 2px at 80% 60%, rgba(255, 255, 255, 0.5) 0%, transparent 100%),
                    radial-gradient(3px 3px at 10% 80%, rgba(99, 102, 241, 0.8) 0%, transparent 100%),
                    radial-gradient(3px 3px at 90% 40%, rgba(168, 85, 247, 0.8) 0%, transparent 100%);
                animation: floatParticles 20s linear infinite;
                pointer-events: none;
            }

            @keyframes floatParticles {
                0% {
                    transform: translateY(0) rotate(0deg);
                }

                100% {
                    transform: translateY(-100vh) rotate(360deg);
                }
            }

            /* Premium Content Card with RGB Border */
            .celebration-content {
                position: relative;
                background: linear-gradient(165deg, #191928 0%, #0a0a14 100%);
                border-radius: 36px;
                padding: 48px 40px;
                text-align: center;
                max-width: 92%;
                width: 380px;
                transform: scale(0.3) rotateX(30deg);
                opacity: 0;
                transition: all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
                z-index: 1;
            }

            /* Animated RGB Border - Using gradient border technique */
            .celebration-content::before {
                content: '';
                position: absolute;
                top: -3px;
                left: -3px;
                right: -3px;
                bottom: -3px;
                background: conic-gradient(from var(--celebration-angle, 0deg),
                        #ef4444, #f97316, #eab308, #22c55e, #06b6d4, #3b82f6, #8b5cf6, #ec4899, #ef4444);
                border-radius: 39px;
                z-index: -2;
                animation: rgbRotate 3s linear infinite;
            }

            /* Solid background to cover the center of the gradient */
            .celebration-content::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(165deg, #191928 0%, #0a0a14 100%);
                border-radius: 36px;
                z-index: -1;
            }


            @keyframes rgbRotate {
                0% {
                    --celebration-angle: 0deg;
                    filter: hue-rotate(0deg);
                }

                100% {
                    --celebration-angle: 360deg;
                    filter: hue-rotate(360deg);
                }
            }

            @property --celebration-angle {
                syntax: '<angle>';
                initial-value: 0deg;
                inherits: false;
            }


            /* Ultra glow shadows */
            .celebration-modal.visible .celebration-content {
                transform: scale(1) rotateX(0deg);
                opacity: 1;
                box-shadow:
                    0 0 60px rgba(99, 102, 241, 0.5),
                    0 0 120px rgba(168, 85, 247, 0.4),
                    0 0 180px rgba(236, 72, 153, 0.3),
                    0 30px 60px rgba(0, 0, 0, 0.5),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            /* 3D Medal Container */
            .medal-container {
                position: relative;
                width: 140px;
                height: 140px;
                margin: 0 auto 24px;
                perspective: 600px;
            }

            .medal-shimmer {
                font-size: 6rem;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle, rgba(245, 158, 11, 0.3) 0%, transparent 70%);
                border-radius: 50%;
                filter: drop-shadow(0 0 30px rgba(245, 158, 11, 0.7));
                animation: medal3DSpin 4s ease-in-out infinite, medalGlow 2s ease-in-out infinite alternate;
                transform-style: preserve-3d;
            }

            @keyframes medal3DSpin {

                0%,
                100% {
                    transform: rotateY(0deg) scale(1);
                }

                25% {
                    transform: rotateY(15deg) scale(1.05);
                }

                50% {
                    transform: rotateY(0deg) scale(1.1);
                }

                75% {
                    transform: rotateY(-15deg) scale(1.05);
                }
            }

            @keyframes medalGlow {
                0% {
                    filter: drop-shadow(0 0 30px rgba(245, 158, 11, 0.7));
                }

                100% {
                    filter: drop-shadow(0 0 60px rgba(245, 158, 11, 1)) drop-shadow(0 0 100px rgba(245, 158, 11, 0.5));
                }
            }

            /* Premium Holographic Title */
            .neon-title {
                font-size: 1.8rem;
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 3px;
                margin-bottom: 12px;
                background: linear-gradient(135deg,
                        #fff 0%,
                        #c4b5fd 25%,
                        #fff 50%,
                        #a78bfa 75%,
                        #fff 100%);
                background-size: 200% auto;
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                animation: holoShine 3s linear infinite;
                text-shadow: none;
            }

            @keyframes holoShine {
                0% {
                    background-position: 200% center;
                }

                100% {
                    background-position: -200% center;
                }
            }

            /* Badge Name with Glow */
            .neon-subtitle {
                font-size: 1.1rem;
                font-weight: 600;
                color: #e2e8f0;
                margin-bottom: 24px;
                text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
            }

            /* Premium CTA Button */
            .celebration-btn {
                position: relative;
                padding: 16px 48px;
                font-size: 1rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 2px;
                color: white;
                background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
                border: none;
                border-radius: 16px;
                cursor: pointer;
                overflow: hidden;
                transition: all 0.3s ease;
                box-shadow:
                    0 10px 30px rgba(99, 102, 241, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            .celebration-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                transition: left 0.5s ease;
            }

            .celebration-btn:hover {
                transform: translateY(-3px) scale(1.02);
                box-shadow:
                    0 15px 40px rgba(99, 102, 241, 0.5),
                    0 0 60px rgba(139, 92, 246, 0.3);
            }

            .celebration-btn:hover::before {
                left: 100%;
            }

            .celebration-btn:active {
                transform: translateY(0) scale(0.98);
            }

            /* ═══════════════════════════════════════════════════════════════
           SCRATCH CARD REWARD POPUP - Apple Award UI/UX Design
           Premium Kazı-Kazan Deneyimi - Minimalist & Elegant
        ═══════════════════════════════════════════════════════════════ */

            /* Modal Overlay - Glassmorphism */
            .reward-modal {
                position: fixed;
                inset: 0;
                z-index: 10000;
                display: none;
                align-items: center;
                justify-content: center;
                padding: 24px;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(40px) saturate(180%);
                -webkit-backdrop-filter: blur(40px) saturate(180%);
                opacity: 0;
                transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .reward-modal.visible {
                display: flex !important;
                opacity: 1;
            }

            .reward-modal.closing {
                opacity: 0 !important;
                pointer-events: none !important;
            }

            /* Light Mode Overlay */
            html:not(.dark) .reward-modal {
                background: rgba(255, 255, 255, 0.7);
            }

            /* Modal Container - Apple Glass Card */
            .reward-container {
                position: relative;
                width: 100%;
                max-width: 340px;
                background: rgba(28, 28, 30, 0.95);
                border-radius: 28px;
                padding: 28px 24px;
                transform: scale(0.92) translateY(30px);
                opacity: 0;
                transition: all 0.6s cubic-bezier(0.32, 0.72, 0, 1);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                overflow: hidden;
            }

            html:not(.dark) .reward-container {
                background: rgba(255, 255, 255, 0.95);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            }

            .reward-modal.visible .reward-container {
                transform: scale(1) translateY(0);
                opacity: 1;
            }

            /* Header - Clean & Minimal */
            .reward-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 20px;
                position: relative;
                z-index: 2;
            }

            .reward-title {
                font-size: 1.5rem;
                font-weight: 700;
                color: #ffffff;
                letter-spacing: -0.03em;
                line-height: 1.2;
            }

            html:not(.dark) .reward-title {
                color: #1c1c1e;
            }

            .reward-subtitle {
                font-size: 0.875rem;
                color: rgba(255, 255, 255, 0.5);
                margin-top: 6px;
                font-weight: 400;
                letter-spacing: -0.01em;
            }

            html:not(.dark) .reward-subtitle {
                color: rgba(60, 60, 67, 0.6);
            }

            .reward-close-btn {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                color: rgba(255, 255, 255, 0.6);
                font-size: 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                flex-shrink: 0;
            }

            .reward-close-btn:hover {
                background: rgba(255, 255, 255, 0.15);
                color: #ffffff;
                transform: scale(1.05);
            }

            .reward-close-btn:active {
                transform: scale(0.95);
            }

            html:not(.dark) .reward-close-btn {
                background: rgba(60, 60, 67, 0.08);
                color: rgba(60, 60, 67, 0.5);
            }

            html:not(.dark) .reward-close-btn:hover {
                background: rgba(60, 60, 67, 0.12);
                color: #1c1c1e;
            }

            /* Card Wrapper - Unified Container */
            .reward-card-wrapper {
                position: relative;
                width: 100%;
                aspect-ratio: 4 / 5;
                max-height: 340px;
                margin: 0 auto 24px;
                border-radius: 20px;
                overflow: hidden;
            }

            .reward-card {
                position: relative;
                width: 100%;
                height: 100%;
                border-radius: 20px;
                overflow: hidden;
                background: linear-gradient(165deg, #2c2c2e 0%, #1c1c1e 100%);
                box-shadow:
                    inset 0 1px 0 rgba(255, 255, 255, 0.05),
                    0 8px 32px rgba(0, 0, 0, 0.3);
            }

            html:not(.dark) .reward-card {
                background: linear-gradient(165deg, #f5f5f7 0%, #e5e5ea 100%);
                box-shadow:
                    inset 0 1px 0 rgba(255, 255, 255, 0.8),
                    0 8px 32px rgba(0, 0, 0, 0.08);
            }

            /* Reveal Content */
            .reward-reveal {
                position: absolute;
                inset: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 32px 24px;
                opacity: 0;
                transform: scale(0.95);
                transition: all 0.8s cubic-bezier(0.32, 0.72, 0, 1);
                z-index: 1;
            }

            .reward-reveal.revealed {
                opacity: 1;
                transform: scale(1);
            }

            .reward-icon {
                font-size: 4.5rem;
                margin-bottom: 20px;
                filter: drop-shadow(0 8px 24px rgba(0, 0, 0, 0.2));
                animation: iconFloat 4s ease-in-out infinite;
            }

            .reward-icon img {
                width: 100px;
                height: 100px;
                object-fit: contain;
            }

            @keyframes iconFloat {

                0%,
                100% {
                    transform: translateY(0) scale(1);
                }

                50% {
                    transform: translateY(-8px) scale(1.02);
                }
            }

            .reward-name {
                font-size: 1.375rem;
                font-weight: 700;
                color: #ffffff;
                text-align: center;
                margin-bottom: 8px;
                letter-spacing: -0.02em;
            }

            html:not(.dark) .reward-name {
                color: #1c1c1e;
            }

            .reward-desc {
                font-size: 0.875rem;
                color: rgba(255, 255, 255, 0.6);
                text-align: center;
                line-height: 1.5;
                max-width: 90%;
            }

            html:not(.dark) .reward-desc {
                color: rgba(60, 60, 67, 0.6);
            }

            .reward-rarity {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 16px;
                border-radius: 100px;
                font-size: 0.6875rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                margin-top: 20px;
            }

            .reward-rarity.common {
                background: rgba(142, 142, 147, 0.15);
                color: #8e8e93;
            }

            .reward-rarity.rare {
                background: rgba(0, 122, 255, 0.12);
                color: #0a84ff;
            }

            .reward-rarity.epic {
                background: rgba(175, 82, 222, 0.12);
                color: #bf5af2;
            }

            .reward-rarity.legendary {
                background: linear-gradient(135deg, rgba(255, 214, 10, 0.15), rgba(255, 159, 10, 0.12));
                color: #ffd60a;
                animation: legendaryGlow 3s ease-in-out infinite;
            }

            @keyframes legendaryGlow {

                0%,
                100% {
                    box-shadow: 0 0 0 0 rgba(255, 214, 10, 0);
                }

                50% {
                    box-shadow: 0 0 20px 0 rgba(255, 214, 10, 0.2);
                }
            }

            /* Scratch Surface - Premium Metallic */
            .reward-scratch-layer {
                position: absolute;
                inset: 0;
                z-index: 20;
                border-radius: 20px;
                overflow: hidden;
                background: linear-gradient(135deg,
                        #e8d5b7 0%,
                        #f5e6d3 15%,
                        #d4c4a8 30%,
                        #f0e2cc 50%,
                        #d9c9ad 70%,
                        #f5e6d3 85%,
                        #e8d5b7 100%);
                background-size: 400% 400%;
                animation: metallicShine 6s ease-in-out infinite;
            }

            @keyframes metallicShine {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            .reward-scratch-canvas {
                position: absolute;
                top: 0;
                left: 0;
                width: 100% !important;
                height: 100% !important;
                display: block;
                cursor: grab;
                touch-action: none;
                background: transparent;
                z-index: 25;
            }

            .reward-scratch-canvas:active {
                cursor: grabbing;
            }

            /* Mystery Overlay */
            .reward-mystery {
                position: absolute;
                inset: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                border-radius: 20px;
                background: linear-gradient(165deg, #2c2c2e 0%, #1c1c1e 100%);
                z-index: 15;
                pointer-events: none;
            }

            html:not(.dark) .reward-mystery {
                background: linear-gradient(165deg, #f5f5f7 0%, #e5e5ea 100%);
            }

            .reward-mystery-icon {
                font-size: 3.5rem;
                opacity: 0.4;
                margin-bottom: 12px;
                animation: mysteryPulse 3s ease-in-out infinite;
            }

            @keyframes mysteryPulse {

                0%,
                100% {
                    transform: scale(1);
                    opacity: 0.4;
                }

                50% {
                    transform: scale(1.05);
                    opacity: 0.5;
                }
            }

            .reward-mystery-text {
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.4);
                text-transform: uppercase;
                letter-spacing: 0.15em;
                font-weight: 500;
            }

            html:not(.dark) .reward-mystery-text {
                color: rgba(60, 60, 67, 0.4);
            }

            /* Progress Indicator - Minimal Pill */
            .reward-progress {
                margin-top: 0;
                width: 100%;
                position: relative;
                z-index: 30;
            }

            .reward-progress-text {
                display: none;
            }

            .reward-progress-percent {
                display: none;
            }

            .reward-progress-bar {
                width: 100%;
                height: 4px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 100px;
                overflow: hidden;
            }

            html:not(.dark) .reward-progress-bar {
                background: rgba(60, 60, 67, 0.06);
            }

            .reward-progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #0a84ff, #5ac8fa);
                border-radius: 100px;
                width: 0%;
                transition: width 0.15s ease-out;
                position: relative;
            }

            html:not(.dark) .reward-progress-fill {
                background: linear-gradient(90deg, #007aff, #34c759);
            }

            /* LED Border - Thin Animated Glow Border */
            .reward-led-border {
                position: absolute;
                inset: 0;
                border-radius: 20px;
                pointer-events: none;
                z-index: 30;
                opacity: 0;
                transition: opacity 0.5s ease;
                background: transparent !important;
                box-shadow:
                    inset 0 0 0 3px #0a84ff,
                    0 0 15px rgba(10, 132, 255, 0.5);
                animation: ledBorderGlow 3s linear infinite;
            }

            .reward-led-border.active,
            .reward-led-border.complete {
                opacity: 1;
            }

            @keyframes ledBorderGlow {
                0% {
                    box-shadow:
                        inset 0 0 0 3px #0a84ff,
                        0 0 15px rgba(10, 132, 255, 0.5);
                }

                16% {
                    box-shadow:
                        inset 0 0 0 3px #5ac8fa,
                        0 0 15px rgba(90, 200, 250, 0.5);
                }

                33% {
                    box-shadow:
                        inset 0 0 0 3px #bf5af2,
                        0 0 15px rgba(191, 90, 242, 0.5);
                }

                50% {
                    box-shadow:
                        inset 0 0 0 3px #ff375f,
                        0 0 15px rgba(255, 55, 95, 0.5);
                }

                66% {
                    box-shadow:
                        inset 0 0 0 3px #ff9f0a,
                        0 0 15px rgba(255, 159, 10, 0.5);
                }

                83% {
                    box-shadow:
                        inset 0 0 0 3px #30d158,
                        0 0 15px rgba(48, 209, 88, 0.5);
                }

                100% {
                    box-shadow:
                        inset 0 0 0 3px #0a84ff,
                        0 0 15px rgba(10, 132, 255, 0.5);
                }
            }

            .reward-led-border svg {
                display: none;
            }

            /* CTA Button - Apple Style */
            .reward-cta {
                width: 100%;
                padding: 16px 24px;
                border: none;
                border-radius: 14px;
                font-size: 1.0625rem;
                font-weight: 600;
                color: white;
                background: #0a84ff;
                cursor: pointer;
                transition: all 0.2s ease;
                opacity: 0;
                transform: translateY(8px);
                pointer-events: none;
                margin-top: 8px;
            }

            .reward-cta.visible {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }

            .reward-cta:hover {
                background: #0077ed;
                transform: scale(1.01);
            }

            .reward-cta:active {
                transform: scale(0.98);
            }

            html:not(.dark) .reward-cta {
                background: #007aff;
            }

            html:not(.dark) .reward-cta:hover {
                background: #0066d6;
            }

            /* Mobile Optimization */
            @media (max-width: 480px) {
                .reward-modal {
                    padding: 16px;
                }

                .reward-container {
                    padding: 24px 20px;
                    border-radius: 24px;
                }

                .reward-card-wrapper {
                    max-height: 280px;
                    margin-bottom: 20px;
                }

                .reward-title {
                    font-size: 1.3rem;
                }

                .reward-icon {
                    font-size: 3.5rem;
                }

                .reward-icon img {
                    width: 80px;
                    height: 80px;
                }

                .reward-name {
                    font-size: 1.25rem;
                }
            }

            /* Glow Burst Effect */
            .reward-glow-burst {
                position: absolute;
                inset: 0;
                border-radius: 20px;
                pointer-events: none;
                z-index: 4;
                opacity: 0;
                background: radial-gradient(circle at center, rgba(255, 255, 255, 0.8) 0%, transparent 70%);
            }

            .reward-glow-burst.active {
                animation: glowBurst 0.8s ease-out forwards;
            }

            @keyframes glowBurst {
                0% {
                    opacity: 1;
                    transform: scale(0.5);
                }

                100% {
                    opacity: 0;
                    transform: scale(1.5);
                }
            }

            /* Shockwave Effect */
            .reward-shockwave {
                position: absolute;
                inset: 0;
                border-radius: 20px;
                pointer-events: none;
                z-index: 3;
                opacity: 0;
            }

            .reward-shockwave.active::before {
                content: '';
                position: absolute;
                inset: -20px;
                border: 3px solid rgba(10, 132, 255, 0.5);
                border-radius: 28px;
                animation: shockwaveRing 0.6s ease-out forwards;
            }

            @keyframes shockwaveRing {
                0% {
                    transform: scale(0.8);
                    opacity: 1;
                }

                100% {
                    transform: scale(1.3);
                    opacity: 0;
                }
            }

            /* Scratch Particles */
            .scratch-particles-container {
                position: absolute;
                inset: 0;
                pointer-events: none;
                z-index: 26;
                overflow: hidden;
                border-radius: 20px;
            }

            /* Performance Mode */
            html.perf .reward-modal,
            html.perf2 .reward-modal {
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
            }

            html.perf .reward-container,
            html.perf2 .reward-container {
                transition: opacity 0.3s ease;
            }

            html.perf .reward-icon,
            html.perf2 .reward-icon,
            html.perf .reward-mystery-icon,
            html.perf2 .reward-mystery-icon,
            html.perf .reward-scratch-layer,
            html.perf2 .reward-scratch-layer {
                animation: none !important;
            }

            html.perf .reward-led-border::after,
            html.perf2 .reward-led-border::after {
                animation: none !important;
                background-position: 0% 50%;
            }

            html.perf .reward-glow-burst,
            html.perf2 .reward-glow-burst,
            html.perf .reward-shockwave,
            html.perf2 .reward-shockwave {
                display: none !important;
            }

            @media (prefers-reduced-motion: reduce) {
                .reward-modal {
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                }

                .reward-container {
                    transition: opacity 0.3s ease;
                }

                .reward-icon,
                .reward-mystery-icon,
                .reward-scratch-layer,
                .reward-led-border::after {
                    animation: none !important;
                }

                .reward-glow-burst,
                .reward-shockwave {
                    display: none !important;
                }
            }

            /* ═══════════════════════════════════════════════════════════════
           SCRATCH CARD - PREMIUM LIGHT MODE ENHANCEMENTS
           Ultra-refined design for light theme
        ═══════════════════════════════════════════════════════════════ */

            /* === MODAL BACKDROP - SOPHISTICATED GLASS === */
            html:not(.dark) .reward-modal {
                background:
                    radial-gradient(ellipse at 30% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 45%),
                    radial-gradient(ellipse at 70% 80%, rgba(168, 85, 247, 0.06) 0%, transparent 45%),
                    radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.03) 0%, transparent 60%),
                    linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(241, 245, 249, 0.97) 100%);
                backdrop-filter: blur(24px) saturate(140%);
                -webkit-backdrop-filter: blur(24px) saturate(140%);
            }

            /* === CONTAINER - ELEGANT CARD WITH DEPTH === */
            html:not(.dark) .reward-container {
                background: linear-gradient(165deg,
                        rgba(255, 255, 255, 1) 0%,
                        rgba(248, 250, 252, 0.98) 50%,
                        rgba(241, 245, 249, 0.95) 100%);
                box-shadow:
                    0 30px 80px -20px rgba(99, 102, 241, 0.15),
                    0 20px 50px -15px rgba(0, 0, 0, 0.1),
                    0 4px 16px -4px rgba(0, 0, 0, 0.04),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.02);
                border: 1px solid rgba(99, 102, 241, 0.08);
            }

            /* === HEADER STYLING === */
            html:not(.dark) .reward-header {
                border-bottom: 1px solid rgba(99, 102, 241, 0.06);
                padding-bottom: 14px;
                margin-bottom: 18px;
            }

            html:not(.dark) .reward-title {
                color: #1e293b;
                background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                font-size: 1.35rem;
                letter-spacing: -0.01em;
            }

            html:not(.dark) .reward-subtitle {
                color: #64748b;
                font-size: 0.8rem;
                letter-spacing: 0.01em;
            }

            html:not(.dark) .reward-close-btn {
                background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
                border: 1px solid rgba(0, 0, 0, 0.06);
                color: #64748b;
                box-shadow:
                    0 2px 6px -2px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
            }

            html:not(.dark) .reward-close-btn:hover {
                background: linear-gradient(145deg, #fee2e2 0%, #fecaca 100%);
                border-color: rgba(239, 68, 68, 0.2);
                color: #ef4444;
                box-shadow: 0 4px 12px -3px rgba(239, 68, 68, 0.15);
            }

            /* === SCRATCH CARD WRAPPER === */
            html:not(.dark) .reward-card-wrapper {
                filter: drop-shadow(0 20px 40px rgba(99, 102, 241, 0.12));
            }

            /* === SCRATCH CARD BASE === */
            html:not(.dark) .reward-card {
                background: linear-gradient(165deg,
                        #ffffff 0%,
                        #f1f5f9 40%,
                        #e2e8f0 100%);
                box-shadow:
                    0 25px 60px -15px rgba(99, 102, 241, 0.2),
                    0 10px 30px -10px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9),
                    inset 0 -2px 6px rgba(0, 0, 0, 0.02);
                border: 1px solid rgba(99, 102, 241, 0.1);
            }

            /* === SCRATCH LAYER - GOLD PREMIUM === */
            html:not(.dark) .reward-scratch-layer {
                background:
                    linear-gradient(135deg,
                        #d4af37 0%,
                        /* Rich Gold */
                        #f5e7a3 20%,
                        /* Light Gold */
                        #c9a227 35%,
                        /* Deep Gold */
                        #e8d48a 50%,
                        /* Shimmer */
                        #c9a227 65%,
                        /* Deep Gold */
                        #f5e7a3 80%,
                        /* Light Gold */
                        #d4af37 100%
                        /* Rich Gold */
                    );
                background-size: 250% 250%;
                animation: goldShimmer 4s ease-in-out infinite;
                box-shadow:
                    inset 0 2px 6px rgba(255, 255, 255, 0.5),
                    inset 0 -2px 6px rgba(0, 0, 0, 0.1);
            }

            @keyframes goldShimmer {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            /* === SILVER VARIANT === */
            html:not(.dark) .reward-scratch-layer:not(.gold) {
                background:
                    linear-gradient(135deg,
                        #9ca3af 0%,
                        /* Cool Silver */
                        #e5e7eb 20%,
                        /* Light Silver */
                        #d1d5db 40%,
                        /* Mid Silver */
                        #f9fafb 50%,
                        /* Shimmer Peak */
                        #d1d5db 60%,
                        /* Mid Silver */
                        #e5e7eb 80%,
                        /* Light Silver */
                        #9ca3af 100%
                        /* Cool Silver */
                    );
                background-size: 250% 250%;
                animation: silverShimmer 4s ease-in-out infinite;
            }

            @keyframes silverShimmer {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            /* === MYSTERY OVERLAY === */
            html:not(.dark) .reward-mystery {
                background: linear-gradient(165deg,
                        rgba(248, 250, 252, 0.98) 0%,
                        rgba(241, 245, 249, 0.95) 50%,
                        rgba(226, 232, 240, 0.9) 100%);
                border: 1px solid rgba(99, 102, 241, 0.05);
            }

            html:not(.dark) .reward-mystery-icon {
                opacity: 0.65;
                filter: drop-shadow(0 4px 12px rgba(99, 102, 241, 0.15));
            }

            html:not(.dark) .reward-mystery-text {
                color: #64748b;
                font-weight: 800;
                letter-spacing: 0.15em;
            }

            /* === PROGRESS BAR === */
            html:not(.dark) .reward-progress-bar {
                background: rgba(0, 0, 0, 0.08) !important;
                border: none !important;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                height: 6px !important;
                border-radius: 99px !important;
            }

            html:not(.dark) .reward-progress-fill {
                background: linear-gradient(90deg,
                        #f59e0b 0%,
                        #fbbf24 40%,
                        #fcd34d 60%,
                        #fbbf24 100%);
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.35);
            }

            html:not(.dark) .reward-progress-text {
                background: linear-gradient(to right,
                        #1e293b 0%,
                        #64748b 50%,
                        #1e293b 100%);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                background-size: 200% auto;
                font-weight: 800;
            }

            /* === CTA BUTTON === */
            html:not(.dark) .reward-cta {
                background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                box-shadow:
                    0 10px 30px -8px rgba(99, 102, 241, 0.4),
                    0 4px 12px -4px rgba(139, 92, 246, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            html:not(.dark) .reward-cta:hover {
                box-shadow:
                    0 15px 40px -10px rgba(99, 102, 241, 0.5),
                    0 6px 16px -5px rgba(139, 92, 246, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.25);
                transform: translateY(-3px);
            }

            /* === LED BORDER LIGHT MODE === */
            /* Uses same animated box-shadow as dark mode, no overrides needed */

            html:not(.dark) .reward-led-border.complete {
                box-shadow:
                    inset 0 0 0 3px rgba(99, 102, 241, 0.8),
                    0 0 35px rgba(99, 102, 241, 0.35),
                    0 0 70px rgba(168, 85, 247, 0.2);
                animation: none;
            }

            /* === REVEALED STATE === */
            html:not(.dark) .reward-reveal {
                background: linear-gradient(180deg,
                        rgba(255, 255, 255, 0.98) 0%,
                        rgba(248, 250, 252, 0.95) 100%);
                transform: scale(0.95);
                opacity: 0;
                transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            }

            html:not(.dark) .reward-reveal.revealed {
                transform: scale(1);
                opacity: 1;
            }

            @keyframes rewardPop {
                0% {
                    transform: scale(0.9);
                    opacity: 0;
                }

                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            html:not(.dark) .reward-icon {
                filter: drop-shadow(0 8px 24px rgba(99, 102, 241, 0.25));
            }

            html:not(.dark) .reward-name {
                background: linear-gradient(135deg,
                        #1e293b 0%,
                        #475569 50%,
                        #334155 100%);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            html:not(.dark) .reward-desc {
                color: #64748b;
                line-height: 1.7;
            }

            /* === Rarity badges light mode refinements === */
            html:not(.dark) .reward-rarity.common {
                background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
                color: #475569;
                border: 1px solid rgba(71, 85, 105, 0.2);
            }

            html:not(.dark) .reward-rarity.rare {
                background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
                color: #2563eb;
                border: 1px solid rgba(59, 130, 246, 0.25);
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
            }

            html:not(.dark) .reward-rarity.epic {
                background: linear-gradient(145deg, #faf5ff 0%, #f3e8ff 100%);
                color: #9333ea;
                border: 1px solid rgba(168, 85, 247, 0.25);
                box-shadow: 0 4px 15px rgba(168, 85, 247, 0.15);
            }

            html:not(.dark) .reward-rarity.legendary {
                background: linear-gradient(145deg, #fffbeb 0%, #fef3c7 100%);
                color: #d97706;
                border: 1px solid rgba(245, 158, 11, 0.35);
                box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
            }

            /* ═══════════════════════════════════════════════════════════════
           SCRATCH CARD - PREMIUM DARK MODE ENHANCEMENTS
           Ultra-refined design for dark theme
        ═══════════════════════════════════════════════════════════════ */

            /* === MODAL BACKDROP - SOPHISTICATED DARK GLASS === */
            html.dark .reward-modal {
                background:
                    radial-gradient(ellipse at 30% 20%, rgba(99, 102, 241, 0.12) 0%, transparent 45%),
                    radial-gradient(ellipse at 70% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 45%),
                    radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 60%),
                    linear-gradient(180deg, rgba(15, 23, 42, 0.97) 0%, rgba(2, 6, 23, 0.99) 100%);
                backdrop-filter: blur(30px) saturate(150%);
                -webkit-backdrop-filter: blur(30px) saturate(150%);
            }

            /* === CONTAINER - ELEGANT DARK CARD WITH DEPTH === */
            html.dark .reward-container {
                background: linear-gradient(165deg,
                        rgba(30, 41, 59, 0.98) 0%,
                        rgba(15, 23, 42, 0.99) 50%,
                        rgba(2, 6, 23, 0.98) 100%);
                box-shadow:
                    0 30px 80px -20px rgba(0, 0, 0, 0.6),
                    0 20px 50px -15px rgba(99, 102, 241, 0.15),
                    0 4px 16px -4px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.08),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(99, 102, 241, 0.15);
            }

            /* ═══════════════════════════════════════════════════════════════════════════
               PREMIUM SCRATCH CARD STYLING (Apple Design Award Style)
               ═══════════════════════════════════════════════════════════════════════════ */

            /* --- Header: Clean & Sophisticated --- */
            .reward-header {
                padding: 24px 24px 16px 24px;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
                text-align: left;
                background: transparent;
                border-bottom: none;
            }

            .reward-title-group {
                flex: 1;
            }

            .reward-title {
                font-size: 22px;
                font-weight: 700;
                color: #000000;
                letter-spacing: -0.02em;
                margin-bottom: 4px;
                line-height: 1.2;
                background: none;
                -webkit-text-fill-color: initial;
                text-shadow: none;
            }

            .reward-subtitle {
                font-size: 15px;
                color: rgba(60, 60, 67, 0.6);
                font-weight: 400;
                letter-spacing: -0.01em;
            }

            html.dark .reward-title {
                color: #FFFFFF;
                background: none;
                -webkit-text-fill-color: initial;
            }

            html.dark .reward-subtitle {
                color: rgba(235, 235, 245, 0.6);
            }

            /* --- Close Button: Ghost Style --- */
            .reward-close-btn {
                background: rgba(120, 120, 128, 0.12);
                border: none;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                color: rgba(60, 60, 67, 0.6);
                font-size: 14px;
                font-weight: 700;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
                margin-left: 12px;
                flex-shrink: 0;
                box-shadow: none;
            }

            html.dark .reward-close-btn {
                background: rgba(120, 120, 128, 0.24);
                color: rgba(235, 235, 245, 0.6);
                border: none;
                box-shadow: none;
            }

            .reward-close-btn:hover {
                background: rgba(120, 120, 128, 0.2);
                transform: scale(1.05);
                color: rgba(60, 60, 67, 0.8);
            }

            html.dark .reward-close-btn:hover {
                background: rgba(120, 120, 128, 0.32);
                color: white;
                box-shadow: none;
                border: none;
            }

            .reward-close-btn:active {
                transform: scale(0.92);
            }

            /* --- Card Wrapper & Base --- */
            .reward-card-wrapper {
                padding: 0 24px 24px 24px;
                position: relative;
                perspective: 1000px;
                filter: none !important;
            }

            .reward-card {
                position: relative;
                width: 100%;
                aspect-ratio: 4/5;
                border-radius: 24px;
                overflow: hidden;
                /* Light Mode Base */
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                box-shadow:
                    0 10px 30px -5px rgba(0, 0, 0, 0.1),
                    inset 0 0 0 1px rgba(0, 0, 0, 0.05);
                border: none;
            }

            html.dark .reward-card {
                /* Dark Mode Base */
                background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
                box-shadow:
                    0 20px 50px -10px rgba(0, 0, 0, 0.5),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.1);
                border: none;
            }

            /* --- Scratch Layer (Metallic) --- */
            .reward-scratch-layer {
                border-radius: 24px;
            }

            /* Reset old overrides */
            html.dark .reward-scratch-layer.gold,
            html.dark .reward-scratch-layer:not(.gold) {
                background: none;
                animation: none;
                box-shadow: none;
            }

            /* --- Progress Bar --- */
            .reward-progress {
                padding: 0 24px 24px 24px;
            }

            .reward-progress-text {
                font-size: 12px;
                font-weight: 500;
                color: rgba(60, 60, 67, 0.6);
                text-align: center;
                margin-bottom: 8px;
                background: none;
                -webkit-text-fill-color: initial;
            }

            html.dark .reward-progress-text {
                color: rgba(235, 235, 245, 0.6);
                background: none;
                -webkit-text-fill-color: initial;
            }

            .reward-progress-bar {
                height: 5px;
                background: rgba(0, 0, 0, 0.06);
                border-radius: 3px;
                overflow: hidden;
            }

            html.dark .reward-progress-bar {
                background: rgba(255, 255, 255, 0.15) !important;
                height: 5px !important;
                box-shadow: none !important;
                border: none !important;
            }

            .reward-progress-fill {
                height: 100%;
                background: #007AFF;
                border-radius: 3px;
                transition: width 0.1s linear;
            }

            html.dark .reward-progress-fill {
                background: #0A84FF !important;
                box-shadow: 0 0 10px rgba(10, 132, 255, 0.5) !important;
            }

            /* --- CTA Button --- */
            .reward-cta {
                width: calc(100% - 48px);
                margin: 0 24px 24px 24px;
                padding: 16px;
                background: #007AFF;
                color: white;
                border: none;
                border-radius: 16px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: transform 0.1s ease, opacity 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            }

            html.dark .reward-cta {
                background: #0A84FF;
                box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
            }

            .reward-cta:active {
                transform: scale(0.96);
            }

            /* --- Mystery Overlay (Removed/Hidden) --- */
            .reward-mystery {
                display: none !important;
            }

            .reward-progress *,
            .reward-progress::before,
            .reward-progress::after,
            .reward-progress-bar::before,
            .reward-progress-bar::after,
            .reward-modal [style*="blue"],
            .reward-modal [style*="#3b82f6"],
            .reward-modal [style*="#2563eb"] {
                border-color: transparent !important;
            }

            .reward-progress>div:not(.reward-progress-bar) {
                background: transparent !important;
                border: none !important;
            }

            /* === CTA BUTTON DARK === */
            html.dark .reward-cta {
                background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
                box-shadow:
                    0 12px 35px -8px rgba(99, 102, 241, 0.5),
                    0 6px 18px -4px rgba(139, 92, 246, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15),
                    0 0 40px rgba(99, 102, 241, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            html.dark .reward-cta:hover {
                box-shadow:
                    0 18px 50px -10px rgba(99, 102, 241, 0.6),
                    0 8px 24px -5px rgba(139, 92, 246, 0.5),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2),
                    0 0 60px rgba(139, 92, 246, 0.25);
                transform: translateY(-3px);
            }

            /* === LED BORDER DARK MODE - Hidden by default === */
            html.dark .reward-led-border {
                opacity: 0 !important;
                visibility: hidden !important;
                transition: opacity 0.3s ease, visibility 0.3s ease;
            }

            html.dark .reward-led-border.active,
            html.dark .reward-led-border.complete {
                opacity: 1 !important;
                visibility: visible !important;
                background: linear-gradient(45deg,
                        #22c55e 0%,
                        #3b82f6 25%,
                        #a855f7 50%,
                        #ec4899 75%,
                        #22c55e 100%) border-box;
            }

            html.dark .reward-led-border.complete {
                box-shadow:
                    0 0 40px rgba(99, 102, 241, 0.5),
                    0 0 80px rgba(168, 85, 247, 0.35),
                    0 0 120px rgba(236, 72, 153, 0.2);
            }

            /* === REVEALED STATE DARK === */
            html.dark .reward-reveal {
                background: linear-gradient(180deg,
                        rgba(30, 41, 59, 0.98) 0%,
                        rgba(15, 23, 42, 0.95) 100%);
                transform: scale(0.95);
                opacity: 0;
                transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            }

            html.dark .reward-reveal.revealed {
                transform: scale(1);
                opacity: 1;
            }

            html.dark .reward-icon {
                filter:
                    drop-shadow(0 10px 30px rgba(99, 102, 241, 0.35)) drop-shadow(0 4px 12px rgba(0, 0, 0, 0.5));
            }

            html.dark .reward-name {
                background: linear-gradient(135deg,
                        #ffffff 0%,
                        #e2e8f0 40%,
                        #cbd5e1 100%);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                text-shadow: none;
            }

            html.dark .reward-desc {
                color: #94a3b8;
                line-height: 1.7;
            }

            /* === Rarity badges dark mode refinements === */
            html.dark .reward-rarity.common {
                background: linear-gradient(145deg, rgba(71, 85, 105, 0.3) 0%, rgba(51, 65, 85, 0.4) 100%);
                color: #94a3b8;
                border: 1px solid rgba(148, 163, 184, 0.2);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
            }

            html.dark .reward-rarity.rare {
                background: linear-gradient(145deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.25) 100%);
                color: #60a5fa;
                border: 1px solid rgba(59, 130, 246, 0.35);
                box-shadow:
                    0 6px 20px rgba(59, 130, 246, 0.25),
                    0 0 30px rgba(59, 130, 246, 0.15),
                    inset 0 1px 0 rgba(96, 165, 250, 0.1);
            }

            html.dark .reward-rarity.epic {
                background: linear-gradient(145deg, rgba(168, 85, 247, 0.2) 0%, rgba(147, 51, 234, 0.25) 100%);
                color: #c084fc;
                border: 1px solid rgba(168, 85, 247, 0.35);
                box-shadow:
                    0 6px 20px rgba(168, 85, 247, 0.25),
                    0 0 30px rgba(168, 85, 247, 0.15),
                    inset 0 1px 0 rgba(192, 132, 252, 0.1);
            }

            html.dark .reward-rarity.legendary {
                background: linear-gradient(145deg, rgba(245, 158, 11, 0.25) 0%, rgba(217, 119, 6, 0.3) 100%);
                color: #fbbf24;
                border: 1px solid rgba(245, 158, 11, 0.45);
                box-shadow:
                    0 8px 25px rgba(245, 158, 11, 0.3),
                    0 0 40px rgba(245, 158, 11, 0.2),
                    inset 0 1px 0 rgba(251, 191, 36, 0.15);
                animation: legendaryGlowDark 2s infinite ease-in-out;
            }

            @keyframes legendaryGlowDark {

                0%,
                100% {
                    box-shadow:
                        0 8px 25px rgba(245, 158, 11, 0.3),
                        0 0 40px rgba(245, 158, 11, 0.2);
                }

                50% {
                    box-shadow:
                        0 10px 35px rgba(245, 158, 11, 0.45),
                        0 0 60px rgba(245, 158, 11, 0.35);
                }
            }

            /* 3D Utility Classes */
            .perspective-1000 {
                perspective: 1000px;
            }

            .transform-style-3d {
                transform-style: preserve-3d;
            }

            .rotate-y-180 {
                transform: rotateY(180deg);
            }

            .backface-hidden {
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
            }

            .nft-card {
                transform-style: preserve-3d;
            }

            .nft-content {
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
            }

            .nft-card .backside {
                transform: rotateY(180deg);
            }

            /* --- 3D TILT & HOLOGRAPHIC EFFECT --- */
            .tilt-container {
                perspective: 1000px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .tilt-card {
                width: 300px;
                height: 480px;
                position: relative;
                border-radius: 24px;
                background: linear-gradient(135deg, #1e1e2e, #2d2d44);
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
                transform-style: preserve-3d;
                transition: transform 0.1s ease-out;
                /* Hareket anında hızlı tepki */
                overflow: hidden;
            }

            /* Kart serbest bırakıldığında yumuşak dönüş */
            .tilt-card.smooth-reset {
                transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            }

            .tilt-content {
                transform: translateZ(60px);
                /* İçerik havada dursun */
                pointer-events: none;
                /* Tıklamayı engelleme */
            }

            /* Işık Yansıması */
            .tilt-glare {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.3) 0%, transparent 60%);
                opacity: 0;
                pointer-events: none;
                mix-blend-mode: overlay;
                transition: opacity 0.2s;
                transform: translateZ(1px);
            }

            .rarity-badge-glow {
                box-shadow: 0 0 15px currentColor;
            }

            /* --- NFT MODAL PERSPECTIVE --- */
            .nft-modal-perspective {
                perspective: 1500px;
                overflow: visible;
            }


            /* === ULTRA PREMIUM BADGE RARITY SYSTEM === */

            /* Common - Subtle Steel */
            .border-common {
                border: 2px solid #52525b;
                box-shadow:
                    0 0 10px rgba(82, 82, 91, 0.3),
                    inset 0 0 20px rgba(255, 255, 255, 0.03);
            }

            /* Rare - Electric Blue */
            .border-rare {
                border: 2px solid #3b82f6;
                box-shadow:
                    0 0 20px rgba(59, 130, 246, 0.4),
                    0 0 40px rgba(59, 130, 246, 0.2),
                    inset 0 0 30px rgba(59, 130, 246, 0.1);
                animation: rare-pulse 3s ease-in-out infinite;
            }

            @keyframes rare-pulse {

                0%,
                100% {
                    box-shadow: 0 0 20px rgba(59, 130, 246, 0.4), 0 0 40px rgba(59, 130, 246, 0.2);
                }

                50% {
                    box-shadow: 0 0 30px rgba(59, 130, 246, 0.6), 0 0 60px rgba(59, 130, 246, 0.3);
                }
            }

            /* Epic - Royal Purple */
            .border-epic {
                border: 2px solid #a855f7;
                box-shadow:
                    0 0 25px rgba(168, 85, 247, 0.5),
                    0 0 50px rgba(168, 85, 247, 0.3),
                    0 0 80px rgba(168, 85, 247, 0.15),
                    inset 0 0 40px rgba(168, 85, 247, 0.1);
                animation: epic-glow 2.5s ease-in-out infinite;
            }

            @keyframes epic-glow {

                0%,
                100% {
                    box-shadow: 0 0 25px rgba(168, 85, 247, 0.5), 0 0 50px rgba(168, 85, 247, 0.3);
                    border-color: #a855f7;
                }

                50% {
                    box-shadow: 0 0 40px rgba(168, 85, 247, 0.7), 0 0 80px rgba(168, 85, 247, 0.4);
                    border-color: #c084fc;
                }
            }

            /* Legendary - Animated Golden Rainbow */
            .border-legendary {
                border: 3px solid transparent;
                background: linear-gradient(#18181b, #18181b) padding-box,
                    linear-gradient(135deg, #f59e0b, #fbbf24, #f59e0b, #d97706) border-box;
                box-shadow:
                    0 0 30px rgba(245, 158, 11, 0.5),
                    0 0 60px rgba(245, 158, 11, 0.3),
                    0 0 100px rgba(245, 158, 11, 0.2),
                    inset 0 0 50px rgba(245, 158, 11, 0.1);
                animation: legendary-shimmer 3s linear infinite;
            }

            @keyframes legendary-shimmer {
                0% {
                    background: linear-gradient(#18181b, #18181b) padding-box,
                        linear-gradient(0deg, #f59e0b, #fbbf24, #f59e0b, #d97706) border-box;
                }

                100% {
                    background: linear-gradient(#18181b, #18181b) padding-box,
                        linear-gradient(360deg, #f59e0b, #fbbf24, #f59e0b, #d97706) border-box;
                }
            }

            /* Mythic - Animated RGB Rainbow Border */
            .border-mythic {
                border: 3px solid transparent;
                background: linear-gradient(#0a0a0f, #0a0a0f) padding-box,
                    linear-gradient(var(--mythic-angle, 0deg), #ef4444, #f97316, #eab308, #22c55e, #3b82f6, #8b5cf6, #ec4899, #ef4444) border-box;
                box-shadow:
                    0 0 40px rgba(239, 68, 68, 0.5),
                    0 0 80px rgba(168, 85, 247, 0.4),
                    0 0 120px rgba(59, 130, 246, 0.3),
                    inset 0 0 60px rgba(239, 68, 68, 0.15);
                animation: mythic-rainbow 4s linear infinite, mythic-pulse 2s ease-in-out infinite;
            }

            @keyframes mythic-rainbow {
                0% {
                    --mythic-angle: 0deg;
                    filter: hue-rotate(0deg);
                }

                100% {
                    --mythic-angle: 360deg;
                    filter: hue-rotate(360deg);
                }
            }

            @keyframes mythic-pulse {

                0%,
                100% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.02);
                }
            }

            /* === APPLE FITNESS+ AWARDS BADGE STYLES === */

            /* Bento Grid Badge Card */
            .badge-bento-card {
                position: relative;
                aspect-ratio: 1;
                border-radius: 24px;
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                overflow: hidden;
                cursor: pointer;
                transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .badge-bento-card:hover {
                transform: translateY(-4px) scale(1.02);
                border-color: rgba(255, 255, 255, 0.15);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            }

            /* Kazanılmış rozet - Levitation efekti */
            .badge-unlocked .badge-icon-float {
                transform: translateY(-8px);
                filter: drop-shadow(0 15px 25px rgba(0, 0, 0, 0.4));
                animation: badgeLevitate 4s ease-in-out infinite;
            }

            /* Ambient Glow - kazanılmış rozetler */
            .badge-ambient-glow {
                position: absolute;
                inset: -20%;
                background: radial-gradient(circle at 50% 50%, var(--glow-color, rgba(99, 102, 241, 0.3)) 0%, transparent 70%);
                opacity: 0;
                transition: opacity 0.5s ease;
                pointer-events: none;
                z-index: 0;
            }

            .badge-unlocked .badge-ambient-glow {
                opacity: 1;
                animation: ambientPulse 3s ease-in-out infinite;
            }

            /* Kazanılmamış rozet - Frosted silhouette */
            .badge-locked {
                filter: grayscale(1);
            }

            .badge-locked .badge-icon-float {
                opacity: 0.25;
                filter: blur(2px) grayscale(1);
            }

            .badge-locked::after {
                content: '🔒';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 1.5rem;
                z-index: 10;
                filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.5));
            }

            @keyframes badgeLevitate {

                0%,
                100% {
                    transform: translateY(-8px);
                }

                50% {
                    transform: translateY(-14px);
                }
            }

            @keyframes ambientPulse {

                0%,
                100% {
                    opacity: 0.6;
                    transform: scale(1);
                }

                50% {
                    opacity: 1;
                    transform: scale(1.1);
                }
            }

            /* === SHOWCASE MODAL - SINEMATIK SAHNE === */
            .badge-showcase-modal {
                background: linear-gradient(180deg, #0f1419 0%, #000000 100%);
            }

            /* Sahne Işığı - Konik huzme */
            .badge-stage-light {
                position: absolute;
                top: -10%;
                left: 50%;
                transform: translateX(-50%);
                width: 300px;
                height: 400px;
                background: conic-gradient(from 180deg at 50% 0%,
                        transparent 30%,
                        rgba(255, 215, 0, 0.08) 45%,
                        rgba(255, 255, 255, 0.12) 50%,
                        rgba(255, 215, 0, 0.08) 55%,
                        transparent 70%);
                pointer-events: none;
                z-index: 1;
            }

            /* Badge 3D Floating animasyonu */
            .badge-3d-showcase {
                animation: floatShowcase 6s ease-in-out infinite;
                filter: drop-shadow(0 30px 50px rgba(0, 0, 0, 0.6));
            }

            @keyframes floatShowcase {

                0%,
                100% {
                    transform: translateY(0) scale(1) rotateY(0deg);
                    filter: drop-shadow(0 30px 50px rgba(0, 0, 0, 0.6));
                }

                25% {
                    transform: translateY(-20px) scale(1.02) rotateY(5deg);
                    filter: drop-shadow(0 50px 70px rgba(0, 0, 0, 0.4));
                }

                50% {
                    transform: translateY(-25px) scale(1.03) rotateY(0deg);
                    filter: drop-shadow(0 60px 80px rgba(0, 0, 0, 0.35));
                }

                75% {
                    transform: translateY(-20px) scale(1.02) rotateY(-5deg);
                    filter: drop-shadow(0 50px 70px rgba(0, 0, 0, 0.4));
                }
            }

            /* Yansıma (Reflection) efekti */
            .badge-reflection {
                position: absolute;
                bottom: -80%;
                left: 50%;
                transform: translateX(-50%) scaleY(-1);
                opacity: 0.15;
                filter: blur(4px);
                -webkit-mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.4) 0%, transparent 60%);
                mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.4) 0%, transparent 60%);
                pointer-events: none;
            }

            /* Apple-style tipografi */
            .badge-title-thin {
                font-weight: 200;
                letter-spacing: 0.1em;
            }

            .badge-title-bold {
                font-weight: 800;
                letter-spacing: -0.02em;
            }

            .badge-desc-silver {
                color: #8e8e93;
                font-weight: 500;
            }

            /* Rarity Ring Glow */
            .rarity-ring {
                position: absolute;
                inset: -2px;
                border-radius: 26px;
                padding: 2px;
                background: var(--rarity-gradient);
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .badge-bento-card:hover .rarity-ring {
                opacity: 1;
            }

            /* Rarity gradients */
            .rarity-common {
                --rarity-gradient: linear-gradient(135deg, #9ca3af, #6b7280);
                --glow-color: rgba(156, 163, 175, 0.3);
            }

            .rarity-rare {
                --rarity-gradient: linear-gradient(135deg, #60a5fa, #3b82f6);
                --glow-color: rgba(59, 130, 246, 0.4);
            }

            .rarity-epic {
                --rarity-gradient: linear-gradient(135deg, #c084fc, #a855f7);
                --glow-color: rgba(168, 85, 247, 0.4);
            }

            .rarity-legendary {
                --rarity-gradient: linear-gradient(135deg, #fbbf24, #f59e0b);
                --glow-color: rgba(245, 158, 11, 0.4);
            }

            .rarity-mythic {
                --rarity-gradient: linear-gradient(135deg, #f87171, #ef4444, #f472b6);
                --glow-color: rgba(239, 68, 68, 0.4);
            }

            /* === ULTRA 3D BADGE CARD ENHANCEMENTS === */
            .premium-3d-card {
                width: 320px;
                height: 480px;
                position: relative;
                transform-style: preserve-3d;
                border-radius: 28px;
                background: linear-gradient(165deg, #1a1a2e 0%, #0d0d15 50%, #0a0a12 100%);
                box-shadow:
                    0 30px 80px rgba(0, 0, 0, 0.6),
                    0 15px 40px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
                transition: transform 0.1s ease-out, box-shadow 0.3s ease;
            }

            .premium-3d-card:hover {
                box-shadow:
                    0 50px 100px rgba(0, 0, 0, 0.7),
                    0 25px 60px rgba(0, 0, 0, 0.5),
                    0 0 80px var(--card-glow-color, rgba(99, 102, 241, 0.3));
            }

            /* Rainbow Holographic Overlay */
            .holo-rainbow {
                position: absolute;
                inset: 0;
                border-radius: 28px;
                background: linear-gradient(135deg,
                        rgba(255, 0, 0, 0.1) 0%,
                        rgba(255, 127, 0, 0.1) 14%,
                        rgba(255, 255, 0, 0.1) 28%,
                        rgba(0, 255, 0, 0.1) 42%,
                        rgba(0, 0, 255, 0.1) 57%,
                        rgba(75, 0, 130, 0.1) 71%,
                        rgba(143, 0, 255, 0.1) 85%,
                        rgba(255, 0, 0, 0.1) 100%);
                opacity: 0;
                mix-blend-mode: color-dodge;
                transition: opacity 0.3s ease;
                pointer-events: none;
                z-index: 40;
            }

            .premium-3d-card:hover .holo-rainbow {
                opacity: 0.6;
                animation: rainbow-shift 3s linear infinite;
            }

            @keyframes rainbow-shift {
                0% {
                    filter: hue-rotate(0deg);
                }

                100% {
                    filter: hue-rotate(360deg);
                }
            }

            /* Enhanced Holographic Sheen */
            .holo-sheen {
                position: absolute;
                inset: 0;
                border-radius: 28px;
                background: linear-gradient(115deg,
                        transparent 0%,
                        rgba(255, 255, 255, 0.02) 20%,
                        rgba(255, 255, 255, 0.15) 40%,
                        rgba(255, 255, 255, 0.4) 50%,
                        rgba(255, 255, 255, 0.15) 60%,
                        rgba(255, 255, 255, 0.02) 80%,
                        transparent 100%);
                opacity: 0;
                pointer-events: none;
                mix-blend-mode: overlay;
                z-index: 60;
                transition: opacity 0.2s ease, transform 0.1s ease;
                transform: translateX(-100%);
            }

            .premium-3d-card:hover .holo-sheen {
                opacity: 1;
                animation: sheen-sweep 1.5s ease-in-out;
            }

            @keyframes sheen-sweep {
                0% {
                    transform: translateX(-100%) rotate(-10deg);
                }

                100% {
                    transform: translateX(100%) rotate(-10deg);
                }
            }

            /* Parallax Depth Layers */
            .layer-bg {
                transform: translateZ(0px);
            }

            .layer-low {
                transform: translateZ(15px);
            }

            .layer-mid {
                transform: translateZ(35px);
            }

            .layer-high {
                transform: translateZ(55px);
            }

            .layer-top {
                transform: translateZ(75px);
            }

            .layer-floating {
                transform: translateZ(100px);
                filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
            }

            /* Badge Icon Glow Effect */
            .badge-icon-glow {
                filter: drop-shadow(0 0 20px currentColor);
                transition: filter 0.3s ease, transform 0.3s ease;
            }

            .premium-3d-card:hover .badge-icon-glow {
                filter: drop-shadow(0 0 40px currentColor) drop-shadow(0 0 80px currentColor);
                transform: translateZ(120px) scale(1.1);
            }

            /* Sparkle Particles */
            @keyframes sparkle {

                0%,
                100% {
                    opacity: 0;
                    transform: scale(0) rotate(0deg);
                }

                50% {
                    opacity: 1;
                    transform: scale(1) rotate(180deg);
                }
            }

            .sparkle-particle {
                position: absolute;
                width: 4px;
                height: 4px;
                background: white;
                border-radius: 50%;
                pointer-events: none;
                animation: sparkle 2s ease-in-out infinite;
            }


            /* Trend Grafiği için Neon Parlama Efekti */
            #trendChart {
                filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.3));
                /* Hafif İndigo Gölge */
            }

            html.dark #trendChart {
                filter: drop-shadow(0 0 15px rgba(129, 140, 248, 0.5));
                /* Karanlık modda daha parlak */
            }

            /* --- CYBERPUNK MODAL UTILS --- */
            @keyframes modalEnter {
                0% {
                    opacity: 0;
                    transform: scale(0.95);
                }

                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .animate-modal-enter {
                animation: modalEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            }

            /* Confirm Modal Pop-in Animation */
            @keyframes confirmPop {
                from {
                    transform: translateY(14px) scale(.985);
                    opacity: 0;
                }

                to {
                    transform: none;
                    opacity: 1;
                }
            }

            #confirm-modal:not(.hidden) .glass-card {
                animation: confirmPop 180ms ease both;
            }

            .bg-grid-slate-800 {
                background-image:
                    linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
                background-size: 20px 20px;
            }

            @keyframes shimmer {
                0% {
                    transform: translateX(-100%);
                }

                100% {
                    transform: translateX(100%);
                }
            }

            .animate-shimmer {
                animation: shimmer 4s infinite linear;
            }

            /* --- GİZLİLİK MODU (PRIVACY BLUR) --- */
            /* Body'de 'privacy-active' sınıfı varsa, aşağıdaki ID'leri bulanıklaştır */

            body.privacy-active #display-balance,
            /* Net Nakit */
            body.privacy-active #display-savings-total,
            /* Toplam Birikim */
            body.privacy-active #display-income,
            /* Gelir Kutusu */
            body.privacy-active #display-expense,
            /* Gider Kutusu */
            body.privacy-active #dashboard-installment-total,
            /* Taksit Widget */
            body.privacy-active #loan-monthly,
            /* Kredi Hesap Sonucu */
            body.privacy-active #goals-list span:first-child,
            /* Hedef Listesi Tutarları */

            /* --- YENİ EKLENEN ALANLAR --- */
            body.privacy-active #dash-goal-percent,
            /* Hedef Kumbarası Yüzdesi */
            body.privacy-active #mainChart,
            /* Finansal İçgörü Grafiği */
            body.privacy-active #category-top-list,
            /* Finansal İçgörü Listesi */
            body.privacy-active #health-status-content h2,
            /* Finansal Sağlık Puanı */
            body.privacy-active #health-status-content .mt-3,
            /* Sağlık Kartı Alt Gelir/Gider */
            body.privacy-active #recent-transactions-list .text-right p,
            /* Son İşlemler Tutarları */
            body.privacy-active #full-history-list .text-right p,
            /* Geçmiş İşlemler Tutarları */
            body.privacy-active .money-value

            /* Genel Para Değerleri */
                {
                filter: blur(8px);
                /* Buzlama Efekti */
                user-select: none;
                /* Seçilmeyi Engelle */
                transition: filter 0.3s ease;
                /* Yumuşak Geçiş */
                opacity: 0.6;
                /* Hafif Silikleştir */
            }

            /* --- ANTIGRAVITY (AG) ASSISTANT STYLES (LIGHT & DARK) --- */
            .ag-perspective {
                perspective: 1500px;
                overflow: hidden;
                /* Light Mode: Ferah Laboratuvar HavasÄ± */
                background-color: #f3f4f6;
                background-image:
                    radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.05), transparent 25%),
                    radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.05), transparent 25%);
            }

            html.dark .ag-perspective {
                /* Dark Mode: Derin Uzay */
                background-color: #050507;
                background-image:
                    radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15), transparent 25%),
                    radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.15), transparent 25%);
            }

            /* YÃ¼zen Kart YapÄ±sÄ± */
            .ag-card {
                transform-style: preserve-3d;
                /* Light Mode: Buzlu Beyaz Cam */
                background: rgba(255, 255, 255, 0.65);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.6);
                box-shadow:
                    0 20px 40px -10px rgba(0, 0, 0, 0.1),
                    0 0 20px rgba(99, 102, 241, 0.05),
                    inset 0 0 20px rgba(255, 255, 255, 0.5);
                color: #1f2937;
                animation: ag-float 8s ease-in-out infinite;
                border-radius: 32px;
            }

            html.dark .ag-card {
                /* Dark Mode: Koyu Transparan */
                background: rgba(20, 20, 28, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow:
                    0 25px 50px -12px rgba(0, 0, 0, 0.8),
                    0 0 40px rgba(99, 102, 241, 0.15),
                    inset 0 0 20px rgba(255, 255, 255, 0.03);
                color: white;
            }

            .ag-delay-1 {
                animation-delay: -2s;
            }

            .ag-delay-2 {
                animation-delay: -4s;
            }

            @keyframes ag-float {

                0%,
                100% {
                    transform: translateY(0) rotateX(0);
                }

                50% {
                    transform: translateY(-12px) rotateX(2deg);
                }
            }

            /* Neon Input AlanÄ± */
            .ag-input {
                /* Light Mode */
                background: rgba(255, 255, 255, 0.8);
                border: 1px solid rgba(209, 213, 219, 0.6);
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
                color: #111827;
                transition: all 0.3s ease;
            }

            html.dark .ag-input {
                /* Dark Mode */
                background: rgba(0, 0, 0, 0.4);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
                color: white;
            }

            .ag-input:focus {
                /* Ortak Focus */
                background: rgba(255, 255, 255, 1);
                border-color: #6366F1;
                box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
                outline: none;
            }

            html.dark .ag-input:focus {
                background: rgba(0, 0, 0, 0.6);
            }

            /* AI Mesaj BaloncuklarÄ± */
            .ag-bubble-user {
                background: linear-gradient(135deg, #6366F1, #8B5CF6);
                box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                border-radius: 20px 20px 4px 20px;
            }

            .ag-bubble-ai {
                /* Light Mode */
                background: rgba(255, 255, 255, 0.8);
                border: 1px solid rgba(229, 231, 235, 0.8);
                color: #374151;
                backdrop-filter: blur(10px);
                border-radius: 20px 20px 20px 4px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            html.dark .ag-bubble-ai {
                /* Dark Mode */
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #e2e8f0;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }

            /* Avatar Ã‡ekirdeÄŸi */
            .ai-core-ring {
                position: absolute;
                inset: -4px;
                border-radius: 50%;
                border: 2px solid transparent;
                border-top-color: #6366F1;
                border-right-color: #8B5CF6;
                animation: spin-slow 6s linear infinite;
                opacity: 0.8;
                box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
            }

            /* --- YENİ NESİL 3D ROZETLER (AAA KALİTE) --- */
            .premium-badge-scene {
                perspective: 1000px;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 400px;
                /* Modal yüksekliği */
                overflow: visible;
            }

            .premium-badge-card {
                width: 240px;
                height: 360px;
                position: relative;
                border-radius: 24px;
                transform-style: preserve-3d;
                transition: transform 0.1s ease-out;
                /* Mouse takibi için hızlı tepki */
                box-shadow: 0 30px 60px -10px rgba(0, 0, 0, 0.8);
                background-size: cover;
                background-position: center;
            }

            /* Kart Kenar Parlaması */
            .premium-badge-card::after {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: 24px;
                padding: 2px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.5), transparent 40%, rgba(255, 255, 255, 0.2));
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                pointer-events: none;
            }

            /* Nadirlik Arka Planları (Cyberpunk Stil) */
            .bg-rarity-common {
                background: linear-gradient(145deg, #27272a, #09090b);
                border: 1px solid #3f3f46;
            }

            .bg-rarity-rare {
                background: linear-gradient(145deg, #172554, #020617);
                border: 1px solid #1e40af;
                box-shadow: 0 0 20px rgba(30, 64, 175, 0.3);
            }

            .bg-rarity-epic {
                background: linear-gradient(145deg, #4c1d95, #2e1065);
                border: 1px solid #7c3aed;
                box-shadow: 0 0 25px rgba(124, 58, 237, 0.4);
            }

            .bg-rarity-legendary {
                background: linear-gradient(145deg, #451a03, #000000);
                border: 1px solid #f59e0b;
                box-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
            }

            .bg-rarity-mythic {
                background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'), linear-gradient(145deg, #7f1d1d, #000000);
                background-blend-mode: overlay;
                border: 1px solid #ef4444;
                box-shadow: 0 0 40px rgba(239, 68, 68, 0.6);
            }

            /* Holografik Yansıma (Glare) */
            .holo-glare {
                position: absolute;
                inset: 0;
                border-radius: 24px;
                background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.25) 0%, transparent 60%);
                opacity: 0;
                pointer-events: none;
                mix-blend-mode: overlay;
                transform: translateZ(1px);
                /* Kartın üzerinde yüzsün */
                z-index: 50;
            }

            /* 3D Derinlik Katmanları */
            .layer-depth-1 {
                transform: translateZ(20px);
            }

            .layer-depth-2 {
                transform: translateZ(40px);
            }

            .layer-depth-3 {
                transform: translateZ(60px);
            }

            /* İkon en üstte */

            /* 3D İkon Resmi */
            .badge-3d-img {
                filter: drop-shadow(0 15px 25px rgba(0, 0, 0, 0.6));
                transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                max-width: 140px;
                pointer-events: none;
            }

            /* --- ULTRA-REALISTIC HOLOGRAPHIC SHADERS --- */

            /* Foil/Holografik Efekt Katmanı */
            .holo-foil {
                position: absolute;
                inset: 0;
                border-radius: 24px;
                background-image:
                    linear-gradient(115deg, transparent 20%, rgba(255, 255, 255, 0.3) 25%, transparent 30%),
                    repeating-linear-gradient(133deg,
                        transparent 0%,
                        rgba(255, 215, 0, 0.1) 2%,
                        rgba(255, 0, 0, 0.05) 3%,
                        rgba(0, 0, 255, 0.05) 4%,
                        transparent 5%);
                background-size: 200% 200%;
                background-position: 50% 50%;
                mix-blend-mode: color-dodge;
                opacity: 0;
                pointer-events: none;
                z-index: 40;
                transition: opacity 0.3s ease;
            }

            /* Metalik Gürültü Dokusu (Gerçekçilik için) */
            .noise-texture {
                position: absolute;
                inset: 0;
                border-radius: 24px;
                background: url('https://grainy-gradients.vercel.app/noise.svg');
                /* Hafif noise */
                opacity: 0.08;
                mix-blend-mode: overlay;
                pointer-events: none;
                z-index: 35;
            }

            /* Nadirlik Seviyesine Göre Özel Işıklar */
            .glow-rare {
                box-shadow: 0 0 40px rgba(59, 130, 246, 0.3), inset 0 0 10px rgba(59, 130, 246, 0.5);
            }

            .glow-epic {
                box-shadow: 0 0 50px rgba(168, 85, 247, 0.4), inset 0 0 15px rgba(168, 85, 247, 0.6);
            }

            .glow-legendary {
                box-shadow: 0 0 60px rgba(234, 179, 8, 0.5), inset 0 0 20px rgba(234, 179, 8, 0.8);
                border: 1px solid rgba(253, 224, 71, 0.5);
            }

            .glow-mythic {
                box-shadow: 0 0 80px rgba(239, 68, 68, 0.6), inset 0 0 30px rgba(239, 68, 68, 0.8);
                animation: mythicPulse 3s infinite alternate;
            }

            @keyframes mythicPulse {
                0% {
                    box-shadow: 0 0 50px rgba(239, 68, 68, 0.5);
                }

                100% {
                    box-shadow: 0 0 90px rgba(239, 68, 68, 0.9), 0 0 20px rgba(255, 255, 255, 0.5);
                }
            }

            /* Kart Başlığı için Özel Font Efekti */
            .premium-title {
                background: linear-gradient(to bottom, #ffffff, #e2e8f0);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            }

            /* --- YENİ AI AVATAR ANİMASYONLARI --- */

            /* Saat yönünde yavaş dönüş */
            @keyframes spin-slow {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            /* Saat yönünün tersine dönüş */
            @keyframes spin-reverse {
                from {
                    transform: rotate(360deg);
                }

                to {
                    transform: rotate(0deg);
                }
            }

            /* Çekirdek nabız atışı (Büyüyüp küçülme) */
            @keyframes core-pulse {

                0%,
                100% {
                    transform: scale(1);
                    opacity: 0.8;
                    box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
                }

                50% {
                    transform: scale(1.15);
                    opacity: 1;
                    box-shadow: 0 0 25px rgba(99, 102, 241, 0.8);
                }
            }

            .animate-spin-slow {
                animation: spin-slow 12s linear infinite;
            }

            /* YENİ: Autopilot Marquee & FadeInUp */
            @keyframes marquee {
                0% {
                    transform: translateX(100%);
                }

                100% {
                    transform: translateX(-100%);
                }
            }

            .animate-marquee {
                animation: marquee 25s linear infinite;
                white-space: nowrap;
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .animate-fade-in-up {
                animation: fadeInUp 0.5s ease-out forwards;
            }

            .animate-spin-reverse {
                animation: spin-reverse 9s linear infinite;
            }

            .animate-core-pulse {
                animation: core-pulse 3s ease-in-out infinite;
            }

            /* --- PREMIUM KART EFEKTLERİ --- */
            .card-chip {
                background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
                border-radius: 6px;
                position: relative;
                overflow: hidden;
                box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.4), 0 1px 2px rgba(0, 0, 0, 0.2);
            }

            .card-chip::before {
                content: '';
                position: absolute;
                inset: 0;
                background: repeating-linear-gradient(90deg, transparent 0, transparent 2px, rgba(0, 0, 0, 0.2) 2px, rgba(0, 0, 0, 0.2) 3px),
                    repeating-linear-gradient(0deg, transparent 0, transparent 2px, rgba(0, 0, 0, 0.2) 2px, rgba(0, 0, 0, 0.2) 4px);
                border: 1px solid rgba(0, 0, 0, 0.3);
                border-radius: 6px;
            }

            /* Premium Dokular */
            .texture-carbon {
                background-image: radial-gradient(black 15%, transparent 16%), radial-gradient(black 15%, transparent 16%);
                background-size: 4px 4px;
                background-position: 0 0, 2px 2px;
                opacity: 0.2;
            }

            .texture-metal {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0) 50%, rgba(255, 255, 255, 0.1) 75%, rgba(255, 255, 255, 0) 100%);
                background-size: 200% 200%;
                animation: shimmer 6s infinite linear;
            }

            .texture-gold {
                background: radial-gradient(ellipse farthest-corner at right bottom, #FEDB37 0%, #FDB931 8%, #9f7928 30%, #8A6E2F 40%, transparent 80%),
                    radial-gradient(ellipse farthest-corner at left top, #FFFFFF 0%, #FFFFAC 8%, #D1B464 25%, #5d4a1f 62.5%, #5d4a1f 100%);
            }

            /* === APPLE UI AWARD - PREMIUM STYLES === */

            /* Premium Shimmer Effect */
            @keyframes premium-shimmer {
                0% {
                    background-position: -200% 0;
                }

                100% {
                    background-position: 200% 0;
                }
            }

            .premium-shimmer {
                background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
                background-size: 200% 100%;
                animation: premium-shimmer 2s infinite;
            }

            /* Premium Crown Float */
            @keyframes crown-float {

                0%,
                100% {
                    transform: translateY(0) rotate(-5deg) scale(1);
                }

                25% {
                    transform: translateY(-8px) rotate(0deg) scale(1.05);
                }

                50% {
                    transform: translateY(-4px) rotate(5deg) scale(1);
                }

                75% {
                    transform: translateY(-10px) rotate(0deg) scale(1.02);
                }
            }

            .premium-crown {
                animation: crown-float 4s ease-in-out infinite;
            }

            /* Feature Check Animation */
            @keyframes check-pop {
                0% {
                    transform: scale(0) rotate(-45deg);
                    opacity: 0;
                }

                50% {
                    transform: scale(1.2) rotate(0deg);
                    opacity: 1;
                }

                100% {
                    transform: scale(1) rotate(0deg);
                    opacity: 1;
                }
            }

            .feature-check {
                animation: check-pop 0.5s ease-out forwards;
            }

            /* Premium Card 3D */
            .premium-card-3d {
                transform-style: preserve-3d;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .premium-card-3d:hover {
                transform: translateY(-8px) rotateX(2deg);
                box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.3);
            }

            /* Premium Glow Pulse */
            @keyframes premium-glow-pulse {

                0%,
                100% {
                    box-shadow: 0 0 20px rgba(168, 85, 247, 0.4), 0 0 40px rgba(99, 102, 241, 0.2);
                }

                50% {
                    box-shadow: 0 0 30px rgba(168, 85, 247, 0.6), 0 0 60px rgba(99, 102, 241, 0.4);
                }
            }

            .premium-glow {
                animation: premium-glow-pulse 3s ease-in-out infinite;
            }

            /* Pricing Toggle */
            .pricing-toggle {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 100px;
                padding: 4px;
                display: flex;
                gap: 4px;
            }

            .pricing-option {
                padding: 8px 20px;
                border-radius: 100px;
                font-weight: bold;
                font-size: 12px;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .pricing-option.active {
                background: white;
                color: #1a1a2e;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .pricing-option:not(.active) {
                color: rgba(255, 255, 255, 0.7);
            }

            /* Pro Badge Glow (Header) */
            .pro-badge-glow {
                background: linear-gradient(135deg, #8b5cf6, #6366f1, #3b82f6);
                color: white !important;
                box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
                animation: premium-glow-pulse 3s ease-in-out infinite;
            }

            /* Save Badge */
            .save-badge {
                position: absolute;
                top: -8px;
                right: -8px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                font-size: 9px;
                font-weight: 800;
                padding: 4px 8px;
                border-radius: 100px;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            }

            /* === HEADER AVATAR - EMBEDDED + SPILL + AMBIENT ANIMATION === */
            :root {
                --avatar-ambient-opacity: 0.45;
                --avatar-ambient-blur: 18px;
                --avatar-spill-opacity: 0.70;
                --avatar-spill-blur: 10px;
            }

            html.dark {
                --avatar-ambient-opacity: 0.70;
                --avatar-ambient-blur: 24px;
                --avatar-spill-opacity: 0.55;
                --avatar-spill-blur: 12px;
            }

            .header-avatar-wrap {
                position: relative;
                overflow: visible;
                isolation: isolate;
            }

            /* Buton "gömülü" hissi: cam + inset shadow */
            .header-avatar-wrap>button {
                overflow: visible !important;
                border: 1.5px solid rgba(255, 255, 255, 0.4);
                box-shadow:
                    inset 0 2px 4px rgba(255, 255, 255, 0.5),
                    inset 0 -12px 20px rgba(0, 0, 0, 0.18),
                    0 8px 24px var(--accent-glow),
                    0 4px 12px rgba(0, 0, 0, 0.15);
            }

            html.dark .header-avatar-wrap>button {
                border-color: rgba(255, 255, 255, 0.2);
                box-shadow:
                    inset 0 2px 4px rgba(255, 255, 255, 0.15),
                    inset 0 -12px 20px rgba(0, 0, 0, 0.35),
                    0 8px 30px var(--accent-glow),
                    0 4px 16px rgba(0, 0, 0, 0.3);
            }


            /* === PREMIUM AVATAR AMBIENT UPGRADE === */
            .avatar-ambient {
                position: absolute;
                inset: -14px;
                z-index: 0;
                pointer-events: none;
                border-radius: 999px;

                /* Base halo: daha yumuşak, daha derin */
                background:
                    radial-gradient(circle at 30% 35%,
                        color-mix(in srgb, var(--accent-primary) 55%, transparent) 0%,
                        transparent 55%),
                    radial-gradient(circle at 70% 65%,
                        color-mix(in srgb, var(--accent-secondary) 45%, transparent) 0%,
                        transparent 60%),
                    conic-gradient(from 180deg,
                        color-mix(in srgb, var(--accent-primary) 65%, transparent),
                        transparent 25%,
                        color-mix(in srgb, var(--accent-secondary) 65%, transparent),
                        transparent 60%,
                        color-mix(in srgb, var(--accent-primary) 65%, transparent));

                filter: blur(var(--avatar-ambient-blur));
                opacity: var(--avatar-ambient-opacity);
                mix-blend-mode: screen;

                transform: translateZ(0);
                animation: avatarSpin 9s linear infinite, avatarBreathe 3.6s ease-in-out infinite;
            }

            /* Aurora drift layer */
            .avatar-ambient::before {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: inherit;
                pointer-events: none;

                background:
                    radial-gradient(80% 60% at 20% 20%,
                        rgba(255, 255, 255, 0.14),
                        transparent 55%),
                    radial-gradient(70% 55% at 80% 70%,
                        rgba(255, 255, 255, 0.10),
                        transparent 60%),
                    linear-gradient(120deg,
                        color-mix(in srgb, var(--accent-primary) 55%, transparent),
                        transparent 35%,
                        color-mix(in srgb, var(--accent-secondary) 55%, transparent));

                filter: blur(calc(var(--avatar-ambient-blur) - 6px));
                opacity: 0.55;
                mix-blend-mode: overlay;

                transform: translateZ(0);
                animation: auroraDrift 6.5s ease-in-out infinite;
            }

            /* Grain / micro-noise layer (çok hafif) */
            .avatar-ambient::after {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: inherit;
                pointer-events: none;

                /* Saf CSS grain hissi: minik katmanlı gradientler */
                background:
                    radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.10) 0 1px, transparent 2px),
                    radial-gradient(circle at 80% 30%, rgba(255, 255, 255, 0.08) 0 1px, transparent 2px),
                    radial-gradient(circle at 40% 70%, rgba(255, 255, 255, 0.06) 0 1px, transparent 2px),
                    radial-gradient(circle at 65% 55%, rgba(255, 255, 255, 0.07) 0 1px, transparent 2px);

                opacity: 0.10;
                mix-blend-mode: soft-light;
                animation: grainJitter 1.6s steps(2) infinite;
            }

            /* Dark modda aurora biraz daha "neon" dursun */
            html.dark .avatar-ambient {
                opacity: calc(var(--avatar-ambient-opacity) + 0.05);
                mix-blend-mode: screen;
            }

            html.dark .avatar-ambient::before {
                opacity: 0.65;
            }

            /* Daire dışına taşan "liquid glass" parça */
            .avatar-spill {
                position: absolute;
                width: 26px;
                height: 20px;
                right: -6px;
                bottom: -4px;
                z-index: 1;
                pointer-events: none;
                opacity: var(--avatar-spill-opacity);
                border-radius: 12px 16px 14px 18px;
                background:
                    radial-gradient(circle at 30% 30%,
                        rgba(255, 255, 255, 0.6),
                        transparent 55%),
                    linear-gradient(135deg,
                        color-mix(in srgb, var(--accent-primary) 65%, transparent),
                        color-mix(in srgb, var(--accent-secondary) 65%, transparent));
                border: 1px solid rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(var(--avatar-spill-blur));
                -webkit-backdrop-filter: blur(var(--avatar-spill-blur));
                filter: drop-shadow(0 8px 14px rgba(0, 0, 0, 0.15));
                transform: rotate(-10deg);
                animation: avatarFloat 4s ease-in-out infinite;
            }

            html.dark .avatar-spill {
                background:
                    radial-gradient(circle at 30% 30%,
                        rgba(255, 255, 255, 0.4),
                        transparent 55%),
                    linear-gradient(135deg,
                        color-mix(in srgb, var(--accent-primary) 50%, transparent),
                        color-mix(in srgb, var(--accent-secondary) 50%, transparent));
                border-color: rgba(255, 255, 255, 0.15);
            }

            /* İç avatar katmanı en üstte kalsın */
            .header-avatar-wrap #profile-avatar-text {
                position: relative;
                z-index: 2;
            }

            /* Animasyonlar */
            @keyframes avatarSpin {
                from {
                    transform: rotate(0deg) scale(1.02);
                }

                to {
                    transform: rotate(360deg) scale(1.02);
                }
            }

            @keyframes avatarFloat {

                0%,
                100% {
                    transform: translateY(0) rotate(-10deg);
                }

                50% {
                    transform: translateY(-2px) rotate(-14deg);
                }
            }

            @keyframes auroraDrift {
                0% {
                    transform: translate(-1px, 1px) scale(1.02);
                }

                50% {
                    transform: translate(2px, -2px) scale(1.05);
                }

                100% {
                    transform: translate(-1px, 1px) scale(1.02);
                }
            }

            @keyframes avatarBreathe {

                0%,
                100% {
                    opacity: var(--avatar-ambient-opacity);
                }

                50% {
                    opacity: calc(var(--avatar-ambient-opacity) + 0.12);
                }
            }

            @keyframes grainJitter {
                0% {
                    transform: translate(0, 0);
                }

                50% {
                    transform: translate(1px, -1px);
                }

                100% {
                    transform: translate(0, 0);
                }
            }

            /* Hareket hassasiyeti olanlar için (genişletilmiş) */
            @media (prefers-reduced-motion: reduce) {

                .avatar-ambient,
                .avatar-ambient::before,
                .avatar-ambient::after,
                .avatar-spill {
                    animation: none !important;
                }
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* FINGO BRAIN PREMIUM STYLES                                      */
            /* ═══════════════════════════════════════════════════════════════ */

            /* Range Selector Pills */
            .fingo-range-selector {
                display: flex;
                gap: 6px;
                padding: 4px;
                background: rgba(99, 102, 241, 0.08);
                border-radius: 16px;
                border: 1px solid rgba(99, 102, 241, 0.15);
            }

            .fingo-range-pill {
                flex: 1;
                padding: 8px 12px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 700;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
                color: rgba(99, 102, 241, 0.7);
                background: transparent;
                border: none;
            }

            .fingo-range-pill:hover {
                color: rgb(99, 102, 241);
                background: rgba(99, 102, 241, 0.1);
            }

            .fingo-range-pill.active {
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                color: white;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }

            .fingo-range-pill:focus-visible {
                outline: 2px solid rgba(99, 102, 241, 0.5);
                outline-offset: 2px;
            }

            /* Typing Indicator */
            .typing-indicator {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 8px 12px;
                background: rgba(99, 102, 241, 0.1);
                border-radius: 16px;
            }

            .typing-indicator span {
                width: 6px;
                height: 6px;
                background: rgb(99, 102, 241);
                border-radius: 50%;
                animation: typingBounce 1.4s infinite ease-in-out both;
            }

            .typing-indicator span:nth-child(1) {
                animation-delay: -0.32s;
            }

            .typing-indicator span:nth-child(2) {
                animation-delay: -0.16s;
            }

            .typing-indicator span:nth-child(3) {
                animation-delay: 0s;
            }

            @keyframes typingBounce {

                0%,
                80%,
                100% {
                    transform: scale(0.6);
                    opacity: 0.5;
                }

                40% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            /* Improved Chart Container */
            .fingo-chart-container {
                position: relative;
                border-radius: 20px;
                padding: 16px;
                background: rgba(255, 255, 255, 0.5);
                border: 1px solid rgba(99, 102, 241, 0.1);
                box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.02);
            }

            html.dark .fingo-chart-container {
                background: rgba(0, 0, 0, 0.25);
                border-color: rgba(255, 255, 255, 0.05);
            }

            /* DNA Category Horizontal Scroll */
            .fingo-category-scroll {
                display: flex;
                gap: 8px;
                overflow-x: auto;
                padding: 8px 2px;
                scrollbar-width: none;
                -ms-overflow-style: none;
                scroll-snap-type: x mandatory;
            }

            .fingo-category-scroll::-webkit-scrollbar {
                display: none;
            }

            .fingo-category-pill {
                flex-shrink: 0;
                padding: 8px 14px;
                border-radius: 20px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                font-size: 11px;
                font-weight: 700;
                color: rgba(255, 255, 255, 0.7);
                white-space: nowrap;
                scroll-snap-align: start;
                transition: all 0.2s ease;
            }

            .fingo-category-pill:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(99, 102, 241, 0.4);
            }

            .fingo-category-pill.dominant {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3));
                border-color: rgba(99, 102, 241, 0.5);
                color: white;
            }

            /* Detective Empty State */
            .detective-empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 24px;
                text-align: center;
            }

            .detective-empty-icon {
                width: 64px;
                height: 64px;
                border-radius: 24px;
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px;
                margin-bottom: 16px;
            }

            /* Detective Action Buttons */
            .detective-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 14px 16px;
                background: rgba(255, 255, 255, 0.6);
                border: 1px solid rgba(0, 0, 0, 0.05);
                border-radius: 16px;
                transition: all 0.2s ease;
            }

            html.dark .detective-item {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.08);
            }

            .detective-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }

            .detective-action-btn {
                padding: 6px 12px;
                border-radius: 10px;
                font-size: 10px;
                font-weight: 700;
                border: none;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .detective-action-btn.mark {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
            }

            .detective-action-btn.ignore {
                background: rgba(107, 114, 128, 0.15);
                color: rgb(107, 114, 128);
            }

            .detective-action-btn:hover {
                transform: scale(1.05);
            }

            /* Dominant Categories Card */
            .fingo-dominant-card {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 14px 18px;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
                border: 1px solid rgba(99, 102, 241, 0.2);
                border-radius: 20px;
                margin-bottom: 16px;
            }

            /* Trend Indicator */
            .fingo-trend-row {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 14px;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 14px;
                margin-top: 12px;
            }

            .trend-up {
                color: #ef4444;
            }

            .trend-down {
                color: #10b981;
            }

            /* Monthly Total Card */
            .detective-total-card {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 20px;
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
                border: 1px solid rgba(239, 68, 68, 0.2);
                border-radius: 20px;
                margin-bottom: 16px;
            }

            /* Accessibility: Focus rings */
            .fingo-range-pill:focus-visible,
            .detective-action-btn:focus-visible {
                outline: 2px solid rgba(99, 102, 241, 0.6);
                outline-offset: 2px;
            }

            /* Tab button accessibility */
            #tab-btn-pulse[aria-selected="true"],
            #tab-btn-dna[aria-selected="true"],
            #tab-btn-detective[aria-selected="true"] {
                background: white;
                color: rgb(99, 102, 241);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            html.dark #tab-btn-pulse[aria-selected="true"],
            html.dark #tab-btn-dna[aria-selected="true"],
            html.dark #tab-btn-detective[aria-selected="true"] {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* FINGO BRAIN V4 - PREMIUM DESIGN SYSTEM                          */
            /* Apple-Inspired UI with Clean Aesthetics & Rich Gradients        */
            /* ═══════════════════════════════════════════════════════════════ */

            /* ─────────────────────────────────────────────────────────────── */
            /* DARK MODE - Midnight Premium Theme                              */
            /* ─────────────────────────────────────────────────────────────── */
            html.dark {
                /* Backgrounds — True-black OLED base with layered surfaces */
                --fb-bg-base: #0f1629;
                --fb-bg-primary: #1e293b;
                --fb-bg-elevated: #1e293b;
                --fb-bg-card: #1e293b;
                --fb-bg-card-hover: #334155;
                --fb-bg-subtle: rgba(255, 255, 255, 0.04);

                /* Borders — Ultra-thin, barely visible */
                --fb-border: rgba(255, 255, 255, 0.06);
                --fb-border-accent: rgba(129, 140, 248, 0.2);
                --fb-border-strong: rgba(255, 255, 255, 0.12);

                /* Shadows — Deep layered elevation, NO glow */
                --fb-shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.5);
                --fb-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.3);
                --fb-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), 0 1px 4px rgba(0, 0, 0, 0.3);
                --fb-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.55), 0 2px 8px rgba(0, 0, 0, 0.35);
                --fb-shadow-xl: 0 16px 40px rgba(0, 0, 0, 0.6), 0 4px 16px rgba(0, 0, 0, 0.4);
                --fb-shadow-depth: 0 2px 6px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.04);

                /* Text Colors — SF Pro hierarchy */
                --fb-text-primary: #f5f5f7;
                --fb-text-secondary: #98989d;
                --fb-text-tertiary: #636366;
                --fb-text-muted: #48484a;

                /* Accent Colors — Desaturated for elegance */
                --fb-accent: #7c8cf5;
                --fb-accent-hover: #9ba5f8;
                --fb-accent-muted: rgba(124, 140, 245, 0.12);
                --fb-accent-secondary: #a78bfa;
                --fb-accent-emerald: #34d399;
                --fb-accent-orange: #fb923c;
                --fb-accent-rose: #fb7185;

                /* Gradients — Muted, premium tones */
                --fb-gradient-hero: linear-gradient(145deg, #312e81 0%, #4338ca 30%, #5b52cc 60%, #7c6dd8 100%);
                --fb-gradient-accent: linear-gradient(135deg, #5b5bd6 0%, #7c5ccc 100%);
                --fb-gradient-card: linear-gradient(180deg, rgba(255, 255, 255, 0.02) 0%, transparent 100%);
                --fb-gradient-success: linear-gradient(135deg, #059669 0%, #10b981 100%);
                --fb-gradient-warning: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);

                /* Separators */
                --fb-separator: rgba(255, 255, 255, 0.04);
                --fb-divider: rgba(255, 255, 255, 0.08);
            }

            /* ─────────────────────────────────────────────────────────────── */
            /* LIGHT MODE - Clean Premium Theme                                */
            /* ─────────────────────────────────────────────────────────────── */
            html:not(.dark) {
                /* Backgrounds — Snow-white layered surfaces */
                --fb-bg-base: #dde2e9;
                --fb-bg-primary: #efeff4;
                --fb-bg-elevated: #ffffff;
                --fb-bg-card: #ffffff;
                --fb-bg-card-hover: #f9f9fb;
                --fb-bg-subtle: rgba(0, 0, 0, 0.025);

                /* Borders — Hairline, barely there */
                --fb-border: rgba(0, 0, 0, 0.06);
                --fb-border-accent: rgba(99, 102, 241, 0.18);
                --fb-border-strong: rgba(0, 0, 0, 0.1);

                /* Shadows — Soft layered elevation, NO glow */
                --fb-shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.03);
                --fb-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.03);
                --fb-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);
                --fb-shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 6px rgba(0, 0, 0, 0.04);
                --fb-shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.06);
                --fb-shadow-depth: 0 1px 3px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.8);

                /* Text Colors — Apple SF Pro hierarchy */
                --fb-text-primary: #1d1d1f;
                --fb-text-secondary: #6e6e73;
                --fb-text-tertiary: #8e8e93;
                --fb-text-muted: #aeaeb2;

                /* Accent Colors */
                --fb-accent: #5856d6;
                --fb-accent-hover: #4a48c4;
                --fb-accent-muted: rgba(88, 86, 214, 0.08);
                --fb-accent-secondary: #8b5cf6;
                --fb-accent-emerald: #10b981;
                --fb-accent-orange: #f97316;
                --fb-accent-rose: #f43f5e;

                /* Gradients — Subtle, sophisticated */
                --fb-gradient-hero: linear-gradient(145deg, #4338ca 0%, #5b52cc 30%, #6d63d4 60%, #8678dc 100%);
                --fb-gradient-accent: linear-gradient(135deg, #5856d6 0%, #7c5ccc 100%);
                --fb-gradient-card: linear-gradient(180deg, #ffffff 0%, #fafafe 100%);
                --fb-gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
                --fb-gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);

                /* Separators */
                --fb-separator: rgba(0, 0, 0, 0.04);
                --fb-divider: rgba(0, 0, 0, 0.06);
            }

            /* ─────────────────────────────────────────────────────────────── */
            /* BENTO GRID - Premium Widget Layout                              */
            /* ─────────────────────────────────────────────────────────────── */
            .bento-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .bento-card {
                position: relative;
                background: var(--fb-bg-card);
                border: 1px solid var(--fb-border);
                border-radius: 20px;
                padding: 18px;
                box-shadow: var(--fb-shadow-sm);
                transition: transform 0.24s cubic-bezier(0.25, 1, 0.5, 1),
                    box-shadow 0.24s ease,
                    border-color 0.24s ease;
                overflow: hidden;
            }

            .bento-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--fb-shadow-lg);
                border-color: var(--fb-border-accent);
            }

            html.dark .bento-card:hover {
                box-shadow: var(--fb-shadow-lg);
                border-color: var(--fb-border-accent);
            }

            .bento-card:active {
                transform: scale(0.97);
                transition: transform 0.1s ease;
            }

            .bento-card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
                position: relative;
                z-index: 1;
            }

            .bento-icon-box {
                width: 34px;
                height: 34px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 17px;
                transition: transform 0.2s ease;
            }

            .bento-card:hover .bento-icon-box {
                transform: scale(1.05);
            }

            .bento-title {
                font-size: 12px;
                font-weight: 600;
                color: var(--fb-text-secondary);
                letter-spacing: 0.01em;
                position: relative;
                z-index: 1;
            }

            .bento-value {
                font-size: 22px;
                font-weight: 800;
                color: var(--fb-text-primary);
                letter-spacing: -0.025em;
                position: relative;
                z-index: 1;
            }

            /* Bento Card Variants */
            .bento-card-large {
                grid-column: span 2;
                padding: 22px;
            }


            /* Base Container - Apple Typography */
            .fb-container {
                font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Inter', system-ui, sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* RANGE SELECTOR - Apple Time Selector Inspired                   */
            /* ═══════════════════════════════════════════════════════════════ */
            .fingo-range-selector {
                display: flex;
                gap: 3px;
                padding: 3px;
                background: var(--fb-bg-elevated);
                border-radius: 14px;
                border: 1px solid var(--fb-border);
                box-shadow: var(--fb-shadow-depth);
                width: 100%;
                max-width: 320px;
                margin: 0 auto;
            }

            html.dark .fingo-range-selector {
                background: var(--fb-bg-card);
                border-color: var(--fb-border);
            }

            .fingo-range-pill {
                flex: 1;
                padding: 9px 14px;
                border-radius: 11px;
                font-size: 13px;
                font-weight: 600;
                text-align: center;
                color: var(--fb-text-secondary);
                background: transparent;
                border: none;
                cursor: pointer;
                transition: color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
            }

            .fingo-range-pill:hover:not(.active) {
                color: var(--fb-text-primary);
                background: var(--fb-bg-subtle);
            }

            .fingo-range-pill.active {
                background: var(--fb-accent);
                color: white;
                box-shadow: var(--fb-shadow-depth);
            }

            html.dark .fingo-range-pill.active {
                box-shadow: var(--fb-shadow-depth);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* TAB CONTROLS - Modern Solid Style                              */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-tabs {
                display: flex;
                gap: 3px;
                padding: 3px;
                background: var(--fb-bg-elevated);
                border-radius: 14px;
                border: 1px solid var(--fb-border);
                box-shadow: var(--fb-shadow-depth);
            }

            .fb-tab {
                flex: 1;
                padding: 11px 14px;
                border-radius: 11px;
                font-size: 12px;
                font-weight: 600;
                letter-spacing: -0.01em;
                text-align: center;
                color: var(--fb-text-secondary);
                background: transparent;
                border: none;
                cursor: pointer;
                transition: color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
                position: relative;
                overflow: hidden;
            }

            .fb-tab:hover {
                color: var(--fb-text-primary);
                background: var(--fb-bg-subtle);
            }

            .fb-tab.active,
            .fb-tab[aria-selected="true"] {
                background: var(--fb-accent);
                color: #ffffff;
                box-shadow: var(--fb-shadow-depth);
            }

            html.dark .fb-tab.active,
            html.dark .fb-tab[aria-selected="true"] {
                background: var(--fb-accent);
                color: #ffffff;
                box-shadow: var(--fb-shadow-depth);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* SOLID CARDS - Clean Modern Design                              */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-glass {
                background: var(--fb-bg-card);
                border: 1px solid var(--fb-border);
                border-radius: 20px;
                box-shadow: var(--fb-shadow-sm);
                transition: box-shadow 0.2s ease, border-color 0.2s ease;
            }

            .fb-glass:hover {
                box-shadow: var(--fb-shadow);
                border-color: var(--fb-border-strong);
            }

            html.dark .fb-glass:hover {
                box-shadow: var(--fb-shadow);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* HERO CARD - Apple Fitness Ring Inspired Premium Design          */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-hero {
                position: relative;
                overflow: hidden;
                padding: 36px 24px;
                background: var(--fb-gradient-hero);
                border-radius: 24px;
                box-shadow:
                    0 12px 32px rgba(67, 56, 202, 0.25),
                    0 4px 12px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            html:not(.dark) .fb-hero {
                box-shadow:
                    0 12px 32px rgba(67, 56, 202, 0.18),
                    0 4px 12px rgba(0, 0, 0, 0.06),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }

            /* FIX: Force white text on Hero Cards (overriding global neumorphic dark text) */
            .fb-hero h1,
            .fb-hero h2,
            .fb-hero h3,
            .fb-hero h4,
            .fb-hero p,
            .fb-hero span,
            .fb-hero div {
                color: white !important;
            }

            .fb-hero .text-indigo-100 {
                color: #e0e7ff !important;
            }

            .fb-hero .text-purple-100 {
                color: #f3e8ff !important;
            }

            .fb-hero .text-red-100 {
                color: #fee2e2 !important;
            }

            .fb-hero .text-white\/80 {
                color: rgba(255, 255, 255, 0.8) !important;
            }

            .fb-hero .text-white\/90 {
                color: rgba(255, 255, 255, 0.9) !important;
            }

            .fb-hero::before {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(180deg,
                        rgba(255, 255, 255, 0.12) 0%,
                        transparent 40%,
                        rgba(0, 0, 0, 0.06) 100%);
                pointer-events: none;
                border-radius: 24px;
            }

            /* Shimmer and glow effects removed for clean premium look */
            .fb-hero::after {
                display: none;
            }

            /* Decorative orbs hidden */
            .fb-hero-glow {
                display: none;
            }

            /* Hero Content */
            .fb-hero-content {
                position: relative;
                z-index: 2;
            }

            .fb-hero-title {
                font-size: 13px;
                font-weight: 600;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                color: rgba(255, 255, 255, 0.85);
                margin-bottom: 8px;
            }

            .fb-hero-value {
                font-size: 52px;
                font-weight: 800;
                letter-spacing: -0.03em;
                color: #ffffff;
                text-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
                line-height: 1;
            }

            .fb-hero-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 14px;
                background: rgba(255, 255, 255, 0.18);
                border: 1px solid rgba(255, 255, 255, 0.25);
                border-radius: 100px;
                font-size: 13px;
                font-weight: 600;
                color: #ffffff;
                margin-top: 16px;
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* METRIC TILES - Clean Solid Cards                               */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-tile {
                position: relative;
                overflow: hidden;
                padding: 18px;
                background: var(--fb-bg-card);
                border: 1px solid var(--fb-border);
                border-radius: 16px;
                box-shadow: var(--fb-shadow-sm);
                transition: box-shadow 0.2s ease, border-color 0.2s ease;
            }

            .fb-tile:hover {
                box-shadow: var(--fb-shadow);
                border-color: var(--fb-border-strong);
            }

            .fb-tile-icon {
                width: 38px;
                height: 38px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 19px;
                margin-bottom: 10px;
            }

            .fb-tile-label {
                font-size: 11px;
                font-weight: 700;
                letter-spacing: 0.5px;
                text-transform: uppercase;
                color: var(--fb-text-secondary);
                margin-bottom: 4px;
            }

            .fb-tile-value {
                font-size: 22px;
                font-weight: 800;
                letter-spacing: -0.025em;
                color: var(--fb-text-primary);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* CHAT INTERFACE - iMessage Inspired Design                      */
            /* ═══════════════════════════════════════════════════════════════ */

            /* Chat Header */
            .fb-chat-header {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px 20px;
                background: var(--fb-bg-card);
                border: 1px solid var(--fb-border);
                border-radius: 20px;
                box-shadow: var(--fb-shadow-sm);
            }

            .fb-chat-avatar {
                width: 44px;
                height: 44px;
                border-radius: 14px;
                background: var(--fb-gradient-accent);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 22px;
                box-shadow: var(--fb-shadow);
            }

            .fb-chat-status {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 12px;
                font-weight: 600;
                color: #34C759;
            }

            .fb-chat-status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #34C759;
                animation: fb-pulse-dot 2s ease-in-out infinite;
            }

            @keyframes fb-pulse-dot {

                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }

                50% {
                    opacity: 0.6;
                    transform: scale(0.9);
                }
            }

            /* Chat Messages */
            .fb-message {
                max-width: 85%;
                padding: 14px 18px;
                border-radius: 20px;
                font-size: 15px;
                line-height: 1.5;
                animation: fb-message-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            @keyframes fb-message-in {
                from {
                    opacity: 0;
                    transform: translateY(16px) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .fb-message-ai {
                align-self: flex-start;
                background: linear-gradient(135deg,
                        rgba(99, 102, 241, 0.12) 0%,
                        rgba(139, 92, 246, 0.08) 100%);
                border: 1px solid rgba(99, 102, 241, 0.15);
                border-bottom-left-radius: 6px;
                color: var(--fb-text-primary);
            }

            html.dark .fb-message-ai {
                background: linear-gradient(135deg,
                        rgba(99, 102, 241, 0.2) 0%,
                        rgba(139, 92, 246, 0.15) 100%);
                border-color: rgba(99, 102, 241, 0.25);
            }

            .fb-message-user {
                align-self: flex-end;
                background: var(--fb-gradient-accent);
                color: white;
                border-bottom-right-radius: 6px;
                box-shadow: var(--fb-shadow);
            }

            /* Chat Input - iMessage Style */
            .fb-chat-input-wrap {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px 12px 10px 20px;
                background: var(--fb-bg-card);
                border: 1px solid var(--fb-border);
                border-radius: 24px;
                box-shadow: var(--fb-shadow-sm);
                transition: border-color 0.2s ease, box-shadow 0.2s ease;
            }

            .fb-chat-input-wrap:focus-within {
                border-color: var(--fb-accent);
                box-shadow: var(--fb-shadow), 0 0 0 2px var(--fb-accent-muted);
            }

            .fb-chat-input {
                flex: 1;
                background: transparent;
                border: none;
                outline: none;
                font-size: 16px;
                font-weight: 400;
                color: var(--fb-text-primary);
                caret-color: var(--fb-accent);
            }

            .fb-chat-input::placeholder {
                color: var(--fb-text-secondary);
            }

            .fb-send-btn {
                width: 38px;
                height: 38px;
                border-radius: 50%;
                background: var(--fb-accent);
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                cursor: pointer;
                box-shadow: var(--fb-shadow-depth);
                transition: transform 0.15s ease, box-shadow 0.15s ease;
            }

            .fb-send-btn:hover {
                transform: scale(1.06);
            }

            .fb-send-btn:active {
                transform: scale(0.94);
            }

            .fb-send-btn svg {
                width: 20px;
                height: 20px;
                color: white;
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* QUICK ACTION CHIPS - Pill-shaped Suggestion Buttons            */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-chips {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .fb-chip {
                padding: 12px 16px;
                border-radius: 14px;
                font-size: 12px;
                font-weight: 600;
                text-align: left;
                background: rgba(255, 255, 255, 0.65);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.4);
                cursor: pointer;
                transition: transform 0.15s ease, box-shadow 0.15s ease;
            }

            html.dark .fb-chip {
                background: rgba(30, 30, 40, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.08);
            }

            .fb-chip:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .fb-chip:active {
                transform: scale(0.97);
            }

            /* Chip Color Variants */
            .fb-chip--indigo {
                color: #6366F1;
                background: rgba(99, 102, 241, 0.1);
                border-color: rgba(99, 102, 241, 0.2);
            }

            .fb-chip--purple {
                color: #8B5CF6;
                background: rgba(139, 92, 246, 0.1);
                border-color: rgba(139, 92, 246, 0.2);
            }

            .fb-chip--emerald {
                color: #10B981;
                background: rgba(16, 185, 129, 0.1);
                border-color: rgba(16, 185, 129, 0.2);
            }

            .fb-chip--orange {
                color: #F59E0B;
                background: rgba(245, 158, 11, 0.1);
                border-color: rgba(245, 158, 11, 0.2);
            }

            .fb-chip--cyan {
                color: #06B6D4;
                background: rgba(6, 182, 212, 0.1);
                border-color: rgba(6, 182, 212, 0.2);
            }

            .fb-chip--pink {
                color: #EC4899;
                background: rgba(236, 72, 153, 0.1);
                border-color: rgba(236, 72, 153, 0.2);
            }

            html.dark .fb-chip--indigo {
                background: rgba(99, 102, 241, 0.15);
            }

            html.dark .fb-chip--purple {
                background: rgba(139, 92, 246, 0.15);
            }

            html.dark .fb-chip--emerald {
                background: rgba(16, 185, 129, 0.15);
            }

            html.dark .fb-chip--orange {
                background: rgba(245, 158, 11, 0.15);
            }

            html.dark .fb-chip--cyan {
                background: rgba(6, 182, 212, 0.15);
            }

            html.dark .fb-chip--pink {
                background: rgba(236, 72, 153, 0.15);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* ANIMATIONS - Smooth Fade & Scale Effects                       */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-fade-in {
                animation: fb-fadeUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            }

            @keyframes fb-fadeUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .fb-scale-in {
                animation: fb-scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            @keyframes fb-scaleIn {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }

                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            /* Typing Indicator - Improved */
            .fb-typing {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 12px 18px;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08));
                border: 1px solid rgba(99, 102, 241, 0.15);
                border-radius: 20px 20px 20px 6px;
            }

            .fb-typing-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--fb-accent-indigo);
                animation: fb-typing-bounce 1.4s ease-in-out infinite;
            }

            .fb-typing-dot:nth-child(1) {
                animation-delay: 0s;
            }

            .fb-typing-dot:nth-child(2) {
                animation-delay: 0.2s;
            }

            .fb-typing-dot:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes fb-typing-bounce {

                0%,
                60%,
                100% {
                    transform: translateY(0);
                    opacity: 0.4;
                }

                30% {
                    transform: translateY(-8px);
                    opacity: 1;
                }
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* SECTION HEADER - Clean Apple Style                             */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-section-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 16px;
            }

            .fb-section-title {
                font-size: 17px;
                font-weight: 700;
                letter-spacing: -0.01em;
                color: var(--fb-text-primary);
            }

            .fb-section-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                background: rgba(99, 102, 241, 0.1);
                color: var(--fb-accent-indigo);
            }

            html.dark .fb-section-badge {
                background: rgba(99, 102, 241, 0.2);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* PREMIUM BUTTONS - Primary, Secondary, Ghost Variants            */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 14px 24px;
                border-radius: 14px;
                font-size: 14px;
                font-weight: 600;
                letter-spacing: -0.01em;
                border: none;
                cursor: pointer;
                transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }

            .fb-btn:active {
                transform: scale(0.96);
            }

            /* Primary Button */
            .fb-btn-primary {
                background: var(--fb-gradient-accent);
                color: #ffffff;
                box-shadow:
                    0 4px 14px rgba(99, 102, 241, 0.35),
                    0 2px 6px rgba(139, 92, 246, 0.2);
            }

            .fb-btn-primary:hover {
                transform: translateY(-2px);
                box-shadow:
                    0 8px 24px rgba(99, 102, 241, 0.4),
                    0 4px 12px rgba(139, 92, 246, 0.25);
            }

            /* Secondary Button */
            .fb-btn-secondary {
                background: var(--fb-bg-elevated);
                color: var(--fb-text-primary);
                border: 1px solid var(--fb-border);
                box-shadow: var(--fb-shadow-sm);
            }

            .fb-btn-secondary:hover {
                background: var(--fb-bg-card);
                border-color: var(--fb-border-accent);
                transform: translateY(-1px);
                box-shadow: var(--fb-shadow);
            }

            /* Ghost Button */
            .fb-btn-ghost {
                background: transparent;
                color: var(--fb-accent);
                padding: 10px 16px;
            }

            .fb-btn-ghost:hover {
                background: var(--fb-accent-bg);
            }

            /* Small Button Variant */
            .fb-btn-sm {
                padding: 10px 16px;
                font-size: 13px;
                border-radius: 10px;
            }

            /* Icon-only Button */
            .fb-btn-icon {
                width: 44px;
                height: 44px;
                padding: 0;
                border-radius: 12px;
            }

            /* Add Button (FAB-style) */
            .fb-btn-add {
                position: fixed;
                bottom: 100px;
                right: 20px;
                width: 56px;
                height: 56px;
                border-radius: 18px;
                background: var(--fb-gradient-accent);
                box-shadow:
                    0 8px 32px rgba(99, 102, 241, 0.45),
                    0 4px 16px rgba(139, 92, 246, 0.3);
                z-index: 100;
            }

            .fb-btn-add:hover {
                transform: scale(1.08);
                box-shadow:
                    0 12px 40px rgba(99, 102, 241, 0.5),
                    0 6px 20px rgba(139, 92, 246, 0.35);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* PROGRESS BARS - Premium Gradient Progress                       */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-progress {
                height: 8px;
                background: var(--fb-bg-tertiary);
                border-radius: 100px;
                overflow: hidden;
                position: relative;
            }

            .fb-progress-bar {
                height: 100%;
                border-radius: 100px;
                background: var(--fb-gradient-accent);
                transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
            }

            .fb-progress-bar::after {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(90deg,
                        transparent 0%,
                        rgba(255, 255, 255, 0.3) 50%,
                        transparent 100%);
                animation: fb-shimmer 2s ease-in-out infinite;
            }

            @keyframes fb-shimmer {
                0% {
                    transform: translateX(-100%);
                }

                100% {
                    transform: translateX(100%);
                }
            }

            /* Large Progress Variant */
            .fb-progress-lg {
                height: 12px;
            }

            /* Progress with label */
            .fb-progress-labeled {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .fb-progress-meta {
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 13px;
                font-weight: 600;
            }

            .fb-progress-label {
                color: var(--fb-text-secondary);
            }

            .fb-progress-value {
                color: var(--fb-accent);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* STATUS BADGES - Semantic Color Indicators                       */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-status {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                border-radius: 100px;
                font-size: 12px;
                font-weight: 600;
            }

            .fb-status-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
            }

            .fb-status-success {
                background: rgba(16, 185, 129, 0.12);
                color: #10B981;
            }

            .fb-status-success .fb-status-dot {
                background: #10B981;
            }

            .fb-status-warning {
                background: rgba(245, 158, 11, 0.12);
                color: #F59E0B;
            }

            .fb-status-warning .fb-status-dot {
                background: #F59E0B;
            }

            .fb-status-danger {
                background: rgba(239, 68, 68, 0.12);
                color: #EF4444;
            }

            .fb-status-danger .fb-status-dot {
                background: #EF4444;
            }

            .fb-status-info {
                background: var(--fb-accent-bg);
                color: var(--fb-accent);
            }

            .fb-status-info .fb-status-dot {
                background: var(--fb-accent);
            }

            /* Dark mode status adjustments */
            html.dark .fb-status-success {
                background: rgba(16, 185, 129, 0.18);
            }

            html.dark .fb-status-warning {
                background: rgba(245, 158, 11, 0.18);
            }

            html.dark .fb-status-danger {
                background: rgba(239, 68, 68, 0.18);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* LIST ITEMS - Premium Card-style List Rows                       */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-list-item {
                display: flex;
                align-items: center;
                gap: 14px;
                padding: 16px;
                background: var(--fb-bg-card);
                border: 1px solid var(--fb-border);
                border-radius: 16px;
                transition: all 0.2s ease;
            }

            .fb-list-item:hover {
                background: var(--fb-bg-elevated);
                border-color: var(--fb-border-accent);
            }

            .fb-list-icon {
                width: 44px;
                height: 44px;
                border-radius: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                flex-shrink: 0;
            }

            .fb-list-content {
                flex: 1;
                min-width: 0;
            }

            .fb-list-title {
                font-size: 15px;
                font-weight: 600;
                color: var(--fb-text-primary);
                margin-bottom: 2px;
            }

            .fb-list-subtitle {
                font-size: 13px;
                color: var(--fb-text-secondary);
            }

            .fb-list-value {
                font-size: 16px;
                font-weight: 700;
                color: var(--fb-text-primary);
                text-align: right;
            }

            .fb-list-chevron {
                color: var(--fb-text-tertiary);
                font-size: 18px;
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* SECTION CONTAINERS - Spacing and Layout Utilities               */
            /* ═══════════════════════════════════════════════════════════════ */
            .fb-section {
                margin-bottom: 24px;
            }

            .fb-section:last-child {
                margin-bottom: 0;
            }

            .fb-stack {
                display: flex;
                flex-direction: column;
            }

            .fb-stack-sm {
                gap: 8px;
            }

            .fb-stack-md {
                gap: 12px;
            }

            .fb-stack-lg {
                gap: 16px;
            }

            .fb-stack-xl {
                gap: 24px;
            }

            .fb-row {
                display: flex;
                align-items: center;
            }

            .fb-row-between {
                justify-content: space-between;
            }

            .fb-row-center {
                justify-content: center;
            }

            /* Divider */
            .fb-divider {
                height: 1px;
                background: var(--fb-separator);
                margin: 16px 0;
            }

            /* === PREMIUM HOLOGRAPHIC 3D BADGE STYLES (Apple Award UI) === */
            .holo-foil {
                position: absolute;
                inset: 0;
                border-radius: inherit;
                pointer-events: none;
                opacity: 0;
                background:
                    conic-gradient(from 0deg, transparent 0%, rgba(255, 255, 255, 0.15) 20%, transparent 40%, rgba(255, 255, 255, 0.1) 60%, transparent 100%),
                    repeating-linear-gradient(133deg, transparent 0%, rgba(255, 255, 255, 0.05) 2%, transparent 4%),
                    radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1), transparent 60%);
                mix-blend-mode: color-dodge;
                /* screen for better compatibility if needed */
                transition: opacity 0.3s ease;
                filter: contrast(1.2) brightness(1.2);
                will-change: opacity, background-position;
            }

            .holo-glare {
                position: absolute;
                inset: 0;
                border-radius: inherit;
                pointer-events: none;
                opacity: 0;
                background: radial-gradient(circle at var(--mx, 50%) var(--my, 50%), rgba(255, 255, 255, 0.4), transparent 50%);
                mix-blend-mode: overlay;
                filter: blur(2px);
                transition: opacity 0.3s ease;
                will-change: opacity, background-position;
            }

            .noise-texture {
                position: absolute;
                inset: 0;
                border-radius: inherit;
                pointer-events: none;
                opacity: 0.07;
                background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
                mix-blend-mode: overlay;
                z-index: 5;
            }

            /* Front face edge highlight */
            #modal-card-inner .card-front::before {
                content: '';
                position: absolute;
                inset: 0;
                border-radius: inherit;
                padding: 1px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), transparent 40%, rgba(255, 255, 255, 0.1));
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                pointer-events: none;
            }

            /* High Quality Badge Icon */
            .badge-hero {
                max-width: 128px;
                width: 128px;
                height: 128px;
                object-fit: contain;
                filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
                transform: translateZ(20px);
                transition: transform 0.3s ease;
            }

            /* 3D Container Update for separate tilt */
            #3d-card-container {
                transform-style: preserve-3d;
                perspective: 1200px;
                will-change: transform;
            }

            #modal-card-inner {
                transform-style: preserve-3d;
                will-change: transform;
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* FINGO BRAIN REDESIGN - APPLE DESIGN SYSTEM                     */
            /* ═══════════════════════════════════════════════════════════════ */

            /* 1. Segmented Control (Apple Style) */
            .fb-segmented-control {
                display: flex;
                padding: 4px;
                background: rgba(118, 118, 128, 0.12);
                border-radius: 9px;
                position: relative;
                margin-bottom: 16px;
            }

            html.dark .fb-segmented-control {
                background: rgba(118, 118, 128, 0.24);
            }

            .fb-segment-btn {
                flex: 1;
                padding: 6px 10px;
                font-size: 13px;
                font-weight: 500;
                color: var(--fb-text-secondary);
                background: transparent;
                border: none;
                border-radius: 7px;
                cursor: pointer;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                z-index: 1;
            }

            .fb-segment-btn.active {
                color: #000;
                font-weight: 600;
                background: #fff;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 3px 1px rgba(0, 0, 0, 0.04);
            }

            html.dark .fb-segment-btn.active {
                color: #fff;
                background: #6366f1;
                /* Indigo accent in dark mode */
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
            }

            html.dark .fb-segment-btn {
                color: rgba(255, 255, 255, 0.6);
            }

            html.dark .fb-segment-btn:hover:not(.active) {
                color: #fff;
            }

            /* 2. Glass Cards (Apple Style) */
            .fb-glass-card {
                background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%);
                border: 1px solid rgba(255, 255, 255, 0.8);
                border-radius: 22px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06), 0 2px 4px rgba(0, 0, 0, 0.04);
                transition: all 0.3s ease;
            }

            .fb-glass-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 20px rgba(0, 0, 0, 0.1);
            }

            html.dark .fb-glass-card {
                background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            }

            html.dark .fb-glass-card:hover {
                box-shadow: 0 12px 20px rgba(0, 0, 0, 0.5);
            }

            /* 3. Hero Section */
            .fb-hero {
                position: relative;
                overflow: hidden;
                border-radius: 32px;
                padding: 24px;
                text-align: center;
                background: linear-gradient(135deg, #000000, #1c1c1e);
                box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
                transform: translateZ(0);
                /* Hardware acceleration */
            }

            /* 4. Animations */
            @keyframes fb-entry {
                0% {
                    opacity: 0;
                    transform: scale(0.96) translateY(10px);
                }

                100% {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }

            .animate-fb-entry {
                animation: fb-entry 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            }

            @keyframes pulse-slow {

                0%,
                100% {
                    opacity: 0.4;
                }

                50% {
                    opacity: 0.7;
                }
            }

            .animate-pulse-slow {
                animation: pulse-slow 3s ease-in-out infinite;
            }

            @keyframes fade-in {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }

            .animate-fade-in {
                animation: fade-in 0.3s ease-out forwards;
            }

            /* Bento Grid Utilities */
            .grid-cols-2 {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .gap-3 {
                gap: 0.75rem;
            }

            .gap-4 {
                gap: 1rem;
            }

            .gap-5 {
                gap: 1.25rem;
            }

            @media (max-width: 768px) {
                .badge-hero {
                    width: 96px;
                    height: 96px;
                }
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* PROFİL MODAL - Mobil Ortalanmış Düzeltmeleri                    */
            /* ═══════════════════════════════════════════════════════════════ */
            @media (max-width: 768px) {

                /* PROFIL MODAL: Mobilde ortalı + eşit boşluk + içerik scroll */
                #profile-modal {
                    padding: 24px 16px !important;
                    padding-top: calc(env(safe-area-inset-top) + 24px) !important;
                    padding-bottom: calc(env(safe-area-inset-bottom) + 24px) !important;
                    align-items: center !important;
                    justify-content: center !important;
                }

                /* Ana kart - ortalanmış, max yükseklik sınırlı */
                #profile-modal>div {
                    width: 100% !important;
                    max-width: 100% !important;
                    max-height: 90dvh !important;
                    height: auto !important;
                    margin: 0 !important;
                    border-radius: 24px !important;

                    /* kart içi düzen: header + tabs + scroll content + footer */
                    display: flex !important;
                    flex-direction: column !important;

                    /* dışarıdan scroll olmasın */
                    overflow: hidden !important;
                }

                /* İçerik alanı scroll edilebilir */
                #profile-modal .custom-scroll {
                    flex: 1 1 auto !important;
                    max-height: none !important;
                    min-height: 0 !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                    overscroll-behavior: contain;
                }

                /* max-h kısıtlamalarını kaldır */
                #profile-modal div[class*="max-h"] {
                    max-height: none !important;
                }

                /* Kapatma butonu */
                #profile-modal .profile-close-btn {
                    top: 12px !important;
                    right: 12px !important;
                    width: 44px !important;
                    height: 44px !important;
                    border-radius: 9999px !important;
                }
            }

            /* === PREMIUM iOS SWIPE-TO-DELETE (Reveal Animation) === */
            .savings-swipe-row {
                position: relative;
                overflow: hidden;
                border-radius: 16px;
                --swipe-reveal: 0;
                /* 0..1 progress */
            }

            /* Delete button: arkada ve başlangıçta görünmez */
            .savings-delete-btn {
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 72px;
                z-index: 0;
                opacity: 0;
                pointer-events: none;
                display: flex;
                align-items: center;
                justify-content: center;

                /* küçük "içeri kaçık" hissi */
                transform: translate3d(14px, 0, 0) scale(0.92);
                transition:
                    opacity 180ms ease,
                    transform 240ms cubic-bezier(0.2, 0.8, 0.2, 1);

                /* premium görünüm */
                background: rgba(239, 68, 68, 0.88);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border-left: 1px solid rgba(255, 255, 255, 0.18);
                border-radius: 0 16px 16px 0;
                cursor: pointer;
            }

            .savings-delete-btn:active {
                background: rgba(239, 68, 68, 0.95);
                transform: translate3d(0, 0, 0) scale(0.95) !important;
            }

            .savings-trash-icon {
                font-size: 20px;
                line-height: 1;
                filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            }

            /* Content önde kalsın (delete butonunu tamamen kapatsın) */
            .savings-swipe-content {
                position: relative;
                z-index: 1;
                will-change: transform;
                touch-action: pan-y;
                /* dikey scroll bozulmasın */
                border-radius: 16px;
                transition: transform 180ms cubic-bezier(.2, .8, .2, 1);
            }

            /* Swipe sırasında kademeli görünürlük */
            .savings-swipe-row.is-swiping .savings-delete-btn {
                opacity: var(--swipe-reveal);
                pointer-events: auto;
                transform:
                    translate3d(calc(14px * (1 - var(--swipe-reveal))), 0, 0) scale(calc(0.92 + (0.08 * var(--swipe-reveal))));
            }

            /* Açık pozisyonda tam görünür */
            .savings-swipe-row.is-open .savings-delete-btn {
                opacity: 1;
                pointer-events: auto;
                transform: translate3d(0, 0, 0) scale(1);
            }

            .savings-swipe-row.is-open .savings-swipe-content {
                border-top-right-radius: 10px;
                border-bottom-right-radius: 10px;
            }

            /* === ASSET DISTRIBUTION (savings-detail-modal) — Apple Award UI Patch === */
            #savings-detail-modal .asset-donut-wrap {
                display: flex;
                align-items: center;
                justify-content: center;
                isolation: isolate;
            }

            #savings-detail-modal .asset-donut-canvas {
                /* width removed to preserve aspect ratio */
                /* height removed to preserve aspect ratio */
                max-width: 100%;
                max-height: 100%;
            }


            /* Glass kart (light) */
            #savings-detail-modal .asset-card {
                background: var(--glass-bg);
                border: 1px solid var(--glass-border-strong);
                box-shadow: var(--glass-shadow);
                backdrop-filter: blur(18px);
                -webkit-backdrop-filter: blur(18px);
                border-radius: 18px;
                overflow: hidden;
                transform: translateZ(0);
            }

            /* Glass kart (dark) */
            html.dark #savings-detail-modal .asset-card {
                background: rgba(15, 23, 42, .55);
                border-color: rgba(255, 255, 255, .10);
                box-shadow: 0 18px 55px rgba(0, 0, 0, .55);
            }

            /* Tipografi (token bazlı) */
            #savings-detail-modal .asset-title {
                color: var(--text-primary);
                letter-spacing: -0.01em;
            }

            #savings-detail-modal .asset-amount {
                color: var(--text-primary);
                letter-spacing: -0.02em;
            }

            #savings-detail-modal .asset-sub {
                color: var(--text-muted);
            }

            /* İkon kapsülü */
            #savings-detail-modal .asset-icon {
                background: rgba(255, 255, 255, .55);
                border: 1px solid rgba(0, 0, 0, .08);
                box-shadow: 0 10px 25px rgba(0, 0, 0, .10);
            }

            html.dark #savings-detail-modal .asset-icon {
                background: rgba(2, 6, 23, .55);
                border-color: rgba(255, 255, 255, .10);
                box-shadow: 0 12px 28px rgba(0, 0, 0, .45);
            }

            /* Rozet (kâr/zarar) – light daha okunur */
            #savings-detail-modal .asset-badge {
                border-radius: 999px;
                border: 1px solid rgba(0, 0, 0, .08);
            }

            #savings-detail-modal .asset-badge.profit {
                background: rgba(16, 185, 129, .14);
                color: rgba(4, 120, 87, 1);
                border-color: rgba(16, 185, 129, .25);
            }

            #savings-detail-modal .asset-badge.loss {
                background: rgba(239, 68, 68, .12);
                color: rgba(185, 28, 28, 1);
                border-color: rgba(239, 68, 68, .22);
            }

            html.dark #savings-detail-modal .asset-badge.profit {
                background: rgba(16, 185, 129, .12);
                color: rgba(110, 231, 183, 1);
                border-color: rgba(16, 185, 129, .25);
            }

            html.dark #savings-detail-modal .asset-badge.loss {
                background: rgba(239, 68, 68, .12);
                color: rgba(252, 165, 165, 1);
                border-color: rgba(239, 68, 68, .25);
            }

            /* Progress bar */
            #savings-detail-modal .asset-bar {
                background: rgba(0, 0, 0, .08);
                height: 6px;
                border-radius: 999px;
                overflow: hidden;
            }

            html.dark #savings-detail-modal .asset-bar {
                background: rgba(255, 255, 255, .10);
            }

            #savings-detail-modal .asset-bar-fill {
                height: 100%;
                border-radius: 999px;
                filter: saturate(1.05);
            }

            /* Hover/press (iOS hissi) */
            #savings-detail-modal .asset-card {
                transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
            }

            #savings-detail-modal .asset-card:hover {
                transform: translateY(-1px);
                border-color: rgba(99, 102, 241, .28);
            }

            #savings-detail-modal .asset-card:active {
                transform: translateY(0) scale(.995);
            }

            /* Reduce motion */
            @media (prefers-reduced-motion: reduce) {
                #savings-detail-modal .asset-card {
                    transition: none;
                }
            }

            /* NOTES MODAL - MOBILE OVERFLOW FIX (date input taşma)           */
            /* ═══════════════════════════════════════════════════════════════ */
            @media (max-width: 768px) {

                /* Modal overlay: yatay taşmayı kesin engelle + safe-area uyumu */
                #notes-modal {
                    overflow-x: hidden !important;
                    padding-left: max(12px, env(safe-area-inset-left)) !important;
                    padding-right: max(12px, env(safe-area-inset-right)) !important;
                    padding-top: max(12px, env(safe-area-inset-top)) !important;
                    padding-bottom: max(12px, env(safe-area-inset-bottom)) !important;
                }

                /* Modal kartı: küçük ekranlarda sağa taşma olmasın */
                #notes-modal>div.glass-card {
                    width: min(420px, calc(100vw - 24px - env(safe-area-inset-left) - env(safe-area-inset-right))) !important;
                    max-width: 100% !important;
                    margin-left: auto !important;
                    margin-right: auto !important;
                    overflow: hidden !important;
                    box-sizing: border-box !important;
                }

                /* Kritik: iOS'ta date input bazen kendi min-width'üyle taşar -> zorla sığdır */
                #notes-modal input[type="date"],
                #notes-modal input#note-task-date {
                    display: block !important;
                    width: 100% !important;
                    max-width: 100% !important;
                    min-width: 0 !important;
                    box-sizing: border-box !important;
                }

                /* modern-input genel shrink desteği (sadece modal scope) */
                #notes-modal .modern-input {
                    min-width: 0 !important;
                    max-width: 100% !important;
                    box-sizing: border-box !important;
                }
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* MICRO FEEDBACK SYSTEM                                           */
            /* ═══════════════════════════════════════════════════════════════ */

            #micro-feedback-root {
                position: fixed;
                left: 0;
                right: 0;
                transform: none;
                bottom: var(--micro-feedback-bottom, calc(100px + env(safe-area-inset-bottom, 0px)));
                z-index: 99999;
                pointer-events: none;
                display: flex;
                justify-content: center;
                padding-left: max(16px, env(safe-area-inset-left, 0px));
                padding-right: max(16px, env(safe-area-inset-right, 0px));
            }

            .micro-pill {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 18px;
                border-radius: 50px;
                font-size: 13px;
                font-weight: 600;
                line-height: 1.2;
                max-width: min(320px, calc(100vw - 32px));
                background: var(--glass-bg, rgba(255, 255, 255, 0.85));
                border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.3));
                backdrop-filter: blur(16px) saturate(180%);
                -webkit-backdrop-filter: blur(16px) saturate(180%);
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
                color: var(--text-primary, #1f2937);
                opacity: 0;
                transform: translateY(12px) scale(0.96);
                transition: opacity 220ms ease-out, transform 220ms ease-out;
                pointer-events: auto;
                text-align: center;
                word-break: break-word;
            }

            html.dark .micro-pill {
                background: rgba(30, 35, 50, 0.9);
                border-color: rgba(255, 255, 255, 0.1);
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.35);
                color: #f1f5f9;
            }

            .micro-pill.show {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            .micro-pill.hide {
                opacity: 0;
                transform: translateY(-8px) scale(0.96);
            }

            .micro-pill__icon {
                font-size: 16px;
                flex-shrink: 0;
                line-height: 1;
            }

            /* Type variations */
            .micro-pill--success {
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
                border-color: rgba(16, 185, 129, 0.3);
            }

            html.dark .micro-pill--success {
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(16, 185, 129, 0.1));
                border-color: rgba(16, 185, 129, 0.4);
            }

            .micro-pill--error {
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
                border-color: rgba(239, 68, 68, 0.3);
            }

            html.dark .micro-pill--error {
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.1));
                border-color: rgba(239, 68, 68, 0.4);
            }

            .micro-pill--info {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.05));
                border-color: rgba(99, 102, 241, 0.3);
            }

            html.dark .micro-pill--info {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(99, 102, 241, 0.1));
                border-color: rgba(99, 102, 241, 0.4);
            }

            /* Inline anchor chip */
            .micro-chip {
                position: absolute;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                background: var(--glass-bg, rgba(255, 255, 255, 0.9));
                border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.3));
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
                color: var(--text-primary, #1f2937);
                z-index: 100;
                opacity: 0;
                transform: translateY(4px);
                animation: chipFade 900ms ease-out forwards;
                pointer-events: none;
            }

            html.dark .micro-chip {
                background: rgba(30, 35, 50, 0.9);
                border-color: rgba(255, 255, 255, 0.1);
                color: #f1f5f9;
            }

            @keyframes chipFade {
                0% {
                    opacity: 0;
                    transform: translateY(4px);
                }

                15% {
                    opacity: 1;
                    transform: translateY(0);
                }

                85% {
                    opacity: 1;
                    transform: translateY(0);
                }

                100% {
                    opacity: 0;
                    transform: translateY(-4px);
                }
            }

            /* Button flash animation */
            .btn-flash-success {
                animation: btnFlashSuccess 900ms ease-out;
            }

            .btn-flash-error {
                animation: btnFlashError 900ms ease-out;
            }

            @keyframes btnFlashSuccess {
                0% {
                    transform: scale(1);
                }

                15% {
                    transform: scale(1.02);
                    background: linear-gradient(135deg, #10b981, #059669) !important;
                }

                85% {
                    transform: scale(1.02);
                }

                100% {
                    transform: scale(1);
                }
            }

            @keyframes btnFlashError {
                0% {
                    transform: scale(1);
                }

                15% {
                    transform: scale(1.02);
                    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
                }

                85% {
                    transform: scale(1.02);
                }

                100% {
                    transform: scale(1);
                }
            }

            /* Reduced Motion for Micro Feedback */
            @media (prefers-reduced-motion: reduce) {

                .micro-pill,
                .micro-chip {
                    transition: opacity 100ms ease-out !important;
                    transform: none !important;
                }

                .btn-flash-success,
                .btn-flash-error {
                    animation: none !important;
                }
            }

            /* Market Rate Badge Styles */
            .rate-change-badge {
                font-size: 10px;
                font-weight: 700;
                padding: 2px 6px;
                border-radius: 999px;
                display: inline-flex;
                align-items: center;
                gap: 2px;
                transition: all 0.3s ease;
                backdrop-filter: blur(4px);
            }

            .rate-change-badge.up {
                background: var(--accent-success-bg, rgba(16, 185, 129, 0.1));
                color: var(--accent-success, #10b981);
            }

            .rate-change-badge.down {
                background: var(--accent-danger-bg, rgba(244, 63, 94, 0.1));
                color: var(--accent-danger, #f43f5e);
            }

            .rate-change-badge.flat {
                background: var(--accent-neutral-bg, rgba(148, 163, 184, 0.1));
                color: var(--text-muted, #94a3b8);
            }

            .rate-change-badge.na {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.5);
            }

            /* ================================
           PERFORMANCE MODE (Mobile)
           ================================ */
            html.perf body::before,
            html.perf body::after,
            html.perf #app-container::before {
                /* En büyük FPS katili: blur + hue-rotate animasyonu */
                animation: none !important;
                filter: blur(24px) !important;
                /* 60-80px yerine */
                opacity: 0.55 !important;
            }

            /* Header cam efekti pahalı: mobil perf modda blur azalt */
            html.perf header[style*="backdrop-filter"] {
                backdrop-filter: blur(10px) saturate(140%) !important;
                -webkit-backdrop-filter: blur(10px) saturate(140%) !important;
            }

            /* Küçük "badge"lerdeki blur da pahalı olabilir */
            html.perf .rate-change-badge {
                backdrop-filter: blur(0px) !important;
                -webkit-backdrop-filter: blur(0px) !important;
            }

            /* Animasyon yoğun yerlerde hareket azalt */
            @media (prefers-reduced-motion: reduce) {

                body::before,
                body::after,
                #app-container::before {
                    animation: none !important;
                }
            }

            /* Görünmeyen ekranlar render edilmesin (ekranlar arası geçişlerde rahatlatır) */
            html.perf #screen-dashboard,
            html.perf #screen-notes,
            html.perf #screen-wallet,
            html.perf #screen-add {
                contain: layout paint style;
            }

            /* Scroll sırasında jank azaltma */
            html.perf * {
                scroll-behavior: auto !important;
            }

            /* ================================
           VISIBILITY PAUSE (Tab arka planda)
           ================================ */
            html.paused body::before,
            html.paused body::after,
            html.paused #app-container::before {
                animation-play-state: paused !important;
            }

            /* ================================
           FINGO STORYTELLING ONBOARDING
           PREMIUM & GOLD MODE STYLES
           ================================ */

            /* Premium Card: Deep Black + Animated Gold Border + Particle Glow */
            .holo-card.card-premium {
                background: linear-gradient(155deg,
                        #0a0a0a 0%,
                        #151515 50%,
                        #0d0d0d 100%) !important;
                border: 2px solid transparent !important;
                background-clip: padding-box !important;
                position: relative;
                box-shadow:
                    0 30px 80px rgba(0, 0, 0, 0.8),
                    0 0 60px rgba(255, 215, 0, 0.2),
                    0 0 120px rgba(255, 215, 0, 0.1),
                    inset 0 1px 0 rgba(255, 215, 0, 0.1) !important;
            }

            /* Animated Gold Border */
            .holo-card.card-premium::before {
                content: '' !important;
                position: absolute !important;
                inset: -2px !important;
                border-radius: 38px !important;
                background: linear-gradient(var(--gold-angle, 0deg),
                        #ffd700, #daa520, #b8860b, #daa520, #ffd700) !important;
                z-index: -1 !important;
                animation: goldBorderRotate 4s linear infinite !important;
                height: auto !important;
            }

            @keyframes goldBorderRotate {
                0% {
                    --gold-angle: 0deg;
                }

                100% {
                    --gold-angle: 360deg;
                }
            }

            @property --gold-angle {
                syntax: '<angle>';
                initial-value: 0deg;
                inherits: false;
            }

            /* Gold Shimmer Overlay */
            .holo-card.card-premium::after {
                content: '' !important;
                position: absolute !important;
                top: 0 !important;
                left: -100% !important;
                width: 50% !important;
                height: 100% !important;
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 215, 0, 0.15),
                        transparent) !important;
                animation: goldShimmer 3s ease-in-out infinite !important;
                border-radius: 36px !important;
                z-index: 1 !important;
            }

            @keyframes goldShimmer {
                0% {
                    left: -100%;
                }

                50%,
                100% {
                    left: 150%;
                }
            }

            /* Premium Text Colors - Gold Gradient */
            .holo-card.card-premium .holo-title {
                background: linear-gradient(135deg, #fffbe8, #ffd700, #daa520, #ffd700) !important;
                background-size: 300% 300% !important;
                -webkit-background-clip: text !important;
                background-clip: text !important;
                -webkit-text-fill-color: transparent !important;
                animation: goldTextShift 4s ease infinite, none !important;
                text-shadow: none !important;
                filter: drop-shadow(0 4px 20px rgba(255, 215, 0, 0.4));
            }

            @keyframes goldTextShift {

                0%,
                100% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }
            }

            .holo-card.card-premium .holo-desc {
                color: rgba(255, 255, 255, 0.9);
                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            }

            /* Premium Progress Dots - Gold Theme */
            .holo-card.card-premium .holo-dot.active {
                background: linear-gradient(135deg, #ffd700, #daa520) !important;
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.7),
                    0 0 30px rgba(255, 215, 0, 0.4) !important;
            }

            /* Gold Mode Background Orbs - Enhanced */
            .holo-orbs.gold-mode .holo-orb {
                background: radial-gradient(circle,
                        rgba(255, 215, 0, 0.8),
                        rgba(218, 165, 32, 0.6),
                        transparent 65%);
                opacity: 0.7;
                filter: blur(100px);
                animation-duration: 15s !important;
            }

            .holo-orbs.gold-mode .holo-orb-1 {
                background: radial-gradient(circle,
                        rgba(255, 215, 0, 0.9),
                        transparent 60%);
            }

            .holo-orbs.gold-mode .holo-orb-2 {
                background: radial-gradient(circle,
                        rgba(255, 180, 0, 0.7),
                        transparent 55%);
            }

            /* ================================
           PREMIUM CTA BUTTONS
           ================================ */

            /* Pulse Animation for Primary Button */
            @keyframes pulse-gold {
                0% {
                    box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.5),
                        0 15px 40px -10px rgba(255, 215, 0, 0.4);
                }

                70% {
                    box-shadow: 0 0 0 18px rgba(255, 215, 0, 0),
                        0 15px 40px -10px rgba(255, 215, 0, 0.4);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(255, 215, 0, 0),
                        0 15px 40px -10px rgba(255, 215, 0, 0.4);
                }
            }

            .holo-cta.pulse-gold {
                background: linear-gradient(135deg, #ffd700 0%, #daa520 50%, #b8860b 100%);
                color: #000;
                font-weight: 800;
                font-size: 17px;
                letter-spacing: -0.02em;
                animation: pulse-gold 2s infinite;
                border: none;
                border-radius: 16px;
                padding: 18px 24px;
                position: relative;
                overflow: hidden;
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3);
            }

            .holo-cta.pulse-gold::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 255, 255, 0.4),
                        transparent);
                animation: ctaShine 2.5s ease-in-out infinite;
            }

            @keyframes ctaShine {
                0% {
                    left: -100%;
                }

                50%,
                100% {
                    left: 100%;
                }
            }

            .holo-cta.pulse-gold:hover {
                transform: translateY(-2px) scale(1.02);
                filter: brightness(1.1);
            }

            .holo-cta.pulse-gold:active {
                transform: scale(0.98);
            }

            /* Secondary Link Button - Improved */
            .holo-secondary-link {
                display: block;
                text-align: center;
                margin-top: 16px;
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.5);
                text-decoration: none;
                background: none;
                border: none;
                width: 100%;
                cursor: pointer;
                padding: 12px;
                border-radius: 12px;
                transition: all 0.3s ease;
            }

            .holo-secondary-link:hover {
                color: rgba(255, 255, 255, 0.8);
                background: rgba(255, 255, 255, 0.05);
                text-decoration: underline;
            }

            /* ═══════════════════════════════════════════════════════════════════════════════
           ███████╗ ██████╗ ███████╗████████╗    ██╗   ██╗██╗    ███████╗██╗   ██╗███████╗
           ██╔════╝██╔═══██╗██╔════╝╚══██╔══╝    ██║   ██║██║    ██╔════╝╚██╗ ██╔╝██╔════╝
           ███████╗██║   ██║█████╗     ██║       ██║   ██║██║    ███████╗ ╚████╔╝ ███████╗
           ╚════██║██║   ██║██╔══╝     ██║       ██║   ██║██║    ╚════██║  ╚██╔╝  ╚════██║
           ███████║╚██████╔╝██║        ██║       ╚██████╔╝██║    ███████║   ██║   ███████║
           ╚══════╝ ╚═════╝ ╚═╝        ╚═╝        ╚═════╝ ╚═╝    ╚══════╝   ╚═╝   ╚══════╝
           SOFT-UI SYSTEM v1 - Apple Award Glass + Neumorphism Design Tokens
           ═══════════════════════════════════════════════════════════════════════════════ */

            /* ─────────────────────────────────────────────────────────────────
           DESIGN TOKENS - LIGHT MODE (Default)
           ───────────────────────────────────────────────────────────────── */
            :root {
                /* Background & Surface Colors */
                --sui-bg: #f0f4f8;
                --sui-bg-gradient: linear-gradient(165deg, #e8eef5 0%, #f0f4f8 50%, #e4ecf4 100%);
                --sui-surface: rgba(255, 255, 255, 0.72);
                --sui-surface2: rgba(241, 245, 249, 0.85);
                --sui-surface-solid: #ffffff;
                --sui-stroke: rgba(255, 255, 255, 0.6);
                --sui-stroke-subtle: rgba(0, 0, 0, 0.04);

                /* Text Colors */
                --sui-text: #1e293b;
                --sui-text-secondary: #475569;
                --sui-muted: #64748b;

                /* Accent Colors */
                --sui-accent: #6366f1;
                --sui-accent-secondary: #8b5cf6;
                --sui-success: #10b981;
                --sui-danger: #f43f5e;
                --sui-warning: #f59e0b;

                /* Shadow Sets - Neumorphism */
                --sui-sd-drop: 6px 6px 16px rgba(166, 180, 200, 0.4);
                --sui-sd-hi: -4px -4px 12px rgba(255, 255, 255, 0.95);
                --sui-sd-inset: inset 3px 3px 6px rgba(166, 180, 200, 0.25),
                    inset -3px -3px 6px rgba(255, 255, 255, 0.8);
                --sui-sd-float: 0 8px 32px rgba(99, 102, 241, 0.18),
                    0 2px 8px rgba(0, 0, 0, 0.06);
                --sui-sd-glass: 0 8px 32px rgba(0, 0, 0, 0.08),
                    0 0 0 1px rgba(255, 255, 255, 0.5) inset;

                /* Border Radii */
                --sui-r-sheet: 32px;
                --sui-r-card: 24px;
                --sui-r-btn: 16px;
                --sui-r-pill: 999px;

                /* Spacing */
                --sui-pad: 16px;
                --sui-pad-lg: 20px;
                --sui-gap: 12px;

                /* Motion */
                --sui-ease: cubic-bezier(0.4, 0, 0.2, 1);
                --sui-ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
                --sui-duration: 160ms;
                --sui-duration-slow: 300ms;
            }

            /* ─────────────────────────────────────────────────────────────────
           DESIGN TOKENS - DARK MODE
           ───────────────────────────────────────────────────────────────── */
            html.dark {
                --sui-bg: #0c0a14;
                --sui-bg-gradient: linear-gradient(165deg, #0f0d18 0%, #0c0a14 50%, #100e1a 100%);
                --sui-surface: rgba(30, 27, 48, 0.75);
                --sui-surface2: rgba(22, 20, 38, 0.85);
                --sui-surface-solid: #1a1625;
                --sui-stroke: rgba(255, 255, 255, 0.08);
                --sui-stroke-subtle: rgba(255, 255, 255, 0.03);

                --sui-text: #f1f5f9;
                --sui-text-secondary: #cbd5e1;
                --sui-muted: #94a3b8;

                --sui-sd-drop: 6px 6px 20px rgba(0, 0, 0, 0.5);
                --sui-sd-hi: -3px -3px 10px rgba(255, 255, 255, 0.03);
                --sui-sd-inset: inset 3px 3px 8px rgba(0, 0, 0, 0.45),
                    inset -2px -2px 6px rgba(255, 255, 255, 0.02);
                --sui-sd-float: 0 8px 32px rgba(99, 102, 241, 0.12),
                    0 2px 8px rgba(0, 0, 0, 0.3);
                --sui-sd-glass: 0 8px 32px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(255, 255, 255, 0.06) inset;
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .app-bg
           Main app background with subtle aurora gradient
           ───────────────────────────────────────────────────────────────── */
            .app-bg {
                background: var(--sui-bg-gradient);
                min-height: 100dvh;
            }

            .app-bg::before {
                content: '';
                position: fixed;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(ellipse at 30% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                    radial-gradient(ellipse at 70% 80%, rgba(139, 92, 246, 0.06) 0%, transparent 40%);
                pointer-events: none;
                z-index: 0;
                animation: sui-aurora 25s ease-in-out infinite alternate;
            }

            html.dark .app-bg::before {
                background: radial-gradient(ellipse at 30% 20%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
                    radial-gradient(ellipse at 70% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 40%);
            }

            @keyframes sui-aurora {
                0% {
                    transform: translate(0, 0) rotate(0deg);
                }

                100% {
                    transform: translate(2%, 2%) rotate(3deg);
                }
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .soft-card
           Neumorphic card with drop shadow + highlight
           ───────────────────────────────────────────────────────────────── */
            .soft-card {
                background: var(--sui-surface);
                border: 1px solid var(--sui-stroke);
                border-radius: var(--sui-r-card);
                box-shadow: var(--sui-sd-drop), var(--sui-sd-hi);
                backdrop-filter: blur(12px) saturate(140%);
                -webkit-backdrop-filter: blur(12px) saturate(140%);
                transition: transform var(--sui-duration) var(--sui-ease),
                    box-shadow var(--sui-duration) var(--sui-ease);
                position: relative;
                overflow: hidden;
            }

            .soft-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 50%;
                background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, transparent 100%);
                border-radius: var(--sui-r-card) var(--sui-r-card) 0 0;
                pointer-events: none;
            }

            html.dark .soft-card::before {
                background: linear-gradient(180deg, rgba(255, 255, 255, 0.04) 0%, transparent 100%);
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .soft-inset
           Recessed/sunken panel effect (oyuk)
           ───────────────────────────────────────────────────────────────── */
            .soft-inset {
                background: var(--sui-surface2);
                border: 1px solid var(--sui-stroke-subtle);
                border-radius: var(--sui-r-btn);
                box-shadow: var(--sui-sd-inset);
                padding: var(--sui-pad);
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .soft-pill
           Capsule/pill shaped button or chip (min 44px tap target)
           ───────────────────────────────────────────────────────────────── */
            .soft-pill {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                min-height: 44px;
                padding: 10px 18px;
                background: var(--sui-surface);
                border: 1px solid var(--sui-stroke);
                border-radius: var(--sui-r-pill);
                box-shadow: var(--sui-sd-drop), var(--sui-sd-hi);
                font-weight: 600;
                font-size: 14px;
                color: var(--sui-text);
                cursor: pointer;
                transition: all var(--sui-duration) var(--sui-ease);
                -webkit-tap-highlight-color: transparent;
            }

            .soft-pill:hover {
                transform: translateY(-1px);
                box-shadow: var(--sui-sd-float);
            }

            .soft-pill:active,
            .soft-pill.active {
                transform: scale(0.97);
                box-shadow: var(--sui-sd-inset);
            }

            /* Pill Variants */
            .soft-pill--accent {
                background: linear-gradient(135deg, var(--sui-accent), var(--sui-accent-secondary));
                color: white;
                border-color: transparent;
            }

            .soft-pill--success {
                background: rgba(16, 185, 129, 0.12);
                color: var(--sui-success);
                border-color: rgba(16, 185, 129, 0.2);
            }

            .soft-pill--danger {
                background: rgba(244, 63, 94, 0.12);
                color: var(--sui-danger);
                border-color: rgba(244, 63, 94, 0.2);
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .icon-chip
           44x44 icon container with subtle gloss
           ───────────────────────────────────────────────────────────────── */
            .icon-chip {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                border-radius: 14px;
                background: var(--sui-surface);
                border: 1px solid var(--sui-stroke);
                box-shadow: var(--sui-sd-drop), var(--sui-sd-hi);
                position: relative;
                overflow: hidden;
                flex-shrink: 0;
            }

            .icon-chip::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 50%;
                background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
                border-radius: 14px 14px 0 0;
                pointer-events: none;
            }

            html.dark .icon-chip::before {
                background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
            }

            /* Icon chip with tinted backgrounds */
            .icon-chip--success {
                background: rgba(16, 185, 129, 0.15);
                border-color: rgba(16, 185, 129, 0.2);
            }

            .icon-chip--danger {
                background: rgba(244, 63, 94, 0.15);
                border-color: rgba(244, 63, 94, 0.2);
            }

            .icon-chip--accent {
                background: rgba(99, 102, 241, 0.15);
                border-color: rgba(99, 102, 241, 0.2);
            }

            .icon-chip--warning {
                background: rgba(245, 158, 11, 0.15);
                border-color: rgba(245, 158, 11, 0.2);
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .glass-sheet
           Modal/sheet with heavy blur + glass effect
           ───────────────────────────────────────────────────────────────── */
            .glass-sheet {
                background: var(--sui-surface);
                border: 1px solid var(--sui-stroke);
                border-radius: var(--sui-r-sheet);
                box-shadow: var(--sui-sd-glass), 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
            }

            /* Fallback for devices without backdrop-filter */
            @supports not (backdrop-filter: blur(20px)) {
                .glass-sheet {
                    background: var(--sui-surface-solid);
                }
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .hairline
           1px subtle divider
           ───────────────────────────────────────────────────────────────── */
            .hairline {
                height: 1px;
                background: var(--sui-stroke-subtle);
                border: none;
                margin: var(--sui-gap) 0;
            }

            html.dark .hairline {
                background: rgba(255, 255, 255, 0.06);
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .tap-anim
           Press/tap animation for interactive elements
           ───────────────────────────────────────────────────────────────── */
            .tap-anim {
                transition: transform var(--sui-duration) var(--sui-ease-bounce),
                    box-shadow var(--sui-duration) var(--sui-ease);
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
            }

            .tap-anim:hover {
                transform: translateY(-2px) scale(1.01);
            }

            .tap-anim:active {
                transform: scale(0.985);
                box-shadow: var(--sui-sd-inset) !important;
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .focus-ring
           Accessible focus indicator
           ───────────────────────────────────────────────────────────────── */
            .focus-ring:focus-visible {
                outline: none;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4),
                    var(--sui-sd-drop), var(--sui-sd-hi);
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY CLASS: .noise-overlay
           Subtle grain/noise texture
           ───────────────────────────────────────────────────────────────── */
            .noise-overlay::after {
                content: '';
                position: absolute;
                inset: 0;
                background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
                opacity: 0.015;
                pointer-events: none;
                border-radius: inherit;
                mix-blend-mode: overlay;
            }

            html.dark .noise-overlay::after {
                opacity: 0.03;
            }

            /* ─────────────────────────────────────────────────────────────────
           UTILITY: Typography helpers
           ───────────────────────────────────────────────────────────────── */
            .sui-title {
                font-size: 22px;
                font-weight: 800;
                letter-spacing: -0.02em;
                color: var(--sui-text);
            }

            .sui-label {
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--sui-muted);
            }

            .sui-value {
                font-size: 28px;
                font-weight: 900;
                letter-spacing: -0.02em;
                color: var(--sui-text);
            }

            /* ─────────────────────────────────────────────────────────────────
           FLOATING NAV BAR ENHANCEMENT
           ───────────────────────────────────────────────────────────────── */
            .sui-floating-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 8px 16px calc(8px + env(safe-area-inset-bottom, 0px));
                background: var(--sui-surface);
                border-top: 1px solid var(--sui-stroke);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.08);
                z-index: 9999;
            }

            html.dark .sui-floating-nav {
                box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
            }

            /* ─────────────────────────────────────────────────────────────────
           REDUCED MOTION SUPPORT
           ───────────────────────────────────────────────────────────────── */
            @media (prefers-reduced-motion: reduce) {

                .soft-card,
                .soft-pill,
                .icon-chip,
                .tap-anim,
                .glass-sheet {
                    transition-duration: 0ms !important;
                }

                .app-bg::before {
                    animation: none !important;
                }

                .tap-anim:hover,
                .tap-anim:active {
                    transform: none !important;
                }
            }

            /* ─────────────────────────────────────────────────────────────────
           PERFORMANCE MODE OPTIMIZATIONS
           ───────────────────────────────────────────────────────────────── */
            html.perf .soft-card,
            html.perf .glass-sheet {
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            }

            html.perf .app-bg::before {
                animation: none !important;
                opacity: 0.5 !important;
            }

            /* ─────────────────────────────────────────────────────────────────
           SAFE AREA UTILITIES
           ───────────────────────────────────────────────────────────────── */
            .sui-safe-bottom {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            .sui-safe-top {
                padding-top: env(safe-area-inset-top, 0px);
            }

            /* ─────────────────────────────────────────────────────────────────
           APPLE AWARD LIQUID GLASS WIDGET STYLES (3D ICONS)
           ───────────────────────────────────────────────────────────────── */
            /* === Net Nakit & Birikim: 3D Animated Icon Capsule (Apple Award) === */

            /* Kart tipine göre ikon gradienti */
            .pw-widget--cash {
                --ig1: var(--accent-primary);
                --ig2: var(--accent-secondary);
                --igGlow: rgba(99, 102, 241, .38);
            }

            .pw-widget--savings {
                --ig1: var(--accent-secondary);
                --ig2: #d946ef;
                --igGlow: rgba(217, 70, 239, .30);
            }

            /* 3D kapsül */
            .pw-icon3d {
                width: 46px;
                height: 46px;
                border-radius: 999px;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;

                /* “cam + jel” hissi */
                background:
                    radial-gradient(120% 120% at 30% 20%, rgba(255, 255, 255, .70), rgba(255, 255, 255, 0) 45%),
                    linear-gradient(135deg, var(--ig1), var(--ig2));

                border: 1px solid rgba(255, 255, 255, .45);
                box-shadow:
                    0 18px 30px rgba(0, 0, 0, .18),
                    0 6px 14px rgba(0, 0, 0, .10),
                    inset 0 1px 0 rgba(255, 255, 255, .60),
                    inset 0 -10px 18px rgba(0, 0, 0, .14);

                transform: translateZ(44px);
                will-change: transform;
            }

            /* Light mode daha “soft” */
            html:not(.dark) .pw-icon3d {
                border-color: rgba(0, 0, 0, .08);
                box-shadow:
                    0 16px 26px rgba(15, 23, 42, .12),
                    0 6px 12px rgba(15, 23, 42, .08),
                    inset 0 1px 0 rgba(255, 255, 255, .85),
                    inset 0 -10px 18px rgba(15, 23, 42, .08);
            }

            /* Dış halka + glow */
            .pw-icon3d::after {
                content: "";
                position: absolute;
                inset: -8px;
                border-radius: inherit;
                box-shadow: 0 0 0 1px rgba(255, 255, 255, .20), 0 0 28px var(--igGlow);
                opacity: .75;
                pointer-events: none;
            }

            html:not(.dark) .pw-icon3d::after {
                box-shadow: 0 0 0 1px rgba(0, 0, 0, .06), 0 10px 30px var(--igGlow);
                opacity: .55;
            }

            /* Ikon (emoji) daha “kabartma” dursun */
            .pw-icon3d__glyph {
                font-size: 18px;
                line-height: 1;
                transform: translateZ(2px);
                text-shadow: 0 8px 18px rgba(0, 0, 0, .22), 0 1px 0 rgba(255, 255, 255, .30);
            }

            /* Hover’da parlama çizgisi (sürekli değil → performans iyi) */
            .pw-icon3d::before {
                content: "";
                position: absolute;
                inset: -30%;
                background: linear-gradient(115deg, transparent 35%, rgba(255, 255, 255, .65) 45%, transparent 55%);
                transform: translateX(-140%) rotate(15deg);
                opacity: .55;
                pointer-events: none;
            }

            .pw-widget:hover .pw-icon3d::before,
            .pw-widget:active .pw-icon3d::before {
                animation: pwIconShine 1.2s ease;
            }

            @keyframes pwIconShine {
                to {
                    transform: translateX(140%) rotate(15deg);
                }
            }

            /* Yumuşak “float” animasyonu (perf modunda ve reduced-motion’da kapanır) */
            @keyframes pwIconFloat {

                0%,
                100% {
                    transform: translateZ(44px) translateY(0) rotate(-2deg);
                }

                50% {
                    transform: translateZ(44px) translateY(-6px) rotate(2deg);
                }
            }

            html:not(.perf) .pw-widget .pw-icon3d {
                animation: pwIconFloat 7s ease-in-out infinite;
            }

            @media (max-width: 768px) {
                html:not(.perf) .pw-widget .pw-icon3d {
                    animation-duration: 9s;
                }
            }

            @media (prefers-reduced-motion: reduce) {
                .pw-icon3d {
                    animation: none !important;
                }
            }

            /* Essential Quality Touch - Premium Card Shadows */
            .pw-widget--cash.pw-glass,
            .pw-widget--savings.pw-glass {
                box-shadow:
                    var(--pw-shadow),
                    inset 0 1px 0 rgba(255, 255, 255, .35),
                    inset 0 -22px 38px rgba(0, 0, 0, .08);
            }

            html:not(.dark) .pw-widget--cash.pw-glass,
            html:not(.dark) .pw-widget--savings.pw-glass {
                box-shadow:
                    var(--pw-shadow),
                    inset 0 1px 0 rgba(255, 255, 255, .55),
                    inset 0 -20px 34px rgba(15, 23, 42, .06);
            }

            /* =========================
   Premium 3D Icon (neo-glass)
   ========================= */

            .pw-widget {
                position: relative;
                overflow: hidden;
                isolation: isolate;
            }

            /* üstten yumuşak ışık + ince “sheen” */
            .pw-widget::before {
                content: "";
                position: absolute;
                inset: -1px;
                background:
                    radial-gradient(120% 80% at 20% 10%, rgba(255, 255, 255, .55), transparent 55%),
                    radial-gradient(80% 60% at 90% 0%, rgba(255, 255, 255, .35), transparent 55%);
                opacity: .55;
                pointer-events: none;
                z-index: 1;
            }

            /* sağa kayan parıltı çizgisi */
            .pw-widget::after {
                content: "";
                position: absolute;
                inset: -40% -60%;
                background: linear-gradient(120deg, transparent 35%, rgba(255, 255, 255, .35) 45%, transparent 55%);
                transform: translateX(-35%) rotate(6deg);
                opacity: .35;
                filter: blur(2px);
                pointer-events: none;
                z-index: 2;
                animation: pwSheen 6.5s ease-in-out infinite;
            }

            /* Kart hover/tap micro-tilt (mobilde active) */
            .pw-widget:hover {
                transform: translateY(-1px);
            }

            .pw-widget:active {
                transform: translateY(0px) scale(.995);
            }

            /* Cash / Savings aksanını daha “premium” yumuşat */
            .pw-widget--cash .pw-accent {
                opacity: .45;
                filter: blur(18px);
            }

            .pw-widget--savings .pw-accent {
                opacity: .40;
                filter: blur(18px);
            }

            /* Bu sınıflar zaten var, sadece daha yumuşatıyoruz. :contentReference[oaicite:4]{index=4} */

            @keyframes pwSheen {

                0%,
                25% {
                    transform: translateX(-35%) rotate(6deg);
                    opacity: .10;
                }

                45% {
                    opacity: .35;
                }

                70%,
                100% {
                    transform: translateX(35%) rotate(6deg);
                    opacity: .12;
                }
            }

            /* 3D Icon badge */
            .pw-icon3d {
                width: 52px;
                height: 52px;
                border-radius: 18px;
                display: grid;
                place-items: center;
                position: relative;
                transform-style: preserve-3d;

                background: linear-gradient(135deg, rgba(255, 255, 255, .70), rgba(255, 255, 255, .28));
                border: 1px solid rgba(255, 255, 255, .55);
                box-shadow:
                    0 18px 35px rgba(0, 0, 0, .14),
                    0 1px 0 rgba(255, 255, 255, .55) inset;
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);

                animation: pwIconFloat 3.6s ease-in-out infinite;
            }

            .pw-icon3d__glow {
                position: absolute;
                inset: -18px;
                border-radius: 26px;
                filter: blur(18px);
                opacity: .55;
                transform: translateZ(-1px);
                pointer-events: none;
            }

            .pw-icon3d__shine {
                position: absolute;
                inset: 2px;
                border-radius: 16px;
                background: radial-gradient(60% 50% at 20% 15%, rgba(255, 255, 255, .85), transparent 55%);
                opacity: .9;
                pointer-events: none;
            }

            .pw-icon3d__glyph {
                font-size: 22px;
                line-height: 1;
                transform: translateZ(14px);
                filter: drop-shadow(0 10px 16px rgba(0, 0, 0, .18));
                opacity: .92;
            }

            /* renk varyantları */
            .pw-icon3d--cash .pw-icon3d__glow {
                background: radial-gradient(circle at 30% 30%, rgba(16, 185, 129, .55), rgba(99, 102, 241, .35), transparent 70%);
            }

            .pw-icon3d--savings .pw-icon3d__glow {
                background: radial-gradient(circle at 30% 30%, rgba(217, 70, 239, .45), rgba(34, 211, 238, .35), transparent 70%);
            }

            /* hover’da 3D tilt */
            .pw-widget:hover .pw-icon3d {
                transform: translateZ(0) rotateX(6deg) rotateY(-10deg);
            }

            .pw-widget:active .pw-icon3d {
                transform: translateZ(0) rotateX(3deg) rotateY(-6deg) scale(.98);
            }

            @keyframes pwIconFloat {

                0%,
                100% {
                    transform: translateY(0) rotateX(0deg) rotateY(0deg);
                }

                50% {
                    transform: translateY(-3px) rotateX(2deg) rotateY(-2deg);
                }
            }

            /* reduce motion */
            @media (prefers-reduced-motion: reduce) {

                .pw-widget::after,
                .pw-icon3d {
                    animation: none !important;
                }

                .pw-widget:hover,
                .pw-widget:active {
                    transform: none !important;
                }
            }

            /* =========================================
           ONBOARDING - Theme Consistent Style
           ========================================= */
            .ob-overlay {
                position: fixed;
                inset: 0;
                z-index: 9999;
                height: 100dvh;
                background: linear-gradient(160deg, #667eea 0%, #764ba2 50%, #4F46E5 100%);
                display: flex;
                flex-direction: column;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
                overflow: hidden;
            }

            /* Dark mode background */
            html.dark .ob-overlay {
                background: linear-gradient(160deg, #1a1625 0%, #2d1f47 50%, #1e1b4b 100%);
            }

            /* Skip Button - Glass style */
            .ob-skip {
                position: absolute;
                top: calc(16px + env(safe-area-inset-top));
                right: 20px;
                color: rgba(255, 255, 255, 0.85);
                font-size: 14px;
                font-weight: 600;
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 20px;
                padding: 8px 16px;
                cursor: pointer;
                z-index: 10;
                transition: all 0.2s ease;
            }

            .ob-skip:active {
                transform: scale(0.95);
                background: rgba(255, 255, 255, 0.25);
            }

            /* Main Content Area */
            .ob-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 60px 32px 20px;
                text-align: center;
            }


            /* Footer */
            .ob-footer {
                padding: 20px 32px calc(28px + env(safe-area-inset-bottom));
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }

            /* Dots */
            .ob-dots {
                display: flex;
                gap: 8px;
            }

            .ob-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transition: all 0.3s ease;
            }


            /* Animations - Enhanced */
            @keyframes obFadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.5) rotate(-10deg);
                }

                to {
                    opacity: 1;
                    transform: scale(1) rotate(0deg);
                }
            }

            @keyframes obSlideUp {
                from {
                    opacity: 0;
                    transform: translateY(40px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Illustration container - Clean */
            .ob-illustration {
                width: 180px;
                height: 180px;
                margin-bottom: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 50%;
                border: 2px solid rgba(255, 255, 255, 0.2);
            }

            .ob-illustration svg {
                width: 60%;
                height: 60%;
                opacity: 0;
                animation: obFadeIn 0.6s ease-out forwards;
            }

            /* Typography with staggered animations */
            .ob-title {
                font-size: 26px;
                font-weight: 800;
                color: #fff;
                line-height: 1.25;
                margin-bottom: 12px;
                opacity: 0;
                animation: obSlideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s forwards;
                text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
            }

            .ob-desc {
                font-size: 15px;
                font-weight: 400;
                color: rgba(255, 255, 255, 0.85);
                line-height: 1.6;
                max-width: 280px;
                opacity: 0;
                animation: obSlideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s forwards;
            }

            /* CTA Button - Clean */
            .ob-cta {
                width: 100%;
                max-width: 300px;
                height: 54px;
                border-radius: 20px;
                background: #fff;
                border: none;
                color: #4F46E5;
                font-size: 16px;
                font-weight: 700;
                cursor: pointer;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
                transition: all 0.2s ease;
            }

            .ob-cta:active {
                transform: scale(0.97);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            }

            /* Dark mode button */
            html.dark .ob-cta {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #fff;
            }

            /* Dot active - simple */
            .ob-dot.active {
                width: 24px;
                border-radius: 4px;
                background: #fff;
            }

            @media (prefers-reduced-motion: reduce) {

                .ob-illustration svg,
                .ob-title,
                .ob-desc,
                .ob-cta,
                .ob-dot.active,
                .ob-overlay::before,
                .ob-overlay::after,
                .ob-illustration {
                    animation: none !important;
                    opacity: 1 !important;
                }
            }

            /* ══════════════════════════════════════════════════════════════════
           FINGENDA KAPSAMLI GELİŞTİRMELER - CSS STİLLERİ
           v2.1 - Sparkline, Skeleton, Filter, Notifications
        ══════════════════════════════════════════════════════════════════ */

            /* ─── 1. SPARKLINE MİNİ GRAFİKLERİ ─── */
            .sparkline-container {
                width: 60px;
                height: 24px;
                display: flex;
                align-items: flex-end;
                gap: 2px;
                margin-top: 6px;
            }

            .sparkline-bar {
                flex: 1;
                min-width: 4px;
                border-radius: 2px;
                transition: height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                opacity: 0.7;
            }

            .sparkline-bar:hover {
                opacity: 1;
                transform: scaleY(1.1);
            }

            .sparkline-bar.income {
                background: linear-gradient(to top, #10b981, #34d399);
            }

            .sparkline-bar.expense {
                background: linear-gradient(to top, #ef4444, #f87171);
            }

            .sparkline-bar.neutral {
                background: linear-gradient(to top, #6366f1, #818cf8);
            }

            /* ─── 2. SKELETON LOADING ─── */
            .skeleton {
                position: relative;
                overflow: hidden;
                background: linear-gradient(90deg,
                        rgba(200, 200, 200, 0.2) 25%,
                        rgba(200, 200, 200, 0.4) 50%,
                        rgba(200, 200, 200, 0.2) 75%);
                background-size: 200% 100%;
                animation: skeletonShimmer 1.5s ease-in-out infinite;
                border-radius: 8px;
            }

            html.dark .skeleton {
                background: linear-gradient(90deg,
                        rgba(255, 255, 255, 0.05) 25%,
                        rgba(255, 255, 255, 0.1) 50%,
                        rgba(255, 255, 255, 0.05) 75%);
                background-size: 200% 100%;
            }

            @keyframes skeletonShimmer {
                0% {
                    background-position: -200% 0;
                }

                100% {
                    background-position: 200% 0;
                }
            }

            .skeleton-card {
                min-height: 140px;
                border-radius: 24px;
            }

            .skeleton-text {
                height: 14px;
                margin-bottom: 8px;
                width: 70%;
            }

            .skeleton-text-sm {
                height: 10px;
                width: 50%;
            }

            .skeleton-circle {
                width: 44px;
                height: 44px;
                border-radius: 50%;
            }

            .skeleton-transaction {
                height: 72px;
                border-radius: 20px;
                margin-bottom: 12px;
            }

            /* ─── 3. GELİŞMİŞ FİLTRELEME MODALI ─── */
            #advanced-filter-modal {
                z-index: 10000;
            }

            .filter-modal-content {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(30px) saturate(180%);
                -webkit-backdrop-filter: blur(30px) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 28px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                max-height: 80vh;
                overflow-y: auto;
            }

            html.dark .filter-modal-content {
                background: rgba(26, 22, 37, 0.95);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .filter-chip {
                display: inline-flex;
                align-items: center;
                padding: 10px 16px;
                border-radius: 14px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 1.5px solid rgba(0, 0, 0, 0.08);
                background: rgba(0, 0, 0, 0.05);
                color: #374151;
            }

            .filter-chip:hover {
                background: rgba(99, 102, 241, 0.12);
                border-color: rgba(99, 102, 241, 0.3);
                transform: scale(1.02);
            }

            .filter-chip.active {
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                color: white;
                border-color: transparent;
                box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
                font-weight: 700;
            }

            html.dark .filter-chip {
                border-color: rgba(255, 255, 255, 0.15);
                background: rgba(255, 255, 255, 0.1);
                color: #e5e7eb;
            }

            html.dark .filter-chip:hover {
                background: rgba(99, 102, 241, 0.2);
                border-color: rgba(99, 102, 241, 0.4);
            }

            html.dark .filter-chip.active {
                box-shadow: 0 4px 18px rgba(99, 102, 241, 0.5);
            }

            .filter-section {
                margin-bottom: 20px;
                padding-bottom: 20px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }

            html.dark .filter-section {
                border-color: rgba(255, 255, 255, 0.05);
            }

            .filter-section:last-child {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }

            .filter-label {
                font-size: 10px;
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: #6b7280;
                margin-bottom: 12px;
                display: block;
            }

            html.dark .filter-label {
                color: #9ca3af;
            }

            .amount-range-slider {
                -webkit-appearance: none;
                appearance: none;
                width: 100%;
                height: 6px;
                border-radius: 3px;
                background: linear-gradient(to right, #e0e7ff, #6366f1);
                outline: none;
            }

            .amount-range-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5);
                transition: transform 0.2s;
            }

            .amount-range-slider::-webkit-slider-thumb:hover {
                transform: scale(1.1);
            }

            /* ─── 4. BÜTÇE LİMİTİ BİLDİRİMLERİ ─── */
            .budget-alert {
                position: fixed;
                top: calc(100px + env(safe-area-inset-top));
                left: 50%;
                transform: translateX(-50%) translateY(-120%);
                z-index: 9999;
                padding: 16px 24px;
                border-radius: 20px;
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
                transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                max-width: 90%;
            }

            .budget-alert.show {
                transform: translateX(-50%) translateY(0);
            }

            .budget-alert.warning {
                background: linear-gradient(135deg, #fbbf24, #f59e0b);
                color: #78350f;
            }

            .budget-alert.danger {
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
            }

            .budget-alert.success {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
            }

            .budget-alert-icon {
                font-size: 24px;
                flex-shrink: 0;
            }

            .budget-alert-close {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: background 0.2s;
                margin-left: auto;
            }

            .budget-alert-close:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            /* ─── 5. PULL TO REFRESH - DISABLED ─── */
            /* ✅ Pull-to-refresh tamamen kapalı */
            .ptr-container,
            .ptr-indicator,
            .ptr-arrow {
                display: none !important;
                visibility: hidden !important;
                pointer-events: none !important;
                opacity: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
            }

            /* ptrSpin animasyonu devre dışı */
            @keyframes ptrSpin {

                from,
                to {
                    transform: none;
                }
            }

            /* ─── 6. HAFTALIK KARŞILAŞTIRMA KARTI ─── */
            .weekly-comparison-card {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.5);
                border-radius: 24px;
                padding: 20px;
                margin-bottom: 16px;
                position: relative;
                overflow: hidden;
            }

            html.dark .weekly-comparison-card {
                background: linear-gradient(135deg, rgba(26, 22, 37, 0.9), rgba(18, 16, 26, 0.9));
                border-color: rgba(255, 255, 255, 0.1);
            }

            .weekly-comparison-card::before {
                content: "";
                position: absolute;
                top: -50%;
                right: -50%;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
                pointer-events: none;
            }

            .weekly-bar-container {
                display: flex;
                align-items: flex-end;
                gap: 8px;
                height: 80px;
                margin-top: 16px;
            }

            .weekly-bar-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }

            .weekly-bar {
                width: 100%;
                max-width: 32px;
                border-radius: 8px 8px 4px 4px;
                transition: height 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
                position: relative;
            }

            .weekly-bar.current {
                background: linear-gradient(to top, #6366f1, #818cf8);
                box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            }

            .weekly-bar.past {
                background: linear-gradient(to top, #d1d5db, #e5e7eb);
            }

            html.dark .weekly-bar.past {
                background: linear-gradient(to top, #374151, #4b5563);
            }

            .weekly-bar-label {
                font-size: 9px;
                font-weight: 700;
                color: #6b7280;
                text-transform: uppercase;
            }

            html.dark .weekly-bar-label {
                color: #9ca3af;
            }

            .weekly-change-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 10px;
                border-radius: 999px;
                font-size: 11px;
                font-weight: 700;
            }

            .weekly-change-badge.positive {
                background: rgba(16, 185, 129, 0.15);
                color: #10b981;
            }

            .weekly-change-badge.negative {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

            /* ─── 7. FİNGO BRAİN TASARRUF ÖNERİLERİ ─── */
            .savings-suggestion-card {
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));
                border: 1px solid rgba(16, 185, 129, 0.2);
                border-radius: 20px;
                padding: 16px;
                margin: 12px 0;
                position: relative;
                overflow: hidden;
            }

            html.dark .savings-suggestion-card {
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.1));
                border-color: rgba(16, 185, 129, 0.3);
            }

            .savings-suggestion-card::before {
                content: "💡";
                position: absolute;
                top: -20px;
                right: -10px;
                font-size: 60px;
                opacity: 0.1;
                pointer-events: none;
            }

            .savings-suggestion-title {
                font-size: 12px;
                font-weight: 800;
                color: #059669;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            html.dark .savings-suggestion-title {
                color: #34d399;
            }

            .savings-suggestion-text {
                font-size: 14px;
                color: #065f46;
                line-height: 1.5;
            }

            html.dark .savings-suggestion-text {
                color: #a7f3d0;
            }

            .savings-suggestion-amount {
                font-size: 18px;
                font-weight: 800;
                color: #059669;
                margin-top: 8px;
            }

            html.dark .savings-suggestion-amount {
                color: #10b981;
            }

            /* ─── EK ANİMASYONLAR ─── */
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .animate-fade-in-up {
                animation: fadeInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            @keyframes bounceIn {
                0% {
                    transform: scale(0.3);
                    opacity: 0;
                }

                50% {
                    transform: scale(1.05);
                }

                70% {
                    transform: scale(0.9);
                }

                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            .animate-bounce-in {
                animation: bounceIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            /* Performance Mode için azaltılmış animasyonlar */
            html.perf .skeleton {
                animation: none;
                background: rgba(200, 200, 200, 0.3);
            }

            html.perf .budget-alert,
            html.perf .ptr-indicator {
                transition-duration: 0.1s;
            }

            html.perf .weekly-bar,
            html.perf .sparkline-bar {
                transition-duration: 0.2s;
            }

            /* ═══════════════════════════════════════════════════════════════════
           GELİŞMİŞ FİLTRELEME MODALI - MOBILE OPTIMIZED v2.0
           Premium dark/light mode support with proper contrast
        ═══════════════════════════════════════════════════════════════════ */

            /* Modal backdrop */
            #advanced-filter-modal {
                padding: 0 !important;
                align-items: flex-end !important;
                justify-content: center !important;
            }

            /* Modal içerik kartı - LIGHT MODE */
            .filter-modal-content {
                width: 100% !important;
                max-width: 100% !important;
                max-height: 90vh !important;
                overflow: auto !important;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                background: #ffffff !important;
                backdrop-filter: blur(30px) saturate(180%);
                -webkit-backdrop-filter: blur(30px) saturate(180%);
                border-radius: 28px 28px 0 0 !important;
                border: none !important;
                border-top: 1px solid rgba(0, 0, 0, 0.08) !important;
                box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.15) !important;
                padding: 0 !important;
            }

            /* Modal içerik kartı - DARK MODE */
            html.dark .filter-modal-content {
                background: #1a1625 !important;
                border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
                box-shadow: 0 -10px 60px rgba(0, 0, 0, 0.5) !important;
            }

            /* Modal iç padding wrapper */
            .filter-modal-content>* {
                padding-left: 20px;
                padding-right: 20px;
            }

            /* Sticky header */
            .filter-modal-header {
                position: sticky !important;
                top: 0 !important;
                z-index: 20 !important;
                padding: 20px 20px 16px 20px !important;
                margin: 0 !important;
                background: #ffffff !important;
                border-bottom: 1px solid rgba(0, 0, 0, 0.06) !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
            }

            html.dark .filter-modal-header {
                background: #1a1625 !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
            }

            .filter-modal-header h3 {
                font-size: 20px !important;
                font-weight: 800 !important;
                color: #111827 !important;
                margin: 0 !important;
            }

            html.dark .filter-modal-header h3 {
                color: #ffffff !important;
            }

            /* Close button */
            .filter-modal-header button {
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background: rgba(0, 0, 0, 0.06) !important;
                border: none !important;
                color: #6b7280 !important;
                font-size: 14px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
            }

            html.dark .filter-modal-header button {
                background: rgba(255, 255, 255, 0.1) !important;
                color: #9ca3af !important;
            }

            .filter-modal-header button:hover {
                background: rgba(0, 0, 0, 0.1) !important;
                transform: scale(1.05) !important;
            }

            html.dark .filter-modal-header button:hover {
                background: rgba(255, 255, 255, 0.15) !important;
            }

            /* Section container */
            .filter-section {
                margin: 0 0 20px 0 !important;
                padding: 0 20px 20px 20px !important;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important;
            }

            .filter-section:last-of-type {
                border-bottom: none !important;
                margin-bottom: 10px !important;
                padding-bottom: 10px !important;
            }

            html.dark .filter-section {
                border-bottom-color: rgba(255, 255, 255, 0.05) !important;
            }

            /* Section label */
            .filter-label {
                display: block !important;
                font-size: 11px !important;
                font-weight: 700 !important;
                text-transform: uppercase !important;
                letter-spacing: 1px !important;
                color: #6b7280 !important;
                margin-bottom: 14px !important;
            }

            html.dark .filter-label {
                color: #9ca3af !important;
            }

            /* Filter chip group */
            .filter-chip-group {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 10px !important;
            }

            /* Filter chips - LIGHT MODE */
            .filter-chip {
                padding: 12px 18px !important;
                font-size: 14px !important;
                font-weight: 600 !important;
                min-height: 46px !important;
                border-radius: 14px !important;
                background: #f3f4f6 !important;
                border: 1.5px solid rgba(0, 0, 0, 0.06) !important;
                color: #374151 !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 6px !important;
                flex: 1 !important;
                min-width: 0 !important;
            }

            /* Filter chips - DARK MODE */
            html.dark .filter-chip {
                background: rgba(255, 255, 255, 0.08) !important;
                border-color: rgba(255, 255, 255, 0.12) !important;
                color: #e5e7eb !important;
            }

            .filter-chip:hover {
                background: rgba(99, 102, 241, 0.12) !important;
                border-color: rgba(99, 102, 241, 0.3) !important;
                transform: scale(1.02) !important;
            }

            html.dark .filter-chip:hover {
                background: rgba(99, 102, 241, 0.2) !important;
                border-color: rgba(99, 102, 241, 0.4) !important;
            }

            /* Filter chips - ACTIVE state */
            .filter-chip.active {
                background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
                color: white !important;
                border-color: transparent !important;
                box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4) !important;
                font-weight: 700 !important;
            }

            html.dark .filter-chip.active {
                box-shadow: 0 4px 20px rgba(99, 102, 241, 0.5) !important;
            }

            /* İşlem tipi chip'leri - 3 sütun grid */
            .filter-section:first-of-type .filter-chip-group {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
            }

            /* Kategori chip'leri - 3 sütun grid */
            #filter-categories {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
            }

            #filter-categories .filter-chip {
                justify-content: center !important;
                text-align: center !important;
                font-size: 13px !important;
                padding: 10px 8px !important;
                min-height: 44px !important;
            }

            /* Range row container */
            .filter-range-row {
                display: flex !important;
                align-items: center !important;
                gap: 12px !important;
            }

            .filter-range-row>span {
                color: #9ca3af !important;
                font-weight: 600 !important;
                flex-shrink: 0 !important;
                font-size: 16px !important;
            }

            /* AG Input - LIGHT MODE */
            .ag-input {
                flex: 1 !important;
                min-width: 0 !important;
                padding: 14px 16px !important;
                font-size: 15px !important;
                font-weight: 500 !important;
                border-radius: 14px !important;
                background: #f3f4f6 !important;
                border: 1.5px solid rgba(0, 0, 0, 0.06) !important;
                color: #111827 !important;
                transition: all 0.2s ease !important;
                -webkit-appearance: none !important;
                appearance: none !important;
            }

            /* AG Input - DARK MODE */
            html.dark .ag-input {
                background: rgba(255, 255, 255, 0.08) !important;
                border-color: rgba(255, 255, 255, 0.12) !important;
                color: #f9fafb !important;
            }

            .ag-input:focus {
                outline: none !important;
                border-color: #6366f1 !important;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15) !important;
            }

            html.dark .ag-input:focus {
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25) !important;
            }

            /* Date input special styling */
            .ag-input[type="date"],
            .ag-input[type="number"] {
                text-align: center !important;
            }

            html.dark .ag-input[type="date"],
            html.dark .ag-input[type="number"] {
                color-scheme: dark !important;
            }

            html.dark .ag-input[type="date"]::-webkit-calendar-picker-indicator {
                filter: invert(1) !important;
                opacity: 0.7 !important;
            }

            /* Placeholder styling */
            .ag-input::placeholder {
                color: #9ca3af !important;
            }

            html.dark .ag-input::placeholder {
                color: #6b7280 !important;
            }

            /* Sticky footer */
            .filter-modal-footer {
                position: sticky !important;
                bottom: 0 !important;
                z-index: 20 !important;
                padding: 16px 20px calc(20px + env(safe-area-inset-bottom)) 20px !important;
                margin: 0 !important;
                background: #ffffff !important;
                border-top: 1px solid rgba(0, 0, 0, 0.06) !important;
                display: flex !important;
                gap: 12px !important;
            }

            html.dark .filter-modal-footer {
                background: #1a1625 !important;
                border-top: 1px solid rgba(255, 255, 255, 0.08) !important;
            }

            /* Footer buttons */
            .filter-modal-footer button {
                flex: 1 !important;
                padding: 16px 20px !important;
                font-size: 15px !important;
                font-weight: 700 !important;
                border-radius: 14px !important;
                border: none !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
            }

            /* Sıfırla button - LIGHT MODE */
            .filter-modal-footer button:first-child {
                background: #f3f4f6 !important;
                color: #4b5563 !important;
            }

            .filter-modal-footer button:first-child:hover {
                background: #e5e7eb !important;
            }

            /* Sıfırla button - DARK MODE */
            html.dark .filter-modal-footer button:first-child {
                background: rgba(255, 255, 255, 0.1) !important;
                color: #d1d5db !important;
            }

            html.dark .filter-modal-footer button:first-child:hover {
                background: rgba(255, 255, 255, 0.15) !important;
            }

            /* Uygula button */
            .filter-modal-footer button:last-child {
                background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
                color: white !important;
                box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4) !important;
            }

            .filter-modal-footer button:last-child:hover {
                transform: scale(1.02) !important;
                box-shadow: 0 6px 24px rgba(99, 102, 241, 0.5) !important;
            }

            /* Extra small screen adjustments */
            @media (max-width: 375px) {
                .filter-modal-header h3 {
                    font-size: 18px !important;
                }

                .filter-chip {
                    padding: 10px 14px !important;
                    font-size: 13px !important;
                    min-height: 42px !important;
                }

                #filter-categories {
                    grid-template-columns: repeat(2, 1fr) !important;
                }

                .ag-input {
                    padding: 12px 14px !important;
                    font-size: 14px !important;
                }
            }

            /* Slide up animation */
            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(40px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .animate-slide-up {
                animation: slideUp 0.35s cubic-bezier(0.32, 0.72, 0, 1) forwards;
            }

            /* ══════════════════════════════════════════════════════════════════
           KAPSAMLI TEMA GELİŞTİRMELERİ v3.0
           Renk Paleti, Animasyonlar, Alternatif Temalar, Mobil UX, 3D Efektler
        ══════════════════════════════════════════════════════════════════ */

            /* ─────────────────────────────────────────────────────────────────
           1. GENİŞLETİLMİŞ RENK PALETİ
        ───────────────────────────────────────────────────────────────── */
            :root {
                /* Extended Accent Colors */
                --theme-pink: #ec4899;
                --theme-pink-soft: rgba(236, 72, 153, 0.15);
                --theme-orange: #f97316;
                --theme-orange-soft: rgba(249, 115, 22, 0.15);
                --theme-teal: #14b8a6;
                --theme-teal-soft: rgba(20, 184, 166, 0.15);
                --theme-cyan: #06b6d4;
                --theme-cyan-soft: rgba(6, 182, 212, 0.15);
                --theme-rose: #f43f5e;
                --theme-rose-soft: rgba(244, 63, 94, 0.15);
                --theme-lime: #84cc16;
                --theme-lime-soft: rgba(132, 204, 22, 0.15);
                --theme-amber: #f59e0b;
                --theme-amber-soft: rgba(245, 158, 11, 0.15);
                --theme-violet: #8b5cf6;
                --theme-violet-soft: rgba(139, 92, 246, 0.15);

                /* Gradient Presets */
                --gradient-sunset: linear-gradient(135deg, #f97316 0%, #ec4899 50%, #8b5cf6 100%);
                --gradient-ocean: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
                --gradient-forest: linear-gradient(135deg, #22c55e 0%, #14b8a6 50%, #06b6d4 100%);
                --gradient-candy: linear-gradient(135deg, #f43f5e 0%, #ec4899 50%, #a855f7 100%);
                --gradient-aurora: linear-gradient(135deg, #6366f1 0%, #8b5cf6 25%, #a855f7 50%, #ec4899 75%, #f43f5e 100%);
                --gradient-gold: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
                --gradient-emerald: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
                --gradient-cosmic: linear-gradient(135deg, #312e81 0%, #4c1d95 50%, #581c87 100%);

                /* Glow Effects */
                --glow-pink: 0 0 30px rgba(236, 72, 153, 0.4);
                --glow-cyan: 0 0 30px rgba(6, 182, 212, 0.4);
                --glow-gold: 0 0 30px rgba(251, 191, 36, 0.4);
                --glow-purple: 0 0 30px rgba(168, 85, 247, 0.4);
            }

            html.dark {
                /* Dark Mode Enhanced Colors */
                --theme-pink: #f472b6;
                --theme-orange: #fb923c;
                --theme-teal: #2dd4bf;
                --theme-cyan: #22d3ee;
                --theme-rose: #fb7185;
                --theme-lime: #a3e635;
            }

            /* ─────────────────────────────────────────────────────────────────
           2. MİKRO ANİMASYONLAR
        ───────────────────────────────────────────────────────────────── */

            /* Page Transition */
            @keyframes pageSlideIn {
                from {
                    opacity: 0;
                    transform: translateX(30px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes pageSlideOut {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }

                to {
                    opacity: 0;
                    transform: translateX(-30px);
                }
            }

            .page-enter {
                animation: pageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            }

            .page-exit {
                animation: pageSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            }

            /* Enhanced Button Effects */
            @keyframes buttonPulse {

                0%,
                100% {
                    box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
                }

                50% {
                    box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
                }
            }

            @keyframes buttonShine {
                0% {
                    background-position: -200% center;
                }

                100% {
                    background-position: 200% center;
                }
            }

            .btn-pulse {
                animation: buttonPulse 2s infinite;
            }

            .btn-shine {
                background: linear-gradient(90deg,
                        transparent 0%,
                        rgba(255, 255, 255, 0.4) 50%,
                        transparent 100%);
                background-size: 200% 100%;
            }

            .btn-shine:hover {
                animation: buttonShine 1.5s infinite;
            }

            /* Scroll Reveal */
            @keyframes revealUp {
                from {
                    opacity: 0;
                    transform: translateY(40px) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            @keyframes revealLeft {
                from {
                    opacity: 0;
                    transform: translateX(-40px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes revealRight {
                from {
                    opacity: 0;
                    transform: translateX(40px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes revealScale {
                from {
                    opacity: 0;
                    transform: scale(0.8);
                }

                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .reveal-up {
                animation: revealUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            .reveal-left {
                animation: revealLeft 0.5s ease-out forwards;
            }

            .reveal-right {
                animation: revealRight 0.5s ease-out forwards;
            }

            .reveal-scale {
                animation: revealScale 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            /* Stagger Animation Delays */
            .stagger-1 {
                animation-delay: 0.05s;
            }

            .stagger-2 {
                animation-delay: 0.1s;
            }

            .stagger-3 {
                animation-delay: 0.15s;
            }

            .stagger-4 {
                animation-delay: 0.2s;
            }

            .stagger-5 {
                animation-delay: 0.25s;
            }

            .stagger-6 {
                animation-delay: 0.3s;
            }

            /* Shimmer Effect */
            @keyframes shimmer {
                0% {
                    background-position: -1000px 0;
                }

                100% {
                    background-position: 1000px 0;
                }
            }

            .shimmer-effect {
                background: linear-gradient(90deg,
                        transparent 0%,
                        rgba(255, 255, 255, 0.3) 50%,
                        transparent 100%);
                background-size: 1000px 100%;
                animation: shimmer 2s infinite linear;
            }

            /* Floating Animation */
            @keyframes gentleFloat {

                0%,
                100% {
                    transform: translateY(0) rotate(0deg);
                }

                25% {
                    transform: translateY(-8px) rotate(1deg);
                }

                75% {
                    transform: translateY(4px) rotate(-1deg);
                }
            }

            .float-gentle {
                animation: gentleFloat 6s ease-in-out infinite;
            }

            /* Heartbeat Effect */
            @keyframes heartbeat {

                0%,
                100% {
                    transform: scale(1);
                }

                14% {
                    transform: scale(1.1);
                }

                28% {
                    transform: scale(1);
                }

                42% {
                    transform: scale(1.1);
                }

                70% {
                    transform: scale(1);
                }
            }

            .heartbeat {
                animation: heartbeat 1.5s infinite;
            }

            /* Wiggle Effect */
            @keyframes wiggle {

                0%,
                100% {
                    transform: rotate(0deg);
                }

                25% {
                    transform: rotate(-5deg);
                }

                75% {
                    transform: rotate(5deg);
                }
            }

            .wiggle:hover {
                animation: wiggle 0.5s ease-in-out;
            }

            /* ─────────────────────────────────────────────────────────────────
           3. ALTERNATİF TEMA MODLARI
        ───────────────────────────────────────────────────────────────── */

            /* OLED Dark Mode (Pure Black) */
            html.oled-dark {
                --neo-bg: #000000;
                --neo-bg-elevated: #0a0a0a;
                --neo-surface: rgba(15, 15, 15, 0.95);
                --neo-surface-elevated: rgba(25, 25, 25, 0.95);
                --glass-bg: rgba(10, 10, 10, 0.95);
                --glass-bg-elevated: rgba(20, 20, 20, 0.95);
                --neo-stroke: rgba(255, 255, 255, 0.05);
                --neo-stroke-strong: rgba(255, 255, 255, 0.1);
            }

            html.oled-dark body {
                background: #000000 !important;
            }

            html.oled-dark .glass-card,
            html.oled-dark .widget-card-apple,
            html.oled-dark .soft-card {
                background: rgba(12, 12, 12, 0.98) !important;
                border-color: rgba(255, 255, 255, 0.06) !important;
            }

            /* Sepia/Eye Care Mode */
            html.sepia-mode {
                --neo-bg: #f5f0e6;
                --neo-bg-elevated: #faf7f0;
                --neo-surface: rgba(250, 245, 235, 0.9);
                --neo-text-primary: #3d3a33;
                --neo-text-secondary: #5c574d;
                --glass-bg: rgba(250, 245, 235, 0.85);
                --neo-accent: #8b6914;
                --neo-accent-indigo: #6b5b3d;
            }

            html.sepia-mode body {
                background: linear-gradient(135deg, #f5f0e6 0%, #ebe4d4 100%) !important;
                filter: sepia(15%);
            }

            html.sepia-mode img,
            html.sepia-mode svg {
                filter: sepia(0%);
            }

            /* High Contrast Mode */
            html.high-contrast {
                --neo-bg: #ffffff;
                --neo-bg-elevated: #ffffff;
                --neo-surface: #ffffff;
                --neo-text-primary: #000000;
                --neo-text-secondary: #1a1a1a;
                --neo-text-tertiary: #333333;
                --glass-bg: rgba(255, 255, 255, 0.98);
                --neo-stroke: rgba(0, 0, 0, 0.3);
                --neo-accent: #0000cc;
                --neo-success: #006600;
                --neo-danger: #cc0000;
            }

            html.high-contrast body {
                background: #ffffff !important;
            }

            html.high-contrast .glass-card,
            html.high-contrast .widget-card-apple {
                background: #ffffff !important;
                border: 2px solid #000000 !important;
                box-shadow: none !important;
            }

            html.high-contrast button,
            html.high-contrast a {
                text-decoration: underline;
                font-weight: bold !important;
            }

            html.high-contrast.dark {
                --neo-bg: #000000;
                --neo-text-primary: #ffffff;
                --neo-text-secondary: #e5e5e5;
                --glass-bg: rgba(0, 0, 0, 0.98);
            }

            html.high-contrast.dark body {
                background: #000000 !important;
            }

            html.high-contrast.dark .glass-card {
                background: #000000 !important;
                border: 2px solid #ffffff !important;
            }

            /* ─────────────────────────────────────────────────────────────────
           4. MOBİL UX İYİLEŞTİRMELERİ
        ───────────────────────────────────────────────────────────────── */

            /* Touch Ripple Effect */
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.4);
                transform: scale(0);
                animation: rippleAnim 0.6s linear;
                pointer-events: none;
            }

            @keyframes rippleAnim {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }

            html.dark .ripple {
                background: rgba(255, 255, 255, 0.2);
            }

            /* Enhanced Touch Feedback */
            .touch-feedback {
                position: relative;
                overflow: hidden;
                -webkit-tap-highlight-color: transparent;
            }

            .touch-feedback::after {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.08);
                opacity: 0;
                transition: opacity 0.15s ease;
                pointer-events: none;
                border-radius: inherit;
            }

            .touch-feedback:active::after {
                opacity: 1;
            }

            html.dark .touch-feedback::after {
                background: rgba(255, 255, 255, 0.1);
            }

            /* iOS Style Press Animation */
            .ios-press {
                transition: transform 0.1s ease, opacity 0.1s ease;
            }

            .ios-press:active {
                transform: scale(0.97);
                opacity: 0.85;
            }

            /* Android Material Elevation */
            .material-lift {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .material-lift:active {
                transform: translateY(2px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
            }

            /* Large Touch Targets */
            .touch-target-lg {
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Swipe Hint Animation */
            @keyframes swipeHint {

                0%,
                100% {
                    transform: translateX(0);
                    opacity: 0.5;
                }

                50% {
                    transform: translateX(10px);
                    opacity: 1;
                }
            }

            .swipe-hint::after {
                content: '→';
                animation: swipeHint 1.5s ease-in-out infinite;
                opacity: 0.5;
            }

            /* ─────────────────────────────────────────────────────────────────
           5. 3D EFEKTLER VE GÖRSEL ZENGİNLEŞTİRME
        ───────────────────────────────────────────────────────────────── */

            /* 3D Card Tilt Effect */
            .card-3d-tilt {
                transform-style: preserve-3d;
                perspective: 1000px;
                transition: transform 0.3s ease;
            }

            .card-3d-tilt:hover {
                transform: rotateY(5deg) rotateX(5deg) translateZ(10px);
            }

            /* Holographic Shimmer */
            @keyframes holoShimmer {
                0% {
                    background-position: 0% 50%;
                }

                50% {
                    background-position: 100% 50%;
                }

                100% {
                    background-position: 0% 50%;
                }
            }

            .holo-shimmer {
                background: linear-gradient(90deg,
                        rgba(255, 255, 255, 0) 0%,
                        rgba(255, 255, 255, 0.1) 20%,
                        rgba(99, 102, 241, 0.2) 40%,
                        rgba(168, 85, 247, 0.2) 60%,
                        rgba(236, 72, 153, 0.2) 80%,
                        rgba(255, 255, 255, 0) 100%);
                background-size: 200% 100%;
                animation: holoShimmer 3s ease infinite;
            }

            .holo-effect::before {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(135deg,
                        transparent 0%,
                        rgba(99, 102, 241, 0.1) 25%,
                        rgba(168, 85, 247, 0.1) 50%,
                        rgba(236, 72, 153, 0.1) 75%,
                        transparent 100%);
                background-size: 300% 300%;
                animation: holoShimmer 4s ease infinite;
                border-radius: inherit;
                pointer-events: none;
            }

            /* Aurora Background */
            @keyframes auroraWave {

                0%,
                100% {
                    background-position: 0% 50%;
                    filter: hue-rotate(0deg);
                }

                50% {
                    background-position: 100% 50%;
                    filter: hue-rotate(30deg);
                }
            }

            .aurora-bg {
                background: linear-gradient(-45deg,
                        rgba(99, 102, 241, 0.3),
                        rgba(168, 85, 247, 0.3),
                        rgba(6, 182, 212, 0.3),
                        rgba(99, 102, 241, 0.3));
                background-size: 400% 400%;
                animation: auroraWave 15s ease infinite;
            }

            html.dark .aurora-bg {
                background: linear-gradient(-45deg,
                        rgba(99, 102, 241, 0.2),
                        rgba(168, 85, 247, 0.2),
                        rgba(6, 182, 212, 0.2),
                        rgba(99, 102, 241, 0.2));
            }

            /* Neon Glow Effects */
            .neon-glow-indigo {
                box-shadow:
                    0 0 5px rgba(99, 102, 241, 0.5),
                    0 0 20px rgba(99, 102, 241, 0.3),
                    0 0 40px rgba(99, 102, 241, 0.2);
            }

            .neon-glow-pink {
                box-shadow:
                    0 0 5px rgba(236, 72, 153, 0.5),
                    0 0 20px rgba(236, 72, 153, 0.3),
                    0 0 40px rgba(236, 72, 153, 0.2);
            }

            .neon-glow-cyan {
                box-shadow:
                    0 0 5px rgba(6, 182, 212, 0.5),
                    0 0 20px rgba(6, 182, 212, 0.3),
                    0 0 40px rgba(6, 182, 212, 0.2);
            }

            .neon-text {
                text-shadow:
                    0 0 10px currentColor,
                    0 0 20px currentColor,
                    0 0 40px currentColor;
            }

            /* Glass Depth Layers */
            .glass-depth-1 {
                backdrop-filter: blur(8px);
                z-index: 1;
            }

            .glass-depth-2 {
                backdrop-filter: blur(16px);
                z-index: 2;
            }

            .glass-depth-3 {
                backdrop-filter: blur(24px);
                z-index: 3;
            }

            .glass-depth-4 {
                backdrop-filter: blur(32px);
                z-index: 4;
            }

            /* Frosted Card Premium */
            .frosted-premium {
                background: linear-gradient(135deg,
                        rgba(255, 255, 255, 0.1) 0%,
                        rgba(255, 255, 255, 0.05) 100%);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.12),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            html.dark .frosted-premium {
                background: linear-gradient(135deg,
                        rgba(255, 255, 255, 0.08) 0%,
                        rgba(255, 255, 255, 0.02) 100%);
                border-color: rgba(255, 255, 255, 0.1);
            }

            /* Liquid Morphing Border */
            @keyframes liquidBorder {

                0%,
                100% {
                    border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
                }

                50% {
                    border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
                }
            }

            .liquid-border {
                animation: liquidBorder 8s ease-in-out infinite;
            }

            /* ─────────────────────────────────────────────────────────────────
           6. VERİ GÖRSELLEŞTİRME STİLLERİ
        ───────────────────────────────────────────────────────────────── */

            /* Chart Color Palette */
            .chart-color-1 {
                color: #6366f1;
                background: #6366f1;
            }

            .chart-color-2 {
                color: #8b5cf6;
                background: #8b5cf6;
            }

            .chart-color-3 {
                color: #ec4899;
                background: #ec4899;
            }

            .chart-color-4 {
                color: #14b8a6;
                background: #14b8a6;
            }

            .chart-color-5 {
                color: #f59e0b;
                background: #f59e0b;
            }

            .chart-color-6 {
                color: #10b981;
                background: #10b981;
            }

            .chart-color-7 {
                color: #ef4444;
                background: #ef4444;
            }

            .chart-color-8 {
                color: #3b82f6;
                background: #3b82f6;
            }

            /* Enhanced Progress Bars */
            .progress-bar-premium {
                height: 8px;
                border-radius: 4px;
                background: rgba(0, 0, 0, 0.1);
                overflow: hidden;
                position: relative;
            }

            html.dark .progress-bar-premium {
                background: rgba(255, 255, 255, 0.1);
            }

            .progress-bar-premium .progress-fill {
                height: 100%;
                border-radius: inherit;
                background: var(--gradient-ocean);
                position: relative;
                transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .progress-bar-premium .progress-fill::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 255, 255, 0.3),
                        transparent);
                animation: shimmer 2s infinite;
            }

            /* Circular Progress */
            .circular-progress {
                --progress: 0;
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: conic-gradient(var(--neo-accent-indigo) calc(var(--progress) * 1%),
                        rgba(0, 0, 0, 0.1) 0);
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .circular-progress::before {
                content: '';
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: var(--neo-bg);
            }

            /* Animated Counter */
            @keyframes countUp {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .counter-animate {
                animation: countUp 0.5s ease-out forwards;
                font-variant-numeric: tabular-nums;
            }

            /* Badge Styles */
            .badge-gradient {
                background: var(--gradient-aurora);
                color: white;
                padding: 4px 12px;
                border-radius: 999px;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .badge-outline {
                border: 2px solid var(--neo-accent);
                color: var(--neo-accent);
                background: transparent;
                padding: 4px 12px;
                border-radius: 999px;
                font-size: 11px;
                font-weight: 700;
            }

            .badge-glow {
                position: relative;
            }

            .badge-glow::before {
                content: '';
                position: absolute;
                inset: -2px;
                border-radius: inherit;
                background: var(--gradient-aurora);
                z-index: -1;
                filter: blur(8px);
                opacity: 0.5;
            }

            /* Stat Cards */
            .stat-card {
                padding: 20px;
                border-radius: 20px;
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                border: 1px solid var(--glass-border);
                position: relative;
                overflow: hidden;
            }

            .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: var(--gradient-ocean);
            }

            .stat-card.success::before {
                background: var(--gradient-forest);
            }

            .stat-card.danger::before {
                background: var(--gradient-candy);
            }

            .stat-card.warning::before {
                background: var(--gradient-sunset);
            }

            /* Trend Indicators */
            .trend-up {
                color: var(--neo-success);
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }

            .trend-up::before {
                content: '↑';
                font-size: 0.9em;
            }

            .trend-down {
                color: var(--neo-danger);
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }

            .trend-down::before {
                content: '↓';
                font-size: 0.9em;
            }

            /* ─────────────────────────────────────────────────────────────────
           7. PERFORMANS MODU İÇİN AZALTILMIŞ EFEKTLER
        ───────────────────────────────────────────────────────────────── */

            html.perf .holo-shimmer,
            html.perf .holo-effect::before,
            html.perf .aurora-bg {
                animation: none !important;
            }

            html.perf .neon-glow-indigo,
            html.perf .neon-glow-pink,
            html.perf .neon-glow-cyan {
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
            }

            html.perf .card-3d-tilt:hover {
                transform: none !important;
            }

            html.perf .liquid-border {
                animation: none !important;
                border-radius: 50% !important;
            }

            html.perf .frosted-premium {
                backdrop-filter: blur(10px) !important;
                -webkit-backdrop-filter: blur(10px) !important;
            }

            @media (prefers-reduced-motion: reduce) {

                .page-enter,
                .page-exit,
                .reveal-up,
                .reveal-left,
                .reveal-right,
                .reveal-scale,
                .shimmer-effect,
                .float-gentle,
                .heartbeat,
                .wiggle,
                .btn-pulse,
                .btn-shine,
                .holo-shimmer,
                .aurora-bg,
                .liquid-border {
                    animation: none !important;
                }

                .card-3d-tilt:hover {
                    transform: none !important;
                }
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* LIGHT/DARK MODE FIX: Mor/İndigo Arka Planlı Butonlarda Yazı     */
            /* Subcategory chips, taksit butonları, kategori etiketleri        */
            /* ═══════════════════════════════════════════════════════════════ */

            /* Mor/indigo gradient butonlar - her zaman beyaz yazı */
            [class*="bg-indigo-5"],
            [class*="bg-indigo-6"],
            [class*="bg-purple-5"],
            [class*="bg-purple-6"],
            [class*="bg-violet-5"],
            [class*="bg-violet-6"] {
                color: white !important;
            }

            /* Light mode - Alt kategori chip'leri ve pill butonlar */
            html:not(.dark) .bg-indigo-500,
            html:not(.dark) .bg-indigo-600,
            html:not(.dark) .bg-purple-500,
            html:not(.dark) .bg-purple-600,
            html:not(.dark) .bg-violet-500,
            html:not(.dark) .bg-violet-600 {
                color: white !important;
                text-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
            }

            /* Taksit butonları ve CTA'lar - her modda beyaz yazı */
            button.bg-indigo-500,
            button.bg-indigo-600,
            button.bg-purple-500,
            button.bg-violet-500 {
                color: white !important;
            }

            /* Dark mode - Daha parlak kontrastlı beyaz yazı */
            html.dark .bg-indigo-500,
            html.dark .bg-indigo-600,
            html.dark .bg-purple-500,
            html.dark .bg-violet-500 {
                color: white !important;
            }

            /* 
         * FIX: UI Text Visibility for Chips/Buttons 
         * Ensure text is white and readable on colored backgrounds (darker shades).
         * Removed *-100 shades to allow dark text on pastel backgrounds in light mode.
         */
            .bg-indigo-500,
            .bg-indigo-600,
            .bg-purple-500,
            .bg-purple-600,
            .bg-violet-500,
            .bg-violet-600,
            .bg-blue-500,
            .bg-blue-600,
            .bg-emerald-500,
            .bg-emerald-600,
            .bg-green-500,
            .bg-green-600,
            .bg-red-500,
            .bg-red-600,
            .bg-orange-500,
            .bg-orange-600,
            .mini-badge,
            .mini-badge--pro,
            .mini-badge--note {
                color: #ffffff !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }

            /* Dark mode specific adjustments if needed */
            .dark .bg-indigo-100 {
                background-color: rgba(79, 70, 229, 0.2) !important;
                color: #a5b4fc !important;
            }

            .dark .bg-purple-100 {
                background-color: rgba(147, 51, 234, 0.2) !important;
                color: #d8b4fe !important;
            }

            /* Reset for strong backgrounds */
            .dark .bg-indigo-600 {
                color: white !important;
            }

            .dark .bg-purple-600 {
                color: white !important;
            }

            /* Header Glass Effect - Enhanced Visibility */
            .app-header-glass {
                background: rgba(255, 255, 255, 0.65);
                /* Frosted glass restored */
                backdrop-filter: blur(24px) saturate(180%);
                -webkit-backdrop-filter: blur(24px) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.4);
                /* Subtle border */
                box-shadow:
                    0 4px 24px -1px rgba(0, 0, 0, 0.05),
                    0 0 0 1px rgba(255, 255, 255, 0.2) inset;
                transition: all 0.3s ease;
            }

            html.dark .app-header-glass {
                background: rgba(30, 27, 56, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!-- ═══════════════════════════════════════════════════════════════════════════ -->
        <!--  APPLE DESIGN SYSTEM - Fingo Brain V2                                      -->
        <!-- ═══════════════════════════════════════════════════════════════════════════ -->
        <style>
            :root {
                /* ─── Apple Color System ─── */
                --fb-bg-primary: #f5f5f7;
                --fb-bg-secondary: #ffffff;
                --fb-text-primary: #1d1d1f;
                --fb-text-secondary: #86868b;

                /* Glassmorphism Light */
                --fb-glass-bg: rgba(255, 255, 255, 0.72);
                --fb-glass-border: rgba(255, 255, 255, 0.65);
                --fb-glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);

                /* Apple Accents */
                --apple-blue: #0071e3;
                --apple-green: #34c759;
                --apple-orange: #ff9500;
                --apple-red: #ff3b30;
                --apple-purple: #af52de;
                --apple-indigo: #5e5ce6;

                /* Gradients */
                --grad-blue: linear-gradient(135deg, #0071e3, #42a5f5);
                --grad-purple: linear-gradient(135deg, #5e5ce6, #bf5af2);
                --grad-orange: linear-gradient(135deg, #ff9500, #ffcc00);
                --grad-mesh: radial-gradient(at top left, rgba(0, 113, 227, 0.15) 0%, transparent 50%),
                    radial-gradient(at bottom right, rgba(94, 92, 230, 0.15) 0%, transparent 50%);
            }

            html.dark {
                --fb-bg-primary: #000000;
                --fb-bg-secondary: #1c1c1e;
                --fb-text-primary: #f5f5f7;
                --fb-text-secondary: #86868b;

                /* Glassmorphism Dark */
                --fb-glass-bg: rgba(28, 28, 30, 0.72);
                --fb-glass-border: rgba(255, 255, 255, 0.12);
                --fb-glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);

                /* Dark Mode Adjustments */
                --apple-blue: #0a84ff;
                --apple-indigo: #5e5ce6;
            }

            /* ─── Components ─── */
            .fb-container {
                background-color: var(--fb-bg-primary);
                color: var(--fb-text-primary);
                font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                -webkit-font-smoothing: antialiased;
            }

            .fb-glass-card {
                background: var(--fb-glass-bg);
                backdrop-filter: blur(24px) saturate(180%);
                -webkit-backdrop-filter: blur(24px) saturate(180%);
                border: 1px solid var(--fb-glass-border);
                border-radius: 20px;
                /* Reduced specific radius for better fit */
                box-shadow: var(--fb-glass-shadow);
                transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }

            .fb-glass-card:active {
                transform: scale(0.98);
            }

            /* Segmented Control (Tabs) */
            .fb-segmented-control {
                background: rgba(118, 118, 128, 0.12);
                border-radius: 12px;
                /* Standard Apple segmented control radius */
                padding: 3px;
                display: flex;
                position: relative;
            }

            .fb-segment-btn {
                flex: 1;
                padding: 8px 12px;
                font-size: 13px;
                font-weight: 600;
                color: var(--fb-text-primary);
                background: transparent;
                border-radius: 9px;
                /* Inner pill radius */
                transition: all 0.2s ease;
                text-align: center;
            }

            .fb-segment-btn.active {
                background: var(--fb-bg-secondary);
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 3px 1px rgba(0, 0, 0, 0.04);
                color: var(--fb-text-primary);
            }

            /* Animations */
            @keyframes fb-fade-in {
                from {
                    opacity: 0;
                    transform: translateY(8px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .animate-fb-entry {
                animation: fb-fade-in 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            }
        </style>
    </head>

    <body class="h-screen w-full relative overflow-hidden app-bg soft-surface">

        <!-- APPLE AWARD-WINNING SPLASH SCREEN -->
        <div id="splash-screen">
            <!-- Animated Background Orbs -->
            <div class="splash-orb splash-orb-1"></div>
            <div class="splash-orb splash-orb-2"></div>
            <div class="splash-orb splash-orb-3"></div>

            <!-- Logo Container -->
            <div class="splash-logo-container">
                <!-- Logo Icon -->
                <div class="splash-logo-icon">
                    <img src="Logo.jpg" alt="Fingenda"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-text" style="display: none;">F</span>
                    <div class="splash-shimmer"></div>
                </div>

                <!-- App Name -->
                <h1 class="splash-app-name">Fingenda</h1>

                <!-- Tagline -->
                <p class="splash-tagline">Finansal Asistan</p>
            </div>

            <!-- Loading Indicator -->
            <div class="splash-loader">
                <div class="splash-loader-dot"></div>
                <div class="splash-loader-dot"></div>
                <div class="splash-loader-dot"></div>
            </div>

            <!-- Version Tag -->
            <span class="splash-version">v2.0 Premium</span>
        </div>

        <!-- LEGACY ONBOARDING REMOVED -->


        <!-- MAIN APP CONTAINER -->
        <div id="app-container"
            class="h-full flex flex-col w-full relative z-10 opacity-0 transition-opacity duration-500">

            <!-- HEADER - Fixed Floating Glass (Navigation Bar Gibi - Tam Şeffaf) -->
            <header
                class="fixed z-[100] px-5 py-3 flex justify-between items-center rounded-[24px] hw-accelerated app-header-glass"
                style="top: calc(16px + env(safe-area-inset-top, 0px)); left: calc(16px + env(safe-area-inset-left, 0px)); width: calc(100% - 32px - env(safe-area-inset-left, 0px) - env(safe-area-inset-right, 0px));"
                id="main-header">
                <div>
                    <p id="header-date" class="text-xs font-bold uppercase tracking-wider"
                        style="color: var(--text-muted);">...</p>
                    <h1 id="user-greeting" class="text-2xl font-black tracking-tight cursor-pointer select-none"
                        style="color: var(--text-primary);" onclick="window.toggleProfileModal(true)">Günaydın,
                        Misafir 🚀
                    </h1>

                    <!-- Plan Durumu (Free/Pro) -->
                    <div class="flex items-center mt-2 space-x-2" id="plan-status-container">
                        <span id="user-plan-badge"
                            class="relative overflow-hidden text-[10px] font-black px-3 py-1.5 rounded-full uppercase tracking-wider cursor-pointer hover:scale-105 transition-all duration-300"
                            style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; box-shadow: 0 4px 15px var(--accent-glow), inset 0 1px 0 rgba(255,255,255,0.3);"
                            onclick="document.getElementById('premium-modal').classList.remove('hidden')">
                            <span class="relative z-10 flex items-center gap-1">
                                <span class="animate-pulse">✨</span>
                                FREE
                            </span>
                            <div class="absolute inset-0 shimmer opacity-50"></div>
                        </span>
                        <button onclick="window.togglePrivacyMode()" id="btn-privacy-toggle"
                            class="p-1.5 rounded-full transition hover:scale-110"
                            style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(200, 210, 230, 0.5); color: #334155;">
                            <svg id="icon-eye-open" class="w-3.5 h-3.5" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                </path>
                            </svg>
                            <svg id="icon-eye-closed" class="hidden w-3.5 h-3.5" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21">
                                </path>
                            </svg>
                        </button>
                        <button onclick="document.getElementById('premium-modal').classList.remove('hidden')"
                            id="btn-header-upgrade"
                            class="btn-glass text-[10px] px-3 py-1 rounded-full flex items-center gap-1 hover:scale-105 transition">
                            <span>👑</span><span>Yükselt</span>
                        </button>
                    </div>
                </div>
                <!-- Profil Avatarı - Glow Effect -->
                <div class="flex items-center space-x-3">
                    <div class="header-avatar-wrap">
                        <!-- Ambient glow (en altta) -->
                        <span class="avatar-ambient" aria-hidden="true"></span>
                        <!-- Liquid glass spill (orta katman) -->
                        <span class="avatar-spill" aria-hidden="true"></span>
                        <!-- Avatar button (en üstte) -->
                        <button onclick="window.toggleProfileModal(true)"
                            class="w-14 h-14 rounded-full flex items-center justify-center hover:scale-105 transition relative cursor-pointer z-[91] glow pulse-glow"
                            style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));">
                            <div id="profile-avatar-text"
                                class="w-full h-full flex items-center justify-center font-bold text-lg rounded-full pointer-events-none text-white">
                                <span>P</span>
                            </div>
                        </button>
                    </div>
                </div>
            </header>

            <!-- CONTENT (Ekran İçerikleri) - Header için üst padding -->
            <main class="flex-1 overflow-y-auto custom-scroll relative px-4 pb-40 pt-28 z-0">

                <!-- DASHBOARD (Özet Ekranı) -->
                <div id="screen-dashboard" class="space-y-6 screen-transition">

                    <!-- Tarih Navigasyonu - Glassmorphism Pill -->
                    <div class="relative h-16 mx-1 flex items-center justify-between px-4 overflow-hidden glass-card">
                        <button onclick="window.changePeriod(-1)"
                            class="z-10 w-10 h-10 rounded-full flex items-center justify-center transition hover:scale-110"
                            style="background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-secondary);">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M15 19l-7-7 7-7">
                                </path>
                            </svg>
                        </button>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <div class="pointer-events-auto flex flex-col items-center cursor-pointer"
                                onclick="window.toggleViewScope()">
                                <span id="current-period-label"
                                    class="text-base font-black tracking-tight leading-none mb-1"
                                    style="color: var(--text-primary);">...</span>
                                <span id="view-scope-badge"
                                    class="text-[9px] font-bold px-3 py-1 rounded-full tracking-wider"
                                    style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white;">AYLIK</span>
                            </div>
                        </div>
                        <button onclick="window.changePeriod(1)"
                            class="z-10 w-10 h-10 rounded-full flex items-center justify-center transition hover:scale-110"
                            style="background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-secondary);">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </button>
                    </div>

                    <!-- Bakiye ve Birikim Bölümü - 3D Glass Cards -->
                    <!-- Bakiye ve Birikim Bölümü - 3D Glass Cards -->
                    <div id="dash-area-top" class="grid grid-cols-2 gap-4">
                        <!-- Net Nakit Kartı - Apple Award Liquid Glass -->
                        <div class="glass-card card-3d relative overflow-hidden rounded-[28px] p-5 min-h-[160px] flex flex-col justify-between group pw-widget pw-widget--cash pw-glass pw-tilt soft-card tap-anim"
                            data-pw-tilt="1" data-pw-sheen="1">
                            <!-- Accent Glow -->
                            <div class="pw-accent"></div>
                            <!-- Glow Background -->
                            <div class="absolute -right-10 -top-10 w-32 h-32 rounded-full blur-[60px] opacity-60"
                                style="background: var(--accent-primary);"></div>

                            <div class="relative z-10 pw-layer pw-layer--content">
                                <div class="flex justify-between items-start">
                                    <div class="flex flex-col">
                                        <span
                                            class="text-[12px] leading-none font-black tracking-widest uppercase drop-shadow-sm mb-1 pw-title"
                                            style="color: var(--accent-primary);">Net Nakit</span>
                                        <span id="storage-indicator"
                                            class="text-[8px] font-bold px-2 py-0.5 rounded-full w-max"
                                            style="background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--accent-primary);">Yerel</span>
                                    </div>
                                    <div class="pw-layer pw-layer--icon">
                                        <div class="pw-icon3d pw-icon3d--cash" aria-hidden="true">
                                            <span class="pw-icon3d__glow"></span>
                                            <span class="pw-icon3d__shine"></span>
                                            <span class="material-symbols-rounded pw-icon3d__glyph">credit_card</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-5">
                                    <h3 id="display-balance"
                                        class="text-2xl sm:text-3xl font-black tracking-tight pw-value"
                                        style="color: var(--text-primary);">0 ₺</h3>
                                    <div class="flex items-center gap-2 mt-2 flex-wrap">
                                        <span class="text-[10px] font-bold flex items-center px-2 py-0.5 rounded-full"
                                            style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
                                            <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                            </svg>%5
                                        </span>
                                        <span class="text-[9px] font-medium" style="color: var(--text-muted);">geçen aya
                                            göre</span>
                                        <!-- Geçmiş Ay Devir -->
                                        <div id="carryover-badge"
                                            class="hidden flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-100 dark:bg-indigo-500/20">
                                            <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                            </svg>
                                            <span id="display-carryover"
                                                class="text-xs font-medium text-indigo-600 dark:text-indigo-400">+0
                                                ₺</span>
                                            <span class="text-[8px] text-indigo-500/70">devir</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Birikim Kartı - Apple Award Liquid Glass -->
                        <div onclick="window.openSavingsDetail()"
                            class="glass-card card-3d relative overflow-hidden rounded-[28px] p-5 min-h-[160px] flex flex-col justify-between group cursor-pointer pw-widget pw-widget--savings pw-glass pw-tilt soft-card tap-anim"
                            data-pw-tilt="1" data-pw-sheen="1">
                            <!-- Accent Glow -->
                            <div class="pw-accent"></div>
                            <!-- Glow Background -->
                            <div class="absolute -right-8 -top-8 w-28 h-28 rounded-full blur-[50px] opacity-60"
                                style="background: var(--accent-secondary);"></div>

                            <div class="relative z-10 pw-layer pw-layer--content">
                                <div class="flex justify-between items-start">
                                    <span
                                        class="text-[12px] leading-none font-black tracking-widest uppercase drop-shadow-sm pw-title"
                                        style="color: var(--accent-secondary);">Birikim</span>
                                    <div class="pw-layer pw-layer--icon">
                                        <div class="pw-icon3d pw-icon3d--savings" aria-hidden="true">
                                            <span class="pw-icon3d__glow"></span>
                                            <span class="pw-icon3d__shine"></span>
                                            <span
                                                class="material-symbols-rounded pw-icon3d__glyph">account_balance</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-5">
                                    <h3 id="display-savings-total"
                                        class="text-2xl sm:text-3xl font-black tracking-tight pw-value"
                                        style="color: var(--text-primary);">0 ₺</h3>
                                    <div class="flex items-center gap-1 mt-2">
                                        <span class="text-[9px] font-medium flex items-center"
                                            style="color: var(--text-muted);">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>Tüm Zamanlar
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orta Bölüm: Hedef/Taksit Barı -->
                    <div id="dash-area-middle" class="space-y-3">
                        <!-- Taksit Widget'ı -->
                        <div id="dashboard-installment-widget"
                            onclick="window.switchTab('wallet'); window.switchAutopilotTab('installments')"
                            class="hidden relative overflow-hidden rounded-[24px] p-1 pr-4 bg-gradient-to-r from-red-50/80 to-orange-50/80 dark:from-red-900/40 dark:to-orange-900/40 border border-red-100 dark:border-red-500/30 cursor-pointer hover:border-red-200 dark:hover:border-red-500/40 transition-all group backdrop-blur-xl soft-card tap-anim">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-12 h-12 rounded-[20px] bg-gradient-to-br from-red-400 to-orange-500 dark:from-red-500 dark:to-orange-600 flex items-center justify-center text-xl shadow-lg shadow-red-200 dark:shadow-red-500/40 text-white">
                                        📅
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-800 dark:text-white text-sm">Gelecek
                                            Ödemeler</h4>
                                        <p class="text-[10px] text-red-500 dark:text-red-300 font-medium">Bu ay
                                            yapılacak
                                            taksitler</p>
                                    </div>
                                </div>
                                <p id="dashboard-installment-total"
                                    class="text-lg font-black text-red-500 dark:text-red-400 drop-shadow-sm">
                                    <span class="amount">0,00</span><span class="currency">₺</span>
                                </p>
                            </div>
                        </div>

                        <!-- Hedef Kartı (Rich Progress Bar) -->
                        <div onclick="window.switchTab('goals')"
                            class="relative overflow-hidden rounded-[24px] bg-white/80 dark:bg-[#1a1625]/90 border-t border-white/50 dark:border-white/5 shadow-xl shadow-indigo-100 dark:shadow-none cursor-pointer group hover:scale-[1.01] transition-transform duration-300 backdrop-blur-xl soft-card tap-anim">

                            <div id="dash-goal-bg"
                                class="absolute top-0 bottom-0 left-0 bg-gradient-to-r from-indigo-200 to-purple-200 dark:from-indigo-900/40 dark:to-purple-900/40 transition-all duration-1000 ease-out overflow-hidden"
                                style="width: 0%">

                                <div
                                    class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-transparent via-white/50 dark:via-white/20 to-transparent animate-shimmer skew-x-[-20deg]">
                                </div>
                            </div>

                            <div class="absolute bottom-0 left-0 w-full h-[3px] bg-gray-100 dark:bg-gray-800">
                                <div id="dash-goal-line"
                                    class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 shadow-[0_0_15px_rgba(99,102,241,0.6)] transition-all duration-1000 ease-out"
                                    style="width: 0%">
                                </div>
                            </div>

                            <div class="relative z-10 p-4 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-500/40 group-hover:scale-110 transition-transform">
                                        🎯</div>
                                    <div>
                                        <h4
                                            class="font-bold text-gray-800 dark:text-white text-sm group-hover:text-indigo-600 dark:group-hover:text-indigo-300 transition-colors">
                                            Hedef Kumbarası
                                        </h4>
                                        <div class="flex items-center gap-2">
                                            <span id="dash-goal-caption"
                                                class="text-[10px] text-gray-500 dark:text-gray-400 font-medium">Veriler
                                                yükleniyor...</span>
                                        </div>
                                    </div>
                                </div>
                                <span id="dash-goal-percent"
                                    class="text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">%0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gelir / Gider Kartları - Premium 3D Widgets -->
                    <div id="dash-area-bottom"
                        class="grid grid-cols-2 gap-5 mb-12 widget-3d-container px-2 relative z-20">

                        <!-- Gelir Kartı -->
                        <div class="widget-card-apple p-5 flex flex-col justify-between group cursor-pointer relative min-h-[150px] soft-card tap-anim"
                            onclick="window.openDetailedStats('income')">
                            <div class="widget-blob bg-emerald-500"></div>

                            <div class="flex justify-between items-start z-10 gap-3">
                                <div class="min-w-0 flex-1">
                                    <p
                                        class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">
                                        GELİR</p>
                                </div>
                                <div
                                    class="widget-icon-3d icon-income transform group-hover:scale-110 transition-transform duration-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-5">
                                <div id="display-income"
                                    class="money-inline money-inline--lg text-gray-800 dark:text-white">
                                    <span class="money-amount" data-money-amount>0</span>
                                    <span class="money-currency">₺</span>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center gap-2 z-10">
                                <span id="income-change-badge"
                                    class="bg-emerald-100 dark:bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                            d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                    </svg>
                                    <span id="income-change-percent">%0</span>
                                </span>
                                <span class="text-[10px] text-gray-400 font-medium">Bu ay</span>
                            </div>
                        </div>

                        <!-- Gider Kartı -->
                        <div class="widget-card-apple p-5 flex flex-col justify-between group cursor-pointer relative min-h-[150px] soft-card tap-anim"
                            onclick="window.openDetailedStats('expense')">
                            <div class="widget-blob bg-red-500"></div>

                            <div class="flex justify-between items-start z-10 gap-3">
                                <div class="min-w-0 flex-1">
                                    <p
                                        class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">
                                        GİDER</p>
                                </div>
                                <div
                                    class="widget-icon-3d icon-expense transform group-hover:scale-110 transition-transform duration-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-5">
                                <div id="display-expense"
                                    class="money-inline money-inline--lg text-gray-800 dark:text-white">
                                    <span class="money-amount" data-money-amount>0</span>
                                    <span class="money-currency">₺</span>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center gap-2 z-10">
                                <span id="expense-change-badge"
                                    class="bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400 text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                            d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                    </svg>
                                    <span id="expense-change-percent">%0</span>
                                </span>
                                <span class="text-[10px] text-gray-400 font-medium">Limiti koru</span>
                            </div>
                        </div>
                    </div>

                    <!-- Taksit Takip Widget - Premium Apple Style -->
                    <div id="installment-dashboard-widget" class="hidden mb-6 px-2">
                        <div class="widget-card-apple p-5 flex flex-col justify-between group cursor-pointer relative min-h-[120px] soft-card tap-anim"
                            onclick="window.switchTab('wallet'); window.switchAutopilotTab('installments');">
                            <div class="widget-blob bg-indigo-500"></div>

                            <div class="flex justify-between items-start z-10 gap-3">
                                <div class="min-w-0 flex-1">
                                    <p
                                        class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">
                                        TAKSİT TAKİP</p>
                                    <p id="installment-widget-count"
                                        class="text-2xl font-black text-gray-800 dark:text-white">
                                        0 Aktif Taksit
                                    </p>
                                </div>
                                <div
                                    class="widget-icon-3d icon-installment transform group-hover:scale-110 transition-transform duration-300 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl w-12 h-12 flex items-center justify-center shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                    </svg>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center justify-between z-10">
                                <div class="flex items-center gap-2">
                                    <span
                                        class="bg-indigo-100 dark:bg-indigo-500/20 text-indigo-600 dark:text-indigo-400 text-[10px] font-bold px-2 py-0.5 rounded-full">
                                        Bu Ay
                                    </span>
                                    <span id="installment-widget-monthly"
                                        class="text-sm font-bold text-gray-600 dark:text-gray-300">0 ₺</span>
                                </div>
                                <div
                                    class="flex items-center gap-1 text-indigo-500 dark:text-indigo-400 text-xs font-semibold">
                                    <span>Detaylar</span>
                                    <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DASHBOARD INSIGHT WIDGET (Premium Carousel v2.0) -->

                    <section id="dashboard-insight-widget" class="insight-section">
                        <!-- Başlık ve Dot Göstergeleri -->
                        <div class="insight-header">
                            <div class="insight-title-wrap">
                                <span class="insight-kicker">💡 BUGÜNÜN İÇGÖRÜSÜ</span>
                                <span class="insight-live">
                                    <i class="insight-dot-live"></i>
                                    <i class="insight-ring"></i>
                                </span>
                            </div>
                            <div class="insight-dots" id="insight-dots">
                                <span class="insight-dot active" data-index="0"></span>
                                <span class="insight-dot" data-index="1"></span>
                                <span class="insight-dot" data-index="2"></span>
                                <span class="insight-dot" data-index="3"></span>
                            </div>
                        </div>

                        <!-- Kaydırılabilir Kart Carouseli -->
                        <div class="insight-carousel" id="insight-carousel">

                            <!-- Kart 1: Tasarruf Analizi -->
                            <div class="insight-card" onclick="window.handleInsightClick(0, 'savings')">
                                <div class="insight-icon icon-success">
                                    <span class="icon-emoji">💰</span>
                                    <span class="icon-glow"></span>
                                </div>
                                <div class="insight-card-body">
                                    <h4 class="insight-card-title">Aylık Tasarruf Oranınız</h4>
                                    <div id="insight-value-0" class="insight-value value-success">%23</div>
                                    <p id="insight-desc-0" class="insight-desc">Bu ay gelirlerinizin %23'ünü
                                        biriktirdiniz.
                                        Harika bir performans!</p>
                                </div>
                                <div class="insight-arrow">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2.5">
                                        <path d="M9 18l6-6-6-6" />
                                    </svg>
                                </div>
                                <div class="insight-shimmer"></div>
                            </div>

                            <!-- Kart 2: Harcama Uyarısı -->
                            <div class="insight-card" onclick="window.handleInsightClick(1, 'spending')">
                                <div class="insight-icon icon-warning">
                                    <span class="icon-emoji">📊</span>
                                    <span class="icon-glow"></span>
                                </div>
                                <div class="insight-card-body">
                                    <h4 class="insight-card-title">En Yüksek Harcama</h4>
                                    <div id="insight-value-1" class="insight-value value-warning">Yemek</div>
                                    <p id="insight-desc-1" class="insight-desc">Geçen aya göre yemek harcamalarınız %15
                                        arttı. Limitleri gözden geçirin.</p>
                                </div>
                                <div class="insight-arrow">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2.5">
                                        <path d="M9 18l6-6-6-6" />
                                    </svg>
                                </div>
                                <div class="insight-shimmer"></div>
                            </div>

                            <!-- Kart 3: Ay Sonu Tahmini -->
                            <div class="insight-card" onclick="window.handleInsightClick(2, 'forecast')">
                                <div class="insight-icon icon-info">
                                    <span class="icon-emoji">📈</span>
                                    <span class="icon-glow"></span>
                                </div>
                                <div class="insight-card-body">
                                    <h4 class="insight-card-title">Ay Sonu Tahmini</h4>
                                    <div id="insight-value-2" class="insight-value">₺4.250</div>
                                    <p id="insight-desc-2" class="insight-desc">Şu anki harcama hızınızla ay sonunda bu
                                        kadar bakiyeniz kalacak.</p>
                                </div>
                                <div class="insight-arrow">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2.5">
                                        <path d="M9 18l6-6-6-6" />
                                    </svg>
                                </div>
                                <div class="insight-shimmer"></div>
                            </div>

                            <!-- Kart 4: Birikim Hedefi -->
                            <div class="insight-card" onclick="window.handleInsightClick(3, 'goal')">
                                <div class="insight-icon icon-success">
                                    <span class="icon-emoji">🎯</span>
                                    <span class="icon-glow"></span>
                                </div>
                                <div class="insight-card-body">
                                    <h4 class="insight-card-title">Birikim Hedefine Kalan</h4>
                                    <div id="insight-value-3" class="insight-value value-success">₺2.750</div>
                                    <p id="insight-desc-3" class="insight-desc">Tatil hedefine ulaşmak için ₺2.750 daha
                                        biriktirmen gerekiyor.</p>
                                </div>
                                <div class="insight-arrow">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2.5">
                                        <path d="M9 18l6-6-6-6" />
                                    </svg>
                                </div>
                                <div class="insight-shimmer"></div>
                            </div>

                        </div>
                    </section>

                    <style>
                        /* ═══════════════════════════════════════════════════════════════════════════
                       INSIGHT CAROUSEL - PREMIUM GLASSMORPHISM v2.0
                       Horizontal Scroll + Scroll Snap + Interactive Cards
                       ═══════════════════════════════════════════════════════════════════════════ */

                        /* Section Container */
                        .insight-section {
                            margin: 16px 0 20px;
                            position: relative;
                            z-index: 10;
                        }

                        /* Header Row */
                        .insight-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 0 20px;
                            margin-bottom: 14px;
                        }

                        .insight-title-wrap {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }

                        .insight-kicker {
                            font-size: 11px;
                            letter-spacing: 0.18em;
                            font-weight: 800;
                            color: var(--neo-text-secondary, #475569);
                            text-transform: uppercase;
                        }

                        html.dark .insight-kicker {
                            color: var(--neo-text-secondary, #94A3B8);
                        }

                        /* Live Indicator */
                        .insight-live {
                            position: relative;
                            width: 14px;
                            height: 14px;
                            flex-shrink: 0;
                        }

                        .insight-dot-live {
                            position: absolute;
                            inset: 0;
                            margin: auto;
                            width: 8px;
                            height: 8px;
                            border-radius: 50%;
                            background: #10b981;
                            box-shadow: 0 0 12px rgba(16, 185, 129, 0.5);
                        }

                        .insight-ring {
                            position: absolute;
                            inset: 0;
                            margin: auto;
                            width: 14px;
                            height: 14px;
                            border-radius: 50%;
                            border: 1.5px solid rgba(16, 185, 129, 0.5);
                            animation: insightPing 2s ease-out infinite;
                        }

                        @keyframes insightPing {
                            0% {
                                transform: scale(0.6);
                                opacity: 0.9;
                            }

                            100% {
                                transform: scale(1.6);
                                opacity: 0;
                            }
                        }

                        /* Dot Navigation */
                        .insight-dots {
                            display: flex;
                            gap: 8px;
                            align-items: center;
                        }

                        .insight-dots .insight-dot {
                            width: 8px;
                            height: 8px;
                            border-radius: 50%;
                            background: rgba(99, 102, 241, 0.2);
                            cursor: pointer;
                            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
                        }

                        .insight-dots .insight-dot.active {
                            width: 26px;
                            border-radius: 4px;
                            background: linear-gradient(135deg, #6366F1, #8B5CF6);
                            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.4);
                        }

                        html.dark .insight-dots .insight-dot {
                            background: rgba(99, 102, 241, 0.25);
                        }

                        /* ═══════════════════════════════════════════════════════════════════════════
                       CAROUSEL CONTAINER - Horizontal Scroll with Snap
                       ═══════════════════════════════════════════════════════════════════════════ */
                        .insight-carousel {
                            display: flex;
                            gap: 14px;
                            overflow-x: auto;
                            overflow-y: hidden;
                            scroll-snap-type: x mandatory;
                            scroll-behavior: smooth;
                            padding: 8px 20px 16px 20px;
                            -webkit-overflow-scrolling: touch;

                            /* Hide Scrollbar */
                            scrollbar-width: none;
                            -ms-overflow-style: none;
                        }

                        .insight-carousel::-webkit-scrollbar {
                            display: none;
                        }

                        /* ═══════════════════════════════════════════════════════════════════════════
                       INSIGHT CARD - Glassmorphism Design
                       ═══════════════════════════════════════════════════════════════════════════ */
                        .insight-card {
                            flex: 0 0 85%;
                            min-width: 280px;
                            max-width: 360px;
                            padding: 20px;
                            border-radius: 24px;
                            scroll-snap-align: center;
                            cursor: pointer;
                            position: relative;
                            z-index: 1;
                            display: flex;
                            align-items: flex-start;
                            gap: 14px;

                            /* Glassmorphism - Light Mode */
                            background: rgba(255, 255, 255, 0.72);
                            backdrop-filter: blur(20px) saturate(150%);
                            -webkit-backdrop-filter: blur(20px) saturate(150%);
                            border: 1px solid rgba(255, 255, 255, 0.65);
                            box-shadow:
                                0 8px 32px rgba(99, 102, 241, 0.08),
                                0 4px 16px rgba(0, 0, 0, 0.04),
                                inset 0 1px 0 rgba(255, 255, 255, 0.85);

                            /* Smooth Transitions */
                            transition: transform 0.22s cubic-bezier(0.34, 1.56, 0.64, 1),
                                box-shadow 0.22s ease;
                            user-select: none;
                            -webkit-user-select: none;
                            touch-action: manipulation;
                        }

                        /* Card Hover (Desktop) */
                        @media (hover: hover) {
                            .insight-card:hover {
                                transform: translateY(-4px) scale(1.015);
                                box-shadow:
                                    0 16px 48px rgba(99, 102, 241, 0.14),
                                    0 8px 24px rgba(0, 0, 0, 0.06),
                                    inset 0 1px 0 rgba(255, 255, 255, 0.9);
                            }

                            .insight-card:hover .insight-shimmer {
                                animation: insightShimmer 0.8s ease forwards;
                            }

                            .insight-card:hover .insight-arrow {
                                transform: translateX(4px);
                                background: rgba(99, 102, 241, 0.18);
                            }
                        }

                        /* Card Active/Pressed - TIKLAMA EFEKTİ */
                        .insight-card:active {
                            transform: scale(0.965) !important;
                            box-shadow:
                                0 4px 16px rgba(99, 102, 241, 0.1),
                                0 2px 8px rgba(0, 0, 0, 0.04);
                            transition: transform 0.1s ease;
                        }

                        /* Dark Mode Card */
                        html.dark .insight-card {
                            background: rgba(30, 27, 56, 0.78);
                            border: 1px solid rgba(255, 255, 255, 0.08);
                            box-shadow:
                                0 8px 32px rgba(0, 0, 0, 0.35),
                                0 4px 16px rgba(99, 102, 241, 0.08),
                                inset 0 1px 0 rgba(255, 255, 255, 0.06);
                        }

                        html.dark .insight-card:hover {
                            box-shadow:
                                0 16px 48px rgba(0, 0, 0, 0.45),
                                0 8px 24px rgba(99, 102, 241, 0.12),
                                inset 0 1px 0 rgba(255, 255, 255, 0.08);
                        }

                        /* ═══════════════════════════════════════════════════════════════════════════
                       ICON CIRCLE - Modern Gradient
                       ═══════════════════════════════════════════════════════════════════════════ */
                        .insight-icon {
                            flex-shrink: 0;
                            width: 52px;
                            height: 52px;
                            border-radius: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: relative;

                            /* Default Gradient */
                            background: linear-gradient(135deg,
                                    rgba(99, 102, 241, 0.12) 0%,
                                    rgba(139, 92, 246, 0.08) 100%);
                            border: 1px solid rgba(99, 102, 241, 0.18);
                        }

                        .insight-icon .icon-emoji {
                            font-size: 24px;
                            position: relative;
                            z-index: 1;
                        }

                        .insight-icon .icon-glow {
                            position: absolute;
                            inset: -8px;
                            background: radial-gradient(circle, rgba(99, 102, 241, 0.15), transparent 65%);
                            filter: blur(8px);
                            opacity: 0.6;
                            transition: opacity 0.3s ease;
                        }

                        .insight-card:hover .icon-glow {
                            opacity: 1;
                        }

                        /* Icon Variants */
                        .insight-icon.icon-success {
                            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
                            border-color: rgba(16, 185, 129, 0.18);
                        }

                        .insight-icon.icon-success .icon-glow {
                            background: radial-gradient(circle, rgba(16, 185, 129, 0.2), transparent 65%);
                        }

                        .insight-icon.icon-warning {
                            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(217, 119, 6, 0.08));
                            border-color: rgba(245, 158, 11, 0.18);
                        }

                        .insight-icon.icon-warning .icon-glow {
                            background: radial-gradient(circle, rgba(245, 158, 11, 0.2), transparent 65%);
                        }

                        .insight-icon.icon-info {
                            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(37, 99, 235, 0.08));
                            border-color: rgba(59, 130, 246, 0.18);
                        }

                        .insight-icon.icon-info .icon-glow {
                            background: radial-gradient(circle, rgba(59, 130, 246, 0.2), transparent 65%);
                        }

                        /* ═══════════════════════════════════════════════════════════════════════════
                       CARD BODY - Typography Hierarchy
                       ═══════════════════════════════════════════════════════════════════════════ */
                        .insight-card-body {
                            flex: 1;
                            min-width: 0;
                            padding-right: 28px;
                        }

                        .insight-card-title {
                            font-size: 13px;
                            font-weight: 650;
                            color: var(--neo-text-secondary, #475569);
                            margin: 0 0 6px;
                            line-height: 1.3;
                        }

                        html.dark .insight-card-title {
                            color: var(--neo-text-secondary, #94A3B8);
                        }

                        .insight-value {
                            font-size: 26px;
                            font-weight: 800;
                            color: var(--neo-accent-indigo, #6366F1);
                            margin-bottom: 6px;
                            letter-spacing: -0.02em;
                            line-height: 1.1;
                        }

                        .insight-value.value-success {
                            color: #10B981;
                        }

                        .insight-value.value-warning {
                            color: #F59E0B;
                        }

                        .insight-value.value-danger {
                            color: #EF4444;
                        }

                        .insight-desc {
                            font-size: 12px;
                            font-weight: 450;
                            color: var(--neo-text-tertiary, #94A3B8);
                            line-height: 1.45;
                            margin: 0;
                            display: -webkit-box;
                            -webkit-line-clamp: 2;
                            line-clamp: 2;
                            -webkit-box-orient: vertical;
                            overflow: hidden;
                        }

                        html.dark .insight-desc {
                            color: var(--neo-text-tertiary, #64748B);
                        }

                        /* ═══════════════════════════════════════════════════════════════════════════
                       ARROW & SHIMMER EFFECTS
                       ═══════════════════════════════════════════════════════════════════════════ */
                        .insight-arrow {
                            position: absolute;
                            right: 16px;
                            top: 50%;
                            transform: translateY(-50%);
                            width: 28px;
                            height: 28px;
                            border-radius: 50%;
                            background: rgba(99, 102, 241, 0.08);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--neo-accent-indigo, #6366F1);
                            transition: transform 0.2s ease, background 0.2s ease;
                        }

                        html.dark .insight-arrow {
                            background: rgba(99, 102, 241, 0.12);
                        }

                        .insight-shimmer {
                            position: absolute;
                            top: 0;
                            left: -100%;
                            width: 50%;
                            height: 100%;
                            background: linear-gradient(90deg,
                                    transparent,
                                    rgba(255, 255, 255, 0.35),
                                    transparent);
                            pointer-events: none;
                            border-radius: 24px;
                            opacity: 0;
                        }

                        @keyframes insightShimmer {
                            0% {
                                left: -100%;
                                opacity: 1;
                            }

                            100% {
                                left: 150%;
                                opacity: 0;
                            }
                        }

                        /* ═══════════════════════════════════════════════════════════════════════════
                       PERFORMANCE MODE & RESPONSIVE
                       ═══════════════════════════════════════════════════════════════════════════ */
                        html.perf .insight-card,
                        html.perf2 .insight-card {
                            backdrop-filter: none;
                            -webkit-backdrop-filter: none;
                        }

                        html.perf .insight-card {
                            background: rgba(255, 255, 255, 0.94);
                        }

                        html.perf.dark .insight-card,
                        html.perf2.dark .insight-card {
                            background: rgba(30, 27, 56, 0.96);
                        }

                        html.perf .insight-ring,
                        html.perf2 .insight-ring {
                            animation: none !important;
                        }

                        @media (prefers-reduced-motion: reduce) {
                            .insight-ring {
                                animation: none !important;
                            }

                            .insight-card {
                                transition: none !important;
                            }
                        }

                        @media (max-width: 380px) {
                            .insight-card {
                                flex: 0 0 88%;
                                padding: 16px;
                                gap: 12px;
                            }

                            .insight-icon {
                                width: 46px;
                                height: 46px;
                                border-radius: 14px;
                            }

                            .insight-icon .icon-emoji {
                                font-size: 22px;
                            }

                            .insight-value {
                                font-size: 22px;
                            }

                            .insight-kicker {
                                font-size: 10px;
                                letter-spacing: 0.14em;
                            }
                        }
                    </style>

                    <script>
                            // Insight Carousel - Dot Navigation & Click Handling
                            (function () {
                                const carousel = document.getElementById('insight-carousel');
                                const dots = document.querySelectorAll('#insight-dots .insight-dot');

                                if (!carousel || !dots.length) return;

                                // Scroll Event - Update Dots
                                carousel.addEventListener('scroll', function () {
                                    const scrollLeft = carousel.scrollLeft;
                                    const card = carousel.querySelector('.insight-card');
                                    if (!card) return;

                                    const cardWidth = card.offsetWidth;
                                    const gap = 14;
                                    const currentIndex = Math.round(scrollLeft / (cardWidth + gap));

                                    dots.forEach((dot, index) => {
                                        dot.classList.toggle('active', index === currentIndex);
                                    });
                                }, { passive: true });

                                // Dot Click - Scroll to Card
                                dots.forEach((dot, index) => {
                                    dot.addEventListener('click', function () {
                                        const cards = carousel.querySelectorAll('.insight-card');
                                        if (cards[index]) {
                                            cards[index].scrollIntoView({
                                                behavior: 'smooth',
                                                inline: 'center',
                                                block: 'nearest'
                                            });
                                        }
                                    });
                                });
                            })();

                        // ═══════════════════════════════════════════════════════════════════════════
                        // INSIGHT CARDS DATA ENGINE - Real Transaction Analysis
                        // ═══════════════════════════════════════════════════════════════════════════
                        window.updateInsightCards = function () {
                            try {
                                const APP_YEAR = new Date().getFullYear();
                                const APP_MONTH = new Date().getMonth() + 1;

                                // Use window.transactions if available, otherwise fallback to localStorage
                                let allTx = [];
                                if (Array.isArray(window.transactions) && window.transactions.length > 0) {
                                    allTx = window.transactions;
                                } else {
                                    const txKey = `my_expenses_${APP_YEAR}`;
                                    allTx = JSON.parse(localStorage.getItem(txKey) || '[]');
                                }

                                // Filter current month transactions
                                const monthTx = allTx.filter(t => {
                                    if (!t.date) return false;
                                    const d = new Date(t.date);
                                    return d.getMonth() + 1 === APP_MONTH && d.getFullYear() === APP_YEAR;
                                });

                                // Get last month transactions for comparison
                                const lastMonth = APP_MONTH === 1 ? 12 : APP_MONTH - 1;
                                const lastMonthYear = APP_MONTH === 1 ? APP_YEAR - 1 : APP_YEAR;
                                const lastMonthTx = allTx.filter(t => {
                                    if (!t.date) return false;
                                    const d = new Date(t.date);
                                    return d.getMonth() + 1 === lastMonth && d.getFullYear() === lastMonthYear;
                                });

                                // Calculate metrics
                                let income = 0, expense = 0, savings = 0;
                                const categorySpending = {};

                                monthTx.forEach(t => {
                                    const amt = parseFloat(t.amount) || 0;
                                    const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : (t.isSavings === true);

                                    if (t.type === 'income') {
                                        income += amt;
                                    } else if (t.type === 'expense') {
                                        if (isSavings) {
                                            savings += amt;
                                        } else {
                                            expense += amt;
                                            // Track category spending
                                            const cat = t.category || 'Diğer';
                                            categorySpending[cat] = (categorySpending[cat] || 0) + amt;
                                        }
                                    }
                                });

                                // Last month metrics for comparison
                                let lastMonthExpense = 0;
                                const lastMonthCategorySpending = {};
                                lastMonthTx.forEach(t => {
                                    const amt = parseFloat(t.amount) || 0;
                                    const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : (t.isSavings === true);
                                    if (t.type === 'expense' && !isSavings) {
                                        lastMonthExpense += amt;
                                        const cat = t.category || 'Diğer';
                                        lastMonthCategorySpending[cat] = (lastMonthCategorySpending[cat] || 0) + amt;
                                    }
                                });

                                // ───────────────────────────────────────────────────────────────────
                                // CARD 1: Tasarruf Oranı
                                // ───────────────────────────────────────────────────────────────────
                                const val0 = document.getElementById('insight-value-0');
                                const desc0 = document.getElementById('insight-desc-0');
                                const icon0 = document.querySelector('.insight-card:nth-child(1) .insight-icon');

                                if (income > 0) {
                                    const savingsRate = Math.round((savings / income) * 100);
                                    if (val0) val0.textContent = '%' + savingsRate;
                                    if (desc0) {
                                        if (savingsRate >= 20) {
                                            desc0.textContent = 'Mükemmel! Gelirinin %' + savingsRate + '\'ini biriktirdin. Böyle devam et!';
                                        } else if (savingsRate >= 10) {
                                            desc0.textContent = 'İyi gidiyorsun! Gelirinin %' + savingsRate + '\'ini biriktirdin.';
                                        } else if (savingsRate > 0) {
                                            desc0.textContent = 'Az da olsa birikim yapıyorsun. Hedefini %20\'ye çıkarmayı dene!';
                                        } else {
                                            desc0.textContent = 'Bu ay henüz birikim yapmadın. Küçük bir miktar bile fark yaratır!';
                                        }
                                    }
                                    // Update icon class based on rate
                                    if (icon0) {
                                        icon0.classList.remove('icon-warning', 'icon-info');
                                        icon0.classList.add(savingsRate >= 10 ? 'icon-success' : 'icon-warning');
                                    }
                                } else if (monthTx.length === 0) {
                                    if (val0) val0.textContent = '—';
                                    if (desc0) desc0.textContent = 'Henüz işlem girmediniz. İşlem ekleyerek analiz görün.';
                                } else {
                                    if (val0) val0.textContent = '%0';
                                    if (desc0) desc0.textContent = 'Bu ay gelir kaydı yok. Gelir ekleyerek tasarruf oranını takip et.';
                                }

                                // ───────────────────────────────────────────────────────────────────
                                // CARD 2: En Yüksek Harcama Kategorisi
                                // ───────────────────────────────────────────────────────────────────
                                const val1 = document.getElementById('insight-value-1');
                                const desc1 = document.getElementById('insight-desc-1');

                                if (Object.keys(categorySpending).length > 0) {
                                    // Find top category
                                    const sortedCategories = Object.entries(categorySpending).sort((a, b) => b[1] - a[1]);
                                    const topCategory = sortedCategories[0];
                                    const catName = topCategory[0].replace(/[^\wşüöçğıİŞÜÖÇĞ\s]/g, '').trim() || topCategory[0];
                                    const catAmount = topCategory[1];

                                    if (val1) val1.textContent = catName;

                                    // Compare with last month
                                    const lastMonthCatAmount = lastMonthCategorySpending[topCategory[0]] || 0;
                                    if (lastMonthCatAmount > 0) {
                                        const changePercent = Math.round(((catAmount - lastMonthCatAmount) / lastMonthCatAmount) * 100);
                                        if (changePercent > 0) {
                                            if (desc1) desc1.textContent = 'Geçen aya göre %' + changePercent + ' arttı. ₺' + catAmount.toLocaleString('tr-TR') + ' harcadın.';
                                        } else if (changePercent < 0) {
                                            if (desc1) desc1.textContent = 'Geçen aya göre %' + Math.abs(changePercent) + ' azaldı. Harika tasarruf!';
                                        } else {
                                            if (desc1) desc1.textContent = 'Geçen ayla aynı seviyede. ₺' + catAmount.toLocaleString('tr-TR') + ' harcadın.';
                                        }
                                    } else {
                                        if (desc1) desc1.textContent = 'Bu kategori için ₺' + catAmount.toLocaleString('tr-TR') + ' harcadın.';
                                    }
                                } else if (monthTx.length === 0) {
                                    if (val1) val1.textContent = '—';
                                    if (desc1) desc1.textContent = 'İşlem ekleyerek harcama analizinizi görün.';
                                } else {
                                    if (val1) val1.textContent = 'Yok';
                                    if (desc1) desc1.textContent = 'Bu ay henüz harcama kaydı yok.';
                                }

                                // ───────────────────────────────────────────────────────────────────
                                // CARD 3: Ay Sonu Tahmini
                                // ───────────────────────────────────────────────────────────────────
                                const val2 = document.getElementById('insight-value-2');
                                const desc2 = document.getElementById('insight-desc-2');
                                const icon2 = document.querySelector('.insight-card:nth-child(3) .insight-icon');

                                const today = new Date();
                                const dayOfMonth = today.getDate();
                                const daysInMonth = new Date(APP_YEAR, APP_MONTH, 0).getDate();
                                const daysRemaining = daysInMonth - dayOfMonth;

                                if (monthTx.length > 0 && dayOfMonth > 1) {
                                    // Calculate daily average spending rate
                                    const dailySpendingRate = expense / dayOfMonth;
                                    const projectedTotalExpense = expense + (dailySpendingRate * daysRemaining);
                                    const projectedBalance = income - projectedTotalExpense - savings;

                                    if (val2) val2.textContent = '₺' + Math.round(projectedBalance).toLocaleString('tr-TR');

                                    if (icon2) {
                                        icon2.classList.remove('icon-success', 'icon-warning', 'icon-danger');
                                        icon2.classList.add(projectedBalance >= 0 ? 'icon-success' : 'icon-danger');
                                    }

                                    if (desc2) {
                                        if (projectedBalance >= 0) {
                                            desc2.textContent = 'Mevcut harcama hızınla ay sonunda ₺' + Math.round(projectedBalance).toLocaleString('tr-TR') + ' kalacak.';
                                        } else {
                                            desc2.textContent = '⚠️ Dikkat! Bu hızla ay sonunda ₺' + Math.abs(Math.round(projectedBalance)).toLocaleString('tr-TR') + ' açık vereceksin.';
                                        }
                                    }
                                } else if (monthTx.length === 0) {
                                    if (val2) val2.textContent = '—';
                                    if (desc2) desc2.textContent = 'Tahmin için işlem geçmişi gerekli. Harcama ekleyin.';
                                } else {
                                    if (val2) val2.textContent = '₺' + Math.round(income - expense - savings).toLocaleString('tr-TR');
                                    if (desc2) desc2.textContent = 'Ayın ilk günü - tahmin için daha fazla veri bekleniyor.';
                                }

                                // ───────────────────────────────────────────────────────────────────
                                // CARD 4: Birikim Hedefi (Hedef Kumbarası ile entegre)
                                // ───────────────────────────────────────────────────────────────────
                                const val3 = document.getElementById('insight-value-3');
                                const desc3 = document.getElementById('insight-desc-3');
                                const icon3 = document.querySelector('.insight-card:nth-child(4) .insight-icon');

                                // Use global goals array (same as Hedef Kumbarası widget)
                                const goalsArray = (typeof goals !== 'undefined' && Array.isArray(goals)) ? goals : [];

                                if (goalsArray.length > 0) {
                                    // Find first active (uncompleted) goal
                                    const activeGoal = goalsArray.find(g => !g.completed) || goalsArray[0];

                                    // Calculate current TL using the same method as Hedef Kumbarası
                                    const goalTarget = parseFloat(activeGoal.target) || 0;
                                    const goalCurrentTL = (typeof window.getGoalCurrentTL === 'function')
                                        ? window.getGoalCurrentTL(activeGoal)
                                        : (parseFloat(activeGoal.current) || 0);

                                    const remaining = Math.max(0, goalTarget - goalCurrentTL);
                                    const progress = goalTarget > 0 ? Math.round((goalCurrentTL / goalTarget) * 100) : 0;
                                    const goalName = activeGoal.title || activeGoal.name || 'Hedef';

                                    if (val3) val3.textContent = '₺' + remaining.toLocaleString('tr-TR', { maximumFractionDigits: 0 });
                                    if (desc3) {
                                        if (remaining === 0) {
                                            desc3.textContent = '🎉 "' + goalName + '" tamamlandı! Yeni hedef belirle.';
                                        } else {
                                            desc3.textContent = '"' + goalName + '" hedefine ulaşmak için ' + remaining.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺ daha biriktirmelisiniz.';
                                        }
                                    }
                                    if (icon3) {
                                        icon3.classList.remove('icon-warning', 'icon-info');
                                        icon3.classList.add(progress >= 50 ? 'icon-success' : 'icon-info');
                                    }
                                } else {
                                    // No goals - show prompt
                                    if (val3) val3.textContent = '—';
                                    if (desc3) desc3.textContent = 'Hedef belirleyerek finansal yolculuğuna başla!';
                                    if (icon3) {
                                        icon3.classList.remove('icon-success', 'icon-warning');
                                        icon3.classList.add('icon-info');
                                    }
                                }

                                console.log('[InsightCards] ✅ Updated with real data:', { income, expense, savings, txCount: monthTx.length });

                            } catch (e) {
                                console.warn('[InsightCards] Update failed:', e);
                            }
                        };

                        // Auto-update on page load (wait for data to load)
                        document.addEventListener('DOMContentLoaded', () => {
                            // Initial update after data is likely loaded
                            setTimeout(window.updateInsightCards, 2000);
                            // Fallback update after 5 seconds for slow connections
                            setTimeout(window.updateInsightCards, 5000);
                        });

                        // Listen for data changes (multiple event types for compatibility)
                        ['fingenda_data_updated', 'storage', 'transaction:added', 'transactions:updated', 'goals:updated'].forEach(evt => {
                            window.addEventListener(evt, () => setTimeout(window.updateInsightCards, 300));
                        });

                        // Make updateInsightCards callable from processTransactions
                        window.__insightCardsReady = true;

                        // Card Click Handler
                        window.handleInsightClick = function (cardIndex, type) {
                            console.log('[Insight] Card clicked:', cardIndex, type);

                            // Navigate to relevant screen
                            if (typeof window.navigateTo === 'function') {
                                const screens = {
                                    savings: 'dashboard',
                                    spending: 'transactions',
                                    forecast: 'dashboard',
                                    goal: 'goals'
                                };
                                if (screens[type]) {
                                    window.navigateTo(screens[type]);
                                }
                            }

                            // Show toast
                            if (typeof window.showToast === 'function') {
                                const messages = {
                                    savings: 'Tasarruf detayları açılıyor...',
                                    spending: 'Harcama analizi açılıyor...',
                                    forecast: 'Tahmin detayları açılıyor...',
                                    goal: 'Hedefler açılıyor...'
                                };
                                window.showToast('info', messages[type] || 'Detaylar yükleniyor...');
                            }
                        }
                    </script>

                    <!-- Dashboard Widget Titles Upgrade -->
                    <style>
                        /* === Dashboard Widget Titles Upgrade (Net Nakit / Birikim / Gelir / Gider) === */

                        /* Net Nakit & Birikim başlıkları */
                        #dash-area-top .pw-title {
                            font-size: 13px;
                            font-weight: 900;
                            letter-spacing: 0.14em;
                            line-height: 1.05;
                            white-space: nowrap;
                            text-shadow: 0 1px 12px rgba(0, 0, 0, .18);
                        }

                        /* KARANKLIK MOD - Parlak başlık renkleri */
                        html.dark #dash-area-top .pw-widget--cash .pw-title {
                            color: #a5f3fc !important;
                            /* Cyan-200 - çok parlak */
                            text-shadow: 0 0 20px rgba(34, 211, 238, 0.6), 0 2px 8px rgba(0, 0, 0, 0.3);
                            font-size: 16px;
                            font-weight: 900;
                            letter-spacing: 0.18em;
                        }

                        html.dark #dash-area-top .pw-widget--savings .pw-title {
                            color: #c4b5fd !important;
                            /* Violet-300 - çok parlak */
                            text-shadow: 0 0 20px rgba(167, 139, 250, 0.6), 0 2px 8px rgba(0, 0, 0, 0.3);
                            font-size: 16px;
                            font-weight: 900;
                            letter-spacing: 0.18em;
                        }

                        /* Light mode için de düzenleme */
                        html:not(.dark) #dash-area-top .pw-widget--cash .pw-title {
                            color: #0891b2 !important;
                            /* Cyan-600 */
                            text-shadow: 0 1px 6px rgba(6, 182, 212, 0.25);
                        }

                        html:not(.dark) #dash-area-top .pw-widget--savings .pw-title {
                            color: #7c3aed !important;
                            /* Violet-600 */
                            text-shadow: 0 1px 6px rgba(124, 58, 237, 0.25);
                        }

                        /* Gelir & Gider başlıkları (sadece üst row'daki title p) */
                        #dash-area-bottom .widget-card-apple>.flex p {
                            font-size: 13px;
                            font-weight: 800;
                            letter-spacing: 0.16em;
                            line-height: 1.05;
                            white-space: nowrap;
                            opacity: 0.92;
                        }

                        /* KARANKLIK MOD - Gelir başlık (parlak yeşil) */
                        html.dark #dash-area-bottom .widget-card-apple:first-child>.flex p {
                            color: #6ee7b7 !important;
                            /* Emerald-300 */
                            text-shadow: 0 0 18px rgba(16, 185, 129, 0.6), 0 2px 8px rgba(0, 0, 0, 0.4);
                            font-size: 14px;
                            font-weight: 900;
                            letter-spacing: 0.18em;
                            opacity: 1;
                        }

                        /* KARANKLIK MOD - Gider başlık (parlak kırmızı) */
                        html.dark #dash-area-bottom .widget-card-apple:last-child>.flex p {
                            color: #fca5a5 !important;
                            /* Red-300 */
                            text-shadow: 0 0 18px rgba(239, 68, 68, 0.6), 0 2px 8px rgba(0, 0, 0, 0.4);
                            font-size: 14px;
                            font-weight: 900;
                            letter-spacing: 0.18em;
                            opacity: 1;
                        }

                        /* Light mode için geliştirilmiş stiller */
                        html:not(.dark) #dash-area-bottom .widget-card-apple:first-child>.flex p {
                            color: #059669 !important;
                            /* Emerald-600 */
                            text-shadow: 0 1px 6px rgba(16, 185, 129, 0.25);
                        }

                        html:not(.dark) #dash-area-bottom .widget-card-apple:last-child>.flex p {
                            color: #dc2626 !important;
                            /* Red-600 */
                            text-shadow: 0 1px 6px rgba(239, 68, 68, 0.25);
                        }

                        /* Mobilde ekstra kontrol: çok küçük ekranlarda taşma olmasın */
                        @media (max-width: 380px) {
                            #dash-area-top .pw-title {
                                font-size: 12.5px;
                                letter-spacing: 0.13em;
                            }

                            #dash-area-bottom .widget-card-apple>.flex p {
                                font-size: 12.5px;
                                letter-spacing: 0.14em;
                            }
                        }
                    </style>




                    <!-- Insight Widget Logic -->
                    <script>
                            (function () {
                                // Uygulamada transaction listesi nerede tutuluyorsa onu yakala.
                                function getTransactionsSafe() {
                                    if (Array.isArray(window.transactions)) return window.transactions;
                                    try {
                                        const raw = localStorage.getItem('transactions');
                                        const arr = raw ? JSON.parse(raw) : [];
                                        return Array.isArray(arr) ? arr : [];
                                    } catch (e) { return []; }
                                }

                                function lastNDaysRange(n) {
                                    const end = new Date();
                                    const start = new Date();
                                    start.setDate(end.getDate() - (n - 1));
                                    start.setHours(0, 0, 0, 0);
                                    return { start, end };
                                }

                                function sumByCategory(trans, start, end, type) {
                                    const map = new Map();
                                    trans.forEach(t => {
                                        const d = new Date(t.date || t.createdAt || t.timestamp || Date.now());
                                        if (d < start || d > end) return;
                                        if (type && t.type !== type) return;
                                        const cat = (t.category || t.mainCategory || 'Diğer').toString();
                                        const amt = Number(t.amount || t.value || 0) || 0;
                                        map.set(cat, (map.get(cat) || 0) + amt);
                                    });
                                    return map;
                                }

                                function topCategory(map) {
                                    let top = null, topVal = -Infinity;
                                    map.forEach((v, k) => {
                                        if (v > topVal) { topVal = v; top = k; }
                                    });
                                    return { cat: top, val: topVal };
                                }

                                function formatTry(n) {
                                    const x = Number(n) || 0;
                                    // Helper içinde renderMoney kullanımı
                                    return window.renderMoney(x, { decimals: 0 }); // Önerilerde kuruşsuz
                                }

                                function daysWithoutEntry(trans) {
                                    if (!trans.length) return 99;
                                    const last = trans
                                        .map(t => new Date(t.date || t.createdAt || t.timestamp || 0))
                                        .sort((a, b) => b - a)[0];
                                    const now = new Date();
                                    const diff = Math.floor((now - last) / (1000 * 60 * 60 * 24));
                                    return diff;
                                }

                                // HTML'yi düz metne dönüştür (Detay açılırken tag'ler görünmesin)
                                function stripHtml(html) {
                                    if (!html) return '';
                                    try {
                                        const doc = new DOMParser().parseFromString(html, 'text/html');
                                        return doc.body.textContent || '';
                                    } catch (e) {
                                        // Fallback: Basit regex ile temizle
                                        return html.replace(/<[^>]*>/g, '');
                                    }
                                }

                                function setInsightUI({ headline, text, tag, chip, action, payload }) {
                                    const h = document.getElementById('insight-headline');
                                    const p = document.getElementById('insight-text');
                                    const tg = document.getElementById('insight-tag');
                                    const ch = document.getElementById('insight-chip');

                                    if (h) h.textContent = headline;
                                    if (p) p.innerHTML = text; // textContent -> innerHTML (Formatted money support)
                                    if (tg) tg.textContent = tag;
                                    if (ch) ch.textContent = chip;

                                    const apply = document.getElementById('insight-apply');
                                    if (apply) {
                                        apply.onclick = () => {
                                            try {
                                                switch (action) {
                                                    case 'open-budget':
                                                        if (typeof window.openBudgetModal === 'function') window.openBudgetModal(payload);
                                                        break;
                                                    case 'add-transaction':
                                                        if (typeof window.openAddTransactionModal === 'function') window.openAddTransactionModal();
                                                        break;
                                                    case 'open-wallet':
                                                        if (typeof window.openWallet === 'function') window.openWallet();
                                                        break;
                                                    case 'open-reports':
                                                        if (typeof window.openReports === 'function') window.openReports();
                                                        break;
                                                }
                                            } catch (e) { }
                                        };
                                    }

                                    const detail = document.getElementById('insight-detail');
                                    if (detail) {
                                        detail.onclick = () => {
                                            try {
                                                const plainText = stripHtml(text);
                                                if (typeof window.openBottomSheet === 'function') {
                                                    window.openBottomSheet({
                                                        title: "İçgörü Detayı",
                                                        body: `${plainText}\n\nKaynak: Son 7 gün verisi.\nEtiket: ${tag}`
                                                    });
                                                } else {
                                                    alert("İçgörü Detayı:\n\n" + plainText + "\n\nKaynak: Son 7 gün verisi.");
                                                }
                                            } catch (e) { }
                                        };
                                    }

                                    const skip = document.getElementById('insight-skip');
                                    if (skip) {
                                        skip.onclick = () => window.renderDailyInsight(true);
                                    }
                                }

                                window.renderDailyInsight = function (forceAlt) {
                                    const trans = getTransactionsSafe();
                                    const { start, end } = lastNDaysRange(7);
                                    const { start: pStart, end: pEnd } = (function () {
                                        const e2 = new Date(start);
                                        e2.setDate(e2.getDate() - 1);
                                        const s2 = new Date(e2);
                                        s2.setDate(s2.getDate() - 6);
                                        s2.setHours(0, 0, 0, 0);
                                        return { start: s2, end: e2 };
                                    })();

                                    const expNow = sumByCategory(trans, start, end, 'expense');
                                    const expPrev = sumByCategory(trans, pStart, pEnd, 'expense');
                                    const topNow = topCategory(expNow);

                                    // 1) kategori artış içgörüsü
                                    if (topNow.cat) {
                                        const prevVal = expPrev.get(topNow.cat) || 0;
                                        const nowVal = topNow.val || 0;
                                        const inc = prevVal > 0 ? ((nowVal - prevVal) / prevVal) * 100 : (nowVal > 0 ? 100 : 0);

                                        if (!forceAlt && nowVal > 0 && inc >= 15) {
                                            const suggested = Math.max(100, Math.round(nowVal * 0.85));
                                            setInsightUI({
                                                headline: `${topNow.cat} harcaman yükseldi`,
                                                text: `Son 7 günde ${topNow.cat} giderin yaklaşık <strong class="ins-strong">+%${Math.round(inc)}</strong> arttı. Limit önerim: ${formatTry(suggested)}`,
                                                tag: "Limit önerisi",
                                                chip: "7 gün",
                                                action: "open-budget",
                                                payload: { category: topNow.cat, suggestedLimit: suggested }
                                            });
                                            return;
                                        }
                                    }

                                    // 2) kayıt yok içgörüsü
                                    const daysNo = daysWithoutEntry(trans);
                                    if (!forceAlt && daysNo >= 3) {
                                        setInsightUI({
                                            headline: "Kayıt ritmin düştü",
                                            text: `${daysNo} gündür işlem girişi yok. 10 saniyede hızlı bir kayıt ekleyip kontrolü geri al.`,
                                            tag: "Rutin",
                                            chip: `${daysNo} gün`,
                                            action: "add-transaction"
                                        });
                                        return;
                                    }

                                    // 3) birikim hedefi
                                    const goal = 250 + Math.round(Math.random() * 250);
                                    setInsightUI({
                                        headline: "Mini birikim hedefi koy",
                                        text: `Bütçen dengeli görünüyor. Bu hafta küçük bir hedef belirle: ${formatTry(goal)} birikim.`,
                                        tag: "Hedef",
                                        chip: "Haftalık",
                                        action: "open-wallet"
                                    });
                                };

                                // Page init
                                document.addEventListener('DOMContentLoaded', () => window.renderDailyInsight(false));

                                // Eğer işlem eklenince custom event atıyorsan, bunu dinle
                                document.addEventListener('transaction:added', () => window.renderDailyInsight(false));
                            })();
                    </script>

                    <!-- Analiz ve Grafikler -->

                    <div
                        class="relative overflow-hidden rounded-[32px] p-6 group transform transition-all duration-300 hover:scale-[1.01] shadow-2xl shadow-indigo-200/50 dark:shadow-none border-t border-white/50 dark:border-white/10 bg-gradient-to-br from-indigo-50/80 to-white/90 dark:from-[#1a1625]/95 dark:to-[#12101a]/95 backdrop-blur-2xl">

                        <div
                            class="absolute -right-12 -top-12 w-48 h-48 bg-indigo-300/30 dark:bg-indigo-600/20 rounded-full blur-[60px] animate-pulse">
                        </div>
                        <div
                            class="absolute -left-12 bottom-0 w-40 h-40 bg-purple-300/30 dark:bg-purple-600/20 rounded-full blur-[50px]">
                        </div>

                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-2xl bg-indigo-100 dark:bg-indigo-500/20 flex items-center justify-center text-xl shadow-sm border border-indigo-200 dark:border-indigo-500/30">
                                        📊</div>
                                    <div>
                                        <h3 class="font-black text-gray-800 dark:text-white text-lg tracking-tight">
                                            Finansal
                                            İçgörü</h3>
                                        <p
                                            class="text-[10px] font-bold text-indigo-500 dark:text-indigo-400 uppercase tracking-widest">
                                            Harcama Analizi</p>
                                    </div>
                                </div>
                                <button onclick="window.switchChart('general')" id="btn-chart-toggle"
                                    class="w-8 h-8 rounded-full bg-white dark:bg-white/5 border border-gray-100 dark:border-white/10 flex items-center justify-center text-gray-400 hover:text-indigo-500 transition shadow-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                            </div>

                            <div
                                class="h-56 relative w-full mb-6 p-2 bg-white/40 dark:bg-black/20 rounded-2xl border border-white/50 dark:border-white/5 shadow-inner">
                                <canvas id="mainChart"
                                    class="absolute inset-0 w-full h-full transition-opacity duration-300 p-2"></canvas>
                            </div>

                            <div
                                class="p-4 rounded-2xl bg-white/60 dark:bg-indigo-900/10 border border-white dark:border-indigo-500/20 shadow-sm backdrop-blur-md relative overflow-hidden group-hover:border-indigo-300 dark:group-hover:border-indigo-500/40 transition-colors">
                                <div id="category-top-list" class="space-y-3 relative z-10">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- YENİ: 3D Finansal Sağlık Kartı (Taşındı & Güncellendi) -->
                    <div
                        class="relative overflow-hidden rounded-[32px] p-6 group transform transition-all duration-300 hover:scale-[1.01] shadow-2xl shadow-emerald-100 dark:shadow-none border-t border-white/50 dark:border-white/10 bg-gradient-to-br from-emerald-50/80 to-teal-50/80 dark:from-[#0d1f1b]/95 dark:to-[#12101a]/95 backdrop-blur-2xl">

                        <div
                            class="absolute right-0 top-0 w-64 h-64 bg-emerald-400/20 dark:bg-emerald-600/10 rounded-full blur-[80px] -mr-16 -mt-16 pointer-events-none animate-pulse-slow">
                        </div>
                        <div
                            class="absolute left-0 bottom-0 w-48 h-48 bg-teal-400/20 dark:bg-teal-600/10 rounded-full blur-[60px] -ml-10 -mb-10 pointer-events-none">
                        </div>

                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-2xl bg-emerald-100 dark:bg-emerald-500/20 flex items-center justify-center text-xl shadow-sm border border-emerald-200 dark:border-emerald-500/30">
                                        🩺</div>
                                    <div>
                                        <h3 class="font-black text-gray-800 dark:text-white text-lg tracking-tight">
                                            Finansal
                                            Sağlık</h3>
                                        <p
                                            class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-widest">
                                            Check-up</p>
                                    </div>
                                </div>
                                <span
                                    class="px-2 py-1 rounded-lg bg-emerald-100 dark:bg-emerald-500/20 text-[9px] font-black text-emerald-700 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-500/30">CANLI</span>
                            </div>

                            <div id="health-status-content" class="mt-4">
                                <p class="text-sm text-gray-500 animate-pulse">Veriler analiz ediliyor...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Son İşlemler Listesi - Premium 3D -->
                    <div class="mb-24 px-2 transaction-list-container">
                        <div class="flex justify-between items-end mb-4 px-2">
                            <h3 class="section-title-premium mb-0">Son İşlemler</h3>
                            <button onclick="window.switchTab('history')"
                                class="text-xs font-bold text-indigo-500 hover:text-indigo-600 transition-colors">
                                Tümünü Gör →
                            </button>
                        </div>
                        <div id="recent-transactions-list" class="space-y-3">
                            <div class="p-4 text-center text-gray-400 text-sm rounded-2xl bg-white/40 dark:bg-white/5">
                                Yükleniyor...</div>
                        </div>
                    </div>
                </div>

                <!-- NOTES SCREEN (Notlar Ekranı) - Apple Award UI Style -->
                <div id="screen-notes" class="hidden space-y-5 screen-transition pb-40">

                    <!-- Premium Header with Glass Effect -->
                    <div
                        class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-amber-500/10 via-orange-500/5 to-yellow-500/10 dark:from-amber-500/20 dark:via-orange-500/10 dark:to-yellow-500/15 p-5 border border-amber-200/30 dark:border-amber-500/20">
                        <div
                            class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-amber-400/20 to-transparent rounded-full blur-2xl -translate-y-1/2 translate-x-1/2">
                        </div>
                        <div
                            class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-orange-400/15 to-transparent rounded-full blur-xl translate-y-1/2 -translate-x-1/2">
                        </div>

                        <div class="relative flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg shadow-amber-500/30">
                                    <span class="text-2xl">📝</span>
                                </div>
                                <div>
                                    <h3 class="text-xl font-black text-gray-900 dark:text-white tracking-tight">Notlarım
                                    </h3>
                                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Fikirler &
                                        Yapılacaklar
                                    </p>
                                </div>
                            </div>
                            <button onclick="window.toggleNotesModal()"
                                class="w-11 h-11 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 text-white flex items-center justify-center shadow-lg shadow-amber-500/25 hover:shadow-xl hover:shadow-amber-500/40 hover:scale-105 active:scale-95 transition-all duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Stats Row -->
                        <div
                            class="relative flex items-center gap-3 mt-4 pt-4 border-t border-amber-200/30 dark:border-amber-500/20">
                            <div class="flex-1 text-center p-2 rounded-xl bg-white/50 dark:bg-white/5">
                                <p id="notes-total-count" class="text-lg font-black text-gray-800 dark:text-white">0</p>
                                <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">Toplam</p>
                            </div>
                            <div class="flex-1 text-center p-2 rounded-xl bg-white/50 dark:bg-white/5">
                                <p id="notes-completed-count" class="text-lg font-black text-emerald-500">0</p>
                                <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">Tamamlandı
                                </p>
                            </div>
                            <div class="flex-1 text-center p-2 rounded-xl bg-white/50 dark:bg-white/5">
                                <p id="notes-pending-count" class="text-lg font-black text-amber-500">0</p>
                                <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">Bekliyor</p>
                            </div>
                        </div>
                    </div>

                    <!-- Category Filter Tabs -->
                    <div class="flex gap-2 overflow-x-auto no-scrollbar px-1">
                        <button onclick="window.filterNotes('all')" data-filter="all"
                            class="notes-filter-btn active flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold bg-amber-500 text-white shadow-md shadow-amber-500/25 transition-all">
                            📋 Tümü
                        </button>
                        <button onclick="window.filterNotes('important')" data-filter="important"
                            class="notes-filter-btn flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold bg-white/60 dark:bg-white/10 text-gray-600 dark:text-gray-400 hover:bg-white dark:hover:bg-white/20 transition-all">
                            ⭐ Önemli
                        </button>
                        <button onclick="window.filterNotes('todo')" data-filter="todo"
                            class="notes-filter-btn flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold bg-white/60 dark:bg-white/10 text-gray-600 dark:text-gray-400 hover:bg-white dark:hover:bg-white/20 transition-all">
                            ✅ Yapılacak
                        </button>
                        <button onclick="window.filterNotes('idea')" data-filter="idea"
                            class="notes-filter-btn flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold bg-white/60 dark:bg-white/10 text-gray-600 dark:text-gray-400 hover:bg-white dark:hover:bg-white/20 transition-all">
                            💡 Fikir
                        </button>
                        <button onclick="window.filterNotes('financial')" data-filter="financial"
                            class="notes-filter-btn flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold bg-white/60 dark:bg-white/10 text-gray-600 dark:text-gray-400 hover:bg-white dark:hover:bg-white/20 transition-all">
                            💰 Finansal
                        </button>
                    </div>

                    <!-- Notes List Container -->
                    <div id="notes-task-list" class="space-y-3">
                        <!-- Notes will be rendered here dynamically -->
                    </div>

                    <!-- Premium Empty State -->
                    <div id="notes-empty-state" class="hidden">
                        <div
                            class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-gray-50 to-gray-100/50 dark:from-gray-800/50 dark:to-gray-900/50 p-8 border border-gray-200/50 dark:border-white/10">
                            <div
                                class="absolute top-0 right-0 w-40 h-40 bg-gradient-radial from-amber-200/20 to-transparent rounded-full blur-2xl">
                            </div>
                            <div
                                class="absolute bottom-0 left-0 w-32 h-32 bg-gradient-radial from-orange-200/15 to-transparent rounded-full blur-xl">
                            </div>

                            <div class="relative flex flex-col items-center text-center">
                                <div
                                    class="w-20 h-20 rounded-3xl bg-gradient-to-br from-amber-100 to-orange-100 dark:from-amber-500/20 dark:to-orange-500/20 flex items-center justify-center mb-4 shadow-lg shadow-amber-500/10">
                                    <span class="text-4xl animate-bounce-slow">📝</span>
                                </div>
                                <h4 class="text-lg font-black text-gray-800 dark:text-white mb-2">Henüz Not Yok</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-5 max-w-xs">Fikirlerinizi,
                                    yapılacakları ve finansal notlarınızı buraya ekleyin.</p>
                                <button onclick="window.toggleNotesModal()"
                                    class="px-6 py-3 rounded-2xl bg-gradient-to-r from-amber-400 to-orange-500 text-white font-bold text-sm shadow-lg shadow-amber-500/30 hover:shadow-xl hover:shadow-amber-500/40 hover:scale-105 active:scale-95 transition-all duration-200">
                                    + İlk Notunu Ekle
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- HISTORY SCREEN (Geçmiş İşlemler Ekranı) -->
                <div id="screen-history" class="hidden space-y-6 screen-transition pb-40">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Geçmiş İşlemler</h3>
                        <div class="flex space-x-2">
                            <button onclick="window.exportToCSV()"
                                class="relative group text-xs font-bold bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1.5 rounded-lg flex items-center transition hover:bg-green-200 dark:hover:bg-green-900/50 border border-green-200 dark:border-green-800">
                                <span class="absolute -top-1 -right-1 text-[8px]">👑</span>
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                    </path>
                                </svg>
                                Excel
                            </button>
                            <button onclick="window.downloadPDFReport()"
                                class="relative group text-xs font-bold bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 px-3 py-1.5 rounded-lg flex items-center transition hover:bg-red-200 dark:hover:bg-red-900/50 border border-red-200 dark:border-red-800">
                                <span class="absolute -top-1 -right-1 text-[8px]">👑</span>
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                    </path>
                                </svg>
                                PDF
                            </button>
                        </div>
                    </div>

                    <!-- Financial Calendar Widget (MODERNIZED) -->
                    <!-- Yearly Financial Overview (YENİ) -->
                    <!-- Financial Calendar Widget (MINIMALIST HORIZONTAL) -->
                    <!-- Financial Calendar Widget (ULTRA-SLIM STRIP) -->
                    <!-- Financial Calendar Widget (Horizontal Filter Scroll) -->
                    <div id="financial-calendar" class="w-full mb-2 relative z-20 flex flex-col gap-2">

                        <div class="flex items-center justify-between px-4 py-1">
                            <div class="flex items-center gap-4">
                                <h4 id="calendar-year-label"
                                    class="text-2xl font-black text-gray-800 dark:text-white tracking-tighter">
                                    2025</h4>
                                <div class="flex gap-1">
                                    <button onclick="window.changeStatsYear(-1)"
                                        class="w-6 h-6 rounded-full bg-gray-100/80 dark:bg-white/10 flex items-center justify-center text-gray-600 dark:text-gray-300 text-xs hover:bg-gray-200 dark:hover:bg-white/20 active:bg-gray-200 dark:active:bg-white/20 transition">◀</button>
                                    <button onclick="window.changeStatsYear(1)"
                                        class="w-6 h-6 rounded-full bg-gray-100/80 dark:bg-white/10 flex items-center justify-center text-gray-600 dark:text-gray-300 text-xs hover:bg-gray-200 dark:hover:bg-white/20 active:bg-gray-200 dark:active:bg-white/20 transition">▶</button>
                                </div>
                            </div>
                            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">Zaman
                                Çizelgesi</span>
                        </div>

                        <div id="calendar-year-grid"
                            class="flex overflow-x-auto px-4 pb-4 gap-2 no-scrollbar mask-linear-fade snap-x">
                        </div>
                    </div>
                    <!-- Arama Kutusu -->
                    <div class="relative px-1">
                        <input type="text" id="history-search" oninput="window.searchTransactions(this.value)"
                            placeholder="İşlem ara (Örn: Market, Maaş)..."
                            class="modern-input w-full pl-10 pr-4 py-3.5 rounded-2xl text-sm font-medium bg-white/60 dark:bg-gray-800 shadow-sm placeholder-gray-500 text-gray-900">
                        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div id="full-history-list" class="space-y-3"></div>
                </div>

                <!-- GOALS SCREEN (Hedefler Ekranı) -->
                <div id="screen-goals" class="hidden space-y-6 screen-transition pb-40">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Hedefler</h3>
                        <button onclick="window.toggleGoalModal(true)"
                            class="w-9 h-9 rounded-full bg-black dark:bg-white text-white dark:text-black flex items-center justify-center hover:scale-110 transition shadow-lg text-xl">+</button>
                    </div>
                    <div id="goals-list" class="space-y-4"></div>
                </div>

                <!-- DOVIZ SCREEN (Piyasa Durumu Ekranı) -->
                <div id="screen-doviz" class="hidden space-y-6 screen-transition pb-40">
                    <div class="flex justify-between items-center px-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Piyasa Durumu</h3>
                            <span class="flex h-2 w-2 relative">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                        </div>
                        <button onclick="window.fetchMarketData()" id="refresh-market-btn"
                            class="w-9 h-9 rounded-full bg-white/50 dark:bg-white/10 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-green-100 hover:text-green-600 transition shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- USD -->
                        <div
                            class="glass-card rounded-2xl p-4 relative overflow-hidden group hover:bg-white/60 dark:hover:bg-white/10 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <span
                                    class="gold-icon-premium flex items-center justify-center text-[42px] filter drop-shadow-md"
                                    aria-hidden="true"
                                    style="background: radial-gradient(circle, rgba(34,197,94,0.15) 0%, rgba(0,0,0,0) 70%); border-radius: 50%;">
                                    💵
                                </span>
                                <span id="rate-usd-change"
                                    class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-white/50 dark:bg-black/30 text-gray-500 flex items-center backdrop-blur-sm">
                                    <span class="animate-pulse">...</span>
                                </span>
                            </div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-wide">ABD Doları</p>
                            <p id="val-usd"
                                class="text-xl font-black text-gray-900 dark:text-white mt-1 flex items-center gap-1">--
                            </p>
                        </div>

                        <!-- EUR -->
                        <div
                            class="glass-card rounded-2xl p-4 relative overflow-hidden group hover:bg-white/60 dark:hover:bg-white/10 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <span
                                    class="gold-icon-premium flex items-center justify-center text-[42px] filter drop-shadow-md"
                                    aria-hidden="true"
                                    style="background: radial-gradient(circle, rgba(59,130,246,0.15) 0%, rgba(0,0,0,0) 70%); border-radius: 50%;">
                                    💶
                                </span>
                                <span id="rate-eur-change"
                                    class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-white/50 dark:bg-black/30 text-gray-500 flex items-center backdrop-blur-sm">
                                    <span class="animate-pulse">...</span>
                                </span>
                            </div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Euro</p>
                            <p id="val-eur"
                                class="text-xl font-black text-gray-900 dark:text-white mt-1 flex items-center gap-1">--
                            </p>
                        </div>

                        <!-- GRAM GOLD - Premium 3D Icon -->
                        <div
                            class="glass-card rounded-2xl p-4 relative overflow-hidden group hover:bg-white/60 dark:hover:bg-white/10 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <span
                                    class="gold-icon-premium flex items-center justify-center text-[42px] filter drop-shadow-md"
                                    aria-hidden="true"
                                    style="background: radial-gradient(circle, rgba(255,223,0,0.15) 0%, rgba(0,0,0,0) 70%); border-radius: 50%;">
                                    🥇
                                </span>
                                <span id="rate-gram-change"
                                    class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-white/50 dark:bg-black/30 text-gray-500 flex items-center backdrop-blur-sm">
                                    <span class="animate-pulse">...</span>
                                </span>
                            </div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Gram Altın</p>
                            <p id="val-gold-gram"
                                class="text-xl font-black text-yellow-600 dark:text-yellow-400 mt-1 flex items-center gap-1">
                                --
                            </p>
                            <p class="text-[9px] text-gray-400 mt-1 font-medium">Canlı Piyasalar</p>
                        </div>

                        <!-- QUARTER GOLD - Premium 3D Icon -->
                        <div
                            class="glass-card rounded-2xl p-4 relative overflow-hidden group hover:bg-white/60 dark:hover:bg-white/10 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <span
                                    class="gold-icon-premium flex items-center justify-center text-[42px] filter drop-shadow-md"
                                    aria-hidden="true"
                                    style="background: radial-gradient(circle, rgba(255,223,0,0.15) 0%, rgba(0,0,0,0) 70%); border-radius: 50%;">
                                    🪙
                                </span>
                                <span id="rate-quarter-change"
                                    class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-white/50 dark:bg-black/30 text-gray-500 flex items-center backdrop-blur-sm">
                                    <span class="animate-pulse">...</span>
                                </span>
                            </div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Çeyrek Altın</p>
                            <p id="val-gold-quarter"
                                class="text-xl font-black text-yellow-600 dark:text-yellow-400 mt-1 flex items-center gap-1">
                                --
                            </p>
                            <p class="text-[9px] text-gray-400 mt-1 font-medium">Canlı Piyasalar</p>
                        </div>
                    </div>

                    <!-- YENİ BÖLÜM: Popüler Hisseler -->
                    <div class="space-y-4 pt-4">
                        <div class="flex items-center justify-between px-2">
                            <h3 class="font-bold text-gray-800 dark:text-white text-lg">Popüler Hisseler (BIST)
                            </h3>
                            <span
                                class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full font-bold">Canlı</span>
                        </div>

                        <!-- Search Input -->
                        <div class="px-2 mb-3">
                            <div class="relative">
                                <input type="text" id="stock-search-input" placeholder="Hisse ara (Örn: THYAO)..."
                                    class="w-full bg-white/50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700/50 rounded-xl px-4 py-2.5 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all backdrop-blur-sm dark:text-white dark:placeholder-gray-400">
                                <svg class="w-4 h-4 absolute left-3.5 top-1/2 transform -translate-y-1/2 text-gray-400"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>



                        <div id="stock-list-container" class="grid grid-cols-2 gap-3 pb-3 px-1">
                            <div
                                class="w-full glass-card rounded-xl p-3 text-center animate-pulse border border-white/40">
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12 mx-auto mb-2"></div>
                                <div class="h-6 bg-gray-300 dark:bg-gray-600 rounded w-20 mx-auto"></div>
                            </div>
                            <div class="w-full glass-card rounded-xl p-3 text-center animate-pulse border border-white/40"
                                style="animation-delay: 0.1s">
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12 mx-auto mb-2"></div>
                                <div class="h-6 bg-gray-300 dark:bg-gray-600 rounded w-20 mx-auto"></div>
                            </div>
                            <div class="w-full glass-card rounded-xl p-3 text-center animate-pulse border border-white/40"
                                style="animation-delay: 0.2s">
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12 mx-auto mb-2"></div>
                                <div class="h-6 bg-gray-300 dark:bg-gray-600 rounded w-20 mx-auto"></div>
                            </div>
                            <div class="w-full glass-card rounded-xl p-3 text-center animate-pulse border border-white/40"
                                style="animation-delay: 0.3s">
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12 mx-auto mb-2"></div>
                                <div class="h-6 bg-gray-300 dark:bg-gray-600 rounded w-20 mx-auto"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-2 text-right px-2">
                        <span class="text-[9px] text-gray-400 font-medium">Veriler anlık güncellenmektedir. Son:
                            <span class="market-time font-bold">--:--</span></span>
                    </div>
                </div>

                <!-- FINGO AUTOPILOT - Premium Finans Koçu (V2.0 - Apple Design Award Aesthetic) -->
                <div id="screen-wallet"
                    class="fb-container hidden space-y-0 screen-transition relative bg-[#dde2e9] dark:bg-[#0f1629]">

                    <!-- PREMIUM GATE (Mevcut yapı korunuyor) -->
                    <div id="autopilot-premium-gate" class="absolute inset-0 z-[60] hidden">
                        <!-- Gradient Blur Overlay -->
                        <div class="absolute inset-0 backdrop-blur-xl"
                            style="background: linear-gradient(180deg, rgba(26, 16, 51, 0.95) 0%, rgba(15, 10, 31, 0.98) 100%);">
                        </div>
                        <!-- Animated Orbs -->
                        <div
                            class="absolute -top-20 -left-20 w-40 h-40 bg-purple-600/30 rounded-full blur-[80px] animate-pulse">
                        </div>
                        <div
                            class="absolute -bottom-20 -right-20 w-48 h-48 bg-blue-600/20 rounded-full blur-[80px] animate-pulse-slow">
                        </div>
                        <!-- Content -->
                        <div class="relative z-10 flex flex-col items-center justify-center h-full px-6 text-center">
                            <div class="premium-crown w-28 h-28 rounded-[32px] flex items-center justify-center mb-8 shadow-2xl premium-glow"
                                style="background: linear-gradient(135deg, #8b5cf6, #6366f1, #3b82f6);">
                                <span class="text-6xl filter drop-shadow-lg">👑</span>
                            </div>
                            <h2 class="text-3xl font-black text-white mb-2 tracking-tight">Fingo Autopilot</h2>
                            <p
                                class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-400 text-lg font-bold mb-6">
                                Premium Özellik</p>
                            <p class="text-sm mb-8 max-w-[280px] text-white/70 leading-relaxed">Akıllı bütçe
                                koruması, nakit
                                akışı tahmini ve kişisel finans koçunla tanış.</p>
                            <button onclick="document.getElementById('premium-modal').classList.remove('hidden')"
                                class="px-10 py-4 rounded-2xl font-black text-white shadow-xl hover:scale-105 transition-all relative overflow-hidden"
                                style="background: linear-gradient(135deg, #8b5cf6, #6366f1, #3b82f6); box-shadow: 0 10px 40px rgba(99, 102, 241, 0.5);">
                                <span class="relative z-10">Premium'a Geç ✨</span>
                                <div class="premium-shimmer absolute inset-0 z-0"></div>
                            </button>
                        </div>
                    </div>



                    <!-- Header & Tabs -->
                    <div class="px-5 pt-4 pb-2 shrink-0">
                        <!-- Clean Header -->
                        <div class="flex items-center justify-between mb-5">
                            <div>
                                <h2 class="text-3xl font-black tracking-tight text-gray-900 dark:text-white"
                                    style="font-family: -apple-system, sans-serif; letter-spacing: -0.03em;">
                                    Fingo Brain
                                </h2>
                                <div class="flex items-center gap-2 mt-1">
                                    <span
                                        class="px-2 py-0.5 rounded-full bg-indigo-100/50 dark:bg-indigo-500/20 text-indigo-600 dark:text-indigo-300 text-[11px] font-bold uppercase tracking-wider">
                                        PRO V2.0
                                    </span>
                                    <p class="text-[13px] font-semibold text-gray-400 dark:text-gray-500">
                                        Finansal Zeka
                                    </p>
                                </div>
                            </div>
                            <div
                                class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-[2px] shadow-lg shadow-indigo-500/30">
                                <div
                                    class="w-full h-full rounded-full bg-white dark:bg-[#1c1c1e] flex items-center justify-center">
                                    <span class="text-2xl">🧠</span>
                                </div>
                            </div>
                        </div>

                        <!-- TAB MENU - Apple Segmented Control -->
                        <div class="fb-segmented-control mb-2">
                            <button onclick="window.switchAutopilotTab('pulse')" id="tab-btn-pulse"
                                class="fb-segment-btn active">
                                Pulse
                            </button>
                            <button onclick="window.switchAutopilotTab('dna')" id="tab-btn-dna" class="fb-segment-btn">
                                DNA
                            </button>
                            <button onclick="window.switchAutopilotTab('ailab')" id="tab-btn-ailab"
                                class="fb-segment-btn">
                                AI Lab
                            </button>
                            <button onclick="window.switchAutopilotTab('installments')" id="tab-btn-installments"
                                class="fb-segment-btn">
                                Taksitler
                            </button>
                            <!-- Asistan tab removed from main nav, accessed via Pulse or Floating -->
                        </div>
                    </div>

                    <!-- SCROLLABLE CONTENT AREA -->
                    <div class="px-4 space-y-5 pb-40">

                        <!-- TAB 1: PULSE (Genel Durum & Tahmin) -->
                        <div id="autopilot-tab-pulse" class="space-y-5 animate-fb-entry">

                            <!-- RANGE SELECTOR: Bugün / Hafta / Ay -->
                            <div class="fb-segmented-control" role="tablist" aria-label="Zaman aralığı">
                                <button onclick="window.setFingoBrainRange('day')" class="fb-segment-btn" role="tab"
                                    aria-selected="false" id="range-day">Bugün</button>
                                <button onclick="window.setFingoBrainRange('week')" class="fb-segment-btn" role="tab"
                                    aria-selected="false" id="range-week">Bu Hafta</button>
                                <button onclick="window.setFingoBrainRange('month')" class="fb-segment-btn active"
                                    role="tab" aria-selected="true" id="range-month">Bu Ay</button>
                            </div>

                            <!-- Apple Health Style Hero Ring -->
                            <div
                                class="relative overflow-hidden rounded-[32px] p-6 text-center transform transition-transform active:scale-95 duration-200 cursor-default group bg-gradient-to-br from-white to-gray-50 dark:from-slate-800 dark:to-[#0f1629] shadow-[0_20px_40px_-10px_rgba(0,0,0,0.1)] dark:shadow-[0_20px_40px_-10px_rgba(0,0,0,0.5)]">

                                <!-- Premium Glow behind ring -->
                                <div
                                    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-indigo-500/20 rounded-full blur-3xl animate-pulse-slow">
                                </div>

                                <div class="relative z-10 flex flex-col items-center">
                                    <div class="w-48 h-48 relative mb-4">
                                        <!-- SVG Ring Container -->
                                        <svg class="w-full h-full transform -rotate-90">
                                            <!-- Track -->
                                            <circle cx="96" cy="96" r="80" stroke="rgba(255,255,255,0.1)"
                                                stroke-width="16" fill="none" stroke-linecap="round" />
                                            <!-- Progress (Animated) -->
                                            <circle id="fingo-score-circle" cx="96" cy="96" r="80"
                                                stroke="url(#gradient-score)" stroke-width="16" fill="none"
                                                stroke-linecap="round" stroke-dasharray="502" stroke-dashoffset="100"
                                                class="transition-all duration-1500 ease-out"
                                                style="filter: drop-shadow(0 0 8px rgba(94, 92, 230, 0.5));" />

                                            <!-- Gradients Definition -->
                                            <defs>
                                                <linearGradient id="gradient-score" x1="0%" y1="0%" x2="100%" y2="0%">
                                                    <stop offset="0%" stop-color="#5e5ce6" />
                                                    <stop offset="100%" stop-color="#bf5af2" />
                                                </linearGradient>
                                            </defs>
                                        </svg>

                                        <!-- Inner Text -->
                                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                                            <span
                                                class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">SCORE</span>
                                            <span id="fingo-score-val"
                                                class="text-6xl font-black text-gray-900 dark:text-white tracking-tighter"
                                                style="font-family: 'SF Pro Display', sans-serif;">850</span>
                                            <span class="text-sm font-medium text-indigo-300 mt-1">Mükemmel</span>
                                        </div>
                                    </div>

                                    <p class="text-sm text-gray-400 max-w-[200px] leading-relaxed">
                                        Finansal sağlığın zirvede. <br>Böyle devam et! 🚀
                                    </p>
                                </div>
                            </div>

                            <!-- 2-Column Bento Grid -->
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Tahmini Bakiye -->
                                <div onclick="window.showWidgetInfo('prediction')"
                                    class="fb-glass-card p-5 relative overflow-hidden group cursor-pointer">
                                    <div class="absolute top-0 right-0 p-3 opacity-20">
                                        <span class="text-3xl">🔮</span>
                                    </div>
                                    <div class="relative z-10">
                                        <p class="text-xs font-bold text-indigo-500 uppercase tracking-wide mb-2">Ay
                                            Sonu
                                        </p>
                                        <h3 id="prediction-balance"
                                            class="text-xl font-black text-gray-900 dark:text-white tracking-tight">-- ₺
                                        </h3>
                                        <p id="prediction-detail"
                                            class="text-[10px] text-gray-400 mt-1 truncate font-medium">
                                            Hesaplanıyor...</p>
                                    </div>
                                </div>

                                <!-- Volatilite -->
                                <div onclick="window.showWidgetInfo('volatility')"
                                    class="fb-glass-card p-5 relative overflow-hidden group cursor-pointer">
                                    <div class="absolute top-0 right-0 p-3 opacity-20">
                                        <span class="text-3xl">📊</span>
                                    </div>
                                    <div class="relative z-10">
                                        <p class="text-xs font-bold text-orange-500 uppercase tracking-wide mb-2">Risk
                                        </p>
                                        <h3 id="prediction-volatility"
                                            class="text-xl font-black text-gray-900 dark:text-white tracking-tight">--
                                        </h3>
                                        <p id="volatility-detail"
                                            class="text-[10px] text-gray-400 mt-1 truncate font-medium">
                                            Analiz ediliyor</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Burn Rate Chart Card -->
                            <div class="fb-glass-card p-4 overflow-hidden relative">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h3 class="font-bold text-gray-900 dark:text-white">Harcama Trendi</h3>
                                        <p class="text-[10px] text-gray-500">Son 7 Günlük Analiz</p>
                                    </div>
                                    <div
                                        class="w-8 h-8 rounded-full bg-blue-50 dark:bg-blue-500/10 flex items-center justify-center">
                                        <span class="text-xs">📈</span>
                                    </div>
                                </div>
                                <div class="relative h-48 w-full">
                                    <canvas id="burnRateChart"></canvas>
                                </div>
                            </div>

                            <!-- Tools Grid - Minimal Text Keys -->
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="window.openCurrencyModal()"
                                    class="fb-glass-card p-4 flex items-center gap-3 hover:bg-white/50 transition-colors text-left">
                                    <div
                                        class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-500/20 flex items-center justify-center text-emerald-600 dark:text-emerald-400 shrink-0">
                                        💱
                                    </div>
                                    <div>
                                        <div class="text-xs font-bold text-gray-900 dark:text-white">Döviz</div>
                                        <div class="text-[10px] text-emerald-500/80">Canlı Kur</div>
                                    </div>
                                </button>
                                <button onclick="window.openLoanModal()"
                                    class="fb-glass-card p-4 flex items-center gap-3 hover:bg-white/50 transition-colors text-left">
                                    <div
                                        class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-500/20 flex items-center justify-center text-indigo-600 dark:text-indigo-400 shrink-0">
                                        🏦
                                    </div>
                                    <div>
                                        <div class="text-xs font-bold text-gray-900 dark:text-white">Kredi</div>
                                        <div class="text-[10px] text-indigo-500/80">Hesaplama</div>
                                    </div>
                                </button>
                            </div>

                        </div> <!-- End Tab Pulse -->


                        <!-- TAB 2: DNA (Radar Chart) -->


                        <!-- TAB 2: DNA (Radar Chart) -->
                        <div id="autopilot-tab-dna" class="space-y-5 hidden animate-fb-entry pb-24">

                            <!-- 1. SPENDING PERSONALITY CARD - Hero Style -->
                            <div id="dna-personality-card" class="fb-hero relative overflow-hidden group">
                                <!-- Dynamic Background based on persona (will be set by JS, default gradient here) -->
                                <div
                                    class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 opacity-90">
                                </div>

                                <div class="relative z-10 flex flex-col items-center text-center">
                                    <div
                                        class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-md flex items-center justify-center text-3xl mb-3 shadow-lg border border-white/20">
                                        <span id="dna-persona-icon">✨</span>
                                    </div>
                                    <h3 class="text-xs font-bold text-white/80 uppercase tracking-widest mb-1">Harcama
                                        Karakterin</h3>
                                    <h2 id="dna-persona-title"
                                        class="text-3xl font-black text-white tracking-tight mb-2">
                                        Analiz Ediliyor...</h2>
                                    <p id="dna-persona-desc"
                                        class="text-sm font-medium text-white/90 leading-relaxed max-w-[260px]">
                                        Finansal verilerin inceleniyor.
                                    </p>
                                </div>
                            </div>

                            <!-- 2. RADAR CHART CARD -->
                            <div class="fb-glass-card p-5">
                                <div class="flex justify-between items-center mb-6">
                                    <div>
                                        <h3 class="font-bold text-gray-900 dark:text-white text-lg">Harcama DNA'sı</h3>
                                        <p class="text-xs text-gray-500 font-medium">Kategori Dağılımı</p>
                                    </div>
                                    <button onclick="window.renderRadarChart()"
                                        class="w-10 h-10 rounded-full bg-gray-100 dark:bg-white/10 text-gray-500 dark:text-gray-400 flex items-center justify-center hover:bg-indigo-500 hover:text-white transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                            </path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Chart Container -->
                                <div class="relative h-64 w-full flex items-center justify-center mb-4">
                                    <canvas id="radarChart"></canvas>
                                </div>

                                <!-- Stats Grid -->
                                <div class="grid grid-cols-3 gap-2">
                                    <div
                                        class="p-3 bg-gray-50 dark:bg-white/5 rounded-xl text-center border border-gray-100 dark:border-white/5">
                                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Baskın</p>
                                        <p id="dna-dominant-cat"
                                            class="text-xs font-black text-indigo-500 dark:text-indigo-400 truncate">--
                                        </p>
                                    </div>
                                    <div
                                        class="p-3 bg-gray-50 dark:bg-white/5 rounded-xl text-center border border-gray-100 dark:border-white/5">
                                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Skor</p>
                                        <p id="dna-diversity-score"
                                            class="text-xs font-black text-purple-500 dark:text-purple-400">--</p>
                                    </div>
                                    <div
                                        class="p-3 bg-gray-50 dark:bg-white/5 rounded-xl text-center border border-gray-100 dark:border-white/5">
                                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Aktif</p>
                                        <p id="dna-total-cats"
                                            class="text-xs font-black text-emerald-500 dark:text-emerald-400">--</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. MONTH COMPARISON -->
                            <div class="fb-glass-card p-5 flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Geçen Aya
                                        Göre
                                    </p>
                                    <div id="dna-month-comparison" class="flex items-baseline gap-2">
                                        <h3 class="text-2xl font-black text-gray-900 dark:text-white">--</h3>
                                        <span
                                            class="text-xs font-bold px-2.5 py-1 rounded-full bg-gray-100 dark:bg-white/10 text-gray-500">Analiz
                                            Ediliyor</span>
                                    </div>
                                </div>
                                <div
                                    class="w-12 h-12 rounded-full bg-indigo-50 dark:bg-indigo-500/10 flex items-center justify-center text-xl">
                                    🗓️
                                </div>
                            </div>

                            <!-- 4. CATEGORIES LIST -->
                            <div class="fb-glass-card overflow-hidden">
                                <div
                                    class="p-5 border-b border-gray-100 dark:border-white/5 flex items-center justify-between">
                                    <h3 class="font-bold text-gray-900 dark:text-white">Kategoriler</h3>
                                    <span class="text-xs text-gray-400 font-medium">Detaylar</span>
                                </div>
                                <div id="dna-category-list" class="divide-y divide-gray-100 dark:divide-white/5">
                                    <!-- Populated by JS -->
                                    <div class="text-center py-8 text-gray-400 text-sm font-medium">Veriler
                                        yükleniyor...
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- TAB 3: AI LAB -->
                        <div id="autopilot-tab-ailab" class="hidden animate-fb-entry pb-24">
                            <div class="grid grid-cols-2 gap-4">

                                <!-- 1. HERO WIDGET: 3 Monthly Forecast (Full Width) -->
                                <div onclick="window.FinancialForecast.openModal()"
                                    class="col-span-2 group relative overflow-hidden rounded-[32px] bg-white dark:bg-[#1c1c1e] p-6 shadow-[0_20px_40px_-12px_rgba(0,0,0,0.08)] hover:shadow-[0_25px_50px_-12px_rgba(99,102,241,0.15)] transition-all duration-300 border border-white/40 dark:border-white/5 cursor-pointer active:scale-[0.98]">

                                    <!-- Background Mesh/Glow -->
                                    <div
                                        class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/5 rounded-full blur-3xl -mr-16 -mt-16 group-hover:bg-indigo-500/10 transition-colors duration-500">
                                    </div>
                                    <div
                                        class="absolute bottom-0 left-0 w-48 h-48 bg-purple-500/5 rounded-full blur-3xl -ml-12 -mb-12 group-hover:bg-purple-500/10 transition-colors duration-500">
                                    </div>

                                    <div class="relative z-10 flex flex-col h-full justify-between gap-4">
                                        <div class="flex items-start justify-between">
                                            <div
                                                class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-3xl shadow-lg shadow-indigo-500/20 text-white group-hover:scale-110 transition-transform duration-300">
                                                🔮
                                            </div>
                                            <div
                                                class="px-3 py-1 rounded-full bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-500/20">
                                                <span
                                                    class="text-[11px] font-bold text-indigo-600 dark:text-indigo-300 tracking-wide uppercase">Öne
                                                    Çıkan</span>
                                            </div>
                                        </div>

                                        <div>
                                            <h3
                                                class="text-xl font-bold text-gray-900 dark:text-white mb-1 tracking-tight">
                                                3 Aylık Gelecek Tahmini</h3>
                                            <p
                                                class="text-sm text-gray-500 dark:text-gray-400 font-medium leading-relaxed max-w-[80%]">
                                                Yapay zeka ile nakit akışını ve finansal geleceğini şimdiden gör.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. SQUARE WIDGET: Inflation Simulator -->
                                <div onclick="window.PortfolioSimulator.openModal()"
                                    class="col-span-1 aspect-square group relative overflow-hidden rounded-[32px] bg-white dark:bg-[#1c1c1e] p-5 shadow-[0_20px_40px_-12px_rgba(0,0,0,0.08)] hover:shadow-[0_25px_50px_-12px_rgba(244,63,94,0.15)] transition-all duration-300 border border-white/40 dark:border-white/5 cursor-pointer active:scale-[0.96] flex flex-col justify-between">

                                    <div
                                        class="absolute top-0 right-0 w-32 h-32 bg-rose-500/5 rounded-full blur-2xl -mr-8 -mt-8 group-hover:bg-rose-500/10 transition-colors">
                                    </div>

                                    <div
                                        class="w-12 h-12 rounded-2xl bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-xl shadow-lg shadow-rose-500/20 text-white group-hover:scale-110 transition-transform duration-300 relative z-10">
                                        📈
                                    </div>

                                    <div class="relative z-10">
                                        <h4
                                            class="text-[15px] font-bold text-gray-900 dark:text-white mb-0.5 leading-tight">
                                            Enflasyon Simülatörü</h4>
                                        <p
                                            class="text-[11px] text-gray-500 dark:text-gray-400 font-medium line-clamp-2">
                                            Paranın değer kaybını hesapla</p>
                                    </div>
                                </div>

                                <!-- 3. SQUARE WIDGET: Expense Intelligence -->
                                <div onclick="window.ExpenseAnalyzer.openModal()"
                                    class="col-span-1 aspect-square group relative overflow-hidden rounded-[32px] bg-white dark:bg-[#1c1c1e] p-5 shadow-[0_20px_40px_-12px_rgba(0,0,0,0.08)] hover:shadow-[0_25px_50px_-12px_rgba(16,185,129,0.15)] transition-all duration-300 border border-white/40 dark:border-white/5 cursor-pointer active:scale-[0.96] flex flex-col justify-between">

                                    <div
                                        class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/5 rounded-full blur-2xl -mr-8 -mt-8 group-hover:bg-emerald-500/10 transition-colors">
                                    </div>

                                    <div
                                        class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-xl shadow-lg shadow-emerald-500/20 text-white group-hover:scale-110 transition-transform duration-300 relative z-10">
                                        📊
                                    </div>

                                    <div class="relative z-10">
                                        <h4
                                            class="text-[15px] font-bold text-gray-900 dark:text-white mb-0.5 leading-tight">
                                            Harcama Zekası</h4>
                                        <p
                                            class="text-[11px] text-gray-500 dark:text-gray-400 font-medium line-clamp-2">
                                            Detaylı harcama analizi</p>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- TAB 4: INSTALLMENTS (Taksitler) -->
                        <div id="autopilot-tab-installments" class="space-y-5 hidden animate-fb-entry pb-24">

                            <!-- Taksitler Header Card -->
                            <div class="fb-hero relative overflow-hidden group">
                                <div class="absolute inset-0 bg-gradient-to-br from-indigo-600 to-blue-600 opacity-90">
                                </div>

                                <div class="relative z-10 flex flex-col p-1 gap-5">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <div
                                                class="w-12 h-12 rounded-2xl bg-white/20 backdrop-blur-md flex items-center justify-center text-2xl border border-white/20">
                                                💳
                                            </div>
                                            <div>
                                                <p
                                                    class="text-xs font-bold text-indigo-100 uppercase tracking-wide mb-1">
                                                    Toplam Aylık Taksit</p>
                                                <p id="fb-installment-total"
                                                    class="text-3xl font-black text-white tracking-tight flex items-baseline gap-1">
                                                    0 ₺</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex gap-3 w-full">
                                        <button onclick="window.openInstallmentModal()"
                                            class="flex-1 flex items-center justify-center gap-2 px-4 py-3.5 rounded-xl bg-white/20 hover:bg-white/30 text-white text-xs font-bold backdrop-blur-sm transition-all active:scale-95 border border-white/10">
                                            <span>+ Taksit Ekle</span>
                                        </button>
                                        <button onclick="window.openCreditModal()"
                                            class="flex-1 flex items-center justify-center gap-2 px-4 py-3.5 rounded-xl bg-white/20 hover:bg-white/30 text-white text-xs font-bold backdrop-blur-sm transition-all active:scale-95 border border-white/10">
                                            <span>🏦 Kredi Ödemesi</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Taksit Özeti (Horizontal Scroll or Summary) -->
                            <div id="fb-installment-summary" class="w-full">
                                <!-- JS ile doldurulacak -->
                            </div>

                            <!-- Taksitler Listesi -->
                            <div class="fb-glass-card overflow-hidden">
                                <div class="p-5 border-b border-gray-100 dark:border-white/5 flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500">
                                        📅
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900 dark:text-white">Aktif Taksitler</h3>
                                        <p class="text-xs text-gray-500">Ödeme planını takip et</p>
                                    </div>
                                </div>

                                <div id="fb-installments-list" class="divide-y divide-gray-100 dark:divide-white/5">
                                    <!-- Empty State -->
                                    <div id="fb-installments-empty"
                                        class="flex flex-col items-center justify-center py-12 text-center p-6">
                                        <div
                                            class="w-16 h-16 rounded-full bg-gray-50 dark:bg-white/5 flex items-center justify-center text-3xl mb-4 border border-gray-100 dark:border-white/10">
                                            💳
                                        </div>
                                        <p class="text-sm font-bold text-gray-900 dark:text-white mb-2">Henüz Taksit Yok
                                        </p>
                                        <p
                                            class="text-xs text-gray-500 dark:text-gray-400 mb-6 max-w-[240px] leading-relaxed mx-auto">
                                            Kredi kartı taksitlerinizi veya borç ödemelerinizi buradan takip edin.
                                        </p>
                                        <button onclick="window.openInstallmentModal()"
                                            class="px-6 py-3 rounded-xl bg-gray-900 dark:bg-white text-white dark:text-black text-xs font-bold shadow-lg hover:scale-105 transition-transform">
                                            + Taksit Ekle
                                        </button>
                                    </div>
                                    <!-- Items injected by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- TAB 4: AI ASSISTAN (Chatbot) - Enhanced V2 -->
                        <div id="autopilot-tab-assistant"
                            class="hidden animate-fade-in flex flex-col h-[calc(100vh-200px)] min-h-[450px]">

                            <!-- Clean Chat Header -->
                            <div class="fb-chat-header mb-3">
                                <div class="fb-chat-avatar">
                                    <span>🧠</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <h3 class="text-base font-bold text-gray-900 dark:text-white truncate">
                                            Fingo Brain
                                        </h3>
                                        <span
                                            class="px-1.5 py-0.5 rounded-md bg-indigo-100 text-indigo-600 dark:bg-indigo-500/20 dark:text-indigo-300 text-[10px] font-bold uppercase tracking-wide">AI</span>
                                    </div>
                                    <div class="fb-chat-status mt-0.5">
                                        <span class="fb-chat-status-dot"></span>
                                        <span
                                            class="text-gray-500 dark:text-gray-400 font-medium text-xs">Çevrimiçi</span>
                                    </div>
                                </div>
                                <button onclick="window.FingoBrain.clearChat()"
                                    class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-gray-400 transition-colors"
                                    title="Sohbeti Temizle">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- MINI FINANCE INDICATORS - Tappable Stats -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- Clean Chips -->
                            <div class="fb-chips">
                                <button onclick="window.sendLocalBrainRequest('Bu ayki gelirlerim nasıl?')"
                                    class="fb-chip fb-chip--emerald">
                                    💰 Gelir Durumu
                                </button>
                                <button onclick="window.sendLocalBrainRequest('Bu ayki giderlerim ne kadar?')"
                                    class="fb-chip fb-chip--orange">
                                    📉 Gider Analizi
                                </button>
                                <button onclick="window.sendLocalBrainRequest('Net durumum nasıl?')"
                                    class="fb-chip fb-chip--indigo">
                                    📊 Net Bakiye
                                </button>
                            </div>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- PROACTIVE AI TIP - Contextual Suggestions -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <div id="fb-proactive-tip" class="hidden shrink-0 mb-3 animate-slide-up">
                                <div
                                    class="relative p-3 rounded-2xl bg-gradient-to-r from-amber-50 via-orange-50 to-yellow-50 dark:from-amber-500/10 dark:via-orange-500/10 dark:to-yellow-500/10 border border-amber-200/50 dark:border-amber-500/20 overflow-hidden">
                                    <!-- Decorative Elements -->
                                    <div class="absolute top-0 right-0 w-16 h-16 bg-amber-400/10 rounded-full blur-xl">
                                    </div>
                                    <div
                                        class="absolute -bottom-4 -left-4 w-12 h-12 bg-orange-400/10 rounded-full blur-lg">
                                    </div>

                                    <div class="relative flex items-start gap-3">
                                        <div
                                            class="w-8 h-8 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shrink-0 shadow-md shadow-amber-500/30">
                                            <span class="text-sm">💡</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p
                                                class="text-[10px] font-bold text-amber-700 dark:text-amber-400 uppercase tracking-wide mb-1">
                                                Fingo öneriyor</p>
                                            <p id="fb-proactive-text"
                                                class="text-xs text-gray-700 dark:text-gray-300 leading-relaxed line-clamp-2">
                                                Bugün için bir öneri yok.</p>
                                        </div>
                                        <button onclick="window.dismissProactiveTip()"
                                            class="p-1.5 rounded-lg hover:bg-white/50 dark:hover:bg-white/10 transition-colors shrink-0">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="flex gap-2 mt-3">
                                        <button onclick="window.acceptProactiveTip()"
                                            class="flex-1 py-2 px-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white text-[11px] font-bold shadow-md shadow-amber-500/30 hover:shadow-lg hover:scale-[1.02] active:scale-95 transition-all">
                                            ✨ Detaylı Gör
                                        </button>
                                        <button onclick="window.dismissProactiveTip()"
                                            class="py-2 px-3 rounded-xl bg-white/50 dark:bg-white/10 text-gray-600 dark:text-gray-400 text-[11px] font-medium hover:bg-white/80 dark:hover:bg-white/20 transition-colors">
                                            Şimdi Değil
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- DAILY CHALLENGE - Gamification Widget -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <div id="fb-daily-challenge" class="hidden shrink-0 mb-3 animate-fade-in">
                                <div
                                    class="relative p-3 rounded-2xl bg-gradient-to-br from-violet-50 via-purple-50 to-fuchsia-50 dark:from-violet-500/10 dark:via-purple-500/10 dark:to-fuchsia-500/10 border border-violet-200/50 dark:border-violet-500/20 overflow-hidden">
                                    <!-- Shine Effect -->
                                    <div
                                        class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full animate-shimmer">
                                    </div>

                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <div
                                                    class="w-7 h-7 rounded-lg bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center shadow-md shadow-violet-500/30">
                                                    <span class="text-xs">🏆</span>
                                                </div>
                                                <div>
                                                    <p
                                                        class="text-[10px] font-bold text-violet-700 dark:text-violet-400 uppercase tracking-wide">
                                                        Günün Challenge'ı</p>
                                                    <p id="fb-challenge-title"
                                                        class="text-xs font-bold text-gray-900 dark:text-white">
                                                        Yükleniyor...</p>
                                                </div>
                                            </div>
                                            <div
                                                class="flex items-center gap-1 px-2 py-1 rounded-full bg-violet-100 dark:bg-violet-500/20">
                                                <span class="text-[10px]">⭐</span>
                                                <span id="fb-challenge-xp"
                                                    class="text-[10px] font-bold text-violet-700 dark:text-violet-400">+50
                                                    XP</span>
                                            </div>
                                        </div>

                                        <!-- Progress Bar -->
                                        <div
                                            class="relative h-2 rounded-full bg-violet-100 dark:bg-violet-500/20 overflow-hidden mb-2">
                                            <div id="fb-challenge-progress"
                                                class="absolute inset-y-0 left-0 bg-gradient-to-r from-violet-500 to-purple-500 rounded-full transition-all duration-500"
                                                style="width: 0%"></div>
                                        </div>

                                        <div class="flex items-center justify-between">
                                            <p id="fb-challenge-status"
                                                class="text-[10px] text-gray-500 dark:text-gray-400">
                                                Henüz başlamadı</p>
                                            <button onclick="window.checkChallengeProgress()"
                                                class="text-[10px] font-bold text-violet-600 dark:text-violet-400 hover:underline">
                                                İlerlemeyi Kontrol Et →
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- SMART CONTEXT CARDS - Dynamic Suggestions -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <div id="fb-context-cards" class="hidden shrink-0 mb-2">
                                <div class="flex items-center justify-between mb-2 px-1">
                                    <span id="fb-context-title"
                                        class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">🎯
                                        Şimdi Sor</span>
                                    <button onclick="window.refreshContextCards()"
                                        class="p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10 transition-colors">
                                        <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                                <div id="fb-context-grid" class="grid grid-cols-2 gap-2">
                                    <!-- Dynamic cards injected by JS -->
                                </div>
                            </div>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- CONVERSATION MODE SELECTOR -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <div id="fb-mode-selector" class="shrink-0 mb-2">
                                <div
                                    class="flex items-center gap-1.5 p-1 rounded-2xl bg-gray-100/80 dark:bg-white/5 border border-gray-200/50 dark:border-white/10">
                                    <button onclick="window.setFingoMode('friend')" id="fb-mode-friend"
                                        class="fb-mode-btn active flex-1 flex items-center justify-center gap-1.5 py-2 px-3 rounded-xl text-[10px] font-bold transition-all duration-200">
                                        <span>😊</span>
                                        <span>Arkadaş</span>
                                    </button>
                                    <button onclick="window.setFingoMode('analyst')" id="fb-mode-analyst"
                                        class="fb-mode-btn flex-1 flex items-center justify-center gap-1.5 py-2 px-3 rounded-xl text-[10px] font-bold transition-all duration-200">
                                        <span>📊</span>
                                        <span>Analist</span>
                                    </button>
                                    <button onclick="window.setFingoMode('coach')" id="fb-mode-coach"
                                        class="fb-mode-btn flex-1 flex items-center justify-center gap-1.5 py-2 px-3 rounded-xl text-[10px] font-bold transition-all duration-200">
                                        <span>🎯</span>
                                        <span>Koç</span>
                                    </button>
                                    <button onclick="window.setFingoMode('teacher')" id="fb-mode-teacher"
                                        class="fb-mode-btn flex-1 flex items-center justify-center gap-1.5 py-2 px-3 rounded-xl text-[10px] font-bold transition-all duration-200">
                                        <span>📚</span>
                                        <span>Öğretmen</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Messages Area -->
                            <div id="fingo-chat-messages"
                                class="flex-1 overflow-y-auto space-y-4 px-2 pb-4 scrollbar-hide">
                                <!-- Welcome Message - Enhanced -->
                                <div class="flex gap-3 animate-fade-in pl-1">
                                    <div
                                        class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center text-sm shrink-0 shadow-md shadow-indigo-500/20 text-white">
                                        🧠
                                    </div>
                                    <div class="flex-1 max-w-[85%]">
                                        <div class="fb-message-v2 fb-message-ai-v2 rounded-tl-sm">
                                            <p class="mb-3 font-medium">Merhaba! 👋 Ben Fingo Brain, yapay zeka destekli
                                                finansal asistanın.</p>
                                            <p class="text-[13px] opacity-80 mb-3">Sana nasıl yardımcı olabilirim?</p>
                                            <div class="grid grid-cols-1 gap-2 text-[12px]">
                                                <button onclick="window.sendLocalBrainRequest('Durumum nasıl?')"
                                                    class="flex items-center gap-2 p-2 rounded-lg bg-white/50 dark:bg-white/5 hover:bg-white/80 dark:hover:bg-white/10 transition-colors text-left">
                                                    <span class="text-base">💰</span>
                                                    <span class="text-gray-700 dark:text-gray-300">"Durumum
                                                        nasıl?"</span>
                                                </button>
                                                <button
                                                    onclick="window.sendLocalBrainRequest('Market harcamam ne kadar?')"
                                                    class="flex items-center gap-2 p-2 rounded-lg bg-white/50 dark:bg-white/5 hover:bg-white/80 dark:hover:bg-white/10 transition-colors text-left">
                                                    <span class="text-base">📊</span>
                                                    <span class="text-gray-700 dark:text-gray-300">"Market
                                                        harcamam?"</span>
                                                </button>
                                                <button onclick="window.sendLocalBrainRequest('Tavsiye ver')"
                                                    class="flex items-center gap-2 p-2 rounded-lg bg-white/50 dark:bg-white/5 hover:bg-white/80 dark:hover:bg-white/10 transition-colors text-left">
                                                    <span class="text-base">💡</span>
                                                    <span class="text-gray-700 dark:text-gray-300">"Tavsiye ver"</span>
                                                </button>
                                            </div>
                                        </div>
                                        <span class="text-[9px] text-gray-400 ml-1 mt-1 block font-medium">Şimdi</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Typing Indicator -->
                            <div id="fingo-typing-indicator" class="hidden mb-4 shrink-0 pl-12 animate-fade-in">
                                <div
                                    class="fb-typing-v2 inline-flex items-center rounded-2xl rounded-tl-sm px-4 py-3 gap-2 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-500/10 dark:to-purple-500/10 border border-indigo-100/50 dark:border-indigo-500/20">
                                    <span class="fb-typing-dot-v2"></span>
                                    <span class="fb-typing-dot-v2" style="animation-delay: 0.15s"></span>
                                    <span class="fb-typing-dot-v2" style="animation-delay: 0.3s"></span>
                                    <span
                                        class="text-[10px] text-indigo-500 dark:text-indigo-400 font-medium ml-1">Yazıyor...</span>
                                </div>
                            </div>

                            <!-- Enhanced Input Area -->
                            <div class="shrink-0 pt-2 pb-2">
                                <div
                                    class="fb-chat-input-wrap-v2 mb-3 flex items-center gap-2 p-2 rounded-2xl bg-white dark:bg-[#1c1c1e] border border-gray-200/50 dark:border-white/10 shadow-lg shadow-indigo-500/5">
                                    <!-- Mic Button -->
                                    <button onclick="window.startVoiceInput()" id="fb-voice-btn"
                                        class="p-2.5 rounded-xl bg-gray-100 dark:bg-white/5 hover:bg-indigo-100 dark:hover:bg-indigo-500/20 transition-all duration-200 hover:scale-105 active:scale-95"
                                        title="Sesli Giriş">
                                        <svg class="w-5 h-5 text-gray-400 dark:text-gray-500" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                        </svg>
                                    </button>

                                    <!-- Input Field -->
                                    <div class="flex-1 relative">
                                        <input type="text" id="fingo-chat-input" placeholder="Bir şeyler yaz..."
                                            class="fb-chat-input-v2 w-full py-3 px-4 rounded-xl bg-gray-50 dark:bg-white/5 border-0 focus:ring-2 focus:ring-indigo-500/20 outline-none text-sm font-medium text-gray-800 dark:text-white placeholder-gray-400"
                                            onkeypress="if(event.key === 'Enter') window.sendLocalBrainRequest()"
                                            oninput="document.getElementById('chat-char-count').textContent = this.value.length + '/200'"
                                            maxlength="200">
                                        <span id="chat-char-count"
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-gray-400 font-medium">0/200</span>
                                    </div>

                                    <!-- Send Button -->
                                    <button onclick="window.sendLocalBrainRequest()"
                                        class="fb-send-btn-v2 p-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 shadow-lg shadow-indigo-500/30 transition-all duration-200 hover:scale-105 active:scale-95">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Enhanced Quick Action Chips -->
                                <div id="chat-suggestions" class="flex gap-2 overflow-x-auto pb-4 px-1 scrollbar-hide">
                                    <button onclick="window.sendLocalBrainRequest('Durumum nasıl?')"
                                        class="fb-chip-v2 fb-chip-v2--indigo shrink-0">
                                        💰 Durumum
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('En çok ne harcadım?')"
                                        class="fb-chip-v2 fb-chip-v2--purple shrink-0">
                                        🎯 En Çok
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('Aboneliklerim')"
                                        class="fb-chip-v2 fb-chip-v2--orange shrink-0">
                                        🔄 Abonelikler
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('Tavsiye ver')"
                                        class="fb-chip-v2 fb-chip-v2--emerald shrink-0">
                                        💡 Tavsiye
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('Ay sonu tahminim?')"
                                        class="fb-chip-v2 fb-chip-v2--cyan shrink-0">
                                        🔮 Ay Sonu
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('Hedeflerim nasıl?')"
                                        class="fb-chip-v2 fb-chip-v2--rose shrink-0">
                                        🎯 Hedefler
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('Geçen ayla karşılaştır')"
                                        class="fb-chip-v2 fb-chip-v2--amber shrink-0">
                                        📊 Karşılaştır
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('Bütçe önerisi')"
                                        class="fb-chip-v2 fb-chip-v2--teal shrink-0">
                                        📋 Bütçe
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('Harcamalarımı analiz et')"
                                        class="fb-chip-v2 fb-chip-v2--indigo shrink-0">
                                        🚀 AI Analiz
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('Portföyümü simüle et')"
                                        class="fb-chip-v2 fb-chip-v2--emerald shrink-0">
                                        📈 Simülasyon
                                    </button>
                                    <button onclick="window.sendLocalBrainRequest('3 ay sonra ne olur?')"
                                        class="fb-chip-v2 fb-chip-v2--cyan shrink-0">
                                        🔮 3 Ay Tahmin
                                    </button>
                                </div>
                            </div>
                        </div>



                    </div>
                </div>

                <div id="screen-add" class="hidden screen-transition w-full pb-40">
                    <div class="mx-2 px-4 py-4 mb-4 bg-gradient-to-r from-gray-100/80 via-white/60 to-gray-100/80 dark:from-white/5 dark:via-white/10 dark:to-white/5 backdrop-blur-sm border border-gray-200/30 dark:border-white/10"
                        style="border-radius: 32px; overflow: hidden;">
                        <h3 class="text-3xl font-black text-gray-800 dark:text-white flex items-center gap-2">
                            Yeni İşlem <span class="text-2xl animate-bounce">✨</span>
                        </h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-medium ml-1">Finansal
                            yolculuğuna bir veri
                            daha ekle.</p>
                    </div>

                    <div class="mb-6 animate-fade-in px-1">
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="window.triggerOCR()"
                                class="relative group overflow-hidden rounded-2xl p-4 bg-gradient-to-br from-indigo-50 to-white dark:from-white/5 dark:to-white/10 border border-indigo-100 dark:border-white/10 shadow-sm hover:shadow-indigo-500/20 transition-all duration-300 active:scale-95">
                                <div
                                    class="absolute top-0 right-0 p-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                    <div class="bg-indigo-600 text-white text-[8px] font-bold px-2 py-0.5 rounded-full">
                                        PRO
                                    </div>
                                </div>
                                <div class="flex flex-col items-center gap-2 relative z-10">
                                    <span
                                        class="text-3xl filter drop-shadow-md group-hover:scale-110 transition-transform duration-300">📸</span>
                                    <span class="text-xs font-bold text-indigo-900 dark:text-indigo-200">Fiş
                                        Tara</span>
                                </div>
                                <div
                                    class="absolute inset-0 bg-indigo-500/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                </div>
                            </button>

                            <button onclick="window.triggerVoiceInput()" id="btn-voice-input"
                                class="relative group overflow-hidden rounded-2xl p-4 bg-gradient-to-br from-purple-50 to-white dark:from-white/5 dark:to-white/10 border border-purple-100 dark:border-white/10 shadow-sm hover:shadow-purple-500/20 transition-all duration-300 active:scale-95">
                                <div
                                    class="absolute top-0 right-0 p-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                    <div class="bg-purple-600 text-white text-[8px] font-bold px-2 py-0.5 rounded-full">
                                        PRO
                                    </div>
                                </div>
                                <div class="flex flex-col items-center gap-2 relative z-10">
                                    <span
                                        class="text-3xl filter drop-shadow-md group-hover:scale-110 transition-transform duration-300">🎙️</span>
                                    <span class="text-xs font-bold text-purple-900 dark:text-purple-200"
                                        id="btn-voice-text">Sesle
                                        Ekle</span>
                                </div>
                                <div
                                    class="absolute inset-0 bg-purple-500/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                </div>
                            </button>
                        </div>

                        <div id="ocr-status"
                            class="hidden mt-4 p-3 bg-white/80 dark:bg-black/40 rounded-xl border border-indigo-100 dark:border-indigo-500/30 backdrop-blur-md animate-slide-up">
                            <div class="flex items-center space-x-3">
                                <div class="relative w-8 h-8">
                                    <svg class="animate-spin w-full h-full text-indigo-600"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4">
                                        </circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between mb-1">
                                        <span
                                            class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider">AI
                                            Analizi</span>
                                        <span id="ocr-progress" class="text-[10px] font-bold text-gray-500">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden">
                                        <div id="ocr-bar"
                                            class="bg-indigo-600 h-1.5 rounded-full transition-all duration-300"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="file" id="ocr-input" accept="image/*" class="hidden"
                        onchange="window.processOCR(this)">

                    <div
                        class="relative overflow-hidden p-1 rounded-t-[40px] rounded-b-[32px] bg-gradient-to-b from-gray-50/90 via-white/95 to-white dark:from-gray-900/90 dark:via-gray-900/95 dark:to-gray-900 shadow-[0_-8px_30px_rgba(0,0,0,0.06)] dark:shadow-[0_-8px_30px_rgba(0,0,0,0.3)] border border-gray-200/50 dark:border-white/10 backdrop-blur-xl">

                        <div class="flex gap-4 mb-6 mx-4 mt-6 relative z-10">
                            <!-- Gider Kutucuğu -->
                            <button type="button" id="btn-type-expense" onclick="window.setTransactionType('expense')"
                                class="flex-1 relative z-20 py-4 rounded-2xl text-sm font-black shadow-lg transition-all duration-300 flex flex-col items-center justify-center gap-2 group ring-2 ring-red-500/20 bg-white dark:bg-gray-900 text-red-500 shadow-red-500/20">
                                <span
                                    class="text-2xl group-hover:scale-110 transition-transform filter drop-shadow-sm">💸</span>
                                <span>Gider</span>
                                <div
                                    class="absolute inset-0 bg-red-500/5 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity">
                                </div>
                            </button>

                            <!-- Gelir Kutucuğu -->
                            <button type="button" id="btn-type-income" onclick="window.setTransactionType('income')"
                                class="flex-1 relative z-20 py-4 rounded-2xl text-sm font-bold text-gray-500 dark:text-gray-400 transition-all duration-300 flex flex-col items-center justify-center gap-2 hover:bg-white/40 dark:hover:bg-white/5 bg-gray-100/50 dark:bg-black/20">
                                <span
                                    class="text-2xl grayscale opacity-70 group-hover:grayscale-0 group-hover:opacity-100 transition-all">💰</span>
                                <span>Gelir</span>
                            </button>
                        </div>

                        <div class="px-6 pb-8 space-y-6">

                            <div class="relative group">
                                <label
                                    class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-4 group-focus-within:text-indigo-500 transition-colors">Tutar</label>
                                <div
                                    class="relative flex items-center transition-transform duration-300 group-focus-within:scale-[1.02]">
                                    <div class="absolute left-0 pl-4 h-full flex items-center">
                                        <select id="input-currency" onchange="window.updateCurrencyPreview()"
                                            class="bg-transparent text-gray-500 dark:text-gray-300 font-black text-sm appearance-none outline-none cursor-pointer pr-6 py-2 hover:text-indigo-600 transition-colors border-none focus:ring-0 focus:outline-none focus:border-none ring-0 shadow-none !border-0"
                                            style="border: none !important; outline: none !important; box-shadow: none !important; -webkit-appearance: none; appearance: none;">
                                            <option value="TRY">TRY</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                        </select>
                                        <div class="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none">
                                            <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <input type="text" inputmode="decimal" id="input-amount"
                                        oninput="window.formatCurrencyInput(this); window.updateCurrencyPreview()"
                                        placeholder="0,00"
                                        class="w-full pl-36 pr-4 py-5 rounded-3xl text-3xl font-black bg-gray-50 dark:bg-white/5 border-2 border-transparent focus:border-indigo-500/30 focus:bg-white dark:focus:bg-black/40 outline-none transition-all placeholder-gray-300 text-gray-800 dark:text-white"
                                        style="padding-left: 140px !important;">
                                </div>
                                <div id="currency-hint"
                                    class="hidden text-right mt-2 text-xs font-bold text-indigo-500 animate-pulse">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-5 gap-3">

                                <div class="sm:col-span-2 group">
                                    <label
                                        class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-2">Tarih</label>
                                    <div class="relative">
                                        <div
                                            class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                                </path>
                                            </svg>
                                        </div>

                                        <input type="date" id="input-date"
                                            class="w-full pl-4 pr-10 py-4 h-[52px] rounded-2xl text-sm font-bold bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5 focus:ring-2 focus:ring-indigo-500/20 outline-none appearance-none transition-all text-left text-gray-800 dark:text-white cursor-pointer placeholder-gray-400">
                                    </div>
                                </div>

                                <div class="sm:col-span-3 group">
                                    <label
                                        class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-2">Kategori</label>
                                    <div class="relative">
                                        <select id="input-category" onchange="window.checkInvestmentInput()"
                                            class="w-full pl-4 pr-10 py-4 h-[52px] rounded-2xl text-sm font-bold bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5 focus:ring-2 focus:ring-indigo-500/20 outline-none appearance-none transition-all text-gray-800 dark:text-white cursor-pointer truncate">
                                        </select>
                                        <div
                                            class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="sub-category-chips" class="hidden subchip-rail no-scrollbar">
                            </div>

                            <div id="investment-input-group" class="hidden animate-slide-up">
                                <div
                                    class="p-4 bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/30 rounded-2xl">
                                    <label
                                        class="block text-[10px] font-bold text-yellow-600 dark:text-yellow-500 uppercase tracking-widest mb-1">Miktar
                                        / Adet</label>
                                    <input type="number" inputmode="decimal" id="input-investment-qty"
                                        placeholder="Örn: 5 Gram, 100 Dolar..."
                                        class="w-full bg-white dark:bg-black/20 border border-yellow-200 dark:border-yellow-800 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-yellow-500/20 outline-none">
                                </div>
                            </div>

                            <div class="group">
                                <label
                                    class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-4 group-focus-within:text-purple-500 transition-colors">Not
                                    / Açıklama</label>
                                <div class="relative">
                                    <div
                                        class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-purple-500 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                            </path>
                                        </svg>
                                    </div>
                                    <input type="text" id="input-desc" placeholder="Detay ekle (Opsiyonel)"
                                        class="w-full pl-14 pr-4 py-4 rounded-2xl text-sm font-medium bg-gray-50 dark:bg-white/5 border border-transparent focus:bg-white dark:focus:bg-black/40 focus:border-purple-500/30 outline-none transition-all text-gray-800 dark:text-white placeholder-gray-400"
                                        style="padding-left: 60px !important;">
                                </div>
                            </div>

                            <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-4 space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <label for="input-recurring"
                                            class="text-xs font-bold text-gray-700 dark:text-gray-300 cursor-pointer">Her
                                            ay
                                            tekrarla</label>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="input-recurring"
                                            onchange="window.toggleRecurringOptions()" class="hidden peer"
                                            style="display: none;">
                                        <div
                                            class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                    </label>
                                </div>
                                <div id="recurring-options" class="hidden pl-10 animate-fade-in">
                                    <select id="input-recurring-day"
                                        class="w-full bg-white dark:bg-black/20 border border-gray-200 dark:border-white/10 rounded-lg py-2 px-3 text-xs font-bold outline-none">
                                    </select>
                                </div>

                                <div id="savings-options"
                                    class="hidden flex items-center justify-between border-t border-gray-200 dark:border-white/10 pt-3 mt-2">
                                    <div class="flex items-center gap-2">
                                        <div
                                            class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center text-xs">
                                            🛡️</div>
                                        <div class="flex flex-col">
                                            <label for="input-exclude-balance"
                                                class="text-xs font-bold text-gray-700 dark:text-gray-300 cursor-pointer">Bakiyeden
                                                Düşme</label>
                                            <span class="text-[8px] text-gray-400">Net nakit etkilenmez, varlık
                                                artar.</span>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="input-exclude-balance" class="sr-only peer">
                                        <div
                                            class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-500">
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="pt-2 flex flex-col gap-3">
                                <button onclick="window.cancelEdit()" id="cancel-edit-btn"
                                    class="hidden w-full py-3 rounded-2xl bg-gray-200 dark:bg-gray-700 text-gray-600 font-bold text-sm hover:bg-gray-300 transition-colors">Düzenlemeyi
                                    İptal Et</button>

                                <button onclick="window.saveTransaction()" id="save-btn"
                                    class="w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black text-lg shadow-xl shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2 group">
                                    <span>Kaydet</span>
                                    <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                            d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                    </svg>
                                </button>
                            </div>

                            <div id="transaction-feedback" class="hidden animate-slide-up">
                                <div
                                    class="p-4 rounded-2xl bg-emerald-50 dark:bg-emerald-900/10 border border-emerald-100 dark:border-emerald-800/30 flex items-start gap-3">
                                    <div class="text-xl animate-bounce">🎉</div>
                                    <div>
                                        <h4 class="font-bold text-emerald-700 dark:text-emerald-400 text-sm">
                                            İşlem Başarılı!
                                        </h4>
                                        <p id="feedback-text"
                                            class="text-xs text-emerald-600 dark:text-emerald-300 mt-0.5">
                                            Verilerin güncellendi.</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </main>

            <!-- NAV BAR - iOS 26 Liquid Glass -->
            <div id="nav-wrapper" class="fixed bottom-6 z-[100]">
                <nav class="glass-card-strong rounded-[28px] px-3 py-3 flex justify-between items-center relative"
                    id="main-nav">

                    <!-- Liquid Glass Blob (Aktif Tab Indicator) -->
                    <div id="nav-liquid-blob" class="nav-liquid-blob"
                        style="width: 60px; top: 50%; transform: translateY(-50%);"></div>

                    <!-- Dashboard - Modern Home Icon -->
                    <button onclick="window.switchTab('dashboard')" id="nav-dashboard" aria-label="Ana Sayfa"
                        class="nav-item active flex items-center justify-center w-14 h-14 transition-all duration-300 rounded-2xl relative z-10">
                        <div class="nav-icon-box w-12 h-12 rounded-xl flex items-center justify-center"
                            style="background: transparent;">
                            <svg class="w-7 h-7" style="color: var(--text-secondary);" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.8">
                                <path
                                    d="M9 21V13.6C9 13.0399 9 12.7599 9.10899 12.546C9.20487 12.3578 9.35785 12.2049 9.54601 12.109C9.75993 12 10.0399 12 10.6 12H13.4C13.9601 12 14.2401 12 14.454 12.109C14.6422 12.2049 14.7951 12.3578 14.891 12.546C15 12.7599 15 13.0399 15 13.6V21M2 9.5L11.04 2.72C11.3843 2.46181 11.5564 2.33271 11.7454 2.28294C11.9123 2.23902 12.0877 2.23902 12.2546 2.28294C12.4436 2.33271 12.6157 2.46181 12.96 2.72L22 9.5M4 8V17.8C4 18.9201 4 19.4802 4.21799 19.908C4.40974 20.2843 4.7157 20.5903 5.09202 20.782C5.51985 21 6.0799 21 7.2 21H16.8C17.9201 21 18.4802 21 18.908 20.782C19.2843 20.5903 19.5903 20.2843 19.782 19.908C20 19.4802 20 18.9201 20 17.8V8L12.96 2.72C12.6157 2.46181 12.4436 2.33271 12.2546 2.28294C12.0877 2.23902 11.9123 2.23902 11.7454 2.28294C11.5564 2.33271 11.3843 2.46181 11.04 2.72L4 8Z"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </button>

                    <!-- Notlar - Documents Icon -->
                    <button onclick="window.switchTab('notes')" id="nav-notes" aria-label="Notlarım"
                        class="nav-item flex items-center justify-center w-14 h-14 transition-all duration-300 rounded-2xl relative z-10">
                        <div class="nav-icon-box w-12 h-12 rounded-xl flex items-center justify-center"
                            style="background: transparent;">
                            <svg class="w-7 h-7" style="color: var(--text-secondary);" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.8">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M14 2v6h6" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M16 13H8" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M16 17H8" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M10 9H8" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </button>

                    <!-- Ortadaki Ekle Butonu - Premium 3D Floating -->
                    <button onclick="window.switchTab('add')" id="nav-add" aria-label="Yeni İşlem Ekle"
                        class="flex items-center justify-center -mt-8 active:scale-90 transition-all duration-300 relative z-20">
                        <div class="w-16 h-16 rounded-full text-white flex items-center justify-center relative overflow-hidden group"
                            style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); 
                               box-shadow: 0 8px 30px var(--accent-glow), 0 0 60px rgba(99, 102, 241, 0.3);
                               transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);">
                            <div class="absolute inset-0 shimmer opacity-40"></div>
                            <!-- Inner glow ring -->
                            <div class="absolute inset-1 rounded-full border border-white/30"></div>
                            <svg class="w-7 h-7 relative z-10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <path d="M12 5V19M5 12H19" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </button>

                    <!-- Döviz - Currency Exchange Icon -->
                    <button onclick="window.switchTab('doviz')" id="nav-doviz" aria-label="Döviz ve Altın Kurları"
                        class="nav-item flex items-center justify-center w-14 h-14 transition-all duration-300 rounded-2xl relative z-10">
                        <div class="nav-icon-box w-12 h-12 rounded-xl flex items-center justify-center"
                            style="background: transparent;">
                            <svg class="w-7 h-7" style="color: var(--text-secondary);" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.8">
                                <path
                                    d="M6 6L8.5 3.5M8.5 3.5L6 1M8.5 3.5H6C3.79086 3.5 2 5.29086 2 7.5M18 18L15.5 20.5M15.5 20.5L18 23M15.5 20.5H18C20.2091 20.5 22 18.7091 22 16.5M22 7.5C22 4.46243 19.5376 2 16.5 2C13.4624 2 11 4.46243 11 7.5C11 10.5376 13.4624 13 16.5 13C19.5376 13 22 10.5376 22 7.5ZM13 16.5C13 13.4624 10.5376 11 7.5 11C4.46243 11 2 13.4624 2 16.5C2 19.5376 4.46243 22 7.5 22C10.5376 22 13 19.5376 13 16.5Z"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </button>

                    <!-- Autopilot (Premium) - AI Robot Icon -->
                    <button onclick="window.switchTab('wallet')" id="nav-wallet" aria-label="Fingo Brain AI Asistan"
                        class="nav-item flex items-center justify-center w-14 h-14 transition-all duration-300 rounded-2xl relative z-10">
                        <div class="nav-icon-box w-12 h-12 rounded-xl flex items-center justify-center relative overflow-visible"
                            style="background: transparent;">
                            <svg class="w-7 h-7" style="color: var(--text-secondary);" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.8">
                                <path
                                    d="M12 2V4M12 2C9.79086 2 8 3.79086 8 6V7M12 2C14.2091 2 16 3.79086 16 6V7M4 14H20M4 14V17C4 19.2091 5.79086 21 8 21H16C18.2091 21 20 19.2091 20 17V14M4 14V11C4 8.79086 5.79086 7 8 7H16C18.2091 7 20 8.79086 20 11V14M9 11H9.01M15 11H15.01M9 17.5C9.5 18 10.5 18.5 12 18.5C13.5 18.5 14.5 18 15 17.5"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <!-- Premium Crown Badge -->
                            <span id="nav-wallet-crown"
                                class="absolute top-0 right-0 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-lg z-30 pointer-events-none"
                                style="background: linear-gradient(135deg, #f59e0b, #ea580c); animation: crownPulse 2s ease-in-out infinite;">
                                👑
                            </span>
                        </div>
                    </button>
                </nav>

            </div>
        </div>

        <!-- OPAK MODAL YÜZEYİ CSS (iOS Sheet Style) -->
        <style>
            /* OPAK MODAL YÜZEYİ (iOS sheet gibi solid arka plan) */
            .modal-surface-opaque {
                background: linear-gradient(180deg, rgba(255, 255, 255, 1) 0%, rgba(248, 250, 252, 1) 100%) !important;
                border: 1px solid rgba(15, 23, 42, 0.08) !important;
                box-shadow: 0 30px 80px -20px rgba(0, 0, 0, 0.22) !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            html.dark .modal-surface-opaque,
            .dark .modal-surface-opaque {
                background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%) !important;
                border: 1px solid rgba(255, 255, 255, 0.08) !important;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6) !important;
            }

            /* Modal içi kartlar için opak yüzey */
            .modal-inner-card-opaque {
                background: rgba(255, 255, 255, 1) !important;
                border: 1px solid rgba(0, 0, 0, 0.05) !important;
            }

            html.dark .modal-inner-card-opaque,
            .dark .modal-inner-card-opaque {
                background: rgba(15, 23, 42, 1) !important;
                border: 1px solid rgba(255, 255, 255, 0.08) !important;
            }
        </style>

        <!-- MODALS (Kullanıcı Arayüzü Modalları) -->

        <!-- Varlık Dağılımı Detay Modalı -->
        <!-- VARLIK DAĞILIMI DETAY MODALI (PREMIUM GLASS REDESIGN) -->
        <div id="savings-detail-modal"
            class="fixed inset-0 z-[120] hidden flex items-center justify-center perspective-1000">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/30 dark:bg-black/55 backdrop-blur-sm transition-all duration-500"
                onclick="window.closeSavingsDetail()"></div>

            <!-- Main Card (OPAK iOS Sheet) -->
            <div
                class="modal-surface-opaque relative w-full max-w-lg rounded-[40px] ring-1 ring-black/5 dark:ring-white/10 transform transition-all duration-500 scale-100 opacity-100 animate-modal-enter m-4 overflow-hidden">

                <!-- Background Effects -->
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 pointer-events-none">
                </div>
                <div
                    class="absolute -top-32 -right-32 w-64 h-64 bg-indigo-500/20 rounded-full blur-3xl opacity-60 pointer-events-none">
                </div>
                <div
                    class="absolute -bottom-32 -left-32 w-64 h-64 bg-purple-500/20 rounded-full blur-3xl opacity-60 pointer-events-none">
                </div>

                <!-- Header -->
                <div class="relative z-10 p-6 pb-2 flex justify-between items-center">
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 dark:text-white tracking-tight">Varlık
                            Dağılımı</h3>
                        <p
                            class="text-slate-500 dark:text-slate-400 text-[11px] font-bold tracking-widest mt-1 uppercase opacity-80">
                            NET DEĞER ANALİZİ</p>
                    </div>
                    <!-- Close Button -->
                    <button onclick="window.closeSavingsDetail()"
                        class="w-9 h-9 rounded-full bg-white/60 dark:bg-slate-800/80 text-slate-600 dark:text-slate-300 border border-black/10 dark:border-white/10 hover:bg-red-500/10 dark:hover:bg-red-500/20 hover:text-red-500 dark:hover:text-red-400 transition-all duration-200 flex items-center justify-center backdrop-blur-md">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Content Area -->
                <div class="relative z-10 px-6 py-4">
                    <!-- Chart Container -->
                    <div class="relative w-full h-64 flex justify-center items-center mb-8 asset-donut-wrap">
                        <!-- Chart Canvas -->
                        <canvas id="savingsChart"
                            class="relative z-10 max-h-full drop-shadow-2xl asset-donut-canvas"></canvas>

                        <!-- Center Text (Clean & Premium) -->
                        <div
                            class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-20">
                            <div id="savings-center-text" class="text-center transform scale-110">
                                <span
                                    class="block text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-[0.2em] mb-1">TOPLAM</span>
                                <span
                                    class="block text-3xl font-black text-slate-900 dark:text-white tracking-tight drop-shadow-sm dark:drop-shadow-[0_0_12px_rgba(99,102,241,0.35)]">0₺</span>
                            </div>
                        </div>
                    </div>

                    <!-- Scrollable List -->
                    <div class="max-h-[320px] overflow-y-auto custom-scroll pr-2 -mr-2 space-y-3 pb-6">
                        <div id="savings-assets-list" class="space-y-3">
                            <!-- JS will populate list here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legacy Notes Modal Removed - Clean code -->

        <!-- Kart Ekleme Modalı (YENİ) -->
        <div id="add-card-modal"
            class="fixed inset-0 z-[130] hidden flex items-center justify-center modal-overlay px-4 bg-black/80 backdrop-blur-md">
            <div
                class="glass-card w-full max-w-sm p-6 rounded-[32px] relative overflow-hidden flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h3 class="text-xl font-black text-gray-900 dark:text-white">Cüzdana Ekle</h3>
                    <button onclick="window.closeAddCardModal()"
                        class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:text-red-500">✕</button>
                </div>

                <div id="card-preview"
                    class="mb-6 relative h-48 w-full rounded-2xl bg-neutral-900 p-6 shadow-2xl flex flex-col justify-between text-white shrink-0 border border-white/10">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-xs">
                        Önizleme
                        Yükleniyor...</div>
                </div>

                <div class="space-y-3 flex-1 overflow-y-auto custom-scroll pr-1 pb-2">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="card-bank-name" placeholder="Banka (Örn: Enpara)"
                            class="modern-input w-full p-3 rounded-xl text-sm font-bold"
                            oninput="window.updateCardPreview()">
                        <select id="card-network" class="modern-input w-full p-3 rounded-xl text-sm"
                            onchange="window.updateCardPreview()">
                            <option value="mastercard">Mastercard</option>
                            <option value="visa">Visa</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <select id="card-type" class="modern-input w-full p-3 rounded-xl text-sm"
                            onchange="window.updateCardPreview()">
                            <option value="credit">Kredi Kartı</option>
                            <option value="debit">Banka Kartı</option>
                        </select>
                        <select id="card-color-theme" class="modern-input w-full p-3 rounded-xl text-sm"
                            onchange="window.updateCardPreview()">
                            <option value="black">⚫ Siyah (Standart)</option>
                            <option value="blue">🔵 Safir (Standart)</option>
                            <option value="gold">👑 Gold (Premium)</option>
                            <option value="metal">⚙️ Metal (Premium)</option>
                            <option value="neon">🟣 Cyberpunk (Pro)</option>
                        </select>
                    </div>

                    <input type="text" id="card-holder" placeholder="Kart Üzerindeki İsim"
                        class="modern-input w-full p-3 rounded-xl text-sm uppercase"
                        oninput="window.updateCardPreview()">

                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="card-last4" maxlength="4" placeholder="Son 4 Hane"
                            class="modern-input w-full p-3 rounded-xl text-sm text-center font-mono"
                            oninput="window.updateCardPreview()">
                        <input type="text" id="card-expiry" placeholder="AA/YY"
                            class="modern-input w-full p-3 rounded-xl text-sm text-center font-mono"
                            oninput="window.updateCardPreview()">
                    </div>

                    <div
                        class="p-3 bg-gray-50 dark:bg-white/5 rounded-xl border border-gray-100 dark:border-white/5 space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 ml-1 mb-1 uppercase">Toplam
                                    Limit</label>
                                <input type="text" inputmode="decimal" id="card-limit" placeholder="0"
                                    oninput="window.formatCurrencyInput(this)"
                                    class="modern-input w-full p-2.5 rounded-lg text-sm font-bold text-center">
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-gray-500 ml-1 mb-1 uppercase text-red-400">Güncel
                                    Borç</label>
                                <input type="text" inputmode="decimal" id="card-debt" placeholder="0"
                                    oninput="window.formatCurrencyInput(this)"
                                    class="modern-input w-full p-2.5 rounded-lg text-sm font-bold text-center text-red-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 ml-1 mb-1 uppercase">Hesap
                                Kesim
                                Günü</label>
                            <select id="card-cutoff"
                                class="modern-input w-full p-2 rounded-lg text-xs font-bold text-center">
                                <option value="1">Her ayın 1'i</option>
                                <option value="5">Her ayın 5'i</option>
                                <option value="10">Her ayın 10'u</option>
                                <option value="15">Her ayın 15'i</option>
                                <option value="20">Her ayın 20'si</option>
                                <option value="25">Her ayın 25'i</option>
                                <option value="30">Her ayın 30'u</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button onclick="window.saveNewCard()"
                    class="w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black shadow-lg shadow-indigo-500/30 hover:scale-[1.02] transition-all mt-4 shrink-0">
                    KARTI OLUŞTUR 💳
                </button>
            </div>
        </div>

        <!-- Hedef Kumbarasına Para Ekleme Modalı -->
        <div id="add-funds-modal"
            class="fixed inset-0 z-[120] hidden flex items-center justify-center modal-overlay px-4 bg-black/50 backdrop-blur-sm">
            <div class="glass-card w-full max-w-sm p-6 rounded-[32px]">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Para Ekle</h3>
                <p id="add-funds-goal-title" class="text-sm text-gray-500 mb-4">Hedefe eklenecek tutar:</p>
                <input type="text" inputmode="decimal" id="add-funds-amount" placeholder="Tutar (₺)"
                    oninput="window.formatCurrencyInput(this)"
                    class="modern-input w-full p-3 rounded-xl mb-3 text-sm placeholder-gray-500 text-gray-900">

                <!-- Mevcut birikimi ekle (Add Funds) -->
                <div class="mt-3 space-y-2 mb-4">
                    <button type="button" id="btn-import-existing-savings-addfunds"
                        onclick="window.importSavingsToAddFunds()"
                        class="w-full px-4 py-2 rounded-xl text-sm font-semibold border border-white/20 bg-white/10 hover:bg-white/15 transition dark:text-white text-gray-700">
                        💎 Mevcut Birikimimi Ekle
                    </button>

                    <div id="add-funds-indexed-hint"
                        class="hidden px-3 py-2 rounded-xl text-xs border border-white/15 bg-white/5 text-gray-700 dark:text-gray-200">
                        <!-- JS dolduracak: INDEXED ise "Kur endeksli eklenecek" gibi -->
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="document.getElementById('add-funds-modal').classList.add('hidden')"
                        class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 font-bold">İptal</button>
                    <button onclick="window.submitAddFunds()"
                        class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold">Ekle</button>
                </div>
            </div>
        </div>
        <!-- Onay/Silme Modalı (Custom Alert) -->
        <div id="confirm-modal"
            class="fixed inset-0 z-[120] hidden flex items-center justify-center modal-overlay px-4 bg-black/50 backdrop-blur-sm">
            <div class="glass-card w-full max-w-sm p-6 rounded-[32px] text-center">
                <div id="confirm-modal-icon"
                    class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    ⚠️</div>
                <h3 id="confirm-modal-title" class="text-xl font-bold mb-2 dark:text-white">Emin misin?</h3>
                <p id="confirm-modal-message" class="text-sm text-gray-500 mb-6">Bu işlem geri alınamaz.</p>
                <div class="flex space-x-2">
                    <button id="confirm-modal-cancel-btn"
                        class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 font-bold">Vazgeç</button>
                    <button id="confirm-modal-btn" class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold">Evet,
                        Sil</button>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- DÖVİZ ÇEVİRİCİ MODALI -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div id="currency-converter-modal"
            class="fixed inset-0 z-[130] hidden flex items-center justify-center px-4 bg-black/60 backdrop-blur-md">
            <div
                class="glass-card w-full max-w-md rounded-[32px] overflow-hidden border border-white/10 dark:border-white/5 shadow-2xl">
                <!-- Header -->
                <div class="relative bg-gradient-to-r from-emerald-500 to-teal-600 p-5 text-white">
                    <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-5">
                    </div>
                    <div class="relative z-10 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">💱</span>
                            <div>
                                <h3 class="text-lg font-black">Döviz Çevirici</h3>
                                <p class="text-[10px] text-white/70 font-medium">Anlık kurlarla hesapla</p>
                            </div>
                        </div>
                        <button onclick="window.closeCurrencyModal()"
                            class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-5 space-y-4 bg-white dark:bg-gray-900">
                    <!-- Amount Input -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1.5 block">Tutar</label>
                        <input type="text" inputmode="decimal" id="modal-currency-amount" placeholder="0.00"
                            value="1000" oninput="window.formatCurrencyInput(this)"
                            class="w-full p-4 rounded-2xl text-lg font-bold text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800 border-2 border-transparent focus:border-emerald-500 outline-none transition">
                    </div>

                    <!-- Currency Select -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label
                                class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1.5 block">Kaynak</label>
                            <select id="modal-currency-from"
                                class="w-full p-3 rounded-xl font-bold text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800 border-2 border-transparent focus:border-emerald-500 outline-none">
                                <option value="TRY">🇹🇷 TRY</option>
                                <option value="USD">🇺🇸 USD</option>
                                <option value="EUR">🇪🇺 EUR</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1.5 block">Hedef</label>
                            <select id="modal-currency-to"
                                class="w-full p-3 rounded-xl font-bold text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800 border-2 border-transparent focus:border-emerald-500 outline-none">
                                <option value="USD">🇺🇸 USD</option>
                                <option value="EUR">🇪🇺 EUR</option>
                                <option value="TRY">🇹🇷 TRY</option>
                            </select>
                        </div>
                    </div>

                    <!-- Result -->
                    <div
                        class="bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 rounded-2xl p-4 border border-emerald-100 dark:border-emerald-500/20">
                        <p class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase mb-1">
                            Sonuç</p>
                        <p id="modal-currency-result" class="text-2xl font-black text-gray-900 dark:text-white">
                            0.00</p>
                    </div>

                    <!-- Calculate Button -->
                    <button onclick="window.calculateModalCurrency()"
                        class="w-full py-4 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-bold text-sm shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/50 transition-all duration-300 hover:scale-[1.02]">
                        Hesapla
                    </button>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- KREDİ HESAPLAMA MODALI -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div id="loan-calculator-modal"
            class="fixed inset-0 z-[130] hidden flex items-center justify-center px-4 bg-black/60 backdrop-blur-md">
            <div
                class="glass-card w-full max-w-md rounded-[32px] overflow-hidden border border-white/10 dark:border-white/5 shadow-2xl">
                <!-- Header -->
                <div class="relative bg-gradient-to-r from-indigo-500 to-purple-600 p-5 text-white">
                    <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-5">
                    </div>
                    <div class="relative z-10 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">🏦</span>
                            <div>
                                <h3 class="text-lg font-black">Kredi Hesaplama</h3>
                                <p class="text-[10px] text-white/70 font-medium">Aylık taksit planı oluştur</p>
                            </div>
                        </div>
                        <button onclick="window.closeLoanModal()"
                            class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-5 space-y-4 bg-white dark:bg-gray-900">
                    <!-- Principal Input -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1.5 block">Kredi
                            Tutarı
                            (₺)</label>
                        <!-- type="text" ile binlik ayırıcı formatı -->
                        <input type="text" id="modal-loan-principal" placeholder="100.000" value="100.000"
                            oninput="this.value = this.value.replace(/[^\d]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, '.')"
                            class="w-full p-4 rounded-2xl text-lg font-bold text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800 border-2 border-transparent focus:border-indigo-500 outline-none transition">
                    </div>

                    <!-- Rate & Term -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1.5 block">Faiz
                                Oranı
                                (%)</label>
                            <input type="number" id="modal-loan-rate" placeholder="3.5" value="3.5" step="0.1"
                                class="w-full p-3 rounded-xl font-bold text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800 border-2 border-transparent focus:border-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1.5 block">Vade
                                (Ay)</label>
                            <input type="number" id="modal-loan-term" placeholder="12" value="12"
                                class="w-full p-3 rounded-xl font-bold text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800 border-2 border-transparent focus:border-indigo-500 outline-none">
                        </div>
                    </div>

                    <!-- Results -->
                    <div
                        class="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-2xl p-4 border border-indigo-100 dark:border-indigo-500/20 space-y-3">
                        <div class="flex justify-between items-center">
                            <p class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase">
                                Aylık Taksit
                            </p>
                            <p id="modal-loan-monthly" class="text-xl font-black text-gray-900 dark:text-white">
                                0 ₺</p>
                        </div>
                        <div class="h-[1px] bg-indigo-200 dark:bg-indigo-500/30"></div>
                        <div class="flex justify-between items-center">
                            <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400">Toplam Ödeme</p>
                            <p id="modal-loan-total" class="text-sm font-bold text-gray-700 dark:text-gray-300">
                                0 ₺</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400">Toplam Faiz</p>
                            <p id="modal-loan-interest" class="text-sm font-bold text-rose-500">0 ₺</p>
                        </div>
                    </div>

                    <!-- Calculate Button -->
                    <button onclick="window.calculateModalLoan()"
                        class="w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold text-sm shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 transition-all duration-300 hover:scale-[1.02]">
                        Hesapla
                    </button>
                </div>
            </div>
        </div>

        <!-- Yeni Hedef Ekleme Modalı -->
        <div id="add-goal-modal"
            class="fixed inset-0 z-[110] hidden flex items-center justify-center modal-overlay px-4 bg-black/50 backdrop-blur-sm">
            <div class="glass-card w-full max-w-sm p-6 rounded-[32px]">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Yeni Hedef</h3>
                <input type="text" id="goal-title" placeholder="Hedef Adı (örn: Araba)"
                    class="modern-input w-full p-3 rounded-xl mb-3 text-sm placeholder-gray-500 text-gray-900">
                <input type="text" inputmode="decimal" id="goal-target" placeholder="Hedef Tutar (₺)"
                    oninput="window.formatCurrencyInput(this)"
                    class="modern-input w-full p-3 rounded-xl mb-3 text-sm placeholder-gray-500 text-gray-900">

                <!-- Mevcut Birikim (TL) - TRY modunda görünür -->
                <input type="text" inputmode="decimal" id="goal-current" placeholder="Mevcut Birikim (₺)"
                    oninput="window.formatCurrencyInput(this)"
                    class="modern-input w-full p-3 rounded-xl mb-3 text-sm placeholder-gray-500 text-gray-900">

                <!-- Endeks Tipi Seçimi -->
                <select id="goal-index-type" onchange="window.handleGoalIndexTypeChange()"
                    class="modern-input w-full p-3 rounded-xl mb-3 text-sm text-gray-900 dark:text-white bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                    <option value="TRY">🇹🇷 TL (Sabit)</option>
                    <option value="USD">🇺🇸 Dolar (USD)</option>
                    <option value="EUR">🇪🇺 Euro (EUR)</option>
                    <option value="GRAM">🥇 Gram Altın</option>
                    <option value="QUARTER">🪙 Çeyrek Altın</option>
                </select>

                <!-- Endeksli Miktar Input - indexType !== TRY ise görünür -->
                <input type="text" inputmode="decimal" id="goal-index-amount" placeholder="Mevcut Birikim (USD)"
                    oninput="window.formatCurrencyInput(this)"
                    class="modern-input w-full p-3 rounded-xl mb-3 text-sm placeholder-gray-500 text-gray-900 hidden">

                <!-- Mevcut Birikimden Aktar Butonu -->
                <button id="btn-import-existing-savings" onclick="window.importSavingsToGoal()"
                    class="w-full py-2.5 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 text-xs font-bold mb-3 transition-colors border border-indigo-100 dark:border-indigo-800/50 flex items-center justify-center gap-2">
                    <span>✨</span> Mevcut birikimimden aktar
                </button>

                <!-- Kur Bilgisi Hint -->
                <p id="goal-index-hint" class="text-[10px] text-gray-500 dark:text-gray-400 mb-4 text-center hidden">
                    Kur endeksli: USD/TRY 34.52 • Değer kurla değişir
                </p>

                <div class="flex space-x-2">
                    <button onclick="window.toggleGoalModal(false)"
                        class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 font-bold">İptal</button>
                    <button onclick="window.saveGoal()"
                        class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold">Ekle</button>
                </div>
            </div>
        </div>

        <!-- Profil ve Ayarlar Modalı (MOBILE-FIRST RESPONSIVE) -->
        <div id="profile-modal"
            class="fixed inset-0 z-[110] hidden flex items-center justify-center modal-overlay px-2 md:px-4 bg-black/50 backdrop-blur-sm">
            <!-- Modal Container: Mobilde %95 genişlik, desktop'ta max-w-sm -->
            <div
                class="glass-card w-[95%] md:w-full md:max-w-sm rounded-2xl md:rounded-[32px] relative overflow-hidden max-h-[90vh] md:max-h-[85vh] flex flex-col my-4">

                <!-- Header (Fixed) - Mobilde kompakt padding -->
                <div
                    class="relative z-10 flex flex-col items-center p-4 md:p-6 pb-3 md:pb-4 border-b border-gray-100 dark:border-white/10 shrink-0">
                    <!-- Kapatma butonu - Mobilde daha büyük dokunma alanı -->
                    <button onclick="window.toggleProfileModal(false)"
                        class="profile-close-btn absolute top-3 right-3 md:top-4 md:right-4 w-10 h-10 md:w-8 md:h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:text-red-500 transition text-lg md:text-base">✕</button>

                    <!-- Avatar ve Başlık - Mobilde daha küçük -->
                    <div
                        class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 shadow-xl flex items-center justify-center text-white text-2xl md:text-3xl font-bold mb-2 md:mb-3 border-4 border-white dark:border-[#1C1C1E] overflow-hidden">
                        <div id="modal-profile-avatar" class="w-full h-full flex items-center justify-center">P
                        </div>
                    </div>
                    <h3 class="text-lg md:text-xl font-bold dark:text-white">Kullanıcı Profili</h3>
                </div>

                <!-- SEKME BUTONLARI - Mobilde kompakt -->
                <div class="px-3 md:px-5 py-2 md:py-3 shrink-0">
                    <div
                        class="flex justify-between items-center gap-1 p-1 md:p-1.5 bg-gray-100/50 dark:bg-gray-800/50 rounded-xl md:rounded-2xl backdrop-blur-sm">
                        <button id="tab-info" onclick="window.switchProfileTab('info')"
                            class="tab-btn active flex-1 py-2.5 md:py-3 rounded-lg md:rounded-xl text-xs md:text-sm font-bold text-gray-600 dark:text-gray-300 transition-all">
                            <span>👤 Profil</span>
                        </button>
                        <button id="tab-settings" onclick="window.switchProfileTab('settings')"
                            class="tab-btn flex-1 py-2.5 md:py-3 rounded-lg md:rounded-xl text-xs md:text-sm font-bold text-gray-600 dark:text-gray-300 transition-all">
                            <span>⚙️ Ayarlar</span>
                        </button>
                        <button id="tab-data" onclick="window.switchProfileTab('data')"
                            class="tab-btn flex-1 py-2.5 md:py-3 rounded-lg md:rounded-xl text-xs md:text-sm font-bold text-gray-600 dark:text-gray-300 transition-all">
                            <span>💾 Veri</span>
                        </button>
                    </div>
                </div>

                <!-- SEKME İÇERİKLERİ (Scrollable) - Mobilde az padding -->
                <div class="flex-1 overflow-y-auto custom-scroll px-3 md:px-5 pb-24 md:pb-2">
                    <div
                        class="rounded-xl md:rounded-2xl bg-white/40 dark:bg-white/5 border border-white/30 dark:border-white/10 p-3 md:p-4 space-y-4 md:space-y-5">

                        <!-- 1. PROFİL SEKME İÇERİĞİ -->
                        <div id="profile-tab-info"
                            class="space-y-4 md:space-y-5 tab-content transition-opacity duration-300">

                            <!-- Kişisel Bilgiler Section -->
                            <div class="profile-section">
                                <h4 class="profile-section-title text-sm md:text-base">👤 Kişisel Bilgiler</h4>
                                <label
                                    class="block text-[10px] md:text-xs font-bold mb-1.5 md:mb-2 text-gray-600 dark:text-gray-400">Adın</label>
                                <!-- Mobilde daha küçük padding -->
                                <input type="text" id="profile-name" placeholder="Adınız"
                                    class="modern-input w-full p-3 md:p-4 rounded-xl md:rounded-2xl text-sm"
                                    style="color: var(--text-primary); background: var(--glass-bg);">
                                <p class="profile-help text-[10px] md:text-xs">Bu isim uygulama içinde kartlarda
                                    görünecek.
                                </p>
                            </div>

                            <!-- Avatar Seçimi Section -->
                            <div class="profile-section">
                                <h4 class="profile-section-title text-sm md:text-base">🎭 Avatar Seçimi</h4>
                                <!-- Mobilde 5 sütun, kompakt gap -->
                                <div id="avatar-selection" class="grid grid-cols-5 gap-2 md:gap-3 p-1 md:p-2">
                                </div>
                                <p class="profile-help text-[10px] md:text-xs">Bir avatar seçerek profilini
                                    kişiselleştir.
                                </p>
                            </div>

                        </div>

                        <!-- 2. AYARLAR SEKME İÇERİĞİ -->
                        <div id="profile-tab-settings"
                            class="space-y-5 tab-content hidden transition-opacity duration-300">

                            <!-- Görünüm Section -->
                            <div class="profile-section">
                                <h4 class="profile-section-title">🎨 Görünüm</h4>
                                <div class="space-y-3">
                                    <button onclick="window.toggleThemeModal(true); window.toggleProfileModal(false)"
                                        class="profile-action-btn" style="color: var(--text-primary);">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg">🎨</span>
                                            <span>Temayı Değiştir</span>
                                        </div>
                                        <span class="text-gray-400">›</span>
                                    </button>
                                    <button onclick="window.handleOpenGallery()" class="profile-action-btn"
                                        style="color: var(--accent-primary);">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg">💎</span>
                                            <div class="flex flex-col items-start">
                                                <span>Rozet Koleksiyonum</span>
                                                <span class="text-[9px] font-normal opacity-70">3D Galeri ve
                                                    Ödüller</span>
                                            </div>
                                        </div>
                                        <span class="text-gray-400">›</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Veri Düzenleme Section -->
                            <div class="profile-section">
                                <h4 class="profile-section-title">📂 Veri Düzenleme</h4>
                                <div class="space-y-3">
                                    <button onclick="window.openCategoryModal(); window.toggleProfileModal(false)"
                                        class="profile-action-btn" style="color: var(--accent-primary);">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg">📂</span>
                                            <span>Kategorileri Düzenle</span>
                                        </div>
                                        <span class="text-gray-400">›</span>
                                    </button>
                                    <button onclick="window.openRecurringManager(); window.toggleProfileModal(false)"
                                        class="profile-action-btn" style="color: var(--accent-secondary);">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg">🔄</span>
                                            <span>Otomatik Talimatlarım</span>
                                        </div>
                                        <span class="text-gray-400">›</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Güvenlik Section (Enhanced) -->
                            <div class="profile-section">
                                <h4 class="profile-section-title">🛡️ Güvenlik</h4>
                                <div class="space-y-3">
                                    <button id="btn-pin-settings" onclick="window.PinManager.startSetup()"
                                        class="profile-action-btn" style="color: var(--text-secondary);">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg">🔒</span>
                                            <div class="flex flex-col items-start">
                                                <span id="lbl-pin-settings">PIN Oluştur</span>
                                                <span class="text-[9px] font-normal opacity-70">Uygulama
                                                    kilidi</span>
                                            </div>
                                        </div>
                                        <span class="text-gray-400">›</span>
                                    </button>
                                    <!-- Biometric Toggle -->
                                    <div id="bio-toggle-row"
                                        class="hidden profile-action-btn justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg">🔐</span>
                                            <div class="flex flex-col items-start">
                                                <span>FaceID / TouchID</span>
                                                <span id="lbl-biometric-status"
                                                    class="text-[9px] font-normal opacity-70">Biyometrik ile
                                                    hızlı
                                                    giriş</span>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="bio-enabled-toggle" class="sr-only peer"
                                                onchange="window.toggleBioEnabled(this.checked)">
                                            <div
                                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Premium Section (Restore) -->
                            <div class="profile-section">
                                <h4 class="profile-section-title">👑 Premium</h4>
                                <button onclick="window.IAPManager?.restore()" class="profile-action-btn"
                                    style="color: var(--accent-primary);">
                                    <div class="flex items-center gap-3">
                                        <span class="text-lg">🔄</span>
                                        <div class="flex flex-col items-start">
                                            <span>Satın Alımları Geri Yükle</span>
                                            <span class="text-[9px] font-normal opacity-70">Önceki satın
                                                alımlarınızı
                                                kurtarın</span>
                                        </div>
                                    </div>
                                    <span class="text-gray-400">›</span>
                                </button>
                            </div>

                            <!-- Senkronizasyon Durumu Section (NEW) -->
                            <div class="profile-section">
                                <h4 class="profile-section-title">🌐 Senkronizasyon</h4>
                                <div class="flex items-center justify-between p-3 rounded-xl"
                                    style="background: var(--glass-bg);">
                                    <div class="flex items-center gap-3">
                                        <div id="sync-status-dot" class="w-2 h-2 rounded-full bg-green-500">
                                        </div>
                                        <span id="sync-status-text" class="text-xs text-gray-600 dark:text-gray-400">Son
                                            kayıt: Kontrol ediliyor...</span>
                                    </div>
                                </div>
                                <p class="profile-help">Veriler cihazınızda güvenle saklanıyor.</p>
                            </div>

                            <!-- Destek & Geri Bildirim Section (NEW) -->
                            <div class="profile-section">
                                <h4 class="profile-section-title">💬 Destek & Geri Bildirim</h4>
                                <div class="space-y-3">
                                    <button onclick="window.ErrorLogger?.sendFeedback()" class="profile-action-btn"
                                        style="color: var(--accent-primary);">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg">📧</span>
                                            <span>Hata Raporu Gönder</span>
                                        </div>
                                        <span class="text-gray-400">›</span>
                                    </button>
                                    <button onclick="window.ErrorLogger?.copyLogsToClipboard()"
                                        class="profile-action-btn" style="color: var(--text-secondary);">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg">📋</span>
                                            <span>Logları Kopyala</span>
                                        </div>
                                        <span class="text-gray-400">›</span>
                                    </button>
                                </div>
                                <p class="profile-help">Sorun yaşadığınızda hata raporu göndererek bize yardımcı
                                    olun.</p>
                            </div>

                        </div>

                        <!-- 3. VERİ SEKME İÇERİĞİ -->
                        <div id="profile-tab-data" class="space-y-5 tab-content hidden transition-opacity duration-300">

                            <!-- Yedekleme Section -->
                            <div class="profile-section">
                                <h4 class="profile-section-title">💾 Yedekleme ve Dışa Aktarma</h4>
                                <div class="grid grid-cols-4 gap-2">
                                    <button
                                        onclick="window.ExportManager?.exportFullBackup() || window.downloadBackup()"
                                        class="py-3 rounded-2xl font-bold text-[10px] flex flex-col items-center justify-center gap-1.5 transition hover:scale-[1.02]"
                                        style="background: var(--glass-bg); color: var(--accent-success);">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                            </path>
                                        </svg>
                                        <span>JSON</span>
                                    </button>
                                    <button onclick="window.ExportManager?.exportCSV()"
                                        class="py-3 rounded-2xl font-bold text-[10px] flex flex-col items-center justify-center gap-1.5 transition hover:scale-[1.02]"
                                        style="background: var(--glass-bg); color: var(--accent-secondary);">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                        <span>CSV</span>
                                    </button>
                                    <button onclick="window.ExportManager?.exportXLSX()"
                                        class="py-3 rounded-2xl font-bold text-[10px] flex flex-col items-center justify-center gap-1.5 transition hover:scale-[1.02]"
                                        style="background: var(--glass-bg); color: #217346;">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        <span>Excel</span>
                                    </button>
                                    <button onclick="document.getElementById('restore-file-input').click()"
                                        class="py-3 rounded-2xl font-bold text-[10px] flex flex-col items-center justify-center gap-1.5 transition hover:scale-[1.02]"
                                        style="background: var(--glass-bg); color: var(--accent-primary);">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12">
                                            </path>
                                        </svg>
                                        <span>Yükle</span>
                                    </button>
                                    <input type="file" id="restore-file-input" class="hidden" accept=".json"
                                        onchange="window.restoreBackup(this)">
                                </div>
                                <p class="profile-help">JSON yedek, CSV/Excel dışa aktar, veya yedekten geri
                                    yükle.</p>
                            </div>

                            <!-- Tehlikeli İşlemler Section -->
                            <div class="profile-section"
                                style="background: rgba(239, 68, 68, 0.05); border-color: rgba(239, 68, 68, 0.2);">
                                <h4 class="profile-section-title" style="color: var(--accent-danger);">⚠️
                                    Tehlikeli
                                    Bölge
                                </h4>
                                <button onclick="window.requestResetApp()"
                                    class="w-full py-4 rounded-2xl border-2 font-bold text-sm transition hover:bg-red-500/10"
                                    style="border-color: var(--accent-danger); color: var(--accent-danger);">
                                    🗑️ Tüm Verileri Sıfırla
                                </button>
                                <p class="profile-help" style="color: var(--accent-danger);">Bu işlem geri
                                    alınamaz. Tüm
                                    veriler silinecek.</p>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Kaydet Butonu Footer - Mobilde kompakt -->
                <div class="shrink-0 px-3 md:px-5 pt-2 md:pt-3 bg-gradient-to-t from-white/95 via-white/80 to-transparent dark:from-[#0b0f1a]/95 dark:via-[#0b0f1a]/80 dark:to-transparent"
                    style="padding-bottom: max(12px, env(safe-area-inset-bottom));">
                    <button onclick="window.saveProfile()"
                        class="w-full py-3.5 md:py-4 px-6 md:px-10 rounded-xl md:rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold text-sm md:text-base shadow-xl shadow-blue-500/25 hover:shadow-blue-500/40 hover:scale-[1.02] transition-all">
                        ✓ Değişiklikleri Kaydet
                    </button>
                </div>
            </div>
        </div>

        <!-- Tema Seçimi Modalı -->
        <div id="theme-modal"
            class="fixed inset-0 z-[110] hidden flex items-center justify-center modal-overlay px-4 bg-black/50 backdrop-blur-sm">
            <div class="glass-card w-full max-w-sm p-6 rounded-[32px]">
                <h3 class="text-xl font-bold mb-6 dark:text-white text-center">Görünüm Seç</h3>
                <div class="space-y-3 mb-6">
                    <button onclick="window.setAppTheme('light')" id="theme-light"
                        class="theme-option w-full p-4 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-white/5 flex items-center justify-between transition-all group">
                        <div class="flex items-center space-x-4">
                            <div
                                class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-xl">
                                ☀️</div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800 dark:text-white">Aydınlık</p>
                                <p class="text-[10px] text-gray-500">Net ve ferah görünüm</p>
                            </div>
                        </div>
                        <div
                            class="w-5 h-5 rounded-full border-2 border-gray-300 group-hover:border-blue-500 flex items-center justify-center selection-ring">
                        </div>
                    </button>
                    <button onclick="window.setAppTheme('dark')" id="theme-dark"
                        class="theme-option w-full p-4 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-white/5 flex items-center justify-between transition-all group">
                        <div class="flex items-center space-x-4">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 shadow-sm flex items-center justify-center text-xl text-white">
                                🌑</div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800 dark:text-white">Karanlık</p>
                                <p class="text-[10px] text-gray-500">Göz yormayan şıklık</p>
                            </div>
                        </div>
                        <div
                            class="w-5 h-5 rounded-full border-2 border-gray-300 group-hover:border-blue-500 flex items-center justify-center selection-ring">
                        </div>
                    </button>
                    <button onclick="window.setAppTheme('system')" id="theme-system"
                        class="theme-option w-full p-4 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-white/5 flex items-center justify-between transition-all group">
                        <div class="flex items-center space-x-4">
                            <div
                                class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-200 to-gray-800 shadow-sm flex items-center justify-center text-xl">
                                🌗</div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800 dark:text-white">Otomatik</p>
                                <p class="text-[10px] text-gray-500">Cihaz ayarlarına uyum</p>
                            </div>
                        </div>
                        <div
                            class="w-5 h-5 rounded-full border-2 border-gray-300 group-hover:border-blue-500 flex items-center justify-center selection-ring">
                        </div>
                    </button>
                </div>
                <button onclick="window.toggleThemeModal(false)"
                    class="w-full py-4 rounded-2xl bg-blue-600 text-white font-bold shadow-lg hover:bg-blue-700 transition">Seçimi
                    Uygula</button>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- HİSSE DETAY MODALI - Light/Dark Mode Compatible -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div id="stock-detail-modal"
            class="fixed inset-0 z-[160] hidden flex items-center justify-center modal-overlay px-4 bg-black/60 backdrop-blur-md">
            <div
                class="glass-card w-full max-w-lg rounded-[32px] overflow-hidden flex flex-col max-h-[90vh] relative border border-gray-200 dark:border-white/10 shadow-2xl bg-white dark:bg-[#0f111a]">
                <!-- Header -->
                <div
                    class="px-6 py-5 border-b border-gray-100 dark:border-white/5 flex items-center justify-between bg-white dark:bg-[#0f111a]">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 rounded-2xl bg-gray-100 dark:bg-white/5 flex items-center justify-center text-2xl shadow-inner border border-gray-200 dark:border-white/5">
                            📈
                        </div>
                        <div>
                            <h3 id="modal-stock-symbol"
                                class="text-2xl font-black text-gray-900 dark:text-white tracking-tight">--</h3>
                            <p id="modal-stock-name" class="text-xs font-bold text-gray-400 uppercase tracking-wider">--
                            </p>
                        </div>
                    </div>
                    <button onclick="window.closeStockDetailModal()"
                        class="w-10 h-10 rounded-full bg-gray-100 dark:bg-white/5 hover:bg-gray-200 dark:hover:bg-white/10 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-white transition-all">✕</button>
                </div>

                <!-- Price & Period Section -->
                <div class="px-6 py-4 bg-white dark:bg-[#0f111a] relative z-20">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">Güncel Fiyat</p>
                            <div class="flex items-baseline gap-2">
                                <span id="modal-stock-price"
                                    class="text-4xl font-black text-gray-900 dark:text-white tracking-tight">--</span>
                                <span class="text-xs font-bold text-gray-400">TRY</span>
                            </div>
                        </div>
                        <div id="modal-stock-change-box" class="px-4 py-2 rounded-xl backdrop-blur-md">
                            <span id="modal-stock-change" class="text-lg font-bold flex items-center gap-1">--</span>
                        </div>
                    </div>

                    <!-- Period Tabs -->
                    <div class="flex items-center gap-2 p-1 bg-gray-100 dark:bg-white/5 rounded-xl">
                        <button onclick="window.changeStockPeriod('1G')" id="period-1G" data-period="1G"
                            class="stock-period-btn flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-indigo-500 text-white shadow-lg shadow-indigo-500/30">1G</button>
                        <button onclick="window.changeStockPeriod('1H')" id="period-1H" data-period="1H"
                            class="stock-period-btn flex-1 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500 dark:text-gray-400 hover:bg-white hover:shadow-sm dark:hover:bg-white/5">1H</button>
                        <button onclick="window.changeStockPeriod('1A')" id="period-1A" data-period="1A"
                            class="stock-period-btn flex-1 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500 dark:text-gray-400 hover:bg-white hover:shadow-sm dark:hover:bg-white/5">1A</button>
                        <button onclick="window.changeStockPeriod('3A')" id="period-3A" data-period="3A"
                            class="stock-period-btn flex-1 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500 dark:text-gray-400 hover:bg-white hover:shadow-sm dark:hover:bg-white/5">3A</button>
                        <button onclick="window.changeStockPeriod('1Y')" id="period-1Y" data-period="1Y"
                            class="stock-period-btn flex-1 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500 dark:text-gray-400 hover:bg-white hover:shadow-sm dark:hover:bg-white/5">1Y</button>
                    </div>
                </div>

                <!-- Chart Container -->
                <div
                    class="flex-1 bg-gray-50 dark:bg-[#0f111a] relative min-h-[300px] border-t border-b border-gray-100 dark:border-white/5">
                    <!-- Grid Lines (CSS Background) -->
                    <div class="absolute inset-0 pointer-events-none opacity-50"
                        style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px;">
                    </div>

                    <canvas id="stock-chart-canvas" class="w-full h-full relative z-10"></canvas>

                    <!-- Time Labels -->
                    <div id="stock-chart-labels"
                        class="absolute bottom-2 left-4 right-4 flex justify-between text-[9px] font-bold text-gray-400 opacity-60">
                        <span>09:00</span>
                        <span>11:00</span>
                        <span>13:00</span>
                        <span>15:00</span>
                        <span>18:00</span>
                    </div>
                </div>

                <!-- Bottom Stats Grid -->
                <div class="p-6 bg-white dark:bg-[#0f111a]">
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <div
                            class="p-3 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5">
                            <p class="text-[9px] font-bold text-gray-400 uppercase mb-1">En Yüksek</p>
                            <p id="stat-high" class="text-sm font-black text-gray-900 dark:text-white">--</p>
                        </div>
                        <div
                            class="p-3 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5">
                            <p class="text-[9px] font-bold text-gray-400 uppercase mb-1">En Düşük</p>
                            <p id="stat-low" class="text-sm font-black text-gray-900 dark:text-white">--</p>
                        </div>
                        <div
                            class="p-3 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5">
                            <p class="text-[9px] font-bold text-gray-400 uppercase mb-1">Açılış</p>
                            <p id="stat-open" class="text-sm font-black text-gray-900 dark:text-white">--</p>
                        </div>
                        <div
                            class="p-3 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5">
                            <p class="text-[9px] font-bold text-gray-400 uppercase mb-1">Hacim</p>
                            <p id="stat-vol" class="text-sm font-black text-gray-900 dark:text-white">--</p>
                        </div>
                    </div>

                    <button onclick="window.closeStockDetailModal()"
                        class="w-full mt-4 py-3 rounded-xl bg-gray-100 dark:bg-white/5 text-xs font-bold text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors">
                        Kapat
                    </button>
                </div>
            </div>
        </div>


        <!-- SMART BLUR OVERLAY (No PIN Session Lock) -->
        <div id="blur-overlay"
            class="fixed inset-0 z-[9998] hidden flex items-center justify-center cursor-pointer transition-all duration-500"
            onclick="window.dismissBlurOverlay()" ontouchstart="window.dismissBlurOverlay()">
            <!-- Background Blur Layer -->
            <div class="absolute inset-0 bg-white/10 dark:bg-black/10 backdrop-blur-[20px] safe-blur-layer"></div>

            <!-- Content -->
            <div class="relative z-10 text-center animate-pulse">
                <div
                    class="w-20 h-20 bg-white/20 dark:bg-black/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-md shadow-2xl ring-1 ring-white/30">
                    <span class="text-4xl">🔒</span>
                </div>
                <h3 class="text-2xl font-black text-gray-800 dark:text-white mb-2 drop-shadow-md">Güvenli Mod</h3>
                <p class="text-sm font-bold text-gray-600 dark:text-gray-300">Devam etmek için ekrana dokun</p>
            </div>
        </div>

        <!-- Premium/Pro Özellik Modalı - APPLE UI AWARD STYLE -->
        <div id="premium-modal"
            class="fixed inset-0 z-[200] hidden flex items-center justify-center modal-overlay px-4 bg-black/90 backdrop-blur-xl">
            <div
                class="premium-card-3d w-full max-w-sm rounded-[32px] text-center relative overflow-hidden bg-white dark:bg-[#0f0a1f] border border-gray-100 dark:border-purple-500/30 shadow-2xl">

                <!-- Animated Background Orbs (Dark Mode Only) -->
                <div
                    class="hidden dark:block absolute -top-20 -left-20 w-40 h-40 bg-purple-600/30 rounded-full blur-[80px] animate-pulse">
                </div>
                <div
                    class="hidden dark:block absolute -bottom-20 -right-20 w-48 h-48 bg-blue-600/20 rounded-full blur-[80px] animate-pulse-slow">
                </div>
                <div
                    class="hidden dark:block absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-indigo-600/10 rounded-full blur-[100px]">
                </div>

                <!-- Close Button -->
                <button onclick="document.getElementById('premium-modal').classList.add('hidden')"
                    class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full flex items-center justify-center transition hover:scale-110 bg-gray-100 dark:bg-white/10 text-gray-500 dark:text-white/60 hover:bg-gray-200 dark:hover:bg-white/20">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>

                <div class="relative z-10 p-8">
                    <!-- Animated Crown -->
                    <div
                        class="premium-crown w-24 h-24 mx-auto mb-6 rounded-[28px] flex items-center justify-center shadow-2xl bg-gradient-to-br from-indigo-500 to-blue-500 dark:from-purple-600 dark:to-indigo-600 shadow-indigo-500/30 dark:shadow-indigo-500/50">
                        <span class="text-5xl filter drop-shadow-lg">👑</span>
                    </div>

                    <!-- Title -->
                    <h3
                        class="text-3xl font-black mb-2 tracking-tight text-gray-900 dark:text-transparent dark:bg-clip-text dark:bg-gradient-to-r dark:from-white dark:to-purple-200">
                        Fingenda Pro</h3>
                    <p class="text-sm text-gray-500 dark:text-purple-300/80 mb-6">Finansal özgürlüğünün kilidini aç</p>

                    <!-- Feature List -->
                    <div class="space-y-3 mb-8 text-left">
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-50 dark:border-white/5">
                            <div
                                class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 bg-emerald-500 text-white">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span class="text-sm text-gray-700 dark:text-white/90 font-medium">Fingo Autopilot & AI
                                Koçu</span>
                        </div>
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-50 dark:border-white/5">
                            <div
                                class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 bg-emerald-500 text-white">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span class="text-sm text-gray-700 dark:text-white/90 font-medium">Sınırsız Taksit & Kredi
                                Takibi</span>
                        </div>
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-50 dark:border-white/5">
                            <div
                                class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 bg-emerald-500 text-white">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span class="text-sm text-gray-700 dark:text-white/90 font-medium">OCR Fiş Tarama & Sesli
                                Giriş</span>
                        </div>
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-50 dark:border-white/5">
                            <div
                                class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 bg-emerald-500 text-white">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span class="text-sm text-gray-700 dark:text-white/90 font-medium">Excel & PDF
                                Raporları</span>
                        </div>
                    </div>

                    <!-- Pricing Toggle -->
                    <div
                        class="pricing-toggle mx-auto w-max mb-4 bg-gray-100 p-1 rounded-xl flex gap-1 dark:bg-white/10">
                        <span
                            class="pricing-option active px-4 py-1.5 rounded-lg text-xs font-bold bg-white text-gray-900 shadow-sm cursor-pointer transition-all dark:bg-white/20 dark:text-white"
                            onclick="window.setPricingPlan('monthly')">Aylık</span>
                        <span
                            class="pricing-option px-4 py-1.5 rounded-lg text-xs font-medium text-gray-500 hover:text-gray-900 cursor-pointer transition-all dark:text-white/50 dark:hover:text-white"
                            onclick="window.setPricingPlan('yearly')">Yıllık</span>
                    </div>

                    <!-- Price Display -->
                    <div id="premium-price-display" class="mb-6">
                        <div class="flex items-baseline justify-center gap-1">
                            <span class="text-4xl font-black text-gray-900 dark:text-white">₺49</span>
                            <span class="text-gray-500 dark:text-white/50 text-sm">/ay</span>
                        </div>
                        <p class="text-[10px] text-gray-400 dark:text-purple-300/60 mt-1">7 gün ücretsiz deneme dahil
                        </p>
                    </div>

                    <!-- CTA Button -->
                    <button onclick="window.upgradeToPro()"
                        class="w-full py-4 rounded-2xl text-white font-black text-lg shadow-xl hover:scale-[1.02] transition-all transform relative overflow-hidden bg-gray-900 dark:bg-gradient-to-r dark:from-indigo-600 dark:to-purple-600">
                        <span class="relative z-10">Premium'a Geç ✨</span>
                        <div class="premium-shimmer absolute inset-0 z-0 opacity-20 dark:opacity-50"></div>
                    </button>

                    <!-- Cancel Text -->
                    <p class="text-[10px] text-gray-400 dark:text-white/30 mt-4">İstediğin zaman iptal edebilirsin</p>
                </div>
            </div>
        </div>

        <!-- Detaylı İstatistik Modalı (Premium Glass UI) -->
        <div id="detailed-stats-modal"
            class="fixed inset-0 z-[120] hidden flex items-center justify-center perspective-1000">
            <div class="absolute inset-0 bg-black/30 dark:bg-black/55 backdrop-blur-sm transition-opacity duration-500"
                onclick="window.closeDetailedStats()"></div>

            <!-- Main Card (OPAK iOS Sheet) -->
            <div
                class="modal-surface-opaque relative w-full max-w-md rounded-[40px] ring-1 ring-black/5 dark:ring-white/10 p-6 flex flex-col max-h-[90vh] transform transition-all duration-500 animate-modal-enter overflow-hidden m-4">

                <!-- Background Effects -->
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 pointer-events-none">
                </div>
                <div
                    class="absolute -top-32 -right-32 w-64 h-64 bg-indigo-500/20 rounded-full blur-3xl opacity-60 pointer-events-none">
                </div>
                <div
                    class="absolute -bottom-32 -left-32 w-64 h-64 bg-purple-500/20 rounded-full blur-3xl opacity-60 pointer-events-none">
                </div>

                <div class="flex justify-between items-center mb-6 relative z-10">
                    <div class="flex items-center gap-3">
                        <div
                            class="p-2.5 rounded-2xl bg-indigo-50 dark:bg-white/10 text-indigo-600 dark:text-white shadow-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 id="detailed-stats-title"
                                class="text-xl font-black text-slate-800 dark:text-white tracking-tight">Analiz
                            </h3>
                            <button onclick="window.openBudgetModal()"
                                class="text-[10px] font-bold text-indigo-500 dark:text-indigo-400 hover:text-indigo-600 dark:hover:text-indigo-300 transition-colors flex items-center gap-1 mt-0.5">
                                <span>Limit Ayarla</span>
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button onclick="window.closeDetailedStats()"
                        class="w-8 h-8 rounded-full bg-slate-100 dark:bg-white/10 text-slate-500 dark:text-white/70 hover:bg-slate-200 dark:hover:bg-white/20 transition-all duration-300 flex items-center justify-center backdrop-blur-md">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="relative w-full h-64 mb-6 shrink-0 z-10 flex items-center justify-center">
                    <canvas id="detailedStatsChart"
                        class="relative z-10 drop-shadow-xl dark:drop-shadow-[0_0_30px_rgba(99,102,241,0.25)]"></canvas>

                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span
                            class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-[0.2em] font-bold mb-1">TOPLAM</span>
                        <span id="chart-total-amount"
                            class="text-3xl font-black text-slate-800 dark:text-white tracking-tight">0 ₺</span>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll pr-2 relative z-10 space-y-3 pb-4"
                    id="detailed-stats-list">
                </div>
            </div>
        </div>
        </div>
        </div>

        <!-- Bütçe Limiti Belirleme Modalı -->
        <div id="budget-modal"
            class="fixed inset-0 z-[130] hidden flex items-center justify-center modal-overlay px-4 bg-black/50 backdrop-blur-sm">
            <div class="glass-card w-full max-w-sm p-6 rounded-[32px]">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Bütçe Limiti</h3>
                <p class="text-xs text-gray-500 mb-4">Kategori bazlı aylık harcama limiti belirleyin.</p>

                <label
                    class="block text-xs font-bold text-gray-400 ml-2 mb-1.5 uppercase tracking-wider">Kategori</label>
                <div class="relative mb-4">
                    <select id="budget-category"
                        class="modern-input w-full pl-4 pr-10 h-[3.5rem] rounded-2xl text-sm font-bold text-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all appearance-none bg-none"></select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>

                <label class="block text-xs font-bold text-gray-400 ml-2 mb-1.5 uppercase tracking-wider">Aylık
                    Limit
                    (₺)</label>
                <div class="relative mb-6">
                    <span
                        class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold text-lg">₺</span>
                    <input type="text" inputmode="decimal" id="budget-amount" placeholder="0.00"
                        oninput="window.formatCurrencyInput(this)"
                        class="modern-input w-full pl-10 pr-4 py-3.5 rounded-2xl text-lg font-bold">
                </div>

                <div class="flex space-x-2">
                    <button onclick="document.getElementById('budget-modal').classList.add('hidden')"
                        class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 font-bold">İptal</button>
                    <button onclick="window.saveBudget()"
                        class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold">Kaydet</button>
                </div>
            </div>
        </div>

        <!-- YENİ: Kategori Yönetimi Modalı -->
        <div id="category-modal"
            class="fixed inset-0 z-[140] hidden flex items-center justify-center modal-overlay px-4 bg-black/50 backdrop-blur-sm">
            <div class="glass-card w-full max-w-sm p-6 rounded-[32px] flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h3 class="text-xl font-bold dark:text-white">Kategorileri Düzenle</h3>
                    <button onclick="window.closeCategoryModal()"
                        class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:text-red-500 transition">✕</button>
                </div>

                <!-- Tab Seçimi -->
                <div class="grid grid-cols-2 gap-3 p-1 bg-gray-100/80 dark:bg-gray-800/80 rounded-2xl mb-4 shrink-0">
                    <button onclick="window.switchCategoryTab('expense')" id="btn-cat-tab-expense"
                        class="py-2 rounded-xl text-sm font-bold shadow-md bg-white dark:bg-gray-700 text-red-500 transition-all">Giderler</button>
                    <button onclick="window.switchCategoryTab('income')" id="btn-cat-tab-income"
                        class="py-2 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-400 transition-all">Gelirler</button>
                </div>

                <!-- Kategori Listesi -->
                <div class="flex-1 overflow-y-auto custom-scroll pr-2 mb-4 space-y-2" id="category-edit-list">
                    <!-- JS ile doldurulacak -->
                </div>

                <!-- Yeni Kategori Ekle -->
                <div class="shrink-0 pt-2 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex gap-2">
                        <input type="text" id="new-category-input" placeholder="Yeni Kategori Adı..."
                            class="modern-input flex-1 px-3 py-2 rounded-xl text-sm">
                        <button onclick="window.addCustomCategory()"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg hover:bg-indigo-700 transition">Ekle</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- YENİ: Toast Bildirim Konteyneri -->
        <div id="toast-container"
            class="fixed bottom-32 left-1/2 -translate-x-1/2 z-[200] flex flex-col-reverse space-y-reverse space-y-3 pointer-events-none items-center">
        </div>
        <div id="nft-detail-modal"
            class="fixed inset-0 z-[350] hidden flex items-center justify-center modal-overlay bg-white/95 dark:bg-black/90 backdrop-blur-xl perspective-1000">
            <button onclick="document.getElementById('nft-detail-modal').classList.add('hidden')"
                class="safe-close-btn absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-white/10 dark:text-white dark:hover:bg-white/20 flex items-center justify-center transition z-50">✕</button>

            <div class="relative flex flex-col items-center">
                <div id="3d-card-container" class="badge-3d-wrapper">
                    <div class="card-front" id="detail-card-front">
                        <div
                            class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10">
                        </div>
                        <div class="text-6xl mb-4 filter drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]" id="detail-icon">
                            🏆
                        </div>
                        <h3 class="text-xl font-black text-white tracking-widest uppercase mb-1" id="detail-title">
                            BAŞLIK
                        </h3>
                        <span
                            class="px-2 py-0.5 rounded bg-white/20 text-[10px] font-bold text-white uppercase tracking-wider"
                            id="detail-rarity">EFSANEVİ</span>

                    </div>

                    <div class="card-back" id="detail-card-back">
                        <h4 class="text-sm font-bold text-white mb-2">Başarım Detayı</h4>
                        <p class="text-xs text-gray-300 leading-relaxed font-medium" id="detail-desc">Açıklama
                        </p>
                        <div class="mt-6 pt-4 border-t border-white/10 w-full">
                            <p class="text-[10px] text-gray-400">Kazanılma Tarihi</p>
                            <p class="text-xs font-bold text-white" id="detail-date">--.--.----</p>
                        </div>
                    </div>
                </div>

                <!-- (Eski Flip uyarısı kaldırıldı) -->
            </div>
        </div>
        <!-- 2. KUTLAMA MODALI (Pop-up) - Apple Award UI Redesign -->
        <div id="badge-celebration-modal"
            class="fixed inset-0 z-[300] hidden flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-500">
            <!-- Backdrop Blur (Deep) -->
            <div class="absolute inset-0 bg-black/80 backdrop-blur-2xl" onclick="window.closeBadgeCelebrationModal()">
            </div>

            <!-- Award Card (Floating) -->
            <div id="award-card"
                class="relative z-10 w-full max-w-sm mx-6 p-1 bg-gradient-to-br from-white/10 to-white/5 rounded-[40px] shadow-2xl transform scale-90 opacity-0 transition-all duration-700 ease-out border border-white/10">
                <div class="absolute inset-0 bg-black/40 rounded-[40px] backdrop-blur-md"></div>

                <div class="relative z-20 flex flex-col items-center justify-center py-12 px-6 text-center">
                    <!-- Spotlight Effect -->
                    <div
                        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-yellow-500/20 rounded-full blur-[80px] pointer-events-none animate-pulse-slow">
                    </div>
                    <div
                        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-yellow-200/10 rounded-full blur-[40px] pointer-events-none">
                    </div>

                    <!-- Floating Badge Icon -->
                    <div id="celebration-icon"
                        class="text-8xl mb-8 filter drop-shadow-[0_20px_40px_rgba(0,0,0,0.6)] transform will-change-transform">
                        🏆
                    </div>

                    <!-- Text Content -->
                    <div class="space-y-3 relative z-30">
                        <h3 id="celebration-title" class="text-3xl font-black text-white tracking-tight drop-shadow-md">
                            Rozet Kazanıldı
                        </h3>
                        <p id="celebration-badge-name"
                            class="text-xl font-medium text-yellow-400/90 tracking-wide uppercase">
                            Kaptan
                        </p>
                        <p id="celebration-description"
                            class="text-sm font-medium text-gray-400 leading-relaxed max-w-[260px] mx-auto">
                            Tebrikler! Yeni bir başarı kilidi açıldı.
                        </p>
                    </div>

                    <!-- Action Button -->
                    <button onclick="window.closeBadgeCelebrationModal()"
                        class="mt-10 px-10 py-3.5 bg-white text-black font-bold rounded-full hover:scale-105 active:scale-95 transition-transform shadow-[0_10px_20px_rgba(255,255,255,0.15)] flex items-center gap-2">
                        <span>Devam Et</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>
                </div>

                <!-- Shimmer Border -->
                <div class="absolute inset-0 rounded-[40px] border border-white/10 pointer-events-none"></div>
            </div>
        </div>

        <!-- Badge Gallery Modal -->
        <div id="badge-gallery-modal"
            class="fixed inset-0 z-[150] hidden flex items-center justify-center modal-overlay px-4 bg-black/60 backdrop-blur-md">
            <div
                class="glass-card w-full max-w-lg p-6 rounded-[32px] flex flex-col max-h-[85vh] relative overflow-hidden">
                <div class="flex justify-between items-center mb-6 shrink-0 z-10">
                    <h3
                        class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-600 dark:from-indigo-300 dark:to-purple-300">
                        Rozet Koleksiyonum 💎</h3>
                    <button onclick="document.getElementById('badge-gallery-modal').classList.add('hidden')"
                        class="w-10 h-10 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:text-red-500 transition shadow-sm">✕</button>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll pr-2 relative z-10">
                    <div id="nft-gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 pb-4">
                        <!-- Rozetler buraya gelecek -->
                    </div>
                </div>

                <!-- Background Decoration -->
                <div
                    class="absolute top-0 right-0 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none">
                </div>
                <div
                    class="absolute bottom-0 left-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -ml-16 -mb-16 pointer-events-none">
                </div>
            </div>
        </div>

        <script>
            // Firebase SDK Modülleri (Dinamik Yükleme için Tanımlar)
            // Yerel Modda Firebase Importları Kullanılmayacak

            // === THEME MANAGER (Mobile Fix) ===
            window.initTheme = function () {
                // 1. Check LocalStorage (Support both keys for safety)
                const storedTheme = localStorage.getItem('app_theme') || localStorage.getItem('theme');

                // 2. Check System Preference
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                // 3. Determine Theme
                let theme = 'light';
                if (storedTheme === 'dark') {
                    theme = 'dark';
                } else if ((!storedTheme || storedTheme === 'system') && systemPrefersDark) {
                    theme = 'dark';
                }

                // 4. Apply Theme
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }

                // 5. Listen for changes
                try {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                        if (!localStorage.getItem('app_theme') && !localStorage.getItem('theme')) {
                            if (e.matches) {
                                document.documentElement.classList.add('dark');
                            } else {
                                document.documentElement.classList.remove('dark');
                            }
                        }
                    });
                } catch (e) { console.log('Theme listener error:', e); }

                // --- SAVINGS & INVESTMENT DETECTION (Centralized) ---
                window.isSavingsTransaction = function (t) {
                    if (!t) return false;
                    const cat = (t.category || '').toLowerCase();
                    const desc = (t.description || '').toLowerCase();

                    // 1. Kategori Bazlı Kontrol (Kesin)
                    const savingsCats = [
                        'birikim', 'tasarruf', 'yatırım', 'altın', 'döviz',
                        'hisse', 'fon', 'coin', 'kripto', 'bitcoin', 'ethereum',
                        'gümüş', 'stok', 'crypto', 'savings', 'invest', 'kumbaram'
                    ];

                    if (savingsCats.some(c => cat.includes(c))) return true;

                    // 2. Açıklama Bazlı Kontrol (Sadece belirgin yatırım kelimeleri)
                    // Dikkat: "Altın" kelimesi "Altın yüzük aldım" gibi harcamalarda da geçebilir.
                    // Bu yüzden sadece güçlü anahtar kelimeleri seçiyoruz.
                    const strongKeywords = [
                        'çeyrek altın', 'gram altın', 'tam altın', 'cumhuriyet altını', 'ata lira',
                        'dolar alım', 'euro alım', 'sterlin alım', 'döviz alım',
                        'yatırım hesabı', 'bireysel emeklilik', 'bes ödemesi', 'bes katkı',
                        'hisse senedi', 'fon alım'
                    ];

                    if (strongKeywords.some(k => desc.includes(k))) return true;

                    return false;
                };

                // 6. Avatar Kalıcılığı (Persistence) - localStorage'dan kayıtlı avatarı yükle
                // Bu kod sayfa yenilense bile seçilen avatarın korunmasını sağlar
                try {
                    const savedName = localStorage.getItem('user_name') || 'Misafir';
                    const savedTitle = localStorage.getItem('user_title') || null;
                    const savedAvatar = localStorage.getItem('user_avatar') || null;

                    // updateProfileUI fonksiyonu henüz tanımlanmamış olabilir, 
                    // bu yüzden DOM hazır olduktan sonra çağırıyoruz
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', () => {
                            if (window.updateProfileUI) {
                                window.updateProfileUI(savedName, savedTitle, savedAvatar);
                            }
                        });
                    } else {
                        // DOM zaten hazır, hemen çağır
                        setTimeout(() => {
                            if (window.updateProfileUI) {
                                window.updateProfileUI(savedName, savedTitle, savedAvatar);
                            }
                        }, 0);
                    }
                } catch (e) {
                    console.log('Avatar restore error:', e);
                }
            };

            // Run immediately
            window.initTheme();

            // ═══════════════════════════════════════════════════════════════
            // BİRİKİM İŞLEMİ KONTROL FONKSİYONU
            // Sadece KATEGORİ bazlı kontrol - açıklama kontrol EDİLMEZ
            // (telefon -> fon çakışması önlenir)
            // ═══════════════════════════════════════════════════════════════
            function isSavingsTransaction(t) {
                if (!t) return false;

                // 1. Manuel isSavings bayrağı
                if (t.isSavings === true) return true;

                // 2. SavingsMarker'da işaretlenmiş mi?
                if (window.SavingsMarker && t.id && window.SavingsMarker.markedIds && window.SavingsMarker.markedIds.has(t.id)) {
                    return true;
                }

                // 3. Sadece KATEGORİ kontrolü (açıklama DEĞİL!)
                const savingsCats = ['💵 Dolar', '💶 Euro', '🟡 Altın Gr.', '🪙 Çeyrek Altın', '💹 Yatırım', '💰 Birikim', '📈 Yatırım', 'Yatırım Fonu', 'Vadeli Mevduat'];
                const cat = t.category || '';

                for (const kw of savingsCats) {
                    if (cat.includes(kw)) return true;
                }

                return false;
            }

            // Global erişim
            window.isSavingsTransaction = isSavingsTransaction;

            // Global Uygulama Değişkenleri
            let app, db, auth, userId;
            let activeGoalId = null;
            let activeDeleteId = null;
            let activeDeleteType = null;
            window.pendingConfirmAction = null; // Custom confirm modal action
            let editingTransactionId = null;
            let userStatus = 'free'; // Açılışta AppStorage'dan hydrate edeceğiz
            window.__premiumReady = null;
            let recurringRules = [];
            let categoryBudgets = {};

            // ═══════════════════════════════════════════════════════════════
            // TEK KAYNAK PREMIUM STATE KATMANI (AppStorage + localStorage)
            // ═══════════════════════════════════════════════════════════════
            window.hydratePremiumState = async function hydratePremiumState() {
                console.log('[Premium] Hydrating premium state from AppStorage...');

                // Çift kaynak okuma: Önce AppStorage (Capacitor), fallback localStorage
                const [asUserStatus, asMembership, asPremiumFlag, asPremiumCache] = await Promise.all([
                    AppStorage.get('user_status'),
                    AppStorage.get('user_membership_status'),
                    AppStorage.get('premium'),
                    AppStorage.get('premium_cache')
                ]);

                const lsUserStatus = localStorage.getItem('user_status');
                const lsMembership = localStorage.getItem('user_membership_status');
                const lsPremiumFlag = localStorage.getItem('premium');
                const lsPremiumCache = localStorage.getItem('premium_cache');

                // Adaylar
                const candidates = [asMembership, asUserStatus, lsMembership, lsUserStatus].filter(Boolean);
                let isPro = candidates.some(v => v === 'pro' || v === 'premium');

                // premium_cache parse kontrolü (varsa)
                const cacheRaw = asPremiumCache || lsPremiumCache;
                if (!isPro && cacheRaw) {
                    try {
                        const c = JSON.parse(cacheRaw);
                        if (c && c.isPremium === true) isPro = true;
                    } catch (e) { /* ignore */ }
                }

                // premium flag kontrolü
                if (!isPro && (asPremiumFlag === 'true' || lsPremiumFlag === 'true')) {
                    isPro = true;
                }

                // Sonuçları uygula
                userStatus = isPro ? 'pro' : 'free';
                window.userStatus = userStatus;

                // PremiumManager varsa senkronla
                if (window.PremiumManager) window.PremiumManager.isPremium = isPro;

                // Storage senkron (AppStorage + localStorage)
                if (isPro) {
                    await Promise.all([
                        AppStorage.set('user_status', 'pro'),
                        AppStorage.set('user_membership_status', 'pro'),
                        AppStorage.set('premium', 'true'),
                    ]);
                    localStorage.setItem('user_status', 'pro');
                    localStorage.setItem('user_membership_status', 'pro');
                    localStorage.setItem('premium', 'true');
                }

                // UI refresh
                try { window.updateUserPlanBadge?.(); } catch (e) { }
                try { window.updateProfileUI?.(window.currentUserName, window.currentUserTitle, window.currentUserAvatar); } catch (e) { }
                try { window.refreshPremiumLocks?.(); } catch (e) { }

                // Eğer Pro ise açık kalan premium modalı kapat
                if (isPro) {
                    const pm = document.getElementById('premium-modal');
                    if (pm) pm.classList.add('hidden');
                }

                console.log('[Premium] Hydration complete:', isPro ? 'PRO 👑' : 'FREE');
                return isPro;
            };

            window.ensurePremiumReady = function ensurePremiumReady() {
                if (!window.__premiumReady) {
                    window.__premiumReady = window.hydratePremiumState().catch(() => false);
                }
                return window.__premiumReady;
            };

            // Uygulama ID'si
            let rawAppId = 'default-app-id';
            try { if (typeof __app_id !== 'undefined') rawAppId = __app_id; } catch (e) { }
            let appId = rawAppId.replace(/[^a-zA-Z0-9_-]/g, '_');


            // ═══════════════════════════════════════════════════════════════
            // INPUT FORMATLAMA YARDIMCILARI
            // ═══════════════════════════════════════════════════════════════
            window.formatCurrencyInput = function (input) {
                // Sadece sayıları bırak
                let value = input.value.replace(/[^\d]/g, '');
                // Binlik ayırıcı ekle (1.000.000)
                if (value) {
                    input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                } else {
                    input.value = '';
                }
            };

            window.parseSimpleCurrency = function (valStr) {
                if (!valStr) return 0;
                // Noktaları temizle, tüm sayıları birleştir
                const cleanStr = String(valStr).replace(/\./g, '');
                return parseFloat(cleanStr) || 0;
            };

            window.transactions = [];
            let transactions = [];
            let goals = [];
            let notes = [];
            let installments = [];
            window.currentNotesMode = 'task'; // Make global so all functions can access it
            let chartInstance = null;
            let categoryChartInstance = null;
            let detailedChartInstance = null;
            let savingsChartInstance = null;
            let currentType = 'expense';
            let isLocalMode = false;
            let marketDataLoaded = false;
            let currentChartType = 'general';
            let currentDate = new Date();
            let viewScope = 'month';
            let selectedAvatar = null;
            let chatHistory = [];
            let liveRates = { USD: 0, EUR: 0, GRAM: 0, QUARTER: 0 };
            window.liveRates = liveRates; // Modal döviz çevirici için global erişim
            // YENİ: Hisse senedi verilerini tutacak değişken
            let liveStocks = {};

            // === INDEXED SAVINGS FOR CHART ===
            window.__indexedSavingsForChart = null;

            // Kur verisi hazır mı?
            window.areLiveRatesReady = function () {
                return liveRates && (liveRates.USD > 0 || liveRates.EUR > 0 || liveRates.GRAM > 0 || liveRates.QUARTER > 0);
            };

            // Anlık kurla hesaplanmış birikim değeri (grafik için)
            window.getIndexedSavingsValue = function (data, fallbackFlowSavings) {
                if (window.areLiveRatesReady() && window.calculatePortfolio) {
                    try {
                        const portfolio = window.calculatePortfolio(data);
                        if (portfolio && typeof portfolio.totalValue === 'number' && portfolio.totalValue > 0) {
                            return portfolio.totalValue;
                        }
                    } catch (e) { console.warn('getIndexedSavingsValue error:', e); }
                }
                // Kur hazır değilse veya hesaplanamadıysa, akış değerini döndür
                return fallbackFlowSavings || 0;
            };

            // === HEDEF KUMBARASI KUR ENDEKSLİ BİRİKİM FONKSİYONLARI ===

            // Belirli bir endeks tipi için canlı kuru döndürür
            window.getIndexRate = function (type) {
                if (!window.areLiveRatesReady()) return 0;
                switch (type) {
                    case 'USD': return liveRates.USD;
                    case 'EUR': return liveRates.EUR;
                    case 'GRAM': return liveRates.GRAM;
                    case 'QUARTER': return liveRates.QUARTER;
                    default: return 1; // TRY
                }
            };

            // Bir hedefin güncel TL değerini hesaplar
            window.getGoalCurrentTL = function (goal) {
                if (goal.currentMode === 'INDEXED' && goal.indexAmount > 0) {
                    const rate = window.getIndexRate(goal.indexType);
                    if (rate > 0) return goal.indexAmount * rate;
                    return goal.lastComputedTL || goal.current || 0;
                }
                return goal.current || 0;
            };

            // Tüm hedeflerin computed değerlerini yeniler
            window.refreshGoalComputedValues = function () {
                if (!goals || goals.length === 0) return;

                goals.forEach(g => {
                    // Geriye uyumluluk: eski hedefler için varsayılan değerler
                    if (!g.currentMode) {
                        g.currentMode = 'TRY';
                        g.indexType = 'TRY';
                        g.indexAmount = 0;
                        g.lastComputedTL = g.current || 0;
                    }

                    if (g.currentMode === 'INDEXED' && g.indexAmount > 0) {
                        const rate = window.getIndexRate(g.indexType);
                        if (rate > 0) {
                            const newTL = g.indexAmount * rate;
                            g.lastDeltaTL = newTL - (g.lastComputedTL || g.current || 0);
                            g.lastComputedTL = newTL;
                            g.lastIndexRate = rate;
                        }
                    }
                });

                localStorage.setItem(`my_goals_${APP_YEAR}`, JSON.stringify(goals));
                if (window.renderGoalsList) window.renderGoalsList();
                if (window.updateDashboardGoalWidget) window.updateDashboardGoalWidget();
            };

            // Kullanıcının toplam TL birikimini hesaplar
            window.getUserTotalSavingsTL = function () {
                if (window.areLiveRatesReady() && window.calculatePortfolio) {
                    const portfolio = window.calculatePortfolio(window.transactions || []);
                    return portfolio.totalValue || 0;
                }
                return 0;
            };

            // Endeks tipi değiştiğinde modal alanlarını güncelle
            window.handleGoalIndexTypeChange = function () {
                const indexType = document.getElementById('goal-index-type').value;
                const currentInput = document.getElementById('goal-current');
                const indexAmountInput = document.getElementById('goal-index-amount');
                const hintEl = document.getElementById('goal-index-hint');

                if (indexType === 'TRY') {
                    // TL modu
                    currentInput.classList.remove('hidden');
                    indexAmountInput.classList.add('hidden');
                    hintEl.classList.add('hidden');
                } else {
                    // Endeksli mod
                    currentInput.classList.add('hidden');
                    indexAmountInput.classList.remove('hidden');
                    hintEl.classList.remove('hidden');

                    // Placeholder ve hint güncelle
                    const labels = { USD: 'USD', EUR: 'EUR', GRAM: 'Gram', QUARTER: 'Adet' };
                    const emojis = { USD: '🇺🇸', EUR: '🇪🇺', GRAM: '🥇', QUARTER: '🪙' };
                    indexAmountInput.placeholder = `Mevcut Birikim (${labels[indexType]})`;

                    const rate = window.getIndexRate(indexType);
                    if (rate > 0) {
                        hintEl.textContent = `${emojis[indexType]} Kur endeksli: ${indexType}/TRY ${rate.toFixed(2)} • Değer kurla değişir`;
                    } else {
                        hintEl.textContent = '⏳ Kur yükleniyor... Piyasa Durumu sekmesini yenileyin';
                    }
                }
            };

            // Mevcut birikimden hedefe aktar
            window.importSavingsToGoal = function () {
                const indexType = document.getElementById('goal-index-type').value;
                const totalTL = window.getUserTotalSavingsTL();

                if (totalTL <= 0) {
                    window.alertMessage('Bilgi', 'Aktarılacak birikim bulunamadı. Önce yatırım işlemi ekleyin.', 'blue');
                    return;
                }

                if (indexType === 'TRY') {
                    const currentInput = document.getElementById('goal-current');
                    currentInput.value = totalTL.toLocaleString('tr-TR', { maximumFractionDigits: 0 }).replace(/\./g, '.');
                } else {
                    const rate = window.getIndexRate(indexType);
                    if (rate <= 0) {
                        window.alertMessage('Uyarı', 'Kur yükleniyor, lütfen Piyasa Durumu sekmesini yenileyin.', 'red');
                        return;
                    }
                    const indexAmount = totalTL / rate;
                    const indexAmountInput = document.getElementById('goal-index-amount');
                    indexAmountInput.value = indexAmount.toFixed(2).replace('.', ',');
                }

                window.alertMessage('Başarılı', `Toplam ${totalTL.toLocaleString('tr-TR', { maximumFractionDigits: 0 })} ₺ birikim aktarıldı.`, 'green');
            };

            // Add Funds modalı için mevcut birikimi aktarma fonksiyonu
            window.importSavingsToAddFunds = async function () {
                try {
                    if (!activeGoalId) return;
                    const g = goals.find(x => x.id === activeGoalId);
                    if (!g) return;

                    const totalTL = window.getUserTotalSavingsTL();
                    if (!totalTL || totalTL <= 0) {
                        window.alertMessage("Bilgi", "Aktarılabilir birikim bulunamadı (kur verisi yüklenmemiş olabilir).", "orange");
                        return;
                    }

                    // inputu doldur
                    const amtInput = document.getElementById('add-funds-amount');
                    amtInput.value = window.formatCurrency ? window.formatCurrency(totalTL) : String(Math.round(totalTL));

                    // küçük bilgi kutusu (INDEXED ise kurla eklenecek)
                    const hint = document.getElementById('add-funds-indexed-hint');
                    if (hint) {
                        // Geriye uyumluluk: eski hedefler için varsayılan değerler
                        if (!g.currentMode) {
                            g.currentMode = 'TRY';
                            g.indexType = 'TRY';
                        }

                        if (g.currentMode === 'INDEXED') {
                            const rate = window.getIndexRate(g.indexType);
                            const labels = { USD: 'USD', EUR: 'EUR', GRAM: 'Gram', QUARTER: 'Adet' };
                            if (rate > 0) {
                                const units = totalTL / rate;
                                hint.classList.remove('hidden');
                                hint.textContent = `🔁 Kur endeksli eklenecek: +${units.toFixed(4)} ${labels[g.indexType]} (Kur: ${rate.toFixed(2)})`;
                            } else {
                                hint.classList.remove('hidden');
                                hint.textContent = '⏳ Kur yükleniyor. Piyasa Durumu sekmesini yenileyin.';
                            }
                        } else {
                            hint.classList.add('hidden');
                            hint.textContent = '';
                        }
                    }

                    window.toastInfo?.("Birikim tutarı eklendi. Kaydetmek için Onayla.", 1800);
                } catch (e) {
                    console.error(e);
                    window.alertMessage("Hata", "Birikim aktarılamadı.", "red");
                }
            };

            // PATCH: Tek "gerçek kaynak" finans özeti fonksiyonu - giderlerde birikimi asla sayma
            window.getFinanceSnapshot = function (scope = 'month') {
                const all = window.transactions || [];
                const now = currentDate;
                const targetMonth = now.getMonth();
                const targetYear = now.getFullYear();

                // PATCH: Scope'a göre filtre
                const filtered = all.filter(t => {
                    if (scope === 'all') return true;
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    if (scope === 'year') return tDate.getFullYear() === targetYear;
                    return tDate.getMonth() === targetMonth && tDate.getFullYear() === targetYear;
                });

                let income = 0, expense = 0, savings = 0;

                // PATCH: processTransactions ile tam aynı mantık - isSavingsTransaction kullan
                filtered.forEach(t => {
                    const val = typeof t.amount === 'number' ? t.amount : (parseFloat(t.amount) || (window.parseSimpleCurrency ? window.parseSimpleCurrency(t.amount) : 0) || 0);
                    if (t.type === 'income') {
                        income += val;
                    } else if (isSavingsTransaction(t)) {
                        savings += val; // Gider DEĞİL, birikim!
                    } else {
                        expense += val;
                    }
                });

                // PATCH: Kur endeksli birikim değeri
                const indexedSavingsTL = window.getIndexedSavingsValue ? window.getIndexedSavingsValue(filtered, savings) : savings;
                const net = income - expense;

                return { income, expense, savings, indexedSavingsTL, net, count: filtered.length, filtered };
            };

            // ═══════════════════════════════════════════════════════════════
            // TAKSİTLER & NOTLAR SİSTEMİ (ENHANCED)
            // ═══════════════════════════════════════════════════════════════

            // Taksit türünü değiştir (credit_card veya loan)
            window.setInstallmentType = function (type) {
                const creditCardBtn = document.getElementById('type-credit-card');
                const loanBtn = document.getElementById('type-loan');
                const typeInput = document.getElementById('installment-type');
                const loanRateContainer = document.getElementById('loan-rate-container');

                if (!creditCardBtn || !loanBtn || !typeInput) return;

                // Hidden input değerini güncelle
                typeInput.value = type;

                // Buton stillerini güncelle
                if (type === 'credit_card') {
                    creditCardBtn.classList.add('active');
                    loanBtn.classList.remove('active');
                    if (loanRateContainer) loanRateContainer.classList.add('hidden');
                } else {
                    loanBtn.classList.add('active');
                    creditCardBtn.classList.remove('active');
                    if (loanRateContainer) loanRateContainer.classList.remove('hidden');
                }
            };

            // Not/Taksit modunu değiştir (task veya installment)
            window.setNotesMode = function (mode) {
                window.currentNotesMode = mode;
                const btnTask = document.getElementById('btn-notes-task');
                const btnInstallment = document.getElementById('btn-notes-installment');
                const listTask = document.getElementById('notes-task-list');
                const listInstallment = document.getElementById('notes-installment-list');
                const modalBtn = document.querySelector('#screen-notes button[onclick^="window.toggleNotesModal"]');

                if (!btnTask || !btnInstallment) return;

                // Tab butonlarını güncelle
                [btnTask, btnInstallment].forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.id === `btn-notes-${mode}`) {
                        btn.classList.add('active');
                    }
                });

                // Listeleri göster/gizle
                if (mode === 'task') {
                    if (listTask) listTask.classList.remove('hidden');
                    if (listInstallment) listInstallment.classList.add('hidden');
                    if (modalBtn) modalBtn.innerText = '✍️';
                } else {
                    if (listTask) listTask.classList.add('hidden');
                    if (listInstallment) listInstallment.classList.remove('hidden');
                    if (modalBtn) modalBtn.innerText = '📅';
                }

                window.renderNotes();
            };

            // Helpers: Günü sınırla (1-31)
            function clampDay(day) {
                return Math.max(1, Math.min(31, day || new Date().getDate()));
            }

            // Notes modal'ı aç/kapat
            // Legacy toggleNotesModal removed - Now using new Notes System


            // Öncelik seçimi
            window.setTaskPriority = function (level) {
                const levels = ['low', 'medium', 'high'];
                const colors = {
                    low: { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-600 dark:text-green-400', border: 'border-green-200 dark:border-green-800' },
                    medium: { bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-600 dark:text-yellow-400', border: 'border-yellow-200 dark:border-yellow-800' },
                    high: { bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-600 dark:text-red-400', border: 'border-red-200 dark:border-red-800' }
                };

                levels.forEach(l => {
                    const btn = document.getElementById(`prio-${l}`);
                    if (btn) {
                        btn.className = `prio-btn py-2.5 rounded-xl text-xs font-bold transition `;
                        if (l === level) {
                            btn.className += `${colors[l].bg} ${colors[l].text} border ${colors[l].border}`;
                        } else {
                            btn.className += `bg-gray-50 dark:bg-white/5 text-gray-400 border border-transparent`;
                        }
                    }
                });

                const hiddenInput = document.getElementById('note-task-priority');
                if (hiddenInput) hiddenInput.value = level;
            };



            // Taksit sil
            window.deleteInstallment = async function (id) {
                const confirmed = await window.confirmDialog({
                    title: 'Taksit Sil',
                    message: 'Bu taksit planını silmek istediğinize emin misiniz?',
                    confirmText: 'Sil',
                    cancelText: 'Vazgeç',
                    variant: 'red'
                });

                if (confirmed) {
                    installments = installments.filter(i => i.id !== id);
                    localStorage.setItem(`my_installments_${APP_YEAR}`, JSON.stringify(installments));

                    // Tekrarlayan kuralı da sil
                    let rules = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');
                    rules = rules.filter(r => r.id !== 'inst_' + id);
                    localStorage.setItem(`my_recurring_rules_${APP_YEAR}`, JSON.stringify(rules));

                    window.alertMessage('Silindi', 'Taksit planı kaldırıldı.', 'blue');
                    window.renderNotes();
                }
            };
            // ==========================================
            // NEW NOTES SYSTEM IMPLEMENTATION
            // ==========================================

            // Not Modalı Aç/Kapa
            // 🛠️ UI UTILITIES (RESTORED)
            window.alertMessage = function (title, message, color) {
                // Fallback to standard alert
                alert(`${title}\n${message}`);
            };

            window.confirmDialog = function (options) {
                const title = options.title || 'Onay';
                const message = options.message || 'Emin misiniz?';
                return new Promise((resolve) => {
                    const result = confirm(`${title}\n\n${message}`);
                    resolve(result);
                });
            };

            window.toggleNotesModal = function (noteOrShow, editId = null) {
                const modal = document.getElementById('notes-modal');
                const content = document.getElementById('notes-modal-content');

                if (!modal || !content) return;

                // Determine if we should show or hide
                // If called with false, hide. Otherwise show.
                // If called with a note object, use it for editing
                let show = true;
                let editNote = null;

                if (noteOrShow === false) {
                    show = false;
                } else if (noteOrShow && typeof noteOrShow === 'object' && noteOrShow.id) {
                    // Called with a note object for editing
                    editNote = noteOrShow;
                } else if (typeof noteOrShow === 'string') {
                    // Called with editId directly
                    editId = noteOrShow;
                }

                if (show) {
                    // Reset form
                    const titleInput = document.getElementById('note-title');
                    const contentInput = document.getElementById('note-content');
                    const idInput = document.getElementById('note-edit-id');

                    if (titleInput) titleInput.value = '';
                    if (contentInput) contentInput.value = '';
                    if (idInput) idInput.value = '';
                    window.selectNoteCategory('todo');

                    // If editing with note object
                    if (editNote) {
                        if (titleInput) titleInput.value = editNote.title || '';
                        if (contentInput) contentInput.value = editNote.content || '';
                        if (idInput) idInput.value = editNote.id;
                        window.selectNoteCategory(editNote.category || 'todo');
                    }
                    // If editing with editId
                    else if (editId) {
                        let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');
                        const note = notes.find(n => n.id === editId);
                        if (note) {
                            if (titleInput) titleInput.value = note.title;
                            if (contentInput) contentInput.value = note.content;
                            if (idInput) idInput.value = note.id;
                            window.selectNoteCategory(note.category);
                        }
                    }

                    modal.style.display = 'flex';
                    modal.classList.remove('hidden');
                    // Small delay for animation
                    setTimeout(() => {
                        content.style.transform = 'translateY(0)';
                        content.classList.remove('translate-y-full');
                    }, 10);
                } else {
                    content.style.transform = 'translateY(100%)';
                    content.classList.add('translate-y-full');
                    setTimeout(() => {
                        modal.style.display = 'none';
                        modal.classList.add('hidden');
                    }, 300);
                }
            };

            window.closeNotesModal = function () {
                window.toggleNotesModal(false);
            };

            // Kategori Seçimi
            window.selectNoteCategory = function (cat) {
                document.querySelectorAll('.note-cat-btn').forEach(btn => {
                    if (btn.dataset.category === cat) {
                        btn.classList.add('ring-2', 'ring-offset-2', 'ring-gray-400');
                        btn.style.transform = 'scale(1.05)';
                    } else {
                        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400');
                        btn.style.transform = 'scale(1)';
                    }
                });
                const catInput = document.getElementById('note-category');
                if (catInput) catInput.value = cat;
            };

            // Not Kaydet
            window.saveNote = function () {
                const titleInput = document.getElementById('note-title');
                const contentInput = document.getElementById('note-content');
                const categoryInput = document.getElementById('note-category');
                const idInput = document.getElementById('note-edit-id');

                if (!titleInput || !contentInput) return;

                const title = titleInput.value.trim();
                const content = contentInput.value.trim();
                const category = categoryInput ? categoryInput.value : 'todo';
                const editId = idInput ? idInput.value : '';

                if (!title) {
                    window.alertMessage('Uyarı', 'Lütfen not başlığı giriniz.', 'yellow');
                    return;
                }

                let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');

                if (editId) {
                    // Update
                    const index = notes.findIndex(n => n.id === editId);
                    if (index !== -1) {
                        notes[index].title = title;
                        notes[index].content = content;
                        notes[index].category = category;
                        notes[index].updatedAt = Date.now();
                    }
                } else {
                    // Create
                    notes.push({
                        id: 'note_' + Date.now(),
                        title,
                        content,
                        category,
                        completed: false,
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                }

                localStorage.setItem('fingo_notes', JSON.stringify(notes));
                window.closeNotesModal();
                window.renderNotes();
                window.alertMessage('Başarılı', 'Not kaydedildi.', 'green');
            };

            // Not Sil
            window.deleteNote = async function (id) {
                const confirmed = await window.confirmDialog({
                    title: 'Not Sil',
                    message: 'Bu notu silmek istediğinize emin misiniz?',
                    confirmText: 'Sil',
                    cancelText: 'Vazgeç',
                    variant: 'red'
                });

                if (confirmed) {
                    let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');
                    notes = notes.filter(n => n.id !== id);
                    localStorage.setItem('fingo_notes', JSON.stringify(notes));
                    window.renderNotes();
                    window.alertMessage('Silindi', 'Not silindi.', 'blue');
                }
            };

            // Not Tamamla / Geri Al
            window.toggleNoteComplete = function (id) {
                let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');
                const note = notes.find(n => n.id === id);
                if (note) {
                    note.completed = !note.completed;
                    localStorage.setItem('fingo_notes', JSON.stringify(notes));
                    window.renderNotes();
                }
            };

            // Not Filtreleme
            window.currentNotesFilter = 'all';
            window.filterNotes = function (filter) {
                window.currentNotesFilter = filter;
                document.querySelectorAll('.notes-filter-btn').forEach(btn => {
                    if (btn.dataset.filter === filter) {
                        btn.classList.add('active', 'bg-amber-500', 'text-white', 'shadow-md');
                        btn.classList.remove('bg-white/60', 'dark:bg-white/10', 'text-gray-600', 'dark:text-gray-400');
                    } else {
                        btn.classList.remove('active', 'bg-amber-500', 'text-white', 'shadow-md');
                        btn.classList.add('bg-white/60', 'dark:bg-white/10', 'text-gray-600', 'dark:text-gray-400');
                    }
                });
                window.renderNotes();
            };

            // Not Render Fonksiyonu
            window.renderNotes = function () {
                const container = document.getElementById('notes-task-list');
                const emptyState = document.getElementById('notes-empty-state');
                const pendingCountEl = document.getElementById('notes-pending-count');

                if (!container) return;

                let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');

                // Update pending count
                const pendingCount = notes.filter(n => !n.completed).length;
                if (pendingCountEl) pendingCountEl.innerText = pendingCount;

                // Filter
                if (window.currentNotesFilter !== 'all') {
                    notes = notes.filter(n => n.category === window.currentNotesFilter);
                }

                // Sort (Newest first, then completed last)
                notes.sort((a, b) => {
                    if (a.completed === b.completed) return b.createdAt - a.createdAt;
                    return a.completed ? 1 : -1;
                });

                if (notes.length === 0) {
                    container.innerHTML = '';
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                }

                if (emptyState) emptyState.classList.add('hidden');

                container.innerHTML = '';

                const categoryConfig = {
                    todo: { icon: '✅', label: 'Yapılacak', color: 'text-emerald-500', bg: 'bg-emerald-50 dark:bg-emerald-900/20' },
                    important: { icon: '⭐', label: 'Önemli', color: 'text-amber-500', bg: 'bg-amber-50 dark:bg-amber-900/20' },
                    idea: { icon: '💡', label: 'Fikir', color: 'text-purple-500', bg: 'bg-purple-50 dark:bg-purple-900/20' },
                    financial: { icon: '💰', label: 'Finansal', color: 'text-blue-500', bg: 'bg-blue-50 dark:bg-blue-900/20' }
                };

                notes.forEach(note => {
                    const conf = categoryConfig[note.category] || categoryConfig.todo;
                    const isDone = note.completed;

                    const html = `
                    <div class="group relative bg-white dark:bg-gray-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm transition-all hover:shadow-md">
                        <div class="flex items-start gap-3">
                            <button onclick="window.toggleNoteComplete('${note.id}')" 
                                class="mt-1 w-6 h-6 rounded-full border-2 ${isDone ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 dark:border-gray-600'} flex items-center justify-center transition-colors">
                                ${isDone ? '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                            </button>
                            <div class="flex-1 min-w-0" onclick="window.toggleNotesModal(true, '${note.id}')">
                                <h4 class="text-sm font-bold ${isDone ? 'text-gray-400 line-through' : 'text-gray-900 dark:text-white'} truncate">${note.title}</h4>
                                <p class="text-xs ${isDone ? 'text-gray-300' : 'text-gray-500 dark:text-gray-400'} line-clamp-2 mt-0.5">${note.content}</p>
                                <div class="flex items-center gap-2 mt-2">
                                    <span class="text-[10px] px-2 py-0.5 rounded-md font-bold ${conf.color} ${conf.bg}">${conf.icon} ${conf.label}</span>
                                    <span class="text-[10px] text-gray-400">${new Date(note.createdAt).toLocaleDateString('tr-TR')}</span>
                                </div>
                            </div>
                            <button onclick="window.deleteNote('${note.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-red-500 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            };







            // Sayfa yüklendiğinde verileri yükle
            // Sayfa yüklendiğinde verileri yükle
            document.addEventListener('DOMContentLoaded', function () {
                const APP_YEAR = new Date().getFullYear();
                // Notes ve Installments verilerini localStorage'dan yükle
                try {
                    notes = JSON.parse(localStorage.getItem(`my_tasks_${APP_YEAR} `) || '[]');
                    installments = JSON.parse(localStorage.getItem(`my_installments_${APP_YEAR} `) || '[]');

                    // Geriye dönük uyumluluk: eski taksitlere type ekle
                    installments.forEach(inst => {
                        if (!inst.type) inst.type = 'credit_card';
                        if (!inst.interestRate) inst.interestRate = 0;
                        if (!inst.totalAmount) inst.totalAmount = inst.monthlyAmount * inst.totalMonths;
                    });
                    localStorage.setItem(`my_installments_${APP_YEAR} `, JSON.stringify(installments));

                    // İlk render
                    window.renderNotes();
                } catch (e) {
                    console.warn('Notes/Installments load error:', e);
                    notes = [];
                    installments = [];
                }
            });

            // Kategori Yapısı
            let defaultCategories = {
                expense: ['🛒 Market', '🧾 Fatura', '🏠 Kira', '💳 Kredi Kartı', '🏦 Kredi', '🏢 Aidat', '🚌 Ulaşım', '🍿 Eğlence', '💊 Sağlık', '👕 Giyim', '🎓 Eğitim', '💵 Dolar', '💶 Euro', '🟡 Altın Gr.', '🪙 Çeyrek Altın', '📈 Yatırım', '💸 Para Transferi', '🔧 Tamirat', '📦 Diğer'],
                income: ['💼 Maaş', '🏠 Kira Geliri', '💸 Ek Gelir', '💹 Yatırım Getirisi', '📦 Diğer']
            };

            // === MICRO-INTERACTIONS: RIPPLE EFFECT ===
            window.createRipple = function (event) {
                const button = event.currentTarget;
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                const ripple = document.createElement('span');
                ripple.className = 'ripple';
                ripple.style.width = ripple.style.height = `${size} px`;
                ripple.style.left = `${x} px`;
                ripple.style.top = `${y} px`;

                button.appendChild(ripple);

                ripple.addEventListener('animationend', () => ripple.remove());
            };

            // Auto-attach ripple to buttons with .ripple-container class
            window.initRippleEffect = function () {
                document.querySelectorAll('.ripple-container, .btn-interactive').forEach(btn => {
                    btn.addEventListener('click', window.createRipple);
                });
            };

            // === PARALLAX SCROLL EFFECT ===
            window.initParallaxScroll = function () {
                const scrollContainer = document.querySelector('#screen-dashboard');
                const parallaxCards = document.querySelectorAll('.parallax-card');

                if (!scrollContainer || parallaxCards.length === 0) return;

                let ticking = false;

                scrollContainer.addEventListener('scroll', function () {
                    if (!ticking) {
                        requestAnimationFrame(() => {
                            const scrollTop = scrollContainer.scrollTop;

                            parallaxCards.forEach((card, index) => {
                                const speed = 0.05 + (index * 0.02);
                                const yOffset = scrollTop * speed;
                                const scale = 1 - (scrollTop * 0.0002);

                                card.style.transform = `translateY(${- yOffset}px) scale(${Math.max(0.95, scale)})`;
                            });

                            ticking = false;
                        });
                        ticking = true;
                    }
                });
            };

            // === PREMIUM TOAST NOTIFICATION SYSTEM ===

            // SF Symbols benzeri minimal SVG ikonlar
            const TOAST_ICONS = {
                success: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
                error: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
                warning: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
                info: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`
            };

            const TOAST_TITLES = {
                success: 'Başarılı',
                error: 'Hata',
                warning: 'Dikkat',
                info: 'Bilgi'
            };

            // Toast container yönetimi
            function ensureToastContainer() {
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    document.body.appendChild(container);
                }
                // Premium stillere upgrade
                container.className = 'toast-shell';
                container.style.cssText = '';
                return container;
            }

            // Max toast kontrolü
            function enforceMaxToasts(container, max = 4) {
                const toasts = container.querySelectorAll('.toast:not(.toast--leaving):not(.toast--swipe-out)');
                if (toasts.length >= max) {
                    const oldest = toasts[0];
                    dismissToast(oldest);
                }
            }

            // Toast kapatma
            function dismissToast(toast, swipeDir = 0) {
                if (toast._dismissed) return;
                toast._dismissed = true;

                // Progress animation durdur
                const progressBar = toast.querySelector('.toast__progress-bar');
                if (progressBar) progressBar.style.animationPlayState = 'paused';

                // Swipe veya normal çıkış
                if (swipeDir !== 0) {
                    toast.style.setProperty('--swipe-dir', swipeDir > 0 ? '1' : '-1');
                    toast.classList.add('toast--swipe-out');
                } else {
                    toast.classList.add('toast--leaving');
                }

                toast.addEventListener('animationend', () => toast.remove(), { once: true });
                // Fallback
                setTimeout(() => toast.remove(), 350);
            }

            // Swipe-to-dismiss handler
            function setupSwipeToDismiss(toast) {
                let startX = 0, currentX = 0, isDragging = false;
                const threshold = toast.offsetWidth * 0.35;

                const onStart = (e) => {
                    if (toast._dismissed) return;
                    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    currentX = startX;
                    isDragging = true;
                    toast.classList.add('toast--swiping');
                };

                const onMove = (e) => {
                    if (!isDragging || toast._dismissed) return;
                    currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    const deltaX = currentX - startX;
                    toast.style.transform = `translateX(${deltaX}px)`;
                    toast.style.opacity = Math.max(0.5, 1 - Math.abs(deltaX) / (threshold * 2));
                };

                const onEnd = () => {
                    if (!isDragging || toast._dismissed) return;
                    isDragging = false;
                    toast.classList.remove('toast--swiping');

                    const deltaX = currentX - startX;
                    if (Math.abs(deltaX) > threshold) {
                        dismissToast(toast, deltaX);
                    } else {
                        // Snap back
                        toast.style.transition = 'transform 0.2s ease, opacity 0.2s ease';
                        toast.style.transform = 'translateX(0)';
                        toast.style.opacity = '1';
                        setTimeout(() => { toast.style.transition = ''; }, 200);
                    }
                };

                toast.addEventListener('pointerdown', onStart, { passive: true });
                toast.addEventListener('pointermove', onMove, { passive: true });
                toast.addEventListener('pointerup', onEnd);
                toast.addEventListener('pointercancel', onEnd);
                toast.addEventListener('pointerleave', onEnd);
            }

            // Ana toast oluşturucu
            function createToast({ title, message, type = 'info', duration = 3000, showProgress = true }) {
                // ✅ Toast kartlarını devre dışı bırak (tamamen kapat)
                if (typeof window.showMicroFeedback === 'function') {
                    const map = { red: 'error', error: 'error', green: 'success', success: 'success', warning: 'warning', yellow: 'warning' };
                    window.showMicroFeedback({ message: `${title}: ${message} `, type: map[type] || 'info' });
                }
                return;
                const container = ensureToastContainer();
                enforceMaxToasts(container, 4);

                const toast = document.createElement('div');
                toast.className = `toast toast--${type} toast--entering`;
                toast.style.setProperty('--toast-duration', `${duration} ms`);

                // HTML yapısı
                toast.innerHTML = `
            < div class="toast__icon" > ${TOAST_ICONS[type] || TOAST_ICONS.info}</div >
                <div class="toast__content">
                    <div class="toast__title">${title || TOAST_TITLES[type] || 'Bildirim'}</div>
                    ${message ? `<div class="toast__msg">${message}</div>` : ''}
                </div>
                <button class="toast__close" aria-label="Kapat">×</button>
                ${showProgress && duration > 0 ? '<div class="toast__progress"><div class="toast__progress-bar"></div></div>' : ''}
        `;

                // Close button
                const closeBtn = toast.querySelector('.toast__close');
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dismissToast(toast);
                });

                // Swipe desteği
                setupSwipeToDismiss(toast);

                container.appendChild(toast);

                // Auto dismiss
                if (duration > 0) {
                    toast._timeout = setTimeout(() => dismissToast(toast), duration);
                }

                // Hover'da zamanı durdur
                toast.addEventListener('mouseenter', () => {
                    if (toast._timeout) clearTimeout(toast._timeout);
                    const bar = toast.querySelector('.toast__progress-bar');
                    if (bar) bar.style.animationPlayState = 'paused';
                });
                toast.addEventListener('mouseleave', () => {
                    if (duration > 0 && !toast._dismissed) {
                        toast._timeout = setTimeout(() => dismissToast(toast), 1500);
                        const bar = toast.querySelector('.toast__progress-bar');
                        if (bar) {
                            bar.style.animation = 'none';
                            bar.offsetHeight; // Reflow
                            bar.style.animation = `toastProgressShrink 1500ms linear forwards`;
                            bar.style.animationPlayState = 'running';
                        }
                    }
                });

                return toast;
            }

            // ═══════════════════════════════════════════════════════════════
            // MICRO FEEDBACK SYSTEM
            // ═══════════════════════════════════════════════════════════════

            (function () {
                let currentPill = null;
                let hideTimer = null;
                let showTimer = null;

                const ICONS = {
                    success: '✓',
                    error: '✕',
                    info: 'ℹ',
                    warning: '⚠'
                };

                const DURATIONS = {
                    success: 2500,
                    info: 2500,
                    error: 3500,
                    warning: 3000
                };

                window.showMicroFeedback = function ({ message, type = 'success', anchorEl = null, duration = null }) {
                    // Safety check: ensure message is always a string
                    let safeMessage = message;
                    if (typeof message === 'object' && message !== null) {
                        // If it's an object, try to extract a useful string
                        safeMessage = message.message || message.text || message.title || JSON.stringify(message);
                    }
                    safeMessage = String(safeMessage || 'Bildirim');

                    const finalDuration = duration || DURATIONS[type] || 1100;

                    // Clear any pending timers
                    if (hideTimer) clearTimeout(hideTimer);
                    if (showTimer) clearTimeout(showTimer);

                    // If anchor element provided, show inline chip
                    if (anchorEl && anchorEl.getBoundingClientRect) {
                        try {
                            const chip = document.createElement('div');
                            chip.className = 'micro-chip';
                            chip.textContent = safeMessage;

                            // Position relative to anchor
                            const rect = anchorEl.getBoundingClientRect();
                            const parent = anchorEl.offsetParent || document.body;
                            const parentRect = parent.getBoundingClientRect();

                            chip.style.top = (rect.top - parentRect.top - 28) + 'px';
                            chip.style.left = (rect.left - parentRect.left + rect.width / 2) + 'px';
                            chip.style.transform = 'translateX(-50%)';

                            parent.style.position = parent.style.position || 'relative';
                            parent.appendChild(chip);

                            // Remove after animation
                            setTimeout(() => chip.remove(), finalDuration);
                            return;
                        } catch (e) {
                            // Fall through to default behavior
                        }
                    }

                    // Default: bottom-center pill
                    const root = document.getElementById('micro-feedback-root');
                    if (!root) return;

                    // Remove existing pill immediately if any
                    if (currentPill) {
                        currentPill.classList.remove('show');
                        currentPill.classList.add('hide');
                        const oldPill = currentPill;
                        setTimeout(() => oldPill.remove(), 150);
                    }

                    // Create new pill
                    const pill = document.createElement('div');
                    pill.className = `micro - pill micro - pill--${type} `;
                    pill.innerHTML = `< span class="micro-pill__icon" > ${ICONS[type] || ICONS.info}</span > <span>${safeMessage}</span>`;

                    // Inline stil - konum ve görünürlük ayarları
                    pill.style.cssText = `
        position: fixed;
        bottom: 120px;
        left: 50 %;
        transform: translateX(-50 %) scale(0.9);
        background: linear - gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
        color: white;
        padding: 12px 24px;
        border - radius: 50px;
        font - weight: 600;
        font - size: 14px;
        display: flex;
        align - items: center;
        gap: 10px;
        box - shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: all 0.4s cubic - bezier(0.4, 0, 0.2, 1);
        z - index: 10000;
        pointer - events: none;
        `;

                    root.appendChild(pill);
                    currentPill = pill;

                    // Trigger show animation
                    showTimer = setTimeout(() => {
                        pill.style.opacity = '1';
                        pill.style.transform = 'translateX(-50%) scale(1)';
                    }, 50);

                    // Auto hide
                    hideTimer = setTimeout(() => {
                        pill.style.opacity = '0';
                        pill.style.transform = 'translateX(-50%) scale(0.9)';
                        setTimeout(() => {
                            if (currentPill === pill) currentPill = null;
                            pill.remove();
                        }, 500);
                    }, finalDuration);
                };

                // Flash button with success state
                window.flashButtonSuccess = function (buttonEl, label = 'Kaydedildi') {
                    if (!buttonEl) return;
                    const originalText = buttonEl.textContent;
                    const originalHTML = buttonEl.innerHTML;
                    buttonEl.textContent = label + ' ✓';
                    buttonEl.classList.add('btn-flash-success');

                    setTimeout(() => {
                        buttonEl.innerHTML = originalHTML;
                        buttonEl.classList.remove('btn-flash-success');
                    }, 900);
                };

                // Flash button with error state
                window.flashButtonError = function (buttonEl, label = 'Hata') {
                    if (!buttonEl) return;
                    const originalText = buttonEl.textContent;
                    const originalHTML = buttonEl.innerHTML;
                    buttonEl.textContent = label + ' ✕';
                    buttonEl.classList.add('btn-flash-error');

                    setTimeout(() => {
                        buttonEl.innerHTML = originalHTML;
                        buttonEl.classList.remove('btn-flash-error');
                    }, 900);
                };
            })();

            // API uyumluluğu: window.showToast -> Micro Feedback'e yönlendir
            window.showToast = function (message, type = 'info', duration = null) {
                window.showMicroFeedback({ message, type, duration });
            };

            // Shortcut functions -> Micro Feedback'e yönlendir
            window.toastSuccess = (msg, dur) => window.showMicroFeedback({ message: msg, type: 'success', duration: dur });
            window.toastError = (msg, dur) => window.showMicroFeedback({ message: msg, type: 'error', duration: dur });
            window.toastWarning = (msg, dur) => window.showMicroFeedback({ message: msg, type: 'warning', duration: dur });
            window.toastInfo = (msg, dur) => window.showMicroFeedback({ message: msg, type: 'info', duration: dur });

            // === WIDGET DRAG & DROP SYSTEM (DISABLED) ===
            // Feature removed per user request - widgets have fixed positions
            window.initWidgetDragDrop = function () {
                // Remove draggable from all widgets
                document.querySelectorAll('.dashboard-widget').forEach(w => {
                    w.removeAttribute('draggable');
                });
                // Clear any saved order
                localStorage.removeItem('widget_order');
            };

            let draggedWidget = null;

            function handleDragStart(e) {
                draggedWidget = this;
                this.classList.add('widget-dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);

                // Create ghost image
                const ghost = this.cloneNode(true);
                ghost.style.opacity = '0.5';
                ghost.style.position = 'absolute';
                ghost.style.top = '-1000px';
                document.body.appendChild(ghost);
                e.dataTransfer.setDragImage(ghost, 0, 0);
                setTimeout(() => ghost.remove(), 0);
            }

            function handleDragEnd(e) {
                this.classList.remove('widget-dragging');
                document.querySelectorAll('.dashboard-widget').forEach(w => {
                    w.classList.remove('widget-drag-over');
                });
                saveWidgetOrder();
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            function handleDragEnter(e) {
                this.classList.add('widget-drag-over');
            }

            function handleDragLeave(e) {
                this.classList.remove('widget-drag-over');
            }

            function handleDrop(e) {
                e.stopPropagation();

                if (draggedWidget !== this) {
                    const container = this.parentNode;
                    const allWidgets = [...container.querySelectorAll('.dashboard-widget')];
                    const draggedIdx = allWidgets.indexOf(draggedWidget);
                    const droppedIdx = allWidgets.indexOf(this);

                    if (draggedIdx < droppedIdx) {
                        this.parentNode.insertBefore(draggedWidget, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedWidget, this);
                    }

                    // Show feedback
                    window.showToast('Widget sırası güncellendi', 'success', 1500);
                }

                this.classList.remove('widget-drag-over');
                return false;
            }

            function saveWidgetOrder() {
                const container = document.getElementById('dashboard-widgets');
                if (!container) return;

                const order = [...container.querySelectorAll('.dashboard-widget')]
                    .map(w => w.id || w.dataset.widgetId);

                localStorage.setItem('widget_order', JSON.stringify(order));
            }

            function loadWidgetOrder() {
                const savedOrder = localStorage.getItem('widget_order');
                if (!savedOrder) return;

                try {
                    const order = JSON.parse(savedOrder);
                    const container = document.getElementById('dashboard-widgets');
                    if (!container) return;

                    order.forEach(id => {
                        const widget = container.querySelector(`#${id}, [data - widget - id="${id}"]`);
                        if (widget) container.appendChild(widget);
                    });
                } catch (e) {
                    console.warn('Widget order load failed:', e);
                }
            }

            let categories = JSON.parse(JSON.stringify(defaultCategories));
            let currentCategoryTab = 'expense';


            const isSavings = (cat) => ['Dolar', 'Euro', 'Altın', 'Çeyrek', 'Yatırım', '💵', '💶', '🟡', '🪙', '📈'].some(k => cat && cat.includes(k));

            window.upgradeToPro = async function () {
                // Update global state
                userStatus = 'pro';
                window.userStatus = 'pro';

                // Write to both AppStorage (Capacitor) and localStorage
                await Promise.all([
                    AppStorage.set('user_status', 'pro'),
                    AppStorage.set('user_membership_status', 'pro'),
                    AppStorage.set('premium', 'true'),
                ]);
                localStorage.setItem('user_status', 'pro');
                localStorage.setItem('user_membership_status', 'pro');
                localStorage.setItem('premium', 'true');

                // Reset hydration promise for fresh state
                window.__premiumReady = Promise.resolve(true);

                document.getElementById('premium-modal').classList.add('hidden');
                window.alertMessage("Tebrikler!", "Fingenda Pro üyeliğiniz aktif edildi! 🎉", "blue");
                const name = localStorage.getItem('user_name');
                window.updateProfileUI(name || 'Misafir', null, localStorage.getItem('user_avatar'));

                // Update header badge to Pro style
                const badge = document.getElementById('user-plan-badge');
                if (badge) {
                    badge.innerHTML = '<span class="relative z-10 flex items-center gap-1"><span class="animate-pulse">👑</span>PRO</span><div class="absolute inset-0 shimmer opacity-50"></div>';
                    badge.style.cssText = 'background: linear-gradient(135deg, #f59e0b, #ea580c); color: white; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255,255,255,0.3); cursor: default;';
                    badge.onclick = null;
                }

                // Hide upgrade button
                const upgradeBtn = document.getElementById('btn-header-upgrade');
                if (upgradeBtn) upgradeBtn.classList.add('hidden');

                // Hide autopilot gate
                const autopilotGate = document.getElementById('autopilot-premium-gate');
                if (autopilotGate) autopilotGate.classList.add('hidden');

                // Update PremiumManager state and unlock features
                if (window.PremiumManager) {
                    window.PremiumManager.isPremium = true;
                    window.PremiumManager.unlockAllFeatures();
                }

                // Premium Welcome Tour trigger
                try {
                    await AppStorage.set('pwt_pending_v1', '1');
                    if (window.PWT) window.PWT.maybeShow();
                } catch (e) {
                    console.warn('PWT trigger error:', e);
                }
            };

            // === PRICING PLAN TOGGLE ===
            window.setPricingPlan = function (plan) {
                const options = document.querySelectorAll('.pricing-option');
                const priceDisplay = document.getElementById('premium-price-display');

                options.forEach(opt => {
                    if (opt.textContent.toLowerCase().includes(plan === 'monthly' ? 'aylık' : 'yıllık')) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });

                if (priceDisplay) {
                    if (plan === 'yearly') {
                        priceDisplay.innerHTML = `
            < div class="relative inline-block" >
                            <span class="save-badge">%40 TASARRUF</span>
                            <div class="flex items-baseline justify-center gap-1">
                                <span class="text-4xl font-black text-white">₺349</span>
                                <span class="text-white/50 text-sm">/yıl</span>
                            </div>
                        </div >
            <p class="text-[10px] text-purple-300/60 mt-1">Aylık ₺29'a denk gelir</p>
        `;
                    } else {
                        priceDisplay.innerHTML = `
            < div class="flex items-baseline justify-center gap-1" >
                            <span class="text-4xl font-black text-white">₺49</span>
                            <span class="text-white/50 text-sm">/ay</span>
                        </div >
            <p class="text-[10px] text-purple-300/60 mt-1">7 gün ücretsiz deneme dahil</p>
        `;
                    }
                }
            };

            window.showUpgradeInfo = function () { window.alertMessage('Bilgi', 'Premium paket yakında aktif olacak! 🚀', 'blue'); };

            // === MINI TOAST NOTIFICATION -> Micro Feedback'e yönlendirildi ===
            window.showMiniToast = function (title, text, icon = "🔄") {
                // Eski API uyumluluğu: title + text birleştir
                const message = text ? `${title}: ${text} ` : title;
                window.showMicroFeedback({ message, type: 'info' });
            };

            window.triggerOCR = function () {
                if (window.checkPremiumFeature('ocr')) {
                    document.getElementById('ocr-input').click();
                }
            };

            window.triggerVoiceInput = function () {
                if (window.checkPremiumFeature('voice_input')) {
                    window.startVoiceInput();
                }
            };

            window.checkPremiumFeature = function (featureName) {
                // Birden fazla kaynaktan pro kontrolü
                if (userStatus === 'pro' || window.userStatus === 'pro' || window.PremiumManager?.isPremium) {
                    return true;
                }
                const premiumFeatures = ['ai_chat', 'excel_export', 'advanced_charts', 'installment_limit_exceeded', 'ocr', 'voice_input'];
                if (premiumFeatures.includes(featureName)) {
                    const modal = document.getElementById('premium-modal');
                    if (modal) modal.classList.remove('hidden');
                    return false;
                }
                return true;
            };

            // === KREDİ HESAPLAYICI ===
            window.calculateLoan = function () {
                const amount = parseFloat(document.getElementById('loan-amount')?.value) || 0;
                const rate = parseFloat(document.getElementById('loan-rate')?.value) || 0;
                const term = parseInt(document.getElementById('loan-term')?.value) || 0;

                if (amount <= 0 || rate <= 0 || term <= 0) {
                    document.getElementById('loan-monthly').textContent = '0₺';
                    document.getElementById('loan-interest').textContent = '0₺';
                    document.getElementById('loan-total').textContent = '0₺';
                    return;
                }

                // Aylık faiz oranı (yüzdelik değeri ondalık hale çeviriyoruz)
                const monthlyRate = rate / 100;

                // Basit faiz formülü ile aylık taksit hesaplama
                // Toplam geri ödeme = Anapara + (Anapara × Faiz Oranı × Vade)
                // Aylık taksit = Toplam geri ödeme / Vade
                const totalInterest = amount * monthlyRate * term;
                const totalPayment = amount + totalInterest;
                const monthlyPayment = totalPayment / term;

                // Sonuçları göster
                document.getElementById('loan-monthly').textContent = monthlyPayment.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺';
                document.getElementById('loan-interest').textContent = totalInterest.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺';
                document.getElementById('loan-total').textContent = totalPayment.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺';
            };

            // === DÖVİZ ÇEVİRİCİ ===
            window.convertCurrency = function () {
                const amount = parseFloat(document.getElementById('currency-amount')?.value) || 0;
                const fromCurrency = document.getElementById('currency-from')?.value || 'TRY';

                // Güncel kurlar (liveRates'den veya varsayılan değerlerden al)
                const rates = {
                    TRY: 1,
                    USD: liveRates?.USD || 34.5,
                    EUR: liveRates?.EUR || 37.5,
                    GBP: (liveRates?.EUR || 37.5) * 1.17 // GBP yaklaşık olarak EUR'dan %17 yüksek
                };

                // Önce TRY'ye çevir, sonra hedef para birimine
                let amountInTRY = amount;
                if (fromCurrency !== 'TRY') {
                    amountInTRY = amount * rates[fromCurrency];
                }

                // Sonuçları hesapla
                const resultUSD = amountInTRY / rates.USD;
                const resultEUR = amountInTRY / rates.EUR;
                const resultGBP = amountInTRY / rates.GBP;

                // Sonuçları göster
                document.getElementById('result-usd').textContent = '$' + resultUSD.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('result-eur').textContent = '€' + resultEUR.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('result-gbp').textContent = '£' + resultGBP.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                // Son güncelleme zamanını göster
                const lastUpdate = document.getElementById('currency-last-update');
                if (lastUpdate) {
                    const now = new Date();
                    lastUpdate.textContent = 'Son güncelleme: ' + now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                }
            };

            // === FINGO AUTOPILOT DASHBOARD ===
            window.updateAutopilotDashboard = function () {
                const transactions = window.transactions || [];
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                // Bugünkü harcamaları hesapla
                let todaySpent = 0;
                transactions.forEach(t => {
                    if (t.type === 'expense' && t.date === todayStr) {
                        todaySpent += parseFloat(t.amount) || 0;
                    }
                });

                // Günlük limit (ayarlarda değiştirebilir, şimdilik 500₺)
                const dailyLimit = 500;
                const spentPercent = Math.min((todaySpent / dailyLimit) * 100, 100);

                // UI Güncelle
                const dailySpentEl = document.getElementById('autopilot-daily-spent');
                const dailyBarEl = document.getElementById('autopilot-daily-bar');
                const statusTextEl = document.getElementById('autopilot-status-text');
                const statusIndicatorEl = document.getElementById('autopilot-status-indicator');
                const adviceEl = document.getElementById('autopilot-advice');

                if (dailySpentEl) {
                    dailySpentEl.textContent = todaySpent.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺ / ' + dailyLimit + '₺';
                }

                if (dailyBarEl) {
                    dailyBarEl.style.width = spentPercent + '%';

                    // Renk değiştir
                    if (spentPercent < 50) {
                        dailyBarEl.style.background = 'linear-gradient(90deg, var(--accent-success), var(--accent-tertiary))';
                    } else if (spentPercent < 80) {
                        dailyBarEl.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                    } else {
                        dailyBarEl.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                    }
                }

                // Durum göstergesi
                if (statusTextEl && statusIndicatorEl) {
                    if (spentPercent < 50) {
                        statusTextEl.textContent = 'Güvenli Bölge';
                        statusTextEl.style.color = 'var(--accent-success)';
                        statusIndicatorEl.style.borderColor = 'var(--accent-success)';
                        statusIndicatorEl.innerHTML = '<span class="text-3xl">✓</span>';
                    } else if (spentPercent < 80) {
                        statusTextEl.textContent = 'Dikkatli Ol';
                        statusTextEl.style.color = '#f59e0b';
                        statusIndicatorEl.style.borderColor = '#f59e0b';
                        statusIndicatorEl.innerHTML = '<span class="text-3xl">⚠️</span>';
                    } else {
                        statusTextEl.textContent = 'Limit Aşımı!';
                        statusTextEl.style.color = 'var(--accent-danger)';
                        statusIndicatorEl.style.borderColor = 'var(--accent-danger)';
                        statusIndicatorEl.innerHTML = '<span class="text-3xl">🚨</span>';
                    }
                }

                // AI Tavsiyesi
                if (adviceEl) {
                    const advices = [
                        todaySpent === 0 ? 'Bugün harcama yapmadın. Bu tempoya devam et!' : null,
                        spentPercent < 30 ? 'Harika gidiyorsun! Bütçeni çok iyi yönetiyorsun. 💪' : null,
                        spentPercent >= 30 && spentPercent < 60 ? 'Günlük limitinin yarısına yaklaştın. Gereksiz harcamalardan kaçın.' : null,
                        spentPercent >= 60 && spentPercent < 80 ? 'Dikkatli ol! Günlük limitine yaklaşıyorsun. 🎯' : null,
                        spentPercent >= 80 ? 'Günlük limitini aştın! Yarın daha dikkatli ol. 📉' : null
                    ].filter(Boolean);
                    adviceEl.textContent = advices[0] || 'Finansal hedeflerine odaklan!';
                }
            };

            // === NAKİT AKIŞI CHART ===
            window.updateCashflowChart = function () {
                const transactions = window.transactions || [];
                const chartEl = document.getElementById('cashflow-chart');
                const incomeEl = document.getElementById('cashflow-income');
                const expenseEl = document.getElementById('cashflow-expense');
                const balanceEl = document.getElementById('cashflow-balance');

                if (!chartEl) return;

                // Son 30 günün verilerini hesapla
                const today = new Date();
                let totalIncome = 0;
                let totalExpense = 0;
                const dailyData = [];

                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];

                    let dayIncome = 0;
                    let dayExpense = 0;

                    transactions.forEach(t => {
                        if (t.date === dateStr) {
                            if (t.type === 'income') {
                                dayIncome += parseFloat(t.amount) || 0;
                            } else if (t.type === 'expense') {
                                dayExpense += parseFloat(t.amount) || 0;
                            }
                        }
                    });

                    totalIncome += dayIncome;
                    totalExpense += dayExpense;
                    dailyData.push({ date: dateStr, income: dayIncome, expense: dayExpense, net: dayIncome - dayExpense });
                }

                // Özet değerleri güncelle
                if (incomeEl) incomeEl.textContent = '+' + totalIncome.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺';
                if (expenseEl) expenseEl.textContent = '-' + totalExpense.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺';
                if (balanceEl) balanceEl.textContent = (totalIncome - totalExpense).toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺';

                // Mini bar chart
                const maxVal = Math.max(...dailyData.map(d => Math.max(d.income, d.expense)), 1);
                chartEl.innerHTML = dailyData.slice(-15).map((d, i) => {
                    const height = Math.max(((d.income + d.expense) / maxVal) * 100, 5);
                    const color = d.net >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)';
                    return `< div class="flex-1 rounded-t" style = "height: ${height}%; background: ${color}; opacity: ${0.4 + (i * 0.04)};" ></div > `;
                }).join('');

                // Trend göstergesi
                const trendEl = document.getElementById('cashflow-trend-text');
                if (trendEl) {
                    const netFlow = totalIncome - totalExpense;
                    if (netFlow > 0) {
                        trendEl.textContent = 'Pozitif';
                        trendEl.style.color = 'var(--accent-success)';
                    } else if (netFlow < 0) {
                        trendEl.textContent = 'Negatif';
                        trendEl.style.color = 'var(--accent-danger)';
                    } else {
                        trendEl.textContent = 'Stabil';
                        trendEl.style.color = 'var(--text-muted)';
                    }
                }
            };

            // === AUTOPILOT BAŞLATMA ===
            window.initAutopilot = function () {
                // Premium gate kontrolü - birden fazla kaynaktan
                const isPro = userStatus === 'pro' || window.userStatus === 'pro' || window.PremiumManager?.isPremium;
                const gate = document.getElementById('autopilot-premium-gate');
                if (gate) {
                    gate.style.display = isPro ? 'none' : 'flex';
                }

                // Dashboard güncelle
                window.updateAutopilotDashboard();
                window.updateCashflowChart();
                window.convertCurrency();
                window.calculateLoan();
            };

            // Tab değiştiğinde Autopilot'u başlat ve orb'ları kontrol et
            const originalSwitchTab = window.switchTab;
            window.switchTab = function (tabId) {
                if (typeof originalSwitchTab === 'function') {
                    originalSwitchTab(tabId);
                }
                if (tabId === 'wallet') {
                    // Ensure data is fresh when opening FingoBrain
                    if (window.refreshDashboard) window.refreshDashboard();
                    setTimeout(() => window.initAutopilot(), 100);
                    // Initialize FingoBrain enhancements
                    setTimeout(() => {
                        if (window.initFingoBrainEnhancements) window.initFingoBrainEnhancements();
                    }, 150);
                }

                // Yeni İşlem ekranında orb'ları ve nav-blob'u gizle
                const navBlob = document.getElementById('nav-liquid-blob');
                if (tabId === 'add') {
                    document.body.classList.add('hide-orbs');
                    if (navBlob) navBlob.classList.add('blob-hidden');
                } else {
                    document.body.classList.remove('hide-orbs');
                    if (navBlob) navBlob.classList.remove('blob-hidden');
                }
            };

            window.setupRealtimeListener = function () {
                // Yerel Mod: Firebase bağlantısı atlandı
                if (isLocalMode || !db || !userId) return;
                const loadingText = document.getElementById('storage-indicator');
                if (loadingText) loadingText.textContent = "Bulut Senkronize";

                // Firebase kodları kaldırıldı
            };

            // ═══════════════════════════════════════════════════════════════
            // HİSSE DETAY MODALI FONKSİYONLARI (GERÇEK VERİ ENTEGRASYONLu)
            // ═══════════════════════════════════════════════════════════════

            // BIST hisse listesi (başlangıç verileri, gerçek verilerle güncellenecek)
            const bistStocks = [
                { symbol: 'YKBNK', name: 'Yapı Kredi Bankası', price: 28.54, change: 2.35 },
                { symbol: 'GARAN', name: 'Garanti BBVA', price: 89.20, change: -1.15 },
                { symbol: 'THYAO', name: 'Türk Hava Yolları', price: 289.50, change: 3.42 },
                { symbol: 'SISE', name: 'Şişecam', price: 56.80, change: 0.85 },
                { symbol: 'KCHOL', name: 'Koç Holding', price: 195.60, change: -0.52 },
                { symbol: 'ASELS', name: 'Aselsan', price: 78.90, change: 1.89 }
            ];

            // Gerçek veri cache sistemi
            const stockDataCache = {};
            const CACHE_DURATION = 5 * 60 * 1000; // 5 dakika

            // Yahoo Finance symbol mapping (BIST -> Yahoo)
            const symbolToYahoo = (symbol) => `${symbol}.IS`;

            // Period mapping (UI -> Yahoo Finance API)
            const periodToYahoo = (period) => {
                const map = {
                    '1G': { range: '1d', interval: '5m' },
                    '1H': { range: '5d', interval: '15m' },
                    '1A': { range: '1mo', interval: '1d' },
                    '3A': { range: '3mo', interval: '1d' },
                    '1Y': { range: '1y', interval: '1wk' }
                };
                return map[period] || map['1G'];
            };

            // Yahoo Finance API'den gerçek veri çekme
            window.fetchHistoricalData = async function (symbol, period = '1G', currentPrice = 0) {
                const cacheKey = `${symbol}_${period} `;
                const now = Date.now();

                // Cache kontrolü
                if (stockDataCache[cacheKey] && (now - stockDataCache[cacheKey].timestamp < CACHE_DURATION)) {
                    console.log(`[Stock] Cache hit for ${cacheKey}`);
                    return stockDataCache[cacheKey].data;
                }

                const yahooSymbol = symbolToYahoo(symbol);
                const { range, interval } = periodToYahoo(period);

                try {
                    // Yahoo Finance API URL
                    const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?range=${range}&interval=${interval}&includePrePost=false`;

                    // CORS proxy kullan
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;

                    console.log(`[Stock] Fetching real data for ${symbol} (${period})...`);

                    // Timeout için AbortController
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 saniye timeout

                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const json = await response.json();
                    const result = json.chart?.result?.[0];

                    if (!result || !result.indicators?.quote?.[0]?.close) {
                        throw new Error('Invalid data structure');
                    }

                    const quote = result.indicators.quote[0];
                    const meta = result.meta;
                    const timestamps = result.timestamp || [];

                    // Fiyat verilerini temizle (null değerleri filtrele)
                    const prices = quote.close.filter(p => p !== null && !isNaN(p));
                    const highs = quote.high.filter(p => p !== null && !isNaN(p));
                    const lows = quote.low.filter(p => p !== null && !isNaN(p));
                    const opens = quote.open.filter(p => p !== null && !isNaN(p));
                    const volumes = quote.volume.filter(v => v !== null && !isNaN(v));

                    if (prices.length < 2) {
                        throw new Error('Insufficient data points');
                    }

                    const data = {
                        prices: prices,
                        high: Math.max(...highs),
                        low: Math.min(...lows),
                        open: opens[0] || prices[0],
                        close: prices[prices.length - 1],
                        volume: volumes.reduce((a, b) => a + b, 0),
                        previousClose: meta.previousClose || opens[0],
                        currency: meta.currency || 'TRY',
                        timestamps: timestamps
                    };

                    // Cache'e kaydet
                    stockDataCache[cacheKey] = {
                        data: data,
                        timestamp: now
                    };

                    console.log(`[Stock] ✓ Real data fetched for ${symbol}: ${prices.length} points`);
                    return data;

                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.warn(`[Stock] Timeout for ${symbol} - using mock data`);
                    } else {
                        console.warn(`[Stock] API error for ${symbol}:`, error.message);
                    }

                    // Fallback: Mock data oluştur (currentPrice'ı geçir)
                    return window.generateMockStockData(symbol, period, currentPrice);
                }
            };

            // Mock veri oluşturma (fallback)
            window.generateMockStockData = function (symbol, period, basePrice = null) {
                // bistStocks'tan fiyat al veya parametre olarak geçilen fiyatı kullan
                const stock = bistStocks.find(s => s.symbol === symbol);
                let price = basePrice || (stock && stock.price) || 100;

                // Eğer fiyat geçerli değilse varsayılan kullan
                if (!price || isNaN(price) || price <= 0) price = 100;

                let points = 50;
                let volatility = 0.5;

                if (period === '1G') { points = 40; volatility = 0.3; }
                else if (period === '1H') { points = 60; volatility = 0.8; }
                else if (period === '1A') { points = 30; volatility = 1.5; }
                else if (period === '3A') { points = 60; volatility = 2.0; }
                else if (period === '1Y') { points = 52; volatility = 3.0; }

                const prices = [];
                let val = price * 0.95;
                for (let i = 0; i < points; i++) {
                    val += (Math.random() - 0.45) * volatility * (price * 0.01);
                    prices.push(Math.max(val, price * 0.5));
                }

                // Son fiyatı gerçek fiyata yaklaştır
                prices[prices.length - 1] = price;

                return {
                    prices: prices,
                    high: Math.max(...prices) * 1.01,
                    low: Math.min(...prices) * 0.99,
                    open: prices[0],
                    close: price,
                    volume: Math.floor(Math.random() * 50000000 + 10000000),
                    previousClose: prices[0],
                    isMock: true
                };
            };

            // Hisse listesini doldur (gerçek verilerle güncelleme destekli)
            // Debounce yardımcı fonksiyonu
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }

            // Hisse arama ve filtreleme fonksiyonu
            window.filterStocks = function (query) {
                const term = query.trim().toLowerCase();
                const container = document.getElementById('stock-list-container');

                if (!term) {
                    window.populateStockList(null); // Tüm listeyi göster
                    return;
                }

                const filtered = bistStocks.filter(stock =>
                    stock.symbol.toLowerCase().includes(term) ||
                    stock.name.toLowerCase().includes(term)
                );

                window.populateStockList(filtered);
            };

            // Hisse listesini doldur (Filtreleme destekli)
            window.populateStockList = async function (stocksToRender = null) {
                const container = document.getElementById('stock-list-container');
                if (!container) return;

                container.innerHTML = '';
                const stocks = stocksToRender || bistStocks;

                if (stocks.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-2 py-8 text-center bg-white/40 dark:bg-white/5 rounded-xl border border-dashed border-gray-300 dark:border-gray-600">
                            <div class="text-2xl mb-2">🔍</div>
                            <p class="text-sm font-bold text-gray-500 dark:text-gray-400">Sonuç bulunamadı</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Farklı bir hisse kodu veya isim deneyin.</p>
                        </div>
                    `;
                    return;
                }

                // Önce mevcut verilerle göster
                stocks.forEach((stock, index) => {
                    const isPositive = stock.change >= 0;
                    const changeColor = isPositive ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400';
                    const changeIcon = isPositive ? '▲' : '▼';
                    const changeBg = isPositive ? 'bg-emerald-100 dark:bg-emerald-900/30' : 'bg-red-100 dark:bg-red-900/30';

                    const html = `
                    <div onclick="window.openStockDetailModal('${stock.symbol}')" 
                         class="glass-card rounded-xl p-3 cursor-pointer hover:scale-[1.02] transition-all border border-white/40 dark:border-white/10 hover:shadow-lg group"
                         style="animation-delay: ${index * 0.05}s"
                         id="stock-card-${stock.symbol}">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-xs font-black text-gray-800 dark:text-white bg-indigo-50 dark:bg-indigo-900/40 px-1.5 py-0.5 rounded text-indigo-600 dark:text-indigo-300">${stock.symbol}</p>
                            <span class="text-[9px] font-bold px-1.5 py-0.5 rounded ${changeBg} ${changeColor}" id="stock-change-${stock.symbol}">
                                ${changeIcon} ${Math.abs(stock.change).toFixed(2)}%
                            </span>
                        </div>
                        <p class="text-lg font-black text-indigo-600 dark:text-indigo-400" id="stock-price-${stock.symbol}">${stock.price.toFixed(2)} ₺</p>
                        <p class="text-[9px] text-gray-500 dark:text-gray-400 font-medium truncate">${stock.name}</p>
                    </div>
                `;

                    container.insertAdjacentHTML('beforeend', html);
                });

                // Arka planda gerçek verileri çek ve güncelle (Sadece listelenenler için güncellese daha iyi ama hepsi için de ok)
                // Filtereliyken sadece görünenleri update etmek mantıklı olabilir ama orijinal fonksiyon hepsini dönüyor.
                // updateStockListWithRealData fonksiyonu ID ile element bulduğu için sorun çıkarmaz.
                window.updateStockListWithRealData();
            };

            // Gerçek verilerle hisse listesini güncelle
            window.updateStockListWithRealData = async function () {
                for (const stock of bistStocks) {
                    try {
                        const data = await window.fetchHistoricalData(stock.symbol, '1G');
                        if (data && !data.isMock) {
                            const change = ((data.close - data.previousClose) / data.previousClose) * 100;

                            // bistStocks'u güncelle
                            stock.price = data.close;
                            stock.change = change;

                            // UI'ı güncelle
                            const priceEl = document.getElementById(`stock-price-${stock.symbol}`);
                            const changeEl = document.getElementById(`stock-change-${stock.symbol}`);

                            if (priceEl) {
                                priceEl.textContent = `${data.close.toFixed(2)} ₺`;
                            }

                            if (changeEl) {
                                const isPositive = change >= 0;
                                const icon = isPositive ? '▲' : '▼';
                                changeEl.textContent = `${icon} ${Math.abs(change).toFixed(2)}%`;
                                changeEl.className = `text-[9px] font-bold px-1.5 py-0.5 rounded ${isPositive ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400' : 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400'}`;
                            }
                        }
                    } catch (e) {
                        console.warn(`[Stock] Update failed for ${stock.symbol}:`, e);
                    }
                }
            };

            // Modal açma fonksiyonu (async - gerçek veri çeker)
            window.openStockDetailModal = async function (symbol) {
                const stock = bistStocks.find(s => s.symbol === symbol);
                if (!stock) return;

                const modal = document.getElementById('stock-detail-modal');
                if (!modal) return;

                // Modal verilerini doldur (başlangıç değerleri)
                document.getElementById('modal-stock-symbol').textContent = stock.symbol;
                document.getElementById('modal-stock-name').textContent = stock.name;
                document.getElementById('modal-stock-price').textContent = stock.price.toFixed(2);

                const changeEl = document.getElementById('modal-stock-change');
                const changeBox = document.getElementById('modal-stock-change-box');
                const isPositive = stock.change >= 0;

                changeEl.textContent = `${isPositive ? '▲' : '▼'} ${Math.abs(stock.change).toFixed(2)}%`;
                changeEl.className = `text-lg font-bold flex items-center gap-1 ${isPositive ? 'text-emerald-500 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400'}`;
                changeBox.className = `px-4 py-2 rounded-xl backdrop-blur-md ${isPositive ? 'bg-emerald-500/10' : 'bg-rose-500/10'}`;

                // İstatistikleri "Yükleniyor" olarak ayarla
                document.getElementById('stat-high').textContent = '...';
                document.getElementById('stat-low').textContent = '...';
                document.getElementById('stat-open').textContent = '...';
                document.getElementById('stat-vol').textContent = '...';

                // Varsayılan Periyot: 1G
                window.changeStockPeriod('1G', false);

                // Modal'ı göster
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Bir frame bekle ve grafiği çiz
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        window.renderStockChart(symbol, '1G');
                    });
                });
            };

            // Modal kapatma fonksiyonu
            window.closeStockDetailModal = function () {
                const modal = document.getElementById('stock-detail-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            };

            // Periyot Değiştirme
            window.changeStockPeriod = function (period, shouldRender = true) {
                // Aktif butonu güncelle
                document.querySelectorAll('.stock-period-btn').forEach(btn => {
                    const isSelected = btn.id === 'period-' + period;
                    if (isSelected) {
                        btn.className = 'stock-period-btn flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-indigo-500 text-white shadow-lg shadow-indigo-500/30';
                    } else {
                        btn.className = 'stock-period-btn flex-1 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500 dark:text-gray-400 hover:bg-white hover:shadow-sm dark:hover:bg-white/5';
                    }
                });

                if (shouldRender) {
                    const symbol = document.getElementById('modal-stock-symbol').textContent;
                    window.renderStockChart(symbol, period);
                }
            };

            // Gelişmiş Chart Çizimi (Gerçek Veri + Premium Style)
            window.renderStockChart = async function (symbol, period = '1G') {
                const canvas = document.getElementById('stock-chart-canvas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                if (!ctx) return;

                // Canvas boyutlarını ayarla
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();

                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);

                const width = rect.width;
                const height = rect.height;

                // "Yükleniyor" göster
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = 'bold 12px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Veri yükleniyor...', width / 2, height / 2);

                // Mevcut fiyatı modal'dan al (mock data için kullanılacak)
                const priceEl = document.getElementById('modal-stock-price');
                let currentPrice = 0;
                if (priceEl) {
                    const priceText = priceEl.textContent || priceEl.innerText || '0';
                    currentPrice = parseFloat(priceText.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
                }

                // Gerçek veriyi çek (current price'ı mock fallback için gönder)
                const stockData = await window.fetchHistoricalData(symbol, period, currentPrice);
                const data = stockData.prices;

                if (!data || data.length < 2) {
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillText('Veri bulunamadı', width / 2, height / 2);
                    return;
                }

                // İstatistikleri güncelle
                const formatVolume = (vol) => {
                    if (vol >= 1000000000) return (vol / 1000000000).toFixed(1) + 'B';
                    if (vol >= 1000000) return (vol / 1000000).toFixed(1) + 'M';
                    if (vol >= 1000) return (vol / 1000).toFixed(1) + 'K';
                    return vol.toString();
                };

                document.getElementById('stat-high').textContent = stockData.high.toFixed(2) + ' ₺';
                document.getElementById('stat-low').textContent = stockData.low.toFixed(2) + ' ₺';
                document.getElementById('stat-open').textContent = stockData.open.toFixed(2) + ' ₺';
                document.getElementById('stat-vol').textContent = formatVolume(stockData.volume);

                // Modal fiyatını da güncelle (priceEl already declared above)
                const changeEl = document.getElementById('modal-stock-change');
                const changeBox = document.getElementById('modal-stock-change-box');

                if (priceEl) {
                    priceEl.textContent = stockData.close.toFixed(2);
                }

                const changePercent = ((stockData.close - stockData.previousClose) / stockData.previousClose) * 100;
                const isPositive = changePercent >= 0;

                if (changeEl) {
                    changeEl.textContent = `${isPositive ? '▲' : '▼'} ${Math.abs(changePercent).toFixed(2)}%`;
                    changeEl.className = `text-lg font-bold flex items-center gap-1 ${isPositive ? 'text-emerald-500 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400'}`;
                }
                if (changeBox) {
                    changeBox.className = `px-4 py-2 rounded-xl backdrop-blur-md ${isPositive ? 'bg-emerald-500/10' : 'bg-rose-500/10'}`;
                }

                // Canvas'ı temizle
                ctx.clearRect(0, 0, width, height);

                // Normalizasyon
                const min = Math.min(...data);
                const max = Math.max(...data);
                const range = max - min || 1;
                const padding = height * 0.12;

                // Koordinatları hesapla
                const coordinates = data.map((d, i) => ({
                    x: (i / (data.length - 1)) * width,
                    y: height - padding - ((d - min) / range) * (height - 2 * padding)
                }));

                // Renk belirleme (pozitif/negatif)
                const lineColor = isPositive ? '#10b981' : '#f43f5e';
                const glowColor = isPositive ? 'rgba(16, 185, 129, 0.6)' : 'rgba(244, 63, 94, 0.6)';

                // Gradient Dolgu
                const gradient = ctx.createLinearGradient(0, 0, 0, height);
                if (isPositive) {
                    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.35)');
                    gradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.15)');
                    gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');
                } else {
                    gradient.addColorStop(0, 'rgba(244, 63, 94, 0.35)');
                    gradient.addColorStop(0.5, 'rgba(244, 63, 94, 0.15)');
                    gradient.addColorStop(1, 'rgba(244, 63, 94, 0.0)');
                }

                // Glow efekti için shadow
                ctx.shadowColor = glowColor;
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;

                // EĞRİ ÇİZİMİ (Smooth Bezier Curve)
                ctx.beginPath();
                ctx.moveTo(coordinates[0].x, coordinates[0].y);

                for (let i = 0; i < coordinates.length - 1; i++) {
                    const xc = (coordinates[i].x + coordinates[i + 1].x) / 2;
                    const yc = (coordinates[i].y + coordinates[i + 1].y) / 2;
                    ctx.quadraticCurveTo(coordinates[i].x, coordinates[i].y, xc, yc);
                }
                ctx.lineTo(coordinates[coordinates.length - 1].x, coordinates[coordinates.length - 1].y);

                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = 2.5;
                ctx.strokeStyle = lineColor;
                ctx.stroke();

                // Shadow'u kapat ve dolgu ekle
                ctx.shadowBlur = 0;

                // Dolgu için yolu kapat
                ctx.lineTo(width, height);
                ctx.lineTo(0, height);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();

                // Son noktaya "Pulse" efekti
                const lastPoint = coordinates[coordinates.length - 1];

                // Dış halka (glow)
                ctx.beginPath();
                ctx.arc(lastPoint.x, lastPoint.y, 8, 0, 2 * Math.PI);
                ctx.fillStyle = lineColor;
                ctx.globalAlpha = 0.3;
                ctx.fill();

                // Orta halka
                ctx.beginPath();
                ctx.arc(lastPoint.x, lastPoint.y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = lineColor;
                ctx.globalAlpha = 0.6;
                ctx.fill();

                // İç nokta (beyaz)
                ctx.beginPath();
                ctx.arc(lastPoint.x, lastPoint.y, 3, 0, 2 * Math.PI);
                ctx.fillStyle = '#ffffff';
                ctx.globalAlpha = 1.0;
                ctx.fill();

                // Veri kaynağı göstergesi (mock ise)
                if (stockData.isMock) {
                    ctx.globalAlpha = 0.4;
                    ctx.fillStyle = '#fff';
                    ctx.font = '9px Inter, sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText('Demo veri', width - 8, height - 8);
                    ctx.globalAlpha = 1.0;
                }
            };

            // Sayfa yüklendiğinde stock listesini doldur
            // Sayfa yüklendiğinde stock listesini doldur
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(window.populateStockList, 1000);

                // Hisse Arama Event Listener
                const searchInput = document.getElementById('stock-search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', function (e) {
                        clearTimeout(window.stockSearchTimeout);
                        window.stockSearchTimeout = setTimeout(() => {
                            if (window.filterStocks) window.filterStocks(e.target.value);
                        }, 300);
                    });

                    // (X) Clean button logic if needed (optional enhancement)
                    // If the input has a sibling clear button, we would attach it here.
                }
            });

            window.calculatePortfolio = function (data) {
                const portfolio = {
                    'Dolar': { qty: 0, cost: 0, currentVal: 0, rate: liveRates.USD },
                    'Euro': { qty: 0, cost: 0, currentVal: 0, rate: liveRates.EUR },
                    'Altın Gr.': { qty: 0, cost: 0, currentVal: 0, rate: liveRates.GRAM },
                    'Çeyrek Altın': { qty: 0, cost: 0, currentVal: 0, rate: liveRates.QUARTER },
                    'Diğer Yatırımlar': { qty: 0, cost: 0, currentVal: 0, rate: 1 }
                };
                let totalValue = 0;

                data.forEach(t => {
                    // PATCH: isSavingsTransaction(t) kullanarak tek kaynak sınıflandırma
                    if (t.type === 'expense' && isSavingsTransaction(t)) {
                        const amount = parseFloat(t.amount) || 0;
                        const unit = parseFloat(t.unitAmount) || 0;
                        let key = 'Diğer Yatırımlar';
                        // Kullanıcının isteği üzerine Altın/Çeyrek kontrol sırası düzeltildi
                        if (t.category.includes('Dolar')) key = 'Dolar';
                        else if (t.category.includes('Euro')) key = 'Euro';
                        else if (t.category.includes('Çeyrek')) key = 'Çeyrek Altın'; // Önce Çeyrek Altın'ı yakalar
                        else if (t.category.includes('Altın') || t.category.includes('Altın Gr.')) key = 'Altın Gr.'; // Sonra genel Altın'ı yakalar

                        if (portfolio[key]) {
                            portfolio[key].cost += amount;
                            if (unit > 0) {
                                portfolio[key].qty += unit;
                            } else {
                                const rate = typeof portfolio[key].rate === 'number' ? portfolio[key].rate : parseFloat(portfolio[key].rate);
                                if (rate > 0 && key !== 'Diğer Yatırımlar') portfolio[key].qty += amount / rate;
                            }
                        }
                    }
                });

                for (const [key, item] of Object.entries(portfolio)) {
                    const rate = typeof item.rate === 'number' ? item.rate : parseFloat(item.rate);
                    if (key === 'Diğer Yatırımlar') item.currentVal = item.cost;
                    else item.currentVal = item.qty * rate;
                    if (item.currentVal > 0) totalValue += item.currentVal;
                }
                return { items: portfolio, totalValue: totalValue };
            };

            window.openSavingsDetail = function () {
                const modal = document.getElementById('savings-detail-modal');
                const listEl = document.getElementById('savings-assets-list');
                const totalEl = document.getElementById('savings-center-text').querySelector('span:last-child');
                const canvas = document.getElementById('savingsChart');

                if (!modal || !listEl) return;

                modal.classList.remove('hidden');

                const portfolioData = window.calculatePortfolio(window.transactions || []);

                // Animasyonlu Sayı Artışı (Counter Up)
                const targetValue = portfolioData.totalValue;
                let startValue = 0;
                const duration = 1000;
                const startTime = performance.now();

                function updateCounter(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // EaseOutExpo Interp
                    const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);

                    const current = startValue + (targetValue - startValue) * ease;
                    totalEl.textContent = current.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺';

                    if (progress < 1) {
                        requestAnimationFrame(updateCounter);
                    }
                }
                requestAnimationFrame(updateCounter);


                const labels = [];
                const data = [];
                // Cyberpunk Neon Gradients
                const colors = [
                    ['#22d3ee', '#0891b2'], // Cyan
                    ['#818cf8', '#4f46e5'], // Indigo
                    ['#f472b6', '#db2777'], // Pink
                    ['#34d399', '#059669'], // Emerald
                    ['#facc15', '#ca8a04']  // Yellow
                ];

                listEl.innerHTML = '';
                let colorIdx = 0;

                const sortedItems = Object.entries(portfolioData.items).sort((a, b) => b[1].currentVal - a[1].currentVal);

                for (const [key, item] of sortedItems) {
                    if (item.currentVal > 0 || item.qty > 0) {
                        labels.push(key);
                        data.push(item.currentVal);

                        const colorPair = colors[colorIdx % colors.length];
                        const percent = (item.currentVal / portfolioData.totalValue) * 100;

                        let unitLabel = ''; // Basit birim kontrolü
                        if (key === 'Dolar') unitLabel = 'USD';
                        else if (key === 'Euro') unitLabel = 'EUR';
                        else if (key.includes('Altın')) unitLabel = 'Gr';

                        const qtyDisplay = item.qty > 0 ? `${item.qty.toLocaleString('tr-TR', { maximumFractionDigits: 2 })} ${unitLabel}` : '';
                        const profitLoss = item.currentVal - item.cost;
                        const isProfit = profitLoss >= 0;

                        // PATCH: Swipe-to-delete container (iOS Reveal Animation)
                        const safeKey = key.replace(/'/g, "\\'");
                        listEl.insertAdjacentHTML('beforeend', `
                        <div class="savings-swipe-row mb-3" data-asset-key="${key}">
                            <!-- Delete button (hidden until swipe) -->
                            <button class="savings-delete-btn" onclick="window.deleteSavingsAsset('${safeKey}')" type="button" aria-label="Sil">
                                <span class="savings-trash-icon">🗑️</span>
                            </button>

                            <!-- Swipeable Content Card -->
                            <div class="savings-swipe-content asset-card">
                                <div class="absolute inset-0 bg-gradient-to-r from-[${colorPair[0]}]/5 to-[${colorPair[1]}]/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                                
                                <div class="relative p-3.5 flex items-center justify-between z-10">
                                    <div class="flex items-center space-x-3">
                                        <div class="asset-icon w-11 h-11 rounded-2xl flex items-center justify-center text-xl" style="background: linear-gradient(135deg, ${colorPair[0]}22, ${colorPair[1]}22);">
                                             ${key === 'Dolar' ? '💵' : key === 'Euro' ? '💶' : key.includes('Altın') ? '🥇' : '📈'}
                                        </div>
                                        <div>
                                            <p class="text-sm font-bold asset-title tracking-wide">${key}</p>
                                            <p class="text-[10px] asset-sub font-mono">${qtyDisplay}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-bold asset-amount mb-0.5">${item.currentVal.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}₺</p>
                                        <span class="asset-badge inline-flex items-center px-1.5 py-0.5 text-[10px] font-bold ${isProfit ? 'profit' : 'loss'}">
                                            ${isProfit ? '▲' : '▼'} %${percent.toFixed(1)}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Progress Bar -->
                                <div class="asset-bar relative w-full mt-1">
                                    <div class="asset-bar-fill absolute top-0 left-0 h-full" style="width: ${percent}%; background: linear-gradient(90deg, ${colorPair[0]}, ${colorPair[1]});"></div>
                                </div>
                            </div>
                        </div>
                    `);
                        colorIdx++;
                    }
                }

                // PATCH: Swipe-to-delete handler'ı başlat
                if (typeof window.initSavingsSwipeToDelete === 'function') {
                    setTimeout(() => window.initSavingsSwipeToDelete(), 100);
                }

                if (savingsChartInstance) savingsChartInstance.destroy();

                if (data.length > 0) {
                    const ctx = canvas.getContext('2d');
                    const gradientColors = colors.map(c => {
                        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                        gradient.addColorStop(0, c[0]);
                        gradient.addColorStop(1, c[1]);
                        return gradient;
                    });

                    savingsChartInstance = new Chart(canvas, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: gradientColors,
                                borderWidth: 0,
                                borderRadius: 5,
                                hoverOffset: 10,
                                spacing: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '75%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#cbd5e1',
                                    borderColor: 'rgba(51, 65, 85, 0.5)',
                                    borderWidth: 1,
                                    padding: 10,
                                    displayColors: true,
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed !== null) {
                                                label += new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(context.parsed);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            animation: { animateScale: true, animateRotate: true }
                        }
                    });
                } else {
                    listEl.innerHTML = '<p class="text-center text-slate-500 text-xs py-10 font-mono">Veri Yok_</p>';
                }
            };

            window.closeSavingsDetail = function () { document.getElementById('savings-detail-modal').classList.add('hidden'); };

            // PATCH: Swipe-to-delete handler (iOS Reveal Animation)
            window.initSavingsSwipeToDelete = function () {
                const rows = Array.from(document.querySelectorAll('.savings-swipe-row'));
                const maxSwipe = 72; // px
                let currentOpenRow = null;

                const setRowX = (row, x, dragging) => {
                    const content = row.querySelector('.savings-swipe-content');
                    if (!content) return;

                    content.style.transform = `translate3d(${x}px,0,0)`;

                    const reveal = Math.min(Math.abs(x) / maxSwipe, 1);
                    row.style.setProperty('--swipe-reveal', reveal.toFixed(3));

                    if (dragging) row.classList.add('is-swiping');
                    else row.classList.remove('is-swiping');

                    // dataset ile mevcut x'i sakla
                    content.dataset.x = String(x);
                };

                const closeRow = (row) => {
                    row.classList.remove('is-open');
                    setRowX(row, 0, false);
                    if (currentOpenRow === row) currentOpenRow = null;
                };

                const closeAll = (exceptRow = null) => {
                    rows.forEach(r => { if (r !== exceptRow) closeRow(r); });
                };

                rows.forEach(row => {
                    const content = row.querySelector('.savings-swipe-content');
                    if (!content) return;

                    let startX = 0, startY = 0;
                    let baseX = 0;
                    let dragging = false;
                    let lock = null; // 'x' | 'y' | null

                    const onStart = (e) => {
                        // başka açık satır varsa kapat
                        if (currentOpenRow && currentOpenRow !== row) closeAll(row);

                        const t = e.touches ? e.touches[0] : e;
                        startX = t.clientX;
                        startY = t.clientY;
                        dragging = true;
                        lock = null;

                        baseX = Number(content.dataset.x || (row.classList.contains('is-open') ? -maxSwipe : 0));

                        content.style.transition = 'none';
                        row.classList.add('is-swiping');
                    };

                    const onMove = (e) => {
                        if (!dragging) return;
                        const t = e.touches ? e.touches[0] : e;

                        const dx = t.clientX - startX;
                        const dy = t.clientY - startY;

                        // eksen kilidi: dikey scroll'u koru
                        if (lock === null) {
                            if (Math.abs(dx) > Math.abs(dy) + 6) lock = 'x';
                            else if (Math.abs(dy) > Math.abs(dx) + 6) lock = 'y';
                        }
                        if (lock !== 'x') return;

                        // yatay swipe'ta sayfayı kaydırmasın
                        if (e.cancelable) e.preventDefault();

                        // sadece sola kaydırma (negatif)
                        let nextX = baseX + dx;
                        nextX = Math.min(0, Math.max(-maxSwipe, nextX));

                        setRowX(row, nextX, true);
                    };

                    const onEnd = () => {
                        if (!dragging) return;
                        dragging = false;

                        const currentX = Number(content.dataset.x || 0);

                        // "snap" animasyonu
                        content.style.transition = 'transform 260ms cubic-bezier(0.2,0.8,0.2,1)';

                        const shouldOpen = currentX < -(maxSwipe * 0.45);

                        if (shouldOpen) {
                            row.classList.add('is-open');
                            setRowX(row, -maxSwipe, false);
                            currentOpenRow = row;
                        } else {
                            closeRow(row);
                        }
                    };

                    // Touch (move passive false olmalı ki preventDefault çalışsın)
                    content.addEventListener('touchstart', onStart, { passive: true });
                    content.addEventListener('touchmove', onMove, { passive: false });
                    content.addEventListener('touchend', onEnd);

                    // Pointer (mouse)
                    content.addEventListener('pointerdown', onStart);
                    content.addEventListener('pointermove', onMove);
                    content.addEventListener('pointerup', onEnd);
                    content.addEventListener('pointercancel', onEnd);
                    content.addEventListener('pointerleave', onEnd);

                    // init state
                    row.style.setProperty('--swipe-reveal', '0');
                });

                // dışarı tıklayınca açık satırı kapat
                const outsideClose = (e) => {
                    if (!currentOpenRow) return;
                    if (!e.target.closest('.savings-swipe-row')) closeAll();
                };
                document.addEventListener('touchstart', outsideClose, { passive: true });
                document.addEventListener('pointerdown', outsideClose);
            };

            // PATCH: Asset-category eşleştirme helper
            window.matchesSavingsKey = function (category, key) {
                if (!category || !key) return false;
                const c = category.toLocaleLowerCase('tr-TR');
                const k = key.toLocaleLowerCase('tr-TR');

                // Anahtar eşleşmeleri
                const mappings = {
                    'dolar': ['dolar', 'usd', '💵'],
                    'euro': ['euro', 'eur', '💶'],
                    'gram altın': ['altın', 'gram', '🟡', 'altın gr'],
                    'çeyrek altın': ['çeyrek', '🪙'],
                    'diğer yatırımlar': ['yatırım', '📈', 'diğer']
                };

                const keywords = mappings[k] || [k];
                return keywords.some(kw => c.includes(kw));
            };

            // PATCH: Birikim varlığını sil (Themed Confirm Modal)
            window.deleteSavingsAsset = function (assetKey) {
                window.openConfirmModal({
                    title: "Silme Onayı",
                    message: `"${assetKey}" birikim işlemlerini silmek istediğinize emin misiniz?`,
                    confirmText: "Sil",
                    cancelText: "Vazgeç",
                    onConfirm: () => {
                        const originalLength = window.transactions.length;

                        window.transactions = window.transactions.filter(t => {
                            const isSavingsTx = isSavingsTransaction(t);
                            if (!isSavingsTx) return true;
                            return !window.matchesSavingsKey(t.category, assetKey);
                        });

                        const deletedCount = originalLength - window.transactions.length;

                        if (deletedCount > 0) {
                            localStorage.setItem(`my_expenses_${APP_YEAR}`, JSON.stringify(window.transactions));
                            window.processTransactions(window.transactions);
                            window.openSavingsDetail();
                            window.showMiniToast('Birikim Silindi', `${deletedCount} işlem silindi 🗑️`, '🗑️');
                        } else {
                            window.showMiniToast('Bilgi', 'Silinecek işlem bulunamadı.', 'ℹ️');
                        }
                    }
                });
            };

            window.setAppTheme = function (theme) {
                localStorage.setItem('app_theme', theme); const html = document.documentElement;
                document.querySelectorAll('.theme-option').forEach(el => { el.classList.remove('selected'); const ring = el.querySelector('.selection-ring'); if (ring) { ring.innerHTML = ''; ring.classList.remove('border-blue-500', 'bg-blue-500'); } });
                const selectedBtn = document.getElementById(`theme-${theme}`);
                if (selectedBtn) { selectedBtn.classList.add('selected'); const ring = selectedBtn.querySelector('.selection-ring'); if (ring) { ring.classList.add('border-blue-500', 'bg-blue-500'); ring.innerHTML = '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>'; } }
                if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) { html.classList.add('dark'); } else { html.classList.remove('dark'); }
                if (chartInstance) { chartInstance.options.scales.x.ticks.color = html.classList.contains('dark') ? '#9CA3AF' : '#374151'; chartInstance.update(); }
                if (categoryChartInstance) { Chart.defaults.color = html.classList.contains('dark') ? '#A1A1AA' : '#374151'; categoryChartInstance.update(); }
                if (detailedChartInstance && detailedChartInstance.options) { detailedChartInstance.options.plugins.legend.labels.color = html.classList.contains('dark') ? '#A1A1AA' : '#374151'; detailedChartInstance.options.scales.y.ticks.color = html.classList.contains('dark') ? '#A1A1AA' : '#374151'; detailedChartInstance.options.scales.x.ticks.color = html.classList.contains('dark') ? '#A1A1AA' : '#374151'; detailedChartInstance.update(); }
                if (savingsChartInstance && savingsChartInstance.options) { savingsChartInstance.options.plugins.legend.labels.color = html.classList.contains('dark') ? '#A1A1AA' : '#374151'; savingsChartInstance.update(); }
            };

            window.updateModalPreview = function (content) {
                const previewContainer = document.getElementById('modal-profile-avatar'); if (!previewContainer) return; previewContainer.innerHTML = '';
                if (content && content.startsWith('http')) {
                    const img = document.createElement('img'); img.src = content; img.className = 'w-full h-full object-contain p-2 rounded-full';
                    previewContainer.appendChild(img); previewContainer.classList.remove('text-3xl', 'font-bold');
                } else {
                    previewContainer.textContent = content || '?';
                    previewContainer.classList.add('text-3xl', 'font-bold');
                }
            };

            window.updateProfileUI = function (name, title, avatar) {
                const greetingEl = document.getElementById('user-greeting'); let greetingText = "Günaydın"; const hour = new Date().getHours(); if (hour >= 6 && hour < 11) greetingText = "Günaydın"; else if (hour >= 11 && hour < 17) greetingText = "Mutlu Günler"; else if (hour >= 17 && hour < 22) greetingText = "İyi Akşamlar"; else greetingText = "İyi Geceler";
                const emojis = ['🚀', '✨', '👋', '🌟', '💼', '🔥', '🦁', '💎']; const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)]; const displayName = (name === 'Patron' || !name) ? 'Misafir' : name;
                if (greetingEl) greetingEl.innerHTML = `${greetingText}, ${displayName} ${randomEmoji}`;

                const displayContent = avatar || (displayName ? displayName.charAt(0).toUpperCase() : 'P'); const headerAvatar = document.getElementById('profile-avatar-text');
                // Premium avatar kontrolü - GitHub Fluent Emojis URL'leri premium
                const isPremiumAvatar = displayContent && displayContent.includes('github') && displayContent.includes('Fluent');

                if (headerAvatar) {
                    headerAvatar.innerHTML = '';
                    if (displayContent.startsWith('http')) {
                        if (isPremiumAvatar) {
                            // Premium avatarlar için 3D Pop-Out efekti
                            const wrapper = document.createElement('div');
                            wrapper.className = 'avatar-pop-wrapper';
                            const img = document.createElement('img');
                            img.src = displayContent;
                            img.className = 'avatar-pop-img';
                            img.alt = 'Premium Avatar';
                            wrapper.appendChild(img);
                            headerAvatar.appendChild(wrapper);
                            headerAvatar.classList.remove('font-bold', 'text-lg', 'overflow-hidden');
                        } else {
                            // Free avatarlar için normal görünüm
                            const img = document.createElement('img');
                            img.src = displayContent;
                            img.className = 'w-full h-full object-cover rounded-full';
                            img.alt = 'Avatar';
                            headerAvatar.appendChild(img);
                            headerAvatar.classList.remove('font-bold', 'text-lg');
                            headerAvatar.classList.add('overflow-hidden');
                        }
                    } else {
                        headerAvatar.innerHTML = `<span class="avatar-pop-fallback">${displayContent}</span>`;
                        headerAvatar.classList.add('font-bold', 'text-lg');
                    }
                }
                window.updateModalPreview(displayContent);

                const isPro = userStatus === 'pro'; const planBadge = document.getElementById('user-plan-badge'); const upgradeBtn = document.getElementById('btn-header-upgrade'); const excelLock = document.getElementById('lock-icon-excel'); const aiLock = document.getElementById('lock-icon-assistant');
                if (planBadge) {
                    planBadge.innerHTML = isPro
                        ? '<span class="relative z-10 flex items-center gap-1"><span class="animate-pulse">👑</span>PRO</span><div class="absolute inset-0 shimmer opacity-50"></div>'
                        : '<span class="relative z-10 flex items-center gap-1"><span class="animate-pulse">✨</span>FREE</span><div class="absolute inset-0 shimmer opacity-50"></div>';
                    planBadge.style.cssText = isPro
                        ? 'background: linear-gradient(135deg, #f59e0b, #ea580c); color: white; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255,255,255,0.3); cursor: default;'
                        : 'background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; box-shadow: 0 4px 15px var(--accent-glow), inset 0 1px 0 rgba(255,255,255,0.3);';
                    planBadge.onclick = isPro ? null : function () { document.getElementById('premium-modal').classList.remove('hidden'); };
                }
                if (upgradeBtn) { if (isPro) upgradeBtn.classList.add('hidden'); else upgradeBtn.classList.remove('hidden'); }
                if (excelLock) { if (isPro) excelLock.classList.add('hidden'); else excelLock.classList.remove('hidden'); }
                if (aiLock) { if (isPro) aiLock.classList.add('hidden'); else aiLock.classList.remove('hidden'); }
            };

            window.initTheme = function () {
                const saved = localStorage.getItem('app_theme') || 'system';
                window.setAppTheme(saved);
                const name = localStorage.getItem('user_name') || 'Misafir';
                const title = localStorage.getItem('user_title') || 'Patron 🚀';
                const avatar = localStorage.getItem('user_avatar');
                window.updateProfileUI(name, title, avatar);
            };

            window.renderAvatarGrid = function () {
                const container = document.getElementById('avatar-selection');
                if (!container) return;
                container.innerHTML = '';

                // Microsoft Fluent 3D Premium Avatar Listesi
                const avatars = [
                    // --- ÜCRETSİZ (Free) - Temel Karakterler ---
                    { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140057.png', premium: false }, // Erkek 5
                    { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png', premium: false }, // Erkek 1
                    { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140048.png', premium: false }, // Erkek 2
                    { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140061.png', premium: false }, // Erkek 3
                    { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140039.png', premium: false }, // Erkek 4
                    { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140047.png', premium: false }, // Kadın 1
                    { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140060.png', premium: false }, // Kadın 2
                    { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140040.png', premium: false }, // Kadın 3
                    { url: 'https://cdn-icons-png.flaticon.com/512/1154/1154473.png', premium: false }, // Çocuk
                    { url: 'https://cdn-icons-png.flaticon.com/512/1154/1154448.png', premium: false }, // Kız

                    // --- PREMIUM (Pro Üyelere Açık) - 3D Profesyonel Karakterler ---
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Black%20Bird.png', premium: true }, // Black Bird
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Cowboy%20Hat%20Face.png', premium: true }, // Cowboy Hat Face
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Robot.png', premium: true }, // Robot
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Bear.png', premium: true }, // Bear
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Clown%20Face.png', premium: true }, // Clown Face
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Skull.png', premium: true }, // Skull
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Dog%20Face.png', premium: true }, // Dog Face
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Cow%20Face.png', premium: true }, // Cow Face
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Fox.png', premium: true }, // Tilki 🦊
                    { url: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Alien.png', premium: true } // Uzaylı 👽
                ];

                const isPro = userStatus === 'pro';

                avatars.forEach(av => {
                    const btn = document.createElement('button');
                    const isLocked = av.premium && !isPro;
                    const isSelected = selectedAvatar === av.url;

                    // DÜZELTME: 'overflow-hidden' sınıfı ana butondan kaldırıldı!
                    // w-14 h-14: Avatarları biraz büyüttük
                    let classes = "relative w-14 h-14 rounded-full flex items-center justify-center transition-all duration-300 border-2 group ";

                    if (isSelected) {
                        // Seçili ise Premium Gold/Neon glow efekti
                        classes += "border-indigo-600 ring-2 ring-indigo-300 transform scale-110 z-10 bg-white shadow-lg avatar-selected-glow";
                    } else {
                        // Seçili değilse hover efekti
                        classes += "border-transparent bg-gray-50 dark:bg-white/10 hover:scale-110 hover:bg-white hover:shadow-md";
                    }

                    if (isLocked) {
                        // Kilitli ise soluk ve siyah-beyaz
                        classes += " opacity-70 grayscale cursor-not-allowed";
                    } else {
                        classes += " cursor-pointer";
                    }

                    btn.className = classes;

                    // --- İç Kapsayıcı (Resim ve Kilit için) ---
                    // DÜZELTME: Resmin dışarı taşmaması için overflow-hidden buraya eklendi.
                    const innerContainer = document.createElement('div');
                    innerContainer.className = "w-full h-full rounded-full overflow-hidden relative flex items-center justify-center";

                    // --- Resim (Premium 3D stilinde) ---
                    const img = document.createElement('img');
                    img.src = av.url;
                    img.className = "w-full h-full object-cover p-0.5 premium-avatar-img"; // 3D gölge efekti
                    img.alt = 'Avatar';
                    img.loading = 'lazy';
                    innerContainer.appendChild(img);

                    // KİLİT (İçeride kalmalı)
                    if (isLocked) {
                        const lockOverlay = document.createElement('div');
                        lockOverlay.className = "absolute inset-0 flex items-center justify-center z-20 bg-black/50 backdrop-blur-[1px]";
                        lockOverlay.innerHTML = '<span class="text-white text-sm drop-shadow-md">🔒</span>';
                        innerContainer.appendChild(lockOverlay);
                    }

                    // İç kapsayıcıyı butona ekle
                    btn.appendChild(innerContainer);

                    // --- TAÇ (Dışarıda kalmalı) ---
                    // DÜZELTME: Taç artık innerContainer'ın değil, btn'nin (ana kapsayıcı) çocuğu.
                    // overflow-hidden olmadığı için dışarı taşabilir.
                    if (av.premium && isPro) {
                        const crown = document.createElement('div');
                        // Konumlandırma: -top-1 ve -right-1 ile dışarı taşırdık
                        crown.className = "absolute -top-1 -right-1 w-5 h-5 bg-gradient-to-br from-yellow-300 to-orange-400 rounded-full flex items-center justify-center border border-white dark:border-gray-800 shadow-sm z-30";
                        crown.innerHTML = '<span class="text-[10px]">👑</span>';
                        btn.appendChild(crown);
                    }

                    // --- Tıklama Olayı ---
                    btn.onclick = (e) => {
                        e.preventDefault();
                        if (isLocked) {
                            // Kilitliyse Premium Modalını Aç
                            const pModal = document.getElementById('premium-modal');
                            if (pModal) {
                                pModal.classList.remove('hidden');
                                window.toggleProfileModal(false); // Profil modalını kapat
                            }
                            // Butonu salla (Hayır efekti)
                            btn.classList.add('animate-pulse');
                            setTimeout(() => btn.classList.remove('animate-pulse'), 500);
                        } else {
                            // Açık ise Seç
                            selectedAvatar = av.url;
                            window.renderAvatarGrid();
                            window.updateModalPreview(av.url);
                        }
                    };

                    container.appendChild(btn);
                });
            };

            window.switchProfileTab = function (tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                const targetContent = document.getElementById(`profile-tab-${tabName}`);
                const targetButton = document.getElementById(`tab-${tabName}`);
                if (targetContent) targetContent.classList.remove('hidden');
                if (targetButton) targetButton.classList.add('active');
            };

            // ═══════════════════════════════════════════════════════════════
            // FİNANS ARAÇLARI MODAL FONKSİYONLARI
            // ═══════════════════════════════════════════════════════════════

            // Döviz Çevirici Modal
            window.openCurrencyModal = function () {
                const modal = document.getElementById('currency-converter-modal');
                if (modal) modal.classList.remove('hidden');
            };

            window.closeCurrencyModal = function () {
                const modal = document.getElementById('currency-converter-modal');
                if (modal) modal.classList.add('hidden');
            };

            window.calculateModalCurrency = function () {
                const amount = window.parseSimpleCurrency(document.getElementById('modal-currency-amount')?.value);
                const from = document.getElementById('modal-currency-from')?.value || 'TRY';
                const to = document.getElementById('modal-currency-to')?.value || 'USD';
                const resultEl = document.getElementById('modal-currency-result');

                // Kurları al (liveRates global değişkeninden)
                const rates = {
                    'USD': liveRates.USD || 34.50,
                    'EUR': liveRates.EUR || 37.50,
                    'GBP': liveRates.GBP || 44.20,
                    'TRY': 1
                };

                const fromRate = rates[from] || 1;
                const toRate = rates[to] || 1;

                const result = (amount * fromRate) / toRate;

                if (resultEl) {
                    const symbolMap = { 'TRY': '₺', 'USD': '$', 'EUR': '€', 'GBP': '£' };
                    const symbol = symbolMap[to] || to;
                    resultEl.textContent = result.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ' + symbol;
                }
            };

            // Kredi Hesaplama Modal
            window.openLoanModal = function () {
                const modal = document.getElementById('loan-calculator-modal');
                if (modal) modal.classList.remove('hidden');
            };

            window.closeLoanModal = function () {
                const modal = document.getElementById('loan-calculator-modal');
                if (modal) modal.classList.add('hidden');
            };

            window.calculateModalLoan = function () {
                // Noktaları temizle (binlik ayırıcı) ve sayıya çevir
                const principal = window.parseSimpleCurrency(document.getElementById('modal-loan-principal')?.value);
                const annualRate = parseFloat(document.getElementById('modal-loan-rate')?.value) || 0;
                const term = parseInt(document.getElementById('modal-loan-term')?.value) || 1;

                const monthlyEl = document.getElementById('modal-loan-monthly');
                const totalEl = document.getElementById('modal-loan-total');
                const interestEl = document.getElementById('modal-loan-interest');

                // Aylık faiz oranı
                const monthlyRate = annualRate / 100;

                // Taksit formülü: P * r * (1+r)^n / ((1+r)^n - 1)
                let monthlyPayment = 0;
                if (monthlyRate > 0) {
                    const factor = Math.pow(1 + monthlyRate, term);
                    monthlyPayment = principal * monthlyRate * factor / (factor - 1);
                } else {
                    monthlyPayment = principal / term;
                }

                const totalPayment = monthlyPayment * term;
                const totalInterest = totalPayment - principal;

                const fmt = (val) => val.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ₺';

                if (monthlyEl) monthlyEl.textContent = fmt(monthlyPayment);
                if (totalEl) totalEl.textContent = fmt(totalPayment);
                if (interestEl) interestEl.textContent = fmt(totalInterest);
            };

            // PATCH: Dynamic --app-vh calculation for iOS Safari
            window.updateAppVH = function () {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--app-vh', `${vh}px`);
            };
            window.updateAppVH();
            window.addEventListener('resize', window.updateAppVH);
            window.addEventListener('orientationchange', () => setTimeout(window.updateAppVH, 100));

            // PATCH: Class-based modal scroll lock (more stable on iOS)
            window.toggleProfileModal = function (show) {
                const modal = document.getElementById('profile-modal'); if (!modal) return;

                // PATCH: Use class-based scroll lock instead of inline styles
                if (show) {
                    document.body.classList.add('modal-open');
                    window.updateAppVH(); // Recalculate on modal open
                } else {
                    document.body.classList.remove('modal-open');
                }

                if (show) {
                    const pName = document.getElementById('profile-name'); if (pName) pName.value = localStorage.getItem('user_name') || 'Misafir';
                    selectedAvatar = localStorage.getItem('user_avatar') || null;
                    window.renderAvatarGrid();
                    window.renderBadges();
                    window.switchProfileTab('info');
                }
                modal.classList.toggle('hidden', !show);
                // Fallback for safety
                modal.style.display = show ? 'flex' : 'none';
            };

            window.saveProfile = function () {
                const nameEl = document.getElementById('profile-name');
                const name = nameEl ? nameEl.value : '';
                if (name) localStorage.setItem('user_name', name);
                if (selectedAvatar) localStorage.setItem('user_avatar', selectedAvatar);
                window.updateProfileUI(name || 'Misafir', null, selectedAvatar);
                window.toggleProfileModal(false);
            };

            window.toggleThemeModal = function (show) { const el = document.getElementById('theme-modal'); if (el) el.classList.toggle('hidden', !show); };

            window.updateCategoryOptions = function () {
                const s = document.getElementById('input-category'); if (!s) return;
                s.innerHTML = '';
                categories[currentType].forEach(c => {
                    const o = document.createElement('option'); o.value = c; o.text = c; s.appendChild(o);
                });
            };

            window.updateHeaderDate = function () {
                const d = new Date();
                const opts = { weekday: 'long', day: 'numeric', month: 'long' };
                const el = document.getElementById('header-date'); if (el) el.innerText = d.toLocaleDateString('tr-TR', opts);
            };

            window.updatePeriodDisplay = function () {
                const label = document.getElementById('current-period-label'); if (!label) return;
                if (viewScope === 'month') label.textContent = currentDate.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
                else label.textContent = currentDate.getFullYear();
            };

            window.updateNavIndicator = function (targetBtnId) {
                const indicator = document.getElementById('nav-indicator');
                const nav = document.getElementById('main-nav');
                if (!targetBtnId || targetBtnId === 'nav-add') {
                    if (indicator) { indicator.style.opacity = '0'; indicator.style.transform = `translateY(-50%) scale(0.5)`; }
                    return;
                }
                const targetBtn = document.getElementById(targetBtnId); if (!targetBtn || !nav) return;
                const navRect = nav.getBoundingClientRect();
                const btnRect = targetBtn.getBoundingClientRect();
                const leftPos = btnRect.left - navRect.left + (btnRect.width / 2) - (52 / 2);
                if (indicator) { indicator.style.opacity = '1'; indicator.style.transform = `translate3d(${leftPos}px, -50%, 0) scale(1)`; }
            };

            // iOS 26 Enhanced Liquid Glass Blob - Ultra Realistic Physics
            window.__blobLastPosition = null;
            window.__blobVelocity = 0;
            window.__blobAnimationFrame = null;

            window.updateLiquidBlob = function (targetBtnId) {
                const blob = document.getElementById('nav-liquid-blob');
                const nav = document.getElementById('main-nav');

                if (!blob || !nav) return;

                // Ekle butonu seçildiğinde blob'u gizle (Yeni İşlem ekranı)
                if (!targetBtnId || targetBtnId === 'nav-add') {
                    blob.classList.add('blob-hidden');
                    blob.style.opacity = '0';
                    blob.style.transform = 'translateY(-50%) scale(0.7)';
                    window.__blobLastPosition = null;
                    return;
                }

                // Blob'u tekrar göster
                blob.classList.remove('blob-hidden', 'stretch-left', 'stretch-right', 'wobbling', 'settling', 'fast-move');

                const targetBtn = document.getElementById(targetBtnId);
                if (!targetBtn) return;

                const navRect = nav.getBoundingClientRect();
                const btnRect = targetBtn.getBoundingClientRect();

                // Yeni pozisyon hesapla
                const newLeftPos = btnRect.left - navRect.left + (btnRect.width / 2) - 28; // 56/2 = 28
                const currentLeft = parseFloat(blob.style.left) || newLeftPos;

                // Hareket yönünü ve hızını hesapla
                const deltaX = newLeftPos - currentLeft;
                const isMovingRight = deltaX > 5;
                const isMovingLeft = deltaX < -5;
                const speed = Math.abs(deltaX);
                const isFastMove = speed > 80;

                // Önceki pozisyonu kaydet
                window.__blobLastPosition = currentLeft;
                window.__blobVelocity = deltaX;

                // Hareket varsa yön bazlı stretch uygula
                if (isMovingRight || isMovingLeft) {
                    // Hızlı harekette blur ekle
                    if (isFastMove) {
                        blob.classList.add('fast-move');
                    }

                    // Yön bazlı stretch
                    if (isMovingRight) {
                        blob.classList.add('stretch-right');
                    } else {
                        blob.classList.add('stretch-left');
                    }

                    // Geçiş animasyonu - hıza bağlı süre
                    const transitionDuration = Math.max(0.25, Math.min(0.5, 300 / speed));
                    blob.style.transition = `left ${transitionDuration}s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.3s ease`;
                } else {
                    blob.style.transition = 'left 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease';
                }

                // Blob'u hareket ettir
                blob.style.opacity = '1';
                blob.style.left = `${newLeftPos}px`;

                // Geçiş tamamlandıktan sonra stretch'i kaldır ve wobble ekle
                const settleDelay = (isMovingRight || isMovingLeft) ?
                    Math.max(150, Math.min(350, 200 + speed * 0.5)) : 200;

                // Önceki animation frame'i iptal et
                if (window.__blobAnimationFrame) {
                    cancelAnimationFrame(window.__blobAnimationFrame);
                }

                setTimeout(() => {
                    blob.classList.remove('stretch-left', 'stretch-right', 'fast-move');

                    // Hız yeterliyse wobble animasyonu
                    if (speed > 30 && !window.__navDraggingNow) {
                        blob.classList.add('wobbling');

                        setTimeout(() => {
                            blob.classList.remove('wobbling');
                            blob.classList.add('settling');

                            setTimeout(() => {
                                blob.classList.remove('settling');
                            }, 500);
                        }, 700);
                    } else if (!window.__navDraggingNow) {
                        // Yavaş harekette sadece settle
                        blob.classList.add('settling');
                        setTimeout(() => {
                            blob.classList.remove('settling');
                        }, 500);
                    }
                }, settleDelay);

                // --- Enhanced 3D Spring Animation ---
                if (!window.__navDraggingNow && blob.animate && speed > 10) {
                    // Hıza bağlı scale animasyonu
                    const scaleIntensity = Math.min(0.12, speed / 800);

                    blob.animate([
                        { transform: `translateY(-50%) scale(${1 - scaleIntensity}, ${1 + scaleIntensity})` },
                        { transform: `translateY(-50%) scale(${1 + scaleIntensity * 0.6}, ${1 - scaleIntensity * 0.6})` },
                        { transform: `translateY(-50%) scale(${1 - scaleIntensity * 0.3}, ${1 + scaleIntensity * 0.3})` },
                        { transform: 'translateY(-50%) scale(1)' }
                    ], {
                        duration: 600 + speed,
                        easing: 'cubic-bezier(0.22, 1, 0.36, 1)',
                        fill: 'forwards'
                    });
                }
            };


            // Sayfa yüklendiğinde blob'u başlat
            window.initLiquidBlob = function () {
                const activeItem = document.querySelector('.nav-item.active');
                if (activeItem) {
                    // İlk yüklemede animasyon olmadan başlat
                    const blob = document.getElementById('nav-liquid-blob');
                    const nav = document.getElementById('main-nav');
                    if (blob && nav && activeItem) {
                        const navRect = nav.getBoundingClientRect();
                        const btnRect = activeItem.getBoundingClientRect();
                        const leftPos = btnRect.left - navRect.left + (btnRect.width / 2) - 28;
                        blob.style.transition = 'none';
                        blob.style.left = `${leftPos}px`;
                        blob.style.opacity = '1';
                        blob.style.transform = 'translateY(-50%) scale(1)';
                        window.__blobLastPosition = leftPos;

                        // Transition'ı geri aç
                        setTimeout(() => {
                            blob.style.transition = 'left 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease';
                        }, 50);
                    }
                }
            };

            // === iOS 26 DRAG LIQUID GLASS NAVİGASYON ===
            window.initDragNavigation = function () {
                const navContainer = document.querySelector('.fixed.bottom-6');
                const nav = document.getElementById('main-nav');
                const blob = document.getElementById('nav-liquid-blob');
                if (!nav || !blob || !navContainer) return;

                let isDragging = false;
                let isPressed = false;
                let startX = 0;
                let currentX = 0;
                const DRAG_THRESHOLD = 10;
                const navItems = Array.from(nav.querySelectorAll('.nav-item'));

                // Tab pozisyonlarını hesapla
                const getNavItemPositions = () => {
                    const navRect = nav.getBoundingClientRect();
                    return navItems.map(item => {
                        const rect = item.getBoundingClientRect();
                        return {
                            id: item.id,
                            center: rect.left - navRect.left + rect.width / 2,
                            left: rect.left - navRect.left,
                            width: rect.width
                        };
                    });
                };

                // En yakın tab'ı bul
                const findNearestTab = (x) => {
                    const positions = getNavItemPositions();
                    let nearest = positions[0];
                    let minDistance = Math.abs(x - nearest.center);

                    positions.forEach(pos => {
                        const distance = Math.abs(x - pos.center);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearest = pos;
                        }
                    });
                    return nearest;
                };

                // Sürükleme başlat
                const startDrag = (e) => {
                    if (e.target.closest('#nav-add')) return; // Ekle butonu hariç

                    isPressed = true;
                    isDragging = false;
                    window.__navDraggingNow = true; // Drag flag set
                    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    currentX = startX; // Initialize immediately

                    // Do not apply drag classes yet
                    blob.style.transition = 'all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
                };

                // Sürükleme devam
                const moveDrag = (e) => {
                    if (!isPressed) return;

                    currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    const deltaX = Math.abs(currentX - startX);

                    // Threshold Check
                    if (!isDragging && deltaX > DRAG_THRESHOLD) {
                        isDragging = true;
                        navContainer.classList.add('nav-dragging');
                        blob.classList.add('drag-active');
                        blob.style.transition = 'none'; // Instant control
                    }

                    if (!isDragging) return; // Still a tap

                    // Active Drag
                    if (e.cancelable) e.preventDefault();

                    const navRect = nav.getBoundingClientRect();
                    const relativeX = currentX - navRect.left;

                    // Blob'u parmak pozisyonuna taşı
                    const blobWidth = 56;
                    let newLeft = relativeX - blobWidth / 2;

                    // Sınırları kontrol et
                    newLeft = Math.max(8, Math.min(newLeft, navRect.width - blobWidth - 8));

                    blob.style.left = `${newLeft}px`;

                    // En yakın tab'ı vurgula
                    const nearest = findNearestTab(relativeX);
                    navItems.forEach(item => {
                        if (item.id === nearest.id && item.id !== 'nav-add') {
                            item.classList.add('active');
                        } else if (item.id !== 'nav-add') {
                            item.classList.remove('active');
                        }
                    });
                };

                // Sürükleme bitir
                const endDrag = (e) => {
                    if (!isPressed) return;
                    isPressed = false;
                    window.__navDraggingNow = false; // Drag flag reset

                    if (!isDragging) {
                        // Tap handling is left to native click events
                        return;
                    }

                    isDragging = false;
                    navContainer.classList.remove('nav-dragging');
                    blob.classList.remove('drag-active');
                    blob.style.transition = 'all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';

                    // En yakın tab'a snap yap
                    const navRect = nav.getBoundingClientRect();
                    const relativeX = currentX - navRect.left;
                    const nearest = findNearestTab(relativeX);

                    // Tab'ı değiştir
                    if (nearest.id && nearest.id !== 'nav-add') {
                        const tabName = nearest.id.replace('nav-', '');
                        window.switchTab(tabName);
                    }
                };

                // Event listeners
                nav.addEventListener('mousedown', startDrag);
                nav.addEventListener('touchstart', startDrag, { passive: true });

                document.addEventListener('mousemove', moveDrag);
                document.addEventListener('touchmove', moveDrag, { passive: false });

                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
            };

            // DOM hazır olduğunda başlat
            setTimeout(() => {
                window.initLiquidBlob && window.initLiquidBlob();
                window.initDragNavigation && window.initDragNavigation();
            }, 500);

            window.formatAmount = function (input) {
                let value = input.value;
                if (value.endsWith('.')) { value = value.substring(0, value.length - 1) + ','; }
                value = value.replace(/\./g, '').replace(/[^0-9,]/g, '');
                let parts = value.split(',');
                if (parts.length > 2) { value = parts[0] + ',' + parts.slice(1).join(''); parts = value.split(','); }
                let integerPart = parts[0];
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                let decimalPart = parts.length > 1 ? ',' + parts[1].substring(0, 2) : '';
                input.value = integerPart + decimalPart;
            };

            // YENİ: Hisse Senedi Arama ve Render Fonksiyonları
            window.cachedStockData = [];

            window.renderStocks = function (stocks) {
                const container = document.getElementById('stock-list-container');
                if (!container) return;

                container.innerHTML = '';

                if (!stocks || stocks.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-2 text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
                            Aradığınız hisse bulunamadı.
                        </div>
                    `;
                    return;
                }

                // Sayı formatı (render fonksiyonu içinde yeniden tanımlandı)
                const fmt = (val) => parseFloat(val).toLocaleString('tr-TR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) + ' ₺';

                stocks.forEach(stock => {
                    const price = stock.lastprice;
                    const change = parseFloat(stock.rate);
                    const symbol = stock.code;

                    const isPositive = change >= 0;
                    const colorClass = isPositive ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400';
                    const bgClass = isPositive ? 'bg-emerald-100/50 dark:bg-emerald-900/30' : 'bg-rose-100/50 dark:bg-rose-900/30';
                    const shadowClass = isPositive ? 'shadow-emerald-500/10' : 'shadow-rose-500/10';
                    const arrow = isPositive ? '▲' : '▼';

                    container.insertAdjacentHTML('beforeend', `
                    <div class="group relative overflow-hidden glass-card rounded-2xl p-3 flex flex-col justify-between w-full border border-white/40 dark:border-white/10 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl ${shadowClass}">
                        <div class="absolute bottom-0 left-0 w-full h-1 ${isPositive ? 'bg-emerald-500' : 'bg-rose-500'} opacity-60"></div>
                        
                        <div class="flex items-center justify-between w-full mb-2">
                            <span class="text-xs font-black text-gray-700 dark:text-gray-200 tracking-wider">${symbol}</span>
                            <div class="flex items-center px-2 py-1 rounded-lg ${bgClass} backdrop-blur-md">
                                <span class="text-[9px] font-bold ${colorClass} flex items-center gap-1">
                                    ${arrow} %${Math.abs(change).toFixed(2)}
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex items-end justify-between">
                            <div>
                                <p class="text-[9px] text-gray-400 font-medium mb-0.5">Son Fiyat</p>
                                <p class="text-lg font-black text-gray-900 dark:text-white tracking-tight leading-none">${fmt(price)}</p>
                            </div>
                            <div class="text-2xl opacity-10 grayscale group-hover:grayscale-0 group-hover:opacity-20 transition-all duration-500 transform group-hover:scale-110">
                                ${isPositive ? '📈' : '📉'}
                            </div>
                        </div>
                    </div>
                `);
                });
            };

            window.initStockSearch = function () {
                const searchInput = document.getElementById('stock-search-input');
                if (searchInput) {
                    // Prevent multiple listeners
                    if (searchInput.dataset.hasSearchListener) return;

                    searchInput.addEventListener('input', function (e) {
                        const query = e.target.value.toLowerCase().trim();
                        if (query === '') {
                            window.renderStocks(window.cachedStockData);
                            return;
                        }

                        const filtered = window.cachedStockData.filter(stock =>
                            stock.code.toLowerCase().includes(query)
                        );
                        window.renderStocks(filtered);
                    });

                    searchInput.dataset.hasSearchListener = 'true';
                }
            };

            window.fetchMarketData = async function () {
                marketDataLoaded = true;
                const btn = document.getElementById('refresh-market-btn');
                if (btn) btn.classList.add('animate-spin');

                // Skeleton Loading (YENİ)
                const stockContainer = document.getElementById('stock-list-container');
                if (stockContainer) {
                    stockContainer.innerHTML = Array(6).fill(0).map(() => `
                    <div class="bg-white/50 dark:bg-gray-800/50 p-2.5 rounded-xl flex items-center justify-between animate-pulse">
                        <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-1/3"></div>
                        <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-1/4"></div>
                    </div>
                `).join('');
                }

                // Sayıları formatlar (Örn: 12.50 ₺)
                const fmt = (val) => parseFloat(val).toLocaleString('tr-TR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) + ' ₺';

                // API Anahtarı
                const myApiKey = "apikey 6mI4Lm64CgIRb1718GWOF2:45iWRdsxagjzfC0l9TF29r";

                try {
                    // --- A. DÖVİZ VERİLERİ (Genelpara - Embed API - Stabil) ---
                    try {
                        const dovizResponse = await fetch("https://api.genelpara.com/embed/para-birimleri.json");
                        const data = await dovizResponse.json();

                        // Helper: Parse Turkish Money Format (2.345,67 -> 2345.67)
                        // Genelpara bazen nokta (binlik) bazen sadece virgül (kuruş) kullanır.
                        const parseVal = (v) => {
                            if (!v) return 0;
                            // Önce binlik ayırıcı olan noktaları temizle, sonra virgülü noktaya çevir
                            let clean = String(v).replace(/\./g, '').replace(',', '.');
                            return parseFloat(clean) || 0;
                        };

                        // Helper: Değişim oranını ve rengini güncelle
                        const updateRateUI = (elementId, changeStr) => {
                            const el = document.getElementById(elementId);
                            if (!el) return;

                            // API "%0,12" veya "0,12" dönebilir
                            const val = parseFloat(String(changeStr).replace('%', '').replace(',', '.'));
                            const isPos = val >= 0;
                            const arrow = isPos ? '▲' : '▼';

                            // Premium Tasarım Sınıfları
                            const textClass = isPos ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400';
                            const bgClass = isPos ? 'bg-emerald-100/50 dark:bg-emerald-900/30' : 'bg-rose-100/50 dark:bg-rose-900/30';

                            el.className = `text-[10px] font-bold px-1.5 py-0.5 rounded ${bgClass} ${textClass} flex items-center backdrop-blur-sm transition-colors duration-500`;
                            el.innerHTML = `${arrow} %${Math.abs(val).toFixed(2)}`;
                        };

                        // 1. USD (Dolar)
                        if (data.USD) {
                            const val = parseVal(data.USD.satis);
                            const el = document.getElementById('val-usd');
                            if (el) el.textContent = fmt(val);
                            updateRateUI('rate-usd-change', data.USD.degisim);
                            liveRates.USD = val;
                        }

                        // 2. EUR (Euro)
                        if (data.EUR) {
                            const val = parseVal(data.EUR.satis);
                            const el = document.getElementById('val-eur');
                            if (el) el.textContent = fmt(val);
                            updateRateUI('rate-eur-change', data.EUR.degisim);
                            liveRates.EUR = val;
                        }

                        // 2.5 GBP (Sterlin) - YENİ
                        if (data.GBP) {
                            const val = parseVal(data.GBP.satis);
                            liveRates.GBP = val;
                        }

                        // 3. GA (Gram Altın)
                        if (data.GA) {
                            const val = parseVal(data.GA.satis);
                            const el = document.getElementById('val-gold-gram');
                            if (el) el.textContent = fmt(val);
                            updateRateUI('rate-gram-change', data.GA.degisim);
                            liveRates.GRAM = val;
                        }

                        // 4. C (Çeyrek Altın)
                        if (data.C) {
                            const val = parseVal(data.C.satis);
                            const el = document.getElementById('val-gold-quarter');
                            if (el) el.textContent = fmt(val);
                            updateRateUI('rate-quarter-change', data.C.degisim);
                            liveRates.QUARTER = val;
                        }

                        // Döviz Çeviriciyi ve Autopilot'u Tetikle
                        if (window.convertCurrency) window.convertCurrency();
                        if (window.calculateCashFlow) window.calculateCashFlow(); // Kur değişince nakit akışı değişebilir (TL karşılığı)

                        // Kur değişince Birikim grafiğini güncelle
                        if (window.processTransactions && window.transactions) {
                            window.processTransactions(window.transactions);
                        }

                    } catch (dovizErr) {
                        console.warn("Döviz verisi alınamadı (Genelpara):", dovizErr);
                    }

                    // --- B. BORSA HİSSELERİ (CollectAPI) ---
                    const stockResponse = await fetch("https://api.collectapi.com/economy/hisseSenedi", {
                        method: "GET",
                        headers: {
                            "content-type": "application/json",
                            "authorization": myApiKey
                        }
                    });

                    const stockResult = await stockResponse.json();

                    if (stockResult.success && stockResult.result) {
                        if (stockContainer) {
                            stockContainer.innerHTML = '';
                            const popularStocks = [
                                'THYAO', 'GARAN', 'ASELS', 'EREGL', 'AKBNK', 'ISCTR',
                                'YKBNK', 'KCHOL', 'SASA', 'SISE', 'TUPRS', 'BIMAS',
                                'PETKM', 'HALKB', 'EKGYO', 'VAKBN', 'ARCLK', 'TOASO',
                                'FROTO', 'PGSUS', 'KOZAL', 'KRDMD', 'HEKTS', 'ENJSA',
                                'ASTOR', 'ODAS', 'KONTR', 'GUBRF', 'VESTL', 'SOKM',
                                'TTKOM', 'TCELL', 'MGROS', 'AEFES', 'AGHOL', 'ALARK',
                                'CANTE', 'CCOLA', 'CIMSA', 'DOHOL', 'DOAS', 'ECILC',
                                'ENKAI', 'EUPWR', 'GESAN', 'GLYHO', 'ISMEN', 'KLSER',
                                'MAVI', 'MIATK'
                            ];

                            // Verileri filtrele ve cache'le
                            window.cachedStockData = stockResult.result.filter(stock =>
                                popularStocks.includes(stock.code)
                            );

                            // İlk render
                            window.renderStocks(window.cachedStockData);

                            // Arama fonksiyonunu başlat
                            window.initStockSearch();
                        }
                    }

                } catch (error) {
                    console.error("Veri çekme hatası:", error);
                } finally {
                    if (btn) btn.classList.remove('animate-spin');
                    const timeEl = document.querySelector('.market-time');
                    if (timeEl) timeEl.textContent = new Date().toLocaleTimeString('tr-TR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            };

            window.toggleGoalModal = function (show) { const modal = document.getElementById('add-goal-modal'); if (modal) modal.classList.toggle('hidden', !show); };

            window.setTransactionType = function (type) {
                currentType = type;
                const btnExp = document.getElementById('btn-type-expense');
                const btnInc = document.getElementById('btn-type-income');

                // Premium Box Style Classes
                const activeBase = "flex-1 relative z-20 py-4 rounded-2xl text-sm font-black shadow-lg transition-all duration-300 flex flex-col items-center justify-center gap-2 group ring-2";
                const passiveBase = "flex-1 relative z-20 py-4 rounded-2xl text-sm font-bold text-gray-500 dark:text-gray-400 transition-all duration-300 flex flex-col items-center justify-center gap-2 hover:bg-white/40 dark:hover:bg-white/5 bg-gray-100/50 dark:bg-black/20";

                if (type === 'expense') {
                    btnExp.className = `${activeBase} ring-red-500/20 bg-white dark:bg-gray-900 text-red-500 shadow-red-500/20`;
                    btnExp.innerHTML = `<span class="text-2xl group-hover:scale-110 transition-transform filter drop-shadow-sm">💸</span><span>Gider</span><div class="absolute inset-0 bg-red-500/5 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity"></div>`;

                    btnInc.className = passiveBase;
                    btnInc.innerHTML = `<span class="text-2xl grayscale opacity-70 group-hover:grayscale-0 group-hover:opacity-100 transition-all">💰</span><span>Gelir</span>`;
                } else {
                    btnInc.className = `${activeBase} ring-green-500/20 bg-white dark:bg-gray-900 text-green-500 shadow-green-500/20`;
                    btnInc.innerHTML = `<span class="text-2xl group-hover:scale-110 transition-transform filter drop-shadow-sm">💰</span><span>Gelir</span><div class="absolute inset-0 bg-green-500/5 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity"></div>`;

                    btnExp.className = passiveBase;
                    btnExp.innerHTML = `<span class="text-2xl grayscale opacity-70 group-hover:grayscale-0 group-hover:opacity-100 transition-all">💸</span><span>Gider</span>`;
                }

                window.updateCategoryOptions();
                const invGroup = document.getElementById('investment-input-group');
                const amountInput = document.getElementById('input-amount');
                if (invGroup) invGroup.classList.add('hidden');
                if (amountInput) { amountInput.readOnly = false; amountInput.placeholder = "0.00"; amountInput.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'cursor-not-allowed'); }
            };

            window.checkInvestmentInput = function () {
                const catSelect = document.getElementById('input-category');
                if (!catSelect) return;
                const cat = catSelect.value;

                // Alt Kategori Çiplerini Render Et
                if (window.renderSubCategories) window.renderSubCategories();

                const invGroup = document.getElementById('investment-input-group');
                const invInput = document.getElementById('input-investment-qty');
                const amountInput = document.getElementById('input-amount');

                invGroup.classList.add('hidden'); if (invInput) invInput.value = '';
                if (amountInput) { amountInput.readOnly = false; amountInput.placeholder = "0.00"; amountInput.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'cursor-not-allowed'); }

                let rate = 0; let placeholder = ""; let isInvestment = false;
                const parseRate = (rStr) => { if (!rStr) return 0; if (typeof rStr === 'number') return rStr; return parseFloat(rStr.toString().replace(' ₺', '').replace(/\./g, '').replace(',', '.')); };

                if (cat === '🟡 Altın Gr.') { rate = parseRate(liveRates.GRAM); placeholder = "Kaç Gram?"; isInvestment = true; }
                else if (cat === '🪙 Çeyrek Altın') { rate = parseRate(liveRates.QUARTER); placeholder = "Kaç Adet?"; isInvestment = true; }
                else if (cat.includes('Dolar')) { rate = parseRate(liveRates.USD); placeholder = "Kaç Dolar?"; isInvestment = true; }
                else if (cat.includes('Euro')) { rate = parseRate(liveRates.EUR); placeholder = "Kaç Euro?"; isInvestment = true; }

                // ✅ FIX: Yatırım/döviz/altın değilse "Bakiyeden Düşme" seçimini sıfırla
                const excludeCb = document.getElementById('input-exclude-balance');
                if (!isInvestment && excludeCb) {
                    excludeCb.checked = false;
                }
                // Yatırım değilken checkbox'ı pasifleştir (UX)
                if (excludeCb) {
                    excludeCb.disabled = !isInvestment;
                }

                if (isInvestment) {
                    invGroup.classList.remove('hidden'); if (invInput) invInput.placeholder = placeholder;
                    if (amountInput) { amountInput.readOnly = true; amountInput.placeholder = "Otomatik Hesaplanıyor..."; amountInput.classList.add('bg-gray-100', 'dark:bg-gray-800', 'cursor-not-allowed'); }
                    if (invInput) invInput.oninput = function () {
                        const qty = parseFloat(this.value.replace(',', '.'));
                        if (amountInput && qty && rate) { amountInput.value = (qty * rate).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
                        else if (amountInput) { amountInput.value = ''; }
                    };
                }

                const savingsOpt = document.getElementById('savings-options');
                if (savingsOpt) savingsOpt.classList.toggle('hidden', !isInvestment);
            };

            window.changePeriod = function (direction) {
                if (viewScope === 'month') currentDate.setMonth(currentDate.getMonth() + direction);
                else currentDate.setFullYear(currentDate.getFullYear() + direction);
                window.updatePeriodDisplay(); window.processTransactions(transactions);
            };

            window.toggleViewScope = function () {
                viewScope = viewScope === 'month' ? 'year' : 'month';
                document.getElementById('view-scope-badge').textContent = viewScope === 'month' ? 'AYLIK' : 'YILLIK';
                window.updatePeriodDisplay(); window.processTransactions(transactions);
            };

            window.getSmartIcon = function (category, description) {
                const text = (category + " " + (description || "")).toLowerCase();
                if (text.includes('market') || text.includes('gıda') || text.includes('bim')) return '🛒';
                if (text.includes('netflix') || text.includes('eğlence')) return '🍿';
                if (text.includes('benzin') || text.includes('yakıt') || text.includes('taksi') || text.includes('ulaşım')) return '🚕';
                if (text.includes('fatura') || text.includes('elektrik')) return '🧾';
                if (text.includes('kira') || text.includes('ev')) return '🏠';
                if (text.includes('maaş') || text.includes('gelir')) return '💰';
                if (text.includes('sağlık') || text.includes('eczane')) return '💊';
                if (text.includes('giyim')) return '👕';
                if (text.includes('tamirat')) return '🔧';
                if (text.includes('eğitim') || text.includes('okul')) return '🎓';
                if (text.includes('dolar') || text.includes('usd')) return '💵';
                if (text.includes('euro') || text.includes('eur')) return '💶';
                if (text.includes('altın')) return '🥇';
                if (text.includes('çeyrek')) return '🪙';
                if (text.includes('yatırım')) return '📈';
                if (category.includes('Yemek')) return '🍔';
                if (category.includes('Spor')) return '💪';
                if (category.includes('Tatil')) return '✈️';
                return '💸';
            };

            window.editTransaction = function (id) {
                const t = transactions.find(x => x.id === id); if (!t) return;
                window.switchTab('add'); editingTransactionId = id;
                const saveBtn = document.getElementById('save-btn'); if (saveBtn) saveBtn.textContent = 'Güncelle';
                const cancelBtn = document.getElementById('cancel-edit-btn'); if (cancelBtn) cancelBtn.classList.remove('hidden');
                const amtInput = document.getElementById('input-amount'); if (amtInput) amtInput.value = t.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const dateInput = document.getElementById('input-date');
                const dateString = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate().toISOString().slice(0, 10) : (t.date || new Date().toISOString().slice(0, 10));
                if (dateInput) dateInput.value = dateString;
                const descInput = document.getElementById('input-desc'); if (descInput) descInput.value = t.description || '';
                window.setTransactionType(t.type);
                const catInput = document.getElementById('input-category'); if (catInput) catInput.value = t.category;
                window.checkInvestmentInput();
                const invInput = document.getElementById('input-investment-qty'); if (t.unitAmount && invInput) invInput.value = t.unitAmount;
            };

            window.cancelEdit = function () {
                editingTransactionId = null;
                document.getElementById('input-amount').value = '';
                document.getElementById('input-desc').value = '';
                document.getElementById('input-investment-qty').value = '';
                document.getElementById('input-date').value = new Date().toISOString().slice(0, 10);
                window.setTransactionType('expense');
                const saveBtn = document.getElementById('save-btn'); if (saveBtn) saveBtn.textContent = 'Kaydet';
                const cancelBtn = document.getElementById('cancel-edit-btn'); if (cancelBtn) cancelBtn.classList.add('hidden');
                document.getElementById('input-recurring').checked = false;
                document.getElementById('recurring-options').classList.add('hidden');

                // YENİ EKLENEN KISIM: Bakiyeden Düşme/Yatırım alanlarını sıfırla
                document.getElementById('input-exclude-balance').checked = false;
                document.getElementById('savings-options').classList.add('hidden');
            };

            window.updateChart = function (inc, exp, sav) {
                const ctx = document.getElementById('mainChart'); if (!ctx) return;
                if (chartInstance) chartInstance.destroy();
                const isDark = document.documentElement.classList.contains('dark');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['Gelir', 'Gider', 'Birikim'], datasets: [{ data: [inc, exp, sav], backgroundColor: ['#34D399', '#F87171', '#FBBF24'], borderRadius: 20, barThickness: 60 }] },
                    options: { responsive: true, maintainAspectRatio: false, animation: { duration: 2000, easing: 'easeOutBounce' }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false }, ticks: { display: false } }, x: { grid: { display: false }, ticks: { color: isDark ? '#9CA3AF' : '#374151', font: { weight: 'bold' } } } } }
                });
            };

            window.initCategoryChart = function () {
                const ctx = document.getElementById('categoryChart'); if (!ctx) return;
                if (categoryChartInstance) { categoryChartInstance.destroy(); categoryChartInstance = null; }
                const targetMonth = currentDate.getMonth(); const targetYear = currentDate.getFullYear();
                const cats = {};
                transactions.filter(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    const d = tDate;
                    const matchDate = viewScope === 'year' ? d.getFullYear() === targetYear : (d.getMonth() === targetMonth && d.getFullYear() === targetYear);
                    return matchDate && t.type === 'expense' && !isSavingsTransaction(t);
                }).forEach(t => { cats[t.category] = (cats[t.category] || 0) + parseFloat(t.amount); });
                const labels = Object.keys(cats); const data = Object.values(cats);
                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#E7E9ED', '#71B37C'];
                const isDark = document.documentElement.classList.contains('dark');
                categoryChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: labels, datasets: [{ data: data, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 }, color: isDark ? '#A1A1AA' : '#374151' } } }, cutout: '70%' }
                });
            };

            window.updateChartInsights = function (dataList) {
                const insightContainer = document.getElementById('category-top-list');
                if (!insightContainer) return;

                if (currentChartType === 'general') {
                    let inc = 0, exp = 0, savFlow = 0;
                    dataList.forEach(t => { const val = parseFloat(t.amount); if (t.type === 'income') inc += val; else if (isSavingsTransaction(t)) savFlow += val; else exp += val; });

                    // Kur endeksli birikim değeri kullan (grafikteki ile uyumlu olsun)
                    const sav = window.getIndexedSavingsValue ? window.getIndexedSavingsValue(dataList, savFlow) : savFlow;

                    let message = `Bütçen dengede görünüyor. 👍`;
                    if (sav > exp) message = `Harika! Bu dönem harcamandan çok birikim yaptın.👏`;
                    else if (exp > inc) message = `Dikkat: Giderlerin gelirini aşmış durumda. ⚠️`;

                    // General view HTML regeneration
                    insightContainer.innerHTML = `
                <div class="flex items-start space-x-3" id="chart-insight-default">
                    <div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs shrink-0 shadow-sm">💡</div>
                    <p id="chart-insight" class="text-xs text-gray-700 dark:text-gray-300 leading-relaxed font-medium">${message}</p>
                </div>
            `;
                    return;
                }

                // Category view logic (remains mostly same, just ensuring container is cleared first)
                insightContainer.innerHTML = ''; // Clear for categories

                const categoriesMap = {};
                let totalExpense = 0;

                dataList.filter(t => t.type === 'expense' && !isSavingsTransaction(t)).forEach(t => {
                    const amount = parseFloat(t.amount);
                    categoriesMap[t.category] = (categoriesMap[t.category] || 0) + amount;
                    totalExpense += amount;
                });

                if (totalExpense === 0) {
                    insightContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400 text-center py-4">Bu dönemde analiz edilecek harcama verisi bulunamadı.</p>';
                    return;
                }

                const sortedCategories = Object.entries(categoriesMap)
                    .map(([category, amount]) => ({
                        category,
                        amount,
                        percentage: (amount / totalExpense) * 100,
                        icon: window.getSmartIcon(category, '')
                    }))
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 4); // İlk 4'ü al

                const colors = {
                    '🛒 Market': '#3B82F6', // Blue
                    '🧾 Fatura': '#8B5CF6', // Purple
                    '🏠 Kira': '#EC4899', // Pink
                    '🚌 Ulaşım': '#F59E0B', // Amber
                    '🍿 Eğlence': '#10B981', // Emerald
                    '💊 Sağlık': '#EF4444', // Red
                    '👕 Giyim': '#6366F1', // Indigo
                    '🎓 Eğitim': '#06B6D4', // Cyan
                    '💸': '#A1A1AA' // Default Gray
                };

                sortedCategories.forEach((item, index) => {
                    const barColor = colors[item.category] || colors['💸'];
                    const lightBg = `bg-white/70 dark:bg-gray-800/50`;
                    const percent = item.percentage.toFixed(1);
                    const amtFmt = item.amount.toLocaleString('tr-TR', { maximumFractionDigits: 0 });

                    const html = `
                <div class="flex flex-col p-3 ${lightBg} rounded-xl border border-gray-100 dark:border-white/10 shadow-sm animate-slide-up" style="animation-delay: ${index * 0.1}s;">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${item.icon}</span>
                            <p class="text-sm font-bold text-gray-800 dark:text-white">${item.category}</p>
                        </div>
                        <p class="text-sm font-black text-gray-900 dark:text-white">${amtFmt} ₺</p>
                    </div>
                    <div class="flex justify-between items-center text-[10px] text-gray-500 dark:text-gray-400">
                        <span>Harcama Payı</span>
                        <span class="font-bold text-gray-700 dark:text-gray-200">%${percent}</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-2">
                        <div class="h-1.5 rounded-full" style="width:${percent}%; background-color: ${barColor};"></div>
                    </div>
                </div>
            `;
                    insightContainer.insertAdjacentHTML('beforeend', html);
                });
            };

            window.updateUI = function (inc, exp, sav, dedSav, carryover) {
                // dedSav (deductableSavings) yeni eklenen parametre. Eğer tanımlı değilse (eski çağrılar için) varsayılan olarak savings kullan.
                dedSav = dedSav !== undefined ? dedSav : sav;
                carryover = carryover !== undefined ? carryover : 0;
                const netCash = inc - exp - dedSav + carryover;
                const fmt = (n) => (Number(n) || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + '\u00A0₺';
                const fmtAmount = (n) => (Number(n) || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

                const elBal = document.getElementById('display-balance');
                const elInc = document.getElementById('display-income');
                const elExp = document.getElementById('display-expense');
                const elCarryover = document.getElementById('display-carryover');

                if (elBal) elBal.textContent = fmt(netCash);

                // Gelir - Yeni money-inline yapısını destekle
                if (elInc) {
                    const amountEl = elInc.querySelector('[data-money-amount]');
                    if (amountEl) amountEl.textContent = fmtAmount(inc);
                    else elInc.textContent = fmt(inc); // fallback
                }

                // Gider - Yeni money-inline yapısını destekle
                if (elExp) {
                    const amountEl = elExp.querySelector('[data-money-amount]');
                    if (amountEl) amountEl.textContent = fmtAmount(exp);
                    else elExp.textContent = fmt(exp); // fallback
                }

                // Geçmiş ay devir gösterimi
                const carryoverBadge = document.getElementById('carryover-badge');
                if (elCarryover && carryoverBadge) {
                    if (carryover !== 0) {
                        elCarryover.textContent = (carryover >= 0 ? '+' : '') + fmt(carryover);
                        elCarryover.className = carryover >= 0
                            ? 'text-xs font-medium text-emerald-600 dark:text-emerald-400'
                            : 'text-xs font-medium text-rose-600 dark:text-rose-400';
                        carryoverBadge.className = carryover >= 0
                            ? 'flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-100 dark:bg-emerald-500/20'
                            : 'flex items-center gap-1 px-2 py-0.5 rounded-full bg-rose-100 dark:bg-rose-500/20';
                        carryoverBadge.classList.remove('hidden');
                    } else {
                        carryoverBadge.classList.add('hidden');
                    }
                }

                const dash = document.getElementById('screen-dashboard');
                if (dash && !dash.classList.contains('hidden') && currentChartType === 'general') {
                    const chartSav = (typeof window.__indexedSavingsForChart === 'number' && isFinite(window.__indexedSavingsForChart) && window.__indexedSavingsForChart > 0)
                        ? window.__indexedSavingsForChart
                        : sav;
                    window.updateChart(inc, exp, chartSav);
                }
            };

            window.renderGoalsList = function () {
                const c = document.getElementById('goals-list'); if (!c) return;
                c.innerHTML = goals.length ? '' : '<p class="text-center text-gray-400 text-xs py-4">Henüz hedef yok.</p>';
                goals.forEach(g => {
                    // Geriye uyumluluk: eski hedefler için varsayılan değerler
                    if (!g.currentMode) {
                        g.currentMode = 'TRY';
                        g.indexType = 'TRY';
                        g.indexAmount = 0;
                        g.lastComputedTL = g.current || 0;
                    }

                    // Güncel TL değerini hesapla
                    const currentTL = window.getGoalCurrentTL ? window.getGoalCurrentTL(g) : g.current;
                    const p = Math.min(100, Math.round((currentTL / g.target) * 100));

                    // Endeks badge'i (sadece INDEXED modda)
                    let indexBadge = '';
                    if (g.currentMode === 'INDEXED' && g.indexAmount > 0) {
                        const labels = { USD: '🇺🇸 USD', EUR: '🇪🇺 EUR', GRAM: '🥇 Gr', QUARTER: '🪙 Adet' };
                        const label = labels[g.indexType] || g.indexType;
                        indexBadge = `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400">${label} • ${g.indexAmount.toLocaleString('tr-TR', { maximumFractionDigits: 2 })}</span>`;
                    }

                    // Delta badge'i (kur değişim farkı)
                    let deltaBadge = '';
                    if (g.currentMode === 'INDEXED' && typeof g.lastDeltaTL === 'number' && g.lastDeltaTL !== 0) {
                        const isPositive = g.lastDeltaTL > 0;
                        const arrow = isPositive ? '▲' : '▼';
                        const colorClass = isPositive ? 'text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30' : 'text-rose-600 dark:text-rose-400 bg-rose-100 dark:bg-rose-900/30';
                        deltaBadge = `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded ${colorClass}">${arrow} ${Math.abs(g.lastDeltaTL).toLocaleString('tr-TR', { maximumFractionDigits: 0 })} ₺</span>`;
                    }

                    c.insertAdjacentHTML('beforeend', `
                    <div class="glass-card rounded-2xl p-4 relative">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold dark:text-white flex items-center space-x-2">
                                <span>🎯</span> <span>${g.title}</span>
                            </span>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-purple-600 font-bold bg-purple-100 dark:bg-purple-900/30 px-2 py-0.5 rounded-lg">%${p}</span>
                                <button onclick="window.requestDeleteGoal('${g.id}')" class="text-gray-400 hover:text-red-500 transition">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        ${(indexBadge || deltaBadge) ? `<div class="flex items-center gap-2 mb-2">${indexBadge}${deltaBadge}</div>` : ''}
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-700" style="width:${p}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mb-3">
                            <span>Mevcut: ${currentTL.toLocaleString('tr-TR', { maximumFractionDigits: 0 })} ₺</span>
                            <span>Hedef: ${g.target.toLocaleString('tr-TR')} ₺</span>
                        </div>
                        <button onclick="window.openAddFundsModal('${g.id}')" class="w-full py-2 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-gray-100 dark:hover:bg-white/10 text-xs font-bold text-gray-600 dark:text-gray-300 transition border border-gray-200 dark:border-gray-700">+ Para Ekle</button>
                    </div>
                `);
                });
                window.updateDashboardGoalWidget(); // Widget'ı güncelle
            };

            window.updateDashboardGoalWidget = function () {
                const elBg = document.getElementById('dash-goal-bg');
                const elLine = document.getElementById('dash-goal-line');
                const elPct = document.getElementById('dash-goal-percent');
                const elCap = document.getElementById('dash-goal-caption');

                if (!elBg || !elLine || !elPct || !elCap) return;

                if (!goals || goals.length === 0) {
                    elBg.style.width = '0%';
                    elLine.style.width = '0%';
                    elPct.textContent = '%0';
                    elCap.textContent = 'Henüz hedef yok';
                    return;
                }

                let totalCurrent = 0, totalTarget = 0;
                goals.forEach(g => {
                    // Güncel TL değerini hesapla (endeksli veya sabit)
                    const currentTL = window.getGoalCurrentTL ? window.getGoalCurrentTL(g) : (g.current || 0);
                    totalCurrent += currentTL;
                    totalTarget += parseFloat(g.target || 0);
                });

                const overallPct = totalTarget > 0 ? Math.min(100, (totalCurrent / totalTarget) * 100) : 0;
                const pctStr = overallPct.toFixed(0);

                elBg.style.width = pctStr + '%';
                elLine.style.width = pctStr + '%';
                elPct.textContent = '%' + pctStr;
                elCap.textContent = 'Hayallerine giden yol';
            };


            window.processTransactions = function (allData) {
                const targetMonth = currentDate.getMonth(); const targetYear = currentDate.getFullYear();
                const filteredData = allData.filter(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    const d = tDate;
                    if (viewScope === 'year') return d.getFullYear() === targetYear;
                    return d.getMonth() === targetMonth && d.getFullYear() === targetYear;
                });

                let income = 0, expense = 0, savings = 0;
                let deductableSavings = 0; // Bakiyeden düşülecek birikimler

                filteredData.forEach(t => {
                    const val = parseFloat(t.amount);
                    if (t.type === 'income') {
                        income += val;
                    } else {
                        // PATCH: isSavingsTransaction(t) kullanarak tek kaynak sınıflandırma
                        if (isSavingsTransaction(t)) {
                            savings += val;
                            // Eğer "Bakiyeden Düşme" seçili DEĞİLSE (false/undefined), düşülecek tutara ekle
                            if (!t.excludeFromBalance) { deductableSavings += val; }
                        } else {
                            expense += val;
                        }
                    }
                });

                // ═══════════════════════════════════════════════════════════════════
                // CARRYOVER BALANCE - Geçmiş aylardan kalan net nakit hesabı
                // ═══════════════════════════════════════════════════════════════════
                let carryoverBalance = 0;
                if (viewScope !== 'year') {
                    // Sadece seçili aydan ÖNCE olan tüm işlemleri hesapla
                    const previousData = allData.filter(t => {
                        const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                        // Hedef tarihten önceki aylar
                        const targetDateStart = new Date(targetYear, targetMonth, 1);
                        return tDate < targetDateStart;
                    });

                    let prevIncome = 0, prevExpense = 0, prevDeductableSavings = 0;
                    previousData.forEach(t => {
                        const val = parseFloat(t.amount);
                        if (t.type === 'income') {
                            prevIncome += val;
                        } else {
                            if (isSavingsTransaction(t)) {
                                if (!t.excludeFromBalance) { prevDeductableSavings += val; }
                            } else {
                                prevExpense += val;
                            }
                        }
                    });

                    carryoverBalance = prevIncome - prevExpense - prevDeductableSavings;
                    // Store for UI display
                    window.carryoverBalance = carryoverBalance;
                }

                // Chart için kur endeksli birikim değerini hesapla
                window.__indexedSavingsForChart = window.getIndexedSavingsValue
                    ? window.getIndexedSavingsValue(filteredData, savings)
                    : savings;

                filteredData.sort((a, b) => {
                    const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.date);
                    const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.date);
                    return dateB - dateA;
                });

                // Net Nakit = Gelir - Gider - (Sadece Bakiyeden Düşülen Birikimler) + Geçmiş Ay Devir
                window.updateUI(income, expense, savings, deductableSavings, carryoverBalance);

                window.renderTransactionsToList(filteredData.slice(0, 5), document.getElementById('recent-transactions-list'));
                allData.sort((a, b) => {
                    const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.date);
                    const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.date);
                    return dateB - dateA;
                });
                window.renderTransactionsToList(allData, document.getElementById('full-history-list'));
                window.updateChartInsights(filteredData);

                const sourceData = window.transactions && window.transactions.length > 0 ? window.transactions : allData;
                const portfolio = window.calculatePortfolio(sourceData);
                const elSavingsTotal = document.getElementById('display-savings-total');
                if (elSavingsTotal) elSavingsTotal.textContent = (Number(portfolio.totalValue) || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ₺';

                const dashInstallmentEl = document.getElementById('dashboard-installment-total');
                const widgetEl = document.getElementById('dashboard-installment-widget');
                if (dashInstallmentEl && widgetEl) {
                    const totalActive = installments.filter(i => i.remainingMonths > 0).reduce((sum, i) => sum + i.monthlyAmount, 0);
                    dashInstallmentEl.textContent = totalActive.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺';
                    if (totalActive > 0) widgetEl.classList.remove('hidden'); else widgetEl.classList.add('hidden');
                }
                window.checkBadges();

                // NAKİT AKIŞI TAHMİNİ
                setTimeout(window.predictCashFlow, 1000);

                // TAKVİM GÜNCELLE
                if (!document.getElementById('screen-history').classList.contains('hidden')) {
                    window.renderCalendar(window.calendarCurrentDate || new Date());
                }
            };

            // ═══════════════════════════════════════════════════════════════════════════
            // APPLE-STYLE SWIPE HANDLER (Premium Physics)
            // ═══════════════════════════════════════════════════════════════════════════
            class AppleSwipeHandler {
                constructor(container, options = {}) {
                    this.container = container;
                    this.content = container.querySelector('.swipe-content');
                    this.actionDelete = container.querySelector('.swipe-action-delete');
                    this.actionEdit = container.querySelector('.swipe-action-edit');
                    this.options = options;

                    this.startX = 0;
                    this.startY = 0;
                    this.currentX = 0;
                    this.isDragging = false;
                    this.isSwiping = false; // true if horizontal > vertical
                    this.directionLocked = false;

                    // Configuration
                    this.thresholdReveal = 70; // px to reveal icon fully
                    this.thresholdCommit = 160; // px to auto-trigger action
                    this.maxDrag = 300;

                    this.rafId = null;

                    // Bindings
                    this.handleTouchStart = this.handleTouchStart.bind(this);
                    this.handleTouchMove = this.handleTouchMove.bind(this);
                    this.handleTouchEnd = this.handleTouchEnd.bind(this);

                    this.container.addEventListener('touchstart', this.handleTouchStart, { passive: true });
                    this.container.addEventListener('touchmove', this.handleTouchMove, { passive: false }); // crucial for preventing scroll
                    this.container.addEventListener('touchend', this.handleTouchEnd, { passive: true });

                    // Initial state
                    if (this.actionDelete) this.actionDelete.style.visibility = 'hidden';
                    if (this.actionEdit) this.actionEdit.style.visibility = 'hidden';
                }

                handleTouchStart(e) {
                    if (window.activeSwipeHandler && window.activeSwipeHandler !== this) {
                        window.activeSwipeHandler.reset();
                    }

                    this.startX = e.touches[0].clientX;
                    this.startY = e.touches[0].clientY;
                    this.isDragging = true;
                    this.isSwiping = false;
                    this.directionLocked = false;
                    this.content.style.transition = 'none'; // Instant follow

                    window.activeSwipeHandler = this;
                }

                handleTouchMove(e) {
                    if (!this.isDragging) return;

                    const x = e.touches[0].clientX;
                    const y = e.touches[0].clientY;
                    const deltaX = x - this.startX;
                    const deltaY = y - this.startY;

                    // Determine direction lock
                    if (!this.directionLocked) {
                        if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                            this.directionLocked = true;
                            if (Math.abs(deltaX) > Math.abs(deltaY) * 1.5) {
                                this.isSwiping = true;

                                // Show correct action layer
                                if (deltaX < 0) { // Swiping Left (Show Right/Delete)
                                    if (this.actionDelete) {
                                        this.actionDelete.style.visibility = 'visible';
                                        this.actionDelete.style.zIndex = '1';
                                    }
                                    if (this.actionEdit) {
                                        this.actionEdit.style.visibility = 'hidden';
                                        this.actionEdit.style.zIndex = '0';
                                    }
                                } else { // Swiping Right (Show Left/Edit)
                                    if (this.actionEdit) {
                                        this.actionEdit.style.visibility = 'visible';
                                        this.actionEdit.style.zIndex = '1';
                                    }
                                    if (this.actionDelete) {
                                        this.actionDelete.style.visibility = 'hidden';
                                        this.actionDelete.style.zIndex = '0';
                                    }
                                }
                            } else {
                                this.isSwiping = false;
                            }
                        }
                    }

                    if (this.isSwiping) {
                        if (e.cancelable) e.preventDefault(); // Stop scrolling

                        // Resistance / Rubber banding
                        let visualX = deltaX;
                        /* Logarithmic resistance */
                        if (Math.abs(deltaX) > this.thresholdCommit) {
                            const extra = Math.abs(deltaX) - this.thresholdCommit;
                            const damped = Math.pow(extra, 0.7); // Soft damping
                            visualX = deltaX > 0 ? this.thresholdCommit + damped : -(this.thresholdCommit + damped);
                        }

                        this.currentX = visualX;
                        this.content.style.transform = `translateX(${visualX}px)`;

                        // Icon animations
                        const progress = Math.min(1, Math.abs(visualX) / this.thresholdReveal);
                        const targetAction = visualX < 0 ? this.actionDelete : this.actionEdit;

                        if (targetAction) {
                            const iconWrapper = targetAction.querySelector('.swipe-action-icon-wrapper');
                            if (iconWrapper) {
                                iconWrapper.style.opacity = progress;
                                iconWrapper.style.transform = `scale(${0.8 + 0.2 * progress})`;
                            }
                        }

                        // Haptics at threshold
                        if (Math.abs(visualX) > this.thresholdCommit && !this.hapticTriggered) {
                            if (window.FingoHaptics && window.FingoHaptics.medium) window.FingoHaptics.medium();
                            else if (navigator.vibrate) navigator.vibrate(10);
                            this.hapticTriggered = true;
                        } else if (Math.abs(visualX) < this.thresholdCommit && this.hapticTriggered) {
                            this.hapticTriggered = false;
                        }
                    }
                }

                handleTouchEnd(e) {
                    if (!this.isDragging) return;
                    this.isDragging = false;
                    this.content.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; // Spring back

                    const absX = Math.abs(this.currentX);

                    if (absX > this.thresholdCommit) {
                        // Full Commit
                        if (this.currentX < 0) {
                            // Swiped LEFT -> DELETE
                            this.commitDelete();
                        } else {
                            // Swiped RIGHT -> EDIT
                            this.commitEdit();
                        }
                    } else if (absX > this.thresholdReveal) {
                        // Reveal only (Snap to open)
                        // User requested behavior: "Threshold < 65% -> reveal"
                        // But actually standard swipe often snaps to open. 
                        // Let's implement snap-to-open for better UX if it's past reveal but not commit.
                        // However, user prompt said "%65 swipe -> full commit".
                        // Let's just snap back if not committed, or keep it open?
                        // "Threshold 35% -> reveal" implies it stays open?
                        // Let's implement snap-to-open logic for edit/delete buttons if user wants manual tap.

                        const snapTarget = this.currentX < 0 ? -100 : 100; // Width of action button
                        this.content.style.transform = `translateX(${snapTarget}px)`;
                        this.isOpen = true; // State tracking
                    } else {
                        // Snap back (Not enough)
                        this.reset();
                    }
                }

                commitDelete() {
                    if (window.FingoHaptics && window.FingoHaptics.warning) window.FingoHaptics.warning();

                    // Visual feedback: slide out completely
                    this.content.style.transform = 'translateX(-120%)';
                    this.content.style.opacity = '0';

                    // Wait for animation then call callback
                    setTimeout(() => {
                        if (this.options.onDelete) this.options.onDelete(this);
                        else {
                            // Default reset if callback doesn't handle DOM removal
                            this.reset();
                            this.content.style.opacity = '1';
                        }
                    }, 300);
                }

                commitEdit() {
                    if (window.FingoHaptics && window.FingoHaptics.light) window.FingoHaptics.light();

                    // For Edit, usually we open modal and snap back card
                    // Or keep card open while modal is up? Usually snap back.
                    this.reset(); // Snap back

                    setTimeout(() => {
                        if (this.options.onEdit) this.options.onEdit(this);
                    }, 50); // Immediate
                }

                reset() {
                    this.content.style.transform = 'translateX(0)';
                    this.currentX = 0;
                    this.isOpen = false;
                    this.hapticTriggered = false;
                    // Reset opacities after transition
                    setTimeout(() => {
                        if (this.actionDelete) this.actionDelete.style.visibility = 'hidden';
                        if (this.actionEdit) this.actionEdit.style.visibility = 'hidden';
                    }, 400);
                }
            }

            window.renderTransactionsToList = function (data, container) {
                if (!container) return;
                container.innerHTML = data.length ? '' : '<p class="text-center text-gray-400 text-xs py-4">İşlem yok</p>';

                // Sort by date descending first
                const sortedData = [...data].sort((a, b) => {
                    const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.date);
                    const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.date);
                    return dateB - dateA;
                });

                // Group by month
                const monthNames = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
                let currentMonthKey = null;

                sortedData.forEach(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    const monthKey = `${tDate.getFullYear()}-${tDate.getMonth()}`;

                    // Add month header if new month
                    if (monthKey !== currentMonthKey) {
                        currentMonthKey = monthKey;
                        const monthName = monthNames[tDate.getMonth()];
                        const year = tDate.getFullYear();
                        container.insertAdjacentHTML('beforeend', `
                        <div class="sticky top-0 z-20 py-2 px-1 -mx-1 mb-2 mt-4 first:mt-0 bg-gray-50/90 dark:bg-gray-900/90 backdrop-blur-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400">${monthName} ${year}</span>
                                <div class="flex-1 h-px bg-gradient-to-r from-indigo-200 dark:from-indigo-500/30 to-transparent"></div>
                            </div>
                        </div>
                    `);
                    }

                    const isInv = isSavingsTransaction(t); const isExp = t.type === 'expense';
                    let color = isExp ? 'text-red-500' : 'text-green-500'; let sign = isExp ? '-' : '+';
                    if (isInv && isExp) {
                        color = t.excludeFromBalance ? 'text-purple-500 dark:text-purple-400' : 'text-orange-500 dark:text-orange-400';
                        sign = t.excludeFromBalance ? '≈' : '-';
                    }
                    let icon = window.getSmartIcon(t.category, t.description);
                    const tDateStr = tDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
                    const qtyLabel = t.unitAmount && t.unitAmount > 0 ? `<span class="text-[10px] text-gray-400 ml-1">(${t.unitAmount})</span>` : '';
                    const noteRaw = (t.description || '').trim();
                    const noteEscaped = noteRaw.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const noteHTML = noteEscaped ? `<div class="mt-1 flex flex-wrap gap-1"><span class="mini-badge mini-badge--note">📝 ${noteEscaped}</span></div>` : '';

                    // Create Container Element
                    const tEl = document.createElement('div');
                    tEl.className = 'swipe-container';
                    tEl.dataset.transactionId = t.id;

                    const amountFormatted = t.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

                    tEl.innerHTML = `
                        <!-- Action Layers -->
                        <div class="swipe-action-layer swipe-action-edit">
                            <div class="swipe-action-icon-wrapper">
                                <span class="swipe-action-icon">✏️</span>
                                <span>Düzenle</span>
                            </div>
                        </div>
                        <div class="swipe-action-layer swipe-action-delete">
                            <div class="swipe-action-icon-wrapper">
                                <span class="swipe-action-icon">🗑️</span>
                                <span>Sil</span>
                            </div>
                        </div>

                        <!-- Content Card -->
                        <div class="swipe-content glass-card rounded-xl p-3 flex justify-between items-center bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3 overflow-hidden">
                                <div class="w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-700/50 flex items-center justify-center text-lg shadow-sm border border-gray-100 dark:border-gray-600">${icon}</div>
                                <div class="min-w-0 flex-1">
                                    <p class="text-sm font-bold text-gray-900 dark:text-white truncate">${t.category}${qtyLabel}</p>
                                    ${noteHTML}
                                    <p class="text-[10px] text-gray-400 mt-0.5">${tDateStr}</p>
                                </div>
                            </div>
                            <div class="text-right pl-2">
                                <p class="${color} font-bold text-sm whitespace-nowrap">${sign}${amountFormatted} ₺</p>
                            </div>
                        </div>
                    `;

                    container.appendChild(tEl);

                    // Initialize Swipe Handler
                    new AppleSwipeHandler(tEl, {
                        onDelete: (handler) => {
                            // Use requestDelete for consistent modal behavior if available
                            if (window.requestDelete) {
                                window.requestDelete('transaction', t.id);
                                // If cancelled, we need to reset the row visually? 
                                // requestDelete is usually async UI. 
                                // We can assume if user cancels, the list re-renders or we reset.
                                // Let's simplify: reset row if not deleted immediately?
                                // Actually, requestDelete usually opens a modal.
                                // We should reset the row so it's back to normal while modal is open.
                                handler.reset();
                            } else if (confirm('Bu işlemi silmek istediğinize emin misiniz?')) {
                                if (window.deleteTransaction) window.deleteTransaction(t.id);
                            } else {
                                handler.reset();
                            }
                        },
                        onEdit: (handler) => {
                            if (window.editTransaction) window.editTransaction(t.id);
                        }
                    });

                });
            };

            window.searchTransactions = function (query) {
                const list = document.getElementById('full-history-list'); if (!list) return;
                const lowerQ = query ? query.toLowerCase() : '';

                // Query'den sayısal bir değer elde etmeye çalışırız (örneğin: "500", "50,00" -> 500)
                const normalizedQuery = lowerQ.replace(/\./g, '').replace(/,/g, '.');
                const queryAmount = parseFloat(normalizedQuery);
                const isNumericQuery = !isNaN(queryAmount) && normalizedQuery.length > 0;

                const filtered = transactions.filter(t => {
                    const categoryMatch = t.category.toLowerCase().includes(lowerQ);
                    const descriptionMatch = t.description && t.description.toLowerCase().includes(lowerQ);

                    // İşlemin Tutarını Formatlanmış Haliyle Kontrol Et (Örn: "500.00" veya "500,00")
                    const amountStr = t.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).toLowerCase();
                    const amountMatch = amountStr.includes(lowerQ);

                    // İşlemin Tarihini Kontrol Et (Örn: "2023-11" veya "2023")
                    const dateString = t.date || (t.timestamp && t.timestamp.toDate ? t.timestamp.toDate().toISOString().slice(0, 10) : '');
                    const dateMatch = dateString.includes(lowerQ);

                    // Tutarın Tam Eşleşmesi (Sayısal arama yapılıyorsa)
                    let exactAmountMatch = false;
                    if (isNumericQuery) {
                        // Tutarın tam olarak girilen değere eşit olması kontrolü (virgül hassasiyetini dikkate alarak)
                        const transactionAmount = parseFloat(t.amount);
                        const threshold = 0.01; // Küçük bir hata payı
                        exactAmountMatch = Math.abs(transactionAmount - queryAmount) < threshold;
                    }

                    return categoryMatch || descriptionMatch || amountMatch || dateMatch || exactAmountMatch;
                }).sort((a, b) => {
                    // Sıralama mantığını koru: Tarihe göre yeniden eskiye
                    const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.date);
                    const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.date);
                    return dateB - dateA;
                });

                window.renderTransactionsToList(filtered, list);
            };



            // --- YILLIK FİNANSAL ÖZET (YEARLY OVERVIEW) ---
            window.currentStatsYear = new Date().getFullYear();
            window.selectedMonthFilter = null;

            window.changeStatsYear = function (delta) {
                window.currentStatsYear += delta;
                window.renderYearCalendar(window.currentStatsYear);
            };

            window.renderYearCalendar = function (year) {
                const grid = document.getElementById('calendar-year-grid');
                const label = document.getElementById('calendar-year-label');
                if (!grid || !label) return;

                label.innerText = year;
                grid.innerHTML = '';

                // Minimalist Ay İsimleri
                const monthShortNames = ["OCA", "ŞUB", "MAR", "NİS", "MAY", "HAZ", "TEM", "AĞU", "EYL", "EKİ", "KAS", "ARA"];

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // Yıllık verileri kontrol et (Sadece veri var mı diye bakıyoruz)
                const monthlyHasData = Array(12).fill(false);
                if (window.transactions) {
                    window.transactions.forEach(t => {
                        const d = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                        if (d.getFullYear() === year) {
                            monthlyHasData[d.getMonth()] = true;
                        }
                    });
                }

                for (let m = 0; m < 12; m++) {
                    const hasData = monthlyHasData[m];
                    const isCurrent = (year === currentYear && m === currentMonth);
                    const isActive = window.selectedMonthFilter && window.selectedMonthFilter.year === year && window.selectedMonthFilter.month === m;

                    // Minimalist Button Styles
                    let btnClass = "flex flex-col items-center justify-center py-4 px-2 min-w-[60px] rounded-2xl transition-all duration-300 relative group border border-transparent shrink-0";
                    let textClass = "font-black text-xs tracking-widest";

                    if (isActive) {
                        btnClass += " bg-indigo-600 dark:bg-indigo-500 text-white shadow-lg scale-105";
                        textClass += " text-white";
                    } else if (isCurrent) {
                        btnClass += " bg-white dark:bg-white/10 text-indigo-600 dark:text-indigo-400 border-indigo-100 dark:border-white/10 shadow-sm";
                        textClass += " text-indigo-600 dark:text-indigo-400";
                    } else {
                        btnClass += " hover:bg-white/40 dark:hover:bg-white/5 text-gray-400 dark:text-gray-500";
                        textClass += " text-gray-400 dark:text-gray-500 group-hover:text-gray-600 dark:group-hover:text-gray-300";
                    }

                    const html = `
                <button onclick="window.filterTransactionsByMonth(${year}, ${m})" class="${btnClass}">
                    <span class="${textClass}">${monthShortNames[m]}</span>
                    ${hasData ? `<div class="w-1.5 h-1.5 rounded-full mt-2 ${isActive ? 'bg-white' : 'bg-indigo-400'}"></div>` : `<div class="w-1.5 h-1.5 mt-2"></div>`}
                </button>`;

                    grid.insertAdjacentHTML('beforeend', html);
                }
            };

            window.filterTransactionsByMonth = function (year, month) {
                if (window.selectedMonthFilter && window.selectedMonthFilter.year === year && window.selectedMonthFilter.month === month) {
                    window.selectedMonthFilter = null; // Toggle off
                } else {
                    window.selectedMonthFilter = { year, month };
                }

                // UI Update
                window.renderYearCalendar(year);

                // Filter List
                const list = document.getElementById('full-history-list');
                if (!window.selectedMonthFilter) {
                    window.searchTransactions(''); // Reset
                    return;
                }

                const filtered = window.transactions.filter(t => {
                    const d = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    return d.getFullYear() === year && d.getMonth() === month;
                }).sort((a, b) => {
                    const dA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.date);
                    const dB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.date);
                    return dB - dA;
                });

                window.renderTransactionsToList(filtered, list);
            };

            // Geri Uyumluluk İçin (Eski fonksiyonu Shim olarak tutuyoruz)
            window.renderCalendar = function (date) {
                // Argümanı yoksay, currentStatsYear kullan
                window.renderYearCalendar(window.currentStatsYear || new Date().getFullYear());
            };

            window.clearDateFilter = function () {
                window.selectedMonthFilter = null;
                window.renderYearCalendar(window.currentStatsYear);
                window.searchTransactions('');
            };

            window.resetTabScrollToTop = function (targetScreenEl) {
                // Ana scroller: uygulamada tek scroll eden alan main
                const mainScroller =
                    document.querySelector('main.custom-scroll') ||
                    document.querySelector('main.flex-1.overflow-y-auto') ||
                    document.querySelector('main');

                // iOS / mobil tutarlılık için: scroll davranışını geçici "auto" yap
                const setTop = (el) => {
                    if (!el) return;
                    const prev = el.style.scrollBehavior;
                    el.style.scrollBehavior = 'auto';
                    el.scrollTop = 0;
                    el.scrollLeft = 0;
                    // bazı cihazlarda scrollTop tek seferde tutmayabiliyor
                    el.scrollTo(0, 0);
                    requestAnimationFrame(() => {
                        el.scrollTop = 0;
                        el.scrollLeft = 0;
                        el.style.scrollBehavior = prev;
                    });
                };

                // Nav drag/swipe algısı varsa programatik scroll flag’iyle çakışmayı önle
                if (typeof isProgrammaticScroll !== 'undefined') {
                    isProgrammaticScroll = true;
                    setTimeout(() => { isProgrammaticScroll = false; }, 180);
                }

                // 1) Ana scroller’ı üste al
                setTop(mainScroller);

                // 2) Ek güvenlik: hedef ekranın içinde bağımsız scroll alanları varsa onları da sıfırla
                if (targetScreenEl) {
                    const innerScrollers = targetScreenEl.querySelectorAll(
                        '.custom-scroll, .overflow-y-auto, [data-scroll], [data-scrollable]'
                    );
                    innerScrollers.forEach(setTop);
                }

                // 3) Son fallback (bazı webview’lar için)
                window.scrollTo(0, 0);
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
            };

            // ═══════════════════════════════════════════════════════════════
            // TAB SWITCH PIPELINE ARCHITECTURE (Base + Plugins)
            // ═══════════════════════════════════════════════════════════════

            // 1. Helper: Navigasyon Blob Hareketi
            window.moveNavBlob = function (tabName) {
                const navBtnId = tabName === 'notes' ? 'nav-notes' : `nav-${tabName}`;
                // iOS 26 Liquid Glass Blob Animasyonu
                if (window.updateLiquidBlob) window.updateLiquidBlob(navBtnId);
                if (window.updateNavIndicator) window.updateNavIndicator(navBtnId);
            };

            // 2. Helper: Dashboard / Autopilot Veri Güncellemeleri
            window.runAutopilotIfNeeded = function (tabName) {
                if (tabName === 'dashboard') {
                    setTimeout(() => {
                        // Chart güncelleme (orijinal logic)
                        if (window.currentChartType === 'category' && window.initCategoryChart) window.initCategoryChart();
                        else if (window.processTransactions) window.processTransactions(window.transactions || []);

                        // Sparklines güncelleme (eski wrapper'dan taşındı)
                        if (window.updateDashboardSparklines) window.updateDashboardSparklines();
                    }, 100);
                }

                if (tabName === 'wallet') {
                    setTimeout(() => {
                        if (window.updateAutopilotDashboard) window.updateAutopilotDashboard();
                    }, 50);
                }
            };

            // 3. Helper: AI Asistan Selamlaması
            window.updateAIGreetingIfNeeded = function (tabName) {
                if (tabName === 'assistant' && window.FingoAI && window.FingoAI.isInitialized) {
                    setTimeout(() => {
                        window.FingoAI.updateGreeting();
                    }, 300);
                }
            };

            // 4. Base Function: Çekirdek Geçiş Mantığı
            window.__baseSwitchTab = function (tabName) {
                // YENİ EKLENEN KISIM: Asistan sekmesi için Premium kontrolü
                if (tabName === 'assistant') {
                    if (window.checkPremiumFeature && !window.checkPremiumFeature('ai_chat')) return false;
                }

                // Fingo Brain (wallet/autopilot) sekmesi için Premium kontrolü
                if (tabName === 'wallet') {
                    // Centralized premium check (AppStorage + localStorage + Global State)
                    const isPro = (window.userStatus === 'pro') ||
                        (window.PremiumManager && window.PremiumManager.isPremium) ||
                        (localStorage.getItem('user_status') === 'pro');

                    if (!isPro) {
                        console.log('[SwitchTab] Wallet access denied - Premium required');
                        // Premium modal aç ve erişimi engelle
                        const modal = document.getElementById('premium-modal');
                        if (modal) modal.classList.remove('hidden');
                        return false; // Blocked
                    }
                }

                // Global Chart Type state (Dashboard için)
                if (typeof currentChartType !== 'undefined') {
                    currentChartType = tabName === 'dashboard' ? 'general' : currentChartType;
                }

                // Ekran Navigasyonu
                document.querySelectorAll('[id^="screen-"]').forEach(el => {
                    if (el.id !== `screen-${tabName}`) el.classList.add('hidden');
                });
                const target = document.getElementById(`screen-${tabName}`);
                if (target) target.classList.remove('hidden');

                // ✅ Tab değişince her zaman ekranın en üstünden başlat
                if (window.resetTabScrollToTop) window.resetTabScrollToTop(target);

                // Alt Navigasyon Buton Aktifliği
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navBtnId = tabName === 'notes' ? 'nav-notes' : `nav-${tabName}`;
                const navBtn = document.getElementById(navBtnId);
                if (navBtn && tabName !== 'add') navBtn.classList.add('active');

                // Tab'a Özel İşlemler
                if (tabName === 'add') {
                    if (window.cancelEdit) window.cancelEdit();
                    const dInput = document.getElementById('input-date');
                    if (dInput) dInput.value = new Date().toISOString().slice(0, 10);
                    if (window.updateCategoryOptions) window.updateCategoryOptions();
                    if (window.setTransactionType && typeof currentType !== 'undefined') window.setTransactionType(currentType);
                    const feedbackEl = document.getElementById('transaction-feedback');
                    if (feedbackEl) feedbackEl.classList.add('hidden');
                }

                if (tabName === 'doviz' && !marketDataLoaded && window.fetchMarketData) window.fetchMarketData();

                if (tabName === 'notes') {
                    if (window.currentNotesMode === 'task') window.setNotesMode('task');
                    else window.setNotesMode('installment');
                    // Ensure notes are rendered when switching to notes tab
                    if (window.renderNotes) window.renderNotes();
                }

                if (tabName === 'dashboard' && window.updateHealthStatus) { window.updateHealthStatus(); }
                if (tabName === 'assistant' && window.updateHealthStatus) { window.updateHealthStatus(); }

                // HISTORY TAB - RESET CALENDAR
                if (tabName === 'history') {
                    window.currentStatsYear = new Date().getFullYear();
                    if (window.renderYearCalendar) window.renderYearCalendar(window.currentStatsYear);
                    if (window.searchTransactions) window.searchTransactions('');
                }

                // PREMIUM MINI-BADGE - Tab değişiminde güncelle
                if (window.refreshPremiumMiniBadges) {
                    setTimeout(window.refreshPremiumMiniBadges, 100);
                }

                return true;
            };

            // 5. Master Function: Pipeline Yöneticisi
            window.switchTab = function (tabName) {
                // A) Temel geçişi dene
                const ok = window.__baseSwitchTab(tabName);

                // B) Eğer engellendiyse (örn: premium) durdur
                if (ok === false) return false;

                // C) Başarılıysa yan etkileri (pluginleri) çalıştır
                window.moveNavBlob(tabName);
                window.runAutopilotIfNeeded(tabName);
                window.updateAIGreetingIfNeeded(tabName);

                return true;
            };



            // --- iOS 26 LIQUID GLASS BLOB & DRAG-TAP NAVIGATION ---

            // Tab sırası (ortadaki 'add' hariç, sürükleme ile değiştirilemez)
            const navTabOrder = ['dashboard', 'notes', 'doviz', 'wallet'];
            let currentActiveTab = 'dashboard';
            let navDragState = {
                isDragging: false,
                startX: 0,
                startY: 0,
                currentX: 0,
                hasMoved: false
            };

            // Flag: Tıklama ile tetiklenen scroll sırasında swipe algılamayı devre dışı bırak
            let isProgrammaticScroll = false;

            // Blob pozisyonunu güncelle
            window.updateLiquidBlob = function (navBtnId, animate = true) {
                const blob = document.getElementById('nav-liquid-blob');
                const nav = document.getElementById('main-nav');

                if (!blob || !nav) return;

                // Ekle butonu seçildiğinde blob'u gizle (Yeni İşlem ekranı)
                if (!navBtnId || navBtnId === 'nav-add') {
                    blob.classList.add('blob-hidden');
                    blob.style.opacity = '0';
                    blob.style.pointerEvents = 'none';
                    blob.style.transform = 'translateY(-50%) scale(0.6)';
                    return;
                }

                // Blob'u tekrar göster
                blob.classList.remove('blob-hidden');
                blob.style.opacity = '1';
                blob.style.pointerEvents = 'auto';

                const btn = document.getElementById(navBtnId);
                if (!btn) return;

                const btnRect = btn.getBoundingClientRect();
                const navRect = nav.getBoundingClientRect();

                // Pozisyonu hesapla
                const left = btnRect.left - navRect.left + (btnRect.width / 2) - 30;

                if (animate) {
                    blob.classList.add('bounce-back');
                    blob.classList.remove('stretch-left', 'stretch-right');
                } else {
                    blob.classList.remove('bounce-back');
                }

                blob.style.left = left + 'px';
                blob.style.width = '60px';
                blob.style.transform = 'translateY(-50%) scaleX(1) scaleY(1)';

                // Animasyon sonrası sınıfları temizle
                if (animate) {
                    setTimeout(() => {
                        blob.classList.remove('bounce-back');
                    }, 500);
                }
            };

            // Aktif tab indeksini al
            function getActiveTabIndex() {
                return navTabOrder.indexOf(currentActiveTab);
            }

            // Sürükleme başlatıcı
            function initNavDragAndTap() {
                const nav = document.getElementById('main-nav');
                const blob = document.getElementById('nav-liquid-blob');

                if (!nav || !blob) return;

                // Touch Events
                nav.addEventListener('touchstart', handleDragStart, { passive: true });
                nav.addEventListener('touchmove', handleDragMove, { passive: false });
                nav.addEventListener('touchend', handleDragEnd, { passive: true });

                // Mouse Events (Desktop)
                nav.addEventListener('mousedown', handleDragStart);
                nav.addEventListener('mousemove', handleDragMove);
                nav.addEventListener('mouseup', handleDragEnd);
                nav.addEventListener('mouseleave', handleDragEnd);

                // İlk blob pozisyonunu ayarla
                setTimeout(() => {
                    window.updateLiquidBlob('nav-dashboard', false);
                }, 100);
            }

            function handleDragStart(e) {
                // Butonlara dokunulduğunda sürükleme başlatma (tap olarak çalışsın)
                if (e.target.closest('button')) {
                    navDragState.hasMoved = false;
                }

                const touch = e.touches ? e.touches[0] : e;
                navDragState.startX = touch.clientX;
                navDragState.startY = touch.clientY;
                navDragState.currentX = touch.clientX;
                navDragState.isDragging = true;
                navDragState.hasMoved = false;
            }

            function handleDragMove(e) {
                if (!navDragState.isDragging) return;

                const touch = e.touches ? e.touches[0] : e;
                const deltaX = touch.clientX - navDragState.startX;
                const deltaY = touch.clientY - navDragState.startY;

                // Yatay sürükleme kontrolü (dikey sürüklemeden ayır)
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                    navDragState.hasMoved = true;
                    if (e.cancelable && e.preventDefault) e.preventDefault();

                    // Body'e drag sınıfı ekle
                    document.body.classList.add('nav-dragging');

                    // Blob'a 3D Jelly Stretch efekti uygula
                    applyJellyStretch(deltaX);
                }

                navDragState.currentX = touch.clientX;
            }

            function handleDragEnd(e) {
                if (!navDragState.isDragging) return;

                const deltaX = navDragState.currentX - navDragState.startX;
                const threshold = 50; // Minimum sürükleme mesafesi

                // Drag sınıfını kaldır
                document.body.classList.remove('nav-dragging');

                // Jelly stretch'i sıfırla
                const blob = document.getElementById('nav-liquid-blob');
                if (blob) {
                    blob.classList.remove('stretch-left', 'stretch-right');
                    blob.classList.add('bounce-back');
                    blob.style.transform = 'translateY(-50%) scaleX(1) scaleY(1)';

                    setTimeout(() => {
                        blob.classList.remove('bounce-back');
                    }, 500);
                }

                // Yeterli mesafe sürüklendiyse tab değiştir
                // Flag kontrolü: Programmatic scroll sırasında tab değiştirme
                if (isProgrammaticScroll) {
                    navDragState.isDragging = false;
                    navDragState.hasMoved = false;
                    return;
                }

                if (navDragState.hasMoved && Math.abs(deltaX) > threshold) {
                    const currentIndex = getActiveTabIndex();
                    let newIndex;

                    if (deltaX < 0) {
                        // Sola sürükleme -> sonraki tab
                        newIndex = Math.min(currentIndex + 1, navTabOrder.length - 1);
                    } else {
                        // Sağa sürükleme -> önceki tab
                        newIndex = Math.max(currentIndex - 1, 0);
                    }

                    if (newIndex !== currentIndex) {
                        const newTab = navTabOrder[newIndex];
                        currentActiveTab = newTab;
                        window.switchTab(newTab, true); // fromSwipe = true
                    }
                }

                navDragState.isDragging = false;
                navDragState.hasMoved = false;
            }

            function applyJellyStretch(deltaX) {
                const blob = document.getElementById('nav-liquid-blob');
                if (!blob) return;

                // Sürükleme mesafesine göre stretch hesapla
                const dragRatio = Math.min(Math.abs(deltaX) / 100, 1);
                const scaleX = 1 + (dragRatio * 0.5);  // 1.0 -> 1.5
                const scaleY = 1 - (dragRatio * 0.15); // 1.0 -> 0.85
                const translateX = deltaX * 0.3; // Blob'u hareket yönünde kaydır

                // Yöne göre stretch sınıfı
                blob.classList.remove('stretch-left', 'stretch-right', 'bounce-back');
                if (deltaX > 0) {
                    blob.classList.add('stretch-right');
                } else {
                    blob.classList.add('stretch-left');
                }

                // Transform uygula
                blob.style.transition = 'none';
                blob.style.transform = `translateY(-50%) translateX(${translateX}px) scaleX(${scaleX}) scaleY(${scaleY})`;
            }

            // Sayfa yüklendiğinde başlat
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initNavDragAndTap, 500);
            });

            // switchTab çağrıldığında aktif tab'ı güncelle
            const originalSwitchTabForNav = window.switchTab;
            window.switchTab = function (tabName, fromSwipe = false) {
                // Tıklama ile tetikleniyorsa (swipe değilse) flag'ı aktifle
                if (!fromSwipe) {
                    isProgrammaticScroll = true;
                    // 500ms sonra flag'ı sıfırla
                    setTimeout(() => {
                        isProgrammaticScroll = false;
                    }, 500);
                }

                if (navTabOrder.includes(tabName)) {
                    currentActiveTab = tabName;
                }
                if (originalSwitchTabForNav(tabName) === false) return;

                // Nav-item active sınıflarını güncelle
                const navItems = document.querySelectorAll('#main-nav .nav-item');
                navItems.forEach(item => {
                    if (item.id === `nav-${tabName}`) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });


                // Blob pozisyonunu / görünürlüğünü güncelle (add dahil)
                if (window.updateLiquidBlob) {
                    if (tabName === 'add') {
                        window.updateLiquidBlob('nav-add');   // add ekranında blob'u gizlemeli
                    } else {
                        window.updateLiquidBlob(`nav-${tabName}`);
                    }
                } else {
                    // Fallback (updateLiquidBlob yoksa bile add ekranında gizle)
                    const blob = document.getElementById('nav-liquid-blob');
                    if (blob) {
                        blob.style.opacity = (tabName === 'add') ? '0' : '1';
                        blob.style.pointerEvents = (tabName === 'add') ? 'none' : 'auto';
                    }
                }
            };

            // --- TAM VE DÜZELTİLMİŞ ANALİZ KODLARI (BAŞLANGIÇ) ---

            // 1. Global Değişkenler
            let trendChartInstance = null;
            let currentTrendType = 'expense';

            // 2. Yapay Zeka Tahmin Motoru (TensorFlow.js)
            async function predictWithAI(transactions, targetMonth, targetYear) {
                const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
                let cumulative = 0;

                // Veriyi Hazırla
                const sortedTx = transactions
                    .filter(t => {
                        const d = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                        return d.getMonth() === targetMonth && d.getFullYear() === targetYear && t.type === 'expense' && !isSavingsTransaction(t);
                    })
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if (sortedTx.length < 2) return 0;

                const dataMap = {};
                sortedTx.forEach(t => {
                    const day = (t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date)).getDate();
                    cumulative += parseFloat(t.amount);
                    dataMap[day] = cumulative;
                });

                const xValues = [];
                const yValues = [];
                Object.keys(dataMap).forEach(day => {
                    xValues.push(parseInt(day) / daysInMonth);
                    yValues.push(dataMap[day]);
                });

                // AI Modelini Oluştur ve Eğit
                const model = tf.sequential();
                model.add(tf.layers.dense({ units: 1, inputShape: [1] }));
                model.compile({ loss: 'meanSquaredError', optimizer: 'sgd' });

                const xs = tf.tensor2d(xValues, [xValues.length, 1]);
                const ys = tf.tensor2d(yValues, [yValues.length, 1]);

                await model.fit(xs, ys, { epochs: 250, shuffle: true });

                // Tahmin Yap (Ay sonu = 1.0)
                const predictionTensor = model.predict(tf.tensor2d([1], [1, 1]));
                const predictedValue = predictionTensor.dataSync()[0];
                return predictedValue;
            };

            // --- DÜZELTİLMİŞ GRAFİK GEÇİŞ VE GÖRÜNÜRLÜK AYARI ---
            window.switchChart = function (type) {
                // Trendler özelliği kaldırıldı. Sadece genel grafik modunda kal.
                currentChartType = 'general';

                // UI Elementlerini Güncelle
                const mainC = document.getElementById('mainChart');
                const trendC = document.getElementById('trendChart');
                const insightBox = document.getElementById('category-top-list')?.parentElement;

                if (mainC) mainC.classList.remove('opacity-0', 'pointer-events-none');
                if (trendC) trendC.classList.add('opacity-0', 'pointer-events-none');
                if (insightBox) insightBox.classList.remove('hidden');

                // Buton Stillerini Resetle
                ['general', 'trends'].forEach(t => {
                    const btn = document.getElementById(`btn-chart-${t}`);
                    if (btn) {
                        if (t === 'general') {
                            btn.className = "px-3 py-1.5 rounded-lg text-[10px] font-bold bg-white dark:bg-gray-700 shadow-sm text-indigo-600 dark:text-indigo-400 transition-all transform scale-105";
                        } else {
                            btn.className = "px-3 py-1.5 rounded-lg text-[10px] font-bold text-gray-600 hover:bg-white/50 transition opacity-50 cursor-not-allowed";
                        }
                    }
                });

                if (typeof window.processTransactions === 'function' && window.transactions) {
                    window.processTransactions(window.transactions);
                }
            };

            // --- YENİ NESİL SAĞLIK KARTI (FİNANSAL SKOR) ---
            window.updateHealthStatus = function () {
                const container = document.getElementById('health-status-content'); if (!container) return;

                const targetMonth = currentDate.getMonth();
                const targetYear = currentDate.getFullYear();
                let income = 0, expense = 0;

                // Verileri Hesapla
                transactions.forEach(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    if (tDate.getMonth() === targetMonth && tDate.getFullYear() === targetYear) {
                        const val = parseFloat(t.amount);
                        if (t.type === 'income') income += val;
                        else if (t.type === 'expense') expense += val;
                    }
                });

                // Basit bir sağlık skoru (Tasarruf Oranı)
                let score = 0;
                if (income > 0) {
                    score = ((income - expense) / income) * 100;
                    if (score < 0) score = 0;
                    if (score > 100) score = 100; // Mantıken olmaz ama harcama olmasa 100
                }

                let message = "Harika gidiyorsun! 🚀";
                let color = "text-green-500";
                let barColor = "text-green-500";

                if (score < 10) {
                    message = "Harcamalarına dikkat etmelisin. ⚠️";
                    color = "text-red-500";
                    barColor = "text-red-500";
                } else if (score < 30) {
                    message = "İyisin, ama daha çok biriktirebilirsin. 💡";
                    color = "text-yellow-500";
                    barColor = "text-yellow-500";
                }

                // SVG Circle Progress Logic
                const radius = 28;
                const circumference = 2 * Math.PI * radius; // ~175.9
                const offset = circumference - (score / 100) * circumference;

                container.innerHTML = `
            <div class="flex items-center space-x-4 mb-3">
                <div class="relative w-16 h-16 flex items-center justify-center shrink-0">
                    <svg class="w-full h-full transform -rotate-90 drop-shadow-md">
                        <circle cx="32" cy="32" r="${radius}" stroke="currentColor" stroke-width="6" fill="none" class="text-gray-200 dark:text-gray-700" />
                        <circle cx="32" cy="32" r="${radius}" stroke="currentColor" stroke-width="6" fill="none" class="${barColor} transition-all duration-1000 ease-out" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round" />
                    </svg>
                    <span class="absolute text-sm font-black ${color}">${Math.round(score)}%</span>
                </div>
                <div class="flex-1 min-w-0">
                    <h5 class="font-bold text-gray-800 dark:text-white text-sm truncate">Finansal Skor</h5>
                    <p class="text-[10px] text-gray-600 dark:text-gray-300 leading-relaxed font-medium line-clamp-2">${message}</p>
                </div>
            </div>
            
            <div class="mt-3 flex justify-between text-[9px] text-gray-400 font-bold border-t border-gray-100 dark:border-white/5 pt-2">
                <span>Gelir: <span class="text-gray-600 dark:text-gray-300 font-black">${income.toLocaleString('tr-TR')} ₺</span></span>
                <span>Gider: <span class="text-gray-600 dark:text-gray-300 font-black">${expense.toLocaleString('tr-TR')} ₺</span></span>
            </div>
            `;
            };

            // --- DETAYLI İSTATİSTİK PENCERESİ (YENİLENMİŞ) ---
            // --- DETAYLI İSTATİSTİK PENCERESİ (YENİLENMİŞ) ---
            window.openDetailedStats = function (type) {
                const modal = document.getElementById('detailed-stats-modal');
                const titleEl = document.getElementById('detailed-stats-title');
                const listEl = document.getElementById('detailed-stats-list');
                const canvas = document.getElementById('detailedStatsChart');
                const totalDisplay = document.getElementById('chart-total-amount');

                if (!modal || !titleEl || !listEl || !canvas) return;

                // Modal'ı Göster
                modal.classList.remove('hidden');

                titleEl.innerText = type === 'income' ? 'GELİR ANALİZİ' : 'GİDER ANALİZİ';

                const targetMonth = currentDate.getMonth();
                const targetYear = currentDate.getFullYear();

                let filteredData = transactions.filter(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    const d = tDate;
                    // viewScope 'year' ise sadece yıl, değilse ay ve yıl kontrolü
                    const dateMatch = viewScope === 'year' ? d.getFullYear() === targetYear : (d.getMonth() === targetMonth && d.getFullYear() === targetYear);
                    return dateMatch && t.type === type;
                });

                if (type === 'expense') { filteredData = filteredData.filter(t => !isSavingsTransaction(t)); }

                const cats = {}; let total = 0;
                filteredData.forEach(t => { cats[t.category] = (cats[t.category] || 0) + parseFloat(t.amount); total += parseFloat(t.amount); });
                const labels = Object.keys(cats); const data = Object.values(cats);

                // Renk Paleti (Hybrid: Light için canlı, Dark için neon)
                const ctx = canvas.getContext('2d');
                const gradients = labels.map((_, i) => {
                    // Basit düz renkler yerine CSS değişkenlerine uyumlu hex kodları
                    // Sırasıyla: Mavi, Mor, Pembe, Turuncu, Yeşil, İndigo, Kırmızı
                    const colors = ['#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#6366F1', '#F43F5E'];
                    return colors[i % colors.length];
                });

                if (detailedChartInstance) { detailedChartInstance.destroy(); }

                // Merkez Metni Güncelle (Toplam Tutar)
                if (totalDisplay) totalDisplay.innerText = total.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ₺';

                detailedChartInstance = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: gradients,
                            borderWidth: 0,
                            hoverOffset: 10,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '90%', // İNCE HALKA
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#e2e8f0',
                                bodyFont: { family: "'Inter', sans-serif", weight: 'bold' },
                                padding: 12,
                                cornerRadius: 12,
                                displayColors: true,
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        elements: {
                            arc: {
                                borderRadius: 20, // YUVARLAK UÇLAR
                                borderWidth: 0
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });

                listEl.innerHTML = '';
                if (labels.length === 0) {
                    listEl.innerHTML = `<div class="flex flex-col items-center justify-center py-10 opacity-50"><span class="text-4xl mb-2">📊</span><p class="text-slate-400 dark:text-indigo-200 text-xs">Bu dönemde işlem verisi yok.</p></div>`;
                } else {
                    const sorted = labels.map((l, i) => ({ label: l, value: data[i], colorIndex: i % 7 })).sort((a, b) => b.value - a.value);
                    const solidColors = ['#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#6366F1', '#F43F5E'];

                    sorted.forEach((item, index) => {
                        const percentage = ((item.value / total) * 100).toFixed(1);
                        const itemColor = solidColors[item.colorIndex];

                        let budgetHtml = '';
                        const budgetLimit = categoryBudgets[item.label];
                        if (budgetLimit && type === 'expense') {
                            const usagePct = (item.value / budgetLimit) * 100;
                            let barColor = 'bg-emerald-500';
                            if (usagePct >= 100) barColor = 'bg-red-500'; else if (usagePct >= 80) barColor = 'bg-yellow-500';

                            budgetHtml = `
                        <div class="mt-2.5 relative group-hover:opacity-100 transition-opacity">
                             <div class="flex justify-between text-[9px] text-slate-400 dark:text-gray-400 mb-1">
                                <span>Limit: ${parseFloat(budgetLimit).toLocaleString('tr-TR')} ₺</span>
                                <span class="${usagePct >= 100 ? 'text-red-500 font-bold' : 'text-emerald-500 font-bold'}">%${usagePct.toFixed(0)}</span>
                            </div>
                            <div class="w-full bg-slate-100 dark:bg-black/30 rounded-full h-1.5 overflow-hidden">
                                <div class="h-full ${barColor} transition-all duration-1000 ease-out" style="width: ${Math.min(100, usagePct)}%"></div>
                            </div>
                        </div>`;
                        }

                        // Card Item HTML (Minimalist Style)
                        const html = `
                    <div class="flex items-center justify-between py-3 border-b border-gray-100 dark:border-white/5 last:border-0 animate-slide-up group" style="animation-delay: ${index * 50}ms">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm" 
                                 style="background-color: ${itemColor}20; color: ${itemColor};">
                                ${Array.from(item.label)[0] || ''}
                            </div>
                            
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-gray-700 dark:text-gray-200 leading-none">${item.label}</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="w-16 h-1 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full" style="width: ${percentage}%; background-color: ${itemColor};"></div>
                                    </div>
                                    <span class="text-[10px] font-medium text-gray-400">%${percentage}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <span class="text-sm font-bold text-gray-800 dark:text-white tracking-tight">${item.value.toLocaleString('tr-TR')} ₺</span>
                            ${budgetHtml ? '' : ''} 
                        </div>
                    </div>
                    ${budgetHtml ? `<div class="mb-2 mt-1">${budgetHtml}</div>` : ''} 
                    `;

                        listEl.insertAdjacentHTML('beforeend', html);
                    });
                }
            };

            window.closeDetailedStats = function () { const modal = document.getElementById('detailed-stats-modal'); if (modal) modal.classList.add('hidden'); };

            window.openBudgetModal = function () {
                const select = document.getElementById('budget-category'); select.innerHTML = '';
                categories.expense.filter(c => !isSavings(c)).forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.text = c; select.appendChild(opt); });
                document.getElementById('budget-amount').value = ''; document.getElementById('budget-modal').classList.remove('hidden');
            };

            window.saveBudget = function () {
                const category = document.getElementById('budget-category').value; const amount = window.parseSimpleCurrency(document.getElementById('budget-amount').value);
                if (!category || isNaN(amount) || amount <= 0) { window.alertMessage("Hata", "Lütfen geçerli bir limit giriniz.", "red"); return; }
                categoryBudgets[category] = amount; localStorage.setItem(`my_budgets_${APP_YEAR}`, JSON.stringify(categoryBudgets));
                document.getElementById('budget-modal').classList.add('hidden'); window.alertMessage("Başarılı", `${category} için limit belirlendi.`, "blue");
                if (!document.getElementById('detailed-stats-modal').classList.contains('hidden')) { window.openDetailedStats('expense'); }
            };

            // --- GÜNCELLENMİŞ EXCEL DIŞA AKTARMA (TÜRKÇE & EMOJİ FIX) ---
            // --- GÜNCELLENMİŞ EXCEL DIŞA AKTARMA (TÜRKÇE & EMOJİ FIX) ---
            // --- GÜNCELLENMİŞ EXCEL DIŞA AKTARMA (EMOJISIZ & DETAYLI) ---
            window.exportToCSV = function () {
                if (!window.checkPremiumFeature('excel_export')) return;
                if (transactions.length === 0) { window.alertMessage('Uyarı', 'Dışa aktarılacak veri yok.', 'red'); return; }

                // Sadece izin verilen karakterleri tutan temizleyici
                const removeEmojis = (str) => {
                    if (!str) return "";
                    return str.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ\s.,\-()\/%&+]/g, '').trim();
                };

                let csvContent = "Tarih;Kategori;Tutar;Tip;Aciklama;Yatirim_Miktari\n";

                transactions.forEach(function (t) {
                    const amount = t.amount.toString().replace('.', ',');
                    const unit = t.unitAmount ? t.unitAmount.toString().replace('.', ',') : '';

                    let tDate = t.date;
                    if (t.timestamp && t.timestamp.toDate) {
                        tDate = t.timestamp.toDate().toLocaleDateString('tr-TR');
                    } else if (t.timestamp && typeof t.timestamp === 'string') {
                        tDate = new Date(t.timestamp).toLocaleDateString('tr-TR');
                    }

                    let typeLabel = t.type === 'income' ? 'Gelir' : 'Gider';
                    if (t.type === 'expense' && isSavingsTransaction(t)) {
                        typeLabel = 'Birikim';
                    }

                    // Temizleme işlemi
                    const cleanDesc = removeEmojis((t.description || '').replace(/;/g, ' ').replace(/\n/g, ' '));
                    const cleanCat = removeEmojis(t.category.replace(/;/g, ' '));

                    let row = `${tDate};"${cleanCat}";"${amount}";"${typeLabel}";"${cleanDesc}";"${unit}"`;
                    csvContent += row + "\n";
                });

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Fingenda_Rapor_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- GÜNCELLENMİŞ PDF RAPORLAMA (PREMIUM & TÜRKÇE FIX) ---
            // --- GÜNCELLENMİŞ PDF RAPORLAMA (TÜRKÇE KARAKTER FIX) ---
            // --- GÜNCELLENMİŞ PDF RAPORLAMA (TÜRKÇE & EMOJİ FIX) ---
            // --- GÜNCELLENMİŞ PDF RAPORLAMA (EMOJISIZ & DETAYLI ÖZET) ---
            window.downloadPDFReport = function () {
                if (!window.checkPremiumFeature('excel_export')) return;
                if (transactions.length === 0) { window.alertMessage('Uyarı', 'Raporlanacak veri bulunamadı.', "red"); return; }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Sadece izin verilen karakterleri tutan temizleyici
                const removeEmojis = (str) => {
                    if (!str) return "";
                    return str.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ\s.,\-()\/%&+]/g, '').trim();
                };

                const trToEn = (str) => {
                    if (!str) return "";
                    let cleanStr = removeEmojis(str); // Önce emojileri ve sembolleri temizle
                    const map = {
                        'ğ': 'g', 'Ğ': 'G', 'ü': 'u', 'Ü': 'U', 'ş': 's', 'Ş': 'S',
                        'ı': 'i', 'İ': 'I', 'ö': 'o', 'Ö': 'O', 'ç': 'c', 'Ç': 'C', '₺': 'TL',
                        'â': 'a', 'î': 'i', 'û': 'u'
                    };
                    return cleanStr.replace(/[ğĞüÜşŞıİöÖçÇ₺âîû]/g, function (m) { return map[m]; });
                };

                let totalIncome = 0;
                let totalExpense = 0;
                let totalSavings = 0;

                transactions.forEach(t => {
                    const val = parseFloat(t.amount);
                    if (t.type === 'income') {
                        totalIncome += val;
                    } else {
                        if (isSavingsTransaction(t)) {
                            totalSavings += val;
                        } else {
                            totalExpense += val;
                        }
                    }
                });

                const netStatus = totalIncome - totalExpense;

                doc.setFontSize(20);
                doc.setTextColor(50, 50, 50);
                doc.text("Fingenda Finans Raporu", 14, 20);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR')}`, 14, 26);
                doc.line(14, 30, 196, 30);

                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");

                doc.setTextColor(22, 163, 74);
                doc.text(trToEn(`Toplam Gelir: +${totalIncome.toLocaleString('tr-TR')} TL`), 14, 40);

                doc.setTextColor(220, 38, 38);
                doc.text(trToEn(`Toplam Gider: -${totalExpense.toLocaleString('tr-TR')} TL`), 14, 46);

                doc.setTextColor(37, 99, 235);
                doc.text(trToEn(`Toplam Birikim: ${totalSavings.toLocaleString('tr-TR')} TL`), 110, 40);

                doc.setTextColor(0, 0, 0);
                doc.text(trToEn(`Net Durum: ${netStatus.toLocaleString('tr-TR')} TL`), 110, 46);

                const tableData = transactions.map(t => {
                    let tDate = t.date;
                    if (t.timestamp && t.timestamp.toDate) tDate = t.timestamp.toDate().toLocaleDateString('tr-TR');
                    else if (t.timestamp) tDate = new Date(t.timestamp).toLocaleDateString('tr-TR');

                    let typeLabel = t.type === 'income' ? 'Gelir' : 'Gider';
                    if (t.type === 'expense' && isSavingsTransaction(t)) {
                        typeLabel = 'Birikim';
                    }

                    return [
                        tDate,
                        trToEn(t.category),
                        t.amount.toLocaleString('tr-TR') + ' TL',
                        trToEn(typeLabel),
                        trToEn(t.description || '-')
                    ];
                });

                doc.autoTable({
                    head: [['Tarih', 'Kategori', 'Tutar', 'Tip', 'Aciklama']],
                    body: tableData,
                    startY: 55,
                    theme: 'striped',
                    headStyles: { fillColor: [40, 40, 40] },
                    styles: { fontSize: 9, cellPadding: 3 },
                    didParseCell: function (data) {
                        if (data.section === 'body' && data.column.index === 2) {
                            const rowType = data.row.raw[3];
                            if (rowType === 'Gelir') data.cell.styles.textColor = [22, 163, 74];
                            else if (rowType === 'Birikim') data.cell.styles.textColor = [37, 99, 235];
                            else data.cell.styles.textColor = [220, 38, 38];
                        }
                    }
                });

                doc.save(`Fingenda_Detayli_Rapor.pdf`);
            };



            window.showMotivation = function (amount, category, type) {
                const feedbackEl = document.getElementById('transaction-feedback'); const feedbackTextEl = document.getElementById('feedback-text'); if (!feedbackEl || !feedbackTextEl) return;
                let message = "İşlem başarıyla kaydedildi!"; const amt = parseFloat(amount);
                if (type === 'income') { message = amt > 1000 ? "Harika bir gelir! Finansal hedefine bir adım daha yaklaştın. 🚀" : "Gelirinizi kaydettik. Küçük adımlar büyük sonuçlar getirir. ✨"; }
                else if (isSavings(category)) { message = "Tebrikler! Birikimini artırdın. Geleceğin için harika bir adım. 🎯"; }
                else { if (amt > 500) { message = "Harcamanızı kaydettik. Gerektiğinden emin misin? Bütçeni kontrol etmeyi unutma! 🧐"; } else if (category.includes('Eğlence') || category.includes('Giyim')) { message = "Keyifli harcama! Ancak dikkatli ol, küçük kaçamaklar birikmesin. 😉"; } else { message = "Giderin tamam. Bütçen hala kontrol altında görünüyor. 👍"; } }
                feedbackTextEl.innerText = message; feedbackEl.classList.remove('hidden'); setTimeout(() => { feedbackEl.classList.add('hidden'); }, 5000);
            };

            window.toggleRecurringOptions = function () {
                const isChecked = document.getElementById('input-recurring').checked; const opts = document.getElementById('recurring-options'); if (opts) opts.classList.toggle('hidden', !isChecked);
            };

            // === DAY CLAMPING HELPER (1-31 arası güvenli gün) ===
            function clampDay(d) { return Math.max(1, Math.min(31, parseInt(d) || 1)); }

            window.checkRecurringTransactions = async function () {
                recurringRules = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');
                const now = new Date();
                const currentDay = now.getDate();
                const currentMonthStr = now.toISOString().slice(0, 7);
                let newTxAdded = false;
                let rulesToRemove = [];

                for (const rule of recurringRules) {
                    // Gün güvenliği: 1-31 arasına sınırla
                    rule.day = clampDay(rule.day);

                    // Bu ay zaten işlendi mi?
                    if (rule.lastExecutedMonth === currentMonthStr) continue;

                    // maxRuns kontrolü: Limit dolmuş mu?
                    if (rule.maxRuns && rule.runsDone >= rule.maxRuns) {
                        rulesToRemove.push(rule.id);
                        continue;
                    }

                    // Gün geldi mi?
                    if (currentDay >= rule.day) {
                        const newTx = {
                            type: rule.type,
                            amount: rule.amount,
                            date: currentMonthStr,
                            category: rule.category,
                            description: rule.description + ' (Otomatik)',
                            unitAmount: 0,
                            timestamp: new Date().toISOString()
                        };

                        if (isLocalMode) {
                            newTx.id = 'l_auto_' + Date.now() + Math.random();
                            transactions.push(newTx);
                            window.transactions = transactions;
                            localStorage.setItem(`my_expenses_${APP_YEAR}`, JSON.stringify(transactions));
                        } else {
                            if (userId) {
                                try {
                                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/monthly_transactions`), { ...newTx, timestamp: serverTimestamp() });
                                } catch (e) { console.error("Auto transaction error:", e); }
                            }
                        }

                        rule.lastExecutedMonth = currentMonthStr;
                        rule.runsDone = (rule.runsDone || 0) + 1;
                        newTxAdded = true;

                        // Taksit kaynağıysa, ilgili taksiti güncelle
                        if (rule.source === 'installment' && rule.sourceId) {
                            const inst = installments.find(i => i.id === rule.sourceId);
                            if (inst) {
                                inst.paidMonths = (inst.paidMonths || 0) + 1;
                                inst.remainingMonths = inst.totalMonths - inst.paidMonths;
                                localStorage.setItem(`my_installments_${APP_YEAR}`, JSON.stringify(installments));

                                // Taksit tamamlandıysa bildirim göster
                                if (inst.remainingMonths <= 0) {
                                    window.showMiniToast("Taksit Tamamlandı", `"${inst.description}" taksiti bitti! 🎉`, "🎉");
                                    rulesToRemove.push(rule.id);
                                }
                            }
                        }

                        // maxRuns doldu mu kontrol et
                        if (rule.maxRuns && rule.runsDone >= rule.maxRuns) {
                            rulesToRemove.push(rule.id);
                        }
                    }
                }

                // Tamamlanan kuralları temizle
                if (rulesToRemove.length > 0) {
                    recurringRules = recurringRules.filter(r => !rulesToRemove.includes(r.id));
                }

                if (newTxAdded || rulesToRemove.length > 0) {
                    localStorage.setItem(`my_recurring_rules_${APP_YEAR}`, JSON.stringify(recurringRules));
                    if (isLocalMode) window.processTransactions(transactions);
                    if (newTxAdded) window.showMiniToast("Otomatik İşlem", "Tekrarlayan ödemeleriniz eklendi 🔄", "🔄");

                    // PATCH: Fingo Brain'i güncelle (taksit/abonelik eklendikten sonra)
                    window.__fingoBrainDirty = true;
                    if (typeof window.calculateFingoBrainPrediction === 'function') {
                        window.calculateFingoBrainPrediction();
                    }
                }
            };

            window.saveTransaction = async function () {
                let amountStr = document.getElementById('input-amount').value;
                const date = document.getElementById('input-date').value;
                const category = document.getElementById('input-category').value;
                const desc = document.getElementById('input-desc').value;
                const unitAmountStr = document.getElementById('input-investment-qty').value;

                if (!amountStr || !date || !category) { window.alertMessage("Hata", "Lütfen miktar ve kategori alanlarını doldurunuz.", "red"); return; }
                const amount = window.parseSimpleCurrency(amountStr);

                if (isNaN(amount) || amount <= 0) { window.alertMessage("Hata", "Lütfen geçerli bir tutar giriniz.", "red"); return; }

                let unitAmountVal = 0;
                if (unitAmountStr) {
                    unitAmountVal = parseFloat(unitAmountStr.replace(',', '.'));
                }

                const excludeFromBalance = document.getElementById('input-exclude-balance').checked;
                const newTx = { type: currentType, amount: amount, date, category, description: desc, unitAmount: unitAmountVal, excludeFromBalance: excludeFromBalance };

                if (currentType === 'expense' && categoryBudgets[category] && !editingTransactionId) {
                    const limit = categoryBudgets[category];
                    // Basit bütçe kontrolü (Bu ayın harcamalarını topla)
                    // ... (Mevcut bütçe mantığı korunabilir veya basitleştirilebilir)
                }

                if (editingTransactionId) {
                    const idx = transactions.findIndex(x => x.id === editingTransactionId);
                    if (idx !== -1) {
                        transactions[idx] = { ...transactions[idx], ...newTx };
                        transactions[idx].timestamp = new Date().toISOString();
                        // ASYNC SAVE
                        await AppStorage.set(`my_expenses_${APP_YEAR}`, JSON.stringify(transactions));
                        window.processTransactions(transactions);
                    }
                    window.alertMessage("Başarılı", "Kayıt güncellendi.", "blue");
                    editingTransactionId = null;
                    document.getElementById('save-btn').textContent = 'Kaydet';
                    document.getElementById('cancel-edit-btn').classList.add('hidden');
                } else {
                    newTx.id = 'l_' + Date.now();
                    newTx.timestamp = new Date().toISOString();
                    transactions.push(newTx);
                    window.transactions = transactions;
                    // ASYNC SAVE
                    await AppStorage.set(`my_expenses_${APP_YEAR}`, JSON.stringify(transactions));
                    window.processTransactions(transactions);

                    const isRecurring = document.getElementById('input-recurring').checked;
                    if (isRecurring) {
                        const day = parseInt(document.getElementById('input-recurring-day').value);
                        const rule = { id: 'rule_' + Date.now(), type: currentType, amount: amount, category: category, description: desc || 'Otomatik İşlem', day: day, lastExecutedMonth: new Date().toISOString().slice(0, 7) };
                        recurringRules.push(rule);
                        await AppStorage.set(`my_recurring_rules_${APP_YEAR}`, JSON.stringify(recurringRules));
                        window.alertMessage("Bilgi", `Otomatik talimat oluşturuldu.`, "blue");
                    }
                    window.showMotivation(amount, category, currentType);
                }

                // Temizlik
                document.getElementById('input-amount').value = '';
                document.getElementById('input-desc').value = '';
                document.getElementById('input-investment-qty').value = '';
                document.getElementById('input-recurring').checked = false;
                document.getElementById('recurring-options').classList.add('hidden');

                // ✅ FIX: Kayıttan sonra "Bakiyeden Düşme" reset
                const excludeCb2 = document.getElementById('input-exclude-balance');
                if (excludeCb2) excludeCb2.checked = false;

                // Panel de kapansın
                const savingsOpt = document.getElementById('savings-options');
                if (savingsOpt) savingsOpt.classList.add('hidden');
            };

            window.deleteItem = async function (id) { window.requestDelete('transaction', id); };

            window.saveGoal = async function () {
                const title = document.getElementById('goal-title').value;
                const target = document.getElementById('goal-target').value;
                const indexType = document.getElementById('goal-index-type').value;

                // Veri Temizleme: Binlik ayraçları (.) kaldır
                const targetVal = window.parseSimpleCurrency(target);

                // Validasyon
                if (!title) { window.alertMessage("Hedef Kayıt Hatası", "Lütfen hedef adını giriniz.", "red"); return; }
                if (isNaN(targetVal) || targetVal <= 0) { window.alertMessage("Hedef Kayıt Hatası", "Lütfen geçerli bir hedef tutar giriniz.", "red"); return; }

                let currentVal = 0;
                let currentMode = 'TRY';
                let indexAmount = 0;
                let lastComputedTL = 0;
                let lastIndexRate = 0;

                if (indexType === 'TRY') {
                    // TL Modu
                    const current = document.getElementById('goal-current').value;
                    currentVal = window.parseSimpleCurrency(current);
                    if (isNaN(currentVal) || currentVal < 0) { window.alertMessage("Hedef Kayıt Hatası", "Lütfen geçerli bir mevcut birikim giriniz.", "red"); return; }
                    currentMode = 'TRY';
                    lastComputedTL = currentVal;
                } else {
                    // Endeksli Mod (USD, EUR, GRAM, QUARTER)
                    const indexAmountInput = document.getElementById('goal-index-amount').value;
                    indexAmount = parseFloat(indexAmountInput.replace(/\./g, '').replace(',', '.')) || 0;
                    if (indexAmount <= 0) { window.alertMessage("Hedef Kayıt Hatası", "Lütfen geçerli bir endeksli miktar giriniz.", "red"); return; }

                    currentMode = 'INDEXED';
                    const rate = window.getIndexRate(indexType);
                    if (rate > 0) {
                        currentVal = indexAmount * rate;
                        lastComputedTL = currentVal;
                        lastIndexRate = rate;
                    } else {
                        currentVal = 0;
                        lastComputedTL = 0;
                    }
                }

                if (targetVal < currentVal) { window.alertMessage("Hedef Kayıt Hatası", "Hedef tutar, mevcut birikiminizden küçük olamaz.", "red"); return; }

                const newGoal = {
                    title,
                    target: targetVal,
                    current: currentVal,
                    currentMode: currentMode,
                    indexType: indexType,
                    indexAmount: indexAmount,
                    lastComputedTL: lastComputedTL,
                    lastDeltaTL: 0,
                    lastIndexRate: lastIndexRate,
                    createdAt: new Date().toISOString()
                };

                if (isLocalMode) {
                    newGoal.id = 'g_' + Date.now();
                    goals.push(newGoal);
                    localStorage.setItem(`my_goals_${APP_YEAR}`, JSON.stringify(goals));
                    window.renderGoalsList();
                    window.updateDashboardGoalWidget();
                } else {
                    if (!userId) return;
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/user_goals`), { ...newGoal, createdAt: serverTimestamp() });
                    } catch (e) {
                        console.error("Firebase Goal Save Error:", e);
                        window.alertMessage("Hata", "Hedef kaydedilemedi. Konsolu kontrol edin.", "red");
                    }
                }

                // Form temizliği
                document.getElementById('goal-title').value = '';
                document.getElementById('goal-target').value = '';
                document.getElementById('goal-current').value = '';
                document.getElementById('goal-index-amount').value = '';
                document.getElementById('goal-index-type').value = 'TRY';
                document.getElementById('goal-current').classList.remove('hidden');
                document.getElementById('goal-index-amount').classList.add('hidden');
                document.getElementById('goal-index-hint').classList.add('hidden');
                window.toggleGoalModal(false);

                window.alertMessage("Başarılı", "Hedef başarıyla oluşturuldu! 🎯", "green");
            };

            window.openAddFundsModal = function (id) {
                activeGoalId = id;
                const g = goals.find(x => x.id === activeGoalId);
                if (g) {
                    document.getElementById('add-funds-goal-title').innerText = `${g.title} hedefine eklenecek tutar:`;
                    document.getElementById('add-funds-amount').value = '';
                    // Hint'i sıfırla
                    const hint = document.getElementById('add-funds-indexed-hint');
                    if (hint) { hint.classList.add('hidden'); hint.textContent = ''; }
                    document.getElementById('add-funds-modal').classList.remove('hidden');
                }
            };

            window.submitAddFunds = async function () {
                if (!activeGoalId) return;
                const g = goals.find(x => x.id === activeGoalId);
                if (!g) return;

                const amtInput = document.getElementById('add-funds-amount');
                const amtTL = window.parseSimpleCurrency(amtInput.value);
                if (isNaN(amtTL) || amtTL <= 0) {
                    window.alertMessage("Hata", "Geçerli bir tutar giriniz.", "red");
                    return;
                }

                // Geriye uyumluluk defaultları (bazı eski hedeflerde yoksa)
                if (!g.currentMode) {
                    g.currentMode = 'TRY';
                    g.indexType = 'TRY';
                    g.indexAmount = 0;
                    g.lastComputedTL = g.current || 0;
                }

                const oldCurrent = g.current;
                const oldIndexAmount = g.indexAmount || 0;

                if (g.currentMode === 'INDEXED') {
                    const rate = window.getIndexRate(g.indexType);
                    if (rate <= 0) {
                        window.alertMessage("Hata", "Kur verisi hazır değil. Piyasa Durumu'nu yenileyin.", "red");
                        return;
                    }

                    const addedUnits = amtTL / rate;
                    g.indexAmount = (g.indexAmount || 0) + addedUnits;

                    const newTL = g.indexAmount * rate;
                    g.lastDeltaTL = newTL - (g.lastComputedTL || g.current || 0);
                    g.lastComputedTL = newTL;
                    g.lastIndexRate = rate;

                    // UI için current'ı da güncel tut (renderGoalsList çoğu yerde current okuyor olabilir)
                    g.current = newTL;
                } else {
                    g.current = (g.current || 0) + amtTL;
                    g.lastComputedTL = g.current; // TRY modunda tutarlı kalsın
                }

                document.getElementById('add-funds-modal').classList.add('hidden');

                if (isLocalMode) {
                    localStorage.setItem(`my_goals_${APP_YEAR}`, JSON.stringify(goals));
                    window.refreshGoalComputedValues();
                } else {
                    try {
                        if (!userId) return;
                        await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/user_goals`, activeGoalId), {
                            current: g.current,
                            indexAmount: g.indexAmount,
                            lastComputedTL: g.lastComputedTL,
                            lastDeltaTL: g.lastDeltaTL,
                            lastIndexRate: g.lastIndexRate
                        });
                        window.refreshGoalComputedValues();
                    } catch (e) {
                        console.error(e);
                        g.current = oldCurrent;
                        g.indexAmount = oldIndexAmount;
                        window.renderGoalsList();
                        window.alertMessage("Hata", "Güncelleme hatası. Lütfen tekrar deneyin.", "red");
                    }
                }

                activeGoalId = null;
            };

            window.requestDeleteGoal = function (id) { window.requestDelete('goal', id); };

            // ═══════════════════════════════════════════════════════════════════════
            // DAILY INSIGHT WIDGET LOGIC (ENHANCED V2)
            // ═══════════════════════════════════════════════════════════════════════

            window.setInsightUI = function (data) {
                const h = document.getElementById('insight-headline');
                const t = document.getElementById('insight-text');
                const badge = document.getElementById('insight-tag');
                const chip = document.getElementById('insight-chip');
                const detailBtn = document.getElementById('insight-detail');

                if (h) h.innerText = data.headline;
                if (t) t.innerHTML = data.text; // Main widget can still have safe HTML (bolding etc) if needed, but usually plain
                if (badge) badge.innerText = data.tag;
                if (chip) chip.innerText = data.chip;

                // Remove old metrics if any
                const oldMetrics = document.querySelector('.ins-metrics');
                if (oldMetrics) oldMetrics.remove();

                // Inject Mini Metrics if available
                if (data.metrics) {
                    const metricsHTML = `
                <div class="ins-metrics flex gap-3 mt-3 mb-1">
                    ${data.metrics.map(m => `
                        <div class="flex flex-col bg-white/10 dark:bg-black/20 rounded-lg px-2.5 py-1.5 border border-white/5 backdrop-blur-sm">
                            <span class="text-[9px] text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider">${m.label}</span>
                            <span class="text-xs font-black text-gray-800 dark:text-gray-100">${m.value}</span>
                        </div>
                    `).join('')}
                </div>`;
                    const textDiv = document.querySelector('.ins-text');
                    if (textDiv) {
                        // Instert before metadata
                        const meta = textDiv.querySelector('.ins-meta');
                        if (meta) meta.insertAdjacentHTML('beforebegin', metricsHTML);
                    }
                }

                // Update Detail Button Click
                if (detailBtn) {
                    detailBtn.onclick = () => {
                        // Convert detailBullets to plain text list
                        let listContent = "";
                        if (data.detailBullets && data.detailBullets.length > 0) {
                            data.detailBullets.forEach(bullet => {
                                // Strip HTML just in case
                                const cleanBullet = window.htmlToPlainText(bullet);
                                listContent += `• ${cleanBullet}\n\n`;
                            });
                        }

                        // Construct clean body text
                        const cleanHeadline = window.htmlToPlainText(data.headline);
                        const cleanText = window.htmlToPlainText(data.summary || data.text); // User longer summary if avail

                        const fullBody = `${cleanText}\n\n${listContent}\n\n💡 Fingo Önerisi: ${window.htmlToPlainText(data.action || "Bütçeni kontrol et.")}`;

                        if (window.openBottomSheet) {
                            window.openBottomSheet({
                                title: "Fingo İçgörü 🧠",
                                body: fullBody, // NOW PLAIN TEXT ONLY
                                icon: "✨",
                                confirmText: "Teşekkürler",
                                onConfirm: () => { }
                            });
                        } else {
                            alert(fullBody);
                        }
                    };
                }
            };

            window.renderDailyInsight = function () {
                // 1. Get Data
                const snap = window.getFinanceSnapshot('month');
                const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                // Filter current month expenses
                const monthlyExpenses = transactions.filter(t => {
                    const d = new Date(t.date);
                    return t.type === 'expense' && d.getMonth() === currentMonth && d.getFullYear() === currentYear && !t.excludeFromBalance;
                });

                // Calculate totals by category
                const catTotals = {};
                let maxCat = '';
                let maxVal = 0;
                monthlyExpenses.forEach(t => {
                    catTotals[t.category] = (catTotals[t.category] || 0) + Math.abs(t.amount);
                    if (catTotals[t.category] > maxVal) {
                        maxVal = catTotals[t.category];
                        maxCat = t.category;
                    }
                });

                const income = snap.income;
                const expense = snap.expense;
                const netFlow = income - expense;
                const savingsRate = income > 0 ? ((income - expense) / income) * 100 : 0;
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const daysLeft = daysInMonth - new Date().getDate();

                // 2. Generate Insight Content
                let insight = {
                    headline: "Finansal Durumun Stabil",
                    text: "Bu ay harcamaların kontrol altında görünüyor.",
                    tag: "Normal",
                    chip: "Aylık",
                    metrics: [],
                    detailBullets: [],
                    summary: "",
                    action: ""
                };

                // Logic Tree
                if (monthlyExpenses.length === 0) {
                    insight.headline = "Harcama Verisi Yok";
                    insight.text = "Henüz bu ay için harcama girmedin. Eklemeye başla!";
                    insight.tag = "Veri Bekleniyor";
                    insight.action = "Harcama ekle (+ butonuna bas)";
                }
                else if (expense > income && income > 0) {
                    insight.headline = "Bütçe Alarmı";
                    insight.text = `Gelirini **${window.renderMoneyText(Math.abs(netFlow))}** aştın.`;
                    insight.tag = "Dikkat";
                    insight.metricVal = "Negatif";
                    insight.detailBullets = [
                        "Giderlerin gelirini aştı.",
                        `En büyük kalem: ${maxCat} (${window.renderMoneyText(maxVal)})`,
                        "Acil olmayan harcamaları ertelemelisin."
                    ];
                    insight.summary = "Bu ay bütçen eksiye düştü. Harcamalarını gözden geçirmelisin.";
                    insight.action = "Fuzuli harcamaları kıs.";
                }
                else if (savingsRate > 20) {
                    insight.headline = "Süper Gidiyorsun! 🚀";
                    insight.text = `Gelirinin **%${savingsRate.toFixed(0)}**'ini korudun.`;
                    insight.tag = "Harika";
                    insight.detailBullets = [
                        `Tasarruf oranın %${savingsRate.toFixed(1)}`,
                        `Kalan bakiye: ${window.renderMoneyText(netFlow)}`,
                        "Bu hızla gidersen hedeflerine erken ulaşabilirsin."
                    ];
                    insight.summary = "Mükemmel bir finansal performans sergiliyorsun.";
                    insight.action = "Artan parayı yatırıma yönlendir.";
                }
                else if (maxVal > (income * 0.3) && income > 0) {
                    insight.headline = `${maxCat} Harcamana Dikkat`;
                    insight.text = `Gelirinin **%${((maxVal / income) * 100).toFixed(0)}**'i buraya gitti.`;
                    insight.tag = "Analiz";
                    insight.detailBullets = [
                        `${maxCat} kategorisi bütçeni zorluyor.`,
                        `Toplam: ${window.renderMoneyText(maxVal)}`,
                        "Alternatifler bularak bu kalemi düşürebilirsin."
                    ];
                    insight.summary = `${maxCat} harcamaların bu ay çok yüksek görünüyor.`;
                    insight.action = `${maxCat} için kendine limit koy.`;
                }
                else {
                    insight.headline = "Her Şey Yolunda 👍";
                    insight.text = `Ay sonuna ${daysLeft} gün kaldı, bütçen dengede.`;
                    insight.tag = "Dengeli";
                    insight.detailBullets = [
                        `Günlük ortalama harcaman: ${window.renderMoneyText(expense / (new Date().getDate() || 1))}`,
                        `Tahmini ay sonu gideri: ${window.renderMoneyText(expense + (expense / (new Date().getDate() || 1) * daysLeft))}`,
                        "Planına sadık kalmaya devam et."
                    ];
                    insight.summary = "Bütçen planlandığı gibi gidiyor, sürpriz yok.";
                    insight.action = "Böyle devam et!";
                }

                // 3. Add Metrics
                insight.metrics = [
                    { label: "Net Akış", value: window.renderMoneyText(netFlow) },
                    { label: "Tasarruf", value: `%${savingsRate.toFixed(0)}` },
                    { label: "Limit", value: maxCat || "-" }
                ];

                window.setInsightUI(insight);
            };

            // (Eski badgesDef bu alandan kaldırıldı ve script sonuna taşındı)

            // --- 3D KART DETAYINI AÇMA FONKSİYONU ---
            window.openBadgeDetail = function (badgeId) {
                const badge = badgesDef.find(b => b.id === badgeId);
                if (!badge) return;

                const modal = document.getElementById('nft-detail-modal');
                if (!modal) return;

                // Check if unlocked
                const myBadges = JSON.parse(localStorage.getItem(`my_badges_${APP_YEAR}`) || '[]');
                const isUnlocked = myBadges.includes(badgeId);

                const container = document.getElementById('3d-card-container');
                const badgeDate = isUnlocked ? new Date().toLocaleDateString('tr-TR') : '---';
                const statusText = isUnlocked ? 'Kazanıldı' : 'Henüz Kazanılmadı';
                const unlockHint = isUnlocked ? 'ÇEVİRMEK İÇİN TIKLA ↻' : 'NASIL KAZANILIR? ↻';

                // Modal içindeki kart yapısını oluştur
                container.innerHTML = `
            <div class="badge-card rarity-${badge.rarity} ${isUnlocked ? '' : 'grayscale opacity-90'}" id="modal-card-inner">
                <div class="badge-face badge-front">
                    <div class="text-6xl mb-4 badge-icon transition-transform hover:scale-110">${badge.icon}</div>
                    <h3 class="text-xl font-black text-white tracking-widest uppercase mb-1 drop-shadow-md text-center">${badge.title}</h3>
                    <span class="px-3 py-1 rounded-full bg-white/20 text-[10px] font-bold text-white uppercase tracking-wider backdrop-blur-sm border border-white/20">${badge.rarity}</span>
                    <div class="absolute bottom-4 text-[8px] text-white/50 font-mono animate-pulse">${unlockHint}</div>
                    ${isUnlocked ? '' : '<div class="absolute top-4 right-4 text-2xl">🔒</div>'}
                </div>
                <div class="badge-face badge-back">
                    <div class="text-4xl mb-4 opacity-50">${badge.icon}</div>
                    <h4 class="text-sm font-bold text-white mb-2">Başarım Detayı</h4>
                    <p class="text-xs text-gray-300 leading-relaxed font-medium px-2">${badge.desc}</p>
                    <div class="mt-auto pt-4 border-t border-white/10 w-full">
                        <p class="text-[9px] text-gray-400 uppercase tracking-wider">${statusText}</p>
                        <p class="text-xs font-bold text-white">${badgeDate}</p>
                    </div>
                </div>
            </div>
            `;

                // Tıklayınca dönme özelliği
                const cardInner = document.getElementById('modal-card-inner');
                container.onclick = function () {
                    cardInner.classList.toggle('flipped');
                };

                modal.classList.remove('hidden');
            };

            // --- BADGE ICON HELPER (High Quality) ---
            window.getBadgeIconHTML = function (badge, isHero = false) {
                const sizeClass = isHero ? 'badge-hero animate-float' : 'w-10 h-10'; // Gallery vs Hero size

                // Check if URL (simple check for extensions or protocol)
                const isUrl = /^(http|https|\.png|\.webp|\.svg)/i.test(badge.icon);

                if (isUrl) {
                    return `<img 
                    src="${badge.icon}" 
                    class="${isHero ? 'badge-hero' : 'w-8 h-8 object-contain'} pointer-events-none select-none" 
                    width="${isHero ? '256' : '64'}" 
                    height="${isHero ? '256' : '64'}" 
                    alt="${badge.title}" 
                    decoding="async" 
                    loading="eager" 
                    draggable="false">`;
                } else {
                    // Emoji or Text
                    return `<div class="${isHero ? 'text-7xl filter drop-shadow-[0_10px_20px_rgba(0,0,0,0.5)]' : 'text-2xl'} cursor-default select-none">${badge.icon}</div>`;
                }
            };

            // --- GÜNCELLENMİŞ 3D ROZET İNCELEME (PREMIUM EFFECT) ---
            // PATCH: HEDEF-3 - Badge date fix with meta storage
            window.openBadgeDetail = function (badgeId) {
                const badge = badgesDef.find(b => b.id === badgeId);
                if (!badge) return;

                const modal = document.getElementById('nft-detail-modal');
                const container = document.getElementById('3d-card-container');
                if (!modal || !container) return;

                const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
                const myBadges = JSON.parse(localStorage.getItem(`my_badges_${currentYear}`) || '[]');
                const isUnlocked = myBadges.includes(badgeId);

                // PATCH: Read badge earned date from meta storage (backward compatible)
                let badgeDate = '---';
                if (isUnlocked) {
                    try {
                        const badgesMeta = JSON.parse(localStorage.getItem(`my_badges_meta_${currentYear}`) || '{}');
                        if (badgesMeta[badgeId]) {
                            badgeDate = new Date(badgesMeta[badgeId]).toLocaleDateString('tr-TR');
                        } else {
                            // Eski kullanıcı için tarih yok - '---' göster
                            badgeDate = '---';
                        }
                    } catch (e) {
                        badgeDate = '---';
                    }
                }
                const statusText = isUnlocked ? 'KAZANILDI' : 'KİLİTLİ';
                const statusColor = isUnlocked ? 'text-emerald-400' : 'text-rose-400';
                const iconHTML = window.getBadgeIconHTML(badge, true); // Hero Quality


                // Build HTML
                container.innerHTML = `
                <div id="modal-card-inner" class="relative w-full h-full duration-500 ease-out preserve-3d cursor-pointer">
                    
                    <!-- PREMIUM LAYERS (Global foil/noise/glare acting on the whole card) -->
                    <div class="holo-foil" id="holo-foil"></div>
                    <div class="noise-texture"></div>
                    <div class="holo-glare" id="holo-glare"></div>

                    <!-- FRONT FACE -->
                    <div class="card-front absolute inset-0 w-full h-full backface-hidden rounded-[24px] p-6 flex flex-col items-center justify-center 
                        ${isUnlocked ? 'bg-gradient-to-br from-[#1c1c1e] to-[#2c2c2e]' : 'bg-gray-900'} 
                        border border-white/10 shadow-2xl overflow-hidden" 
                        style="transform: rotateY(0deg); z-index: 2;">
                        
                        <!-- BG Pattern -->
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-[0.03] mix-blend-overlay pointer-events-none"></div>
                        
                        <!-- Lock Icon if locked -->
                        ${!isUnlocked ? '<div class="absolute top-4 right-4 text-2xl opacity-60">🔒</div>' : ''}

                        <!-- Badge Icon -->
                        <div class="mb-6 z-10 transform-gpu">${iconHTML}</div>
                        
                        <!-- Text Info -->
                        <h3 class="text-2xl font-black text-white tracking-widest uppercase mb-1 text-center font-display z-10" 
                            style="text-shadow: 0 2px 10px rgba(0,0,0,0.5);">${badge.title}</h3>
                        
                        <span class="px-3 py-1 rounded-full bg-white/10 text-[10px] font-bold text-white uppercase tracking-widest border border-white/20 backdrop-blur-sm z-10 mt-2">
                            ${badge.rarity}
                        </span>

                        <div class="absolute bottom-6 text-[10px] text-white/40 font-mono flex items-center gap-1 z-10">
                            <span>dokun ve çevir</span> ↻
                        </div>
                    </div>

                    <!-- BACK FACE -->
                    <div class="card-back absolute inset-0 w-full h-full backface-hidden rounded-[24px] p-8 flex flex-col items-center justify-center 
                        bg-[#101010] border border-white/10 shadow-inner" 
                        style="transform: rotateY(180deg); z-index: 1;">
                        
                        <div class="opacity-20 scale-75 mb-4 grayscale pointer-events-none">${iconHTML}</div>

                        <h4 class="text-sm font-bold text-white mb-3 border-b border-white/10 pb-2 w-full text-center">Detaylar</h4>
                        <p class="text-xs text-gray-400 font-medium text-center leading-relaxed mb-auto">${badge.desc}</p>
                        
                        <div class="mt-4 pt-4 border-t border-white/5 w-full text-center">
                            <p class="text-[9px] text-gray-500 uppercase tracking-widest mb-1">Durum</p>
                            <p class="text-xs font-bold ${statusColor}">${statusText}</p>
                            <p class="text-[10px] text-gray-500 mt-1">${badgeDate}</p>
                        </div>
                    </div>
                </div>
            `;

                modal.classList.remove('hidden');

                // --- TILT & GLIP LOGIC (Premium) ---
                const cardInner = document.getElementById('modal-card-inner');
                const foil = document.getElementById('holo-foil');
                const glare = document.getElementById('holo-glare');

                // Flip on click -> applied to INNER
                container.onclick = (e) => {
                    e.stopPropagation();
                    cardInner.classList.toggle('rotate-y-180');
                };

                // Tilt Variables
                const limits = 15; // Max tilt degrees
                let frameId;

                function handleMove(e) {
                    if (!container) return;
                    const rect = container.getBoundingClientRect();

                    // Coordinates relative to card center (0-1)
                    let clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    let clientY = e.touches ? e.touches[0].clientY : e.clientY;

                    // Safety check for mobile scroll
                    // if (e.touches && content is scrolled?) -> usually safe if we use touch-action: none on modal overlay

                    const x = clientX - rect.left;
                    const y = clientY - rect.top;

                    // Percentages for CSS vars
                    const mx = ((x / rect.width) * 100).toFixed(2);
                    const my = ((y / rect.height) * 100).toFixed(2);

                    // Set CSS variables for Glare/Foil (Performant)
                    container.style.setProperty('--mx', `${mx}%`);
                    container.style.setProperty('--my', `${my}%`);

                    // Calculate Rotation
                    // X axis rotation depends on Y position
                    // Y axis rotation depends on X position
                    const rotateX = ((y / rect.height - 0.5) * -limits * 2).toFixed(2);
                    const rotateY = ((x / rect.width - 0.5) * limits * 2).toFixed(2);

                    // Apply Tilt to CONTAINER (Wrapper), NOT inner (Inner handles Flip)
                    // This prevents conflict with rotate-y-180
                    requestAnimationFrame(() => {
                        container.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;

                        // Update opacity based on intensity
                        const intensity = Math.min(1, (Math.abs(rotateX) + Math.abs(rotateY)) / 20 + 0.1);
                        if (foil) foil.style.opacity = intensity;
                        if (glare) glare.style.opacity = intensity;
                    });
                }

                function resetTilt() {
                    requestAnimationFrame(() => {
                        container.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`;
                        if (foil) foil.style.opacity = 0;
                        if (glare) glare.style.opacity = 0;
                    });
                }

                // Event Listeners
                const wrap = document.querySelector('#nft-detail-modal');
                // Listen on wrapper or window to catch moves even if outside small container? 
                // Better listening on card for standard tilt interactive feel

                // Desktop
                container.addEventListener('mousemove', handleMove);
                container.addEventListener('mouseleave', resetTilt);

                // Mobile (Gyroscope would be better but requires permission. Fallback to touch drag if needed or just static)
                // For now, simple touch tilt
                container.addEventListener('touchmove', handleMove, { passive: true });
                container.addEventListener('touchend', resetTilt);

                // Cleanup when closing
                const closeBtn = modal.querySelector('button'); // find the X button
                const oldClose = closeBtn.onclick;

                window.closeDetailModalClean = function () {
                    container.removeEventListener('mousemove', handleMove);
                    container.removeEventListener('mouseleave', resetTilt);
                    container.removeEventListener('touchmove', handleMove);
                    container.removeEventListener('touchend', resetTilt);
                    if (frameId) cancelAnimationFrame(frameId);
                    modal.classList.add('hidden');
                };

                // Override toggle functionality for this specific modal instance
                closeBtn.onclick = window.closeDetailModalClean;
            };
            // PATCH: HEDEF-3 - Badge date fix with meta storage
            window.checkBadges = function () {
                const myBadges = JSON.parse(localStorage.getItem(`my_badges_${APP_YEAR}`) || '[]');
                const badgesMeta = JSON.parse(localStorage.getItem(`my_badges_meta_${APP_YEAR}`) || '{}');
                let newBadge = false;

                badgesDef.forEach(badge => {
                    // Eğer rozet zaten kazanılmamışsa ve şart sağlanıyorsa
                    if (!myBadges.includes(badge.id)) {
                        try {
                            if (badge.condition()) {
                                myBadges.push(badge.id);
                                // PATCH: Store badge earned timestamp
                                badgesMeta[badge.id] = new Date().toISOString();
                                newBadge = true;
                                window.showBadgeCelebration(badge); // Kutlama modalını aç
                            }
                        } catch (e) {
                            console.error("Rozet kontrol hatası:", e);
                        }
                    }
                });

                if (newBadge) {
                    localStorage.setItem(`my_badges_${APP_YEAR}`, JSON.stringify(myBadges));
                    // PATCH: Save badge meta with timestamps
                    localStorage.setItem(`my_badges_meta_${APP_YEAR}`, JSON.stringify(badgesMeta));
                    window.renderBadges(); // Profildeki rozetleri güncelle
                    window.renderNFTGallery(); // Galeriyi güncelle
                }
            };

            /* --- DÜZELTİLMİŞ KUTLAMA MODALI (RESİM DESTEKLİ) --- */
            window.showBadgeCelebration = function (badge) {
                // Varsa eski modalı temizle
                let existingModal = document.getElementById('badge-celebration-modal');
                if (existingModal) existingModal.remove();

                // İkon kontrolü: Resim URL'si mi yoksa Emoji mi?
                let iconContent = '';
                if (badge.icon.startsWith('http')) {
                    // Resim ise <img> etiketi oluştur
                    iconContent = `<img src="${badge.icon}" class="w-32 h-32 object-contain mx-auto drop-shadow-[0_0_25px_rgba(255,215,0,0.6)] animate-bounce" alt="Rozet">`;
                } else {
                    // Emoji ise düz yazı olarak bas
                    iconContent = `<div class="text-8xl">${badge.icon}</div>`;
                }

                const modalHTML = `
                <div id="badge-celebration-modal" class="celebration-modal" onclick="window.closeBadgeCelebrationModal()">
                    <div class="celebration-content" onclick="event.stopPropagation()">
                        
                        <div class="medal-shimmer mb-6 flex justify-center items-center h-32">
                            ${iconContent}
                        </div>

                        <h2 class="neon-title text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-2 drop-shadow-sm">
                            ROZET KAZANILDI!
                        </h2>
                        
                        <p class="neon-subtitle text-xl font-bold text-white mb-2 tracking-wide">
                            ${badge.title}
                        </p>
                        
                        <div class="text-xs text-gray-300 mt-2 italic px-4 font-medium opacity-80">
                            "${badge.desc}"
                        </div>
                        
                        <button onclick="window.closeBadgeCelebrationModal()" 
                            class="mt-8 w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl text-white font-black text-lg shadow-xl shadow-indigo-500/40 hover:scale-105 transition-transform active:scale-95">
                            HARİKA! 🚀
                        </button>
                    </div>
                </div>
            `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Animasyon ve Ses Efektleri (requestAnimationFrame ile daha stabil)
                requestAnimationFrame(() => {
                    const el = document.getElementById('badge-celebration-modal');
                    if (el) {
                        el.classList.add('visible');
                    }

                    // Başarı Sesi (Opsiyonel)
                    try {
                        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3');
                        audio.volume = 0.5;
                        audio.play().catch(() => { });
                    } catch (e) { }

                    // Konfeti Patlatma
                    if (typeof confetti === 'function') {
                        confetti({
                            particleCount: 150,
                            spread: 100,
                            origin: { y: 0.6 },
                            colors: ['#FFD700', '#FFA500', '#ffffff', '#6366F1']
                        });
                    }
                }, 100);
            };

            window.closeBadgeCelebrationModal = function () {
                const el = document.getElementById('badge-celebration-modal');
                if (!el) return;

                // Inline style varsa temizle (eski bug'ın kökü)
                el.style.opacity = '';
                el.style.display = '';

                // Kapanış: closing class ile opacity düşür
                el.classList.remove('visible');
                el.classList.add('closing');

                // Transition süresi CSS'te 0.4s olduğu için güvenli buffer
                setTimeout(() => {
                    if (el && el.parentNode) el.remove();

                    // iOS repaint tetikle (nadiren takılı kalan layer'ı bitirir)
                    document.documentElement.style.webkitTransform = 'translateZ(0)';
                    setTimeout(() => { document.documentElement.style.webkitTransform = ''; }, 0);
                }, 450);
            };

            /* ═══════════════════════════════════════════════════════════════
               SCRATCH CARD REWARD POPUP - Premium Kazı-Kazan Sistemi
            ═══════════════════════════════════════════════════════════════ */

            // Global state
            window._rewardPopupState = {
                isOpen: false,
                rewardData: null,
                scratchComplete: false,
                scratchPercentage: 0
            };

            /**
             * Opens the reward popup with scratch-to-reveal experience
             * @param {Object} rewardData - The reward data object
             * @param {string} rewardData.id - Unique reward ID
             * @param {string} rewardData.title - Reward title (e.g., "Efsane Rozet")
             * @param {string} rewardData.rarity - common | rare | epic | legendary
             * @param {string} rewardData.icon - Emoji or image URL
             * @param {string} rewardData.description - Reward description
             * @param {string} rewardData.valueTier - low | high (determines LED animation)
             */
            window.openRewardPopup = function (rewardData) {
                if (window._rewardPopupState.isOpen) return;

                // Clean up any existing modal
                const existing = document.getElementById('reward-popup-modal');
                if (existing) existing.remove();

                // Reset state
                window._rewardPopupState = {
                    isOpen: true,
                    rewardData: rewardData,
                    scratchComplete: false,
                    scratchPercentage: 0
                };

                // Icon content
                const isImageIcon = rewardData.icon && rewardData.icon.startsWith('http');
                const iconContent = isImageIcon
                    ? `<img src="${rewardData.icon}" alt="Reward Icon" style="width: 64px; height: 64px; border-radius: 12px; object-fit: cover;">`
                    : rewardData.icon || '🎁';

                // Premium simplified HTML structure
                const modalHTML = `
                <div id="reward-popup-modal" class="reward-modal" role="dialog" aria-modal="true">
                    <div class="reward-container">
                        <!-- Header -->
                        <div class="reward-header">
                            <div class="reward-title-group">
                                <div class="reward-title">Ödül Kazandın</div>
                                <div class="reward-subtitle">Kazı ve sürprizi keşfet.</div>
                            </div>
                            <button class="reward-close-btn" onclick="window.closeRewardPopup()" aria-label="Kapat">✕</button>
                        </div>

                        <!-- Card Area (3D Stage) -->
                        <div class="reward-card-wrapper">
                            <div class="reward-card" id="reward-card">
                                <!-- Reveal Content (Underneath) -->
                                <div class="reward-reveal" id="reward-reveal">
                                    <div class="reward-icon">${iconContent}</div>
                                    <div class="reward-name">${rewardData.title}</div>
                                    <div class="reward-desc">${rewardData.description || 'Tebrikler!'}</div>
                                    <div class="reward-rarity ${rewardData.rarity || 'common'}">
                                        ${(rewardData.rarity || 'COMMON').toUpperCase()}
                                    </div>
                                </div>

                                <!-- Scratch Particles Container -->
                                <div class="scratch-particles-container" id="scratch-particles-container"></div>

                                <!-- Scratch Layer (Canvas) -->
                                <div class="reward-scratch-layer" id="reward-scratch-layer">
                                    <canvas class="reward-scratch-canvas" id="reward-scratch-canvas"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Minimal Progress (Bottom) -->
                        <div class="reward-progress" id="reward-progress">
                            <div class="reward-progress-text" id="reward-progress-text">Kazımaya başla</div>
                            <div class="reward-progress-bar">
                                <div class="reward-progress-fill" id="reward-progress-fill"></div>
                            </div>
                        </div>

                        <!-- CTA Button -->
                        <button class="reward-cta" id="reward-cta" onclick="window.closeRewardPopup()">
                            Süper! 🚀
                        </button>
                    </div>
                </div>
            `;

                // Insert to DOM
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.body.classList.add('modal-open');

                // Animate Entrance
                requestAnimationFrame(() => {
                    const modal = document.getElementById('reward-popup-modal');
                    if (modal) {
                        // Force reflow
                        void modal.offsetWidth;
                        modal.classList.add('visible');
                    }

                    // Init canvas with slight delay for visuals to settle
                    setTimeout(() => {
                        window._initRewardScratchCanvas();
                    }, 350);
                });
            };

            /**
             * Initializes the scratch canvas
             */
            /**
             * Initializes the scratch canvas with Premium Metallic Texture
             */
            window._initRewardScratchCanvas = function (retryCount = 0) {
                const canvas = document.getElementById('reward-scratch-canvas');
                const scratchLayer = document.getElementById('reward-scratch-layer');
                if (!canvas || !scratchLayer) return;

                const rect = scratchLayer.getBoundingClientRect();

                // Mobile hydration fix
                if ((rect.width === 0 || rect.height === 0) && retryCount < 10) {
                    setTimeout(() => window._initRewardScratchCanvas(retryCount + 1), 100);
                    return;
                }

                const containerWidth = rect.width || scratchLayer.offsetWidth || 280;
                const containerHeight = rect.height || scratchLayer.offsetHeight || 350;
                const dpr = window.devicePixelRatio || 1;

                // Retina support
                canvas.width = containerWidth * dpr;
                canvas.height = containerHeight * dpr;
                canvas.style.width = containerWidth + 'px';
                canvas.style.height = containerHeight + 'px';

                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr);

                // --- Premium Metallic Gradient ---
                const gradient = ctx.createLinearGradient(0, 0, containerWidth, containerHeight);
                // Silver/Platinum base
                gradient.addColorStop(0, '#9ca3af');
                gradient.addColorStop(0.2, '#e5e7eb');
                gradient.addColorStop(0.4, '#d1d5db');
                gradient.addColorStop(0.5, '#f3f4f6'); // Highlight
                gradient.addColorStop(0.6, '#d1d5db');
                gradient.addColorStop(0.8, '#e5e7eb');
                gradient.addColorStop(1, '#9ca3af');

                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, containerWidth, containerHeight);

                // --- Noise Texture (Grain) ---
                ctx.globalAlpha = 0.08;
                for (let i = 0; i < containerWidth; i += 2) {
                    for (let j = 0; j < containerHeight; j += 2) {
                        if (Math.random() > 0.5) {
                            ctx.fillStyle = Math.random() > 0.5 ? '#000' : '#fff';
                            ctx.fillRect(i, j, 1, 1);
                        }
                    }
                }
                ctx.globalAlpha = 1;

                // Scratch Settings
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = 50; // Proper finger width

                // Interaction Logic
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;
                let lastCheck = 0;
                let lastHaptic = 0;

                const getPos = (e) => {
                    const r = canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { x: clientX - r.left, y: clientY - r.top };
                };

                const startDraw = (e) => {
                    if (window._rewardPopupState.scratchComplete) return;
                    e.preventDefault();
                    isDrawing = true;
                    const pos = getPos(e);
                    lastX = pos.x;
                    lastY = pos.y;
                };

                const draw = (e) => {
                    if (!isDrawing || window._rewardPopupState.scratchComplete) return;
                    e.preventDefault();

                    const pos = getPos(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();

                    lastX = pos.x;
                    lastY = pos.y;

                    // Light Haptic Feedback
                    const now = Date.now();
                    if (now - lastHaptic > 60 && navigator.vibrate) {
                        navigator.vibrate(5);
                        lastHaptic = now;
                    }

                    // Throttled Progress Check
                    if (now - lastCheck > 200) {
                        lastCheck = now;
                        window._checkScratchProgress(ctx, containerWidth, containerHeight, dpr);
                    }
                };

                const endDraw = () => {
                    isDrawing = false;
                    window._checkScratchProgress(ctx, containerWidth, containerHeight, dpr);
                };

                // Listeners
                canvas.addEventListener('mousedown', startDraw);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', endDraw);
                canvas.addEventListener('mouseleave', endDraw);
                canvas.addEventListener('touchstart', startDraw, { passive: false });
                canvas.addEventListener('touchmove', draw, { passive: false });
                canvas.addEventListener('touchend', endDraw);
            };

            /**
             * Check scratch progress and trigger reveal if threshold met
             */
            window._checkScratchProgress = function (ctx, width, height, dpr) {
                if (window._rewardPopupState.scratchComplete) return;

                // Sample pixels to calculate scratched percentage
                const sampleSize = 20;
                const stepX = width / sampleSize;
                const stepY = height / sampleSize;
                let transparent = 0;
                let total = 0;

                for (let x = 0; x < sampleSize; x++) {
                    for (let y = 0; y < sampleSize; y++) {
                        const pixel = ctx.getImageData(
                            Math.floor(x * stepX * dpr),
                            Math.floor(y * stepY * dpr),
                            1, 1
                        ).data;
                        total++;
                        if (pixel[3] < 128) transparent++;
                    }
                }

                const percentage = Math.round((transparent / total) * 100);
                window._rewardPopupState.scratchPercentage = percentage;

                // Update progress bar and percentage
                const progressFill = document.getElementById('reward-progress-fill');
                const progressText = document.getElementById('reward-progress-text');
                const progressPercent = document.getElementById('reward-progress-percent');

                if (progressFill) {
                    progressFill.style.width = Math.min(percentage, 100) + '%';
                }

                if (progressPercent) {
                    progressPercent.textContent = percentage + '%';
                }

                if (progressText) {
                    if (percentage < 25) {
                        progressText.textContent = 'Kazımaya devam et...';
                    } else if (percentage < 50) {
                        progressText.textContent = 'Güzel gidiyorsun! 💪';
                    } else if (percentage < 65) {
                        progressText.textContent = 'Neredeyse bitti! ✨';
                    } else {
                        progressText.textContent = 'Açılıyor... 🎉';
                    }
                }

                // Trigger reveal at 65% threshold
                if (percentage >= 65) {
                    window._triggerRewardReveal();
                }
            };

            /**
             * Triggers the reward reveal sequence with premium effects
             */
            window._triggerRewardReveal = function () {
                if (window._rewardPopupState.scratchComplete) return;
                window._rewardPopupState.scratchComplete = true;

                const rewardData = window._rewardPopupState.rewardData;
                const isHighValue = rewardData.valueTier === 'high' ||
                    rewardData.rarity === 'epic' ||
                    rewardData.rarity === 'legendary';

                // Clear particles container
                const particlesContainer = document.getElementById('scratch-particles-container');
                if (particlesContainer) particlesContainer.innerHTML = '';

                // Trigger glow burst effect
                const glowBurst = document.getElementById('reward-glow-burst');
                if (glowBurst) {
                    glowBurst.classList.add('active');
                    setTimeout(() => glowBurst.remove(), 600);
                }

                // Trigger shockwave effect
                const shockwave = document.getElementById('reward-shockwave');
                if (shockwave) {
                    shockwave.classList.add('active');
                    setTimeout(() => shockwave.remove(), 800);
                }

                // Hide scratch layer with fade
                const scratchLayer = document.getElementById('reward-scratch-layer');
                const mystery = document.getElementById('reward-mystery');
                if (scratchLayer) {
                    scratchLayer.style.transition = 'opacity 0.4s ease';
                    scratchLayer.style.opacity = '0';
                    setTimeout(() => scratchLayer.remove(), 400);
                }
                if (mystery) {
                    mystery.style.transition = 'opacity 0.3s ease';
                    mystery.style.opacity = '0';
                    setTimeout(() => mystery.remove(), 300);
                }

                // Hide progress
                const progress = document.getElementById('reward-progress');
                const cta = document.getElementById('reward-cta');
                if (progress) {
                    progress.style.transition = 'opacity 0.3s ease';
                    progress.style.opacity = '0';
                }

                // Reveal content with bounce animation
                setTimeout(() => {
                    const reveal = document.getElementById('reward-reveal');
                    if (reveal) reveal.classList.add('revealed');

                    // LED border animation for high-value rewards
                    if (isHighValue) {
                        setTimeout(() => window._startLedBorderAnimation(), 200);
                    } else {
                        // Show CTA after slight delay for low-value
                        setTimeout(() => {
                            if (cta) cta.classList.add('visible');
                            window._triggerRewardConfetti();
                        }, 400);
                    }
                }, 150);

                // Strong haptic burst for reveal
                if (navigator.vibrate) {
                    navigator.vibrate([50, 30, 100]);
                }
            };

            /**
             * Starts the LED border trace animation
             */
            window._startLedBorderAnimation = function () {
                const ledBorder = document.getElementById('reward-led-border');
                const cta = document.getElementById('reward-cta');

                if (!ledBorder) {
                    // No LED border, just show CTA
                    if (cta) cta.classList.add('visible');
                    window._triggerRewardConfetti();
                    return;
                }

                // Check for reduced motion
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                const isPerfMode = document.documentElement.classList.contains('perf');

                if (prefersReducedMotion || isPerfMode) {
                    // Skip animation, show static glow
                    ledBorder.classList.add('active', 'complete');
                    if (cta) cta.classList.add('visible');
                    window._triggerRewardConfetti();
                    return;
                }

                // Start LED trace animation
                ledBorder.classList.add('active');

                // After animation completes (1.5s), add complete glow and show CTA
                setTimeout(() => {
                    ledBorder.classList.add('complete');

                    // Confetti
                    window._triggerRewardConfetti();

                    // Haptic
                    if (navigator.vibrate) {
                        navigator.vibrate([50, 50, 50]);
                    }

                    // Show CTA
                    setTimeout(() => {
                        if (cta) cta.classList.add('visible');
                    }, 300);
                }, 1500);
            };

            /**
             * Triggers confetti celebration
             */
            window._triggerRewardConfetti = function () {
                if (typeof confetti !== 'function') return;

                const isPerfMode = document.documentElement.classList.contains('perf');
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

                // Reduced confetti for performance mode
                const particleCount = (isPerfMode || prefersReducedMotion) ? 50 : 120;

                confetti({
                    particleCount: particleCount,
                    spread: 80,
                    origin: { y: 0.6, x: 0.5 },
                    colors: ['#6366f1', '#a855f7', '#ec4899', '#f59e0b', '#ffffff'],
                    disableForReducedMotion: true
                });
            };

            /**
             * Closes the reward popup
             */
            window.closeRewardPopup = function () {
                const modal = document.getElementById('reward-popup-modal');
                if (!modal) return;

                modal.classList.remove('visible');
                modal.classList.add('closing');

                // Unlock body scroll
                document.body.classList.remove('modal-open');

                setTimeout(() => {
                    if (modal && modal.parentNode) modal.remove();
                    window._rewardPopupState.isOpen = false;
                }, 400);
            };

            /* ═══════════════════════════════════════════════════════════════
               BADGE CELEBRATION REDIRECT
               Legacy function now calls new reward popup
            ═══════════════════════════════════════════════════════════════ */

            // Store original function for rollback
            window._legacyShowBadgeCelebration = window.showBadgeCelebration;

            // Override with new scratch card experience
            window.showBadgeCelebration = function (badge) {
                // Convert badge data to reward format
                const rewardData = {
                    id: badge.id,
                    title: badge.title,
                    rarity: badge.rarity || 'common',
                    icon: badge.icon,
                    description: badge.desc || badge.description || '',
                    valueTier: (badge.rarity === 'epic' || badge.rarity === 'legendary') ? 'high' : 'low'
                };

                // Open new reward popup
                window.openRewardPopup(rewardData);
            };

            window.renderBadges = function () {
                const grid = document.getElementById('badge-grid'); if (!grid) return;
                const unlockedBadges = JSON.parse(localStorage.getItem(`my_badges_${APP_YEAR}`) || '[]'); grid.innerHTML = '';
                badgesDef.forEach(b => {
                    const isUnlocked = unlockedBadges.includes(b.id);
                    const opacityClass = isUnlocked ? 'opacity-100 scale-100 bg-white dark:bg-gray-700 shadow-sm' : 'opacity-40 grayscale scale-90 bg-transparent';
                    const borderClass = isUnlocked ? 'border-yellow-400' : 'border-transparent';
                    grid.insertAdjacentHTML('beforeend', `<div class="flex flex-col items-center justify-center p-2 rounded-xl border ${borderClass} ${opacityClass} transition-all duration-500 group relative" title="${b.desc}"><div class="text-2xl mb-1 filter drop-shadow-sm">${b.icon}</div><span class="text-[8px] font-bold text-center leading-tight dark:text-white">${b.title}</span><div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-black text-white text-[9px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-20">${isUnlocked ? 'Kazanıldı!' : b.desc}</div></div>`);
                });
            };

            window.downloadBackup = function () {
                const keys = ['my_expenses_${APP_YEAR}', 'my_goals_${APP_YEAR}', 'my_tasks_${APP_YEAR}', 'my_installments_${APP_YEAR}', 'my_recurring_rules_${APP_YEAR}', 'my_budgets_${APP_YEAR}', 'my_categories_${APP_YEAR}', 'user_name', 'user_avatar', 'user_status', 'app_theme', 'my_badges_${APP_YEAR}'];
                const data = {}; let hasData = false;
                keys.forEach(k => { const val = localStorage.getItem(k); if (val) { data[k] = val; hasData = true; } });
                if (!hasData) { window.alertMessage("Uyarı", "Yedeklenecek veri yok.", "red"); return; }
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); const dateStr = new Date().toISOString().slice(0, 10); a.href = url; a.download = `fingenda_yedek_${dateStr}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                window.alertMessage("Başarılı", "Yedek dosyası indirildi. Bu dosyayı güvenli bir yerde saklayın! 💾", "blue");
            };

            window.restoreBackup = function (input) {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data || typeof data !== 'object') throw new Error("Geçersiz dosya formatı");
                        Object.keys(data).forEach(k => { localStorage.setItem(k, data[k]); });
                        window.alertMessage("Tamamlandı", "Yedek başarıyla yüklendi! Uygulama yeniden başlatılıyor... 🔄", "green");
                        setTimeout(() => window.location.reload(), 1500);
                    } catch (err) { console.error(err); window.alertMessage("Hata", "Yedek dosyası bozuk veya geçersiz.", "red"); }
                    input.value = '';
                };
                reader.readAsText(file);
            };

            window.requestResetApp = function () {
                activeDeleteType = 'reset_all';
                const msgEl = document.getElementById('confirm-modal-message'); if (msgEl) msgEl.textContent = "DİKKAT: Tüm veriler (işlemler, hedefler, notlar) kalıcı olarak silinecek ve uygulama sıfırlanacaktır. Emin misin?";
                const modal = document.getElementById('confirm-modal'); const btn = document.getElementById('confirm-modal-btn');
                if (btn) btn.className = "flex-1 py-3 rounded-xl bg-red-600 text-white font-bold";
                if (modal) modal.classList.remove('hidden'); window.toggleProfileModal(false);
            };

            window.requestDelete = function (type, id) {
                activeDeleteId = id; activeDeleteType = type; let message = "Bu işlem geri alınamaz.";
                if (type === 'installment') message = "Bu taksit planını silmek istediğine emin misin?"; else if (type === 'note') message = "Bu notu silmek istediğine emin misin?"; else if (type === 'goal') message = "Bu hedefi silmek istediğine emin misin?"; else if (type === 'transaction') message = "Bu işlemi silmek istediğine emin misin?";
                const msgEl = document.getElementById('confirm-modal-message'); if (msgEl) msgEl.textContent = message;
                const modal = document.getElementById('confirm-modal'); if (modal) modal.classList.remove('hidden');
                const btn = document.getElementById('confirm-modal-btn'); if (btn) btn.textContent = 'Evet, Sil';
            };

            // Confirm modal kapatma helper
            window.closeConfirmModal = function (triggerCancel = true) {
                const modal = document.getElementById('confirm-modal');
                if (modal) modal.classList.add('hidden');

                // Cancel callback varsa çalıştır
                if (triggerCancel && typeof window._confirmModalOnCancel === 'function') {
                    window._confirmModalOnCancel();
                }
                // Promise reject
                if (triggerCancel && typeof window._confirmModalReject === 'function') {
                    window._confirmModalReject(false);
                }

                // State temizle
                window.pendingConfirmAction = null;
                window._confirmModalOnCancel = null;
                window._confirmModalResolve = null;
                window._confirmModalReject = null;
                activeDeleteId = null;
                activeDeleteType = null;
            };

            // Genel amaçlı confirm modal açma (callback + variant destekli)
            window.openConfirmModal = function ({ title, message, confirmText = "Sil", cancelText = "Vazgeç", variant = "red", onConfirm, onCancel }) {
                const modal = document.getElementById('confirm-modal');
                if (!modal) return;

                const titleEl = document.getElementById('confirm-modal-title');
                const msgEl = document.getElementById('confirm-modal-message');
                const btnEl = document.getElementById('confirm-modal-btn');
                const cancelBtn = document.getElementById('confirm-modal-cancel-btn');
                const iconEl = document.getElementById('confirm-modal-icon');

                if (titleEl) titleEl.textContent = title || "Onay";
                if (msgEl) msgEl.textContent = message || "Bu işlem geri alınamaz.";
                if (btnEl) btnEl.textContent = confirmText;
                if (cancelBtn) cancelBtn.textContent = cancelText;

                // Variant'a göre ikon ve buton stili
                if (iconEl) {
                    iconEl.className = "w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl";
                    if (variant === "red" || variant === "danger") {
                        iconEl.classList.add("bg-red-100", "text-red-500");
                        iconEl.innerHTML = "⚠️";
                        if (btnEl) btnEl.className = "flex-1 py-3 rounded-xl bg-red-600 text-white font-bold";
                    } else if (variant === "warning") {
                        iconEl.classList.add("bg-yellow-100", "text-yellow-600");
                        iconEl.innerHTML = "⚠️";
                        if (btnEl) btnEl.className = "flex-1 py-3 rounded-xl bg-yellow-500 text-white font-bold";
                    } else {
                        iconEl.classList.add("bg-blue-100", "text-blue-500");
                        iconEl.innerHTML = "❓";
                        if (btnEl) btnEl.className = "flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold";
                    }
                }

                window.pendingConfirmAction = typeof onConfirm === "function" ? onConfirm : null;
                window._confirmModalOnCancel = typeof onCancel === "function" ? onCancel : null;
                modal.classList.remove('hidden');
            };

            // Promise tabanlı confirm dialog (native confirm() yerine)
            window.confirmDialog = function ({ title, message, confirmText = "Onayla", cancelText = "Vazgeç", variant = "blue" }) {
                return new Promise((resolve, reject) => {
                    window._confirmModalResolve = resolve;
                    window._confirmModalReject = reject;
                    window.openConfirmModal({
                        title,
                        message,
                        confirmText,
                        cancelText,
                        variant,
                        onConfirm: () => {
                            resolve(true);
                            window._confirmModalResolve = null;
                            window._confirmModalReject = null;
                        },
                        onCancel: () => {
                            resolve(false);
                            window._confirmModalResolve = null;
                            window._confirmModalReject = null;
                        }
                    });
                });
            };

            window.executeDelete = async function () {
                // 0) Önce custom confirm action var mı?
                if (typeof window.pendingConfirmAction === 'function') {
                    const modal = document.getElementById('confirm-modal');
                    if (modal) modal.classList.add('hidden');

                    const action = window.pendingConfirmAction;
                    window.pendingConfirmAction = null;

                    try {
                        await action();
                    } catch (e) {
                        console.error("Custom delete action failed:", e);
                        window.alertMessage("Hata", "Silme işlemi sırasında bir hata oluştu.", "red");
                    }
                    return;
                }

                const id = activeDeleteId;
                const type = activeDeleteType;
                const modal = document.getElementById('confirm-modal');
                if (modal) modal.classList.add('hidden');

                // --- TÜM VERİLERİ SIFIRLAMA (FABRİKA AYARLARI) ---
                if (type === 'reset_all') {
                    // localStorage.clear() komutu bu siteye ait her şeyi siler
                    try {
                        localStorage.clear();
                        sessionStorage.clear(); // Oturum verilerini de temizle

                        window.alertMessage("Sıfırlandı", "Uygulama fabrika ayarlarına döndürüldü. Yeniden başlatılıyor... 🔄", "green");

                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } catch (e) {
                        console.error("Sıfırlama hatası:", e);
                        window.alertMessage("Hata", "Sıfırlama başarısız oldu.", "red");
                    }
                    return;
                }

                // --- TEKİL SİLME İŞLEMLERİ (Aynı kalacak) ---
                if (!id && type !== 'reset_all') return;
                try {
                    if (type === 'installment') {
                        installments = installments.filter(x => x.id !== id);
                        localStorage.setItem(`my_installments_${APP_YEAR}`, JSON.stringify(installments));
                    }
                    else if (type === 'note') {
                        notes = notes.filter(x => x.id !== id);
                        localStorage.setItem(`my_tasks_${APP_YEAR}`, JSON.stringify(notes));
                    }
                    else if (type === 'goal') {
                        goals = goals.filter(x => x.id !== id);
                        localStorage.setItem(`my_goals_${APP_YEAR}`, JSON.stringify(goals));
                    }
                    else if (type === 'transaction') {
                        transactions = transactions.filter(x => x.id !== id);
                        window.transactions = transactions;
                        localStorage.setItem(`my_expenses_${APP_YEAR}`, JSON.stringify(transactions));
                        window.processTransactions(transactions);
                    }
                } catch (error) {
                    console.error("Silme işlemi başarısız:", error);
                    window.alertMessage("Hata", "Silme işlemi sırasında bir hata oluştu.", "red");
                }

                activeDeleteId = null;
                activeDeleteType = null;

                if (type !== 'transaction') {
                    window.renderNotes();
                    window.renderGoalsList();
                }
            };

            window.deleteInstallment = function (id) { window.requestDelete('installment', id); };
            window.deleteNote = function (id) { window.requestDelete('note', id); };
            window.deleteGoal = function (id) { window.requestDelete('goal', id); };
            window.confirmDeleteGoal = window.executeDelete;

            // Enhanced alertMessage - onConfirm varsa modal aç, yoksa toast göster
            window.alertMessage = function (title, message, type = "blue", onConfirm, opts = {}) {
                // Eğer 4. parametre fonksiyon ise confirm modal aç (bu davranış aynı kalır)
                if (typeof onConfirm === 'function') {
                    const variant = type === 'red'
                        ? 'red'
                        : (type === 'yellow' || type === 'warning' ? 'warning' : 'blue');

                    window.openConfirmModal({
                        title: title,
                        message: message,
                        confirmText: opts.confirmText || (type === 'red' ? 'Sil' : 'Onayla'),
                        cancelText: opts.cancelText || 'Vazgeç',
                        variant: variant,
                        onConfirm: onConfirm,
                        onCancel: opts.onCancel || null
                    });
                    return;
                }

                // ✅ Toast kartlarını kaldır: micro-feedback (mini pill) kullan
                const map = {
                    red: 'error',
                    green: 'success',
                    yellow: 'warning',
                    warning: 'warning',
                    orange: 'warning',
                    blue: 'info',
                    purple: 'info'
                };

                const microType = map[(type || 'info').toString().toLowerCase()] || 'info';

                const safeTitle = (title || '').toString().trim();
                const safeMsg = (message || '').toString().trim();
                const combined = safeTitle && safeMsg
                    ? `${safeTitle}: ${safeMsg}`
                    : (safeMsg || safeTitle || 'Bildirim');

                // showMicroFeedback varsa onu kullan, yoksa hiçbir şey yapma (çakışma olmasın)
                if (typeof window.showMicroFeedback === 'function') {
                    window.showMicroFeedback({
                        message: combined,
                        type: microType,
                        duration: opts.duration || (microType === 'error' ? 1800 : 1100)
                    });
                }
            };


            // Confirm modal buton event binding + ESC + Overlay click
            document.addEventListener('DOMContentLoaded', function () {
                const confirmBtn = document.getElementById('confirm-modal-btn');
                const cancelBtn = document.getElementById('confirm-modal-cancel-btn');
                const modal = document.getElementById('confirm-modal');

                // Confirm butonu: pendingAction varsa onu çalıştır, yoksa executeDelete
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', async function () {
                        if (typeof window.pendingConfirmAction === 'function') {
                            const action = window.pendingConfirmAction;
                            window.closeConfirmModal(false); // Cancel callback'i tetikleme
                            try {
                                await action();
                            } catch (e) {
                                console.error("Confirm action failed:", e);
                            }
                        } else {
                            window.executeDelete();
                        }
                    });
                }

                // Cancel butonu
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function () {
                        window.closeConfirmModal(true);
                    });
                }

                // Overlay click (modal dışına tıklama)
                if (modal) {
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            window.closeConfirmModal(true);
                        }
                    });
                }

                // ESC tuşu ile kapatma
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        const confirmModal = document.getElementById('confirm-modal');
                        if (confirmModal && !confirmModal.classList.contains('hidden')) {
                            window.closeConfirmModal(true);
                        }
                    }
                });
            });

            // Akıllı Panel Fonksiyonları
            window.calculateConverter = function () {
                const inputVal = document.getElementById('converter-input').value; const tl = window.parseSimpleCurrency(inputVal);
                const usdRate = liveRates.USD || 1; const eurRate = liveRates.EUR || 1; const gramRate = liveRates.GRAM || 1;
                document.getElementById('conv-usd').innerText = (tl / usdRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('conv-eur').innerText = (tl / eurRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('conv-gram').innerText = (tl / gramRate).toLocaleString('tr-TR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            };

            window.updateLoanRateDisplay = function (val) {
                const displayEl = document.getElementById('loan-rate-display'); if (displayEl) displayEl.textContent = `%${parseFloat(val).toFixed(2)}`;
            }

            window.calculateLoan = function () {
                const amount = window.parseSimpleCurrency(document.getElementById('loan-amount').value);
                const term = parseFloat(document.getElementById('loan-term').value);
                const rateInput = document.getElementById('loan-rate');
                if (!rateInput) return;
                const monthlyRatePct = parseFloat(rateInput.value);
                if (!amount || !term || term <= 0 || isNaN(monthlyRatePct) || monthlyRatePct < 0) { window.alertMessage("Hata", "Lütfen geçerli bir tutar, vade ve faiz oranı giriniz.", "red"); return; }
                const interestRate = monthlyRatePct / 100;
                let monthlyPayment;
                if (interestRate === 0) monthlyPayment = amount / term;
                else monthlyPayment = (amount * interestRate * Math.pow(1 + interestRate, term)) / (Math.pow(1 + interestRate, term) - 1);
                document.getElementById('loan-result').classList.remove('hidden');
                document.getElementById('loan-monthly').innerText = monthlyPayment.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺';
            };

            window.updateHealthStatus = function () {
                const container = document.getElementById('health-status-content'); if (!container) return;

                const targetMonth = currentDate.getMonth();
                const targetYear = currentDate.getFullYear();

                let income = 0, expense = 0;

                // Verileri Hesapla
                transactions.forEach(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    if (tDate.getMonth() === targetMonth && tDate.getFullYear() === targetYear) {
                        const val = parseFloat(t.amount);
                        if (t.type === 'income') income += val;
                        else if (!isSavingsTransaction(t)) expense += val;
                    }
                });

                // Puanlama Hesaplamaları
                let score = 50; // Başlangıç (Nötr)
                let savingsRate = 0;
                let message = "Henüz yeterli veri yok.";
                let colorClass = "text-gray-500";
                let barColor = "bg-gray-400";
                let bgColor = "bg-gray-100";

                if (income > 0) {
                    savingsRate = ((income - expense) / income) * 100;
                    // Formül: %50 tasarruf = 100 puan, %0 tasarruf = 50 puan, -%50 açık = 0 puan
                    score = Math.min(100, Math.max(0, (savingsRate + 50)));
                } else if (expense > 0) {
                    score = 10; // Gelir yok ama harcama var
                    savingsRate = -100;
                } else {
                    score = 50; // İşlem yok
                }

                // Duruma Göre Renk ve Mesaj Belirleme
                if (income === 0 && expense === 0) {
                    message = "Bu ay henüz işlem yapmadın. Temiz bir sayfa açmak için harika bir gün! ☀️";
                    colorClass = "text-gray-400"; barColor = "bg-gray-300"; bgColor = "bg-gray-50 dark:bg-white/5";
                } else if (score >= 80) {
                    message = "🔥 Mükemmel! Finansal özgürlüğe koşuyorsun. Yatırımlarını artırmayı düşünebilirsin.";
                    colorClass = "text-emerald-500"; barColor = "bg-emerald-500"; bgColor = "bg-emerald-50 dark:bg-emerald-900/20";
                } else if (score >= 60) {
                    message = "✅ Gayet iyi. Bütçen dengeli ve kontrol altında. Böyle devam et!";
                    colorClass = "text-blue-500"; barColor = "bg-blue-500"; bgColor = "bg-blue-50 dark:bg-blue-900/20";
                } else if (score >= 40) {
                    message = "⚠️ Dikkatli ol. Harcamaların gelirine çok yakın, sürpriz masraflar seni zorlayabilir.";
                    colorClass = "text-yellow-500"; barColor = "bg-yellow-500"; bgColor = "bg-yellow-50 dark:bg-yellow-900/20";
                } else {
                    message = "🚨 Kritik Durum! Giderlerin gelirini aşmış durumda. Acil bütçe planlaması yapmalısın.";
                    colorClass = "text-red-500"; barColor = "bg-red-500"; bgColor = "bg-red-50 dark:bg-red-900/20";
                }

                // HTML Render (Glassmorphism Tasarım)
                container.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <div>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Sağlık Puanı</p>
                    <h2 class="text-4xl font-black ${colorClass} tracking-tighter">${Math.round(score)}<span class="text-lg text-gray-300 font-bold opacity-50">/100</span></h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Tasarruf Oranı</p>
                    <p class="text-xl font-bold ${savingsRate >= 0 ? 'text-emerald-500' : 'text-red-500'}">%${savingsRate.toFixed(1)}</p>
                </div>
            </div>

            <div class="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-full mb-4 overflow-hidden shadow-inner">
                <div class="h-full ${barColor} transition-all duration-1000 ease-out relative" style="width: ${score}%">
                    <div class="absolute inset-0 bg-white/30 animate-pulse"></div>
                </div>
            </div>

            <div class="p-3 rounded-xl ${bgColor} border border-white/10 flex items-start space-x-3 backdrop-blur-sm transition-colors">
                <div class="text-xl mt-0.5">💡</div>
                <div>
                    <p class="text-xs font-bold ${colorClass} mb-0.5">Analiz Sonucu</p>
                    <p class="text-[10px] text-gray-600 dark:text-gray-300 leading-relaxed font-medium">${message}</p>
                </div>
            </div>
            
            <div class="mt-3 flex justify-between text-[9px] text-gray-400 font-bold border-t border-gray-100 dark:border-white/5 pt-2">
                <span>Gelir: <span class="text-gray-600 dark:text-gray-300 font-black">${income.toLocaleString('tr-TR')} ₺</span></span>
                <span>Gider: <span class="text-gray-600 dark:text-gray-300 font-black">${expense.toLocaleString('tr-TR')} ₺</span></span>
            </div>
        `;
            };

            window.clearChat = function () { chatHistory = []; const msgContainer = document.getElementById('chat-messages'); const suggestions = document.getElementById('chat-suggestions'); if (msgContainer) msgContainer.innerHTML = ''; if (suggestions) suggestions.classList.remove('hidden'); };
            window.appendMessage = function (role, text) {
                const container = document.getElementById('chat-messages'); if (!container) return;
                const msgDiv = document.createElement('div');
                if (role === 'ai') { msgDiv.className = 'flex items-start space-x-2 animate-slide-up'; msgDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-sm shadow-sm flex-shrink-0">🤖</div><div class="chat-bubble ai prose">${marked.parse(text)}</div>`; }
                else { msgDiv.className = 'flex justify-end animate-slide-up'; msgDiv.innerHTML = `<div class="chat-bubble user">${text}</div>`; }
                container.appendChild(msgDiv); container.classList.remove('hidden'); const parent = document.getElementById('chat-container'); if (parent) parent.scrollTop = parent.scrollHeight;
            };

            window.handleChatSubmit = function (text = null, mode = 'chat') {
                const input = document.getElementById('chat-input'); const userText = text || input.value;
                if (!userText || !userText.trim()) return; if (input) input.value = '';
                if (!window.checkPremiumFeature('ai_chat')) return;
                const suggestions = document.getElementById('chat-suggestions'); if (suggestions) suggestions.classList.add('hidden');
                window.appendMessage('user', userText); window.sendAIChatRequest(userText, mode);
            };

            // Firebase'siz API çağrıları (Mock veya geçersiz)
            async function fetchWithRetry(url, options, retries = 3) {
                // Yerel Mod: API çağrısı atlanıp, mock hata döndürülüyor.
                console.warn("API çağrısı yerel modda atlanmıştır. Pro özelliğini kullanmak için uygulamayı Firebase ile başlatın.");
                return {
                    ok: false,
                    status: 400,
                    json: async () => ({ error: { message: "Bu özellik yerel modda devre dışıdır. API anahtarını kontrol edin." } })
                };
            }

            window.sendAIChatRequest = async function (userText, mode) {
                const loading = document.getElementById('chat-loading'); if (loading) loading.classList.remove('hidden');
                const parent = document.getElementById('chat-container'); if (parent) parent.scrollTop = parent.scrollHeight;

                // PATCH: Yerel mod için akıllı cevap sistemi (getFinanceSnapshot kullan)
                if (loading) loading.classList.add('hidden');

                const lowerText = userText.toLocaleLowerCase('tr-TR');
                const formatTRY = (v) => (v || 0).toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';

                // PATCH: Finans sorguları için getFinanceSnapshot kullan
                const isStatusQuery = /durum|özet|nasıl.*gidiyor|genel|bu\s*ay|kalan|mali|finansal/i.test(lowerText);
                const isExpenseQuery = /gider|harcama|harcadım/i.test(lowerText);
                const isIncomeQuery = /gelir|maaş|kazanç/i.test(lowerText);
                const isSavingsQuery = /birikim|tasarruf|yatırım|dolar|euro|altın/i.test(lowerText);
                const isCategoryQuery = /en\s*çok|en\s*fazla|kategori|nereye/i.test(lowerText);
                const isSubscriptionQuery = /taksit|abonelik|sabit|düzenli|aylık.*ödeme/i.test(lowerText);
                const isPredictionQuery = /ay\s*sonu|tahmin|kalan.*para|ne.*olur/i.test(lowerText);

                let response = '';

                // PATCH: Status / özet sorgusu
                if (isStatusQuery || isExpenseQuery || isIncomeQuery || isSavingsQuery) {
                    const snap = window.getFinanceSnapshot('month');
                    const greeting = ['Patron', 'Şampiyon', 'Dostum'][Math.floor(Math.random() * 3)];

                    response = `### 🧠 FİNGO YAPAY ZEKA Raporu\n\n`;
                    response += `| Kalem | Tutar |\n|---|---|\n`;
                    response += `| 💰 Gelir | **${formatTRY(snap.income)}** |\n`;
                    response += `| 💸 Gider | **${formatTRY(snap.expense)}** |\n`;
                    response += `| 💎 Birikim (Kur Endeksli) | **${formatTRY(snap.indexedSavingsTL)}** |\n`;
                    response += `| 📈 Net Durum | **${formatTRY(snap.net)}** |\n\n`;

                    if (snap.net >= 0) {
                        response += `✅ **${greeting}, iyi gidiyorsun!** Bu ay ${formatTRY(snap.net)} artıdasın. Birikime devam edersen hedeflerine daha hızlı ulaşırsın! 🚀`;
                    } else {
                        response += `⚠️ **Dikkat ${greeting}!** Bu ay ${formatTRY(Math.abs(snap.net))} ekside görünüyorsun. Gereksiz harcamaları kısmayı düşünebilirsin. 💪`;
                    }
                }
                // PATCH: Kategori analizi
                else if (isCategoryQuery) {
                    const snap = window.getFinanceSnapshot('month');
                    const categoryTotals = {};

                    // SavingsTransactions HARİÇ tutarak hesapla (Altın, Yatırım önerilmemeli)
                    snap.filtered.filter(t => t.type === 'expense' && !window.isSavingsTransaction(t)).forEach(t => {
                        const cat = t.category || 'Diğer';
                        const val = typeof t.amount === 'number' ? t.amount : parseFloat(t.amount) || 0;
                        categoryTotals[cat] = (categoryTotals[cat] || 0) + val;
                    });

                    const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).slice(0, 5);

                    response = `### 🎯 En Çok Harcama Yaptığın Kategoriler (Yatırımlar Hariç)\n\n`;
                    if (sorted.length > 0) {
                        response += `| # | Kategori | Tutar |\n|---|---|---|\n`;
                        sorted.forEach(([cat, val], i) => {
                            response += `| ${i + 1} | ${cat} | ${formatTRY(val)} |\n`;
                        });
                        response += `\n💡 **FİNGO TASARRUF ÖNERİSİ:** ${sorted[0][0]} kategorisinde tasarruf yapmayı düşünebilirsin!`;
                    } else {
                        response += `Bu ay henüz gider kaydı yok.`;
                    }
                }
                // PATCH: Taksit/abonelik sorgusu
                else if (isSubscriptionQuery) {
                    const rules = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');
                    const activeRules = rules.filter(r => !r.maxRuns || r.runsDone < r.maxRuns);
                    const totalMonthly = activeRules.reduce((sum, r) => sum + (r.amount || 0), 0);

                    response = `### 📅 Sabit Giderler & Taksitler\n\n`;
                    response += `Aktif düzenli işlem: **${activeRules.length} adet**\n`;
                    response += `Toplam aylık yük: **${formatTRY(totalMonthly)}**\n\n`;

                    if (activeRules.length > 0) {
                        response += `| İşlem | Tutar |\n|---|---|\n`;
                        activeRules.slice(0, 5).forEach(r => {
                            response += `| ${r.description || r.category} | ${formatTRY(r.amount)} |\n`;
                        });
                    }
                }
                // PATCH: Tahmin sorgusu
                else if (isPredictionQuery) {
                    const snap = window.getFinanceSnapshot('month');
                    const now = new Date();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const daysPassed = now.getDate();
                    const daysRemaining = daysInMonth - daysPassed;

                    const dailyExpense = daysPassed > 0 ? snap.expense / daysPassed : 0;
                    const projectedExpense = snap.expense + (dailyExpense * daysRemaining);
                    const projectedNet = snap.income - projectedExpense;

                    response = `### 🔮 Ay Sonu Tahmini\n\n`;
                    response += `📊 Günlük ortalama gider: **${formatTRY(dailyExpense)}**\n`;
                    response += `📆 Kalan gün: **${daysRemaining}**\n`;
                    response += `💸 Tahmini toplam gider: **${formatTRY(projectedExpense)}**\n`;
                    response += `💰 Tahmini net durum: **${formatTRY(projectedNet)}**\n\n`;

                    if (projectedNet >= 0) {
                        response += `✅ Bu gidişle ay sonunda **artıda** kalacaksın!`;
                    } else {
                        response += `⚠️ Dikkat! Bu hızla devam edersen ay sonunda **${formatTRY(Math.abs(projectedNet))}** eksiye düşebilirsin.`;
                    }
                }
                // PATCH: Bilinmeyen soru
                else {
                    const snap = window.getFinanceSnapshot('month');
                    const tips = [
                        "Küçük tasarruflar büyük servetler yaratır!",
                        "Bütçeni takip etmeye devam et!",
                        "Her ay biraz birikim yap, geleceğin parlak olsun!",
                        "Gereksiz abonelikleri iptal etmeyi düşün."
                    ];
                    response = `Hmm, bu soruyu tam anlayamadım ama şunu söyleyebilirim:\n\n`;
                    response += `💡 **FİNGO TASARRUF ÖNERİSİ:** ${tips[Math.floor(Math.random() * tips.length)]}\n\n`;
                    response += `Bu ayki durumun: Gelir ${formatTRY(snap.income)}, Gider ${formatTRY(snap.expense)}`;
                }

                window.appendMessage('ai', response);
                return;
            };

            window.processAIInput = function (mode) { window.handleChatSubmit(null, mode); };

            // --- GÖREV ÖNCELİK YÖNETİMİ ---
            window.setTaskPriority = function (p) {
                const input = document.getElementById('note-task-priority');
                if (input) input.value = p;
                document.querySelectorAll('.prio-btn').forEach(b => {
                    b.className = 'prio-btn py-2.5 rounded-xl text-xs font-bold bg-gray-50 dark:bg-white/5 text-gray-400 border border-transparent transition';
                });
                const activeBtn = document.getElementById('prio-' + p);
                if (activeBtn) {
                    if (p === 'low') activeBtn.className = 'prio-btn py-2.5 rounded-xl text-xs font-bold bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 border border-green-200 dark:border-green-800 transition';
                    if (p === 'medium') activeBtn.className = 'prio-btn py-2.5 rounded-xl text-xs font-bold bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 border border-yellow-200 dark:border-yellow-800 transition';
                    if (p === 'high') activeBtn.className = 'prio-btn py-2.5 rounded-xl text-xs font-bold bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 transition';
                }
            };

            // Note: setNotesMode and toggleNotesModal are already defined earlier in the file (lines ~24527 and ~24565)
            // Note: saveNoteOrInstallment is already defined earlier in the file (line ~24639)

            window.toggleTaskCompleted = async function (id) {
                const note = notes.find(n => n.id === id);
                if (!note) return;
                const newState = !note.completed;

                note.completed = newState;
                localStorage.setItem(`my_tasks_${APP_YEAR}`, JSON.stringify(notes));

                window.renderNotes();
            };

            window.markInstallmentPaid = async function (id) {
                const installment = installments.find(i => i.id === id);
                if (!installment || installment.remainingMonths <= 0) return;

                const currentMonthStr = new Date().toISOString().slice(0, 7);

                // Recurring rule'u bul
                recurringRules = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');
                const rule = recurringRules.find(r => r.source === 'installment' && r.sourceId === id);

                // Çift kayıt kontrolü: Bu ay zaten kaydedildi mi?
                if (rule && rule.lastExecutedMonth === currentMonthStr) {
                    window.alertMessage("Bilgi", "Bu ayın taksiti zaten kaydedilmiş. ✅", "blue");
                    return;
                }

                // Gider işlemi ekle
                const newTx = {
                    id: 'l_inst_' + Date.now(),
                    type: 'expense',
                    amount: installment.monthlyAmount,
                    date: currentMonthStr,
                    category: '💳 Kredi Kartı',
                    description: installment.description + ' (Taksit)',
                    unitAmount: 0,
                    timestamp: new Date().toISOString()
                };
                transactions.push(newTx);
                window.transactions = transactions;
                localStorage.setItem(`my_expenses_${APP_YEAR}`, JSON.stringify(transactions));

                // Taksit sayaçlarını güncelle
                const newPaid = installment.paidMonths + 1;
                const newRemaining = installment.totalMonths - newPaid;
                installment.paidMonths = newPaid;
                installment.remainingMonths = newRemaining;
                localStorage.setItem(`my_installments_${APP_YEAR}`, JSON.stringify(installments));

                // Recurring rule'u güncelle
                if (rule) {
                    rule.lastExecutedMonth = currentMonthStr;
                    rule.runsDone = (rule.runsDone || 0) + 1;

                    // Taksit bittiyse rule'u temizle
                    if (newRemaining <= 0) {
                        recurringRules = recurringRules.filter(r => r.id !== rule.id);
                    }
                    localStorage.setItem(`my_recurring_rules_${APP_YEAR}`, JSON.stringify(recurringRules));
                }

                // İşlemleri yenile
                window.processTransactions(transactions);

                // Bildirim göster
                if (newRemaining === 0) {
                    window.alertMessage("Tebrikler!", `${installment.description} taksiti başarıyla tamamlandı. 🎉`, "blue");
                    window.showMiniToast("Taksit Tamamlandı", `"${installment.description}" bitti! 🎉`, "🎉");
                } else {
                    window.showMiniToast("Taksit Kaydedildi", "Bu ayın taksiti giderlerine eklendi.", "✅");
                }
                window.renderNotes();
            };

            window.renderNotes = function () {
                if (window.currentNotesMode === 'task') {
                    const c = document.getElementById('notes-task-list'); if (!c) return;
                    if (notes.length === 0) { c.innerHTML = `<div class="flex flex-col items-center justify-center py-12 opacity-60"><div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-3 text-3xl">📝</div><p class="text-sm font-bold text-gray-500 dark:text-gray-400">Henüz not eklenmedi</p><p class="text-[10px] text-gray-400">Sağ alttaki butona basarak ekle</p></div>`; } else {
                        c.innerHTML = '';
                        // SORTING: Uncompleted first, then by Priority (High>Medium>Low), then by Date
                        const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                        notes.sort((a, b) => {
                            if (a.completed !== b.completed) return a.completed - b.completed;
                            if ((priorityOrder[a.priority] || 2) !== (priorityOrder[b.priority] || 2)) return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2);
                            return new Date(a.dueDate || '3000-01-01') - new Date(b.dueDate || '3000-01-01');
                        });

                        notes.forEach(n => {
                            const isCompleted = n.completed;
                            const dueDate = n.dueDate ? new Date(n.dueDate).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }) : '';
                            const prio = n.priority || 'low';

                            let badgeHtml = '';
                            if (prio === 'high') badgeHtml = `<span class="px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-[9px] font-black uppercase tracking-wider border border-red-200 dark:border-red-800">Acil</span>`;
                            else if (prio === 'medium') badgeHtml = `<span class="px-2 py-0.5 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 text-[9px] font-bold uppercase tracking-wider border border-yellow-200 dark:border-yellow-800">Orta</span>`;
                            else badgeHtml = `<span class="px-2 py-0.5 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 text-[9px] font-bold uppercase tracking-wider border border-green-200 dark:border-green-800">Düşük</span>`;

                            const textClass = isCompleted ? 'line-through text-gray-400 dark:text-gray-600' : 'text-gray-800 dark:text-white';

                            c.insertAdjacentHTML('beforeend', `
                        <div class="glass-card rounded-xl p-4 flex justify-between items-center transition-all ${isCompleted ? 'opacity-60 bg-gray-50 dark:bg-black/20' : ''}">
                            <div class="flex items-center space-x-3 w-full">
                                <button onclick="window.toggleTaskCompleted('${n.id}')" class="w-6 h-6 rounded-full flex items-center justify-center border-2 ${isCompleted ? 'border-green-500 bg-green-500 text-white' : 'border-gray-300 dark:border-gray-600 text-transparent hover:border-green-500'} transition-colors duration-200 shrink-0">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </button>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-0.5">
                                        ${badgeHtml}
                                        ${dueDate ? `<span class="text-[9px] text-gray-400 font-medium">📅 ${dueDate}</span>` : ''}
                                    </div>
                                    <p class="text-sm font-bold truncate ${textClass}">${n.title}</p>
                                </div>
                            </div>
                            <button onclick="window.deleteNote('${n.id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-500 transition shrink-0">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>`);
                        });
                    }
                } else {
                    const c = document.getElementById('installments-list');
                    const summaryContainer = document.getElementById('notes-installment-summary');
                    if (!c) return;

                    // --- DEBT CRUSHER: SMART SUMMARY CALCULATION ---
                    let totalMonthlyLoad = 0;
                    let totalRemainingDebt = 0;
                    installments.forEach(i => {
                        if (i.remainingMonths > 0) {
                            totalMonthlyLoad += i.monthlyAmount;
                            totalRemainingDebt += (i.remainingMonths * i.monthlyAmount);
                        }
                    });

                    // RENDER SUMMARY CARD
                    if (summaryContainer) {
                        if (installments.length > 0 && totalRemainingDebt > 0) {
                            const progress = 100;
                            summaryContainer.innerHTML = `
                        <div class="relative overflow-hidden rounded-[24px] p-6 mb-4 shadow-2xl transition-transform hover:scale-[1.01]" style="background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-16 -mt-16 pointer-events-none"></div>
                            <div class="absolute bottom-0 left-0 w-24 h-24 bg-black/10 rounded-full blur-xl -ml-10 -mb-10 pointer-events-none"></div>
                            
                            <div class="flex justify-between items-start mb-6 relative z-10">
                                <div>
                                    <p class="text-xs font-bold uppercase tracking-widest mb-1" style="color: rgba(255,255,255,0.9) !important;">TOPLAM KALAN BORÇ</p>
                                    <h3 class="text-3xl font-black tracking-tight" style="color: #ffffff !important;">${totalRemainingDebt.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} <span class="text-lg font-bold" style="color: rgba(255,255,255,0.8) !important;">₺</span></h3>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm border border-white/20">
                                    <span class="text-lg">💳</span>
                                </div>
                            </div>
                            
                            <div class="space-y-3 relative z-10">
                                <div class="flex justify-between items-end text-xs font-bold">
                                    <span style="color: rgba(255,255,255,0.9) !important;">Aylık Ödeme Yükü</span>
                                    <span class="text-base font-black" style="color: #ffffff !important;">${totalMonthlyLoad.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} ₺</span>
                                </div>
                                <div class="w-full rounded-full h-1.5 overflow-hidden" style="background: rgba(255,255,255,0.2);">
                                     <div class="h-full rounded-full" style="width: 75%; background: #ffffff; box-shadow: 0 0 10px rgba(255,255,255,0.5);"></div> 
                                </div>
                                <p class="text-[10px] text-right mt-1" style="color: rgba(255,255,255,0.8) !important;">Otomatik ödeme planı aktif ✨</p>
                            </div>
                        </div>`;
                        } else {
                            if (summaryContainer) summaryContainer.innerHTML = '';
                        }
                    }

                    installments.sort((a, b) => a.remainingMonths - b.remainingMonths);

                    if (installments.length === 0) {
                        c.innerHTML = `<div class="flex flex-col items-center justify-center py-12 opacity-60"><div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-3 text-3xl">📅</div><p class="text-sm font-bold text-gray-500 dark:text-gray-400">Henüz taksit eklenmedi</p><p class="text-[10px] text-gray-400">Taksitlerini takip etmek için ekle</p></div>`;
                    } else {
                        c.innerHTML = '';
                        installments.forEach(i => {
                            const progress = i.totalMonths > 0 ? Math.min(100, Math.round(((i.totalMonths - i.remainingMonths) / i.totalMonths) * 100)) : 100;

                            // Calculate Estimate End Date
                            const now = new Date();
                            now.setMonth(now.getMonth() + i.remainingMonths);
                            const endString = now.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });

                            c.insertAdjacentHTML('beforeend', `
                        <div class="glass-card rounded-2xl p-4 relative group hover:border-indigo-200 dark:hover:border-indigo-800 transition-colors">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="text-sm font-bold text-gray-800 dark:text-white leading-tight">${i.description}</h4>
                                    <span class="text-[10px] text-gray-500 font-medium">Bitiş: <strong class="text-indigo-600 dark:text-indigo-400">${endString}</strong></span>
                                </div>
                                <button onclick="window.deleteInstallment('${i.id}')" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-red-500 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                            
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex flex-col">
                                    <span class="text-xs font-medium text-gray-400">Taksit Tutarı</span>
                                    <span class="text-base font-black text-gray-800 dark:text-white">${i.monthlyAmount.toLocaleString('tr-TR', { minimumFractionDigits: 0 })} ₺</span>
                                </div>
                                <div class="flex flex-col items-end">
                                    <span class="text-xs font-bold text-gray-600 dark:text-gray-300">%${progress}</span>
                                    <span class="text-[10px] text-gray-400">${i.remainingMonths} ay kaldı</span>
                                </div>
                            </div>
                            
                            <div class="relative w-full h-2.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="absolute top-0 left-0 h-full rounded-full transition-all duration-1000 ease-out" 
                                     style="width:${progress}%; background: ${i.remainingMonths === 0 ? '#10B981' : 'linear-gradient(90deg, #6366F1, #8B5CF6)'}; box-shadow: 0 0 10px rgba(99,102,241,0.5);">
                                </div>
                            </div>
                            
                            ${i.remainingMonths > 0 ? `
                            <button onclick="window.markInstallmentPaid('${i.id}')" class="mt-4 w-full py-2.5 rounded-xl bg-indigo-50 dark:bg-indigo-900/20 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 text-[10px] font-bold text-indigo-600 dark:text-indigo-300 transition-all active:scale-[0.98] flex items-center justify-center gap-2 border border-indigo-100 dark:border-indigo-800/30">
                                <span>💸</span> Ödeme Yap (1 Taksit)
                            </button>` : `
                            <div class="mt-4 w-full py-2 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800/30 text-[10px] font-bold text-green-600 dark:text-green-400 text-center flex items-center justify-center gap-2">
                                <span>🎉</span> Ödemeler Tamamlandı
                            </div>`}
                        </div>`);
                        });
                    }

                    // Update Dashboard Widget if exists
                    const dashInstallmentEl = document.getElementById('dashboard-installment-total');
                    const widgetEl = document.getElementById('dashboard-installment-widget');
                    if (dashInstallmentEl && widgetEl) {
                        dashInstallmentEl.textContent = totalMonthlyLoad.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺';
                        if (totalMonthlyLoad > 0) widgetEl.classList.remove('hidden'); else widgetEl.classList.add('hidden');
                    }
                }
            };

            window.loadLocalData = function () {
                try {
                    transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]'); window.transactions = transactions;

                    // ✅ ONE-TIME FIX: Yanlış excludeFromBalance işaretli expense'leri düzelt
                    // Kredi kartı gibi kategoriler yatırım değil, excludeFromBalance = false olmalı
                    const isInvestmentKeywordLocal = (cat = "") => {
                        return /(Gram|USD|EUR|Dolar|Euro|Altın|Çeyrek|💵|💶|🟡|🪙)/i.test(cat);
                    };
                    let fixedCount = 0;
                    transactions = transactions.map(t => {
                        if (t && t.type === 'expense' && t.excludeFromBalance === true && !isInvestmentKeywordLocal(t.category || "")) {
                            fixedCount++;
                            return { ...t, excludeFromBalance: false };
                        }
                        return t;
                    });
                    if (fixedCount > 0) {
                        localStorage.setItem(`my_expenses_${APP_YEAR}`, JSON.stringify(transactions));
                        console.log(`[FIX] ${fixedCount} yanlış excludeFromBalance işaretli işlem düzeltildi.`);
                    }
                    window.transactions = transactions;

                    goals = JSON.parse(localStorage.getItem(`my_goals_${APP_YEAR}`) || '[]');
                    notes = JSON.parse(localStorage.getItem(`my_tasks_${APP_YEAR}`) || '[]');
                    installments = JSON.parse(localStorage.getItem(`my_installments_${APP_YEAR}`) || '[]');
                    categoryBudgets = JSON.parse(localStorage.getItem(`my_budgets_${APP_YEAR}`) || '{}');
                    const savedCats = localStorage.getItem(`my_categories_${APP_YEAR}`);
                    if (savedCats) { categories = JSON.parse(savedCats); } else { categories = JSON.parse(JSON.stringify(defaultCategories)); }
                    window.processTransactions(transactions); window.renderGoalsList(); window.renderNotes();
                    window.updateLoanRateDisplay(3.5);
                    window.updateDashboardGoalWidget(); // İlk açılışta widget'ı güncelle
                    window.updateDashboardGoalWidget(); // İlk açılışta widget'ı güncelle
                    if (window.refreshGoalComputedValues) window.refreshGoalComputedValues(); // Kur endeksli hedefleri hesapla
                    setTimeout(() => { if (window.renderDailyInsight) window.renderDailyInsight(); }, 1000); // ⚡ INSIGHT WIDGET RENDER
                } catch (e) { console.error("Local Data Error", e); transactions = []; goals = []; notes = []; installments = []; }
            };

            window.startLocalMode = async function () {
                isLocalMode = true;
                const loadingBar = document.getElementById('loading-bar'); if (loadingBar) loadingBar.style.width = '70%';
                const loadingText = document.getElementById('loading-text'); if (loadingText) loadingText.textContent = "Yerel mod başlatılıyor...";
                const storageInd = document.getElementById('storage-indicator'); if (storageInd) storageInd.textContent = "Yerel Kayıt (Native)";

                await window.loadLocalData();

                window.checkBadges();
                setTimeout(window.openApp, 800);
            };

            window.openApp = function () {
                const loadingBar = document.getElementById('loading-bar'); if (loadingBar) loadingBar.style.width = '100%';
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen'); const appContainer = document.getElementById('app-container');
                    const daySelect = document.getElementById('input-recurring-day'); if (daySelect) { daySelect.innerHTML = ''; for (let i = 1; i <= 31; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = i; daySelect.appendChild(opt); } }
                    window.updateCategoryOptions(); window.updateHeaderDate(); window.updatePeriodDisplay(); window.updateNavIndicator('nav-dashboard'); window.switchTab('dashboard');

                    // Kayıtlı temayı uygula
                    const savedTheme = localStorage.getItem('app_theme');
                    if (savedTheme) { window.setAppTheme(savedTheme); }
                    else { window.setAppTheme('system'); }

                    // Gizlilik modunu yükle
                    if (window.loadPrivacyState) window.loadPrivacyState();

                    // === AVATAR KALICILIĞI (PERSISTENCE) ===
                    // localStorage'dan kayıtlı avatarı ve kullanıcı bilgisini yükle
                    try {
                        const savedName = localStorage.getItem('user_name') || 'Misafir';
                        const savedTitle = localStorage.getItem('user_title') || null;
                        const savedAvatar = localStorage.getItem('user_avatar') || null;

                        if (window.updateProfileUI) {
                            window.updateProfileUI(savedName, savedTitle, savedAvatar);
                        }
                    } catch (e) {
                        console.log('Avatar restore error:', e);
                    }

                    // --- GÜNCELLENEN KISIM BAŞLANGIÇ ---

                    // İlk açılışta veriyi çek
                    window.fetchMarketData();

                    // Akıllı Zamanlayıcı: Her 5 dakikada (300.000 ms) bir yenile
                    // VE sadece sayfa görünür durumdaysa (document.hidden değilse) istek at.
                    setInterval(() => {
                        try {
                            if (!document.hidden) {
                                window.fetchMarketData();
                            }
                        } catch (e) { console.log(e); }
                    }, 300000); // 60000 yerine 300000 (5 dakika) yaptık.

                    // --- GÜNCELLENEN KISIM BİTİŞ ---

                    window.checkRecurringTransactions();
                    if (splash) { splash.style.opacity = '0'; splash.style.pointerEvents = 'none'; }
                    if (appContainer) appContainer.classList.remove('opacity-0');
                    setTimeout(() => { if (splash) { splash.style.display = 'none'; splash.style.zIndex = '-10'; } }, 700);
                }, 500);
            };

            // YENİ: Splash Ekranı Mesaj Döngüsü
            window.cycleLoadingMessages = function () {
                const messages = [
                    "Veriler şifreleniyor... 🔒",
                    "Piyasa kurları alınıyor... 📈",
                    "Cüzdan senkronize ediliyor... 💼",
                    "Fatura takvimi kontrol ediliyor... 🧾",
                    "Fingo Autopilot hazırlanıyor... 🤖",
                    "Bütçe analizi yapılıyor... 📊",
                    "Fingenda hazır! 🚀"
                ];

                const textEl = document.getElementById('loading-text');
                if (!textEl) return;
                textEl.textContent = messages[0]; // İlk mesaj

                let index = 0;
                const interval = setInterval(() => {
                    index++;
                    if (index < messages.length) {
                        textEl.style.opacity = '0'; // Yazıyı silikleştir
                        textEl.style.transform = 'translateY(5px)'; // Hafif aşağı kaydır

                        setTimeout(() => {
                            textEl.textContent = messages[index]; // Yazıyı değiştir
                            textEl.style.opacity = '1'; // Tekrar görünür yap
                            textEl.style.transform = 'translateY(0)'; // Yerine getir
                        }, 200);
                    } else {
                        clearInterval(interval);
                    }
                }, 800); // Mesaj değişim hızı
            };

            // GÜNCELLENMİŞ BAŞLATMA FONKSİYONU (Aşağıya Taşındı ve Onboarding Eklendi)

            // Kategori Yönetimi: Kategori Yönetimi fonksiyonlarını başlatıyoruz
            window.openCategoryModal = function () { currentCategoryTab = 'expense'; window.renderCategoryEditList(); document.getElementById('btn-cat-tab-expense').className = "py-2 rounded-xl text-sm font-bold shadow-md bg-white dark:bg-gray-700 text-red-500 transition-all"; document.getElementById('btn-cat-tab-income').className = "py-2 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-400 transition-all"; document.getElementById('category-modal').classList.remove('hidden'); };
            window.closeCategoryModal = function () { document.getElementById('category-modal').classList.add('hidden'); };
            window.switchCategoryTab = function (type) { currentCategoryTab = type; window.renderCategoryEditList(); const btnExp = document.getElementById('btn-cat-tab-expense'); const btnInc = document.getElementById('btn-cat-tab-income'); if (type === 'expense') { btnExp.className = "py-2 rounded-xl text-sm font-bold shadow-md bg-white dark:bg-gray-700 text-red-500 transition-all"; btnInc.className = "py-2 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-400 transition-all"; } else { btnInc.className = "py-2 rounded-xl text-sm font-bold shadow-md bg-white dark:bg-gray-700 text-green-500 transition-all"; btnExp.className = "py-2 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-400 transition-all"; } };
            window.renderCategoryEditList = function () { const list = document.getElementById('category-edit-list'); if (!list) return; const currentList = categories[currentCategoryTab]; list.innerHTML = ''; if (currentList.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">Kategori bulunamadı.</p>'; return; } currentList.forEach((cat, index) => { const isDefault = defaultCategories[currentCategoryTab].includes(cat); const deleteButton = !isDefault ? `<button onclick="window.deleteCustomCategory(${index})" class="text-red-400 hover:text-red-600 transition p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : `<span class="text-xs text-gray-400 dark:text-gray-600">Varsayılan</span>`; list.insertAdjacentHTML('beforeend', `<div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/10"><span class="text-sm font-bold dark:text-white">${cat}</span>${deleteButton}</div>`); }); };
            window.addCustomCategory = function () { const input = document.getElementById('new-category-input'); const val = input.value.trim(); if (!val) { window.alertMessage("Hata", "Lütfen bir kategori adı giriniz.", "red"); return; } if (categories[currentCategoryTab].includes(val)) { window.alertMessage("Uyarı", "Bu kategori zaten mevcut.", "red"); return; } categories[currentCategoryTab].push(val); input.value = ''; window.saveCategories(); window.alertMessage("Başarılı", "Yeni kategori eklendi.", "blue"); };
            window.deleteCustomCategory = function (index) { const categoryToDelete = categories[currentCategoryTab][index]; if (defaultCategories[currentCategoryTab].includes(categoryToDelete)) { window.alertMessage("Uyarı", "Varsayılan kategoriler silinemez.", "red"); return; } const hasTransactions = transactions.some(t => t.category === categoryToDelete); if (hasTransactions) { window.alertMessage("Uyarı", "Bu kategoriye ait işlemler mevcut. Önce işlemleri düzenlemelisiniz.", "red"); return; } categories[currentCategoryTab].splice(index, 1); window.saveCategories(); };
            window.saveCategories = function () { localStorage.setItem(`my_categories_${APP_YEAR}`, JSON.stringify(categories)); window.renderCategoryEditList(); window.updateCategoryOptions(); const budgetSelect = document.getElementById('budget-category'); if (budgetSelect && currentCategoryTab === 'expense') { window.openBudgetModal(); document.getElementById('budget-modal').classList.add('hidden'); } };

            document.addEventListener('DOMContentLoaded', function () {
                const rateInput = document.getElementById('loan-rate');
                if (rateInput) {
                    window.updateLoanRateDisplay(rateInput.value);
                }
                window.initApp(); // Uygulamayı başlat
            });
            // --- YEREL TESSERACT.JS OCR SİSTEMİ (ÜCRETSİZ & GİZLİLİK ODAKLI) ---

            // --- GELİŞMİŞ OCR & ONAY SİSTEMİ ---

            window.processOCR = async function (input) {
                const file = input.files[0];
                if (!file) return;

                // UI Güncelleme (Yükleniyor)
                const statusEl = document.getElementById('ocr-status');
                const progressEl = document.getElementById('ocr-progress');
                const barEl = document.getElementById('ocr-bar');

                if (statusEl) statusEl.classList.remove('hidden');
                if (progressEl) progressEl.innerText = 'Okunuyor... (%0)';
                if (barEl) { barEl.style.width = '0%'; barEl.classList.add('animate-pulse'); }

                try {
                    // Tesseract Worker Başlat
                    const worker = await Tesseract.createWorker('tur', 1, {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const pct = Math.round(m.progress * 100);
                                if (progressEl) progressEl.innerText = `Okunuyor... (%${pct})`;
                                if (barEl) barEl.style.width = `${pct}%`;
                            }
                        }
                    });

                    const { data: { text } } = await worker.recognize(file);
                    await worker.terminate();

                    // Regex ile Fiyat Bulma
                    const priceRegex = /(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2}))/g;
                    const matches = text.match(priceRegex);
                    let maxAmount = 0;

                    if (matches) {
                        const amounts = matches.map(m => {
                            let clean = m.replace(/\./g, '').replace(',', '.');
                            if ((clean.match(/\./g) || []).length > 1) {
                                clean = clean.replace(/\./g, '');
                                clean = clean.slice(0, -2) + '.' + clean.slice(-2);
                            }
                            return parseFloat(clean);
                        }).filter(val => !isNaN(val) && val < 500000); // Mantıksız sayıları ele

                        if (amounts.length > 0) maxAmount = Math.max(...amounts);
                    }

                    // Modal Hazırlığı
                    const modal = document.getElementById('ocr-confirm-modal');
                    const imgPreview = document.getElementById('ocr-preview-img');
                    const inputAmount = document.getElementById('ocr-confirm-amount');
                    const inputDate = document.getElementById('ocr-confirm-date');
                    const inputDesc = document.getElementById('ocr-confirm-desc');

                    // Resmi Önizlemeye Koy
                    const reader = new FileReader();
                    reader.onload = (e) => { imgPreview.src = e.target.result; };
                    reader.readAsDataURL(file);

                    // Değerleri Doldur
                    inputAmount.value = maxAmount > 0 ? window.formatMoneyTRY(maxAmount) : '';
                    inputDate.value = new Date().toISOString().slice(0, 10); // Varsayılan: Bugün

                    // Açıklama tahmini (Basit: İlk satırı al veya varsayılan)
                    const lines = text.split('\n').filter(l => l.trim().length > 3);
                    inputDesc.value = lines.length > 0 ? lines[0].substring(0, 20) + "..." : "Fiş Taraması";

                    // Yükleniyor'u Gizle ve Modalı Aç
                    setTimeout(() => {
                        if (statusEl) statusEl.classList.add('hidden');
                        if (barEl) barEl.classList.remove('animate-pulse');
                        modal.classList.remove('hidden');
                    }, 500);

                } catch (error) {
                    console.error("OCR Hatası:", error);
                    if (statusEl) statusEl.classList.add('hidden');
                    window.alertMessage("Hata", "Okuma başarısız. Lütfen tekrar dene.", "red");
                }
                input.value = ''; // Inputu temizle
            };

            window.confirmOCRData = function () {
                const modal = document.getElementById('ocr-confirm-modal');
                const amt = document.getElementById('ocr-confirm-amount').value;
                const date = document.getElementById('ocr-confirm-date').value;
                const desc = document.getElementById('ocr-confirm-desc').value;

                if (!amt) { window.alertMessage("Hata", "Lütfen bir tutar girin.", "red"); return; }

                // Ana Forma Aktar
                document.getElementById('input-amount').value = amt;
                document.getElementById('input-date').value = date;
                document.getElementById('input-desc').value = desc;

                // Modalı Kapat
                modal.classList.add('hidden');
                window.alertMessage("Başarılı", "Veriler forma aktarıldı. Kategoriyi seçip kaydedebilirsin! ✅", "green");
            };


            // --- NFT GALERİSİ GÜVENLİ AÇILIŞ (FIX) ---
            window.handleOpenGallery = function () {
                // 1. Profil modalını kapat
                window.toggleProfileModal(false);

                // 2. Animasyonun bitmesi için kısa bir süre bekle ve galeriyi aç
                setTimeout(() => {
                    const galleryModal = document.getElementById('badge-gallery-modal');
                    if (galleryModal) {
                        galleryModal.classList.remove('hidden');

                        // Galeriyi render et (Eğer fonksiyon tanımlıysa)
                        if (typeof window.renderNFTGallery === 'function') {
                            window.renderNFTGallery();
                        } else {
                            console.error("renderNFTGallery fonksiyonu bulunamadı!");
                        }
                    }
                }, 200); // 200ms gecikme çakışmayı önler
            };

            // --- UX ENHANCEMENTS: HAPTIC & ONBOARDING ---
            // --- GÜNCELLENMİŞ ONBOARDING (Bottom Sheet with Pro Upsell) ---
            window.startOnboarding = function () {
                // 0. NUCLEAR CLEANUP (Remove old onboarding if exists)
                const oldSheet = document.getElementById('onboarding-sheet');
                if (oldSheet) {
                    console.log('[Onboarding] Removing legacy onboarding-sheet');
                    oldSheet.remove();
                }

                // Test için reset: localStorage.removeItem('fingo_intro_seen');
                if (localStorage.getItem('fingo_intro_seen')) return;

                const overlay = document.getElementById('ob-overlay');
                if (!overlay) return;
                overlay.classList.remove('hidden');

                // Steps Data (6 Slides)
                const steps = [
                    {
                        icon: '💎',
                        title: 'Fingenda\'ya Hoş Geldin',
                        desc: 'Finansal özgürlüğüne giden yolculuk buradan başlıyor. Hazır mısın?',
                        color: 'from-indigo-500 to-purple-600',
                        isPremium: false
                    },
                    {
                        icon: '📊',
                        title: 'Net Tablo Tek Bakışta',
                        desc: 'Bütün gelir, gider ve yatırımlarını tek bir ekranda, kristal netliğinde gör.',
                        color: 'from-blue-500 to-cyan-500',
                        isPremium: false
                    },
                    {
                        icon: '⚡',
                        title: 'İşlem Eklemek 2 Saniye',
                        desc: 'Hızlı ekle butonu veya sesli komut ile harcamalarını anında kaydet.',
                        color: 'from-amber-400 to-orange-500',
                        isPremium: false
                    },
                    {
                        icon: '🏦',
                        title: 'Birikimlerini Ayrı Yönet',
                        desc: 'Altın, Döviz ve Fonlarını "Birikim" olarak işaretle, net varlığını takip et.',
                        color: 'from-emerald-500 to-teal-600',
                        isPremium: false
                    },
                    {
                        icon: '📅',
                        title: 'Zaman Çizelgesi + Rapor',
                        desc: 'Geçmiş harcamalarını incele, detaylı raporlarla bütçene hakim ol.',
                        color: 'from-rose-500 to-pink-600',
                        isPremium: false
                    },
                    {
                        icon: '👑',
                        title: 'Premium ile Tam Kontrol',
                        desc: 'Sınırsız taksit, reklam yok, özel ikonlar ve Fingo Brain AI desteği.',
                        color: 'from-fuchsia-600 to-purple-600', // Premium Color
                        isPremium: true
                    }
                ];

                let currentStep = 0;
                const track = document.getElementById('ob3-track');
                const titleEl = document.getElementById('ob3-title');
                const descEl = document.getElementById('ob3-desc');
                const iconContainer = document.getElementById('ob3-icon-container');
                const iconSpan = document.getElementById('ob3-icon');
                const dotsContainer = document.getElementById('ob3-dots');
                const nextBtn = document.getElementById('ob3-next-btn');
                const skipBtn = document.getElementById('ob3-skip-btn');

                function renderStep(index) {
                    const s = steps[index];

                    // 1. Update Content
                    titleEl.textContent = s.title;
                    descEl.textContent = s.desc;
                    iconSpan.textContent = s.icon;

                    // 2. Update Icon Style (Squircle Gradient)
                    iconContainer.className = `w-24 h-24 rounded-[28px] bg-gradient-to-br ${s.color} flex items-center justify-center mb-8 ob3-icon-3d transform transition-all duration-500 relative z-10`;
                    iconSpan.className = 'text-5xl filter drop-shadow-md ob3-icon-float';

                    // 3. Update Dots with premium glow style
                    dotsContainer.innerHTML = steps.map((_, i) =>
                        `<div class="ob3-dot ${i === index ? 'active' : ''}"></div>`
                    ).join('');

                    // 4. Button Logic
                    if (s.isPremium) {
                        nextBtn.innerHTML = `<span>Premium'u Gör</span> <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`;
                        nextBtn.className = "ob3-btn-premium ob3-btn-gold w-full py-4 rounded-2xl font-bold text-white flex items-center justify-center gap-2";
                        skipBtn.textContent = "Şimdilik Başla";
                    } else {
                        nextBtn.innerHTML = `<span>Devam Et</span> <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"></path></svg>`;
                        nextBtn.className = "ob3-btn-premium w-full py-4 rounded-2xl font-bold text-white flex items-center justify-center gap-2";
                        skipBtn.textContent = "Geç";
                    }
                }

                // Init
                renderStep(0);

                // Actions
                window.nextStep = function () {
                    if (currentStep < steps.length - 1) {
                        currentStep++;
                        renderStep(currentStep);
                    } else {
                        // Last Step (Premium Upsell)
                        finishOnboarding(true);
                    }
                };

                window.finishOnboarding = function (openPremium = false) {
                    overlay.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                        localStorage.setItem('fingo_intro_seen', 'true');

                        if (openPremium) {
                            const pModal = document.getElementById('premium-modal');
                            if (pModal) pModal.classList.remove('hidden');
                        }
                    }, 500);
                };

                // Bind Clicks (Global wrappers to avoid scope issues in inline HTML)
                nextBtn.onclick = window.nextStep;
                skipBtn.onclick = () => window.finishOnboarding(false);
            };
            // ═══════════════════════════════════════════════════════════════
            // GLOBAL MARKET HELPERS
            // ═══════════════════════════════════════════════════════════════

            // ═══════════════════════════════════════════════════════════════
            // GLOBAL MARKET HELPERS
            // ═══════════════════════════════════════════════════════════════

            // GLOBAL MONEY FORMATTER
            window.formatMoneyTRY = function (value, { compact = false, decimals = 2 } = {}) {
                if (value === null || value === undefined || isNaN(value)) return '0,00';

                try {
                    return new Intl.NumberFormat('tr-TR', {
                        style: 'decimal',
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals,
                        notation: compact ? 'compact' : 'standard'
                    }).format(value);
                } catch (e) {
                    return String(value);
                }
            };

            // GLOBAL MONEY RENDERER (HTML)
            window.renderMoney = function (value, { compact = false, decimals = 2 } = {}) {
                const formatted = window.formatMoneyTRY(value, { compact, decimals });
                return `<span class="amount">${formatted}</span><span class="currency">₺</span>`;
            };

            // Backwards compatibility / Alias if needed
            window.formatTRY = function (val) { return window.formatMoneyTRY(val); };

            // Helper: Parse Money (TR + EN) robust
            window.parseMarketVal = (v) => {
                if (v === null || v === undefined) return 0;
                let s = String(v).trim();
                s = s.replace(/[^\d.,-]/g, ''); // Temizlik
                if (!s) return 0;

                const hasComma = s.includes(',');
                const dotCount = (s.match(/\./g) || []).length;

                if (hasComma) {
                    // TR: 1.234,56
                    s = s.replace(/\./g, '').replace(',', '.');
                } else {
                    // EN: 1,234.56 or 1234.56 or 1234
                    if (dotCount > 1 || /^\d{1,3}(\.\d{3})+$/.test(s)) {
                        s = s.replace(/\./g, '');
                    }
                }

                const n = parseFloat(s);
                if (!Number.isFinite(n)) return 0;

                // Güvenlik: aşırı büyük değer kontrolü
                if (n > 50000) {
                    const alt = parseFloat(String(v).replace(/,/g, ''));
                    if (Number.isFinite(alt) && alt < 50000) return alt;
                }
                return n;
            };

            window.prev_market_rates = JSON.parse(localStorage.getItem('prev_market_rates') || '{}');

            window.computeDeltaPercent = (key, currentVal) => {
                if (!currentVal || currentVal <= 0) return null;

                const prev = window.prev_market_rates[key];

                // Yeni değeri kaydet
                window.prev_market_rates[key] = currentVal;
                localStorage.setItem('prev_market_rates', JSON.stringify(window.prev_market_rates));

                if (!prev || prev <= 0) return null; // Önceki yoksa değişim hesaplanamaz

                const diff = currentVal - prev;
                const percent = (diff / prev) * 100;
                return percent;
            };

            window.updateRateUI = (elementId, changeInput) => {
                const el = document.getElementById(elementId);
                if (!el) return;

                let val = 0;
                let isValid = false;

                if (changeInput === null || changeInput === undefined || changeInput === "") {
                    isValid = false;
                } else if (typeof changeInput === 'number') {
                    val = changeInput;
                    isValid = true;
                } else {
                    val = window.parseMarketVal(changeInput);
                    isValid = true;
                }

                // Fallback: eğer değer 0 ise ve string boşsa -> isValid false
                if (changeInput === "" && val === 0) isValid = false;

                if (!isValid) {
                    el.className = "rate-change-badge na";
                    el.innerHTML = "—";
                    return;
                }

                const isPos = val > 0;
                const isNeg = val < 0;
                const isFlat = val === 0;

                if (isPos) {
                    el.className = "rate-change-badge up";
                    el.innerHTML = `▲ %${Math.abs(val).toFixed(2)}`;
                } else if (isNeg) {
                    el.className = "rate-change-badge down";
                    el.innerHTML = `▼ %${Math.abs(val).toFixed(2)}`;
                } else {
                    el.className = "rate-change-badge flat";
                    el.innerHTML = `▬ %0.00`;
                }
            };

            // --- PİYASA VERİLERİ (API) & DÖVİZ ---
            window.fetchMarketData = async function () {
                marketDataLoaded = true;
                const btn = document.getElementById('refresh-market-btn');
                if (btn) btn.classList.add('animate-spin');

                // Skeleton Loading
                const stockContainer = document.getElementById('stock-list-container');
                if (stockContainer && stockContainer.children.length === 0) {
                    stockContainer.innerHTML = Array(6).fill(0).map(() => `
                    <div class="bg-white/50 dark:bg-gray-800/50 p-2.5 rounded-xl flex items-center justify-between animate-pulse">
                        <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-1/3"></div>
                        <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-1/4"></div>
                    </div>
                `).join('');
                }

                const fmt = (val) => window.renderMoney(parseFloat(val));

                const myApiKey = "apikey 6mI4Lm64CgIRb1718GWOF2:45iWRdsxagjzfC0l9TF29r";

                // ═══════════════════════════════════════════════════════════════
                // HELPERS (Scope'u geniş tutuyoruz ki catch'te de erişelim)
                // ═══════════════════════════════════════════════════════════════

                // Helper: Parse Money (TR + EN) robust
                const parseVal = window.parseMarketVal;

                // Eski setRateNA ve updateRateUI kaldırıldı -> window.updateRateUI kullanılıyor.
                const updateRateUI = window.updateRateUI; // Alias for convenience

                // Helper: Fetch with timeout

                // Helper: Fetch with timeout
                const fetchWithTimeout = async (url, options = {}, ms = 4500) => {
                    const controller = new AbortController();
                    const t = setTimeout(() => controller.abort(), ms);
                    try {
                        const res = await fetch(url, { ...options, signal: controller.signal });
                        return res;
                    } finally {
                        clearTimeout(t);
                    }
                };

                // Helper: CollectAPI JSON fetch with error handling
                const fetchCollectJson = async (url) => {
                    const res = await fetchWithTimeout(url, {
                        method: "GET",
                        headers: {
                            "content-type": "application/json",
                            "authorization": myApiKey
                        }
                    }, 4500);

                    if (!res.ok) throw new Error("CollectAPI HTTP " + res.status);

                    const json = await res.json();
                    if (json && json.success === false) {
                        throw new Error(json.error || "CollectAPI success:false");
                    }
                    return json;
                };

                // Helper: Normalize string
                const norm = (s) => String(s || "").toLowerCase().replace(/\s+/g, " ").trim();

                // Helper: Pick first valid number from object by keys
                const pickNumber = (obj, keys) => {
                    for (const k of keys) {
                        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return parseVal(obj[k]);
                    }
                    return 0;
                };

                // Helper: Pick first valid string from object by keys
                const pickString = (obj, keys) => {
                    for (const k of keys) {
                        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return String(obj[k]);
                    }
                    return "";
                };

                // Helper: Find currency in array
                const findCurrency = (arr, wanted) => {
                    const w = wanted.toUpperCase();
                    return (arr || []).find(x =>
                        norm(x.code) === norm(w) ||
                        norm(x.symbol) === norm(w) ||
                        norm(x.name).includes(norm(wanted)) ||
                        (w === "USD" && norm(x.name).includes("dolar")) ||
                        (w === "EUR" && norm(x.name).includes("euro"))
                    );
                };

                // Helper: Find gold in array
                const findGold = (arr, type) => {
                    if (type === "GRAM") return (arr || []).find(x => norm(x.name).includes("gram") && norm(x.name).includes("alt"));
                    if (type === "QUARTER") return (arr || []).find(x => norm(x.name).includes("çeyrek") || norm(x.name).includes("ceyrek"));
                    return null;
                };

                try {
                    // --- A. DÖVİZ VERİLERİ (Genelpara) ---
                    const symbolList = ['USD', 'EUR', 'GA', 'C'].join(',');
                    const params = new URLSearchParams({
                        list: 'doviz,altin',
                        sembol: symbolList
                    });

                    try {
                        const dovizResponse = await fetch(`https://api.genelpara.com/json/?${params}`, { cache: "no-store" });
                        if (!dovizResponse.ok) throw new Error("Genelpara HTTP " + dovizResponse.status);
                        const dovizResult = await dovizResponse.json();
                        if (!dovizResult || !dovizResult.success || !dovizResult.data) throw new Error("Genelpara veri eksik/boş");

                        const d = dovizResult.data;
                        if (!d.USD || !d.EUR) throw new Error("Genelpara USD/EUR eksik");

                        const elUsd = document.getElementById('val-usd');
                        if (elUsd) elUsd.innerHTML = fmt(parseVal(d.USD.satis));
                        updateRateUI('rate-usd-change', d.USD.degisim);

                        const elEur = document.getElementById('val-eur');
                        if (elEur) elEur.innerHTML = fmt(parseVal(d.EUR.satis));
                        updateRateUI('rate-eur-change', d.EUR.degisim);

                        const elGram = document.getElementById('val-gold-gram');
                        if (elGram && d.GA) elGram.innerHTML = fmt(parseVal(d.GA.satis));
                        if (d.GA) updateRateUI('rate-gram-change', d.GA.degisim);

                        const elQuarter = document.getElementById('val-gold-quarter');
                        if (elQuarter && d.C) elQuarter.innerHTML = fmt(parseVal(d.C.satis));
                        if (d.C) updateRateUI('rate-quarter-change', d.C.degisim);

                        // Global değişkenleri güncelle
                        liveRates.USD = parseVal(d.USD.satis);
                        liveRates.EUR = parseVal(d.EUR.satis);
                        if (d.GA) liveRates.GRAM = parseVal(d.GA.satis);
                        if (d.C) liveRates.QUARTER = parseVal(d.C.satis);

                        // Kurlar geldi, ekranı ve birikimleri yenile
                        if (window.transactions) {
                            window.processTransactions(window.transactions);
                        }
                        if (window.refreshGoalComputedValues) {
                            window.refreshGoalComputedValues();
                        }

                    } catch (dovizErr) {
                        console.warn("Döviz verisi alınamadı (Genelpara):", dovizErr);

                        // ═══════════════════════════════════════════════════════════════
                        // COLLECT API FALLBACK
                        // ═══════════════════════════════════════════════════════════════
                        try {
                            let usd = null, eur = null;

                            // 1) USD/EUR - önce allCurrency, olmadı singleCurrency
                            try {
                                const cur = await fetchCollectJson("https://api.collectapi.com/economy/allCurrency");
                                const list = cur.result || cur.data || [];
                                usd = findCurrency(list, "USD");
                                eur = findCurrency(list, "EUR");
                            } catch (e1) {
                                try {
                                    const u = await fetchCollectJson("https://api.collectapi.com/economy/singleCurrency?tag=USD");
                                    const e = await fetchCollectJson("https://api.collectapi.com/economy/singleCurrency?tag=EUR");
                                    usd = (u.result && (Array.isArray(u.result) ? u.result[0] : u.result)) || null;
                                    eur = (e.result && (Array.isArray(e.result) ? e.result[0] : e.result)) || null;
                                } catch (e2) {
                                    console.warn("CollectAPI currency fallback failed:", e2);
                                }
                            }

                            // 2) GOLD
                            let gram = null, quarter = null;
                            try {
                                const g = await fetchCollectJson("https://api.collectapi.com/economy/goldPrice");
                                const glist = g.result || g.data || [];
                                gram = findGold(glist, "GRAM");
                                quarter = findGold(glist, "QUARTER");
                            } catch (eg) {
                                console.warn("CollectAPI goldPrice failed:", eg);
                            }

                            // 3) UI + liveRates güncelle
                            const setVal = (id, value) => {
                                const el = document.getElementById(id);
                                if (el && value > 0) el.innerHTML = fmt(value);
                            };

                            if (usd) {
                                const usdSell = pickNumber(usd, ["selling", "satis", "rate", "value"]);
                                setVal("val-usd", usdSell);
                                liveRates.USD = usdSell;
                                const ch = pickString(usd, ["change", "degisim", "diff", "rateChange"]);
                                if (ch) updateRateUI("rate-usd-change", ch);
                                else updateRateUI("rate-usd-change", window.computeDeltaPercent("USD", usdSell));
                            }

                            if (eur) {
                                const eurSell = pickNumber(eur, ["selling", "satis", "rate", "value"]);
                                setVal("val-eur", eurSell);
                                liveRates.EUR = eurSell;
                                const ch = pickString(eur, ["change", "degisim", "diff", "rateChange"]);
                                if (ch) updateRateUI("rate-eur-change", ch);
                                else updateRateUI("rate-eur-change", window.computeDeltaPercent("EUR", eurSell));
                            }

                            if (gram) {
                                const gramSell = pickNumber(gram, ["selling", "satis", "price", "value"]);
                                setVal("val-gold-gram", gramSell);
                                liveRates.GRAM = gramSell;
                                const ch = pickString(gram, ["change", "degisim", "diff", "rateChange"]);
                                if (ch) updateRateUI("rate-gram-change", ch);
                                else updateRateUI("rate-gram-change", window.computeDeltaPercent("GRAM", gramSell));
                            }

                            if (quarter) {
                                const qSell = pickNumber(quarter, ["selling", "satis", "price", "value"]);
                                setVal("val-gold-quarter", qSell);
                                liveRates.QUARTER = qSell;
                                const ch = pickString(quarter, ["change", "degisim", "diff", "rateChange"]);
                                if (ch) updateRateUI("rate-quarter-change", ch);
                                else updateRateUI("rate-quarter-change", window.computeDeltaPercent("QUARTER", qSell));
                            }

                            // 4) Mevcut tetikleyiciler
                            if (window.convertCurrency) window.convertCurrency();
                            if (window.calculateCashFlow) window.calculateCashFlow();
                            if (window.processTransactions && window.transactions) window.processTransactions(window.transactions);
                            if (window.refreshGoalComputedValues) window.refreshGoalComputedValues();

                        } catch (fallbackErr) {
                            console.warn("CollectAPI fallback tamamen başarısız:", fallbackErr);
                        }
                    }


                    // --- B. BORSA HİSSELERİ ---
                    const stockResponse = await fetch("https://api.collectapi.com/economy/hisseSenedi", {
                        method: "GET",
                        headers: {
                            "content-type": "application/json",
                            "authorization": myApiKey
                        }
                    });

                    const stockResult = await stockResponse.json();

                    if (stockResult.success && stockResult.result) {
                        if (stockContainer) {
                            stockContainer.innerHTML = '';
                            const popularStocks = [
                                'THYAO', 'GARAN', 'ASELS', 'EREGL', 'AKBNK', 'ISCTR',
                                'YKBNK', 'KCHOL', 'SASA', 'SISE', 'TUPRS', 'BIMAS',
                                'PETKM', 'HALKB', 'EKGYO', 'VAKBN', 'ARCLK', 'TOASO',
                                'FROTO', 'PGSUS', 'KOZAL', 'KRDMD', 'HEKTS', 'ENJSA',
                                'ASTOR', 'ODAS', 'KONTR', 'GUBRF', 'VESTL', 'SOKM',
                                'TCELL', 'MIGROS', 'ULKER', 'ALARK', 'ENKAI', 'TTKOM',
                                'AEFES', 'DOHOL', 'MGROS', 'TKFEN', 'ISMEN', 'DOAS',
                                'AKSEN', 'MAVI', 'CIMSA', 'GWIND', 'ALBRK', 'SKBNK',
                                'TSKB', 'OTKAR', 'TTRAK', 'BRISA', 'FKEN'
                            ];

                            stockResult.result.forEach(stock => {
                                if (popularStocks.includes(stock.code)) {
                                    const price = stock.lastprice;
                                    const change = parseFloat(stock.rate);
                                    const symbol = stock.code;
                                    const isPositive = change >= 0;
                                    const colorClass = isPositive ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400';
                                    const bgClass = isPositive ? 'bg-emerald-100/50 dark:bg-emerald-900/30' : 'bg-rose-100/50 dark:bg-rose-900/30';
                                    const shadowClass = isPositive ? 'shadow-emerald-500/10' : 'shadow-rose-500/10';
                                    const arrow = isPositive ? '▲' : '▼';

                                    // bistStocks'a hisseyi ekle veya güncelle (ilk sistem için)
                                    const existingStockIdx = bistStocks.findIndex(s => s.symbol === symbol);
                                    if (existingStockIdx >= 0) {
                                        bistStocks[existingStockIdx].name = stock.text || symbol;
                                        bistStocks[existingStockIdx].price = parseFloat(price);
                                        bistStocks[existingStockIdx].change = change;
                                    } else {
                                        bistStocks.push({ symbol: symbol, name: stock.text || symbol, price: parseFloat(price), change: change });
                                    }

                                    stockContainer.insertAdjacentHTML('beforeend', `
                                    <div onclick="window.openStockDetailModal('${symbol}')" class="cursor-pointer group relative overflow-hidden glass-card rounded-2xl p-3 flex flex-col justify-between w-full border border-white/40 dark:border-white/10 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl ${shadowClass}">
                                        <div class="absolute bottom-0 left-0 w-full h-1 ${isPositive ? 'bg-emerald-500' : 'bg-rose-500'} opacity-60"></div>
                                        <div class="flex items-center justify-between w-full mb-2">
                                            <span class="text-xs font-black text-gray-700 dark:text-gray-200 tracking-wider">${symbol}</span>
                                            <div class="flex items-center px-2 py-1 rounded-lg ${bgClass} backdrop-blur-md">
                                                <span class="text-[9px] font-bold ${colorClass} flex items-center gap-1">
                                                    ${arrow} %${Math.abs(change).toFixed(2)}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-end justify-between">
                                            <div>
                                                <p class="text-[9px] text-gray-400 font-medium mb-0.5">Son Fiyat</p>
                                                <p class="text-lg font-black text-gray-900 dark:text-white tracking-tight leading-none flex items-center gap-1">${fmt(price)}</p>
                                            </div>
                                            <div class="text-2xl opacity-10 grayscale group-hover:grayscale-0 group-hover:opacity-20 transition-all duration-500 transform group-hover:scale-110">
                                                ${isPositive ? '📈' : '📉'}
                                            </div>
                                        </div>
                                    </div>
                                `);
                                }
                            });
                        }
                    }

                } catch (error) {
                    console.error("Veri çekme hatası:", error);
                } finally {
                    if (btn) btn.classList.remove('animate-spin');
                    const timeEl = document.querySelector('.market-time');
                    if (timeEl) timeEl.textContent = new Date().toLocaleTimeString('tr-TR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            };

            // --- STOCK DETAIL MODAL LOGIC (Premium Chart.js Version) ---
            let stockChartInstance = null;
            let currentStockSymbol = null;
            let currentStockData = { price: 0, change: 0 };
            let selectedPeriod = '1D';

            // Premium Stock Chart Styles
            const stockChartStyles = document.createElement('style');
            stockChartStyles.textContent = `
            .stock-chart-container {
                background: linear-gradient(180deg, #0f111a 0%, #131722 100%);
            }
            
            .stock-period-btn {
                padding: 6px 12px;
                font-size: 11px;
                font-weight: 700;
                color: #6b7280;
                background: transparent;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .stock-period-btn:hover {
                color: #9ca3af;
                background: white/5;
            }
            
            .stock-period-btn.active {
                color: white;
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }
            
            .stock-stat-card {
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            
            .stock-stat-label {
                font-size: 9px;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .stock-stat-value {
                font-size: 12px;
                font-weight: 800;
                color: white;
            }
            
            /* Light mode overrides */
            html:not(.dark) .stock-chart-container {
                background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            }
            
            html:not(.dark) .stock-period-btn {
                color: #64748b;
            }
            
            html:not(.dark) .stock-period-btn:hover {
                color: #334155;
            }
            
            html:not(.dark) .stock-stat-card {
                background: rgba(0, 0, 0, 0.02);
                border-color: rgba(0, 0, 0, 0.05);
            }
            
            html:not(.dark) .stock-stat-value {
                color: #1e293b;
            }
        `;
            document.head.appendChild(stockChartStyles);

            // NOTE: Aşağıdaki fonksiyon devre dışı bırakıldı. Birinci sistem (satır ~21816) kullanılıyor.
            // Bu ikinci tanımlama birincisini eziyordu ve grafik çakışmasına neden oluyordu.
            /*
            window.fetchHistoricalData = async function (symbol, period = '1G', price, change) {
                const symbolIS = symbol.includes('.') ? symbol : symbol + '.IS';
                let interval = '15m'; // Default for 1D
                let range = '1d';
    
                switch (period) {
                    case '1G': range = '1d'; interval = '5m'; break;
                    case '1H': range = '5d'; interval = '30m'; break;
                    case '1A': range = '1mo'; interval = '1d'; break;
                    case '3A': range = '3mo'; interval = '1d'; break;
                    case '1Y': range = '1y'; interval = '1wk'; break;
                    default: range = '1d'; interval = '15m';
                }
    
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbolIS}?range=${range}&interval=${interval}&includePrePost=false&events=div%2Csplit`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Proxy error');
                    const proxyData = await response.json();
                    const result = JSON.parse(proxyData.contents).chart.result[0];
    
                    const timestamps = result.timestamp;
                    const prices = result.indicators.quote[0].close;
                    const meta = result.meta;
    
                    // Stats calculation
                    const data = [];
                    const labels = [];
    
                    prices.forEach((price, i) => {
                        if (price !== null) {
                            data.push(price);
                            const date = new Date(timestamps[i] * 1000);
                            if (period === '1G') {
                                labels.push(date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }));
                            } else {
                                labels.push(date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' }));
                            }
                        }
                    });
    
                    return {
                        data: data,
                        labels: labels,
                        meta: {
                            high: meta.regularMarketDayHigh || Math.max(...data),
                            low: meta.regularMarketDayLow || Math.min(...data),
                            open: meta.regularMarketDayOpen || data[0],
                            volume: meta.regularMarketVolume || 0
                        }
                    };
                } catch (error) {
                    console.error('Data fetch error:', error);
                    const fallback = generateStockData(currentStockData.price, currentStockData.change, period);
                    return { ...fallback, meta: null };
                }
            };
            */

            // NOTE: Aşağıdaki fonksiyonlar devre dışı bırakıldı.
            // Birinci sistem (satır ~22089 ve ~22071) kullanılıyor.
            // Bu ikinci tanımlamalar birincisini eziyordu ve grafik çakışmasına neden oluyordu.
            /*
            function generateStockData(basePrice, change, period) {
                const data = [];
                const labels = [];
                const points = 20;
                const end = parseFloat(basePrice);
                const start = end / (1 + parseFloat(change) / 100);
                const step = (end - start) / points;
                for (let i = 0; i < points; i++) {
                    data.push(start + (step * i) + (Math.random() - 0.5) * (end * 0.01));
                    labels.push("");
                }
                data.push(end);
                labels.push("");
                return { data, labels };
            }
    
            // Render the stock chart
            async function renderStockChart(symbol, price, change, period = '1G') {
                // ... Chart.js implementation (devre dışı)
            }
    
            // Change period
            window.changeStockPeriod = function (period) {
                // ... (devre dışı)
            };
    
            window.openStockDetail = function (symbol, name, price, change) {
                // ... (devre dışı)
            };
    
            window.closeStockDetailModal = function () {
                // ... (devre dışı - birinci tanımlama satır ~22062'de)
            };
            */

            // GÜNCELLENMİŞ BAŞLATMA FONKSİYONU
            // Onboarding'i hızlı ama güvenli şekilde aç (ilk paint sonrası)
            window.scheduleOnboarding = function () {
                try {
                    // startOnboarding zaten kendi içinde flag kontrolü yapıyor ama burada da ekstra güvenlik:
                    if (localStorage.getItem('intro_shown_v3') === 'true') return;

                    const run = () => {
                        try { window.startOnboarding?.(); } catch (e) { /* sessiz */ }
                    };

                    // 1) İlk render/paint sonrası aç: iki kez RAF = daha stabil (özellikle mobil webview)
                    requestAnimationFrame(() => requestAnimationFrame(run));

                    // 2) Fallback: RAF çalışmazsa ya da UI bloklanırsa kısa süre sonra zorla dene
                    setTimeout(run, 120);

                } catch (e) { /* sessiz */ }
            };

            // GÜNCELLENMİŞ BAŞLATMA FONKSİYONU (Native & Async)
            window.initApp = async function () {
                window.initTheme();
                window.cycleLoadingMessages();

                const loadingBar = document.getElementById('loading-bar');
                setTimeout(() => { if (loadingBar) loadingBar.style.width = '30%'; }, 100);

                // Uygulamayı başlat
                await window.startLocalMode();

                // Native Storage Extras (Wrapper Logic Integrated)
                if (window.loadPrivacyState) window.loadPrivacyState();
                if (window.PinManager && window.PinManager.init) window.PinManager.init();

                // Onboarding'i geciktirme: ilk paint sonrası hızlı aç
                window.scheduleOnboarding();

                // Boot sırasında: profil modal her koşulda kapalı başlasın
                try { window.toggleProfileModal?.(false); } catch (e) { }
            };
            // --- OTOMATİK TALİMAT YÖNETİCİSİ ---
            window.openRecurringManager = function () {
                const modal = document.getElementById('recurring-manager-modal');
                const listEl = document.getElementById('recurring-list');
                if (!modal || !listEl) return;

                // Listeyi Çek
                let rules = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');

                if (rules.length === 0) {
                    listEl.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-center opacity-60">
                <div class="text-4xl mb-2">🍃</div>
                <p class="text-sm font-bold text-gray-500">Henüz aktif abonelik yok</p>
                <p class="text-[10px] text-gray-400">İşlem eklerken "Her ay tekrarla"yı seç.</p>
            </div>
        `;
                } else {
                    listEl.innerHTML = '';
                    rules.forEach(rule => {
                        const icon = window.getSmartIcon(rule.category, rule.description);
                        const amt = parseFloat(rule.amount).toLocaleString('tr-TR', { minimumFractionDigits: 2 });

                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between p-3 mb-2 bg-white/50 dark:bg-white/5 border border-indigo-100 dark:border-white/10 rounded-2xl';
                        item.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-xl shadow-sm">
                        ${icon}
                    </div>
                    <div>
                        <h4 class="text-sm font-bold dark:text-gray-200">${rule.description || rule.category}</h4>
                        <div class="flex items-center gap-2">
                           <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400">${amt} ₺</span>
                           <span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-700 text-gray-500 font-bold">Her Ayın ${rule.day}. Günü</span>
                        </div>
                    </div>
                </div>
                <button onclick="window.deleteRecurringRule('${rule.id}')" class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center hover:bg-red-200 transition">
                    🗑️
                </button>
            `;
                        listEl.appendChild(item);
                    });
                }

                modal.classList.remove('hidden');
            };

            // --- SESLİ KOMUT İLE İŞLEM EKLEME ---
            window.currentRecognition = null;

            window.startVoiceInput = function () {
                const btn = document.getElementById('btn-voice-input');
                const btnText = document.getElementById('btn-voice-text');

                // Toggle Durdurma Mantığı
                if (window.currentRecognition) {
                    window.currentRecognition.abort();
                    window.currentRecognition = null;
                    if (btnText) btnText.innerText = "Sesle Ekle";
                    if (btn) btn.classList.remove('animate-pulse', 'ring-2', 'ring-red-500', 'bg-red-50', 'text-red-500');
                    return;
                }

                if (!('webkitSpeechRecognition' in window)) {
                    window.alertMessage("Hata", "Tarayıcınız desteklemiyor.", "red");
                    return;
                }

                const recognition = new webkitSpeechRecognition();
                window.currentRecognition = recognition;
                recognition.lang = 'tr-TR';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = function () {
                    if (btn) btn.classList.add('animate-pulse', 'ring-2', 'ring-red-500', 'bg-red-50', 'text-red-500');
                    if (btnText) btnText.innerText = "Dinliyor...";
                };

                recognition.onend = function () {
                    window.currentRecognition = null;
                    if (btn) btn.classList.remove('animate-pulse', 'ring-2', 'ring-red-500', 'bg-red-50', 'text-red-500');
                    if (btnText) btnText.innerText = "Sesle Ekle";
                };

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    console.log("Algılanan:", transcript);

                    // 1. Tutar Bulma
                    const amountMatch = transcript.match(/(\d+([\.,]\d+)?)\s*(tl|lira|try)?/i);

                    // 2. Kategori Bulma
                    let category = "";
                    const lowerText = transcript.toLowerCase();
                    const keywords = {
                        'Market': ['market', 'bakkal', 'süpermarket', 'gıda', 'bim', 'a101', 'şok', 'migros'],
                        'Ulaşım': ['benzin', 'mazot', 'otobüs', 'taksi', 'dolmuş', 'bilet'],
                        'Yemek': ['yemek', 'restoran', 'kafe', 'kahve', 'simit', 'döner', 'burger'],
                        'Fatura': ['fatura', 'elektrik', 'su', 'doğalgaz', 'internet', 'telefon'],
                        'Giyim': ['kıyafet', 'tişört', 'pantolon', 'ayakkabı', 'mont'],
                        'Eğlence': ['sinema', 'oyun', 'netflix', 'spotify', 'konser'],
                        'Sağlık': ['eczane', 'ilaç', 'doktor', 'hastane'],
                        'Eğitim': ['kitap', 'defter', 'okul', 'kurs']
                    };

                    for (const [cat, keys] of Object.entries(keywords)) {
                        if (keys.some(k => lowerText.includes(k))) {
                            category = cat;
                            break;
                        }
                    }

                    // 3. Formu Doldur (Formatlı)
                    if (amountMatch) {
                        let rawVal = amountMatch[1];
                        // Sadece nokta varsa (10.50) virgül yap, sadece virgülse kalsın.
                        // Amaç: Sistemin 10,50 (on buçuk) olarak algılaması.
                        rawVal = rawVal.replace('.', ',');

                        const amountEl = document.getElementById('input-amount');
                        if (amountEl) {
                            amountEl.value = rawVal;
                            // Binlik ayırıcıları eklemesi için format fonksiyonunu çağır
                            if (window.formatAmount) window.formatAmount(amountEl);
                            if (window.updateCurrencyPreview) window.updateCurrencyPreview();
                        }
                    }

                    if (category) {
                        const catSelect = document.getElementById('input-category');
                        for (let i = 0; i < catSelect.options.length; i++) {
                            if (catSelect.options[i].value.includes(category)) {
                                catSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    // Açıklama
                    const desc = transcript.charAt(0).toUpperCase() + transcript.slice(1);
                    document.getElementById('input-desc').value = desc;

                    window.alertMessage("Anlaşıldı", `"${desc}"`, "purple");
                    if (navigator.vibrate) navigator.vibrate(50);
                };

                recognition.start();
            };

            // --- GÜVENLİ & TASARIM PIN YÖNETİCİSİ ---
            // --- GÜVENLİ & TASARIM PIN YÖNETİCİSİ (Native Async) ---
            window.PinManager = {
                currentInput: "", mode: "unlock", tempPin: "",
                async init() {
                    const savedPin = await AppStorage.get('app_pin');
                    const btnLbl = document.getElementById('lbl-pin-settings');
                    if (btnLbl) btnLbl.innerText = savedPin ? "PIN Kodunu Kaldır" : "PIN Oluştur";

                    const verified = sessionStorage.getItem('pin_verified');
                    if (savedPin && !verified) { this.showLockScreen("unlock"); }

                    document.addEventListener("visibilitychange", async () => {
                        if (document.visibilityState === "visible") {
                            const pin = await AppStorage.get('app_pin');
                            if (pin) this.showLockScreen("unlock");
                        }
                    });
                },
                showLockScreen(mode) {
                    this.mode = mode; this.currentInput = ""; this.updateDots();
                    const screen = document.getElementById('pin-lock-screen');
                    screen.classList.remove('hidden'); screen.classList.remove('fade-out');

                    const title = document.getElementById('pin-title');
                    const sub = document.getElementById('pin-subtitle');
                    const cancelBtn = document.getElementById('btn-pin-cancel');

                    if (cancelBtn) cancelBtn.classList.toggle('hidden', mode === 'unlock');

                    if (title) {
                        if (mode === 'unlock') { title.innerText = "Giriş Yapın"; if (sub) sub.innerText = "Devam etmek için PIN girin"; }
                        else if (mode === 'create') { title.innerText = "PIN Oluştur"; if (sub) sub.innerText = "4 haneli yeni şifrenizi belirleyin"; }
                        else if (mode === 'confirm') { title.innerText = "PIN Doğrula"; if (sub) sub.innerText = "Şifrenizi tekrar girin"; }
                    }
                },
                cancelSetup() {
                    document.getElementById('pin-lock-screen').classList.add('hidden');
                    this.currentInput = "";
                },
                press(num) {
                    if (this.currentInput.length < 4) {
                        this.currentInput += num; this.updateDots();
                        if (navigator.vibrate) navigator.vibrate(15);
                        if (this.currentInput.length === 4) setTimeout(() => this.check(), 100);
                    }
                },
                clear() { this.currentInput = this.currentInput.slice(0, -1); this.updateDots(); },
                updateDots() {
                    const dots = document.querySelectorAll('.pin-dot');
                    dots.forEach((dot, idx) => {
                        dot.className = idx < this.currentInput.length ? "pin-dot w-4 h-4 rounded-full bg-indigo-600 scale-110 shadow-md transition-all" : "pin-dot w-4 h-4 rounded-full bg-gray-300 dark:bg-gray-600 scale-90 transition-all";
                    });
                },
                async check() {
                    const savedPin = await AppStorage.get('app_pin');
                    if (this.mode === 'unlock') {
                        if (this.currentInput === savedPin) this.unlock(); else this.error();
                    } else if (this.mode === 'create') {
                        this.tempPin = this.currentInput; this.showLockScreen('confirm');
                    } else if (this.mode === 'confirm') {
                        if (this.currentInput === this.tempPin) {
                            await AppStorage.set('app_pin', this.tempPin);
                            this.unlock();
                            window.alertMessage("Güvenlik", "PIN kilidi oluşturuldu! 🔒", "green");
                            document.getElementById('lbl-pin-settings').innerText = "PIN Kodunu Kaldır";
                        } else {
                            window.alertMessage("Hata", "Şifreler uyuşmuyor! Tekrar deneyin.", "red"); this.showLockScreen('create');
                        }
                    }
                },
                unlock() {
                    const screen = document.getElementById('pin-lock-screen');
                    screen.classList.add('fade-out');
                    setTimeout(() => screen.classList.add('hidden'), 300);
                    this.currentInput = "";
                    sessionStorage.setItem('pin_verified', 'true');
                },
                error() {
                    const dots = document.getElementById('pin-dots-container');
                    if (dots) { dots.classList.add('animate-shake'); setTimeout(() => dots.classList.remove('animate-shake'), 400); }
                    if (navigator.vibrate) navigator.vibrate(200);
                    this.currentInput = ""; setTimeout(() => this.updateDots(), 400);
                },
                async startSetup() {
                    window.toggleProfileModal(false);
                    const savedPin = await AppStorage.get('app_pin');
                    if (savedPin) {
                        const confirmed = await window.confirmDialog({
                            title: "PIN Kaldır",
                            message: "PIN kodunu kaldırmak istediğinize emin misiniz? Verileriniz korunacaktır.",
                            confirmText: "Kaldır",
                            cancelText: "Vazgeç",
                            variant: "warning"
                        });
                        if (confirmed) {
                            await AppStorage.remove('app_pin');
                            document.getElementById('lbl-pin-settings').innerText = "PIN Oluştur";
                            window.alertMessage("Bilgi", "Güvenlik kilidi kaldırıldı.", "blue");
                        }
                    } else {
                        this.showLockScreen('create');
                    }
                },
                async forgot() {
                    const confirmed = await window.confirmDialog({
                        title: "Şifre Sıfırlama",
                        message: "DİKKAT: Şifrenizi unuttuysanız, güvenlik nedeniyle TÜM VERİLERİNİZ SIFIRLANACAKTIR. Onaylıyor musunuz?",
                        confirmText: "Sıfırla",
                        cancelText: "Vazgeç",
                        variant: "red"
                    });
                    if (confirmed) {
                        window.requestResetApp();
                    }
                }
            };

            // ═══════════════════════════════════════════════════════════════════════════════════
            // FEATURE MODULE 1: BIOMETRIC BRIDGE (FaceID/TouchID + PIN Fallback)
            // ═══════════════════════════════════════════════════════════════════════════════════
            window.BiometricBridge = {
                isAvailable: false,
                async init() {
                    try {
                        // Check for Capacitor native biometric plugin
                        if (window.Capacitor?.Plugins?.NativeBiometric) {
                            const result = await window.Capacitor.Plugins.NativeBiometric.isAvailable();
                            this.isAvailable = result?.isAvailable ?? false;
                        } else if (window.Capacitor?.Plugins?.BiometricAuth) {
                            this.isAvailable = true;
                        }
                        // Update UI if biometric available
                        this.updateUI();
                    } catch (e) {
                        console.warn('BiometricBridge init error:', e);
                        this.isAvailable = false;
                    }
                },
                updateUI() {
                    const bioBtn = document.getElementById('btn-biometric-unlock');
                    const bioToggleRow = document.getElementById('bio-toggle-row');
                    const bioToggle = document.getElementById('bio-enabled-toggle');
                    const bioLabel = document.getElementById('lbl-biometric-status');

                    // Show/hide biometric button on PIN screen
                    if (bioBtn) {
                        const bioEnabled = localStorage.getItem('bio_enabled') === 'true';
                        bioBtn.classList.toggle('hidden', !this.isAvailable || !bioEnabled);
                    }

                    // Show/hide biometric toggle row in Settings
                    if (bioToggleRow) {
                        bioToggleRow.classList.toggle('hidden', !this.isAvailable);
                        bioToggleRow.classList.toggle('flex', this.isAvailable);
                    }

                    // Set toggle state
                    if (bioToggle) {
                        bioToggle.checked = localStorage.getItem('bio_enabled') === 'true';
                    }

                    // Update label
                    if (bioLabel) {
                        bioLabel.textContent = this.isAvailable ? 'Biyometrik ile hızlı giriş' : 'Biyometrik mevcut değil';
                    }
                },
                async authenticate() {
                    try {
                        if (!this.isAvailable) return false;

                        // Try Capacitor NativeBiometric
                        if (window.Capacitor?.Plugins?.NativeBiometric) {
                            await window.Capacitor.Plugins.NativeBiometric.verifyIdentity({
                                reason: 'Fingenda\'ya giriş yapmak için doğrulayın',
                                title: 'Biyometrik Doğrulama',
                                subtitle: 'Parmak izi veya yüz tanıma'
                            });
                            return true;
                        }
                        return false;
                    } catch (e) {
                        console.warn('Biometric auth failed:', e);
                        return false;
                    }
                },
                async tryBiometricFirst() {
                    // Only try biometric if enabled in settings
                    const bioEnabled = localStorage.getItem('bio_enabled') === 'true';
                    if (this.isAvailable && bioEnabled) {
                        const success = await this.authenticate();
                        if (success) {
                            window.PinManager.unlock();
                            return true;
                        }
                    }
                    // Fall back to PIN
                    return false;
                }
            };

            // Bio enabled toggle handler
            window.toggleBioEnabled = function (enabled) {
                localStorage.setItem('bio_enabled', enabled ? 'true' : 'false');
                window.BiometricBridge?.updateUI();
                window.showMicroFeedback?.({
                    message: enabled ? '🔐 Biyometrik kilit aktif' : '🔒 Biyometrik kilit kapatıldı',
                    type: 'info'
                });
            };

            // PATCH 5.1: Auto-lock after 30s in background
            (function initAutoLock() {
                let backgroundTime = null;
                const AUTO_LOCK_DELAY = 30000; // 30 seconds

                document.addEventListener('visibilitychange', () => {
                    const pinEnabled = localStorage.getItem('pin_enabled') === 'true';
                    if (!pinEnabled) return;

                    if (document.hidden) {
                        // App went to background - record time
                        backgroundTime = Date.now();
                    } else {
                        // App came back - check if we should lock
                        if (backgroundTime && (Date.now() - backgroundTime) >= AUTO_LOCK_DELAY) {
                            localStorage.removeItem('pin_verified');
                            window.showMicroFeedback?.({ message: '🔒 Güvenlik için kilit aktif', type: 'info' });

                            // Show PIN screen
                            const pinScreen = document.getElementById('pin-lock-screen');
                            if (pinScreen) {
                                pinScreen.classList.remove('hidden');
                                // Try biometric first
                                window.BiometricBridge?.tryBiometricFirst?.();
                            }
                        }
                        backgroundTime = null;
                    }
                });
            })();


            // ═══════════════════════════════════════════════════════════════════════════════════
            // FEATURE MODULE 2: OFFLINE MANAGER (Enhanced with Cache + Pending Queue)
            // ═══════════════════════════════════════════════════════════════════════════════════
            window.OfflineManager = {
                isOnline: navigator.onLine,
                lastSyncTs: null,
                pendingQueue: [],
                APP_YEAR: new Date().getFullYear(),

                init() {
                    this.APP_YEAR = window.APP_YEAR || new Date().getFullYear();
                    this.lastSyncTs = localStorage.getItem('last_sync_ts') || null;
                    this.isOnline = navigator.onLine;
                    this.loadPendingQueue();

                    window.addEventListener('online', () => this.handleOnline());
                    window.addEventListener('offline', () => this.handleOffline());

                    this.updateStatusUI();
                },

                handleOnline() {
                    this.isOnline = true;
                    localStorage.setItem('net_status', 'online');
                    this.updateStatusUI();
                    this.showBanner('online');
                    this.syncPendingQueue();
                },

                handleOffline() {
                    this.isOnline = false;
                    localStorage.setItem('net_status', 'offline');
                    this.updateStatusUI();
                    this.showBanner('offline');
                },

                // PATCH: HEDEF-4 - Enhanced sync status UI
                updateStatusUI() {
                    const syncEl = document.getElementById('sync-status-text');
                    const dotEl = document.getElementById('sync-status-dot');

                    if (syncEl && dotEl) {
                        if (!this.isOnline) {
                            // Offline state
                            dotEl.className = 'w-2 h-2 rounded-full bg-red-500';
                            const lastTs = this.lastSyncTs ? new Date(this.lastSyncTs).toLocaleString('tr-TR') : 'N/A';
                            syncEl.textContent = `Offline • Son kayıt: ${lastTs}`;
                        } else if (!this.lastSyncTs) {
                            // Online but never synced
                            dotEl.className = 'w-2 h-2 rounded-full bg-yellow-500';
                            syncEl.textContent = 'Henüz senkronize edilmedi';
                        } else {
                            // Online and synced
                            dotEl.className = 'w-2 h-2 rounded-full bg-green-500';
                            const ts = new Date(this.lastSyncTs).toLocaleString('tr-TR');
                            syncEl.textContent = `Son senkron: ${ts}`;
                        }
                    }
                },

                showBanner(status) {
                    const msg = status === 'online'
                        ? '🌐 Tekrar çevrimiçisiniz'
                        : '📴 Çevrimdışı mod – veriler cihazda kayıt ediliyor';
                    window.showMicroFeedback?.({ message: msg, type: status === 'online' ? 'success' : 'warning' });
                },

                recordSync() {
                    this.lastSyncTs = new Date().toISOString();
                    localStorage.setItem('last_sync_ts', this.lastSyncTs);
                    this.updateStatusUI();
                },

                // Cache management
                cacheData(key, data) {
                    try {
                        localStorage.setItem(`cache_${key}_${this.APP_YEAR}`, JSON.stringify(data));
                        this.recordSync();
                    } catch (e) {
                        console.warn('Cache write failed:', e);
                    }
                },

                getCachedData(key) {
                    try {
                        const cached = localStorage.getItem(`cache_${key}_${this.APP_YEAR}`);
                        return cached ? JSON.parse(cached) : null;
                    } catch (e) {
                        return null;
                    }
                },

                // Pending queue for offline writes
                loadPendingQueue() {
                    try {
                        this.pendingQueue = JSON.parse(localStorage.getItem('pending_queue') || '[]');
                    } catch (e) {
                        this.pendingQueue = [];
                    }
                },

                addToPendingQueue(operation) {
                    this.pendingQueue.push({
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        ts: new Date().toISOString(),
                        ...operation
                    });
                    localStorage.setItem('pending_queue', JSON.stringify(this.pendingQueue));
                },

                async syncPendingQueue() {
                    if (!this.isOnline || this.pendingQueue.length === 0) return;

                    const queue = [...this.pendingQueue];
                    for (const op of queue) {
                        try {
                            // For now, just remove from queue (local-only app)
                            // In future: sync to Firebase/server
                            this.pendingQueue = this.pendingQueue.filter(q => q.id !== op.id);
                        } catch (e) {
                            console.warn('Queue sync failed for:', op.id);
                        }
                    }
                    localStorage.setItem('pending_queue', JSON.stringify(this.pendingQueue));

                    if (queue.length > 0) {
                        this.recordSync();
                        window.showMicroFeedback?.({ message: `✅ ${queue.length} işlem senkronize edildi`, type: 'success' });
                    }
                },

                getPendingCount() {
                    return this.pendingQueue.length;
                }
            };

            // ═══════════════════════════════════════════════════════════════════════════════════
            // FEATURE MODULE 3: EXPORT MANAGER (Enhanced with Standardized Format + Import)
            // ═══════════════════════════════════════════════════════════════════════════════════
            window.ExportManager = {
                APP_VERSION: '2.0.0',

                async exportCSV() {
                    try {
                        const APP_YEAR = window.APP_YEAR || new Date().getFullYear();
                        const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');

                        if (transactions.length === 0) {
                            window.alertMessage('Bilgi', 'Dışa aktarılacak işlem bulunamadı.', 'blue');
                            return;
                        }

                        // CSV header with more fields
                        const headers = ['Tarih', 'Tür', 'Kategori', 'Tutar', 'Açıklama', 'Ödeme Yöntemi', 'ID'];
                        const rows = [headers.join(';')]; // Use semicolon for Excel compatibility

                        transactions.forEach(t => {
                            const row = [
                                t.date || '',
                                t.type === 'income' ? 'Gelir' : 'Gider',
                                (t.category || '').replace(/;/g, ','),
                                String(t.amount || 0).replace('.', ','), // Turkish decimal
                                `"${(t.description || '').replace(/"/g, '""')}"`,
                                (t.paymentMethod || '').replace(/;/g, ','),
                                t.id || ''
                            ];
                            rows.push(row.join(';'));
                        });

                        const csvContent = '\uFEFF' + rows.join('\r\n'); // UTF-8 BOM + Windows line endings
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

                        await this.downloadOrShare(blob, `fingenda_islemler_${APP_YEAR}.csv`, 'text/csv');
                        window.showMicroFeedback?.({ message: '✅ CSV başarıyla oluşturuldu', type: 'success' });
                        window.OfflineManager?.recordSync();
                    } catch (e) {
                        console.error('CSV export error:', e);
                        window.ErrorLogger?.log('error', 'CSV export failed', { error: e.message });
                        window.alertMessage('Hata', 'CSV oluşturulurken bir sorun oluştu.', 'red');
                    }
                },

                async exportXLSX() {
                    try {
                        // Load SheetJS if not already loaded
                        if (!window.XLSX) {
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                            });
                        }

                        const APP_YEAR = window.APP_YEAR || new Date().getFullYear();
                        const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');

                        if (transactions.length === 0) {
                            window.alertMessage('Bilgi', 'Dışa aktarılacak işlem bulunamadı.', 'blue');
                            return;
                        }

                        // Prepare data for Excel
                        const data = transactions.map(t => ({
                            'Tarih': t.date || '',
                            'Tür': t.type === 'income' ? 'Gelir' : 'Gider',
                            'Kategori': t.category || '',
                            'Tutar': t.amount || 0,
                            'Açıklama': t.description || '',
                            'Ödeme Yöntemi': t.paymentMethod || ''
                        }));

                        // Create workbook and worksheet
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.json_to_sheet(data);

                        // Set column widths
                        ws['!cols'] = [
                            { wch: 12 }, // Tarih
                            { wch: 8 },  // Tür
                            { wch: 15 }, // Kategori
                            { wch: 12 }, // Tutar
                            { wch: 30 }, // Açıklama
                            { wch: 15 }  // Ödeme Yöntemi
                        ];

                        XLSX.utils.book_append_sheet(wb, ws, 'İşlemler');

                        // Generate file
                        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                        const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                        await this.downloadOrShare(blob, `fingenda_islemler_${APP_YEAR}.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
                        window.showMicroFeedback?.({ message: '✅ Excel dosyası oluşturuldu', type: 'success' });
                        window.OfflineManager?.recordSync();
                    } catch (e) {
                        console.error('XLSX export error:', e);
                        window.ErrorLogger?.log('error', 'XLSX export failed', { error: e.message });
                        window.alertMessage('Hata', 'Excel dosyası oluşturulurken bir sorun oluştu.', 'red');
                    }
                },

                async exportFullBackup() {
                    try {
                        const APP_YEAR = window.APP_YEAR || new Date().getFullYear();
                        const backup = {
                            version: '2.0',
                            appVersion: this.APP_VERSION,
                            createdAt: new Date().toISOString(),
                            year: APP_YEAR,
                            deviceInfo: {
                                platform: navigator.platform,
                                language: navigator.language
                            },
                            data: {
                                transactions: JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]'),
                                goals: JSON.parse(localStorage.getItem(`my_goals_${APP_YEAR}`) || '[]'),
                                tasks: JSON.parse(localStorage.getItem(`my_tasks_${APP_YEAR}`) || '[]'),
                                installments: JSON.parse(localStorage.getItem(`my_installments_${APP_YEAR}`) || '[]'),
                                budgets: JSON.parse(localStorage.getItem(`my_budgets_${APP_YEAR}`) || '[]'),
                                categories: JSON.parse(localStorage.getItem('custom_categories') || '[]'),
                                recurringRules: JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]'),
                                cards: JSON.parse(localStorage.getItem('my_credit_cards') || '[]'),
                                profile: {
                                    name: localStorage.getItem('user_name'),
                                    avatar: localStorage.getItem('user_avatar')
                                }
                            }
                        };

                        const jsonContent = JSON.stringify(backup, null, 2);
                        const blob = new Blob([jsonContent], { type: 'application/json' });

                        await this.downloadOrShare(blob, `fingenda_yedek_${APP_YEAR}.json`, 'application/json');
                        window.showMicroFeedback?.({ message: '✅ Tam yedek oluşturuldu', type: 'success' });
                        window.OfflineManager?.recordSync();
                    } catch (e) {
                        console.error('Backup export error:', e);
                        window.ErrorLogger?.log('error', 'Backup export failed', { error: e.message });
                        window.alertMessage('Hata', 'Yedek oluşturulurken bir sorun oluştu.', 'red');
                    }
                },

                async importBackup(jsonData) {
                    try {
                        const backup = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;

                        if (!backup.data) {
                            throw new Error('Geçersiz yedek formatı');
                        }

                        const APP_YEAR = backup.year || window.APP_YEAR || new Date().getFullYear();
                        let imported = { transactions: 0, goals: 0, tasks: 0 };

                        // Merge transactions (dedupe by id)
                        if (backup.data.transactions) {
                            const existing = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                            const existingIds = new Set(existing.map(t => t.id));
                            const newTxns = backup.data.transactions.filter(t => t.id && !existingIds.has(t.id));
                            if (newTxns.length > 0) {
                                localStorage.setItem(`my_expenses_${APP_YEAR}`, JSON.stringify([...existing, ...newTxns]));
                                imported.transactions = newTxns.length;
                            }
                        }

                        // Merge goals
                        if (backup.data.goals) {
                            const existing = JSON.parse(localStorage.getItem(`my_goals_${APP_YEAR}`) || '[]');
                            const existingIds = new Set(existing.map(g => g.id));
                            const newGoals = backup.data.goals.filter(g => g.id && !existingIds.has(g.id));
                            if (newGoals.length > 0) {
                                localStorage.setItem(`my_goals_${APP_YEAR}`, JSON.stringify([...existing, ...newGoals]));
                                imported.goals = newGoals.length;
                            }
                        }

                        // Merge tasks
                        if (backup.data.tasks) {
                            const existing = JSON.parse(localStorage.getItem(`my_tasks_${APP_YEAR}`) || '[]');
                            const existingIds = new Set(existing.map(t => t.id));
                            const newTasks = backup.data.tasks.filter(t => t.id && !existingIds.has(t.id));
                            if (newTasks.length > 0) {
                                localStorage.setItem(`my_tasks_${APP_YEAR}`, JSON.stringify([...existing, ...newTasks]));
                                imported.tasks = newTasks.length;
                            }
                        }

                        window.OfflineManager?.recordSync();
                        return imported;
                    } catch (e) {
                        console.error('Import error:', e);
                        throw e;
                    }
                },

                async downloadOrShare(blob, filename, mimeType) {
                    // Try Capacitor Share first (for iOS Files app)
                    if (window.Capacitor?.Plugins?.Share) {
                        try {
                            const reader = new FileReader();
                            reader.onload = async () => {
                                const base64 = reader.result.split(',')[1];
                                await window.Capacitor.Plugins.Share.share({
                                    title: filename,
                                    text: 'Fingenda Yedek Dosyası',
                                    files: [`data:${mimeType};base64,${base64}`]
                                });
                            };
                            reader.readAsDataURL(blob);
                            return;
                        } catch (e) {
                            console.warn('Share fallback to download:', e);
                        }
                    }

                    // Browser download fallback
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            };

            // ═══════════════════════════════════════════════════════════════════════════════════
            // FEATURE MODULE 4: ERROR LOGGER (Enhanced with Data Masking + File Export)
            // ═══════════════════════════════════════════════════════════════════════════════════
            window.ErrorLogger = {
                MAX_LOGS: 200,
                logs: [],

                init() {
                    try {
                        this.logs = JSON.parse(localStorage.getItem('app_logs') || '[]');
                    } catch (e) {
                        this.logs = [];
                    }

                    // Global error handler
                    window.onerror = (message, source, lineno, colno, error) => {
                        this.log('error', this.maskSensitiveData(String(message)), {
                            source: source?.split('/').pop(), // Only filename
                            lineno, colno,
                            stack: this.maskSensitiveData(error?.stack || '')
                        });
                        return false;
                    };

                    // Promise rejection handler
                    window.onunhandledrejection = (event) => {
                        this.log('error', 'Unhandled Promise Rejection', {
                            reason: this.maskSensitiveData(String(event.reason))
                        });
                    };

                    this.log('info', 'App initialized');
                },

                // Mask sensitive data
                maskSensitiveData(text) {
                    if (!text || typeof text !== 'string') return text;

                    return text
                        // Mask email addresses
                        .replace(/([a-zA-Z0-9._-]+)@([a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi, '***@***.***')
                        // Mask numbers > 3 digits (potential amounts/IDs)
                        .replace(/\b\d{4,}\b/g, '****')
                        // Mask Turkish phone numbers
                        .replace(/(\+90|0)?\s*5\d{2}\s*\d{3}\s*\d{2}\s*\d{2}/g, '****')
                        // Truncate long strings
                        .substring(0, 500);
                },

                log(level, message, context = {}) {
                    const entry = {
                        ts: new Date().toISOString(),
                        level,
                        message: this.maskSensitiveData(message),
                        context
                    };

                    this.logs.push(entry);
                    if (this.logs.length > this.MAX_LOGS) {
                        this.logs = this.logs.slice(-this.MAX_LOGS);
                    }

                    try {
                        localStorage.setItem('app_logs', JSON.stringify(this.logs));
                    } catch (e) { }

                    const consoleMethod = level === 'error' ? console.error : (level === 'warn' ? console.warn : console.log);
                    consoleMethod(`[${level.toUpperCase()}]`, message, context);
                },

                getRecentLogs(count = 30) {
                    return this.logs.slice(-count);
                },

                // PATCH: HEDEF-5 - Enhanced logs with app version, user status, browser info
                copyLogsToClipboard() {
                    const appVersion = window.ExportManager?.APP_VERSION || '1.0.0';
                    const isPremium = window.PremiumManager?.isPremium || localStorage.getItem('is_pro') === 'true';
                    const userAgent = navigator.userAgent;
                    const platform = navigator.platform;
                    const language = navigator.language;
                    const isOnline = window.OfflineManager?.isOnline ?? navigator.onLine;
                    const lastSync = localStorage.getItem('last_sync_ts') || 'N/A';
                    const pendingCount = window.OfflineManager?.getPendingCount?.() || 0;

                    // Get last error if any
                    const errorLogs = this.logs.filter(l => l.level === 'error');
                    const lastError = errorLogs.length > 0 ? errorLogs[errorLogs.length - 1] : null;

                    const logsText = this.getRecentLogs(50).map(l =>
                        `[${l.ts}] ${l.level.toUpperCase()}: ${l.message}`
                    ).join('\n');

                    const fullReport = `
════════════════════════════════════════════
FINGENDA HATA RAPORU
Oluşturulma: ${new Date().toLocaleString('tr-TR')}
════════════════════════════════════════════

📱 CİHAZ BİLGİLERİ
──────────────────
Uygulama Sürümü: ${appVersion}
Platform: ${platform}
Dil: ${language}
Tarayıcı: ${userAgent}
Durum: ${isOnline ? 'Çevrimiçi' : 'Çevrimdışı'}
Premium: ${isPremium ? 'Pro' : 'Free'}
Son Senkron: ${lastSync}
Bekleyen İşlem: ${pendingCount}

${lastError ? `⚠️ SON HATA
──────────────────
Tarih: ${lastError.ts}
Mesaj: ${lastError.message}
Detay: ${JSON.stringify(lastError.context || {})}
` : ''}
📋 SON 50 LOG
──────────────────
${logsText}

════════════════════════════════════════════
`.trim();

                    navigator.clipboard.writeText(fullReport).then(() => {
                        window.showMicroFeedback?.({ message: '📋 Detaylı rapor kopyalandı', type: 'success' });
                    }).catch(() => {
                        window.alertMessage('Hata', 'Kopyalama başarısız', 'red');
                    });
                },

                async generateFeedbackFile() {
                    const logs = this.getRecentLogs(50);
                    const logsText = logs.map(l => `${l.ts} [${l.level}] ${l.message}`).join('\n');

                    const content = `
═══════════════════════════════════════════════════════════
FINGENDA HATA RAPORU
Oluşturulma: ${new Date().toLocaleString('tr-TR')}
═══════════════════════════════════════════════════════════

CİHAZ BİLGİLERİ
---------------
Platform: ${navigator.platform}
Dil: ${navigator.language}
Durum: ${window.OfflineManager?.isOnline ? 'Çevrimiçi' : 'Çevrimdışı'}
Son Senkron: ${window.OfflineManager?.lastSyncTs || 'N/A'}
Bekleyen İşlem: ${window.OfflineManager?.getPendingCount() || 0}
Premium: ${window.PremiumManager?.isPremium ? 'Evet' : 'Hayır'}

SON 50 LOG
----------
${logsText}

KULLANICI NOTU
--------------
[Buraya sorununuzu yazın]

═══════════════════════════════════════════════════════════
`.trim();

                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    await window.ExportManager?.downloadOrShare(blob, 'fingenda_hata_raporu.txt', 'text/plain');
                    window.showMicroFeedback?.({ message: '📄 Rapor dosyası oluşturuldu', type: 'success' });
                },

                sendFeedback() {
                    this.generateFeedbackFile();
                },

                clearLogs() {
                    this.logs = [];
                    localStorage.removeItem('app_logs');
                    window.showMicroFeedback?.({ message: '🗑️ Loglar temizlendi', type: 'info' });
                }
            };

            // ═══════════════════════════════════════════════════════════════════════════════════
            // FEATURE MODULE 5: IAP MANAGER (In-App Purchase with Restore)
            // ═══════════════════════════════════════════════════════════════════════════════════
            window.IAPManager = {
                // PATCH: Auto-detect production vs development mode
                // Production = Capacitor native app; Dev = Browser/localhost
                get IS_DEV_MODE() {
                    // In Capacitor native app → production mode (real IAP)
                    if (window.Capacitor?.isNativePlatform?.()) return false;
                    // Browser or localhost → dev mode (simulated)
                    return true;
                },
                products: [],
                entitlement: null,
                PRODUCT_IDS: {
                    MONTHLY: 'fingenda_pro_monthly',
                    YEARLY: 'fingenda_pro_yearly',
                    LIFETIME: 'fingenda_pro_lifetime'
                },

                async init() {
                    // Load cached entitlement
                    this.entitlement = localStorage.getItem('premium_entitlement') || null;

                    if (window.Capacitor?.Plugins?.InAppPurchase2) {
                        try {
                            const store = window.Capacitor.Plugins.InAppPurchase2;
                            // Register products
                            await store.register([
                                { id: this.PRODUCT_IDS.MONTHLY, type: 'PAID_SUBSCRIPTION' },
                                { id: this.PRODUCT_IDS.YEARLY, type: 'PAID_SUBSCRIPTION' },
                                { id: this.PRODUCT_IDS.LIFETIME, type: 'NON_CONSUMABLE' }
                            ]);

                            // Load products
                            this.products = await store.getProducts();

                            // Check existing purchases
                            await this.validateEntitlement();
                        } catch (e) {
                            console.warn('IAP init error:', e);
                        }
                    }
                },

                async purchase(productId) {
                    if (this.IS_DEV_MODE) {
                        // Simulation mode for development
                        console.log('[DEV] Simulating purchase:', productId);
                        await this.simulatePurchase();
                        return true;
                    }

                    if (!window.Capacitor?.Plugins?.InAppPurchase2) {
                        window.alertMessage('Hata', 'Satın alma servisi kullanılamıyor.', 'red');
                        return false;
                    }

                    try {
                        const store = window.Capacitor.Plugins.InAppPurchase2;
                        const result = await store.purchase({ productId });

                        if (result.transactionId) {
                            await this.validateEntitlement();
                            return true;
                        }
                        return false;
                    } catch (e) {
                        console.error('Purchase error:', e);
                        window.ErrorLogger?.log('error', 'Purchase failed', { productId, error: e.message });
                        return false;
                    }
                },

                async restore() {
                    if (this.IS_DEV_MODE) {
                        window.alertMessage('Bilgi', '[DEV] Restore simülasyonu', 'blue');
                        return;
                    }

                    if (!window.Capacitor?.Plugins?.InAppPurchase2) {
                        window.alertMessage('Hata', 'Satın alma servisi kullanılamıyor.', 'red');
                        return;
                    }

                    try {
                        const store = window.Capacitor.Plugins.InAppPurchase2;
                        await store.restorePurchases();
                        await this.validateEntitlement();

                        if (this.entitlement) {
                            window.alertMessage('Başarılı', 'Premium üyeliğiniz geri yüklendi! 🎉', 'green');
                        } else {
                            window.alertMessage('Bilgi', 'Geri yüklenecek satın alma bulunamadı.', 'blue');
                        }
                    } catch (e) {
                        console.error('Restore error:', e);
                        window.alertMessage('Hata', 'Geri yükleme başarısız.', 'red');
                    }
                },

                async validateEntitlement() {
                    // In production: verify receipt with Apple/Google
                    // For now: check local entitlement cache
                    if (this.entitlement) {
                        window.PremiumManager.isPremium = true;
                        window.applyPremiumUI?.();
                    }
                },

                async simulatePurchase() {
                    // DEV MODE ONLY: Simulate successful purchase
                    this.entitlement = {
                        productId: 'fingenda_pro_lifetime',
                        purchaseDate: new Date().toISOString(),
                        isSimulated: true
                    };
                    localStorage.setItem('premium_entitlement', JSON.stringify(this.entitlement));
                    localStorage.setItem('user_status', 'pro');

                    window.PremiumManager.isPremium = true;
                    window.PremiumManager.closeModal?.();
                    window.applyPremiumUI?.();
                    window.PWT?.maybeShow?.();

                    window.alertMessage('Başarılı', '[DEV] Premium simülasyonu aktif 🎉', 'green');
                },

                isPremiumActive() {
                    return !!this.entitlement || window.PremiumManager?.isPremium;
                }
            };

            // ═══════════════════════════════════════════════════════════════════════════════════
            // FEATURE MODULE 6: LAZY LOADER (Deferred Script Loading) - PATCH: Enhanced
            // ═══════════════════════════════════════════════════════════════════════════════════
            window.LazyLoader = {
                loaded: {},

                async load(name) {
                    if (this.loaded[name]) return this.loaded[name];

                    // PATCH: Updated library URLs and added TensorFlow
                    const scripts = {
                        tesseract: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js',
                        tensorflow: 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js',
                        jspdf: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                        jspdfAutotable: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js',
                        xlsx: 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js',
                        marked: 'https://cdn.jsdelivr.net/npm/marked/marked.min.js'
                    };

                    if (!scripts[name]) {
                        console.warn('Unknown library:', name);
                        return null;
                    }

                    // PATCH: Show loading toast
                    window.showMicroFeedback?.({ message: `📦 ${name} yükleniyor...`, type: 'info' });

                    return new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = scripts[name];
                        script.async = true;
                        script.onload = () => {
                            this.loaded[name] = true;
                            window.ErrorLogger?.log('info', `Lazy loaded: ${name}`);
                            resolve(true);
                        };
                        script.onerror = (e) => {
                            window.ErrorLogger?.log('error', `Failed to load: ${name}`);
                            window.showMicroFeedback?.({ message: `❌ ${name} yüklenemedi`, type: 'error' });
                            reject(e);
                        };
                        document.head.appendChild(script);
                    });
                },

                isLoaded(name) {
                    return !!this.loaded[name];
                }
            };

            // PATCH: Convenient ensure* helper functions
            window.ensureTesseract = async function () {
                if (window.Tesseract) return window.Tesseract;
                await window.LazyLoader.load('tesseract');
                return window.Tesseract;
            };

            window.ensureTFJS = async function () {
                if (window.tf) return window.tf;
                await window.LazyLoader.load('tensorflow');
                return window.tf;
            };

            window.ensureJSPDF = async function () {
                if (window.jspdf) return window.jspdf;
                await window.LazyLoader.load('jspdf');
                await window.LazyLoader.load('jspdfAutotable');
                return window.jspdf;
            };

            window.ensureXLSX = async function () {
                if (window.XLSX) return window.XLSX;
                await window.LazyLoader.load('xlsx');
                return window.XLSX;
            };


            // Initialize all modules on DOM ready
            document.addEventListener('DOMContentLoaded', () => {
                window.BiometricBridge?.init();
                window.OfflineManager?.init();
                window.ErrorLogger?.init();
                window.IAPManager?.init();
            });

            // --- GİZLİLİK MODU YÖNETİMİ ---
            window.togglePrivacyMode = function () {
                const body = document.body;
                const isHidden = body.classList.toggle('privacy-active');

                // İkonları değiştir
                document.getElementById('icon-eye-open').classList.toggle('hidden', isHidden);
                document.getElementById('icon-eye-closed').classList.toggle('hidden', !isHidden);

                // Durumu kaydet
                localStorage.setItem('privacy_mode', isHidden);

                // Kullanıcıya hissettir (Haptic)
                if (navigator.vibrate) navigator.vibrate(20);
            };

            // Sayfa açılışında durumu geri yükle (initApp içine eklenecek)
            window.loadPrivacyState = function () {
                const isHidden = localStorage.getItem('privacy_mode') === 'true';
                if (isHidden) {
                    document.body.classList.add('privacy-active');
                    const btn = document.getElementById('btn-privacy-toggle');
                    if (btn) {
                        document.getElementById('icon-eye-open').classList.add('hidden');
                        document.getElementById('icon-eye-closed').classList.remove('hidden');
                    }
                }
            };



            // --- ALT KATEGORİ ÇİPLERİ (SUB-CATEGORY CHIPS) ---
            const subCategories = {
                '🛒 Market': ['BİM/A101', 'Migros', 'Carrefour', 'Bakkal', 'Pazar', 'Şarküteri', 'Ekmek'],
                '🍿 Eğlence': ['Netflix/Spotify', 'Sinema', 'Konser', 'Oyun', 'Etkinlik', 'Hobi'],
                '🏠 Kira': ['Ev Kirası', 'Aidat', 'Depozito', 'Emlakçı'],
                '🚌 Ulaşım': ['Benzin', 'Otobüs/Metro', 'Taksi', 'Uber', 'Uçak Bileti', 'Otopark'],
                '💳 Kredi Kartı': ['Asgari Ödeme', 'Dönem Borcu', 'Taksit', 'Kart Aidatı'],
                '🍽️ Yemek': ['Restoran', 'Kafe', 'Sipariş', 'Yemekhane', 'Atıştırmalık'],
                '💡 Faturalar': ['Elektrik', 'Su', 'Doğalgaz', 'İnternet', 'Telefon'],
                '🩺 Sağlık': ['Eczane', 'Hastane', 'Muayene', 'İlaç', 'Spor Salonu'],
                '👕 Giyim': ['Kıyafet', 'Ayakkabı', 'Aksesuar', 'Kuru Temizleme'],
                '📚 Eğitim': ['Kitap', 'Kırtasiye', 'Harç', 'Kurs', 'Okul Taksiti'],
                '🔧 Tamirat': ['Ev Tamiratı', 'Oto Sanayi', 'Bakım', 'Servis'],
                '✈️ Tatil': ['Otel', 'Ulaşım', 'Gezi', 'Vize']
            };

            window.renderSubCategories = function () {
                const catSelect = document.getElementById('input-category');
                const chipsContainer = document.getElementById('sub-category-chips');
                if (!catSelect || !chipsContainer) return;

                const selectedCat = catSelect.value;
                const subs = subCategories[selectedCat];

                if (subs && subs.length > 0) {
                    chipsContainer.innerHTML = '';
                    chipsContainer.classList.remove('hidden');

                    subs.forEach(sub => {
                        const btn = document.createElement('button');
                        btn.type = "button";
                        btn.className = "subchip";
                        btn.innerText = sub;
                        btn.setAttribute("aria-pressed", "false");

                        btn.onclick = function () {
                            const descInput = document.getElementById('input-desc');

                            // aktif görsel: sadece is-active ile yönet
                            Array.from(chipsContainer.children).forEach(c => {
                                c.classList.remove('is-active');
                                c.setAttribute("aria-pressed", "false");
                            });
                            this.classList.add('is-active');
                            this.setAttribute("aria-pressed", "true");

                            // Açıklamaya ekle (mevcut mantığı koru)
                            if (descInput) {
                                const currentVal = descInput.value;
                                const prefixRegex = /^\[.*?\] - /;
                                const cleanVal = currentVal.replace(prefixRegex, '');
                                descInput.value = `[${sub}] - ${cleanVal}`;
                                descInput.focus();
                            }
                        };

                        chipsContainer.appendChild(btn);
                    });
                } else {
                    chipsContainer.classList.add('hidden');
                }
            };

            // --- ÇOKLU PARA BİRİMİ DESTEĞİ (MULTI-CURRENCY) ---
            window.updateCurrencyPreview = function () {
                const amountInput = document.getElementById('input-amount');
                const currencySelect = document.getElementById('input-currency');
                const hintDiv = document.getElementById('currency-hint');

                if (!amountInput || !currencySelect || !hintDiv) return;

                const currency = currencySelect.value;
                const rawAmount = parseFloat(amountInput.value.replace(/\./g, '').replace(',', '.')) || 0;

                if (currency === 'TRY' || rawAmount === 0) {
                    hintDiv.classList.add('hidden');
                    amountInput.placeholder = "0.00";
                    return;
                }

                // Kur Belirleme
                let rate = 0;
                if (currency === 'USD') rate = liveRates.USD;
                else if (currency === 'EUR') rate = liveRates.EUR;

                if (rate > 0) {
                    const tryAmount = rawAmount * rate;
                    hintDiv.innerText = `≈ ${tryAmount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ₺ (Kur: ${rate.toFixed(2)})`;
                    hintDiv.classList.remove('hidden');
                    amountInput.placeholder = currency === 'USD' ? "0.00 $" : "0.00 €";
                } else {
                    hintDiv.innerText = "Kur verisi yükleniyor...";
                    hintDiv.classList.remove('hidden');
                }
            };

            // Mevcut Save Fonksiyonunu Sarmala (Wrapper)
            const originalSaveTransaction = window.saveTransaction;
            window.saveTransaction = function () {
                const currencySelect = document.getElementById('input-currency');
                const amountInput = document.getElementById('input-amount');
                const descInput = document.getElementById('input-desc');

                if (currencySelect && amountInput && currencySelect.value !== 'TRY') {
                    const currency = currencySelect.value;
                    const rawAmount = parseFloat(amountInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                    let rate = currency === 'USD' ? liveRates.USD : (currency === 'EUR' ? liveRates.EUR : 0);

                    if (rate > 0 && rawAmount > 0) {
                        const tryAmount = rawAmount * rate;

                        // Input değerini TL'ye çevirip override et (Original fonksiyon bunu okuyacak)
                        amountInput.value = tryAmount.toFixed(2).replace('.', ','); // Tr formatına yakın

                        // Açıklamaya not düş
                        const originalDesc = descInput.value;
                        const currencyNote = `(${rawAmount.toLocaleString('en-US')} ${currency} - Kur: ${rate.toFixed(2)})`;
                        descInput.value = originalDesc ? `${originalDesc} ${currencyNote}` : currencyNote;

                        // İşlemden sonra UI resetleme işini original fonksiyon halleder, 
                        // ama biz select'i TRY'ye çekmeliyiz ki sonraki işlem karışmasın.
                        setTimeout(() => {
                            currencySelect.value = 'TRY';
                            document.getElementById('currency-hint').classList.add('hidden');
                        }, 500);
                    }
                }

                // Orijinal kaydetme fonksiyonunu çağır
                if (originalSaveTransaction) originalSaveTransaction();
            };

            window.deleteRecurringRule = async function (id) {
                const confirmed = await window.confirmDialog({
                    title: "Talimat İptali",
                    message: "Bu otomatik talimatı iptal etmek istediğine emin misin?",
                    confirmText: "İptal Et",
                    cancelText: "Vazgeç",
                    variant: "red"
                });
                if (!confirmed) return;

                let rules = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');
                rules = rules.filter(r => r.id !== id);
                localStorage.setItem(`my_recurring_rules_${APP_YEAR}`, JSON.stringify(rules));

                // Listeyi yenile
                window.openRecurringManager();
                window.alertMessage("Başarılı", "Otomatik talimat iptal edildi. ✅", "green");
            };


            // Yardımcı Fonksiyonlar
            function getCurrentBalance() {
                return parseFloat(document.getElementById('display-balance')?.innerText.replace(/[^0-9.-]+/g, "")) || 0;
            }
            function getTotalNetWorth() {
                if (typeof window.calculatePortfolio === 'function') {
                    const p = window.calculatePortfolio(transactions);
                    return getCurrentBalance() + p.totalValue;
                }
                return getCurrentBalance();
            }
            function getCategoryCount(cat) {
                if (!transactions) return 0;
                return transactions.filter(t => t.category.toLowerCase().includes(cat)).length;
            }
            function getCategorySum(cat) {
                if (!transactions) return 0;
                return transactions.filter(t => t.category.toLowerCase().includes(cat)).reduce((a, b) => a + parseFloat(b.amount), 0);
            }
            function checkAllBadgesExceptThis() {
                return false;
            }



            // 4. Galeri Render (Güncel)
            /* --- ROZET GALERİSİNİ RENDER ETME - APPLE FITNESS+ AWARDS STYLE --- */
            window.renderNFTGallery = function () {
                let container = document.getElementById('nft-gallery-grid');
                if (!container) container = document.getElementById('nft-gallery');

                if (!container) return;

                const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
                const myBadges = JSON.parse(localStorage.getItem(`my_badges_${currentYear}`) || '[]');

                container.innerHTML = '';

                badgesDef.forEach((def, index) => {
                    const isUnlocked = myBadges.includes(def.id);
                    const rarityClass = `rarity-${def.rarity || 'common'}`;
                    const stateClass = isUnlocked ? 'badge-unlocked' : 'badge-locked';
                    const iconHTML = window.getBadgeIconHTML ? window.getBadgeIconHTML(def, false) : `<span class="text-4xl">${def.icon}</span>`;
                    const animationDelay = index * 50;

                    const html = `
    <div onclick="window.openBadgeDetail('${def.id}')" 
         class="group relative flex flex-col items-center justify-center aspect-square rounded-2xl overflow-hidden transition-all duration-300 cursor-pointer ${stateClass} bg-white dark:bg-white/10 border border-gray-200 dark:border-white/10 shadow-[0_4px_15px_rgb(0,0,0,0.04)] dark:shadow-none hover:shadow-lg hover:scale-[1.02]"
         style="animation-delay: ${animationDelay}ms;">
        
        <!-- Rarity Ring Glow (Dark Mode Only) -->
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 bg-gradient-to-tr from-${def.rarity === 'rare' ? 'blue' : (def.rarity === 'epic' ? 'purple' : (def.rarity === 'legendary' ? 'yellow' : 'gray'))}-500/10 to-transparent dark:from-white/5"></div>
        
        <!-- Icon Container -->
        <div class="relative z-10 flex flex-col items-center justify-center p-4 transform transition-transform duration-500 group-hover:-translate-y-2">
            <div class="text-5xl mb-4 drop-shadow-xl filter ${isUnlocked ? '' : 'grayscale opacity-30'}">
                ${iconHTML}
            </div>
            
            <p class="text-xs font-bold text-gray-900 dark:text-white text-center leading-tight mb-0.5 px-2">${def.title}</p>
            <p class="text-[9px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">${def.rarity || 'common'}</p>
        </div>
        
        <!-- Lock Overlay (If Locked) -->
        ${!isUnlocked ? '<div class="absolute top-3 right-3 text-gray-300 dark:text-white/20"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm6-9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V10a2 2 0 0 1 2-2h1V6a5 5 0 0 1 10 0v2h1zM8 6a4 4 0 0 1 8 0v2H8V6z"/></svg></div>' : ''}
    </div>
`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            };



            // Yardımcı Renk Fonksiyonu
            function getRarityColor(rarity) {
                const colors = { common: '#9ca3af', rare: '#3b82f6', epic: '#a855f7', legendary: '#eab308', mythic: '#ef4444' };
                return colors[rarity] || '#fff';
            }

            // --- YENİ NESİL 3D ROZET İNCELEME (LAG-FREE) ---
            window.openBadgeDetail = function (badgeId) {
                const badge = badgesDef.find(b => b.id === badgeId);
                if (!badge) return;

                // Close the gallery modal first (if it's open)
                const galleryModal = document.getElementById('badge-gallery-modal');
                if (galleryModal && !galleryModal.classList.contains('hidden')) {
                    galleryModal.classList.add('hidden');
                }

                const modal = document.getElementById('nft-detail-modal');
                const container = document.getElementById('3d-card-container');
                if (!modal || !container) return;

                const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
                const myBadges = JSON.parse(localStorage.getItem(`my_badges_${currentYear}`) || '[]');
                const isUnlocked = myBadges.includes(badgeId);

                // Veriler
                const badgeDate = isUnlocked ? new Date().toLocaleDateString('tr-TR') : '---';
                const statusText = isUnlocked ? 'KAZANILDI' : 'KİLİTLİ';
                const statusColor = isUnlocked ? 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20' : 'text-red-400 bg-red-500/10 border-red-500/20';
                const borderClass = isUnlocked ? `border-${badge.rarity}` : 'border-common grayscale opacity-60';
                const rarityColor = getRarityColor(badge.rarity);
                const iconHTML = window.getBadgeIconHTML ? window.getBadgeIconHTML(badge, true) : `<span class="text-[120px]">${badge.icon}</span>`;

                // HTML Yapısı - APPLE HEALTH STYLE LIGHT / DARK
                container.innerHTML = `
                <div class="fixed inset-0 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-indigo-50/95 via-white/95 to-white/95 dark:from-gray-900/95 dark:via-black/95 dark:to-black/95 backdrop-blur-md transition-colors duration-500">
                    
                    <!-- Stage Light (Dark Mode Only) -->
                    <div class="absolute top-0 inset-x-0 h-1/2 bg-gradient-to-b from-${badge.rarity === 'legendary' ? 'yellow' : (badge.rarity === 'epic' ? 'purple' : 'indigo')}-500/20 to-transparent opacity-0 dark:opacity-100 pointer-events-none blur-3xl"></div>
                    
                    <!-- Close Button -->
                    <button onclick="document.getElementById('nft-detail-modal').classList.add('hidden')" 
                            class="absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-white/10 dark:text-white/60 dark:hover:bg-white/20 dark:hover:text-white flex items-center justify-center transition-all z-50 shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    
                    <!-- Main Content -->
                    <div class="relative flex flex-col items-center max-w-sm w-full z-10">
                        
                        <!-- Badge Status Pill -->
                        <div class="mb-10 scale-110">
                            <span class="text-[10px] font-black px-4 py-1.5 rounded-full border uppercase tracking-widest shadow-sm ${isUnlocked ? 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-500/20 dark:text-emerald-300 dark:border-emerald-500/30' : 'bg-gray-100 text-gray-500 border-gray-200 dark:bg-white/5 dark:text-gray-400 dark:border-white/10'}">
                                ${statusText}
                            </span>
                        </div>
                        
                        <!-- 3D Badge Showcase -->
                        <div class="relative mb-8 perspective-1000">
                            <div id="tilt-card" class="relative cursor-grab active:cursor-grabbing select-none transition-transform duration-100 ease-out will-change-transform ${isUnlocked ? '' : 'grayscale opacity-50'}">
                                <div class="filter drop-shadow-2xl dark:drop-shadow-[0_20px_50px_rgba(255,255,255,0.15)] transform transition-transform hover:scale-105 duration-300">
                                    ${iconHTML}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Typography -->
                        <div class="text-center mb-8">
                            <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-[0.3em] mb-3">FINGENDA COLLECTION</p>
                            <h1 class="text-4xl font-black text-slate-800 dark:text-white mb-4 tracking-tight drop-shadow-sm">${badge.title}</h1>
                            
                            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-lg bg-gray-100 dark:bg-white/10 border border-gray-200 dark:border-white/5">
                                <div class="w-2 h-2 rounded-full" style="background-color: ${rarityColor}"></div>
                                <span class="text-[10px] font-bold uppercase tracking-widest text-gray-600 dark:text-gray-300">${badge.rarity || 'Common'}</span>
                            </div>
                        </div>
                        
                        <!-- Description Card -->
                        <div class="w-full bg-white dark:bg-white/5 rounded-3xl p-6 border border-gray-100 dark:border-white/10 shadow-[0_4px_20px_rgba(0,0,0,0.03)] dark:shadow-none mb-6">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300 text-center leading-relaxed">
                                "${badge.desc}"
                            </p>
                        </div>
                        
                        <!-- Stats Grid -->
                        <div class="w-full grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-4 border border-gray-100 dark:border-white/5 text-center">
                                <p class="text-[9px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-1">Kazanım Tarihi</p>
                                <p class="text-sm font-black text-slate-800 dark:text-white font-mono">${badgeDate}</p>
                            </div>
                            <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-4 border border-gray-100 dark:border-white/5 text-center">
                                <p class="text-[9px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-1">Nadirlik Seviyesi</p>
                                <p class="text-sm font-black capitalize" style="color: ${rarityColor};">${badge.rarity || 'Common'}</p>
                            </div>
                        </div>
                        
                        <p class="mt-8 text-gray-300 dark:text-white/20 text-[9px] font-bold animate-pulse tracking-[0.4em] uppercase">3D İnceleme Modu</p>
                    </div>
                </div>
            `;

                modal.classList.remove('hidden');

                // --- PERFORMANS ODAKLI TILT MANTIĞI ---
                const card = document.getElementById('tilt-card');
                const glare = document.getElementById('holo-glare');

                // Mouse/Touch hareket sınırları
                const limits = 25; // Derece cinsinden maksimum dönüş açısı

                function handleInput(e) {
                    // O anki geçişi kaldır (Lag önleme - ÇOK ÖNEMLİ)
                    card.style.transition = 'none';

                    const rect = card.getBoundingClientRect();
                    // Mouse veya Touch koordinatları
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                    const x = clientX - rect.left;
                    const y = clientY - rect.top;

                    // Merkez noktası
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;

                    // Dönüş hesaplama
                    const rotateX = ((y - centerY) / centerY) * -limits; // Y ekseni hareketi X ekseninde dönüş yaratır
                    const rotateY = ((x - centerX) / centerX) * limits;

                    // Kartı döndür
                    card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;

                    // Işık efekti pozisyonu
                    const glareX = (x / rect.width) * 100;
                    const glareY = (y / rect.height) * 100;
                    glare.style.background = `radial-gradient(circle at ${glareX}% ${glareY}%, rgba(255,255,255,0.3) 0%, transparent 50%)`;
                    glare.style.opacity = '1';
                }

                function resetCard() {
                    // Mouse çıkınca yumuşak geçişi geri aç
                    card.style.transition = 'transform 0.5s cubic-bezier(0.23, 1, 0.32, 1)';
                    card.style.transform = `rotateX(0deg) rotateY(0deg)`;
                    glare.style.opacity = '0';
                }

                // Event Listeners (Desktop)
                card.addEventListener('mousemove', handleInput);
                card.addEventListener('mouseleave', resetCard);

                // Event Listeners (Mobile)
                card.addEventListener('touchmove', handleInput);
                card.addEventListener('touchend', resetCard);
            };
            /*
            const badge = badgesDef.find(b => b.id === badgeId);
            if (!badge) return;
     
            const modal = document.getElementById('nft-detail-modal');
            if (!modal) return;
     
            // Kilit Durumu Kontrolü
            const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
            const myBadges = JSON.parse(localStorage.getItem(`my_badges_${currentYear}`) || '[]');
            const isUnlocked = myBadges.includes(badgeId);
     
            const container = document.getElementById('3d-card-container');
            const badgeDate = isUnlocked ? new Date().toLocaleDateString('tr-TR') : '---';
            const statusText = isUnlocked ? 'Kazanıldı' : 'Kilitli';
            const unlockHint = isUnlocked ? 'ARKASINI OKU ↻' : 'NASIL KAZANILIR?';
     
            container.innerHTML = `
                <div class="relative w-72 h-96 group perspective-1000 cursor-pointer" onclick="this.querySelector('#modal-card-inner').classList.toggle('rotate-y-180')">
                    <div id="modal-card-inner" class="relative w-full h-full transition-all duration-700 transform-style-3d shadow-2xl rounded-3xl">
                        
                        <div class="absolute inset-0 w-full h-full backface-hidden rounded-3xl p-6 flex flex-col items-center justify-center border-2 border-white/10 ${isUnlocked ? 'bg-gradient-to-br from-[#1e1e2e] to-[#2d2d44]' : 'bg-gray-800 grayscale'}" style="z-index: 2;">
                            <div class="absolute inset-0 bg-gradient-to-tr from-white/5 to-transparent rounded-3xl pointer-events-none"></div>
                            
                            ${isUnlocked ? '' : '<div class="absolute top-4 right-4 text-3xl z-20 opacity-50">🔒</div>'}
                            
                            <div class="text-7xl mb-6 filter drop-shadow-xl transform transition-transform duration-500 hover:scale-110">
                                ${badge.icon}
                            </div>
                            
                            <h3 class="text-2xl font-black text-white tracking-widest uppercase text-center mb-2 drop-shadow-md">
                                ${badge.title}
                            </h3>
                            
                            <span class="px-4 py-1 rounded-full bg-white/10 text-xs font-bold text-white uppercase tracking-wider border border-white/20">
                                ${badge.rarity}
                            </span>
     
                            <div class="absolute bottom-6 text-[10px] text-white/50 font-mono animate-pulse">
                                ${unlockHint}
                            </div>
                        </div>
     
                        <div class="absolute inset-0 w-full h-full backface-hidden rounded-3xl p-6 flex flex-col items-center justify-center bg-gradient-to-bl from-[#1e1e2e] to-[#000] border-2 border-white/10" 
                             style="transform: rotateY(180deg); z-index: 1;">
                             
                            <div class="text-5xl mb-4 opacity-30 grayscale">${badge.icon}</div>
                            
                            <h4 class="text-lg font-bold text-white mb-4 border-b border-white/10 pb-2 w-full text-center">
                                Detaylar
                            </h4>
                            
                            <p class="text-sm text-gray-300 leading-relaxed text-center font-medium">
                                ${badge.desc}
                            </p>
                            
                            <div class="mt-auto pt-6 border-t border-white/10 w-full text-center">
                                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Durum</p>
                                <p class="text-sm font-bold ${isUnlocked ? 'text-green-400' : 'text-red-400'}">
                                    ${statusText} <span class="text-white text-xs block mt-1">${badgeDate}</span>
                                </p>
                            </div>
                        </div>
     
                    </div>
                </div>
                <p class="mt-8 text-white/60 text-xs font-bold animate-pulse tracking-widest text-center">KARTI ÇEVİRMEK İÇİN TIKLA</p>
                `;
     
            // Modalı Göster
            modal.classList.remove('hidden');
            }; */



        </script>






        <!-- LIQUID PIN LOCK SCREEN -->
        <div id="pin-lock-screen"
            class="hidden fixed inset-0 z-[9999] pin-glass-bg flex flex-col items-center justify-center transition-opacity duration-300">

            <!-- Vazgeç Butonu (Sadece PIN oluştururken görünür) -->
            <button id="btn-pin-cancel" onclick="window.PinManager.cancelSetup()"
                class="safe-close-btn hidden absolute top-8 right-8 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white/70 transition-colors z-50">
                <span class="text-xl font-bold">✕</span>
            </button>

            <div class="pin-wrapper">
                <div class="pin-stage">
                    <div class="pin-card">
                        <div class="mb-8 text-center">
                            <div
                                class="w-20 h-20 mx-auto mb-4 rounded-[2rem] bg-gradient-to-br from-indigo-500 to-purple-600 shadow-xl shadow-indigo-500/30 flex items-center justify-center lock-bounce">
                                <span class="text-4xl">🔒</span>
                            </div>
                            <h3 id="pin-title"
                                class="text-2xl font-black text-gray-800 dark:text-white mb-2 tracking-tight">
                                Hoş
                                Geldiniz</h3>
                            <p id="pin-subtitle" class="text-sm font-medium text-gray-500 dark:text-gray-400">
                                Güvenliğiniz
                                için
                                parolayı girin</p>
                        </div>

                        <div
                            class="pin-dots-container flex gap-4 mb-8 p-3 rounded-2xl bg-white/40 dark:bg-black/20 backdrop-blur-md border border-white/20">
                            <div
                                class="pin-dot w-4 h-4 rounded-full bg-gray-300 dark:bg-gray-600 transition-all duration-300 scale-90">
                            </div>
                            <div
                                class="pin-dot w-4 h-4 rounded-full bg-gray-300 dark:bg-gray-600 transition-all duration-300 scale-90">
                            </div>
                            <div
                                class="pin-dot w-4 h-4 rounded-full bg-gray-300 dark:bg-gray-600 transition-all duration-300 scale-90">
                            </div>
                            <div
                                class="pin-dot w-4 h-4 rounded-full bg-gray-300 dark:bg-gray-600 transition-all duration-300 scale-90">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-x-5 gap-y-4">
                            <button onclick="window.PinManager.press(1)" class="liquid-key">1</button>
                            <button onclick="window.PinManager.press(2)" class="liquid-key">2</button>
                            <button onclick="window.PinManager.press(3)" class="liquid-key">3</button>
                            <button onclick="window.PinManager.press(4)" class="liquid-key">4</button>
                            <button onclick="window.PinManager.press(5)" class="liquid-key">5</button>
                            <button onclick="window.PinManager.press(6)" class="liquid-key">6</button>
                            <button onclick="window.PinManager.press(7)" class="liquid-key">7</button>
                            <button onclick="window.PinManager.press(8)" class="liquid-key">8</button>
                            <button onclick="window.PinManager.press(9)" class="liquid-key">9</button>

                            <button onclick="window.PinManager.forgot()"
                                class="pin-forgot-btn flex items-center justify-center text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest hover:text-indigo-500 transition">Unuttum?</button>
                            <button onclick="window.PinManager.press(0)" class="liquid-key">0</button>
                            <button onclick="window.PinManager.clear()"
                                class="pin-clear-btn flex items-center justify-center text-xl text-gray-400 dark:text-gray-500 hover:text-red-500 transition">⌫</button>
                        </div>

                        <!-- FaceID/TouchID Button (shown if BiometricBridge.isAvailable) -->
                        <button id="btn-biometric-unlock" onclick="window.BiometricBridge?.tryBiometricFirst()"
                            class="hidden mt-6 w-full py-3 px-4 rounded-2xl bg-gradient-to-r from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 flex items-center justify-center gap-3 text-indigo-600 dark:text-indigo-300 font-bold text-sm hover:scale-[1.02] transition-all">
                            <span class="text-xl">🔐</span>
                            <span id="lbl-biometric-status">FaceID / TouchID ile Aç</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="ocr-confirm-modal"
            class="fixed inset-0 z-[160] hidden flex items-center justify-center modal-overlay px-4 bg-black/80 backdrop-blur-sm transition-opacity duration-300">
            <div class="glass-card w-full max-w-sm p-6 rounded-[32px] flex flex-col max-h-[90vh]">
                <h3 class="text-xl font-bold dark:text-white mb-4 text-center">Fiş Onayı 🧾</h3>

                <div class="mb-4 bg-black/20 rounded-2xl p-2 flex justify-center overflow-hidden h-48">
                    <img id="ocr-preview-img" src="" alt="Fiş Önizleme" class="h-full object-contain rounded-lg">
                </div>

                <div class="space-y-3 flex-1 overflow-y-auto custom-scroll pr-1">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase ml-2 mb-1">Tespit
                            Edilen
                            Tutar</label>
                        <input type="text" inputmode="decimal" id="ocr-confirm-amount"
                            oninput="window.formatCurrencyInput(this)"
                            class="modern-input w-full p-3 rounded-xl text-lg font-black text-center">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase ml-2 mb-1">Tarih</label>
                        <input type="month" id="ocr-confirm-date"
                            class="modern-input w-full p-3 rounded-xl text-sm font-bold text-center">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase ml-2 mb-1">Açıklama</label>
                        <input type="text" id="ocr-confirm-desc"
                            class="modern-input w-full p-3 rounded-xl text-sm font-medium">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4 pt-4 border-t border-white/10">
                    <button onclick="document.getElementById('ocr-confirm-modal').classList.add('hidden')"
                        class="py-3 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold text-sm">Vazgeç</button>
                    <button onclick="window.confirmOCRData()"
                        class="py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold text-sm shadow-lg hover:scale-105 transition-transform">Onayla
                        & Aktar</button>
                </div>
            </div>
        </div>
        <!-- YENİ: Otomatik Talimat Yönetimi Modalı -->
        <div id="recurring-manager-modal"
            class="fixed inset-0 z-[150] hidden flex items-center justify-center modal-overlay px-4 bg-black/50 backdrop-blur-sm">
            <div class="glass-card w-full max-w-sm p-6 rounded-[32px] flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h3 class="text-xl font-bold dark:text-white flex items-center gap-2"><span>🔄</span>
                        Abonelikler</h3>
                    <button onclick="document.getElementById('recurring-manager-modal').classList.add('hidden')"
                        class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:text-red-500 transition">✕</button>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll pr-2" id="recurring-list">
                    <!-- JS ile doldurulacak -->
                </div>

                <p class="text-[10px] text-gray-400 text-center mt-4">
                    Bu işlemler her ay belirlenen günde otomatik olarak eklenir.
                </p>
            </div>
        </div>

        <script>
            // --- NAKİT AKIŞI TAHMİNİ (EKSİK FONKSİYON EKLENDİ) ---
            window.predictCashFlow = function () {
                // Sadece Dashboard açıksa çalıştır
                const dash = document.getElementById('screen-dashboard');
                if (!dash || dash.classList.contains('hidden')) return;

                let currentBalance = window.parseSimpleCurrency(document.getElementById('display-balance').innerText);
                const warningEl = document.getElementById('cash-flow-warning');
                const msgEl = document.getElementById('cash-flow-msg');

                if (!warningEl || !msgEl) return;

                let riskFound = false;
                const today = new Date();

                // recurringRules (Otomatik Talimatlar) kontrolü
                // recurringRules değişkeninin tanımlı olduğundan emin ol
                const rules = (typeof recurringRules !== 'undefined') ? recurringRules : (JSON.parse(localStorage.getItem('my_recurring_rules_' + new Date().getFullYear())) || []);

                for (let i = 1; i <= 30; i++) {
                    const futureDate = new Date();
                    futureDate.setDate(today.getDate() + i);
                    const dayOfMonth = futureDate.getDate();

                    rules.forEach(rule => {
                        if (rule.day === dayOfMonth && rule.type === 'expense') {
                            currentBalance -= parseFloat(rule.amount);
                            if (currentBalance < 0 && !riskFound) {
                                riskFound = true;
                                warningEl.classList.remove('hidden');
                                msgEl.innerText = `Ayın ${dayOfMonth} 'inde (${rule.description || rule.category}) ödemesi nedeniyle bakiyen eksiye düşebilir!`;
                            }
                        }
                    });
                }

                if (!riskFound) warningEl.classList.add('hidden');
            };

            // --- YENİ YARDIMCI: Ürün Adından Kategori Tahmini ---
            window.detectCategoryFromTitle = function (title) {
                const t = title.toLowerCase();
                if (t.includes('yemek') || t.includes('burger') || t.includes('pizza') || t.includes('restoran')) return 'Yemek';
                if (t.includes('market') || t.includes('süt') || t.includes('gıda')) return 'Market';
                if (t.includes('kıyafet') || t.includes('ayakkabı') || t.includes('zara') || t.includes('giyim')) return 'Giyim';
                if (t.includes('oyun') || t.includes('steam') || t.includes('sinema') || t.includes('netflix')) return 'Eğlence';
                if (t.includes('benzin') || t.includes('taksi') || t.includes('uber')) return 'Ulaşım';
                if (t.includes('telefon') || t.includes('bilgisayar') || t.includes('kulaklık')) return 'Teknoloji';
                return 'Genel';
            };

            // --- GELİŞMİŞ SATIN ALMA ANALİZ MOTORU V2 ---
            window.analyzePurchase = function () {
                // 1. GİRDİLERİ AL
                const product = document.getElementById('decision-product').value.trim();
                const price = window.parseSimpleCurrency(document.getElementById('decision-price').value);
                const priority = document.getElementById('decision-priority').value;

                // UI Elementleri
                const resultBox = document.getElementById('decision-result');
                const headerBg = document.getElementById('decision-header-bg');
                const iconEl = document.getElementById('decision-icon');
                const titleEl = document.getElementById('decision-title');
                const scoreText = document.getElementById('decision-score-text');
                const descEl = document.getElementById('decision-desc');
                const gaugeCircle = document.getElementById('decision-gauge');
                const gaugeVal = document.getElementById('decision-gauge-val');
                const tradeoffText = document.getElementById('decision-tradeoff-text');
                const simCurrent = document.getElementById('sim-current-bal');
                const simFuture = document.getElementById('sim-future-bal');

                if (!price || price <= 0) {
                    window.alertMessage("Hata", "Lütfen geçerli bir fiyat girin.", "red");
                    return;
                }

                // 2. KULLANICI VERİSİNİ ANALİZ ET
                // Mevcut bakiye (ekrandan okuyoruz veya değişkenden)
                const currentBalance = window.parseSimpleCurrency(document.getElementById('display-balance').innerText);

                // Gelecek Sabit Giderler (Taksitler + Abonelikler)
                let fixedLiabilities = 0;
                const installments = JSON.parse(localStorage.getItem(`my_installments_${APP_YEAR}`)) || [];
                installments.forEach(ins => { if (ins.remainingMonths > 0) fixedLiabilities += parseFloat(ins.monthlyAmount); });

                const recurring = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');
                recurring.forEach(rec => fixedLiabilities += parseFloat(rec.amount));

                // "Özgür Para" (Borçlar düşüldükten sonra kalan)
                const freeCash = currentBalance - fixedLiabilities;
                const futureBalance = currentBalance - price;

                // Kategori Analizi (Bu ay buna benzer ne kadar harcadın?)
                const detectedCategory = window.detectCategoryFromTitle(product);
                let categorySpendThisMonth = 0;
                const now = new Date();
                window.transactions.forEach(t => {
                    const tDate = new Date(t.date || t.timestamp);
                    if (tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear() && t.type === 'expense') {
                        // İsim veya kategori eşleşmesi
                        if (t.category.includes(detectedCategory) || t.description.toLowerCase().includes(product.toLowerCase())) {
                            categorySpendThisMonth += parseFloat(t.amount);
                        }
                    }
                });

                // 3. SKORLAMA ALGORİTMASI (0 - 100)
                let score = 100;

                // Kural 1: Bakiye Yetersizliği (Ölümcül)
                if (futureBalance < 0) score = 0;
                else if (futureBalance < fixedLiabilities) score -= 50; // Borçları ödeyemez hale geliyorsa riskli

                // Kural 2: Harcanabilir Gelire Oran
                const ratio = price / (freeCash > 0 ? freeCash : 1);
                if (ratio > 0.5) score -= 30; // Özgür paranının yarısından fazlasıysa
                else if (ratio > 0.2) score -= 10;

                // Kural 3: Kategori Doygunluğu (Zaten çok harcadın mı?)
                if (categorySpendThisMonth > price * 1.5) score -= 15;

                // Kural 4: Öncelik Durumu
                if (priority === 'want') score -= 15; // İstekse puan kır
                if (priority === 'investment') score += 10; // Yatırımsa puan ekle

                // Skor Sınırları
                score = Math.max(0, Math.min(100, Math.round(score)));

                // 4. SONUÇ ÜRETİMİ (RENKLER VE METİNLER)
                let verdictTitle = "";
                let verdictColor = ""; // Text color
                let verdictBg = ""; // Header bg class
                let icon = "";
                let explanation = "";
                let tradeOffMsg = "";

                // Simülasyon Yaz
                simCurrent.innerText = currentBalance.toLocaleString('tr-TR') + ' ₺';
                simFuture.innerText = futureBalance.toLocaleString('tr-TR') + ' ₺';
                simFuture.className = `text-sm font-black transition-colors ${futureBalance < 0 ? 'text-red-600' : 'text-gray-800 dark:text-white'}`;

                if (score >= 80) {
                    // YEŞİL BÖLGE
                    verdictTitle = "GÜVENLİ BÖLGE";
                    verdictColor = "text-emerald-600 dark:text-emerald-400";
                    verdictBg = "bg-emerald-100 dark:bg-emerald-900/30 border-emerald-200 dark:border-emerald-800";
                    icon = "🟢";
                    explanation = `Bütçen bu harcamayı rahatlıkla kaldırıyor. ${detectedCategory !== 'Genel' ? `Bu ay <strong>${detectedCategory}</strong> harcaman makul seviyede.` : ''} Alabilirsin!`;
                    tradeOffMsg = "Bu harcama hedeflerini etkilemiyor. Keyfini çıkar! 🌟";
                } else if (score >= 50) {
                    // SARI BÖLGE
                    verdictTitle = "DİKKATLİ OL";
                    verdictColor = "text-yellow-600 dark:text-yellow-400";
                    verdictBg = "bg-yellow-100 dark:bg-yellow-900/30 border-yellow-200 dark:border-yellow-800";
                    icon = "⚠️";
                    explanation = `Alabilirsin ancak bu ayki "özgür paranı" %${(ratio * 100).toFixed(0)} oranında eritecek. ${categorySpendThisMonth > 0 ? `Zaten bu ay benzer şeyler için <strong>${categorySpendThisMonth} ₺</strong> harcamışsın.` : ''}`;

                    // Alternatif Maliyet
                    const coffeeCount = Math.floor(price / 60); // Kahve 60TL
                    tradeOffMsg = `Bunu almak, yaklaşık <strong>${coffeeCount} kahve</strong> içmemek demek. Değer mi? 🤔`;
                } else {
                    // KIRMIZI BÖLGE
                    verdictTitle = "RİSKLİ HARCAMA";
                    verdictColor = "text-red-600 dark:text-red-400";
                    verdictBg = "bg-red-100 dark:bg-red-900/30 border-red-200 dark:border-red-800";
                    icon = "🛑";
                    explanation = `Bütçen alarm veriyor! Sabit giderlerin (${fixedLiabilities} ₺) düşünüldüğünde bu harcama seni zor durumda bırakır.`;

                    if (priority === 'want') explanation += " Bu bir 'İstek' olduğu için 24 saat beklemeni öneririm.";

                    const savingsDays = Math.ceil(price / 100);
                    tradeOffMsg = `Şu an alma. Günde 100 TL kenara atarsan <strong>${savingsDays} gün</strong> sonra bütçeni bozmadan alabilirsin. ⏳`;
                }

                // 5. UI GÜNCELLEME
                resultBox.classList.remove('hidden');

                // Header Renklerini Sıfırla ve Yenisini Ekle
                headerBg.className = `p-4 flex items-center justify-between border-b transition-colors duration-500 ${verdictBg}`;

                iconEl.innerText = icon;
                titleEl.textContent = verdictTitle;
                titleEl.className = `text-base font-black uppercase leading-none ${verdictColor}`;
                scoreText.innerText = `Skor: ${score}/100`;

                descEl.innerHTML = explanation;
                tradeoffText.innerHTML = tradeOffMsg;

                // Gauge Animasyonu
                const maxDash = 126; // SVG circle circumference
                const targetDash = maxDash - ((score / 100) * maxDash);

                gaugeVal.innerText = score;
                gaugeVal.className = `absolute text-[10px] font-bold ${verdictColor}`;
                gaugeCircle.className = `transition-all duration-1000 ${verdictColor}`;

                // Animasyonu tetikle
                setTimeout(() => {
                    gaugeCircle.style.strokeDashoffset = targetDash;
                }, 100);

                // Sonuç alanına kaydır
                resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            };
            // OVERRIDE: Render Year Calendar (Ultra-Slim)
            window.renderYearCalendar = function (year) {
                const grid = document.getElementById('calendar-year-grid');
                const label = document.getElementById('calendar-year-label');
                if (!grid || !label) return;

                label.innerText = year;
                grid.innerHTML = '';

                const monthNames = ["Oca", "Şub", "Mar", "Nis", "May", "Haz", "Tem", "Ağu", "Eyl", "Eki", "Kas", "Ara"];
                const now = new Date();

                // Veri kontrolü
                const hasData = Array(12).fill(false);
                if (window.transactions) {
                    window.transactions.forEach(t => {
                        const d = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                        if (d.getFullYear() === year) hasData[d.getMonth()] = true;
                    });
                }

                for (let m = 0; m < 12; m++) {
                    const isActive = window.selectedMonthFilter && window.selectedMonthFilter.year === year && window.selectedMonthFilter.month === m;
                    const isCurrentMonth = (year === now.getFullYear() && m === now.getMonth());

                    // Dinamik Sınıflar (Slim & Pill Design)
                    let btnClass = "flex flex-col items-center justify-center py-1.5 px-4 rounded-full transition-all duration-300 min-w-[3.5rem] cursor-pointer border border-transparent ";
                    let textClass = "text-[10px] font-bold uppercase tracking-wider ";
                    let dotClass = "w-1 h-1 rounded-full mt-1 ";

                    if (isActive) {
                        btnClass += "bg-indigo-600 shadow-md transform scale-105";
                        textClass += "text-white";
                        dotClass += "bg-white";
                    } else {
                        btnClass += isCurrentMonth ? "bg-white/10 border-white/10" : "hover:bg-white/5";
                        textClass += isCurrentMonth ? "text-indigo-400" : "text-gray-500 dark:text-gray-400";
                        dotClass += hasData[m] ? (isCurrentMonth ? "bg-indigo-500" : "bg-gray-500") : "bg-transparent";
                    }

                    const html = `
                <div onclick="window.filterTransactionsByMonth(${year}, ${m})" class="${btnClass}">
                    <span class="${textClass}">${monthNames[m]}</span>
                    <div class="${dotClass}"></div>
                </div>`;

                    grid.insertAdjacentHTML('beforeend', html);
                }
            };
            // OVERRIDE: Render Year Calendar (Horizontal Filter Scroll)
            window.renderYearCalendar = function (year) {
                const grid = document.getElementById('calendar-year-grid');
                const label = document.getElementById('calendar-year-label');
                if (!grid || !label) return;

                label.innerText = year;
                grid.innerHTML = '';

                const monthNames = ["Oca", "Şub", "Mar", "Nis", "May", "Haz", "Tem", "Ağu", "Eyl", "Eki", "Kas", "Ara"];
                const now = new Date();

                // Veri Kontrolü
                const hasData = Array(12).fill(false);
                if (window.transactions) {
                    window.transactions.forEach(t => {
                        const d = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                        if (d.getFullYear() === year) hasData[d.getMonth()] = true;
                    });
                }

                for (let m = 0; m < 12; m++) {
                    const isActive = window.selectedMonthFilter && window.selectedMonthFilter.year === year && window.selectedMonthFilter.month === m;
                    const isCurrentMonth = (year === now.getFullYear() && m === now.getMonth());

                    // Buton Stilleri (Compact Capsule)
                    let btnClass = "snap-center flex-shrink-0 flex flex-col items-center justify-center w-[3.5rem] py-2 rounded-2xl transition-all duration-300 cursor-pointer border ";
                    let textClass = "text-xs font-bold uppercase tracking-wider ";
                    let dotClass = "w-1 h-1 rounded-full mt-1.5 ";

                    if (isActive) {
                        // Seçili (Parlayan Dolu Kutu)
                        btnClass += "bg-indigo-600 border-indigo-500 text-white shadow-lg shadow-indigo-500/40 transform scale-105";
                        textClass += "text-white";
                        dotClass += "bg-white";
                    } else {
                        // Varsayılan (Silik)
                        btnClass += "bg-white/50 dark:bg-white/5 border-transparent hover:bg-white dark:hover:bg-white/10";

                        if (isCurrentMonth) {
                            textClass += "text-indigo-600 dark:text-indigo-400";
                            btnClass += " border-indigo-200 dark:border-indigo-500/30";
                        } else {
                            textClass += "text-gray-400 dark:text-gray-500";
                        }

                        dotClass += hasData[m] ? (isCurrentMonth ? "bg-indigo-500" : "bg-gray-400") : "bg-transparent";
                    }

                    const html = `
                <div onclick="window.filterTransactionsByMonth(${year}, ${m})" class="${btnClass}">
                    <span class="${textClass}">${monthNames[m]}</span>
                    <div class="${dotClass}"></div>
                </div>`;

                    grid.insertAdjacentHTML('beforeend', html);
                }
            };

            /* --- YENİLENMİŞ ROZET SİSTEMİ (3D GÖRSELLER İLE) --- */
            /* --- YENÄ°LENMÄ°Å GENÄ°Å ROZET KOLEKSÄ°YONU (30+ ADET - FLUENT 3D) --- */
            /* --- YENİLENMİŞ GENİŞ ROZET KOLEKSİYONU (30+ ADET - FLUENT 3D) --- */
            /* --- YENİLENMİŞ & GARANTİLİ 3D ROZET KOLEKSİYONU (MS FLUENT CDN) --- */
            const badgesDef = [
                // --- SEVİYE 1: COMMON (Yaygın - Bronz/Gri) ---
                {
                    id: 'b_com_1',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Rocket/3D/rocket_3d.png',
                    title: 'BAŞLANGIÇ',
                    rarity: 'common',
                    desc: 'İlk işlemini kaydettin. Finansal yolculuk başladı! 🚀',
                    condition: () => transactions.length >= 1
                },
                {
                    id: 'b_com_2',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Memo/3D/memo_3d.png',
                    title: 'NOT ALAN',
                    rarity: 'common',
                    desc: '3 adet not ekledin. Hafızan artık daha güçlü. 📝',
                    condition: () => notes.length >= 3
                },
                {
                    id: 'b_com_3',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Shopping%20cart/3D/shopping_cart_3d.png',
                    title: 'MARKETÇİ',
                    rarity: 'common',
                    desc: 'Market kategorisinde 5 işlem yaptın. 🛒',
                    condition: () => getCategoryCount('market') >= 5
                },
                {
                    id: 'b_com_4',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Hot%20beverage/3D/hot_beverage_3d.png',
                    title: 'KAHVE MOLASI',
                    rarity: 'common',
                    desc: '50 TL altı 5 küçük harcama. Keyifler yerinde. ☕',
                    condition: () => transactions.filter(t => t.type === 'expense' && parseFloat(t.amount) < 50).length >= 5
                },
                {
                    id: 'b_com_5',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Bus/3D/bus_3d.png',
                    title: 'GEZGİN',
                    rarity: 'common',
                    desc: 'Ulaşım kategorisinde 5 işlem. 🚌',
                    condition: () => getCategoryCount('ulaşım') >= 5
                },
                {
                    id: 'b_com_6',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Credit%20card/3D/credit_card_3d.png',
                    title: 'TAKSİTÇİ',
                    rarity: 'common',
                    desc: 'İlk taksit planını oluşturdun. Borçlar kontrol altında. 💳',
                    condition: () => installments.length >= 1
                },
                {
                    id: 'b_com_7',
                    icon: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Symbols/Counterclockwise%20Arrows%20Button.png',
                    title: 'OTOMATİK',
                    rarity: 'common',
                    desc: 'Bir otomatik talimat (abonelik) ekledin. 🔄',
                    condition: () => recurringRules.length >= 1
                },

                // --- SEVİYE 2: RARE (Nadir - Mavi/Gümüş) ---
                {
                    id: 'b_rare_1',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Fire/3D/fire_3d.png',
                    title: 'İSTİKRAR',
                    rarity: 'rare',
                    desc: '50 İşlem kaydetmeyi başardın. Alev aldın! 🔥',
                    condition: () => transactions.length >= 50
                },
                {
                    id: 'b_rare_2',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Hamburger/3D/hamburger_3d.png',
                    title: 'GURME',
                    rarity: 'rare',
                    desc: 'Yemek kategorisinde 20 işlem. Afiyet olsun! 🍔',
                    condition: () => getCategoryCount('yemek') >= 20
                },
                {
                    id: 'b_rare_3',
                    icon: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Dress.png',
                    title: 'STİL İKONU',
                    rarity: 'rare',
                    desc: 'Giyim harcamaların 10 adedi geçti. Şıksın! 👕',
                    condition: () => getCategoryCount('giyim') >= 10
                },
                {
                    id: 'b_rare_4',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Pill/3D/pill_3d.png',
                    title: 'SAĞLIK OLSUN',
                    rarity: 'rare',
                    desc: 'Sağlık için toplam 5.000 TL harcadın. Kendine iyi bak. 💊',
                    condition: () => getCategorySum('sağlık') >= 5000
                },
                {
                    id: 'b_rare_5',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Graduation%20cap/3D/graduation_cap_3d.png',
                    title: 'BİLGİN',
                    rarity: 'rare',
                    desc: 'Eğitim harcamaların var (10 Adet). Öğrenmek güzeldir. 🎓',
                    condition: () => getCategoryCount('eğitim') >= 10
                },
                {
                    id: 'b_rare_6',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Receipt/3D/receipt_3d.png',
                    title: 'SORUMLU',
                    rarity: 'rare',
                    desc: 'Fatura ödemelerini aksatmıyorsun (10 Adet). 🧾',
                    condition: () => getCategoryCount('fatura') >= 10
                },
                {
                    id: 'b_rare_7',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Video%20game/3D/video_game_3d.png',
                    title: 'OYUNCU',
                    rarity: 'rare',
                    desc: 'Eğlence kategorisinde 10 harcama. GG WP! 🎮',
                    condition: () => getCategoryCount('eğlence') >= 10
                },

                // --- SEVİYE 3: EPIC (Destansı - Mor/Altın) ---
                {
                    id: 'b_epic_1',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Money%20bag/3D/money_bag_3d.png',
                    title: 'BANKER',
                    rarity: 'epic',
                    desc: '50.000 TL Nakit Bakiye. Cüzdan doldu taştı! 💰',
                    condition: () => getCurrentBalance() >= 50000
                },
                {
                    id: 'b_epic_2',
                    icon: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Activities/Bullseye.png',
                    title: 'HEDEF AVCISI',
                    rarity: 'epic',
                    desc: 'Bir hedefini %100 tamamladın. Tam isabet! 🎯',
                    condition: () => goals.some(g => g.current >= g.target)
                },
                {
                    id: 'b_epic_3',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Chart%20increasing/3D/chart_increasing_3d.png',
                    title: 'YATIRIMCI',
                    rarity: 'epic',
                    desc: 'Portföyünde en az 5 farklı yatırım işlemi var. 📈',
                    condition: () => transactions.filter(t => isSavingsTransaction(t)).length >= 5
                },
                {
                    id: 'b_epic_4',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Airplane/3D/airplane_3d.png',
                    title: 'DÜNYA TURU',
                    rarity: 'epic',
                    desc: 'Tatil için 50.000 TL bütçe ayırdın. İyi uçuşlar! ✈️',
                    condition: () => getCategorySum('tatil') >= 50000
                },
                {
                    id: 'b_epic_5',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Automobile/3D/automobile_3d.png',
                    title: 'GARAGE',
                    rarity: 'epic',
                    desc: 'Araba/Ulaşım masrafı 100.000 TL üzeri. 🚗',
                    condition: () => getCategorySum('ulaşım') >= 100000
                },
                {
                    id: 'b_epic_6',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/House/3D/house_3d.png',
                    title: 'EMLAK KRALI',
                    rarity: 'epic',
                    desc: 'Kira/Aidat ödemeleri toplam 200.000 TL. 🏠',
                    condition: () => getCategorySum('kira') + getCategorySum('aidat') >= 200000
                },

                // --- SEVİYE 4: LEGENDARY (Efsanevi - Turuncu/Neon) ---
                {
                    id: 'b_leg_1',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Money%20with%20wings/3D/money_with_wings_3d.png',
                    title: 'BONKÖR',
                    rarity: 'legendary',
                    desc: 'Tek seferde 20.000 TL harcama. Para kanatlandı! 💸',
                    condition: () => transactions.some(t => t.type === 'expense' && parseFloat(t.amount) >= 20000)
                },
                {
                    id: 'b_leg_2',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Lion/3D/lion_3d.png',
                    title: 'ASLAN PAYI',
                    rarity: 'legendary',
                    desc: 'Tek seferde 50.000 TL gelir girişi. Kral sensin! 🦁',
                    condition: () => transactions.some(t => t.type === 'income' && parseFloat(t.amount) >= 50000)
                },
                {
                    id: 'b_leg_3',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Crescent%20moon/3D/crescent_moon_3d.png',
                    title: 'GECE KUŞU',
                    rarity: 'legendary',
                    desc: 'Gece 03:00 - 05:00 arası işlem girdin. Uyumuyor musun? 🌙',
                    condition: () => transactions.some(t => { const h = new Date(t.timestamp || t.date).getHours(); return h >= 3 && h <= 5; })
                },
                {
                    id: 'b_leg_4',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Party%20popper/3D/party_popper_3d.png',
                    title: 'HAFTA SONU',
                    rarity: 'legendary',
                    desc: 'Sadece hafta sonları 50 işlem yaptın. Parti zamanı! 🎉',
                    condition: () => transactions.filter(t => { const d = new Date(t.date); return d.getDay() === 0 || d.getDay() === 6; }).length >= 50
                },

                // --- SEVİYE 5: MYTHIC (Gizli - Kırmızı/Obsidyen) ---
                {
                    id: 'b_myt_1',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Crown/3D/crown_3d.png',
                    title: 'MİLYONER',
                    rarity: 'mythic',
                    desc: 'Toplam Varlığın 1 Milyon TL\'yi aştı! Taç senin. 👑',
                    condition: () => getTotalNetWorth() >= 1000000
                },
                {
                    id: 'b_myt_2',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Gem%20stone/3D/gem_stone_3d.png',
                    title: 'ELMAS ELLER',
                    rarity: 'mythic',
                    desc: 'Hiç satış yapmadan 50 Yatırım işlemi. Asla satmadın! 💎',
                    condition: () => transactions.filter(t => isSavingsTransaction(t)).length >= 50
                },
                {
                    id: 'b_myt_3',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Dragon/3D/dragon_3d.png',
                    title: 'EJDERHA',
                    rarity: 'mythic',
                    desc: 'Tüm hedeflerini tamamladın (En az 3 hedef). Hazineni koru! 🐉',
                    condition: () => goals.length >= 3 && goals.every(g => g.current >= g.target)
                },
                {
                    id: 'b_myt_4',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Crystal%20ball/3D/crystal_ball_3d.png',
                    title: 'KAHİN',
                    rarity: 'mythic',
                    desc: 'Toplam 1000 işlem. Geleceği görüyorsun. 🔮',
                    condition: () => transactions.length >= 1000
                },
                {
                    id: 'b_myt_5',
                    icon: 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Unicorn/3D/unicorn_3d.png',
                    title: 'UNICORN',
                    rarity: 'mythic',
                    desc: '5 Milyon TL Net Varlık. Sen bir efsanesin! 🦄',
                    condition: () => getTotalNetWorth() >= 5000000
                }
            ];

            /* --- ROZET META YARDIMCI FONKSİYONLARI --- */
            // Rozet kazanılma tarihlerini saklayan meta storage key
            function getBadgeMetaKey() {
                const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
                return `my_badges_meta_${currentYear}`;
            }

            // Meta verisini localStorage'dan yükle
            function loadBadgeMeta() {
                try {
                    return JSON.parse(localStorage.getItem(getBadgeMetaKey()) || '{}');
                } catch (e) {
                    console.error('Badge meta yüklenirken hata:', e);
                    return {};
                }
            }

            // Meta verisini localStorage'a kaydet
            function saveBadgeMeta(meta) {
                localStorage.setItem(getBadgeMetaKey(), JSON.stringify(meta || {}));
            }

            // Rozet kazanıldığında tarih kaydet (sonradan overwrite etme!)
            function recordBadgeEarnedAt(badgeId, earnedAtISO) {
                const meta = loadBadgeMeta();
                if (!meta[badgeId]) meta[badgeId] = {};
                // Eğer daha önce kaydedilmemişse yaz
                if (!meta[badgeId].earnedAt) {
                    meta[badgeId].earnedAt = earnedAtISO || new Date().toISOString();
                    saveBadgeMeta(meta);
                }
            }

            // Eski rozetler için migration: earnedAt yoksa null olarak işaretle
            (function migrateBadgesMeta() {
                const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
                const unlocked = JSON.parse(localStorage.getItem(`my_badges_${currentYear}`) || '[]');
                const meta = loadBadgeMeta();

                let changed = false;
                for (const id of unlocked) {
                    if (!meta[id]) {
                        meta[id] = { earnedAt: null }; // Eski rozetler için null = "—" gösterilir
                        changed = true;
                    }
                }
                if (changed) saveBadgeMeta(meta);
            })();

            /* --- KUTLAMA MODALI - YENİ SCRATCH CARD SİSTEMİNE YÖNLENDİRİLDİ --- */
            window.showBadgeCelebration = function (badge) {
                // Convert badge data to reward format and use new scratch card popup
                const rewardData = {
                    id: badge.id,
                    title: badge.title,
                    rarity: badge.rarity || 'common',
                    icon: badge.icon,
                    description: badge.desc || badge.description || '',
                    valueTier: (badge.rarity === 'epic' || badge.rarity === 'legendary') ? 'high' : 'low'
                };

                // Open new reward popup
                window.openRewardPopup(rewardData);
            };

            window.closeBadgeCelebrationModal = function () {
                const modal = document.getElementById('badge-celebration-modal');
                const card = document.getElementById('award-card');

                if (!modal || !card) return;

                // Çıkış Animasyonu
                modal.classList.add('opacity-0');
                card.classList.remove('scale-100', 'opacity-100');
                card.classList.add('scale-90', 'opacity-0');

                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }, 500);
            };

            /* --- ROZET KONTROL VE KAZANMA FONKSİYONU --- */
            window.checkAndAwardBadges = function () {
                const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
                let myBadges = JSON.parse(localStorage.getItem(`my_badges_${currentYear}`) || '[]');
                let newlyUnlocked = [];

                badgesDef.forEach(badge => {
                    // Zaten kazanılmış mı?
                    if (myBadges.includes(badge.id)) return;

                    // Koşul sağlanıyor mu?
                    try {
                        if (badge.condition && badge.condition()) {
                            myBadges.push(badge.id);
                            // Kazanılma tarihini kaydet
                            recordBadgeEarnedAt(badge.id, new Date().toISOString());
                            newlyUnlocked.push(badge);
                        }
                    } catch (e) {
                        console.warn(`Badge condition error for ${badge.id}:`, e);
                    }
                });

                // Değişiklik varsa kaydet
                if (newlyUnlocked.length > 0) {
                    localStorage.setItem(`my_badges_${currentYear}`, JSON.stringify(myBadges));

                    // Yeni rozet kazanıldı bildirimi (Premium Modal)
                    // Sadece ilk kazanılanı gösterelim ki üst üste binmesin, veya sırayla gösterilebilir.
                    // Şimdilik son kazanılanı veya en değerlisini gösterelim.
                    if (newlyUnlocked.length > 0) {
                        window.showBadgeCelebration(newlyUnlocked[newlyUnlocked.length - 1]);
                    }
                }

                return newlyUnlocked;
            };

            /* --- YÜKSEK PERFORMANSLI 3D ROZET İNCELEME (MOBİL OPTİMİZE) --- */
            window.openBadgeDetail = function (badgeId) {
                const badge = badgesDef.find(b => b.id === badgeId);
                if (!badge) return;

                // PATCH: Rozet koleksiyonu modalını kapat (z-index çakışmasını önle)
                const galleryModal = document.getElementById('badge-gallery-modal');
                if (galleryModal) galleryModal.classList.add('hidden');

                const modal = document.getElementById('nft-detail-modal');
                const container = document.getElementById('3d-card-container');
                if (!modal || !container) return;

                const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
                const myBadges = JSON.parse(localStorage.getItem(`my_badges_${currentYear}`) || '[]');
                const isUnlocked = myBadges.includes(badgeId);

                // Veriler - Kaydedilmiş earnedAt tarihini kullan
                const meta = loadBadgeMeta();
                const earnedAtISO = meta[badgeId]?.earnedAt || null;
                const badgeDate = (isUnlocked && earnedAtISO)
                    ? new Date(earnedAtISO).toLocaleDateString('tr-TR')
                    : '—';
                const statusText = isUnlocked ? 'KAZANILDI' : 'KİLİTLİ';

                // Stil Sınıfları
                let glowClass = '';
                if (badge.rarity === 'rare') glowClass = 'glow-rare';
                if (badge.rarity === 'epic') glowClass = 'glow-epic';
                if (badge.rarity === 'legendary') glowClass = 'glow-legendary';
                if (badge.rarity === 'mythic') glowClass = 'glow-mythic';

                const borderClass = isUnlocked ? `border-${badge.rarity} ${glowClass}` : 'border-common grayscale opacity-60';

                // Light/Dark mode detection
                const isDarkMode = document.documentElement.classList.contains('dark');

                // Dynamic colors based on theme - UPDATED FOR PREMIUM LOOK
                const statusBg = isUnlocked
                    ? (isDarkMode ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' : 'bg-emerald-100 text-emerald-700 border-emerald-200')
                    : (isDarkMode ? 'bg-rose-500/20 text-rose-300 border-rose-500/30' : 'bg-rose-100 text-rose-600 border-rose-200');

                // Card Backgrounds - More depth
                const cardBg = isDarkMode ? '#0f172a' : 'linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%)';
                const cardBgStyle = isDarkMode ? `background-color: ${cardBg};` : `background: ${cardBg};`;

                // Typography Colors
                const brandTextColor = isDarkMode ? 'text-slate-400' : 'text-slate-500';
                const titleTextColor = isDarkMode ? 'text-white' : 'text-slate-800';
                const descTextColor = isDarkMode ? 'text-slate-400' : 'text-slate-600';

                // Footer & Accents
                const footerLabelColor = isDarkMode ? 'text-slate-500' : 'text-slate-400';
                const footerValueColor = isDarkMode ? 'text-slate-200' : 'text-slate-700';
                const helpTextColor = isDarkMode ? 'text-white/40' : 'text-slate-400';

                // Shadows & Glows
                const dropShadow = isDarkMode ? 'drop-shadow-[0_25px_50px_rgba(0,0,0,0.7)]' : 'drop-shadow-[0_20px_40px_rgba(0,0,0,0.2)]';
                const ambientGlow = isDarkMode
                    ? `<div class="absolute top-0 left-1/4 w-full h-full bg-gradient-to-br from-${isUnlocked ? 'indigo' : 'gray'}-500/10 to-transparent blur-[80px] -translate-y-1/2"></div>`
                    : `<div class="absolute top-0 left-1/4 w-full h-full bg-gradient-to-br from-${isUnlocked ? 'indigo' : 'gray'}-200/40 to-transparent blur-[80px] -translate-y-1/2"></div>`;
                const cardShadow = isDarkMode
                    ? 'shadow-[0_0_0_1px_rgba(255,255,255,0.05),0_20px_60px_rgba(0,0,0,0.6)]'
                    : 'shadow-[0_0_0_1px_rgba(0,0,0,0.05),0_25px_50px_rgba(20,20,40,0.1),0_10px_20px_rgba(0,0,0,0.05)]';

                // HTML Yapısı - PREMIUM DESIGN
                // PATCH: Remove modal container background/shadow to let the card float
                const modalContent = modal.querySelector('div:not(.absolute):not(.fixed)');
                if (modalContent) {
                    modalContent.style.cssText = "background: none !important; box-shadow: none !important; border: none !important;";
                }

                container.innerHTML = `
                <div class="nft-modal-perspective flex flex-col items-center justify-center h-full w-full py-8">
                    


                    <div id="tilt-card" class="premium-3d-card ${borderClass} ${cardShadow} gpu-accelerated flex flex-col items-center p-8 select-none cursor-grab active:cursor-grabbing relative overflow-hidden group transition-all duration-300" style="${cardBgStyle}; min-height: 520px; width: 100%; max-width: 340px; border-radius: 28px;">
                        
                        <!-- Texture & Effects -->
                        <div class="noise-texture opacity-[0.04]"></div>
                        <div class="holo-foil opacity-20 mixed-blend-overlay" id="holo-foil"></div>
                        <div class="holo-sheen opacity-40 mix-blend-soft-light" id="holo-glare"></div>
                        <div class="absolute inset-0 bg-gradient-to-b from-white/10 to-transparent pointer-events-none opacity-50"></div>

                        <!-- Ambient Glow Layer -->
                        <div class="absolute inset-0 overflow-hidden pointer-events-none layer-bg">
                            ${ambientGlow}
                        </div>

                        <!-- Header Pill -->
                        <div class="w-full flex justify-between items-center z-10 layer-mid mb-8">
                            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/40 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 shadow-sm">
                                <div class="w-2 h-2 rounded-full ${isUnlocked ? 'bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.6)]' : 'bg-rose-500'} animate-pulse"></div>
                                <span class="text-[10px] ${brandTextColor} font-black tracking-[0.2em] uppercase">FINGENDA</span>
                            </div>
                            <span class="${statusBg} text-[10px] font-bold px-3 py-1 rounded-full border backdrop-blur-md uppercase tracking-widest shadow-sm">
                                ${badge.rarity}
                            </span>
                        </div>

                        <!-- Floating 3D Icon Container -->
                        <div class="layer-floating my-auto relative z-20 filter ${dropShadow} transition-transform duration-500 group-hover:scale-105 group-hover:-translate-y-2">
                            <img src="${badge.icon}" alt="Icon" class="badge-3d-img w-52 h-52 object-contain filter contrast-110 saturate-110">
                        </div>

                        <!-- Content Section -->
                        <div class="layer-top flex flex-col items-center mt-auto w-full z-20">
                            <h2 class="text-3xl font-black ${titleTextColor} uppercase tracking-tight text-center mb-3 drop-shadow-sm leading-none">${badge.title}</h2>
                            <p class="text-[13px] ${descTextColor} text-center font-medium leading-relaxed max-w-[95%] opacity-90 mb-6">${badge.desc}</p>
                            
                            <!-- Stats Footer -->
                            <div class="w-full grid grid-cols-2 gap-3">
                                <div class="bg-white/50 dark:bg-white/5 rounded-2xl p-3 border border-white/40 dark:border-white/5 text-center backdrop-blur-md shadow-sm">
                                    <span class="block text-[9px] ${footerLabelColor} font-bold uppercase tracking-widest mb-1">DURUM</span>
                                    <span class="text-xs font-bold ${statusText === 'KAZANILDI' ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400'}">${statusText}</span>
                                </div>
                                <div class="bg-white/50 dark:bg-white/5 rounded-2xl p-3 border border-white/40 dark:border-white/5 text-center backdrop-blur-md shadow-sm">
                                    <span class="block text-[9px] ${footerLabelColor} font-bold uppercase tracking-widest mb-1">KAZANILDI</span>
                                    <span class="text-xs font-bold ${footerValueColor} font-mono">${badgeDate}</span>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <!-- Interactive Hint -->
                     <div class="mt-8 flex items-center gap-3 ${helpTextColor} text-[10px] font-bold animate-pulse tracking-[0.3em] uppercase opacity-70">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path></svg>
                        <span>Çevirmek İçin Sürükle</span>
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </div>
                </div>
            `;

                modal.classList.remove('hidden');

                // --- OPTİMİZE EDİLMİŞ ANİMASYON MOTORU (rAF Loop) ---
                const card = document.getElementById('tilt-card');
                const glare = document.getElementById('holo-glare');
                const foil = document.getElementById('holo-foil');
                const badgeImg = card.querySelector('.badge-3d-img');

                // Durum Değişkenleri
                let state = {
                    mouseX: 0, mouseY: 0,      // Hedef (Mouse/Gyro)
                    currentX: 0, currentY: 0,  // Mevcut (Animasyon için)
                    limits: 25,                // Max dönüş açısı
                    isRunning: true            // Animasyon döngüsü kontrolü
                };

                // 1. Animasyon Döngüsü (Sadece ekran yenilendiğinde çalışır)
                function animate() {
                    if (!state.isRunning || !card) return;

                    // Lineer İnterpolasyon (Yumuşatma) - Değeri 0.1 (Yavaş) ile 1 (Anlık) arası değiştirilebilir
                    // 0.1 değeri hareketin "ağırlıklı" ve "akıcı" olmasını sağlar.
                    state.currentX += (state.mouseX - state.currentX) * 0.1;
                    state.currentY += (state.mouseY - state.currentY) * 0.1;

                    // Hesaplamaları yap (Virgülden sonra 2 basamak yeterli)
                    const rotateX = (state.currentY * -state.limits).toFixed(2);
                    const rotateY = (state.currentX * state.limits).toFixed(2);
                    const glareX = (50 + (state.currentX * 50)).toFixed(2);
                    const glareY = (50 + (state.currentY * 50)).toFixed(2);

                    // DOM Güncellemesi (Tek seferde)
                    card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;

                    if (glare) {
                        glare.style.background = `radial-gradient(circle at ${glareX}% ${glareY}%, rgba(255,255,255,0.3) 0%, transparent 60%)`;
                        glare.style.opacity = Math.min(1, Math.abs(state.currentX) + Math.abs(state.currentY) + 0.2);
                    }

                    if (foil) {
                        foil.style.backgroundPosition = `${glareX}% ${glareY}%`;
                        foil.style.opacity = Math.min(1, Math.abs(state.currentX) + Math.abs(state.currentY));
                    }

                    if (badgeImg) {
                        // Paralaks efekti
                        badgeImg.style.transform = `translateX(${state.currentX * 15}px) translateY(${state.currentY * 15}px) scale(1.1)`;
                    }

                    requestAnimationFrame(animate);
                }

                // Döngüyü başlat
                requestAnimationFrame(animate);

                // 2. Olay Dinleyicileri (Sadece hedef değerleri günceller)

                // Masaüstü Mouse
                function handleMouseMove(e) {
                    const rect = card.getBoundingClientRect();
                    const x = (e.clientX - rect.left - rect.width / 2) / (rect.width / 2);
                    const y = (e.clientY - rect.top - rect.height / 2) / (rect.height / 2);
                    state.mouseX = x;
                    state.mouseY = y;
                }

                function handleMouseLeave() {
                    state.mouseX = 0;
                    state.mouseY = 0;
                }

                // Mobil Jiroskop
                function handleOrientation(e) {
                    // Değerleri normalize et ve sınırla (-1 ile 1 arası)
                    let x = e.gamma / 45; // Sağa sola
                    let y = e.beta / 45;  // Öne arkaya

                    if (x > 1) x = 1; if (x < -1) x = -1;
                    if (y > 1) y = 1; if (y < -1) y = -1;

                    state.mouseX = x;
                    state.mouseY = y;
                }

                // Eventleri Ekle
                card.addEventListener('mousemove', handleMouseMove);
                card.addEventListener('mouseleave', handleMouseLeave);

                // Mobil destek kontrolü
                if (window.DeviceOrientationEvent && 'ontouchstart' in window) {
                    window.addEventListener('deviceorientation', handleOrientation);
                }

                // 3. Temizlik Fonksiyonu (Modal kapandığında çalışır)
                window.cleanupBadgeDetail = function () {
                    state.isRunning = false; // Döngüyü durdur
                    card.removeEventListener('mousemove', handleMouseMove);
                    card.removeEventListener('mouseleave', handleMouseLeave);
                    window.removeEventListener('deviceorientation', handleOrientation);
                    modal.classList.add('hidden');
                };

                // Kapatma butonunu güncelle
                const closeBtn = modal.querySelector('button');
                if (closeBtn) {
                    closeBtn.onclick = window.cleanupBadgeDetail;
                }
            };

            /* --- GELİŞMİŞ WALLET SİSTEMİ (PRO) --- */
            window.cards = JSON.parse(localStorage.getItem('my_cards_v1')) || [];

            // 1. Kartları Yükle ve Render Et (Premium UI)
            window.loadCards = function () {
                const container = document.getElementById('wallet-cards-container');
                const list = document.getElementById('wallet-transactions-list');
                if (!container) return;

                container.innerHTML = '';

                if (window.cards.length === 0) {
                    container.innerHTML = `
                    <div onclick="window.openAddCardModal()" class="cursor-pointer group flex flex-col items-center justify-center w-[85%] h-[200px] border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-3xl hover:border-indigo-500 transition-colors bg-gray-50 dark:bg-white/5">
                        <div class="w-16 h-16 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-3xl mb-3 shadow-sm group-hover:scale-110 transition-transform">➕</div>
                        <p class="text-sm font-bold text-gray-500 dark:text-gray-400">Yeni Kart Ekle</p>
                        <span class="text-[10px] text-indigo-500 font-medium mt-1 bg-indigo-50 dark:bg-indigo-900/20 px-2 py-0.5 rounded">Premium Tasarımlar Aktif ✨</span>
                    </div>
                `;
                    document.getElementById('wallet-total-limit').innerText = '0 ₺';
                    document.getElementById('wallet-total-balance').innerText = '0 ₺';
                    list.innerHTML = '<p class="text-center text-xs text-gray-400 py-4">İşlem geçmişi için kart ekleyin.</p>';
                    return;
                }

                let totalLimit = 0;
                let totalDebt = 0;

                window.cards.forEach((card, index) => {
                    totalLimit += parseFloat(card.limit || 0);
                    totalDebt += parseFloat(card.debt || 0);

                    const el = document.createElement('div');

                    // Tema ve Doku Yönetimi
                    let bgClass = "bg-gray-800"; // Fallback
                    let textureHtml = "";
                    let textClass = "text-white";

                    if (card.theme === 'black') { bgClass = "bg-neutral-900"; textureHtml = '<div class="texture-carbon absolute inset-0"></div>'; }
                    else if (card.theme === 'blue') { bgClass = "bg-gradient-to-br from-blue-700 to-indigo-900"; textureHtml = '<div class="texture-metal absolute inset-0 opacity-30"></div>'; }
                    else if (card.theme === 'gold') { bgClass = "texture-gold"; textClass = "text-yellow-900"; textureHtml = '<div class="absolute inset-0 bg-white/10 mix-blend-overlay"></div>'; }
                    else if (card.theme === 'metal') { bgClass = "bg-gradient-to-br from-gray-300 to-gray-500"; textClass = "text-gray-800"; textureHtml = '<div class="texture-metal absolute inset-0 mix-blend-color-dodge"></div>'; }
                    else if (card.theme === 'neon') { bgClass = "bg-black border border-purple-500/50 shadow-[0_0_20px_rgba(168,85,247,0.4)]"; textureHtml = '<div class="absolute inset-0 bg-gradient-to-r from-transparent via-purple-500/20 to-transparent animate-shimmer"></div>'; }

                    // Kart Logosu (Visa/Mastercard)
                    const networkLogo = card.network === 'mastercard'
                        ? '<div class="flex"><div class="w-6 h-6 rounded-full bg-red-500/90 mix-blend-hard-light"></div><div class="w-6 h-6 rounded-full bg-yellow-500/90 mix-blend-hard-light -ml-3"></div></div>'
                        : '<h3 class="font-black italic tracking-tighter text-xl">VISA</h3>';

                    el.className = `absolute w-[85%] h-[210px] rounded-[24px] p-6 shadow-2xl transform transition-all duration-500 cursor-pointer hover:scale-[1.02] overflow-hidden ${bgClass} ${textClass}`;
                    el.style.top = '0';
                    el.style.zIndex = index + 1;

                    // Stack Efekti
                    if (index > 0) {
                        el.style.transform = `scale(${1 - (index * 0.05)}) translateY(${index * 12}px)`;
                        el.style.opacity = 1 - (index * 0.2);
                        el.style.filter = `brightness(${100 - (index * 20)}%)`;
                    }

                    const available = parseFloat(card.limit) - parseFloat(card.debt);
                    const progress = Math.min(100, (parseFloat(card.debt) / parseFloat(card.limit)) * 100);

                    el.innerHTML = `
                    ${textureHtml}
                    
                    <div class="relative z-10 flex justify-between items-start">
                        <div class="flex flex-col">
                            <span class="font-bold tracking-widest text-lg opacity-90">${card.bank}</span>
                            <span class="text-[9px] font-mono opacity-60 uppercase tracking-widest">WORLD ELITE</span>
                        </div>
                        ${networkLogo}
                    </div>

                    <div class="relative z-10 mt-6 flex items-center gap-3">
                        <div class="card-chip w-10 h-8"></div>
                        <svg class="w-6 h-6 opacity-60 rotate-90" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" opacity=".3"/><path d="M12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6 6 6z" opacity=".5"/><path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6-6 6 2.69 6 6-2.69 6 6 6z"/></svg>
                    </div>

                    <div class="relative z-10 mt-4">
                        <div class="text-xl font-mono tracking-[0.15em] mb-4 shadow-black drop-shadow-md">**** **** **** ${card.last4}</div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-[8px] opacity-60 uppercase mb-0.5">Kalan Limit</p>
                                <p class="font-bold text-sm tracking-wide">${available.toLocaleString('tr-TR')} ₺</p>
                            </div>
                            <div>
                                <p class="text-[8px] opacity-60 uppercase text-right mb-0.5">SKT</p>
                                <p class="font-bold text-sm tracking-wide font-mono">${card.expiry}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-0 left-0 h-1 bg-red-500 transition-all duration-1000" style="width: ${progress}%"></div>
                `;

                    el.onclick = () => window.selectCard(card.id);
                    container.appendChild(el);
                });

                // Toplamları Güncelle
                document.getElementById('wallet-total-limit').innerText = totalLimit.toLocaleString('tr-TR') + ' ₺';
                const totalAvail = totalLimit - totalDebt;
                document.getElementById('wallet-total-balance').innerText = totalAvail.toLocaleString('tr-TR') + ' ₺';

                // 3D Premium Kart UI Güncelleme
                const mainCard = document.getElementById('wallet-main-card');
                const noCard = document.getElementById('wallet-no-card');
                const usageBar = document.getElementById('wallet-usage-bar');
                const usageText = document.getElementById('wallet-usage-text');
                const remainingAmount = document.getElementById('wallet-remaining-amount');
                const limitMax = document.getElementById('wallet-limit-max');

                if (window.cards.length > 0) {
                    const firstCard = window.cards[0];
                    const cardLimit = parseFloat(firstCard.limit || 0);
                    const cardDebt = parseFloat(firstCard.debt || 0);
                    const cardAvail = cardLimit - cardDebt;
                    const usagePercent = cardLimit > 0 ? Math.round((cardDebt / cardLimit) * 100) : 0;

                    // Kartı göster, boş durumu gizle
                    if (mainCard) mainCard.style.display = 'flex';
                    if (noCard) noCard.style.display = 'none';

                    // Kart bilgilerini güncelle
                    const cardBank = document.getElementById('wallet-card-bank');
                    const cardName = document.getElementById('wallet-card-name');
                    const cardNumber = document.getElementById('wallet-card-number');
                    const cardLimitEl = document.getElementById('wallet-card-limit');
                    const cardRemaining = document.getElementById('wallet-card-remaining');
                    const cardNetwork = document.getElementById('wallet-card-network');

                    if (cardBank) cardBank.textContent = firstCard.bank || 'Banka';
                    if (cardName) cardName.textContent = (firstCard.holder || 'Kart Sahibi').toUpperCase();
                    if (cardNumber) cardNumber.textContent = '•••• •••• •••• ' + (firstCard.last4 || '••••');
                    if (cardLimitEl) cardLimitEl.textContent = cardLimit.toLocaleString('tr-TR') + ' ₺';
                    if (cardRemaining) cardRemaining.textContent = cardAvail.toLocaleString('tr-TR') + ' ₺';
                    if (cardNetwork) cardNetwork.innerHTML = `<span class="text-white/80 text-xs font-bold">${(firstCard.network || 'VISA').toUpperCase()}</span>`;

                    // Limit göstergesini güncelle
                    if (usageBar) usageBar.style.width = usagePercent + '%';
                    if (usageText) usageText.textContent = usagePercent + '%';
                    if (remainingAmount) remainingAmount.textContent = cardAvail.toLocaleString('tr-TR') + ' ₺';
                    if (limitMax) limitMax.textContent = cardLimit.toLocaleString('tr-TR') + ' ₺';
                } else {
                    // Kartı gizle, boş durumu göster
                    if (mainCard) mainCard.style.display = 'none';
                    if (noCard) noCard.style.display = 'flex';

                    // Limit göstergesini sıfırla
                    if (usageBar) usageBar.style.width = '0%';
                    if (usageText) usageText.textContent = '0%';
                    if (remainingAmount) remainingAmount.textContent = '0 ₺';
                    if (limitMax) limitMax.textContent = '0 ₺';
                }

                // İlk kartı seç
                if (window.cards.length > 0) {
                    window.selectCard(window.cards[0].id);
                }
            };

            // 2. Kart Seçimi ve Hesap Özeti
            window.selectCard = function (cardId) {
                const card = window.cards.find(c => c.id === cardId);
                if (!card) return;

                // Hesaplamalar
                const limit = parseFloat(card.limit || 0);
                const debt = parseFloat(card.debt || 0);
                const available = limit - debt;

                // Kesim Tarihi Hesaplama
                const today = new Date();
                const cutoffDay = parseInt(card.cutoff || 1);
                let nextCutoff = new Date(today.getFullYear(), today.getMonth(), cutoffDay);
                if (today.getDate() > cutoffDay) {
                    nextCutoff.setMonth(nextCutoff.getMonth() + 1);
                }
                const daysLeft = Math.ceil((nextCutoff - today) / (1000 * 60 * 60 * 24));

                // Kart Listesini Güncelle (Seçilen en üste gelsin)
                const cardIdx = window.cards.findIndex(c => c.id === cardId);
                if (cardIdx > 0) {
                    const selected = window.cards.splice(cardIdx, 1)[0];
                    window.cards.unshift(selected);
                    window.loadCards(); // Yeniden render et (Stack animasyonu için)
                    return; // Fonksiyon yeniden çalışacak
                }

                // İşlemleri Listele
                const list = document.getElementById('wallet-transactions-list');
                list.innerHTML = `
                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-xl mb-3 flex justify-between items-center border border-indigo-100 dark:border-indigo-800/50">
                    <div>
                        <p class="text-[10px] text-gray-500 dark:text-gray-400">Hesap Kesimine</p>
                        <p class="text-sm font-bold text-indigo-600 dark:text-indigo-400">${daysLeft} Gün Kaldı</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-gray-500 dark:text-gray-400">Güncel Borç</p>
                        <p class="text-sm font-black text-gray-800 dark:text-white">${debt.toLocaleString('tr-TR')} ₺</p>
                    </div>
                </div>
            `;

                // Dummy İşlemler (Gerçek veride kart ID ile eşleşmeli)
                const cardTrans = window.transactions.filter(t => t.description.toLowerCase().includes(card.bank.toLowerCase()));
                if (cardTrans.length === 0) {
                    list.insertAdjacentHTML('beforeend', '<p class="text-center text-xs text-gray-400 py-4">Bu dönem işlem yok.</p>');
                } else {
                    cardTrans.slice(0, 5).forEach(t => {
                        list.insertAdjacentHTML('beforeend', `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-white/5 rounded-xl border border-gray-100 dark:border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-sm">${t.category.substring(0, 2)}</div>
                                <div>
                                    <p class="text-xs font-bold text-gray-800 dark:text-white">${t.category}</p>
                                    <p class="text-[9px] text-gray-500">${t.date}</p>
                                </div>
                            </div>
                            <p class="text-xs font-black text-red-500">-${parseFloat(t.amount).toLocaleString('tr-TR')}₺</p>
                        </div>
                    `);
                    });
                }
            };

            // 3. Kart Önizleme & Premium Kontrolü
            window.updateCardPreview = () => {
                const theme = document.getElementById('card-color-theme').value;
                const isPro = localStorage.getItem('user_status') === 'pro';
                const premiumThemes = ['gold', 'metal', 'neon'];

                // Premium Kilit Kontrolü
                if (premiumThemes.includes(theme) && !isPro) {
                    window.alertMessage("Premium Özellik", "Bu özel kart tasarımı sadece PRO üyeler içindir! 👑", "purple");
                    document.getElementById('card-color-theme').value = 'black'; // Geri al
                    return;
                }

                const bank = document.getElementById('card-bank-name').value || 'BANKA ADI';
                const holder = document.getElementById('card-holder').value || 'AD SOYAD';
                const last4 = document.getElementById('card-last4').value || '****';
                const expiry = document.getElementById('card-expiry').value || 'AA/YY';
                const network = document.getElementById('card-network').value;

                document.getElementById('preview-bank').innerText = bank;
                document.getElementById('preview-holder').innerText = holder;
                document.getElementById('preview-number').innerText = `**** **** **** ${last4}`;
                document.getElementById('preview-expiry').innerText = expiry;

                const card = document.getElementById('card-preview');
                card.className = `mb-6 relative h-48 w-full rounded-2xl p-6 shadow-2xl flex flex-col justify-between text-white transform transition-all duration-500 border border-white/10`;

                // Temizle
                card.innerHTML = '';

                let bgClass = "bg-neutral-900";
                let texture = '<div class="texture-carbon absolute inset-0"></div>';
                let textColor = "text-white";

                if (theme === 'blue') { bgClass = "bg-gradient-to-br from-blue-700 to-indigo-900"; texture = '<div class="texture-metal absolute inset-0 opacity-30"></div>'; }
                else if (theme === 'gold') { bgClass = "texture-gold"; textColor = "text-yellow-900"; texture = ''; }
                else if (theme === 'metal') { bgClass = "bg-gradient-to-br from-gray-300 to-gray-500"; textColor = "text-gray-800"; texture = '<div class="texture-metal absolute inset-0 mix-blend-color-dodge"></div>'; }
                else if (theme === 'neon') { bgClass = "bg-black border-2 border-purple-500"; texture = '<div class="absolute inset-0 bg-gradient-to-r from-transparent via-purple-900/40 to-transparent animate-pulse"></div>'; }

                card.classList.add(...bgClass.split(' '));
                if (textColor) card.classList.add(textColor);

                const networkLogo = network === 'mastercard'
                    ? '<div class="flex"><div class="w-8 h-8 rounded-full bg-red-500/90 mix-blend-hard-light"></div><div class="w-8 h-8 rounded-full bg-yellow-500/90 mix-blend-hard-light -ml-4"></div></div>'
                    : '<h3 class="font-black italic text-2xl">VISA</h3>';

                card.innerHTML = `
                ${texture}
                <div class="relative z-10 flex justify-between items-start">
                    <span class="font-bold tracking-widest text-xl opacity-90">${bank}</span>
                    ${networkLogo}
                </div>
                <div class="relative z-10 mt-auto">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="card-chip w-10 h-8 shadow-sm"></div>
                        <svg class="w-6 h-6 opacity-60 rotate-90" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" opacity=".3"/><path d="M12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6 6-2.69 6 6 6z" opacity=".5"/><path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6-6 6 2.69 6 6-2.69 6 6 6z"/></svg>
                    </div>
                    <div class="text-2xl font-mono tracking-[0.15em] mb-2 shadow-black drop-shadow-sm">**** **** **** ${last4}</div>
                    <div class="flex justify-between items-end">
                        <p class="font-bold text-sm tracking-wide uppercase opacity-90">${holder}</p>
                        <p class="font-bold text-sm tracking-wide font-mono">${expiry}</p>
                    </div>
                </div>
            `;
            };

            // 4. Yeni Kart Kaydet (Güncellendi)
            window.saveNewCard = () => {
                const bank = document.getElementById('card-bank-name').value;
                const limit = window.parseSimpleCurrency(document.getElementById('card-limit').value);
                const debt = window.parseSimpleCurrency(document.getElementById('card-debt').value);

                if (!bank || !limit) {
                    window.alertMessage("Eksik Bilgi", "Lütfen banka adı ve limit giriniz.", "red");
                    return;
                }

                const newCard = {
                    id: Date.now().toString(),
                    bank: bank,
                    type: document.getElementById('card-type').value,
                    network: document.getElementById('card-network').value,
                    theme: document.getElementById('card-color-theme').value,
                    holder: document.getElementById('card-holder').value,
                    last4: document.getElementById('card-last4').value,
                    expiry: document.getElementById('card-expiry').value,
                    limit: limit,
                    debt: debt || 0, // Yeni Alan
                    cutoff: document.getElementById('card-cutoff').value || 1, // Yeni Alan
                    dateAdded: new Date()
                };

                window.cards.push(newCard);
                localStorage.setItem('my_cards_v1', JSON.stringify(window.cards));

                window.loadCards();
                window.closeAddCardModal();
                window.alertMessage("Başarılı", "Kart cüzdanınıza eklendi! 🎉", "green");
            };

            /* --- EKSİK MODAL FONKSİYONLARI --- */

            /* --- 3D WALLET KART FONKSİYONLARI --- */

            // 3D Kart Tilt Efekti
            window.tiltCard = function (event, card) {
                const rect = card.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                const rotateX = (y - centerY) / 10;
                const rotateY = (centerX - x) / 10;

                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
            };

            // Kart Tilt Sıfırlama
            window.resetCardTilt = function (card) {
                card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)';
            };

            // Kart Dondurma
            window.freezeCard = function () {
                const cards = JSON.parse(localStorage.getItem('wallet_cards') || '[]');
                if (cards.length === 0) {
                    window.alertMessage("Uyarı", "Önce bir kart eklemelisiniz.", "yellow");
                    return;
                }
                window.alertMessage("Bilgi", "Kart dondurma özelliği yakında aktif olacak!", "blue");
            };

            // Kart Düzenleme
            window.editCard = function () {
                const cards = JSON.parse(localStorage.getItem('wallet_cards') || '[]');
                if (cards.length === 0) {
                    window.alertMessage("Uyarı", "Düzenlenecek kart bulunamadı.", "yellow");
                    return;
                }
                window.openAddCardModal();
            };

            // Ekstre Gösterme
            window.showCardStatement = function () {
                const cards = JSON.parse(localStorage.getItem('wallet_cards') || '[]');
                if (cards.length === 0) {
                    window.alertMessage("Uyarı", "Önce bir kart eklemelisiniz.", "yellow");
                    return;
                }
                window.alertMessage("Bilgi", "Ekstre hesaplama özelliği yakında aktif olacak!", "blue");
            };

            // Kart Silme
            window.deleteCard = async function () {
                const cards = JSON.parse(localStorage.getItem('wallet_cards') || '[]');
                if (cards.length === 0) {
                    window.alertMessage("Uyarı", "Silinecek kart bulunamadı.", "yellow");
                    return;
                }
                const confirmed = await window.confirmDialog({
                    title: "Kart Silme",
                    message: "Bu kartı silmek istediğinizden emin misiniz?",
                    confirmText: "Sil",
                    cancelText: "Vazgeç",
                    variant: "red"
                });
                if (confirmed) {
                    localStorage.setItem('wallet_cards', '[]');
                    window.loadCards();
                    window.alertMessage("Başarılı", "Kart silindi.", "green");
                }
            };

            // Modalı Açma Fonksiyonu
            window.openAddCardModal = function () {
                const modal = document.getElementById('add-card-modal');
                if (modal) {
                    modal.classList.remove('hidden');

                    // Formu Sıfırla
                    const inputs = ['card-bank-name', 'card-holder', 'card-last4', 'card-expiry', 'card-limit', 'card-debt'];
                    inputs.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });

                    // Önizlemeyi Güncelle
                    if (window.updateCardPreview) window.updateCardPreview();
                }
            };

            // Modalı Kapatma Fonksiyonu
            window.closeAddCardModal = function () {
                const modal = document.getElementById('add-card-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            };

            // Initial Startup Call
            document.addEventListener('DOMContentLoaded', () => { setTimeout(window.loadCards, 1000); });

            // ========== FINGO AUTOPILOT FUNCTIONS ==========

            // Döviz Kurları (Varsayılan değerler - canlı API ile güncellenebilir)
            window.exchangeRates = {
                TRY: 1,
                USD: 34.50,
                EUR: 37.20,
                GBP: 43.80
            };

            // Autopilot Başlatma
            // === FINGO AUTOPILOT V2.0 PREMIUM ENGINE ===

            // 1. Sekme Yönetimi
            window.switchAutopilotTab = function (tabName) {
                ['pulse', 'dna', 'ailab'].forEach(t => {
                    const tab = document.getElementById(`autopilot-tab-${t}`);
                    const btn = document.getElementById(`tab-btn-${t}`);
                    if (tab) tab.classList.add('hidden');
                    if (btn) {
                        btn.classList.remove('bg-white', 'dark:bg-white/10', 'text-indigo-600', 'dark:text-white', 'shadow-sm', 'font-black');
                        btn.classList.add('text-gray-500', 'dark:text-gray-400', 'font-bold');
                    }
                });

                const targetTab = document.getElementById(`autopilot-tab-${tabName}`);
                const targetBtn = document.getElementById(`tab-btn-${tabName}`);

                if (targetTab) targetTab.classList.remove('hidden');
                if (targetBtn) {
                    targetBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'font-bold');
                    targetBtn.classList.add('bg-white', 'dark:bg-white/10', 'text-indigo-600', 'dark:text-white', 'shadow-sm', 'font-black');
                }

                if (tabName === 'dna') setTimeout(window.renderRadarChart, 100);
                if (tabName === 'pulse') setTimeout(window.renderBurnRateChart, 100);
            }

            // 2. Fingo Brain Analitik Motoru (Init)
            window.initAutopilot = function () {
                // Premium Gate
                const gate = document.getElementById('autopilot-premium-gate');
                const isPro = localStorage.getItem('user_status') === 'pro';
                if (gate) {
                    if (!isPro) gate.classList.remove('hidden');
                    else gate.classList.add('hidden');
                }

                // Mevcut Lojiği Tetikle
                window.updateBudgetStatus();
                window.getUpcomingPayments();
                window.calculateCashFlow();
                window.convertCurrency();
                window.calculateLoan();

                // Yeni V2 Lojiği
                window.switchAutopilotTab('pulse');
                setTimeout(() => {
                    window.calculateFingoBrainPrediction();
                    window.typeWriterAdvice();
                }, 500);
            };

            // 3. Fingo Score & Linear Regression & Volatility
            window.calculateFingoBrainPrediction = function () {
                const tx = window.transactions || [];
                if (tx.length === 0) return;

                // --- A. VOLATİLİTE HESABI (Risk Endeksi) ---
                const dailySpending = {};
                const days = 30;
                const now = new Date();

                for (let i = 0; i < days; i++) {
                    const d = new Date(); d.setDate(now.getDate() - i);
                    const dayKey = d.toISOString().split('T')[0];
                    dailySpending[dayKey] = 0;
                }

                tx.forEach(t => {
                    if (t.type === 'expense') {
                        const d = t.date.split('.').reverse().join('-');
                        if (dailySpending[d] !== undefined) dailySpending[d] += parseFloat(t.amount);
                    }
                });

                const values = Object.values(dailySpending);
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                const stdDev = Math.sqrt(variance);

                const volEl = document.getElementById('prediction-volatility');
                if (volEl) {
                    if (stdDev > 500) { volEl.innerHTML = "Yüksek ⚡"; volEl.className = "text-lg font-black text-red-500"; }
                    else if (stdDev > 200) { volEl.innerHTML = "Orta ⚖️"; volEl.className = "text-lg font-black text-yellow-500"; }
                    else { volEl.innerHTML = "Düşük 🛡️"; volEl.className = "text-lg font-black text-emerald-500"; }
                }

                // --- B. LINEAR REGRESSION (Tahmini Bakİye) ---
                const currentBalance = window.parseSimpleCurrency(document.getElementById('display-balance')?.innerText);
                const daysLeft = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate() - now.getDate();
                const predictedBurn = mean * daysLeft; // Basit projeksiyon
                const estimatedFinal = currentBalance - predictedBurn;

                const predEl = document.getElementById('prediction-balance');
                if (predEl) {
                    predEl.innerText = estimatedFinal.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';
                    predEl.className = estimatedFinal > 0 ? "text-lg font-black text-emerald-600 dark:text-emerald-400" : "text-lg font-black text-red-600 dark:text-red-400";
                }

                // --- C. FINGO SCORE ---
                let score = 700;
                if (stdDev < 200) score += 50; // Düşük volatilite ödülü
                if (estimatedFinal > 0) score += 100; // Pozitif kapanış ödülü
                if (mean < 200) score += 50; // Tutumluluk ödülü
                score = Math.min(900, Math.max(300, score)); // 300-900 arası sınırla

                const scoreVal = document.getElementById('fingo-score-val');
                const scoreCirc = document.getElementById('fingo-score-circle');

                if (scoreVal) {
                    let start = 0; const duration = 1000;
                    const animate = (timestamp) => {
                        if (!start) start = timestamp;
                        const progress = timestamp - start;
                        const val = Math.min(Math.floor((progress / duration) * score), score) || score;
                        scoreVal.innerText = val;
                        if (progress < duration) requestAnimationFrame(animate);
                    };
                    requestAnimationFrame(animate);
                }

                if (scoreCirc) {
                    const offset = 175 - (175 * (score / 900));
                    setTimeout(() => scoreCirc.style.strokeDashoffset = offset, 100);

                    scoreCirc.classList.remove('text-emerald-500', 'text-indigo-500', 'text-orange-500');
                    if (score > 800) scoreCirc.classList.add('text-emerald-500');
                    else if (score > 600) scoreCirc.classList.add('text-indigo-500');
                    else scoreCirc.classList.add('text-orange-500');
                }
            }

            // 4. Burn Rate Grafiği (Chart.js)
            window.renderBurnRateChart = function () {
                const canvas = document.getElementById('burnRateChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                if (window.burnChartInstance) window.burnChartInstance.destroy();

                const labels = [];
                const data = [];
                const currentBalance = window.parseSimpleCurrency(document.getElementById('display-balance')?.innerText);

                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); d.setDate(new Date().getDate() - i);
                    labels.push(d.toLocaleDateString('tr-TR', { weekday: 'short' }));
                    // Geriye dönük simülasyon
                    data.push(currentBalance + (i * 150) + (Math.random() * 50));
                }

                window.burnChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tahmini Bakiye',
                            data: data,
                            borderColor: '#6366f1',
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
                                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');
                                return gradient;
                            },
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#6366f1',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#9ca3af' } },
                            y: { display: false }
                        }
                    }
                });
            }

            // 5. Radar Chart (DNA) - PREMIUM VERSION
            window.renderRadarChart = function () {
                const canvas = document.getElementById('radarChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                if (window.radarChartInstance) window.radarChartInstance.destroy();

                // Genişletilmiş kategori eşleştirmesi
                const categoryConfig = {
                    'Market': { emoji: '🛒', color: '#10b981', keywords: ['Market', 'Gıda', 'Bakkal', 'Süpermarket'] },
                    'Fatura': { emoji: '🧾', color: '#f59e0b', keywords: ['Fatura', 'Kira', 'Elektrik', 'Su', 'Doğalgaz', 'İnternet'] },
                    'Ulaşım': { emoji: '🚌', color: '#3b82f6', keywords: ['Ulaşım', 'Benzin', 'Metro', 'Otobüs', 'Taksi'] },
                    'Eğlence': { emoji: '🎬', color: '#ec4899', keywords: ['Sinema', 'Oyun', 'Netflix', 'Spotify', 'Eğlence'] },
                    'Giyim': { emoji: '👕', color: '#8b5cf6', keywords: ['Giyim', 'Ayakkabı', 'Aksesuar'] },
                    'Sağlık': { emoji: '💊', color: '#ef4444', keywords: ['Sağlık', 'İlaç', 'Hastane', 'Doktor'] },
                    'Eğitim': { emoji: '🎓', color: '#06b6d4', keywords: ['Eğitim', 'Kitap', 'Kurs'] },
                    'Diğer': { emoji: '📦', color: '#6b7280', keywords: [] }
                };

                const cats = {};
                Object.keys(categoryConfig).forEach(c => cats[c] = 0);

                const txns = window.transactions || [];
                txns.forEach(t => {
                    if (t.type === 'expense') {
                        let matched = false;
                        const catName = (t.category || '').toLowerCase();

                        for (const [key, config] of Object.entries(categoryConfig)) {
                            if (key !== 'Diğer' && config.keywords.some(k => catName.includes(k.toLowerCase()))) {
                                cats[key] += parseFloat(t.amount);
                                matched = true;
                                break;
                            }
                        }
                        if (!matched) cats['Diğer'] += parseFloat(t.amount);
                    }
                });

                // Sıfır olmayan kategorileri filtrele
                const activeCats = Object.entries(cats).filter(([k, v]) => v > 0);
                const maxVal = Math.max(...Object.values(cats)) || 1;
                const totalExpense = Object.values(cats).reduce((a, b) => a + b, 0);

                // Baskın kategori
                let dominantCat = 'Yok';
                let dominantVal = 0;
                Object.entries(cats).forEach(([k, v]) => {
                    if (v > dominantVal) {
                        dominantVal = v;
                        dominantCat = k;
                    }
                });

                // Çeşitlilik skoru hesapla (Shannon entropy based)
                let diversityScore = 0;
                if (totalExpense > 0) {
                    let entropy = 0;
                    Object.values(cats).forEach(v => {
                        if (v > 0) {
                            const p = v / totalExpense;
                            entropy -= p * Math.log2(p);
                        }
                    });
                    const maxEntropy = Math.log2(Object.keys(cats).length);
                    diversityScore = Math.round((entropy / maxEntropy) * 100);
                }

                // UI güncellemeleri
                const dominantEl = document.getElementById('dna-dominant-cat');
                const totalCatsEl = document.getElementById('dna-total-cats');
                const diversityEl = document.getElementById('dna-diversity-score');

                if (dominantEl) dominantEl.textContent = dominantCat;
                if (totalCatsEl) totalCatsEl.textContent = activeCats.length;
                if (diversityEl) diversityEl.textContent = diversityScore + '%';

                // --- 1. SPENDING PERSONALITY ALGORITHM ---
                // Kategorileri grupla
                const groups = {
                    'invest': ['Yatırım', 'Birikim', 'Altın', 'Döviz', 'Hisse'],
                    'needs': ['Market', 'Fatura', 'Ulaşım', 'Sağlık', 'Eğitim', 'Kira', 'Aidat', 'Mutfak'],
                    'wants': ['Eğlence', 'Giyim', 'Yeme-İçme', 'Teknoloji', 'Tatil', 'Hobi', 'Kozmetik', 'Restoran', 'Kafe']
                };

                let sumInvest = 0, sumNeeds = 0, sumWants = 0;

                Object.entries(cats).forEach(([cat, amount]) => {
                    let found = false;
                    if (groups.invest.some(k => cat.includes(k))) { sumInvest += amount; found = true; }
                    else if (groups.needs.some(k => cat.includes(k))) { sumNeeds += amount; found = true; }
                    else if (groups.wants.some(k => cat.includes(k))) { sumWants += amount; found = true; }

                    if (!found) {
                        // Emojiye gore tahmin (Basit heuristic)
                        const conf = categoryConfig[cat];
                        if (conf) {
                            if (['🛒', '🧾', '🚌', '💊', '🎓', '🏠'].includes(conf.emoji)) sumNeeds += amount;
                            else if (['🎬', '👕', '✈️', '🍔', '☕', '💄'].includes(conf.emoji)) sumWants += amount;
                            else sumWants += amount; // Varsayılan wants
                        } else {
                            sumWants += amount;
                        }
                    }
                });

                const grandTotal = sumInvest + sumNeeds + sumWants || 1;
                const investRatio = sumInvest / grandTotal;
                const needsRatio = sumNeeds / grandTotal;
                const wantsRatio = sumWants / grandTotal;

                let personaTitle = "Analiz Ediliyor";
                let personaDesc = "Verilerin işleniyor.";
                let personaIcon = "✨";
                let personaGradient = "from-indigo-600 via-purple-600 to-violet-600";

                if (txns.length < 5) {
                    personaTitle = "Yeni Başlayan 🌱";
                    personaDesc = "Henüz yeterli veri yok. Harcamaya devam et!";
                    personaIcon = "🌱";
                    personaGradient = "from-emerald-500 to-teal-500";
                } else if (investRatio > 0.15) {
                    personaTitle = "Gelecek Mimarı 🏰";
                    personaDesc = `Gelirinin %${Math.round(investRatio * 100)}'ini geleceğe ayırıyorsun. Harika bir strateji!`;
                    personaIcon = "🏰";
                    personaGradient = "from-emerald-600 via-teal-600 to-cyan-600";
                } else if (wantsRatio > 0.55) {
                    personaTitle = "Keyif Gurmesi 🎉";
                    personaDesc = "Hayatın tadını çıkarmayı seviyorsun, ama dengeye dikkat!";
                    personaIcon = "🎉";
                    personaGradient = "from-pink-600 via-rose-600 to-red-600";
                } else if (needsRatio > 0.70) {
                    personaTitle = "Sorumluluk Sahibi 👔";
                    personaDesc = "Harcamalarının çoğu temel ihtiyaçlarına gidiyor. Oldukça planlısın.";
                    personaIcon = "👔";
                    personaGradient = "from-blue-600 via-indigo-600 to-blue-800";
                } else {
                    personaTitle = "Denge Ustası ⚖️";
                    personaDesc = "İhtiyaç ve isteklerin arasında mükemmel bir denge kurmuşsun.";
                    personaIcon = "⚖️";
                    personaGradient = "from-violet-600 via-fuchsia-600 to-purple-600";
                }

                // Render Persona
                const pCard = document.getElementById('dna-personality-card');
                const pTitle = document.getElementById('dna-persona-title');
                const pDesc = document.getElementById('dna-persona-desc');
                const pIcon = document.getElementById('dna-persona-icon');

                if (pCard) pCard.className = `relative overflow-hidden rounded-3xl p-6 bg-gradient-to-br ${personaGradient} text-white shadow-xl shadow-indigo-500/20 card-lift`;
                if (pTitle) pTitle.innerText = personaTitle;
                if (pDesc) pDesc.innerText = personaDesc;
                if (pIcon) pIcon.innerText = personaIcon;


                // --- 2. MONTH COMPARISON ---
                const now = new Date();
                const last30Sums = {};
                const prev30Sums = {};
                let totalLast30 = 0;
                let totalPrev30 = 0;

                txns.forEach(t => {
                    if (t.type === 'expense') {
                        const txDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                        const daysDiff = (now - txDate) / (1000 * 60 * 60 * 24);
                        const amt = parseFloat(t.amount);

                        if (daysDiff <= 30) {
                            totalLast30 += amt;
                        } else if (daysDiff <= 60) {
                            totalPrev30 += amt;
                        }
                    }
                });

                const compEl = document.getElementById('dna-month-comparison');
                if (compEl) {
                    if (totalPrev30 === 0) {
                        compEl.innerHTML = `<h3 class="text-lg font-black text-gray-900 dark:text-white">Veri Yok</h3>`;
                    } else {
                        const diff = totalLast30 - totalPrev30;
                        const pct = Math.round((Math.abs(diff) / totalPrev30) * 100);
                        const isLess = diff < 0;

                        compEl.innerHTML = `
                        <h3 class="text-lg font-black text-gray-900 dark:text-white">%${pct} ${isLess ? 'Daha Az' : 'Daha Fazla'}</h3>
                        <span class="text-xs font-bold px-2 py-0.5 rounded-full ${isLess ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400'}">
                            ${isLess ? '📉 Tasarruf' : '📈 Artış'}
                        </span>
                    `;
                    }
                }


                // --- 3. RENDER CATEGORY LIST (Interactive) ---
                const catListEl = document.getElementById('dna-category-list');
                if (catListEl) {
                    const sorted = Object.entries(cats).filter(([k, v]) => v > 0).sort((a, b) => b[1] - a[1]);
                    let listHtml = '';

                    sorted.forEach(([cat, val], idx) => {
                        const conf = categoryConfig[cat];
                        const pct = totalExpense > 0 ? Math.round((val / totalExpense) * 100) : 0;
                        const barColor = conf.color || '#6366f1';

                        listHtml += `
                     <div onclick="window.openCategoryDetailModal('${cat}')" class="group flex items-center justify-between p-3 rounded-2xl hover:bg-gray-50 dark:hover:bg-white/5 cursor-pointer transition-all active:scale-[0.98]">
                        <div class="flex items-center gap-3 w-full">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg shadow-sm" style="background: ${barColor}20; color: ${barColor}">
                                ${conf.emoji}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="text-sm font-bold text-gray-900 dark:text-white truncate">${cat}</p>
                                    <p class="text-sm font-bold text-gray-900 dark:text-white">${window.formatTRY ? window.formatTRY(val) : val.toFixed(0) + '₺'}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-full h-1.5 bg-gray-100 dark:bg-gray-700/50 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full" style="width: ${pct}%; background: ${barColor}"></div>
                                    </div>
                                    <span class="text-[10px] font-bold text-gray-400 w-8 text-right">%${pct}</span>
                                </div>
                            </div>
                            <div class="text-gray-300 group-hover:text-indigo-500 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </div>
                     </div>`;
                    });

                    catListEl.innerHTML = listHtml || '<div class="text-center text-gray-400 py-4">İşlem yok</div>';
                }


                // --- 4. RENDER PREMIUM RADAR CHART ---
                const labels = Object.keys(cats);
                const dataPoints = Object.values(cats).map(v => (v / maxVal) * 100);

                // Gradient oluştur
                const gradient = ctx.createRadialGradient(canvas.width / 2, canvas.height / 2, 0, canvas.width / 2, canvas.height / 2, 100);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); // Indigo Center
                gradient.addColorStop(1, 'rgba(139, 92, 246, 0.1)'); // Purple Outer

                window.radarChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Harcama DNA',
                            data: dataPoints,
                            backgroundColor: gradient,
                            borderColor: '#818cf8',
                            borderWidth: 2,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#6366f1',
                            pointBorderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#6366f1',
                            pointHoverBorderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                angleLines: { color: 'rgba(156, 163, 175, 0.1)' }, // Subtle Grid
                                grid: { color: 'rgba(156, 163, 175, 0.1)', circular: true },
                                pointLabels: {
                                    color: (ctx) => {
                                        // Highlight labels with high values
                                        const val = dataPoints[ctx.index];
                                        return val > 50 ? '#6366f1' : '#9ca3af';
                                    },
                                    font: { size: 10, weight: '700', family: 'Inter' },
                                    callback: (label) => {
                                        const config = categoryConfig[label];
                                        return config ? `${config.emoji} ${label}` : label;
                                    }
                                },
                                ticks: { display: false, backdropColor: 'transparent' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(17, 24, 39, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#e5e7eb',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                padding: 10,
                                cornerRadius: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function (ctx) {
                                        const catName = labels[ctx.dataIndex];
                                        const amount = cats[catName];
                                        return `${window.formatTRY ? window.formatTRY(amount) : amount.toFixed(0) + ' ₺'}`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeOutElastic'
                        }
                    }
                });
            }


            // 6. Abonelik Dedektifi - Enhanced with Mark Button
            window.__detectedSubscriptions = []; // Global storage

            window.detectSubscriptions = function (txData) {
                const listEl = document.getElementById('subscription-list');
                if (!listEl) return;

                const groups = {};
                txData.forEach(t => {
                    if (t.type === 'expense') {
                        const key = (t.description || t.category).trim();
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(t);
                    }
                });

                // Global listeye kaydet
                window.__detectedSubscriptions = [];
                let html = '';
                let found = false;
                let idx = 0;

                Object.keys(groups).forEach(key => {
                    const items = groups[key];
                    if (items.length >= 2) { // Basit kural: Aynı isimle 2+ işlem
                        found = true;
                        // Ortalama tutar
                        const avg = items.reduce((a, b) => a + parseFloat(b.amount), 0) / items.length;
                        // Son görülme tarihi
                        const lastSeen = items[items.length - 1].date || items[items.length - 1].timestamp;
                        // Kategori tahmini
                        const category = items[0].category || '🍿 Eğlence';

                        // Global listeye ekle
                        window.__detectedSubscriptions.push({
                            name: key,
                            amount: Math.round(avg),
                            category: category,
                            lastSeen: lastSeen,
                            count: items.length
                        });

                        // Recurring rule var mı kontrol et
                        const existingRules = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');
                        const alreadyMarked = existingRules.some(r => r.source === 'subscription' && r.sourceId === key.toLowerCase().trim());

                        html += `
                    <div class="glass-card p-3 rounded-xl flex items-center justify-between border border-white/5 animate-fade-in-up">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full ${alreadyMarked ? 'bg-green-100 dark:bg-green-900/20 text-green-500' : 'bg-red-100 dark:bg-red-900/20 text-red-500'} flex items-center justify-center text-xs font-bold">${alreadyMarked ? '✓' : '↻'}</div>
                            <div>
                                <p class="text-xs font-bold text-gray-800 dark:text-gray-200">${key}</p>
                                <p class="text-[10px] text-gray-500">${items.length} işlem tespit edildi</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <p class="font-black text-red-500 text-xs">~${avg.toFixed(0)}₺</p>
                            ${alreadyMarked
                                ? '<span class="px-2 py-1 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 text-[9px] font-bold">Aktif</span>'
                                : `<button onclick="window.markSubscription(${idx})" class="px-2 py-1 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 text-[9px] font-bold hover:bg-indigo-200 dark:hover:bg-indigo-800/40 transition">İşaretle ✓</button>`
                            }
                        </div>
                    </div>`;
                        idx++;
                    }
                });

                if (!found) html = `<div class="p-8 text-center text-gray-400 text-xs">Düzenli ödeme bulunamadı.</div>`;
                listEl.innerHTML = html;
            }

            // 6b. Abonelik İşaretleme - Recurring Rule Oluştur
            window.markSubscription = function (idx) {
                const sub = window.__detectedSubscriptions[idx];
                if (!sub) return;

                const currentMonthStr = new Date().toISOString().slice(0, 7);
                const ruleId = 'sub_rule_' + sub.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();

                // Zaten var mı kontrol et
                recurringRules = JSON.parse(localStorage.getItem(`my_recurring_rules_${APP_YEAR}`) || '[]');
                const existing = recurringRules.find(r => r.id === ruleId);
                if (existing) {
                    window.alertMessage("Bilgi", `"${sub.name}" zaten otomatik gider olarak ayarlanmış.`, "blue");
                    return;
                }

                // Gün hesapla
                let subDay = 1;
                if (sub.lastSeen) {
                    try {
                        const lastDate = new Date(sub.lastSeen);
                        subDay = clampDay(lastDate.getDate());
                    } catch (e) { subDay = 1; }
                }

                const newRule = {
                    id: ruleId,
                    type: 'expense',
                    amount: sub.amount,
                    category: sub.category || '🍿 Eğlence',
                    description: (sub.name || '').toString().trim(),
                    day: subDay,
                    lastExecutedMonth: currentMonthStr, // Bu ay hemen eklemesin
                    source: 'subscription',
                    sourceId: sub.name.toLowerCase().trim()
                };

                recurringRules.push(newRule);
                localStorage.setItem(`my_recurring_rules_${APP_YEAR}`, JSON.stringify(recurringRules));

                // Bildirimler
                window.showMiniToast("Abonelik Otomatiği Açık", `Her ayın ${subDay}. günü otomatik gider eklenecek.`, "🧾");
                window.alertMessage('Abonelik', `"${sub.name}" artık otomatik gider olarak eklenecek. ✅`, 'green');

                // UI'ı yenile
                window.detectSubscriptions(window.transactions || []);
            }

            // 7. Typewriter Effect
            window.typeWriterAdvice = function () {
                const el = document.getElementById('fingo-insight-text');
                if (!el) return;

                const msgs = [
                    "Harcamaların geçen aya göre daha dengeli. 👍",
                    "Fingo Score'un yükselişte! Finansal sağlığın iyi gidiyor. 🚀",
                    "Volatilite düşük, nakit akışın stabil görünüyor. 🛡️"
                ];
                const text = msgs[Math.floor(Math.random() * msgs.length)];
                el.innerText = text;
            }

            // 8. Tool Scroll Helper
            window.scrollToTools = function (toolId) {
                const t = document.getElementById('tool-' + toolId);
                if (t) {
                    t.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    t.classList.add('ring-2', 'ring-indigo-500');
                    setTimeout(() => t.classList.remove('ring-2', 'ring-indigo-500'), 1500);
                }
            }

            // 1. BÜTÇE DURUMU GÜNCELLEME
            window.updateBudgetStatus = function () {
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                // Bugünkü harcamalar
                const todayExpenses = transactions.filter(t => {
                    const tDate = new Date(t.date.split('.').reverse().join('-'));
                    return tDate.toISOString().split('T')[0] === todayStr && t.type === 'expense';
                }).reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

                // Aylık ortalama harcama
                const monthExpenses = transactions.filter(t => {
                    const tDate = new Date(t.date.split('.').reverse().join('-'));
                    return tDate.getMonth() === today.getMonth() && tDate.getFullYear() === today.getFullYear() && t.type === 'expense';
                }).reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                const dailyBudget = Math.round(monthExpenses / daysInMonth) || 500;

                // UI Güncelle
                const statusText = document.getElementById('autopilot-status-text');
                const statusIndicator = document.getElementById('autopilot-status-indicator');
                const dailySpent = document.getElementById('autopilot-daily-spent');
                const dailyBar = document.getElementById('autopilot-daily-bar');
                const advice = document.getElementById('autopilot-advice');

                const percent = Math.min((todayExpenses / dailyBudget) * 100, 100);

                if (dailySpent) dailySpent.textContent = `${todayExpenses.toLocaleString('tr-TR')}₺ / ${dailyBudget.toLocaleString('tr-TR')}₺`;
                if (dailyBar) dailyBar.style.width = percent + '%';

                // Durum belirleme
                if (percent < 50) {
                    if (statusText) statusText.textContent = 'Güvenli Bölge';
                    if (statusText) statusText.style.color = 'var(--accent-success)';
                    if (statusIndicator) {
                        statusIndicator.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1))';
                        statusIndicator.style.borderColor = 'var(--accent-success)';
                        statusIndicator.innerHTML = '<span class="text-3xl">✓</span>';
                    }
                    if (dailyBar) dailyBar.style.background = 'linear-gradient(90deg, var(--accent-success), var(--accent-tertiary))';
                    if (advice) advice.textContent = 'Harika gidiyorsun! Bu tempoya devam et.';
                } else if (percent < 80) {
                    if (statusText) statusText.textContent = 'Dikkat';
                    if (statusText) statusText.style.color = 'var(--accent-warning)';
                    if (statusIndicator) {
                        statusIndicator.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1))';
                        statusIndicator.style.borderColor = 'var(--accent-warning)';
                        statusIndicator.innerHTML = '<span class="text-3xl">⚠</span>';
                    }
                    if (dailyBar) dailyBar.style.background = 'linear-gradient(90deg, var(--accent-warning), #f97316)';
                    if (advice) advice.textContent = 'Günlük bütçene yaklaşıyorsun. Dikkatli harca!';
                } else {
                    if (statusText) statusText.textContent = 'Bütçe Aşımı!';
                    if (statusText) statusText.style.color = 'var(--accent-danger)';
                    if (statusIndicator) {
                        statusIndicator.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1))';
                        statusIndicator.style.borderColor = 'var(--accent-danger)';
                        statusIndicator.innerHTML = '<span class="text-3xl">✕</span>';
                    }
                    if (dailyBar) dailyBar.style.background = 'linear-gradient(90deg, var(--accent-danger), #dc2626)';
                    if (advice) advice.textContent = 'Günlük bütçeni aştın! Yarın daha dikkatli ol.';
                }
            };

            // 2. YAKLAŞAN ÖDEMELER
            window.getUpcomingPayments = function () {
                const recurring = JSON.parse(localStorage.getItem('recurringTransactions') || '[]');
                const container = document.getElementById('autopilot-upcoming');
                const totalEl = document.getElementById('upcoming-total');

                if (!container) return;

                const today = new Date();
                const upcoming = recurring.filter(r => {
                    const nextDate = new Date(r.nextDate || r.startDate);
                    const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                    return daysUntil >= 0 && daysUntil <= 30 && r.type === 'expense';
                }).sort((a, b) => new Date(a.nextDate || a.startDate) - new Date(b.nextDate || b.startDate));

                if (upcoming.length === 0) {
                    container.innerHTML = `
                    <div class="p-4 rounded-xl text-center" style="background: var(--glass-bg-subtle); border: 1px dashed var(--glass-border);">
                        <span class="text-2xl">📭</span>
                        <p class="text-sm font-medium mt-2" style="color: var(--text-muted);">Yaklaşan ödeme yok</p>
                        <p class="text-xs mt-1" style="color: var(--text-light);">Otomatik talimatlar burada görünecek</p>
                    </div>
                `;
                    if (totalEl) totalEl.textContent = '0₺';
                    return;
                }

                let total = 0;
                container.innerHTML = upcoming.slice(0, 5).map(r => {
                    const nextDate = new Date(r.nextDate || r.startDate);
                    const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                    total += parseFloat(r.amount || 0);
                    return `
                    <div class="flex items-center justify-between p-3 rounded-xl" style="background: var(--glass-bg-subtle); border: 1px solid var(--glass-border);">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: var(--accent-glow);">
                                <span class="text-lg">${r.category?.substring(0, 2) || '📅'}</span>
                            </div>
                            <div>
                                <p class="text-sm font-bold" style="color: var(--text-primary);">${r.description || r.category}</p>
                                <p class="text-[10px]" style="color: var(--text-muted);">${daysUntil === 0 ? 'Bugün' : daysUntil + ' gün sonra'}</p>
                            </div>
                        </div>
                        <p class="text-sm font-black" style="color: var(--accent-danger);">-${parseFloat(r.amount).toLocaleString('tr-TR')}₺</p>
                    </div>
                `;
                }).join('');

                if (totalEl) totalEl.textContent = total.toLocaleString('tr-TR') + '₺';
            };

            // 3. NAKİT AKIŞI HESAPLAMA
            window.calculateCashFlow = function () {
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                const recurring = JSON.parse(localStorage.getItem('recurringTransactions') || '[]');
                const today = new Date();

                // Son 30 gün ortalamasını hesapla
                const last30Days = transactions.filter(t => {
                    const tDate = new Date(t.date.split('.').reverse().join('-'));
                    return (today - tDate) / (1000 * 60 * 60 * 24) <= 30;
                });

                const totalIncome = last30Days.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const totalExpense = last30Days.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

                // Gelecek ay tahmini
                const projectedIncome = totalIncome; // Aynı gelir varsayımı
                const projectedExpense = totalExpense; // Aynı gider varsayımı
                const projectedBalance = projectedIncome - projectedExpense;

                // UI Güncelle
                const incomeEl = document.getElementById('cashflow-income');
                const expenseEl = document.getElementById('cashflow-expense');
                const balanceEl = document.getElementById('cashflow-balance');
                const trendText = document.getElementById('cashflow-trend-text');
                const trendIcon = document.getElementById('cashflow-trend');

                if (incomeEl) incomeEl.textContent = '+' + projectedIncome.toLocaleString('tr-TR') + '₺';
                if (expenseEl) expenseEl.textContent = '-' + projectedExpense.toLocaleString('tr-TR') + '₺';
                if (balanceEl) {
                    balanceEl.textContent = projectedBalance.toLocaleString('tr-TR') + '₺';
                    balanceEl.style.color = projectedBalance >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)';
                }

                // Trend
                if (projectedBalance > 0) {
                    if (trendText) { trendText.textContent = 'Pozitif'; trendText.style.color = 'var(--accent-success)'; }
                    if (trendIcon) trendIcon.textContent = '📈';
                } else if (projectedBalance < 0) {
                    if (trendText) { trendText.textContent = 'Negatif'; trendText.style.color = 'var(--accent-danger)'; }
                    if (trendIcon) trendIcon.textContent = '📉';
                } else {
                    if (trendText) { trendText.textContent = 'Stabil'; trendText.style.color = 'var(--text-muted)'; }
                    if (trendIcon) trendIcon.textContent = '📊';
                }
            };

            // Mini Bar Chart oluştur
            window.generateCashFlowChart = function () {
                const container = document.getElementById('cashflow-chart');
                if (!container) return;

                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                const today = new Date();

                // Son 7 günlük veri
                const days = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];

                    const dayExpense = transactions.filter(t => {
                        const tDate = new Date(t.date.split('.').reverse().join('-'));
                        return tDate.toISOString().split('T')[0] === dateStr && t.type === 'expense';
                    }).reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

                    days.push({ date, expense: dayExpense });
                }

                const maxExpense = Math.max(...days.map(d => d.expense), 100);

                container.innerHTML = days.map((d, i) => {
                    const height = Math.max((d.expense / maxExpense) * 100, 5);
                    const isToday = i === 6;
                    return `
                    <div class="flex-1 flex flex-col items-center gap-1">
                        <div class="w-full rounded-t-md transition-all" style="height: ${height}%; background: ${isToday ? 'var(--accent-primary)' : 'var(--accent-glow)'};"></div>
                        <span class="text-[8px] font-bold" style="color: var(--text-light);">${['Pz', 'Pt', 'Sa', 'Ça', 'Pe', 'Cu', 'Ct'][d.date.getDay()]}</span>
                    </div>
                `;
                }).join('');
            };

            // 4. DÖVİZ ÇEVİRİCİ
            window.convertCurrency = function () {
                const amount = parseFloat(document.getElementById('currency-amount')?.value || 0);
                const from = document.getElementById('currency-from')?.value || 'TRY';

                const rates = window.exchangeRates;
                const amountInTRY = from === 'TRY' ? amount : amount * rates[from];

                // Sonuçları göster
                const resultUSD = document.getElementById('result-usd');
                const resultEUR = document.getElementById('result-eur');
                const resultGBP = document.getElementById('result-gbp');

                if (from === 'TRY') {
                    if (resultUSD) resultUSD.textContent = '$' + (amount / rates.USD).toFixed(2);
                    if (resultEUR) resultEUR.textContent = '€' + (amount / rates.EUR).toFixed(2);
                    if (resultGBP) resultGBP.textContent = '£' + (amount / rates.GBP).toFixed(2);
                } else {
                    if (resultUSD) resultUSD.textContent = from === 'USD' ? '-' : '$' + (amountInTRY / rates.USD).toFixed(2);
                    if (resultEUR) resultEUR.textContent = from === 'EUR' ? '-' : '€' + (amountInTRY / rates.EUR).toFixed(2);
                    if (resultGBP) resultGBP.textContent = from === 'GBP' ? '-' : '£' + (amountInTRY / rates.GBP).toFixed(2);
                }

                // Güncelleme zamanı
                const updateEl = document.getElementById('currency-last-update');
                if (updateEl) updateEl.textContent = 'Son güncelleme: Şimdi';
            };

            // 5. KREDİ HESAPLAYICI
            // Helper: Parse money string (1.000,50 -> 1000.50)
            window.parseMoney = function (val) {
                if (!val) return 0;
                if (typeof val === 'number') return val;
                // Remove dots (thousands), replace comma with dot
                let clean = val.toString().replace(/\./g, '').replace(',', '.');
                return parseFloat(clean) || 0;
            };

            // 5. KREDİ HESAPLAYICI (AUTOPILOT)
            window.calculateLoan = function () {
                const principal = window.parseMoney(document.getElementById('loan-amount')?.value);
                const ratePercent = parseFloat(document.getElementById('loan-rate')?.value || 0);
                const months = parseInt(document.getElementById('loan-term')?.value || 0);

                // Varsayılan değerleri sıfırla
                if (!principal || !ratePercent || !months) {
                    // UI temizle
                    return;
                }

                // Standart Banka Formülü: Taksit = (Anapara * Faiz * (1+Faiz)^Vade) / ((1+Faiz)^Vade - 1)
                // Faiz = Aylık Faiz Oranı (Yüzde / 100)
                const r = ratePercent / 100;
                const n = months;

                let monthly = 0;
                if (r === 0) monthly = principal / n;
                else monthly = (principal * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);

                const total = monthly * n;
                const interest = total - principal;

                const monthlyEl = document.getElementById('loan-monthly');
                const interestEl = document.getElementById('loan-interest');
                const totalEl = document.getElementById('loan-total');

                if (monthlyEl) monthlyEl.textContent = monthly.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) + '₺';
                if (interestEl) interestEl.textContent = interest.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) + '₺';
                if (totalEl) totalEl.textContent = total.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) + '₺';
            };

            // 6. BASİT KREDİ HESAPLAYICI (ASİSTAN)
            window.calculateSimpleLoan = function () {
                const principal = window.parseMoney(document.getElementById('simple-loan-amount')?.value);
                const ratePercent = parseFloat(document.getElementById('simple-loan-rate')?.value || 0);
                const months = parseInt(document.getElementById('simple-loan-term')?.value || 0);
                const resultBox = document.getElementById('simple-loan-result');

                if (principal <= 0 || ratePercent <= 0 || months <= 0) {
                    if (resultBox) resultBox.classList.add('hidden');
                    return;
                }

                const r = ratePercent / 100;
                const n = months;

                let monthly = 0;
                if (r === 0) monthly = principal / n;
                else monthly = (principal * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);

                const monthlyEl = document.getElementById('simple-loan-monthly');
                if (monthlyEl) monthlyEl.textContent = monthly.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) + ' ₺';
                if (resultBox) resultBox.classList.remove('hidden');
            };

            // ═══════════════════════════════════════════════════════════════════════
            // FINGO BRAIN PREMIUM - JavaScript Functions
            // ═══════════════════════════════════════════════════════════════════════

            // Global State
            window.__fingoBrainRange = 'month';
            window.__burnRateChartInstance = null;
            window.__radarChartInstance = null;
            window.__fingoBrainDirty = true;
            window.__fingoBrainDebounceTimer = null;
            window.__detectedSubscriptions = [];
            window.__ignoredSubscriptions = [];

            // Currency Formatter
            window.formatTRY = function (amount) {
                if (isNaN(amount) || amount === null || amount === undefined) return '0 ₺';
                return new Intl.NumberFormat('tr-TR', {
                    style: 'currency',
                    currency: 'TRY',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            };

            // Range Selector Handler
            window.setFingoBrainRange = function (range) {
                if (window.__fingoBrainRange === range) return;
                window.__fingoBrainRange = range;

                // Update UI
                document.querySelectorAll('.fingo-range-pill').forEach(pill => {
                    pill.classList.remove('active');
                    pill.setAttribute('aria-selected', 'false');
                });
                const activePill = document.getElementById('range-' + range);
                if (activePill) {
                    activePill.classList.add('active');
                    activePill.setAttribute('aria-selected', 'true');
                }

                // Trigger recalculation
                window.__fingoBrainDirty = true;
                window.calculateFingoBrainPrediction();
            };

            // Tab Switching with Debounce
            window.switchAutopilotTab = function (tab) {
                clearTimeout(window.__fingoBrainDebounceTimer);

                window.__fingoBrainDebounceTimer = setTimeout(() => {
                    // Hide all tabs
                    ['pulse', 'dna', 'ailab', 'detective', 'assistant', 'installments'].forEach(t => {
                        const tabEl = document.getElementById('autopilot-tab-' + t);
                        const btnEl = document.getElementById('tab-btn-' + t);
                        if (tabEl) tabEl.classList.add('hidden');
                        if (btnEl) {
                            btnEl.classList.remove('bg-white', 'dark:bg-white/10', 'text-indigo-600', 'dark:text-white', 'shadow-sm', 'font-black');
                            btnEl.classList.add('text-gray-500', 'dark:text-gray-400', 'font-bold');
                            btnEl.setAttribute('aria-selected', 'false');
                        }
                    });

                    // Show selected tab
                    const activeTab = document.getElementById('autopilot-tab-' + tab);
                    const activeBtn = document.getElementById('tab-btn-' + tab);
                    if (activeTab) {
                        activeTab.classList.remove('hidden');
                        activeTab.classList.add('animate-fade-in');
                    }
                    if (activeBtn) {
                        activeBtn.classList.add('bg-white', 'dark:bg-white/10', 'text-indigo-600', 'dark:text-white', 'shadow-sm', 'font-black');
                        activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'font-bold');
                        activeBtn.setAttribute('aria-selected', 'true');
                    }

                    // Update only if dirty
                    if (window.__fingoBrainDirty) {
                        if (tab === 'pulse') window.calculateFingoBrainPrediction();
                        else if (tab === 'dna') window.renderRadarChart();
                        else if (tab === 'detective') window.detectSubscriptions();
                        else if (tab === 'installments') window.renderFBInstallments();
                        window.__fingoBrainDirty = false;
                    }
                }, 150);
            };

            // Main Calculation Engine (V2 - Improved)
            window.calculateFingoBrainPrediction = function () {
                // === 1. TEMEL DEĞİŞKENLER ===
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                const currentDay = now.getDate();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const daysLeft = daysInMonth - currentDay;
                const currentMonthStr = now.toISOString().slice(0, 7); // "YYYY-MM"

                // İşlemleri al (window.transactions veya localStorage fallback)
                let txns = window.transactions || [];
                if (!txns || txns.length === 0) {
                    try {
                        txns = JSON.parse(localStorage.getItem(`my_expenses_${currentYear}`) || '[]');
                    } catch (e) { txns = []; }
                }

                // Recurring rules'ları al
                let recurringRules = [];
                try {
                    recurringRules = JSON.parse(localStorage.getItem(`my_recurring_rules_${currentYear}`) || '[]');
                } catch (e) { recurringRules = []; }

                // UI Elements
                const typingEl = document.getElementById('fingo-typing-indicator');
                const insightEl = document.getElementById('fingo-insight-text');
                if (typingEl) typingEl.classList.remove('hidden');
                if (insightEl) insightEl.textContent = '';

                // Empty state check
                if (!txns || txns.length === 0) {
                    document.getElementById('fingo-score-val').textContent = '--';
                    document.getElementById('prediction-balance').textContent = 'Veri yok';
                    document.getElementById('prediction-volatility').textContent = '--';
                    if (typingEl) typingEl.classList.add('hidden');
                    if (insightEl) insightEl.textContent = 'Henüz işlem kaydedilmemiş. İlk işlemini ekleyerek başla!';
                    window.renderBurnRateChart([]);
                    return;
                }

                // === 2. BU AYIN İŞLEMLERİNİ FİLTRELE ===
                const getDateStr = (t) => {
                    if (t.date && t.date.length >= 7) return t.date.slice(0, 7);
                    if (t.timestamp) return new Date(t.timestamp).toISOString().slice(0, 7);
                    return '';
                };
                const monthTxns = txns.filter(t => getDateStr(t) === currentMonthStr);

                // Gelir, Gider, Tasarruf (isSavingsTransaction kullan)
                let monthIncome = 0, monthExpense = 0, monthSaving = 0;
                monthTxns.forEach(t => {
                    const amount = parseFloat(t.amount) || 0;
                    if (t.type === 'income') {
                        monthIncome += amount;
                    } else if (t.type === 'expense') {
                        if (typeof isSavingsTransaction === 'function' && isSavingsTransaction(t)) {
                            monthSaving += amount;
                        } else {
                            monthExpense += amount;
                        }
                    }
                });

                // === 3. MEVCUT NET BAKİYE ===
                let currentBalance = 0;
                if (typeof window.currentBalance === 'number' && !isNaN(window.currentBalance)) {
                    currentBalance = window.currentBalance;
                } else {
                    currentBalance = monthIncome - monthExpense - monthSaving;
                }

                // === 4. PLANLANAN GELİR-GİDER (KALAN GÜNLER) ===
                let upcomingIncome = 0, upcomingFixedExpense = 0;
                const clampDay = (d) => Math.min(28, Math.max(1, parseInt(d) || 1));

                recurringRules.forEach(rule => {
                    if (!rule) return;
                    // Bu ay henüz çalışmadıysa ve maxRuns dolmadıysa
                    const ruleExecuted = rule.lastExecutedMonth === currentMonthStr;
                    const maxRunsReached = rule.maxRuns && rule.runsDone >= rule.maxRuns;
                    if (ruleExecuted || maxRunsReached) return;

                    const ruleDay = clampDay(rule.day);
                    // Kalan günlerde mi?
                    if (ruleDay > currentDay) {
                        const ruleAmount = parseFloat(rule.amount) || 0;
                        if (rule.type === 'income') {
                            upcomingIncome += ruleAmount;
                        } else if (rule.type === 'expense') {
                            upcomingFixedExpense += ruleAmount;
                        }
                    }
                });

                // === 5. DEĞİŞKEN GİDER TAHMİNİ (son 14 gün bazlı) ===
                const lookbackDays = 14;
                const lookbackDate = new Date(now);
                lookbackDate.setDate(lookbackDate.getDate() - lookbackDays);

                const getDayStr = (t) => {
                    if (t.date && t.date.length >= 10) return t.date.slice(0, 10);
                    if (t.timestamp) return new Date(t.timestamp).toISOString().slice(0, 10);
                    return '';
                };

                let recentVariableTotal = 0, recentVariableDays = 0;
                const countedDays = new Set();
                txns.forEach(t => {
                    if (t.type !== 'expense') return;
                    if (typeof isSavingsTransaction === 'function' && isSavingsTransaction(t)) return;
                    // Otomatik işlemleri atla
                    const desc = (t.description || '').toLowerCase();
                    if (desc.includes('(otomatik)') || desc.includes('otomatik')) return;

                    const dayStr = getDayStr(t);
                    if (!dayStr) return;
                    const txDate = new Date(dayStr);
                    if (txDate >= lookbackDate && txDate <= now) {
                        recentVariableTotal += parseFloat(t.amount) || 0;
                        countedDays.add(dayStr);
                    }
                });

                recentVariableDays = Math.max(countedDays.size, 7); // Min 7 gün
                const avgDailyVariableExpense = recentVariableTotal / recentVariableDays;
                const projectedVariableExpense = avgDailyVariableExpense * daysLeft;

                // === 6. AY SONU TAHMİNİ BAKİYE ===
                const predictedBalance = currentBalance + upcomingIncome - upcomingFixedExpense - projectedVariableExpense;
                document.getElementById('prediction-balance').innerHTML = window.renderMoney(predictedBalance);

                // === 7. VOLATİLİTE HESABI ===
                const expenseAmounts = monthTxns
                    .filter(t => t.type === 'expense' && parseFloat(t.amount) > 0)
                    .filter(t => !(typeof isSavingsTransaction === 'function' && isSavingsTransaction(t)))
                    .map(t => parseFloat(t.amount));

                let volatility = 'Düşük', cv = 0;
                if (expenseAmounts.length > 1) {
                    const mean = expenseAmounts.reduce((a, b) => a + b, 0) / expenseAmounts.length;
                    const variance = expenseAmounts.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / expenseAmounts.length;
                    const stdDev = Math.sqrt(variance);
                    cv = mean > 0 ? (stdDev / mean) * 100 : 0;
                    if (cv > 80) volatility = 'Yüksek';
                    else if (cv > 40) volatility = 'Orta';
                }
                document.getElementById('prediction-volatility').textContent = volatility;

                // === 8. FİNGO SCORE (4 BİLEŞENLİ, 0-1000) ===
                const projectedIncome = monthIncome + upcomingIncome;

                // 8.1 Tasarruf Disiplini (30%) - monthSaving / projectedIncome
                let savingsScore = 0;
                if (projectedIncome > 0) {
                    const savingsRate = monthSaving / projectedIncome;
                    savingsScore = Math.min(1, savingsRate * 5) * 300; // %20 tasarruf = max puan
                }

                // 8.2 Ay Sonu Tamponu (25%) - kaç gün dayanır?
                let bufferScore = 0;
                if (avgDailyVariableExpense > 0 && predictedBalance > 0) {
                    const bufferDays = predictedBalance / avgDailyVariableExpense;
                    bufferScore = Math.min(1, bufferDays / 30) * 250; // 30+ gün = max
                } else if (predictedBalance > 0) {
                    bufferScore = 150; // Pozitif ama veri yok
                }

                // 8.3 Sabit Yük (25%) - yüksekse puan düşer
                let fixedLoadScore = 250; // Max başla
                if (projectedIncome > 0) {
                    const fixedLoadRatio = upcomingFixedExpense / projectedIncome;
                    fixedLoadScore = Math.max(0, 250 * (1 - fixedLoadRatio * 2)); // %50 = 0 puan
                }

                // 8.4 Volatilite (20%) - düşükse iyi
                let volatilityScore = 200;
                if (cv > 80) volatilityScore = 50;
                else if (cv > 40) volatilityScore = 125;

                // Toplam Score
                let score = Math.round(savingsScore + bufferScore + fixedLoadScore + volatilityScore);

                // Negatif bakiye cezası
                if (predictedBalance < 0) {
                    const penaltyRatio = Math.min(1, Math.abs(predictedBalance) / (projectedIncome || 10000));
                    score = Math.round(score * (1 - penaltyRatio * 0.5));
                }

                score = Math.max(0, Math.min(1000, score));

                // Update Score UI
                const scoreEl = document.getElementById('fingo-score-val');
                const circleEl = document.getElementById('fingo-score-circle');
                if (scoreEl) scoreEl.textContent = score;
                if (circleEl) {
                    const offset = 214 - (214 * score / 1000);
                    circleEl.style.strokeDashoffset = offset;
                }

                // === 9. BURN RATE CHART (Son 7 gün) ===
                const last7Days = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dayStr = d.toISOString().slice(0, 10);

                    const dayExpense = txns.filter(t => {
                        if (t.type !== 'expense') return false;
                        const txDayStr = getDayStr(t);
                        return txDayStr === dayStr;
                    }).reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

                    last7Days.push({ date: dayStr, amount: dayExpense });
                }
                window.renderBurnRateChart(last7Days);

                // === 10. INSIGHT ===
                setTimeout(() => {
                    if (typingEl) typingEl.classList.add('hidden');
                    let insight = '';
                    if (score >= 800) insight = 'Mükemmel! Finansal durumun çok iyi. Tasarruf alışkanlıkların örnek seviyede. 🌟';
                    else if (score >= 600) insight = 'İyi gidiyorsun! Küçük optimizasyonlarla daha da iyileşebilirsin. 💪';
                    else if (score >= 400) insight = 'Harcamalarına dikkat etmelisin. Gereksiz giderleri azaltmayı dene. ⚠️';
                    else insight = 'Dikkat! Harcamaların gelirini aşıyor. Acil önlem almalısın. 🚨';

                    if (predictedBalance < 0) {
                        insight = `⚠️ Ay sonunda yaklaşık ${window.formatMoneyTRY(Math.abs(predictedBalance))} ₺ açık riski var. Harcamaları kıs!`;
                    }

                    window.typeWriterAdvice(insight);
                }, 800);
            };

            // Burn Rate Chart with Instance Reuse
            window.renderBurnRateChart = function (data) {
                const canvas = document.getElementById('burnRateChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const labels = data.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('tr-TR', { weekday: 'short' });
                });
                const amounts = data.map(d => d.amount);

                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Harcama',
                        data: amounts,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(99, 102, 241)',
                        borderWidth: 2
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: window.__burnRateChartInstance ? false : { duration: 600 },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => window.formatMoneyTRY(ctx.raw) + ' ₺'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 }, color: '#9ca3af' }
                        },
                        y: {
                            grid: { color: 'rgba(156, 163, 175, 0.1)' },
                            ticks: {
                                font: { size: 10 },
                                color: '#9ca3af',
                                callback: (val) => val >= 1000 ? (val / 1000) + 'K' : val
                            }
                        }
                    }
                };

                if (window.__burnRateChartInstance) {
                    window.__burnRateChartInstance.data = chartData;
                    window.__burnRateChartInstance.update('none');
                } else if (typeof Chart !== 'undefined') {
                    window.__burnRateChartInstance = new Chart(ctx, { type: 'line', data: chartData, options });
                }
            };

            // Radar Chart with Instance Reuse
            window.renderRadarChart = function () {
                const canvas = document.getElementById('radarChart');
                if (!canvas) return;

                const txns = window.transactions || [];
                const categories = {};

                txns.filter(t => t.type === 'expense').forEach(t => {
                    const cat = t.category || 'Diğer';
                    categories[cat] = (categories[cat] || 0) + parseFloat(t.amount || 0);
                });

                const sortedCats = Object.entries(categories).sort((a, b) => b[1] - a[1]).slice(0, 6);
                const labels = sortedCats.map(c => c[0].replace(/^[^\s]+\s/, ''));
                const amounts = sortedCats.map(c => c[1]);

                // Update dominant categories
                const dominantText = document.getElementById('dna-dominant-text');
                if (dominantText && sortedCats.length > 0) {
                    dominantText.textContent = sortedCats.slice(0, 2).map(c => c[0]).join(' • ');
                }

                // Update category pills
                const pillsContainer = document.getElementById('dna-category-pills');
                if (pillsContainer && sortedCats.length > 0) {
                    pillsContainer.innerHTML = sortedCats.map((c, i) =>
                        `<span class="fingo-category-pill${i === 0 ? ' dominant' : ''}">${c[0]}</span>`
                    ).join('');
                }

                const chartData = {
                    labels: labels.length ? labels : ['Veri Yok'],
                    datasets: [{
                        label: 'Harcama',
                        data: amounts.length ? amounts : [0],
                        backgroundColor: 'rgba(99, 102, 241, 0.25)',
                        borderColor: 'rgb(139, 92, 246)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgb(139, 92, 246)',
                        pointBorderColor: '#fff',
                        pointRadius: 4
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: window.__radarChartInstance ? false : { duration: 600 },
                    plugins: { legend: { display: false } },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: { size: 10, weight: '600' }
                            },
                            ticks: { display: false }
                        }
                    }
                };

                if (window.__radarChartInstance) {
                    window.__radarChartInstance.data = chartData;
                    window.__radarChartInstance.update('none');
                } else if (typeof Chart !== 'undefined') {
                    window.__radarChartInstance = new Chart(canvas.getContext('2d'), { type: 'radar', data: chartData, options });
                }
            };

            // Subscription Detection
            window.detectSubscriptions = async function () {
                const txns = window.transactions || [];
                const listEl = document.getElementById('subscription-list');
                const emptyEl = document.getElementById('detective-empty-state');
                const totalEl = document.getElementById('detective-monthly-total');

                // Load ignored subscriptions
                try {
                    const ignored = await AppStorage.get('ignored_subscriptions');
                    window.__ignoredSubscriptions = ignored ? JSON.parse(ignored) : [];
                } catch (e) {
                    window.__ignoredSubscriptions = JSON.parse(localStorage.getItem('ignored_subscriptions') || '[]');
                }

                // Find recurring patterns
                const patterns = {};
                txns.filter(t => t.type === 'expense').forEach(t => {
                    const key = (t.description || t.category || '').toLowerCase().trim();
                    if (!key) return;
                    if (!patterns[key]) patterns[key] = { count: 0, amounts: [], dates: [], category: t.category };
                    patterns[key].count++;
                    patterns[key].amounts.push(parseFloat(t.amount || 0));
                    patterns[key].dates.push(new Date(t.date));
                });

                // Filter for potential subscriptions (2+ occurrences, similar amounts)
                const subscriptions = [];
                Object.entries(patterns).forEach(([name, data]) => {
                    if (data.count < 2) return;
                    if (window.__ignoredSubscriptions.includes(name)) return;

                    const avgAmount = data.amounts.reduce((a, b) => a + b, 0) / data.amounts.length;
                    const variance = data.amounts.reduce((sum, val) => sum + Math.abs(val - avgAmount), 0) / data.amounts.length;

                    // If amounts are relatively consistent (< 20% variance)
                    if (variance / avgAmount < 0.2) {
                        const lastDate = new Date(Math.max(...data.dates.map(d => d.getTime())));
                        subscriptions.push({
                            name: name,
                            amount: avgAmount,
                            count: data.count,
                            lastSeen: lastDate,
                            category: data.category
                        });
                    }
                });

                window.__detectedSubscriptions = subscriptions;

                // Calculate total
                const monthlyTotal = subscriptions.reduce((sum, s) => sum + s.amount, 0);
                if (totalEl) totalEl.innerHTML = window.renderMoney(monthlyTotal);

                // Render UI
                if (!listEl) return;

                if (subscriptions.length === 0) {
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    return;
                }

                if (emptyEl) emptyEl.classList.add('hidden');

                const html = subscriptions.slice(0, 5).map((sub, idx) => `
                <div class="detective-item" data-idx="${idx}">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-gray-800 dark:text-white truncate capitalize">${sub.name}</p>
                        <p class="text-[10px] text-gray-400">${sub.count}x görüldü • Son: ${sub.lastSeen.toLocaleDateString('tr-TR')}</p>
                    </div>
                    <p class="text-sm font-black text-red-500">${window.renderMoney(sub.amount)}</p>
                    <div class="flex gap-1.5 shrink-0">
                        <button onclick="window.markSubscription(${idx})" class="detective-action-btn mark" title="İşaretle">✓</button>
                        <button onclick="window.ignoreSubscription(${idx})" class="detective-action-btn ignore" title="Yoksay">✕</button>
                    </div>
                </div>
            `).join('');

                listEl.innerHTML = (emptyEl ? emptyEl.outerHTML : '') + html;
            };

            // Mark Subscription
            window.markSubscription = function (idx) {
                const sub = window.__detectedSubscriptions[idx];
                if (!sub) return;
                window.alertMessage('Abonelik', `"${sub.name}" abonelik olarak işaretlendi! 🎯`, 'green');
            };

            // Ignore Subscription
            window.ignoreSubscription = async function (idx) {
                const sub = window.__detectedSubscriptions[idx];
                if (!sub) return;

                window.__ignoredSubscriptions.push(sub.name);

                try {
                    await AppStorage.set('ignored_subscriptions', JSON.stringify(window.__ignoredSubscriptions));
                } catch (e) {
                    localStorage.setItem('ignored_subscriptions', JSON.stringify(window.__ignoredSubscriptions));
                }

                window.detectSubscriptions();
            };

            // Typewriter Effect
            window.typeWriterAdvice = function (text) {
                const el = document.getElementById('fingo-insight-text');
                if (!el) return;

                let i = 0;
                el.textContent = '';

                const type = () => {
                    if (i < text.length) {
                        el.textContent += text.charAt(i);
                        i++;
                        setTimeout(type, 20);
                    }
                };
                type();
            };

            // Initialize Autopilot
            window.initAutopilot = function () {
                window.__fingoBrainDirty = true;

                // Set default range
                const rangeMonth = document.getElementById('range-month');
                if (rangeMonth) {
                    rangeMonth.classList.add('active');
                    rangeMonth.setAttribute('aria-selected', 'true');
                }

                // Initialize PULSE by default
                window.calculateFingoBrainPrediction();
            };

            // Autopilot Dashboard Update Alias (backwards compatibility)
            window.updateAutopilotDashboard = function () {
                window.__fingoBrainDirty = true;
                window.initAutopilot();
            };

            // Helper: Format Money as Plain Text (No HTML) - Apple Style
            window.renderMoneyText = function (amount, currency = 'TRY') {
                const val = parseFloat(amount || 0);
                const formatted = val.toLocaleString('tr-TR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const symbol = currency === 'TRY' ? '₺' : (currency === 'USD' ? '$' : '€');
                return `${formatted} ${symbol}`; // "1.234,56 ₺"
            };

            // Helper: Convert HTML string to Plain Text (strips tags)
            window.htmlToPlainText = function (html) {
                if (!html) return '';
                const temp = document.createElement('div');
                temp.innerHTML = html;
                // Handle specific currency structure: <span class="amount">100</span><span class="currency">₺</span>
                // Add space between amount and currency if stuck together
                let text = temp.textContent || temp.innerText || '';
                // Fix sticky currency symbol if no space
                text = text.replace(/(\d)(₺|\$|€)/g, '$1 $2');
                return text;
            };

            // ═══════════════════════════════════════════════════════════════════════
            // FINGO BRAIN INSTALLMENTS - Taksit Yönetimi
            // ═══════════════════════════════════════════════════════════════════════

            // Render Installments List in Fingo Brain
            window.renderFBInstallments = function () {
                const currentYear = new Date().getFullYear();
                let installments = [];
                try {
                    installments = JSON.parse(localStorage.getItem(`my_installments_${currentYear}`) || '[]');
                } catch (e) { installments = []; }

                const listEl = document.getElementById('fb-installments-list');
                const emptyEl = document.getElementById('fb-installments-empty');
                const totalEl = document.getElementById('fb-installment-total');

                // Calculate monthly total
                let monthlyTotal = 0;
                const now = new Date();
                installments.forEach(inst => {
                    if (inst.paidCount < inst.totalCount) {
                        monthlyTotal += parseFloat(inst.monthlyAmount || 0);
                    }
                });

                if (totalEl) totalEl.innerHTML = window.renderMoney ? window.renderMoney(monthlyTotal) : monthlyTotal.toLocaleString('tr-TR') + ' ₺';

                if (!listEl) return;

                // Filter active installments
                const activeInstallments = installments.filter(inst => inst.paidCount < inst.totalCount);

                if (activeInstallments.length === 0) {
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    // Clear other items but keep empty state
                    const items = listEl.querySelectorAll('.fb-installment-item');
                    items.forEach(item => item.remove());
                    return;
                }

                if (emptyEl) emptyEl.classList.add('hidden');

                // Render installments
                const html = activeInstallments.map((inst, idx) => {
                    const progress = Math.round((inst.paidCount / inst.totalCount) * 100);
                    const remaining = inst.totalCount - inst.paidCount;
                    const categoryIcon = inst.category || '💳';
                    const isCredit = inst.type === 'credit';
                    const gradientColors = isCredit
                        ? 'from-blue-500/20 to-purple-500/20'
                        : 'from-red-500/20 to-orange-500/20';
                    const progressColors = isCredit
                        ? 'from-blue-500 to-purple-500'
                        : 'from-red-500 to-orange-500';
                    const textColor = isCredit ? 'text-blue-500' : 'text-red-500';
                    const bankInfo = isCredit && inst.bank ? `<span class="text-[9px] text-gray-400">${inst.bank}</span>` : '';

                    return `
                    <div class="fb-installment-item flex items-center gap-3 p-3 rounded-2xl bg-white/50 dark:bg-white/5 border border-gray-100 dark:border-white/10 hover:shadow-md transition-all" data-idx="${idx}">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${gradientColors} flex items-center justify-center text-lg shrink-0">
                            ${categoryIcon}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <p class="text-sm font-bold text-gray-800 dark:text-white truncate">${inst.description || (isCredit ? 'Kredi' : 'Taksit')}</p>
                                ${bankInfo}
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="flex-1 h-1.5 rounded-full bg-gray-200 dark:bg-white/10 overflow-hidden">
                                    <div class="h-full bg-gradient-to-r ${progressColors} rounded-full transition-all" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-[10px] font-bold text-gray-500 dark:text-gray-400">${inst.paidCount}/${inst.totalCount}</span>
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <p class="text-sm font-black ${textColor}">${window.renderMoney ? window.renderMoney(inst.monthlyAmount) : inst.monthlyAmount.toLocaleString('tr-TR') + ' ₺'}</p>
                            <p class="text-[9px] text-gray-400">${remaining} ${isCredit ? 'ay' : 'taksit'} kaldı</p>
                        </div>
                        <button onclick="window.payInstallment(${idx})" class="p-2 rounded-xl bg-emerald-50 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-emerald-500/20 transition-colors" title="${isCredit ? 'Ödeme Yap' : 'Taksit Öde'}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                    </div>
                `;
                }).join('');

                // Keep empty state element and add items
                listEl.innerHTML = (emptyEl ? emptyEl.outerHTML : '') + html;
            };

            // Pay Installment
            window.payInstallment = function (idx) {
                const currentYear = new Date().getFullYear();
                let installments = [];
                try {
                    installments = JSON.parse(localStorage.getItem(`my_installments_${currentYear}`) || '[]');
                } catch (e) { installments = []; }

                const activeInstallments = installments.filter(inst => inst.paidCount < inst.totalCount);
                if (idx < 0 || idx >= activeInstallments.length) return;

                const inst = activeInstallments[idx];
                const originalIdx = installments.findIndex(i => i.id === inst.id);

                if (originalIdx !== -1 && installments[originalIdx].paidCount < installments[originalIdx].totalCount) {
                    installments[originalIdx].paidCount++;
                    localStorage.setItem(`my_installments_${currentYear}`, JSON.stringify(installments));

                    if (window.alertMessage) {
                        window.alertMessage('Taksit Ödendi', `${inst.description} - ${installments[originalIdx].paidCount}/${inst.totalCount}`, 'green');
                    }

                    window.renderFBInstallments();
                }
            };

            // Open Installment Modal
            window.openInstallmentModal = function () {
                if (window.FingoHaptics?.light) window.FingoHaptics.light();

                const content = `
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Açıklama</label>
                        <input type="text" id="fb-inst-desc" placeholder="Örn: iPhone 15 Pro" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Aylık Tutar</label>
                            <div class="relative">
                                <input type="number" id="fb-inst-amount" placeholder="1500" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50 pl-8">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">₺</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Taksit Sayısı</label>
                            <input type="number" id="fb-inst-total" placeholder="12" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Ödenen Taksit</label>
                        <input type="number" id="fb-inst-paid" placeholder="0" value="0" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50">
                    </div>
                </div>
            `;

                window.createPremiumModal('fb-installment-modal', 'Yeni Taksit Ekle', '💳', content, [
                    { label: 'Taksit Ekle', action: 'window.saveInstallment()', variant: 'primary' }
                ]);
            };

            // Close Installment Modal
            window.closeInstallmentModal = function () {
                const modal = document.getElementById('fb-installment-modal');
                if (modal) modal.remove();
            };

            // Save Installment
            window.saveInstallment = function () {
                const desc = document.getElementById('fb-inst-desc')?.value?.trim();
                const amount = parseFloat(document.getElementById('fb-inst-amount')?.value || 0);
                const total = parseInt(document.getElementById('fb-inst-total')?.value || 0);
                const paid = parseInt(document.getElementById('fb-inst-paid')?.value || 0);

                if (!desc || amount <= 0 || total <= 0) {
                    if (window.alertMessage) {
                        window.alertMessage('Hata', 'Lütfen tüm alanları doldurun', 'red');
                    }
                    return;
                }

                const currentYear = new Date().getFullYear();
                let installments = [];
                try {
                    installments = JSON.parse(localStorage.getItem(`my_installments_${currentYear}`) || '[]');
                } catch (e) { installments = []; }

                const newInstallment = {
                    id: Date.now(),
                    description: desc,
                    monthlyAmount: amount,
                    totalCount: total,
                    paidCount: Math.min(paid, total),
                    category: '💳',
                    createdAt: new Date().toISOString()
                };

                installments.push(newInstallment);
                localStorage.setItem(`my_installments_${currentYear}`, JSON.stringify(installments));

                if (window.alertMessage) {
                    window.alertMessage('Başarılı', 'Taksit eklendi!', 'green');
                }

                window.closeInstallmentModal();
                window.renderFBInstallments();
            };

            // ═══════════════════════════════════════════════════════════════════════
            // FINGO BRAIN CREDITS - Kredi Yönetimi
            // ═══════════════════════════════════════════════════════════════════════

            // Open Credit Modal
            window.openCreditModal = function () {
                if (window.FingoHaptics?.light) window.FingoHaptics.light();

                const content = `
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Kredi Adı</label>
                        <input type="text" id="fb-credit-name" placeholder="Örn: Konut Kredisi" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50">
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Banka</label>
                        <input type="text" id="fb-credit-bank" placeholder="Örn: Ziraat Bankası" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Toplam Tutar</label>
                            <div class="relative">
                                <input type="number" id="fb-credit-total" placeholder="500000" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50 pl-8">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">₺</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Aylık Taksit</label>
                            <div class="relative">
                                <input type="number" id="fb-credit-monthly" placeholder="12500" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50 pl-8">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">₺</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Taksit Sayısı</label>
                            <input type="number" id="fb-credit-count" placeholder="120" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Ödenen</label>
                            <input type="number" id="fb-credit-paid" placeholder="0" value="0" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Faiz Oranı (%)</label>
                        <input type="number" id="fb-credit-rate" placeholder="2.49" step="0.01" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50">
                    </div>
                </div>
            `;

                window.createPremiumModal('fb-credit-modal', 'Yeni Kredi Ekle', '🏦', content, [
                    { label: 'Kredi Ekle', action: 'window.saveCredit()', variant: 'primary' }
                ]);
            };

            // Close Credit Modal
            window.closeCreditModal = function () {
                const modal = document.getElementById('fb-credit-modal');
                if (modal) modal.remove();
            };

            // Save Credit
            window.saveCredit = function () {
                const name = document.getElementById('fb-credit-name')?.value?.trim();
                const bank = document.getElementById('fb-credit-bank')?.value?.trim();
                const totalAmount = parseFloat(document.getElementById('fb-credit-total')?.value || 0);
                const monthlyAmount = parseFloat(document.getElementById('fb-credit-monthly')?.value || 0);
                const totalCount = parseInt(document.getElementById('fb-credit-count')?.value || 0);
                const paidCount = parseInt(document.getElementById('fb-credit-paid')?.value || 0);
                const rate = parseFloat(document.getElementById('fb-credit-rate')?.value || 0);

                if (!name || monthlyAmount <= 0 || totalCount <= 0) {
                    if (window.alertMessage) {
                        window.alertMessage('Hata', 'Lütfen gerekli alanları doldurun', 'red');
                    }
                    return;
                }

                const currentYear = new Date().getFullYear();
                let installments = [];
                try {
                    installments = JSON.parse(localStorage.getItem(`my_installments_${currentYear}`) || '[]');
                } catch (e) { installments = []; }

                const newCredit = {
                    id: Date.now(),
                    type: 'credit',
                    description: name,
                    bank: bank || '',
                    totalAmount: totalAmount,
                    monthlyAmount: monthlyAmount,
                    totalCount: totalCount,
                    paidCount: Math.min(paidCount, totalCount),
                    interestRate: rate,
                    category: '🏦',
                    createdAt: new Date().toISOString()
                };

                installments.push(newCredit);
                localStorage.setItem(`my_installments_${currentYear}`, JSON.stringify(installments));

                if (window.alertMessage) {
                    window.alertMessage('Başarılı', 'Kredi eklendi!', 'green');
                }

                window.closeCreditModal();
                window.renderFBInstallments();
            };

        </script>

        <!-- ================================================================= -->
        <!-- PREMIUM PAYWALL SYSTEM (ADDED BY SENIOR FRONTEND ENGINEER) -->
        <!-- ================================================================= -->

        <!-- 1. Premium Paywall Modal (3D Animated Fingenda Pro) -->
        <style>
            @keyframes float-crown {

                0%,
                100% {
                    transform: translateY(0) rotateZ(-3deg);
                }

                50% {
                    transform: translateY(-12px) rotateZ(3deg);
                }
            }

            @keyframes glow-pulse {

                0%,
                100% {
                    box-shadow: 0 0 30px rgba(99, 102, 241, 0.4), 0 0 60px rgba(139, 92, 246, 0.2);
                }

                50% {
                    box-shadow: 0 0 50px rgba(99, 102, 241, 0.6), 0 0 100px rgba(139, 92, 246, 0.4);
                }
            }

            @keyframes border-glow {
                0% {
                    background-position: 0% 50%;
                }

                100% {
                    background-position: 100% 50%;
                }
            }

            @keyframes sparkle {

                0%,
                100% {
                    opacity: 0;
                    transform: scale(0) rotate(0deg);
                }

                50% {
                    opacity: 1;
                    transform: scale(1) rotate(180deg);
                }
            }

            @keyframes shine {
                0% {
                    left: -100%;
                }

                100% {
                    left: 200%;
                }
            }

            @keyframes feature-slide {
                0% {
                    opacity: 0;
                    transform: translateX(-20px);
                }

                100% {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .premium-card-3d {
                transform-style: preserve-3d;
                perspective: 1000px;
            }



            .crown-float {
                animation: float-crown 3s ease-in-out infinite;
                will-change: transform;
            }

            .crown-glow {
                animation: glow-pulse 2s ease-in-out infinite;
                will-change: box-shadow;
            }

            .gradient-border {
                background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899, #6366f1);
                background-size: 300% 300%;
                animation: border-glow 3s linear infinite;
                will-change: background-position;
            }

            .feature-animate {
                animation: feature-slide 0.5s ease-out forwards;
                opacity: 0;
                will-change: transform, opacity;
            }

            .sparkle {
                animation: sparkle 2s ease-in-out infinite;
                will-change: transform, opacity;
            }

            .btn-shine {
                position: relative;
                overflow: hidden;
            }

            .btn-shine::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 50%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                animation: shine 3s infinite;
            }
        </style>
        <style>
            /* Tailwind gecikirse/çalışmazsa gizleme garanti olsun */
            .hidden {
                display: none !important;
            }

            /* Modal gibi kritik overlay’lerde ekstra garanti */
            #profile-modal.hidden {
                display: none !important;
            }

            /* === MOBİL LAYOUT FIX (KAYMA ENGELLEME) === */
            @media (max-width: 768px) {
                body {
                    position: static !important;
                    overflow: auto !important;
                }

                /* Overlay */
                #profile-modal {
                    display: flex;
                    /* overlay flex kalsın */
                    align-items: center !important;
                    justify-content: center !important;
                    padding:
                        calc(env(safe-area-inset-top) + 12px) calc(env(safe-area-inset-right) + 12px) calc(env(safe-area-inset-bottom) + 12px) calc(env(safe-area-inset-left) + 12px) !important;
                }

                /* Modal container (overlay içindeki ana kart) */
                #profile-modal>div {
                    width: min(560px, calc(100vw - 24px)) !important;
                    max-height: calc(100dvh - 24px) !important;
                    /* iOS için 100dvh */
                    margin: 0 auto !important;
                    box-sizing: border-box !important;
                    overflow: hidden !important;
                    /* iç scroll’u alt kapsayıcı yönetsin */
                }

                /* İçerik alanı (modal içinde scroll gereken bölüm) */
                #profile-modal .modal-body,
                #profile-modal [data-modal-body] {
                    max-height: calc(100dvh - 220px) !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                }
            }

            /* === MINI TOAST STYLES === */
            #mini-toast .toast-card {
                background: var(--glass-bg-subtle, rgba(255, 255, 255, 0.08));
                border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.12));
                backdrop-filter: blur(18px);
                -webkit-backdrop-filter: blur(18px);
                color: var(--text-primary, #fff);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
                border-radius: 18px;
                padding: 12px 14px;
                min-width: 260px;
                max-width: 92vw;
                transform: translateY(10px);
                opacity: 0;
                transition: all .25s ease;
            }

            #mini-toast.show .toast-card {
                transform: translateY(0);
                opacity: 1;
            }

            #mini-toast .toast-title {
                font-weight: 900;
                font-size: 12px;
                letter-spacing: .2px;
            }

            #mini-toast .toast-text {
                font-weight: 700;
                font-size: 11px;
                opacity: .8;
                margin-top: 2px;
            }

            /* === MOBILE PERFORMANCE OVERRIDES === */
            @media (max-width: 768px) {
                * {
                    box-shadow: none !important;
                    /* Heavy shadows kill mobile FPS */
                    backdrop-filter: none !important;
                    /* Fallback */
                    -webkit-backdrop-filter: none !important;
                }

                /* Re-enable modest blur for critical UI only */
                #mini-toast .toast-card,
                .glass-panel,
                .nav-bar,
                #premium-welcome-tour {
                    backdrop-filter: blur(8px) !important;
                    -webkit-backdrop-filter: blur(8px) !important;
                }

                /* Disable heavy animations */
                .sparkle,
                .crown-float,
                .crown-glow,
                .btn-shine::after {
                    animation: none !important;
                    display: none !important;
                }
            }

            /* Micro Feedback Root */
            #micro-feedback-root {
                position: fixed;
                left: 0;
                right: 0;
                bottom: var(--micro-feedback-bottom, 100px);
                z-index: 9999;
                display: flex;
                justify-content: center;
                pointer-events: none;
                padding: 0 16px;
                transition: bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            }

            #micro-feedback-root .micro-pill {
                pointer-events: auto;
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* PREMIUM 3D GOLD ICONS - Apple Award Level Aesthetics            */
            /* Supports: <img> with 3D PNG assets                              */
            /* ═══════════════════════════════════════════════════════════════ */

            .gold-icon-premium {
                /* Base sizing - responsive */
                width: 48px;
                height: 48px;
                display: inline-block;
                position: relative;
                flex-shrink: 0;

                /* iOS rendering fix */
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                will-change: transform, filter;
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;

                /* Smooth transitions for all effects */
                transition:
                    transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1),
                    filter 0.3s ease,
                    box-shadow 0.3s ease;
            }

            /* The actual image inside */
            .gold-icon-premium img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                display: block;
                border-radius: 12px;

                /* iOS rendering optimization */
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* LIGHT MODE - Realistic Drop Shadows                             */
            /* ═══════════════════════════════════════════════════════════════ */
            .gold-icon-premium {
                /* Multi-layer realistic shadow */
                filter:
                    drop-shadow(0 8px 16px rgba(180, 140, 30, 0.25)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.12)) drop-shadow(0 2px 3px rgba(0, 0, 0, 0.08));
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* DARK MODE - Golden Glow Effect                                  */
            /* ═══════════════════════════════════════════════════════════════ */
            html.dark .gold-icon-premium {
                /* Golden glow + enhanced contrast */
                filter:
                    drop-shadow(0 0 20px rgba(255, 214, 10, 0.4)) drop-shadow(0 0 40px rgba(245, 158, 11, 0.25)) drop-shadow(0 8px 16px rgba(0, 0, 0, 0.35)) contrast(1.08) brightness(1.05);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* HOVER STATE - Float Up & Shine Animation                        */
            /* ═══════════════════════════════════════════════════════════════ */
            .gold-icon-premium:hover {
                transform: translateY(-6px) translateZ(0) scale(1.05);
            }

            /* Light mode hover - intensified shadows */
            .gold-icon-premium:hover {
                filter:
                    drop-shadow(0 14px 28px rgba(180, 140, 30, 0.35)) drop-shadow(0 8px 16px rgba(0, 0, 0, 0.18)) drop-shadow(0 4px 6px rgba(0, 0, 0, 0.12)) brightness(1.08);
            }

            /* Dark mode hover - enhanced glow */
            html.dark .gold-icon-premium:hover {
                filter:
                    drop-shadow(0 0 28px rgba(255, 214, 10, 0.6)) drop-shadow(0 0 56px rgba(245, 158, 11, 0.35)) drop-shadow(0 12px 24px rgba(0, 0, 0, 0.45)) contrast(1.12) brightness(1.12);
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* ACTIVE/TAP STATE                                                */
            /* ═══════════════════════════════════════════════════════════════ */
            .gold-icon-premium:active {
                transform: translateY(-2px) translateZ(0) scale(0.98);
                transition-duration: 0.1s;
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* RESPONSIVE SIZING                                               */
            /* ═══════════════════════════════════════════════════════════════ */

            /* Desktop - larger icons */
            @media (min-width: 768px) {
                .gold-icon-premium {
                    width: 56px;
                    height: 56px;
                }

                .gold-icon-premium img {
                    border-radius: 14px;
                }
            }

            /* Mobile small screens - compact */
            @media (max-width: 420px) {
                .gold-icon-premium {
                    width: 42px;
                    height: 42px;
                }

                .gold-icon-premium img {
                    border-radius: 10px;
                }
            }

            /* Very small screens */
            @media (max-width: 360px) {
                .gold-icon-premium {
                    width: 38px;
                    height: 38px;
                }
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* REDUCED MOTION - Accessibility                                  */
            /* ═══════════════════════════════════════════════════════════════ */
            @media (prefers-reduced-motion: reduce) {
                .gold-icon-premium {
                    transition: none !important;
                }

                .gold-icon-premium:hover {
                    transform: translateZ(0) !important;
                }
            }

            /* ═══════════════════════════════════════════════════════════════ */
            /* SHINE ANIMATION OVERLAY (Optional - for extra premium feel)     */
            /* ═══════════════════════════════════════════════════════════════ */
            .gold-icon-premium::after {
                content: '';
                position: absolute;
                inset: 0;
                border-radius: 12px;
                pointer-events: none;

                /* Shine gradient */
                background: linear-gradient(115deg,
                        rgba(255, 255, 255, 0) 0%,
                        rgba(255, 255, 255, 0) 35%,
                        rgba(255, 255, 255, 0.5) 50%,
                        rgba(255, 255, 255, 0) 65%,
                        rgba(255, 255, 255, 0) 100%);
                background-size: 300% 100%;
                background-position: 200% 0;

                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .gold-icon-premium:hover::after {
                opacity: 0.6;
                animation: goldIconShine 0.8s ease-out forwards;
            }

            @keyframes goldIconShine {
                0% {
                    background-position: 200% 0;
                }

                100% {
                    background-position: -100% 0;
                }
            }

            html.dark .gold-icon-premium:hover::after {
                opacity: 0.4;
            }

            /* ================================
           iOS-style 3D Gold Icons (No emoji)
           Scoped: only .gold3d-icon
        ================================== */
            .gold3d-icon {
                width: 42px;
                height: 42px;
                display: inline-block;
                border-radius: 14px;
                position: relative;
                flex: 0 0 auto;
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                will-change: transform;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.05));
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow:
                    0 10px 22px rgba(0, 0, 0, 0.18),
                    inset 0 1px 0 rgba(255, 255, 255, 0.35);
                overflow: hidden;
            }

            /* coin body */
            .gold3d-icon::before {
                content: "";
                position: absolute;
                inset: 7px;
                border-radius: 999px;

                /* 3D coin gradient */
                background:
                    radial-gradient(circle at 30% 25%, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.0) 42%),
                    radial-gradient(circle at 70% 80%, rgba(0, 0, 0, 0.18), rgba(0, 0, 0, 0.0) 55%),
                    linear-gradient(135deg, rgba(255, 214, 10, 0.98), rgba(245, 158, 11, 0.98));

                box-shadow:
                    0 10px 18px rgba(0, 0, 0, 0.22),
                    inset 0 2px 2px rgba(255, 255, 255, 0.55),
                    inset 0 -3px 6px rgba(0, 0, 0, 0.20);
            }

            /* rim + shine streak */
            .gold3d-icon::after {
                content: "";
                position: absolute;
                inset: 7px;
                border-radius: 999px;

                background: linear-gradient(115deg,
                        rgba(255, 255, 255, 0.0) 0%,
                        rgba(255, 255, 255, 0.55) 22%,
                        rgba(255, 255, 255, 0.0) 52%,
                        rgba(255, 255, 255, 0.0) 100%);
                background-size: 220% 100%;
                background-position: -140% 0;

                /* Sweep animation instead of slide */
                animation: goldSheen 2.6s ease-in-out infinite;

                will-change: background-position, opacity;
                transform: translateZ(0);
                backface-visibility: hidden;

                mix-blend-mode: normal;
                opacity: 0.45;

                box-shadow:
                    inset 0 0 0 1.5px rgba(255, 255, 255, 0.18),
                    inset 0 0 0 6px rgba(0, 0, 0, 0.06);
                pointer-events: none;
            }

            /* Dark mode premium tuning */
            html.dark .gold3d-icon::after {
                opacity: 0.38;
                filter: blur(0.35px);
                box-shadow:
                    inset 0 0 0 1.5px rgba(255, 255, 255, 0.14),
                    inset 0 0 0 7px rgba(0, 0, 0, 0.10);
            }

            html.dark .gold3d-icon::before {
                box-shadow:
                    0 12px 22px rgba(0, 0, 0, 0.34),
                    inset 0 2px 2px rgba(255, 255, 255, 0.50),
                    inset 0 -4px 10px rgba(0, 0, 0, 0.28);
            }

            /* Gram: coin + small "bar" badge */
            .gold3d-icon--gram i {
                display: none;
            }

            .gold3d-icon--gram .dummy {
                display: none;
            }

            .gold3d-icon--gram span {
                display: none;
            }

            /* bar overlay (gram altın hissi) */
            .gold3d-icon--gram {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.20), rgba(139, 92, 246, 0.12));
            }

            .gold3d-icon--gram::marker {
                content: "";
            }

            /* noop */
            .gold3d-icon--gram .x {
                display: none;
            }

            /* Gold bar layer - consolidated */
            .gold3d-icon--gram>* {
                display: none;
            }

            .gold3d-icon--gram {
                position: relative;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(139, 92, 246, 0.10));
            }

            .gold3d-icon--gram .gold-bar {
                display: none;
            }

            .gold3d-icon--gram::before {
                background:
                    /* gold bar */
                    linear-gradient(135deg, rgba(255, 214, 10, 0.95), rgba(245, 158, 11, 0.95)) 55% 68% / 55% 28% no-repeat,
                    radial-gradient(circle at 30% 25%, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.0) 42%),
                    radial-gradient(circle at 70% 80%, rgba(0, 0, 0, 0.18), rgba(0, 0, 0, 0.0) 55%),
                    linear-gradient(135deg, rgba(255, 214, 10, 0.98), rgba(245, 158, 11, 0.98));
                box-shadow:
                    0 10px 18px rgba(0, 0, 0, 0.22),
                    inset 0 2px 2px rgba(255, 255, 255, 0.55),
                    inset 0 -3px 6px rgba(0, 0, 0, 0.20);
            }

            /* Çeyrek: slightly different hue + “stamp” */
            .gold3d-icon--ceyrek::before {
                background:
                    /* inner stamp */
                    radial-gradient(circle at 55% 55%, rgba(255, 255, 255, 0.20), rgba(255, 255, 255, 0.0) 55%),
                    radial-gradient(circle at 30% 25%, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.0) 42%),
                    radial-gradient(circle at 70% 80%, rgba(0, 0, 0, 0.18), rgba(0, 0, 0, 0.0) 55%),
                    linear-gradient(135deg, rgba(252, 211, 77, 0.98), rgba(245, 158, 11, 0.98));
            }


            /* Sweep animation (no transform shift) */
            @keyframes goldSheen {
                0% {
                    background-position: -140% 0;
                    opacity: .28;
                }

                50% {
                    background-position: 40% 0;
                    opacity: .52;
                }

                100% {
                    background-position: 140% 0;
                    opacity: .30;
                }
            }

            /* Mobile size tuning */
            @media (max-width: 420px) {
                .gold3d-icon {
                    width: 38px;
                    height: 38px;
                    border-radius: 13px;
                }

                .gold3d-icon::before,
                .gold3d-icon::after {
                    inset: 6px;
                }
            }

            /* Reduced motion */
            @media (prefers-reduced-motion: reduce) {
                .gold3d-icon::after {
                    animation: none !important;
                }
            }

            /* ================================
           STORY MODE ONBOARDING 3D CSS
           Scoped: #onboarding-sheet .onb-*
        ================================== */

            /* -- Global Page Transition Overrides -- */
            .onb-page {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                will-change: transform, opacity, filter;
                transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), filter 0.4s ease;
            }

            .onb-enter-state {
                opacity: 0;
                transform: scale(1.05);
                /* Slight zoom in start */
                filter: blur(8px);
            }

            .onb-active-state {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }

            /* -- 1. HERO MOCKUP (Phone + Icons) -- */
            .onb-hero-mockup-wrapper {
                position: relative;
                width: 220px;
                height: 240px;
                margin: 20px auto 30px;
                perspective: 1000px;
            }

            .onb-icon-parade {
                position: absolute;
                top: -20px;
                left: -40px;
                right: -40px;
                display: flex;
                justify-content: space-around;
                pointer-events: none;
                z-index: 10;
            }

            .onb-float-icon {
                font-size: 28px;
                filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
                animation: floatIcon 3s ease-in-out infinite;
                animation-delay: var(--d, 0s);
            }

            @keyframes floatIcon {

                0%,
                100% {
                    transform: translateY(0);
                }

                50% {
                    transform: translateY(-10px);
                }
            }

            .onb-iphone-3d {
                width: 160px;
                height: 220px;
                background: #121212;
                border-radius: 24px;
                margin: 20px auto 0;
                position: relative;
                box-shadow:
                    0 20px 40px rgba(0, 0, 0, 0.4),
                    inset 0 0 0 4px #333,
                    inset 0 0 0 6px #000;
                transform: rotateY(-10deg) rotateX(5deg);
                transition: transform 0.5s ease;
                animation: phoneSway 6s ease-in-out infinite alternate;
            }

            @keyframes phoneSway {
                0% {
                    transform: rotateY(-8deg) rotateX(4deg);
                }

                100% {
                    transform: rotateY(8deg) rotateX(4deg);
                }
            }

            .onb-iphone-notch {
                position: absolute;
                top: 6px;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 14px;
                background: #000;
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
                z-index: 20;
            }

            .onb-iphone-screen {
                position: absolute;
                inset: 6px;
                border-radius: 20px;
                background: linear-gradient(180deg, #1c1c1e 0%, #2c2c2e 100%);
                overflow: hidden;
                padding: 24px 10px 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .onb-screen-header {
                height: 20px;
                background: linear-gradient(90deg, #6366f1, #8b5cf6);
                border-radius: 6px;
                opacity: 0.8;
            }

            .onb-screen-row {
                height: 12px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
                width: 70%;
            }

            .onb-screen-card {
                flex: 1;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            /* -- 2. MARKET 3D GRID -- */
            .onb-market-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                width: 100%;
                max-width: 280px;
                margin: 20px auto 30px;
            }

            .onb-market-card {
                background: rgba(255, 255, 255, 0.08);
                /* Dark mode default */
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 16px;
                padding: 12px;
                display: flex;
                flex-direction: column;
                gap: 4px;
                transform: translateY(20px);
                opacity: 0;
                animation: cardPopUp 0.6s cubic-bezier(0.2, 0.9, 0.2, 1) forwards;
                animation-delay: calc(var(--i) * 0.1s);
            }

            @keyframes cardPopUp {
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .omc-label {
                font-size: 10px;
                font-weight: 700;
                color: #aaa;
                letter-spacing: 0.5px;
            }

            .omc-val {
                font-size: 14px;
                font-weight: 800;
                color: #fff;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .omc-up {
                color: #4ade80;
                font-size: 10px;
            }

            .omc-down {
                color: #f87171;
                font-size: 10px;
            }

            /* -- 3. RINGS PRO -- */
            .onb-rings-container {
                width: 200px;
                height: 200px;
                margin: 20px auto 30px;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .onb-ring-outer {
                position: absolute;
                inset: 0;
                border-radius: 50%;
                background: conic-gradient(#6366f1 0%, #a855f7 70%, rgba(255, 255, 255, 0.1) 70%);
                mask: radial-gradient(transparent 62%, black 63%);
                -webkit-mask: radial-gradient(transparent 62%, black 63%);
                /* Hole */
                animation: spinRing 2s cubic-bezier(0.2, 1, 0.7, 1);
            }

            .onb-ring-inner {
                position: absolute;
                inset: 20px;
                border-radius: 50%;
                background: conic-gradient(#ec4899 0%, #f43f5e 45%, rgba(255, 255, 255, 0.05) 45%);
                mask: radial-gradient(transparent 62%, black 63%);
                -webkit-mask: radial-gradient(transparent 62%, black 63%);
                animation: spinRing2 2.4s cubic-bezier(0.1, 1, 0.6, 1);
                opacity: 0.8;
            }

            @keyframes spinRing {
                from {
                    transform: rotate(-90deg) scale(0.9);
                    opacity: 0;
                }

                to {
                    transform: rotate(0deg) scale(1);
                    opacity: 1;
                }
            }

            @keyframes spinRing2 {
                from {
                    transform: rotate(-120deg);
                    opacity: 0;
                }

                to {
                    transform: rotate(0deg);
                    opacity: 0.8;
                }
            }

            .onb-ring-text {
                text-align: center;
                display: flex;
                flex-direction: column;
                z-index: 20;
            }

            .ort-label {
                font-size: 11px;
                text-transform: uppercase;
                color: #888;
                font-weight: 700;
            }

            .ort-val {
                font-size: 24px;
                font-weight: 800;
                background: linear-gradient(135deg, #fff, #ccc);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            /* -- 4. SMART STACK -- */
            .onb-card-stack {
                position: relative;
                width: 240px;
                height: 160px;
                margin: 40px auto 50px;
                perspective: 800px;
            }

            .ocs-card {
                position: absolute;
                inset: 0;
                border-radius: 18px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            }

            .ocs-1 {
                z-index: 3;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));
                transform: translateY(0) scale(1);
            }

            .ocs-2 {
                z-index: 2;
                transform: translateY(14px) scale(0.92);
                opacity: 0.6;
            }

            .ocs-3 {
                z-index: 1;
                transform: translateY(28px) scale(0.84);
                opacity: 0.3;
            }

            .onb-enter-state .ocs-1 {
                transform: translateY(40px) scale(0.8);
                opacity: 0;
            }

            .ocs-note {
                font-weight: 600;
                font-size: 14px;
                color: #fff;
            }

            /* -- 5. PREMIUM REVEAL -- */
            .onb-premium-reveal {
                position: relative;
                width: 220px;
                height: 220px;
                margin: 20px auto 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .opr-glow-crown {
                font-size: 64px;
                filter: drop-shadow(0 0 20px rgba(234, 179, 8, 0.6));
                animation: crownPulse 2s ease-in-out infinite;
                z-index: 10;
            }

            @keyframes crownPulse {

                0%,
                100% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.1);
                    filter: drop-shadow(0 0 30px rgba(234, 179, 8, 0.9));
                }
            }

            .opr-card {
                position: absolute;
                width: 180px;
                height: 120px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.02));
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 16px;
                top: 60%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-10deg);
                z-index: 1;
                padding: 16px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .opr-line {
                height: 8px;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 4px;
                width: 100%;
            }

            .opr-chart {
                flex: 1;
                background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.2), transparent);
                margin-top: 4px;
                border-radius: 4px;
            }

            /* ═══════════════════════════════════════════════════════════════
           PREMIUM ONBOARDING 3D - Full Screen & Motion System
        ═══════════════════════════════════════════════════════════════ */

            /* Full-screen overlay fix */
            #onboarding-sheet {
                position: fixed !important;
                inset: 0 !important;
                width: 100vw !important;
                height: 100dvh !important;
                padding-top: env(safe-area-inset-top, 0);
                padding-bottom: env(safe-area-inset-bottom, 0);
                z-index: 99999 !important;
            }

            .onb-inner {
                min-height: 100dvh;
                display: flex;
                flex-direction: column;
            }

            #onb-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            /* Premium content transitions */
            .onb-scene {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .onb-scene-enter {
                opacity: 0;
                transform: translateY(12px) scale(0.97);
                filter: blur(8px);
            }

            .onb-scene-active {
                opacity: 1;
                transform: none;
                filter: blur(0);
                transition: opacity 0.35s ease, transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1), filter 0.35s ease;
            }

            .onb-scene-exit {
                opacity: 0;
                transform: translateY(-8px) scale(0.98);
                filter: blur(6px);
                transition: all 0.25s ease;
            }

            /* Visual container */
            .onb-visual {
                width: 100%;
                max-width: 320px;
                height: 280px;
                margin: 0 auto 24px;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                perspective: 1200px;
            }

            /* ─────────────────────────────────────────────────────────────
           1. HERO MOCKUP 3D - iPhone with floating icons
        ───────────────────────────────────────────────────────────── */
            .hero3d-wrapper {
                position: relative;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .hero3d-phone {
                width: 140px;
                height: 260px;
                background: linear-gradient(145deg, #1a1a1e, #0d0d0f);
                border-radius: 28px;
                position: relative;
                box-shadow:
                    0 30px 60px rgba(0, 0, 0, 0.5),
                    inset 0 0 0 2px rgba(255, 255, 255, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15);
                transform: rotateY(-8deg) rotateX(4deg);
                animation: heroPhoneFloat 5s ease-in-out infinite;
                transform-style: preserve-3d;
            }

            @keyframes heroPhoneFloat {

                0%,
                100% {
                    transform: rotateY(-8deg) rotateX(4deg) translateY(0);
                }

                50% {
                    transform: rotateY(-6deg) rotateX(3deg) translateY(-8px);
                }
            }

            .hero3d-notch {
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 50px;
                height: 12px;
                background: #000;
                border-radius: 8px;
                z-index: 10;
            }

            .hero3d-screen {
                position: absolute;
                inset: 8px;
                border-radius: 22px;
                background: linear-gradient(180deg, #1c1c2e 0%, #12121a 100%);
                overflow: hidden;
                padding: 20px 8px 8px;
            }

            .hero3d-screen-header {
                height: 16px;
                background: linear-gradient(90deg, #6366f1, #a855f7);
                border-radius: 6px;
                margin-bottom: 8px;
                opacity: 0.9;
            }

            .hero3d-screen-row {
                height: 10px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 4px;
                margin-bottom: 6px;
                width: 70%;
            }

            .hero3d-screen-card {
                height: 40px;
                background: rgba(99, 102, 241, 0.15);
                border: 1px solid rgba(99, 102, 241, 0.25);
                border-radius: 8px;
                margin-top: 8px;
            }

            .hero3d-screen-chart {
                height: 30px;
                margin-top: 8px;
                background: linear-gradient(90deg, transparent 10%, rgba(99, 102, 241, 0.3) 50%, transparent 90%);
                border-radius: 4px;
            }

            /* Floating icons around phone */
            .hero3d-icons {
                position: absolute;
                inset: 0;
                pointer-events: none;
            }

            .hero3d-icon {
                position: absolute;
                width: 36px;
                height: 36px;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(8px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                animation: iconFloat 4s ease-in-out infinite;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            }

            .hero3d-icon:nth-child(1) {
                top: 10%;
                left: 5%;
                animation-delay: 0s;
            }

            .hero3d-icon:nth-child(2) {
                top: 5%;
                right: 10%;
                animation-delay: 0.3s;
            }

            .hero3d-icon:nth-child(3) {
                top: 40%;
                left: 0%;
                animation-delay: 0.6s;
            }

            .hero3d-icon:nth-child(4) {
                top: 35%;
                right: 0%;
                animation-delay: 0.9s;
            }

            .hero3d-icon:nth-child(5) {
                bottom: 20%;
                left: 8%;
                animation-delay: 1.2s;
            }

            .hero3d-icon:nth-child(6) {
                bottom: 15%;
                right: 5%;
                animation-delay: 1.5s;
            }

            @keyframes iconFloat {

                0%,
                100% {
                    transform: translateY(0) scale(1);
                }

                50% {
                    transform: translateY(-6px) scale(1.05);
                }
            }

            /* ─────────────────────────────────────────────────────────────
           2. MARKET DECK 3D - Glass cards with tilt
        ───────────────────────────────────────────────────────────── */
            .market3d-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                width: 100%;
                max-width: 280px;
            }

            .market3d-card {
                background: rgba(255, 255, 255, 0.06);
                backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px;
                padding: 14px;
                position: relative;
                overflow: hidden;
                transform: translateZ(0);
                animation: cardSlideUp 0.6s cubic-bezier(0.2, 0.9, 0.3, 1) forwards;
                animation-delay: calc(var(--i, 0) * 0.1s);
                opacity: 0;
            }

            @keyframes cardSlideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px) rotateX(-10deg);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) rotateX(0);
                }
            }

            .market3d-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 200%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
                animation: shimmer 3s infinite;
            }

            @keyframes shimmer {
                0% {
                    left: -100%;
                }

                100% {
                    left: 100%;
                }
            }

            .market3d-icon {
                width: 32px;
                height: 32px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                margin-bottom: 8px;
                background: rgba(255, 255, 255, 0.08);
            }

            html.dark .market3d-icon {
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            .market3d-label {
                font-size: 10px;
                font-weight: 700;
                color: rgba(255, 255, 255, 0.5);
                letter-spacing: 0.5px;
                text-transform: uppercase;
            }

            .market3d-value {
                font-size: 18px;
                font-weight: 800;
                color: #fff;
                margin-top: 4px;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .market3d-change {
                font-size: 11px;
                font-weight: 700;
                padding: 2px 6px;
                border-radius: 6px;
            }

            .market3d-change.up {
                background: rgba(74, 222, 128, 0.15);
                color: #4ade80;
            }

            .market3d-change.down {
                background: rgba(248, 113, 113, 0.15);
                color: #f87171;
            }

            /* ─────────────────────────────────────────────────────────────
           3. SCAN & VOICE 3D - Camera frame + waveform
        ───────────────────────────────────────────────────────────── */
            .scan3d-wrapper {
                position: relative;
                width: 220px;
                height: 220px;
            }

            .scan3d-frame {
                width: 100%;
                height: 160px;
                background: rgba(0, 0, 0, 0.4);
                border: 2px solid rgba(99, 102, 241, 0.5);
                border-radius: 16px;
                position: relative;
                overflow: hidden;
            }

            .scan3d-corners {
                position: absolute;
                inset: 8px;
                border: 2px solid #6366f1;
                border-radius: 8px;
                clip-path: polygon(0 0, 20% 0, 20% 2px, 2px 2px, 2px 20%, 0 20%, 0 80%, 2px 80%, 2px 98%, 20% 98%, 20% 100%, 0 100%, 0 0, 100% 0, 100% 20%, 98% 20%, 98% 2px, 80% 2px, 80% 0, 100% 0, 100% 100%, 80% 100%, 80% 98%, 98% 98%, 98% 80%, 100% 80%);
            }

            .scan3d-line {
                position: absolute;
                left: 10%;
                right: 10%;
                height: 2px;
                background: linear-gradient(90deg, transparent, #6366f1, transparent);
                box-shadow: 0 0 10px #6366f1;
                animation: scanMove 2s ease-in-out infinite;
            }

            @keyframes scanMove {

                0%,
                100% {
                    top: 15%;
                }

                50% {
                    top: 85%;
                }
            }

            .scan3d-receipt {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 48px;
                opacity: 0.6;
            }

            .scan3d-voice {
                margin-top: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 3px;
                height: 40px;
            }

            .scan3d-bar {
                width: 4px;
                background: linear-gradient(180deg, #6366f1, #a855f7);
                border-radius: 2px;
                animation: voicePulse 0.8s ease-in-out infinite;
            }

            .scan3d-bar:nth-child(1) {
                height: 20px;
                animation-delay: 0s;
            }

            .scan3d-bar:nth-child(2) {
                height: 30px;
                animation-delay: 0.1s;
            }

            .scan3d-bar:nth-child(3) {
                height: 40px;
                animation-delay: 0.2s;
            }

            .scan3d-bar:nth-child(4) {
                height: 25px;
                animation-delay: 0.3s;
            }

            .scan3d-bar:nth-child(5) {
                height: 35px;
                animation-delay: 0.4s;
            }

            .scan3d-bar:nth-child(6) {
                height: 20px;
                animation-delay: 0.5s;
            }

            .scan3d-bar:nth-child(7) {
                height: 28px;
                animation-delay: 0.6s;
            }

            @keyframes voicePulse {

                0%,
                100% {
                    transform: scaleY(0.6);
                    opacity: 0.7;
                }

                50% {
                    transform: scaleY(1);
                    opacity: 1;
                }
            }

            /* ─────────────────────────────────────────────────────────────
           4. BRAIN ORB 3D - Glowing orb with neural connections
        ───────────────────────────────────────────────────────────── */
            .brain3d-wrapper {
                position: relative;
                width: 240px;
                height: 240px;
            }

            .brain3d-orb {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 100px;
                height: 100px;
                background: radial-gradient(circle at 30% 30%, #a855f7, #6366f1 60%, #4338ca);
                border-radius: 50%;
                box-shadow:
                    0 0 40px rgba(99, 102, 241, 0.5),
                    0 0 80px rgba(168, 85, 247, 0.3),
                    inset 0 0 30px rgba(255, 255, 255, 0.2);
                animation: orbPulse 3s ease-in-out infinite;
            }

            @keyframes orbPulse {

                0%,
                100% {
                    transform: translate(-50%, -50%) scale(1);
                    box-shadow: 0 0 40px rgba(99, 102, 241, 0.5), 0 0 80px rgba(168, 85, 247, 0.3);
                }

                50% {
                    transform: translate(-50%, -50%) scale(1.08);
                    box-shadow: 0 0 60px rgba(99, 102, 241, 0.7), 0 0 100px rgba(168, 85, 247, 0.5);
                }
            }

            .brain3d-emoji {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
                z-index: 10;
            }

            .brain3d-nodes {
                position: absolute;
                inset: 0;
            }

            .brain3d-node {
                position: absolute;
                width: 12px;
                height: 12px;
                background: rgba(168, 85, 247, 0.8);
                border-radius: 50%;
                box-shadow: 0 0 10px rgba(168, 85, 247, 0.6);
                animation: nodePulse 2s ease-in-out infinite;
            }

            .brain3d-node:nth-child(1) {
                top: 10%;
                left: 50%;
                animation-delay: 0s;
            }

            .brain3d-node:nth-child(2) {
                top: 30%;
                left: 85%;
                animation-delay: 0.3s;
            }

            .brain3d-node:nth-child(3) {
                top: 70%;
                left: 85%;
                animation-delay: 0.6s;
            }

            .brain3d-node:nth-child(4) {
                top: 90%;
                left: 50%;
                animation-delay: 0.9s;
            }

            .brain3d-node:nth-child(5) {
                top: 70%;
                left: 15%;
                animation-delay: 1.2s;
            }

            .brain3d-node:nth-child(6) {
                top: 30%;
                left: 15%;
                animation-delay: 1.5s;
            }

            @keyframes nodePulse {

                0%,
                100% {
                    transform: scale(1);
                    opacity: 0.7;
                }

                50% {
                    transform: scale(1.3);
                    opacity: 1;
                }
            }

            .brain3d-insight {
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 12px;
                padding: 10px 16px;
                font-size: 12px;
                font-weight: 600;
                color: #fff;
                white-space: nowrap;
                animation: insightSlide 0.6s ease-out 0.5s forwards;
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }

            @keyframes insightSlide {
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }

            /* ─────────────────────────────────────────────────────────────
           5. PRO VAULT 3D - Premium reveal with sparkles
        ───────────────────────────────────────────────────────────── */
            .vault3d-wrapper {
                position: relative;
                width: 200px;
                height: 200px;
            }

            @keyframes float-slow {

                0%,
                100% {
                    transform: translateY(0);
                }

                50% {
                    transform: translateY(-10px);
                }
            }

            .animate-float-slow {
                animation: float-slow 4s ease-in-out infinite;
            }

            @keyframes pulse-slow {

                0%,
                100% {
                    opacity: 0.2;
                    transform: translate(-50%, -50%) scale(1);
                }

                50% {
                    opacity: 0.3;
                    transform: translate(-50%, -50%) scale(1.1);
                }
            }

            .animate-pulse-slow {
                animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }

            .vault3d-glow {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 140px;
                height: 140px;
                background: radial-gradient(circle, rgba(234, 179, 8, 0.3) 0%, transparent 70%);
                border-radius: 50%;
                animation: glowPulse 2s ease-in-out infinite;
            }

            @keyframes glowPulse {

                0%,
                100% {
                    transform: translate(-50%, -50%) scale(1);
                    opacity: 0.6;
                }

                50% {
                    transform: translate(-50%, -50%) scale(1.3);
                    opacity: 1;
                }
            }

            .vault3d-sparkles {
                position: absolute;
                inset: 0;
                overflow: hidden;
            }

            .vault3d-sparkle {
                position: absolute;
                width: 4px;
                height: 4px;
                background: #fbbf24;
                border-radius: 50%;
                animation: sparkle 1.5s ease-in-out infinite;
            }

            .vault3d-sparkle:nth-child(1) {
                top: 20%;
                left: 20%;
                animation-delay: 0s;
            }

            .vault3d-sparkle:nth-child(2) {
                top: 15%;
                left: 70%;
                animation-delay: 0.2s;
            }

            .vault3d-sparkle:nth-child(3) {
                top: 60%;
                left: 10%;
                animation-delay: 0.4s;
            }

            .vault3d-sparkle:nth-child(4) {
                top: 70%;
                left: 80%;
                animation-delay: 0.6s;
            }

            .vault3d-sparkle:nth-child(5) {
                top: 85%;
                left: 40%;
                animation-delay: 0.8s;
            }

            .vault3d-sparkle:nth-child(6) {
                top: 30%;
                left: 85%;
                animation-delay: 1s;
            }

            @keyframes sparkle {

                0%,
                100% {
                    transform: scale(0);
                    opacity: 0;
                }

                50% {
                    transform: scale(1.5);
                    opacity: 1;
                }
            }

            .vault3d-badge {
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #fbbf24, #f59e0b);
                color: #000;
                font-size: 11px;
                font-weight: 900;
                padding: 6px 14px;
                border-radius: 20px;
                letter-spacing: 1px;
                box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            }

            /* PRO Button glow */
            #onb-btn.onb-btn-pro {
                background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
                color: #000 !important;
                font-weight: 900 !important;
                box-shadow: 0 0 25px rgba(251, 191, 36, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3) !important;
            }

            /* Inline SVG Gold Icons */
            .gold3d-svg {
                width: 32px;
                height: 32px;
            }

            /* ═══════════════════════════════════════════════════════════════
           PIN REDESIGN (VISUAL ONLY) - Premium iOS Style
        ═══════════════════════════════════════════════════════════════ */

            /* Theme variables */
            :root {
                --pin-bg-1: rgba(120, 92, 255, .22);
                --pin-bg-2: rgba(0, 210, 255, .10);
                --pin-surface: rgba(255, 255, 255, .72);
                --pin-surface-2: rgba(255, 255, 255, .45);
                --pin-border: rgba(255, 255, 255, .35);
                --pin-text: #0b1020;
                --pin-sub: rgba(11, 16, 32, .55);
                --pin-accent: rgba(138, 116, 255, .95);
                --pin-shadow: 0 20px 60px rgba(10, 15, 35, .25);
            }

            html.dark {
                --pin-bg-1: rgba(138, 116, 255, .20);
                --pin-bg-2: rgba(0, 210, 255, .08);
                --pin-surface: rgba(18, 22, 40, .72);
                --pin-surface-2: rgba(18, 22, 40, .45);
                --pin-border: rgba(255, 255, 255, .10);
                --pin-text: rgba(255, 255, 255, .92);
                --pin-sub: rgba(255, 255, 255, .55);
                --pin-shadow: 0 30px 90px rgba(0, 0, 0, .45);
            }

            /* Full-screen + safe-area + true center (only when visible) */
            #pin-lock-screen:not(.hidden) {
                position: fixed !important;
                inset: 0 !important;
                z-index: 9999 !important;
                display: flex !important;
                align-items: stretch !important;
                justify-content: center !important;
                padding: calc(env(safe-area-inset-top, 0px) + 18px) 16px calc(env(safe-area-inset-bottom, 0px) + 18px) !important;
            }

            #pin-lock-screen::before {
                content: "";
                position: absolute;
                inset: 0;
                background:
                    radial-gradient(900px 600px at 20% 20%, var(--pin-bg-1), transparent 60%),
                    radial-gradient(900px 600px at 80% 80%, var(--pin-bg-2), transparent 60%),
                    linear-gradient(180deg, rgba(0, 0, 0, .10), rgba(0, 0, 0, .20));
                filter: saturate(1.15);
                pointer-events: none;
            }

            /* Premium wrapper + stage + card */
            #pin-lock-screen .pin-wrapper {
                position: relative;
                width: min(430px, 100%);
                height: 100%;
                margin: 0 auto;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
            }

            #pin-lock-screen .pin-stage {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #pin-lock-screen .pin-card {
                width: 100%;
                max-height: 100%;
                border-radius: 32px;
                background: linear-gradient(180deg, var(--pin-surface), var(--pin-surface-2));
                border: 1px solid var(--pin-border);
                box-shadow: var(--pin-shadow);
                backdrop-filter: blur(18px);
                -webkit-backdrop-filter: blur(18px);
                padding: 28px 22px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                position: relative;
            }

            #pin-lock-screen .pin-card::after {
                content: "";
                position: absolute;
                inset: -40%;
                background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, .25), transparent 55%);
                transform: rotate(12deg);
                pointer-events: none;
            }

            /* Premium title styling */
            #pin-title {
                color: var(--pin-text) !important;
                letter-spacing: -0.02em !important;
                font-size: 1.6rem !important;
                font-weight: 800 !important;
            }

            #pin-subtitle {
                color: var(--pin-sub) !important;
                font-size: 0.875rem !important;
            }

            /* Premium dots */
            #pin-lock-screen .pin-dot {
                background: rgba(255, 255, 255, .35) !important;
                border: 1px solid rgba(255, 255, 255, .22) !important;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, .25) !important;
            }

            html.dark #pin-lock-screen .pin-dot {
                background: rgba(255, 255, 255, .12) !important;
            }

            /* 3D Premium keypad */
            #pin-lock-screen .liquid-key {
                width: 72px !important;
                height: 58px !important;
                border-radius: 18px !important;
                background: linear-gradient(180deg, rgba(255, 255, 255, .75), rgba(255, 255, 255, .35)) !important;
                border: 1px solid rgba(255, 255, 255, .28) !important;
                box-shadow: 0 12px 26px rgba(0, 0, 0, .14), inset 0 1px 0 rgba(255, 255, 255, .35) !important;
                color: var(--pin-text) !important;
                font-weight: 800 !important;
                font-size: 20px !important;
                transition: transform .12s ease, box-shadow .12s ease, filter .12s ease !important;
                user-select: none !important;
                -webkit-tap-highlight-color: transparent !important;
            }

            html.dark #pin-lock-screen .liquid-key {
                background: linear-gradient(180deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .04)) !important;
                border: 1px solid rgba(255, 255, 255, .10) !important;
                color: rgba(255, 255, 255, .92) !important;
                box-shadow: 0 18px 34px rgba(0, 0, 0, .35), inset 0 1px 0 rgba(255, 255, 255, .08) !important;
            }

            #pin-lock-screen .liquid-key:active {
                transform: translateY(2px) scale(.99) !important;
                filter: brightness(1.05) !important;
            }

            /* Responsive for short screens */
            @media (max-height: 740px) {
                #pin-lock-screen .pin-card {
                    padding: 18px 16px;
                    border-radius: 28px;
                }

                #pin-lock-screen .liquid-key {
                    width: 66px !important;
                    height: 52px !important;
                    border-radius: 16px !important;
                }
            }

            /* Cancel button styling */
            #pin-lock-screen .safe-close-btn {
                position: absolute !important;
                top: calc(env(safe-area-inset-top, 0px) + 12px) !important;
                right: 12px !important;
                width: 40px !important;
                height: 40px !important;
                border-radius: 14px !important;
                background: rgba(255, 255, 255, .20) !important;
                border: 1px solid rgba(255, 255, 255, .16) !important;
                backdrop-filter: blur(10px) !important;
                -webkit-backdrop-filter: blur(10px) !important;
                z-index: 50 !important;
            }

            /* Entrance animation */
            @keyframes pinIn {
                from {
                    opacity: 0;
                    transform: translateY(14px) scale(.98);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            #pin-lock-screen:not(.hidden) .pin-card {
                animation: pinIn .28s cubic-bezier(.2, .9, .2, 1) both;
            }

            @media (prefers-reduced-motion: reduce) {
                #pin-lock-screen .pin-card {
                    animation: none !important;
                }

                #pin-lock-screen .liquid-key {
                    transition: none !important;
                }
            }

            /* =========================================================
           LIGHT MODE FIXES — PIN (visual only, no JS change)
           ========================================================= */

            /* Light mod algısı: projede dark class html'de kullanılıyor */
            html:not(.dark) {
                /* Daha “Apple / liquid glass” hissi */
                --pin-bg-1: rgba(120, 92, 255, .18);
                --pin-bg-2: rgba(0, 210, 255, .10);
                --pin-surface: rgba(255, 255, 255, .88);
                --pin-surface-2: rgba(255, 255, 255, .62);
                --pin-border: rgba(11, 16, 32, .10);
                --pin-text: #0b1020;
                --pin-sub: rgba(11, 16, 32, .58);
                --pin-shadow: 0 24px 70px rgba(2, 6, 23, .14);
            }

            /* Light mode’da PIN arka planını “karartan” siyah gradient'i kaldır */
            html:not(.dark) #pin-lock-screen::before {
                background:
                    radial-gradient(900px 600px at 20% 20%, var(--pin-bg-1), transparent 60%),
                    radial-gradient(900px 600px at 80% 80%, var(--pin-bg-2), transparent 60%),
                    linear-gradient(180deg, rgba(255, 255, 255, .55), rgba(245, 247, 255, .92)) !important;
                filter: saturate(1.08) contrast(1.02) !important;
            }

            /* Kart: daha temiz kenar + daha soft shadow */
            html:not(.dark) #pin-lock-screen .pin-card {
                border: 1px solid var(--pin-border) !important;
                box-shadow: var(--pin-shadow) !important;
            }

            /* Başlık/alt başlık: kontrastı iyileştir (lightta daha okunur) */
            html:not(.dark) #pin-lock-screen #pin-title {
                color: var(--pin-text) !important;
                letter-spacing: -0.2px;
            }

            html:not(.dark) #pin-lock-screen #pin-subtitle {
                color: var(--pin-sub) !important;
            }

            /* Noktalar: empty/filled ayrımı daha “premium” dursun */
            html:not(.dark) #pin-lock-screen .pin-dot {
                background: rgba(11, 16, 32, .14) !important;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, .7);
            }

            html:not(.dark) #pin-lock-screen .pin-dot.active {
                background: rgba(138, 116, 255, .95) !important;
                box-shadow: 0 8px 18px rgba(138, 116, 255, .25) !important;
            }

            /* Keypad tuşları: light modda “cam” hissi + sınır netliği */
            html:not(.dark) #pin-lock-screen .liquid-key {
                border: 1px solid rgba(11, 16, 32, .10) !important;
                background: linear-gradient(180deg, rgba(255, 255, 255, .96), rgba(255, 255, 255, .68)) !important;
                box-shadow: 0 12px 28px rgba(2, 6, 23, .10), inset 0 1px 0 rgba(255, 255, 255, .9) !important;
            }

            html:not(.dark) #pin-lock-screen .liquid-key:active {
                transform: translateY(1px) scale(0.985) !important;
                box-shadow: 0 8px 18px rgba(2, 6, 23, .12), inset 0 1px 0 rgba(255, 255, 255, .85) !important;
            }

            /* Cancel butonu: light modda daha “link” gibi dursun */
            html:not(.dark) #pin-lock-screen #btn-pin-cancel {
                color: rgba(11, 16, 32, .70) !important;
            }

            html:not(.dark) #pin-lock-screen #btn-pin-cancel:hover {
                color: rgba(11, 16, 32, .92) !important;
            }

            /* =========================================================
           LIGHT MODE FIXES — MICRO FEEDBACK (visual only, no JS change)
           ========================================================= */

            /* Root: zaten fixed & center; light’ta sadece daha temiz spacing */
            html:not(.dark) #micro-feedback-root:not(.hidden) {
                padding: 0 14px !important;
            }

            /* Toast pill: light glass */
            html:not(.dark) #micro-feedback-root .micro-pill {
                background: rgba(255, 255, 255, .92) !important;
                border: 1px solid rgba(11, 16, 32, .10) !important;
                color: rgba(11, 16, 32, .92) !important;
                box-shadow: 0 16px 40px rgba(2, 6, 23, .12) !important;
                backdrop-filter: blur(18px) saturate(1.1) !important;
            }

            /* Icon/metin kontrast */
            html:not(.dark) #micro-feedback-root .micro-pill__icon {
                opacity: .95 !important;
            }

            html:not(.dark) #micro-feedback-root .micro-pill__text {
                color: rgba(11, 16, 32, .90) !important;
            }

            /* Varyantlar: light modda “tinted glass” */
            html:not(.dark) #micro-feedback-root .micro-pill--success {
                background: linear-gradient(135deg, rgba(16, 185, 129, .18), rgba(255, 255, 255, .92)) !important;
                border-color: rgba(16, 185, 129, .22) !important;
            }

            html:not(.dark) #micro-feedback-root .micro-pill--info {
                background: linear-gradient(135deg, rgba(59, 130, 246, .18), rgba(255, 255, 255, .92)) !important;
                border-color: rgba(59, 130, 246, .22) !important;
            }

            html:not(.dark) #micro-feedback-root .micro-pill--warn {
                background: linear-gradient(135deg, rgba(245, 158, 11, .20), rgba(255, 255, 255, .92)) !important;
                border-color: rgba(245, 158, 11, .24) !important;
            }

            html:not(.dark) #micro-feedback-root .micro-pill--error {
                background: linear-gradient(135deg, rgba(239, 68, 68, .18), rgba(255, 255, 255, .92)) !important;
                border-color: rgba(239, 68, 68, .22) !important;
            }

            /* Micro chip: light modda daha premium */
            html:not(.dark) .micro-chip {
                background: rgba(255, 255, 255, .92) !important;
                border: 1px solid rgba(11, 16, 32, .10) !important;
                color: rgba(11, 16, 32, .92) !important;
                box-shadow: 0 12px 28px rgba(2, 6, 23, .12) !important;
                backdrop-filter: blur(16px) saturate(1.08) !important;
            }

            /* ═══════════════════════════════════════════════════════════════════════════════════ */
            /* PREMIUM WELCOME TOUR - Apple Award UI Design                                        */
            /* ═══════════════════════════════════════════════════════════════════════════════════ */

            #premium-welcome-tour {
                position: fixed;
                inset: 0;
                z-index: 99999;
                display: none;
                align-items: center;
                justify-content: center;
                padding: calc(var(--safe-area-top, 0px) + 16px) 16px calc(var(--safe-area-bottom, 0px) + 16px);
            }

            #premium-welcome-tour.pwt-open {
                display: flex;
            }

            /* Backdrop */
            .pwt-backdrop {
                position: absolute;
                inset: 0;
                background: linear-gradient(180deg, rgba(0, 0, 0, 0.85) 0%, rgba(15, 10, 30, 0.92) 100%);
                backdrop-filter: blur(24px) saturate(180%);
                -webkit-backdrop-filter: blur(24px) saturate(180%);
            }

            html:not(.dark) .pwt-backdrop {
                background: linear-gradient(180deg, rgba(255, 255, 255, 0.88) 0%, rgba(245, 240, 255, 0.95) 100%);
            }

            /* Main Card */
            .pwt-card {
                position: relative;
                width: 100%;
                max-width: 400px;
                max-height: 90vh;
                background: rgba(30, 25, 50, 0.85);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 32px;
                padding: 32px 24px 24px;
                box-shadow: 0 32px 80px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
                overflow: hidden;
                animation: pwt-fadeUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            html:not(.dark) .pwt-card {
                background: rgba(255, 255, 255, 0.92);
                border-color: rgba(0, 0, 0, 0.08);
                box-shadow: 0 32px 80px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.03) inset;
            }

            /* Premium Badge */
            .pwt-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 14px;
                border-radius: 50px;
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(234, 88, 12, 0.15));
                border: 1px solid rgba(245, 158, 11, 0.4);
                font-size: 11px;
                font-weight: 700;
                color: #fbbf24;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                animation: pwt-pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both;
            }

            html:not(.dark) .pwt-badge {
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(234, 88, 12, 0.1));
                color: #d97706;
            }

            /* Close Button */
            .pwt-close {
                position: absolute;
                top: 16px;
                right: 16px;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                color: rgba(255, 255, 255, 0.6);
                font-size: 18px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                z-index: 10;
            }

            .pwt-close:hover {
                background: rgba(255, 255, 255, 0.2);
                color: white;
            }

            html:not(.dark) .pwt-close {
                background: rgba(0, 0, 0, 0.06);
                color: rgba(0, 0, 0, 0.5);
            }

            html:not(.dark) .pwt-close:hover {
                background: rgba(0, 0, 0, 0.1);
                color: rgba(0, 0, 0, 0.8);
            }

            /* Hero Container */
            .pwt-hero {
                position: relative;
                height: 160px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 24px 0;
                perspective: 800px;
            }

            /* 3D Hero Icon */
            .pwt-hero-icon {
                position: relative;
                width: 120px;
                height: 120px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 64px;
                border-radius: 40px;
                background: linear-gradient(145deg, rgba(99, 102, 241, 0.3), rgba(168, 85, 247, 0.2));
                box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4), 0 0 80px rgba(168, 85, 247, 0.2);
                transform: rotateX(8deg) rotateY(-5deg);
                animation: pwt-softFloat 6s ease-in-out infinite, pwt-pop 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
                transition: transform 0.3s ease;
            }

            .pwt-hero-icon::before {
                content: '';
                position: absolute;
                inset: -3px;
                border-radius: 43px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), transparent 60%);
                pointer-events: none;
            }

            .pwt-hero-icon::after {
                content: '';
                position: absolute;
                top: 6px;
                left: 10%;
                right: 10%;
                height: 30%;
                background: linear-gradient(180deg, rgba(255, 255, 255, 0.25), transparent);
                border-radius: 40px 40px 80px 80px;
                pointer-events: none;
            }

            /* Hero Particles */
            .pwt-particles {
                position: absolute;
                inset: 0;
                pointer-events: none;
                overflow: hidden;
            }

            .pwt-particle {
                position: absolute;
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: rgba(245, 158, 11, 0.6);
                animation: pwt-float 4s ease-in-out infinite;
            }

            .pwt-particle:nth-child(1) {
                left: 15%;
                top: 20%;
                animation-delay: 0s;
            }

            .pwt-particle:nth-child(2) {
                left: 80%;
                top: 25%;
                animation-delay: 1s;
                background: rgba(168, 85, 247, 0.5);
            }

            .pwt-particle:nth-child(3) {
                left: 25%;
                top: 75%;
                animation-delay: 2s;
                background: rgba(99, 102, 241, 0.5);
            }

            .pwt-particle:nth-child(4) {
                left: 75%;
                top: 70%;
                animation-delay: 0.5s;
            }

            /* Content */
            .pwt-title {
                font-size: 26px;
                font-weight: 800;
                color: white;
                text-align: center;
                margin-bottom: 8px;
                line-height: 1.2;
            }

            html:not(.dark) .pwt-title {
                color: #1f2937;
            }

            .pwt-desc {
                font-size: 14px;
                color: rgba(255, 255, 255, 0.7);
                text-align: center;
                margin-bottom: 20px;
                line-height: 1.5;
            }

            html:not(.dark) .pwt-desc {
                color: rgba(31, 41, 55, 0.7);
            }

            /* Bullets */
            .pwt-bullets {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
                margin-bottom: 28px;
            }

            .pwt-bullet {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 14px;
                border-radius: 50px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.1);
                font-size: 12px;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.9);
            }

            html:not(.dark) .pwt-bullet {
                background: rgba(99, 102, 241, 0.08);
                border-color: rgba(99, 102, 241, 0.15);
                color: #4f46e5;
            }

            /* Progress Dots */
            .pwt-dots {
                display: flex;
                justify-content: center;
                gap: 8px;
                margin-bottom: 20px;
            }

            .pwt-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.2);
                transition: all 0.3s ease;
            }

            .pwt-dot.active {
                width: 24px;
                border-radius: 4px;
                background: linear-gradient(135deg, #6366f1, #a855f7);
            }

            html:not(.dark) .pwt-dot {
                background: rgba(0, 0, 0, 0.15);
            }

            html:not(.dark) .pwt-dot.active {
                background: linear-gradient(135deg, #6366f1, #a855f7);
            }

            /* CTA Button */
            .pwt-cta {
                width: 100%;
                padding: 16px;
                border: none;
                border-radius: 16px;
                background: linear-gradient(135deg, #6366f1, #a855f7);
                color: white;
                font-size: 16px;
                font-weight: 700;
                cursor: pointer;
                position: relative;
                overflow: hidden;
                transition: all 0.3s ease;
                box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
            }

            .pwt-cta:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 40px rgba(99, 102, 241, 0.5);
            }

            .pwt-cta:active {
                transform: scale(0.98);
            }

            .pwt-cta::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                animation: pwt-shimmer 3s infinite;
            }

            /* Animations */
            @keyframes pwt-fadeUp {
                from {
                    opacity: 0;
                    transform: translateY(30px) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            @keyframes pwt-softFloat {

                0%,
                100% {
                    transform: rotateX(8deg) rotateY(-5deg) translateY(0);
                }

                50% {
                    transform: rotateX(8deg) rotateY(-5deg) translateY(-8px);
                }
            }

            @keyframes pwt-pop {
                from {
                    opacity: 0;
                    transform: scale(0.5);
                }

                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes pwt-shimmer {
                0% {
                    left: -100%;
                }

                100% {
                    left: 200%;
                }
            }

            @keyframes pwt-float {

                0%,
                100% {
                    transform: translateY(0) scale(1);
                    opacity: 0.6;
                }

                50% {
                    transform: translateY(-15px) scale(1.2);
                    opacity: 1;
                }
            }

            /* Mobile Optimization */
            @media (max-height: 700px) {
                .pwt-card {
                    padding: 24px 20px 20px;
                }

                .pwt-hero {
                    height: 120px;
                    margin: 16px 0;
                }

                .pwt-hero-icon {
                    width: 90px;
                    height: 90px;
                    font-size: 48px;
                }

                .pwt-title {
                    font-size: 22px;
                }
            }
        </style>

        <div id="premium-paywall-modal" class="fixed inset-0 z-[9999] hidden" aria-hidden="true">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/70 backdrop-blur-2xl" onclick="window.PremiumManager.closeModal()">
            </div>

            <!-- Close Button -->
            <button onclick="window.PremiumManager.closeModal()"
                class="absolute top-4 right-4 z-50 w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white/60 hover:text-white transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>

            <!-- Modal Card -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-[340px] px-5 scale-95 opacity-0 transition-all duration-300"
                id="premium-modal-card">

                <!-- Card with subtle purple tint -->
                <div class="bg-[#18181b] rounded-[22px] overflow-hidden border border-purple-500/10">

                    <!-- Content -->
                    <div class="p-7 pt-8">

                        <!-- Icon - Purple gradient -->
                        <div
                            class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-fuchsia-500 flex items-center justify-center shadow-lg shadow-purple-500/25">
                            <span class="text-3xl">👑</span>
                        </div>

                        <!-- Title -->
                        <h2 class="text-[22px] font-semibold text-white text-center tracking-tight mb-1">
                            Fingenda Pro</h2>
                        <p class="text-[13px] text-gray-400 text-center mb-6">Tüm premium özelliklere eriş</p>

                        <!-- Features - Purple checkmarks -->
                        <div class="space-y-3 mb-6">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span class="text-[15px] text-white/90">Fingo Brain & AI Asistan</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span class="text-[15px] text-white/90">Sınırsız Taksit Takibi</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span class="text-[15px] text-white/90">OCR Fiş Tarama</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span class="text-[15px] text-white/90">Detaylı Raporlar</span>
                            </div>
                        </div>

                        <!-- Segmented Control - Purple accent -->
                        <div class="bg-white/5 rounded-xl p-1 flex mb-5">
                            <button id="btn-plan-monthly" onclick="window.PremiumManager.setPlan('monthly')"
                                class="flex-1 py-2.5 rounded-lg text-[13px] font-medium transition-all bg-purple-500 text-white">
                                Aylık
                            </button>
                            <button id="btn-plan-yearly" onclick="window.PremiumManager.setPlan('yearly')"
                                class="flex-1 py-2.5 rounded-lg text-[13px] font-medium transition-all text-gray-400">
                                Yıllık
                            </button>
                        </div>

                        <!-- Price -->
                        <div class="text-center mb-2">
                            <span id="price-amount" class="text-[34px] font-bold text-white tracking-tight">₺49</span>
                            <span id="price-period" class="text-[15px] text-gray-400">/ay</span>
                        </div>
                        <p class="text-[12px] text-center text-purple-400/80 mb-5">7 gün ücretsiz deneme</p>

                        <!-- CTA Button - Purple gradient -->
                        <button onclick="window.PremiumManager.upgradeToPremium()" id="btn-purchase-premium"
                            class="w-full py-[14px] rounded-xl bg-gradient-to-r from-indigo-500 via-purple-500 to-fuchsia-500 text-white font-semibold text-[17px] active:opacity-80 transition-opacity">
                            Devam Et
                        </button>

                        <!-- Terms -->
                        <p class="mt-4 text-[11px] text-center text-gray-500 leading-relaxed">
                            İstediğin zaman iptal edebilirsin.
                        </p>
                    </div>
                </div>
            </div>
        </div>


        <!-- 2. Logic Script -->
        <script>
            /**
             * PREMIUM MANAGER SYSTEM
             * Handles User Status (Free/Premium), UI Locking, and Paywall Interception
             */

            // Configuration: Add IDs of elements you want to lock here
            const PREMIUM_CONFIG = {
                storageKey: 'user_status', // localStorage key
                lockedFeatureIds: [
                    // nav-wallet removed - crown icon is now shown in HTML directly
                    'nav-assistant',   // Alternative ID
                    'nav-autopilot',   // Alternative ID assumption
                    'btn-fingo-brain'  // Generic button ID if exists
                ]
            };

            // ═══════════════════════════════════════════════════════════════════════════════════
            // PATCH: REFACTORED PremiumManager - Centralized Entitlement with IAP Integration
            // ═══════════════════════════════════════════════════════════════════════════════════
            window.PremiumManager = {
                isPremium: false,
                selectedPlan: 'yearly', // Default to yearly (better value)

                // Entitlement cache with timestamp
                _entitlementCache: {
                    isPremium: false,
                    expiresAt: null,
                    cachedAt: null,
                    source: null // 'iap' | 'revenuecat' | 'cache'
                },

                // Cache TTL: 1 hour for online validation
                CACHE_TTL_MS: 60 * 60 * 1000,

                // ==== CORE API ====

                // Initialize - call on app start
                async init() {
                    console.log('[PremiumManager] Initializing...');

                    // 1. Load cached entitlement for fast UI
                    this._loadCachedEntitlement();

                    // 2. Apply cached state immediately (fast UI)
                    if (this.isPremium) {
                        this.unlockAllFeatures();
                        console.log('[PremiumManager] Loaded cached PREMIUM state 👑');
                    } else {
                        this.lockFeatures();
                        console.log('[PremiumManager] Loaded cached FREE state 🔒');
                    }

                    // 3. Global click interceptor
                    document.addEventListener('click', this.handleInterception.bind(this), true);

                    // 4. Refresh entitlement in background (if online)
                    if (navigator.onLine) {
                        this.refreshEntitlement().catch(e => {
                            console.warn('[PremiumManager] Background refresh failed:', e);
                        });
                    }

                    // 5. Re-validate when coming back online
                    window.addEventListener('online', () => {
                        console.log('[PremiumManager] Back online, refreshing entitlement...');
                        this.refreshEntitlement();
                    });
                },

                // Check if premium (use this everywhere)
                checkPremium() {
                    return this.isPremium;
                },

                // Require premium for feature - shows paywall if not premium
                // Returns true if premium, false if paywall shown
                requirePremium(featureKey) {
                    if (this.isPremium) {
                        return true;
                    }

                    console.log(`[PremiumManager] Feature "${featureKey}" requires premium`);
                    window.ErrorLogger?.log('info', `Premium required: ${featureKey}`);
                    this.showPaywall(featureKey);
                    return false;
                },

                // Refresh entitlement from store (call after purchase/restore)
                async refreshEntitlement() {
                    console.log('[PremiumManager] Refreshing entitlement...');

                    try {
                        // Option A: RevenueCat (if available)
                        if (window.Purchases) {
                            const customerInfo = await window.Purchases.getCustomerInfo();
                            const isActive = customerInfo?.entitlements?.active?.['pro'] ||
                                customerInfo?.entitlements?.active?.['premium'];

                            this._updateEntitlement(!!isActive, 'revenuecat');
                            return;
                        }

                        // Option B: IAPManager entitlement
                        if (window.IAPManager?.entitlement) {
                            this._updateEntitlement(true, 'iap');
                            return;
                        }

                        // Option C: Check localStorage cache as fallback
                        const cached = localStorage.getItem('premium_entitlement');
                        if (cached) {
                            try {
                                const data = JSON.parse(cached);
                                // Validate expiration for subscriptions
                                if (data.expiresAt) {
                                    const isValid = new Date(data.expiresAt) > new Date();
                                    this._updateEntitlement(isValid, 'cache');
                                } else {
                                    // Lifetime - always valid
                                    this._updateEntitlement(true, 'cache');
                                }
                            } catch (e) {
                                this._updateEntitlement(false, 'none');
                            }
                        } else {
                            this._updateEntitlement(false, 'none');
                        }
                    } catch (e) {
                        console.error('[PremiumManager] Refresh error:', e);
                        window.ErrorLogger?.log('error', 'Entitlement refresh failed', { error: e.message });
                        // Keep current state on error (don't lock user out)
                    }
                },

                // ==== INTERNAL METHODS ====

                _loadCachedEntitlement() {
                    try {
                        const cached = localStorage.getItem('premium_cache');
                        if (cached) {
                            const data = JSON.parse(cached);
                            this._entitlementCache = data;
                            this.isPremium = data.isPremium;
                        } else {
                            // Fallback to old storage key
                            const oldStatus = localStorage.getItem(PREMIUM_CONFIG.storageKey);
                            this.isPremium = (oldStatus === 'premium' || oldStatus === 'pro');
                        }
                    } catch (e) {
                        this.isPremium = false;
                    }
                },

                _updateEntitlement(isPremium, source) {
                    const previousState = this.isPremium;
                    this.isPremium = isPremium;

                    // Update cache
                    this._entitlementCache = {
                        isPremium: isPremium,
                        cachedAt: new Date().toISOString(),
                        source: source
                    };
                    localStorage.setItem('premium_cache', JSON.stringify(this._entitlementCache));

                    // Also update old storage key for compatibility
                    localStorage.setItem(PREMIUM_CONFIG.storageKey, isPremium ? 'premium' : 'free');

                    // Update UI if state changed
                    if (previousState !== isPremium) {
                        console.log(`[PremiumManager] State changed: ${previousState} → ${isPremium}`);
                        if (isPremium) {
                            this.unlockAllFeatures();
                            window.showMicroFeedback?.({ message: '👑 Premium aktif!', type: 'success' });
                        } else {
                            this.lockFeatures();
                        }
                    }
                },

                // ==== PLAN SELECTION ====

                setPlan(plan) {
                    this.selectedPlan = plan;

                    const btnMonthly = document.getElementById('btn-plan-monthly');
                    const btnYearly = document.getElementById('btn-plan-yearly');
                    const priceAmount = document.getElementById('price-amount');
                    const pricePeriod = document.getElementById('price-period');

                    // Get real prices from IAPManager if available
                    const monthlyProduct = window.IAPManager?.products?.find(p =>
                        p.id?.includes('monthly'));
                    const yearlyProduct = window.IAPManager?.products?.find(p =>
                        p.id?.includes('yearly'));

                    if (plan === 'monthly') {
                        btnMonthly?.classList?.add('bg-purple-500', 'text-white');
                        btnMonthly?.classList?.remove('text-gray-400');
                        btnYearly?.classList?.remove('bg-purple-500', 'text-white');
                        btnYearly?.classList?.add('text-gray-400');

                        if (priceAmount) priceAmount.textContent = monthlyProduct?.price || '₺49';
                        if (pricePeriod) pricePeriod.textContent = '/ay';
                    } else {
                        btnYearly?.classList?.add('bg-purple-500', 'text-white');
                        btnYearly?.classList?.remove('text-gray-400');
                        btnMonthly?.classList?.remove('bg-purple-500', 'text-white');
                        btnMonthly?.classList?.add('text-gray-400');

                        if (priceAmount) priceAmount.textContent = yearlyProduct?.price || '₺399';
                        if (pricePeriod) pricePeriod.textContent = '/yıl';
                    }
                },

                // ==== UI METHODS ====

                handleInterception(e) {
                    if (this.isPremium) return;

                    const target = e.target.closest('[data-premium-locked="true"]');
                    if (target) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        this.showPaywall();
                    }
                },

                lockFeatures() {
                    PREMIUM_CONFIG.lockedFeatureIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.setAttribute('data-premium-locked', 'true');
                            el.classList.add('relative', 'group');

                            if (!el.querySelector('.premium-lock-icon')) {
                                const computedStyle = window.getComputedStyle(el);
                                if (computedStyle.position === 'static') {
                                    el.style.position = 'relative';
                                }

                                const icon = document.createElement('div');
                                icon.className = 'premium-lock-icon absolute -top-1 -right-1 w-5 h-5 bg-white dark:bg-gray-800 rounded-full flex items-center justify-center shadow-md border border-gray-100 dark:border-gray-700 z-50';
                                icon.innerHTML = '<span class="text-[10px]">🔒</span>';
                                el.appendChild(icon);
                            }
                        }
                    });

                    const badge = document.getElementById('user-plan-badge');
                    if (badge) badge.innerHTML = '<span class="relative z-10 flex items-center gap-1">✨ FREE</span>';
                },

                unlockAllFeatures() {
                    PREMIUM_CONFIG.lockedFeatureIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.removeAttribute('data-premium-locked');
                            const icon = el.querySelector('.premium-lock-icon');
                            if (icon) icon.remove();
                        }
                    });

                    document.querySelectorAll('[data-premium-locked="true"]').forEach(el => {
                        el.removeAttribute('data-premium-locked');
                        const icon = el.querySelector('.premium-lock-icon');
                        if (icon) icon.remove();
                    });

                    const badge = document.getElementById('user-plan-badge');
                    if (badge) {
                        badge.innerHTML = '<span class="relative z-10 flex items-center gap-1">👑 PRO</span><div class="absolute inset-0 shimmer opacity-50"></div>';
                        badge.style.background = 'linear-gradient(135deg, #F59E0B, #D97706)';
                    }
                },

                showPaywall(featureKey) {
                    // Pro ise paywall açma
                    if (this.isPremium || window.userStatus === 'pro') {
                        console.log('[PremiumManager] Paywall skipped - user is Pro');
                        const pm = document.getElementById('premium-modal');
                        if (pm) pm.classList.add('hidden');
                        return;
                    }

                    const modal = document.getElementById('premium-paywall-modal') ||
                        document.getElementById('premium-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                        // Log which feature triggered paywall
                        if (featureKey) {
                            window.ErrorLogger?.log('info', `Paywall shown for: ${featureKey}`);
                        }
                    }
                },

                closeModal() {
                    const modal = document.getElementById('premium-paywall-modal');
                    const card = document.getElementById('premium-modal-card');
                    if (!modal) return;

                    if (card) {
                        card.classList.remove('scale-100', 'opacity-100');
                        card.classList.add('scale-95', 'opacity-0');
                    }

                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                },

                // ==== PURCHASE FLOW ====

                async upgradeToPremium() {
                    const btn = document.getElementById('btn-purchase-premium');
                    if (!btn) return;

                    const originalText = btn.innerHTML;

                    // Loading State
                    btn.disabled = true;
                    btn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

                    try {
                        // Determine product ID based on selected plan
                        const productId = this.selectedPlan === 'monthly'
                            ? window.IAPManager?.PRODUCT_IDS?.MONTHLY
                            : window.IAPManager?.PRODUCT_IDS?.YEARLY;

                        // Attempt real purchase via IAPManager
                        const success = await window.IAPManager?.purchase(productId);

                        if (success) {
                            // ═══ SAVE TO LOCALSTORAGE FOR PERSISTENCE ═══
                            localStorage.setItem('user_membership_status', 'pro');
                            localStorage.setItem('user_status', 'pro');
                            console.log('[PremiumManager] 💾 Pro membership saved to localStorage.');

                            // Refresh entitlement after purchase
                            await this.refreshEntitlement();

                            // Close modal
                            this.closeModal();

                            // Celebrate!
                            window.showMicroFeedback?.({ message: '🎉 Premium aktif edildi!', type: 'success' });

                            // Confetti if available
                            if (window.confetti) {
                                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                            }
                        } else {
                            window.showMicroFeedback?.({ message: 'Satın alma iptal edildi', type: 'warning' });
                        }
                    } catch (e) {
                        console.error('[PremiumManager] Purchase error:', e);
                        window.ErrorLogger?.log('error', 'Purchase failed', { error: e.message });
                        window.alertMessage?.('Hata', 'Satın alma başarısız. Lütfen tekrar deneyin.', 'red');
                    } finally {
                        // Reset button
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                },

                // Restore purchases
                async restorePurchases() {
                    try {
                        window.showMicroFeedback?.({ message: '🔄 Geri yükleniyor...', type: 'info' });

                        await window.IAPManager?.restore();
                        await this.refreshEntitlement();

                        if (this.isPremium) {
                            window.alertMessage?.('Başarılı', 'Premium üyeliğiniz geri yüklendi! 👑', 'green');
                        } else {
                            window.alertMessage?.('Bilgi', 'Geri yüklenecek satın alma bulunamadı.', 'blue');
                        }
                    } catch (e) {
                        console.error('[PremiumManager] Restore error:', e);
                        window.alertMessage?.('Hata', 'Geri yükleme başarısız.', 'red');
                    }
                }
            };

            // Auto-run
            document.addEventListener('DOMContentLoaded', () => {
                // ═══════════════════════════════════════════════════════════════════
                // IMMEDIATE PREMIUM STATE RESTORATION (Before PremiumManager.init)
                // Now uses AppStorage hydration for iOS Capacitor support
                // ═══════════════════════════════════════════════════════════════════

                // Önce AppStorage'dan async hydration başlat
                window.ensurePremiumReady();

                (function restorePremiumStateImmediate() {
                    try {
                        // Check multiple storage keys for compatibility (sync initial check)
                        const savedUserStatus = localStorage.getItem('user_status');
                        const savedPremiumCache = localStorage.getItem('premium_cache');
                        const savedMembershipStatus = localStorage.getItem('user_membership_status');

                        let isProUser = false;

                        // Check user_membership_status (new key)
                        if (savedMembershipStatus === 'pro') {
                            isProUser = true;
                        }

                        // Check user_status (existing key)
                        if (savedUserStatus === 'pro' || savedUserStatus === 'premium') {
                            isProUser = true;
                        }

                        // Check premium_cache (PremiumManager's cache)
                        if (savedPremiumCache) {
                            try {
                                const cacheData = JSON.parse(savedPremiumCache);
                                if (cacheData.isPremium === true) {
                                    isProUser = true;
                                }
                            } catch (e) { /* ignore parse errors */ }
                        }

                        // AppStorage hydration sonucu da kontrol et (global var set edilmiş olabilir)
                        if (window.userStatus === 'pro') {
                            isProUser = true;
                        }

                        if (isProUser) {
                            console.log('[Premium] Restoring Pro status from storage...');

                            // A) Update global variables
                            userStatus = 'pro';
                            window.userStatus = 'pro';
                            if (typeof window.PremiumManager !== 'undefined') {
                                window.PremiumManager.isPremium = true;
                            }

                            // B) Ensure all storage keys are synced
                            localStorage.setItem('user_status', 'pro');
                            localStorage.setItem('user_membership_status', 'pro');

                            // C) Update Header Badge immediately - PRO ise onclick null
                            const badge = document.getElementById('user-plan-badge');
                            if (badge) {
                                badge.innerHTML = '<span class="relative z-10 flex items-center gap-1"><span class="animate-pulse">👑</span>PRO</span><div class="absolute inset-0 shimmer opacity-50"></div>';
                                badge.style.cssText = 'background: linear-gradient(135deg, #f59e0b, #ea580c); color: white; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255,255,255,0.3); cursor: default;';
                                badge.onclick = null; // Pro ise premium modal açmasın
                            }

                            // D) Hide upgrade button and lock icons
                            const upgradeBtn = document.getElementById('btn-header-upgrade');
                            if (upgradeBtn) upgradeBtn.classList.add('hidden');

                            const excelLock = document.getElementById('lock-icon-excel');
                            if (excelLock) excelLock.classList.add('hidden');

                            const aiLock = document.getElementById('lock-icon-assistant');
                            if (aiLock) aiLock.classList.add('hidden');

                            // E) Remove premium lock icons from nav items
                            document.querySelectorAll('.premium-lock-icon').forEach(icon => icon.remove());
                            document.querySelectorAll('[data-premium-locked="true"]').forEach(el => {
                                el.removeAttribute('data-premium-locked');
                            });

                            console.log('[Premium] ✓ Pro membership restored and UI updated.');
                        } else {
                            console.log('[Premium] User is FREE - no restoration needed.');
                        }
                    } catch (e) {
                        console.error('[Premium] Error during immediate state restoration:', e);
                    }
                })();

                // Delay slightly to ensure DOM is fully parsed and other scripts ran
                setTimeout(() => window.PremiumManager.init(), 100);
            });

            // ================================================================================
            // FINGO BRAIN AI CHATBOT - Rule-Based Intelligent Assistant
            // ================================================================================

            /**
             * YARDIMCI FONSİYONLAR: Tasarruf ve Yatırım Algılama
             */
            function isSavingsCategory(cat) {
                if (!cat) return false;
                const c = cat.toLocaleLowerCase('tr-TR');
                const keywords = [
                    'birikim', 'tasarruf', 'kumbara', 'hedef', 'hedef kumbarası', 'yatırım', 'yatirim',
                    'dolar', 'usd', 'usdt', 'euro', 'eur', 'altın', 'gram', 'çeyrek', 'gümüş',
                    'fon', 'etf', 'hisse', 'borsa', 'kripto', 'bitcoin', 'btc', 'eth',
                    'mevduat', 'vadeli', 'bes', 'emeklilik', 'portföy', 'sterlın'
                ];
                return keywords.some(k => c.includes(k));
            }

            // PATCH: Yatırım anahtar kelime kontrolü (Dolar/Euro/Altın vs.)
            function isInvestmentKeyword(cat = "") {
                const c = String(cat || "");
                return /Dolar|Euro|Altın|Çeyrek|Gram|USD|EUR|💵|💶|🟡|🪙/i.test(c);
            }

            // PATCH: TEK KAYNAK - Birikim/yatırım işlemi mi?
            // Bu fonksiyon uygulamanın her yerinde kullanılmalı
            function isSavingsTransaction(t) {
                if (!t) return false;

                const type = String(t.type || "").toLowerCase();
                const cat = t.category || "";
                const desc = t.description || "";
                const combined = cat + " " + desc;

                // 1) Kategori/isim birikim (kumbara, tasarruf, hedef vs.) ise
                const byCategory = isSavingsCategory(combined);

                // 2) Kullanıcı "Bakiyeden düşme" seçtiyse (yani: bu işlem gider değil, birikim/yatırım)
                const byToggle = t.excludeFromBalance === true;

                // 3) Döviz/altın/gram/çeyrek gibi FX varlıkları mı?
                const isFx = isInvestmentKeyword(cat);

                /**
                 * KRİTİK DÜZELTME:
                 * - Kullanıcı "Yeni İşlem > Gider" kısmında Euro/Dolar/Altın/Çeyrek girerse:
                 *   - "Bakiyeden düşme" AÇIK  => bu işlem BİRİKİM/YATIRIM (expense değil)
                 *   - "Bakiyeden düşme" KAPALI => bu işlem GERÇEK GİDER
                 *
                 * - Geriye dönük uyumluluk:
                 *   Eski kayıtlarda excludeFromBalance alanı yoksa (undefined/null),
                 *   önceki davranış bozulmasın diye FX işlemini BİRİKİM sayıyoruz.
                 */
                if (type === "expense" && isFx) {
                    if (t.excludeFromBalance === true) return true;
                    if (t.excludeFromBalance === false) return false;
                    return true; // legacy
                }

                return byCategory || byToggle;
            }

            // ═══════════════════════════════════════════════════════════════════════════════════
            // FINGO BRAIN SMART LAYER - Kategori Algılama ve Akıllı Öneri Sistemi
            // ═══════════════════════════════════════════════════════════════════════════════════

            /**
             * normalizeText - Türkçe karakter normalizasyonu + lowercase + trim
             */
            function normalizeText(str) {
                if (!str) return '';
                return String(str)
                    .toLocaleLowerCase('tr-TR')
                    .replace(/ı/g, 'i')
                    .replace(/ğ/g, 'g')
                    .replace(/ü/g, 'u')
                    .replace(/ş/g, 's')
                    .replace(/ö/g, 'o')
                    .replace(/ç/g, 'c')
                    .trim();
            }

            /**
             * EXPENSE_CATEGORIES - Kategori anahtar kelimeleri sözlüğü
             */
            const EXPENSE_CATEGORIES = {
                BORC_TAKSIT: ['kredi', 'taksit', 'faiz', 'borc', 'borç', 'kredi kart', 'ekstre', 'minimum', 'limit', 'yapilandirma', 'yapılandırma', 'odeme', 'ödeme plani'],
                MARKET: ['market', 'migros', 'a101', 'bim', 'sok', 'şok', 'carrefour', 'gida', 'gıda', 'alisveris', 'alışveriş', 'macro', 'metro'],
                YEMEK: ['yemek', 'restoran', 'cafe', 'kafe', 'kahve', 'burger', 'pizza', 'yemeksepeti', 'getir', 'trendyol yemek', 'lokanta', 'fast food'],
                ULASIM: ['akaryakit', 'akaryakıt', 'benzin', 'motorin', 'otobus', 'otobüs', 'metro', 'uber', 'taksi', 'hgs', 'ogs', 'otopark', 'yakit', 'yakıt'],
                FATURA: ['elektrik', 'su', 'dogalgaz', 'doğalgaz', 'internet', 'telefon', 'fatura', 'gsm', 'vodafone', 'turkcell', 'turk telekom'],
                KIRA: ['kira', 'aidat', 'site', 'apartman', 'konut', 'ev kirasi'],
                ABONELIK: ['netflix', 'spotify', 'youtube', 'apple', 'google', 'abonelik', 'membership', 'premium', 'exxen', 'bein', 'disney', 'hbo', 'amazon prime'],
                SAGLIK: ['eczane', 'hastane', 'muayene', 'ilac', 'ilaç', 'dis', 'diş', 'doktor', 'klinik', 'saglik', 'sağlık'],
                EGITIM: ['kurs', 'egitim', 'eğitim', 'okul', 'kitap', 'udemy', 'coursera', 'dershane', 'ozel ders'],
                EGLENCE: ['sinema', 'konser', 'oyun', 'steam', 'psn', 'xbox', 'eglence', 'eğlence', 'bilet', 'tiyatro'],
                ALISVERIS: ['trendyol', 'amazon', 'hepsiburada', 'giyim', 'ayakkabi', 'ayakkabı', 'n11', 'gittigidiyor', 'lcw', 'zara', 'h&m'],
                SEYAHAT: ['otel', 'ucak', 'uçak', 'airbnb', 'bilet', 'seyahat', 'tatil', 'booking', 'thy', 'pegasus']
            };

            /**
             * inferExpenseCategory - Gider kategorisini kurallarla tespit et
             * @param {Object} tx - İşlem objesi {type, category, description, amount, paymentMethod}
             * @returns {Object} { categoryKey, confidence, signals[] }
             */
            function inferExpenseCategory(tx) {
                try {
                    if (!tx) return { categoryKey: 'DIGER', confidence: 0, signals: [] };

                    const type = normalizeText(tx.type);
                    if (type === 'income' || type === 'gelir') {
                        return { categoryKey: 'INCOME', confidence: 1, signals: ['type=income'] };
                    }

                    const cat = normalizeText(tx.category || '');
                    const desc = normalizeText(tx.description || '');
                    const paymentMethod = normalizeText(tx.paymentMethod || '');
                    const combined = cat + ' ' + desc + ' ' + paymentMethod;

                    let bestMatch = { categoryKey: 'DIGER', confidence: 0, signals: [] };

                    for (const [catKey, keywords] of Object.entries(EXPENSE_CATEGORIES)) {
                        let matchCount = 0;
                        const matchedKeywords = [];

                        for (const kw of keywords) {
                            if (combined.includes(kw)) {
                                matchCount++;
                                matchedKeywords.push(kw);
                            }
                        }

                        if (matchCount > 0) {
                            const confidence = Math.min(1, matchCount * 0.3 + 0.4);
                            if (confidence > bestMatch.confidence) {
                                bestMatch = { categoryKey: catKey, confidence, signals: matchedKeywords };
                            }
                        }
                    }

                    // Özel kural: paymentMethod "kredi kartı" + notta "taksit" => BORC_TAKSIT ağırlığı artır
                    if ((paymentMethod.includes('kredi') || combined.includes('taksit')) && bestMatch.categoryKey !== 'BORC_TAKSIT') {
                        if (combined.includes('taksit') || combined.includes('kredi')) {
                            bestMatch = { categoryKey: 'BORC_TAKSIT', confidence: 0.8, signals: ['kredi/taksit override'] };
                        }
                    }

                    return bestMatch;
                } catch (e) {
                    console.warn('inferExpenseCategory error:', e);
                    return { categoryKey: 'DIGER', confidence: 0, signals: [] };
                }
            }

            /**
             * buildFingoContext - Son işlemlerden bağlam özeti çıkar
             * @param {Array} transactions - İşlem dizisi
             * @returns {Object} Context objesi
             */
            function buildFingoContext(transactions) {
                try {
                    const ctx = {
                        totalsByCategory: {},
                        topCategories: [],
                        debtInstallmentTotal: 0,
                        incomeTotal: 0,
                        savingsTotal: 0,
                        expenseTotal: 0,
                        recentTx: [],
                        hasData: false
                    };

                    if (!transactions || !Array.isArray(transactions) || transactions.length === 0) {
                        return ctx;
                    }

                    ctx.hasData = true;
                    ctx.recentTx = transactions.slice(0, 10);

                    transactions.forEach(t => {
                        const amount = parseFloat(t.amount) || 0;
                        const inferred = inferExpenseCategory(t);

                        if (t.type === 'income') {
                            ctx.incomeTotal += amount;
                        } else if (t.type === 'expense') {
                            if (typeof isSavingsTransaction === 'function' && isSavingsTransaction(t)) {
                                ctx.savingsTotal += amount;
                            } else {
                                ctx.expenseTotal += amount;
                                const catKey = inferred.categoryKey;
                                ctx.totalsByCategory[catKey] = (ctx.totalsByCategory[catKey] || 0) + amount;

                                if (catKey === 'BORC_TAKSIT') {
                                    ctx.debtInstallmentTotal += amount;
                                }
                            }
                        }
                    });

                    // Top 3 kategori
                    ctx.topCategories = Object.entries(ctx.totalsByCategory)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3)
                        .map(([key, amount]) => ({ key, amount }));

                    return ctx;
                } catch (e) {
                    console.warn('buildFingoContext error:', e);
                    return { totalsByCategory: {}, topCategories: [], debtInstallmentTotal: 0, incomeTotal: 0, savingsTotal: 0, expenseTotal: 0, recentTx: [], hasData: false };
                }
            }

            /**
             * FORBIDDEN_PATTERNS - Yasaklı öneri kalıpları (anti-saçmalık)
             */
            const FORBIDDEN_PATTERNS = [
                /taksitten\s*tasarruf/i,
                /krediden\s*tasarruf\s*et/i,
                /taksiti\s*k[ıi]s/i,
                /faizi\s*yok\s*say/i,
                /borcu\s*azalt.*tasarruf/i,
                /kredi.*k[ıi]s[ıi]nt[ıi]/i
            ];

            /**
             * validateAdvice - Anti-saçmalık filtresi
             * @param {string} text - Öneri metni
             * @param {Object} ctx - Bağlam objesi
             * @returns {boolean} Geçerli mi?
             */
            function validateAdvice(text, ctx) {
                try {
                    if (!text) return false;

                    // Borç/taksit varsa yasaklı kalıpları kontrol et
                    if (ctx && ctx.debtInstallmentTotal > 0) {
                        for (const pattern of FORBIDDEN_PATTERNS) {
                            if (pattern.test(text)) {
                                console.warn('FingoBrain: Yasaklı kalıp tespit edildi:', pattern);
                                return false;
                            }
                        }
                    }

                    return true;
                } catch (e) {
                    return true; // Hata durumunda geçir
                }
            }

            /**
             * SMART_TEMPLATES - Kategori bazlı akıllı öneri şablonları
             */
            const SMART_TEMPLATES = {
                BORC_TAKSIT: {
                    intro: "Borç ve taksit yükünü görüyorum. Bu tür sabit ödemeleri 'kısmak' yerine maliyetini düşürmeye odaklanalım.",
                    suggestions: [
                        "💳 Bankanla faiz oranı veya vade yapılandırma görüşmesi yap. Refinans seçeneklerini araştır.",
                        "📉 Mümkünse küçük ek ödemelerle toplam maliyeti azalt (erken ödeme cezası var mı kontrol et).",
                        "✂️ Diğer kategorilerde (market, yemek, abonelik) hedef kısma belirle; taksit düzenini bozma.",
                        "⏰ Otomatik ödeme talimatı kur, gecikme faizinden kaçın."
                    ],
                    question: "Bu borç sabit faizli mi, değişken mi? Erken kapama cezası var mı biliyor musun?"
                },
                MARKET: {
                    intro: "Market harcamaların dikkat çekici seviyede.",
                    suggestions: [
                        "📝 Alışverişe çıkmadan liste yap, listeye sadık kal.",
                        "💰 Haftalık sepet limiti belirle (örn: 1500₺) ve takip et.",
                        "🏷️ İndirimli ürünleri takip et ama ihtiyacın olmayanı alma.",
                        "🍳 Hazır gıda yerine temel malzeme al, evde hazırla."
                    ],
                    question: "Haftalık market bütçeni belirledin mi?"
                },
                YEMEK: {
                    intro: "Yemek kategorisinde harcamalar yüksek görünüyor.",
                    suggestions: [
                        "🏠 Haftada en az 3-4 gün evde yemek hazırlamayı dene.",
                        "📊 Dışarıda yeme sayısını haftalık 2-3 ile sınırla.",
                        "🥗 Öğle yemeği için evden hazırlık götür.",
                        "☕ Günlük kahve alışkanlığını evde hazırlamaya çevir."
                    ],
                    question: "Haftada kaç gün dışarıda yemek yiyorsun?"
                },
                ABONELIK: {
                    intro: "Abonelik giderlerini gözden geçirelim.",
                    suggestions: [
                        "🔍 Aktif kullanmadığın abonelikleri tespit et ve iptal et.",
                        "📅 Yıllık ödeme seçenekleriyle %15-20 tasarruf edebilirsin.",
                        "👨‍👩‍👧 Aile/grup planlarına geçerek maliyeti böl.",
                        "🆓 Ücretsiz alternatifleri araştır (örn: Spotify Free, YouTube Free)."
                    ],
                    question: "Son 1 ayda hangi abonelikleri gerçekten kullandın?"
                },
                ULASIM: {
                    intro: "Ulaşım giderlerin bütçende önemli bir yer tutuyor.",
                    suggestions: [
                        "🚌 Toplu taşıma alternatiflerini değerlendir.",
                        "⛽ Akaryakıt için indirimli istasyonları tercih et.",
                        "🚗 Kısa mesafeler için yürüyüş veya bisiklet düşün.",
                        "📱 Araç paylaşım uygulamalarını karşılaştır."
                    ],
                    question: "İşe gidiş-geliş için alternatif ulaşım düşündün mü?"
                },
                FATURA: {
                    intro: "Fatura giderlerin sabit ama optimize edilebilir.",
                    suggestions: [
                        "💡 Enerji tasarruflu cihazlara geç.",
                        "📱 Telefon/internet paketini ihtiyacına göre ayarla.",
                        "🌡️ Isıtma/soğutma ayarlarını optimize et.",
                        "💧 Su tasarrufu alışkanlıkları edin."
                    ],
                    question: "Fatura paketlerini son ne zaman karşılaştırdın?"
                },
                DIGER: {
                    intro: "Harcamalarını analiz ettim.",
                    suggestions: [
                        "📊 Aylık bütçe planı oluştur ve takip et.",
                        "💰 Gelirinin %20'sini tasarrufa ayırmayı hedefle.",
                        "🎯 Kısa ve uzun vadeli finansal hedefler belirle.",
                        "📝 Tüm harcamalarını düzenli kaydet."
                    ],
                    question: "Öncelikli olarak hangi kategoride tasarruf yapmak istersin?"
                }
            };

            /**
             * buildAdviceFromTemplates - Kategori bazlı akıllı öneri üret
             * @param {Object} ctx - Bağlam objesi
             * @param {Object} inferred - inferExpenseCategory sonucu
             * @returns {string} Öneri metni
             */
            function buildAdviceFromTemplates(ctx, inferred) {
                try {
                    if (!ctx || !ctx.hasData) {
                        return "💡 Tavsiye verebilmem için önce biraz veri lazım!\n\nHarcamalarını kaydetmeye başla, ben de sana özel öneriler sunayım. 📝";
                    }

                    // En yüksek harcama kategorisini bul
                    let targetCatKey = 'DIGER';
                    if (ctx.topCategories && ctx.topCategories.length > 0) {
                        targetCatKey = ctx.topCategories[0].key;
                    }
                    if (inferred && inferred.categoryKey && inferred.confidence > 0.5) {
                        targetCatKey = inferred.categoryKey;
                    }

                    // Borç/taksit varsa öncelik ver
                    if (ctx.debtInstallmentTotal > 0 && ctx.debtInstallmentTotal > ctx.expenseTotal * 0.2) {
                        targetCatKey = 'BORC_TAKSIT';
                    }

                    const template = SMART_TEMPLATES[targetCatKey] || SMART_TEMPLATES.DIGER;
                    const topCatAmount = ctx.topCategories[0] ? ctx.topCategories[0].amount : 0;

                    let response = `💡 **Akıllı Analiz Sonucu:**\n\n`;
                    response += `${template.intro}\n\n`;

                    // Tutar bilgisi ekle
                    if (targetCatKey === 'BORC_TAKSIT' && ctx.debtInstallmentTotal > 0) {
                        response += `📊 **Toplam Borç/Taksit:** ${ctx.debtInstallmentTotal.toLocaleString('tr-TR')} ₺\n\n`;
                    } else if (topCatAmount > 0) {
                        response += `📊 **Bu Kategoride Toplam:** ${topCatAmount.toLocaleString('tr-TR')} ₺\n\n`;
                    }

                    response += `**Önerilerim:**\n`;
                    const shuffledSuggestions = template.suggestions.sort(() => Math.random() - 0.5).slice(0, 3);
                    shuffledSuggestions.forEach((s, i) => {
                        response += `${i + 1}. ${s}\n`;
                    });

                    response += `\n❓ ${template.question}`;
                    response += `\n\n⚠️ _Bu genel önerilerdir, kişisel finansal danışmanlık yerine geçmez._`;

                    return response;
                } catch (e) {
                    console.warn('buildAdviceFromTemplates error:', e);
                    return "💡 Şu an analiz yapamıyorum. Lütfen biraz sonra tekrar dene.";
                }
            }

            // ═══════════════════════════════════════════════════════════════════════
            // FINGO BRAIN MEMORY SYSTEM - Kalıcı Hafıza ve Kullanıcı Profili
            // ═══════════════════════════════════════════════════════════════════════

            class FingoBrainMemory {
                constructor() {
                    this.storageKey = 'fingo_brain_memory_v2';
                    this.maxHistory = 100; // Son 100 konuşmayı sakla
                    this.data = this.load();
                }

                /**
                 * localStorage'dan veri yükle
                 */
                load() {
                    try {
                        const stored = localStorage.getItem(this.storageKey);
                        if (stored) {
                            return JSON.parse(stored);
                        }
                    } catch (e) {
                        console.warn('FingoBrainMemory load error:', e);
                    }

                    // Varsayılan yapı
                    return {
                        conversations: [],
                        profile: {
                            name: null,
                            nickname: null,
                            spendingPersonality: null,
                            financialGoals: [],
                            riskTolerance: 'medium',
                            preferredTopics: [],
                            lastInteraction: null,
                            totalInteractions: 0,
                            firstSeen: new Date().toISOString(),
                            insights: {
                                avgMonthlyIncome: 0,
                                avgMonthlyExpense: 0,
                                savingsRate: 0,
                                topCategories: [],
                                lastUpdated: null
                            }
                        },
                        intentStats: {},
                        moodHistory: [],
                        achievements: []
                    };
                }

                /**
                 * Hafızayı yeniden yükle (Hot Reload)
                 */
                reload() {
                    this.data = this.load();
                    console.log('[FingoBrainMemory] Memory reloaded from storage.');
                }

                /**
                 * localStorage'a kaydet
                 */
                save() {
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    } catch (e) {
                        console.warn('FingoBrainMemory save error:', e);
                    }
                }

                /**
                 * Konuşma kaydet
                 */
                saveConversation(userMessage, botResponse, intent, metadata = {}) {
                    const entry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        userMessage: userMessage.substring(0, 500), // Max 500 karakter
                        botResponse: botResponse.substring(0, 2000), // Max 2000 karakter
                        intent: intent,
                        ...metadata
                    };

                    this.data.conversations.unshift(entry);

                    // Limit aşarsa eski kayıtları sil
                    if (this.data.conversations.length > this.maxHistory) {
                        this.data.conversations = this.data.conversations.slice(0, this.maxHistory);
                    }

                    // Intent istatistiğini güncelle
                    this.trackIntent(intent);

                    // Son etkileşim zamanını güncelle
                    this.data.profile.lastInteraction = new Date().toISOString();
                    this.data.profile.totalInteractions++;

                    this.save();
                }

                /**
                 * Son konuşmaları getir
                 */
                getRecentConversations(count = 10) {
                    return this.data.conversations.slice(0, count);
                }

                /**
                 * Belirli intent'e sahip konuşmaları bul
                 */
                getConversationsByIntent(intentType, count = 5) {
                    return this.data.conversations
                        .filter(c => c.intent === intentType)
                        .slice(0, count);
                }

                /**
                 * Intent istatistiğini izle
                 */
                trackIntent(intentType) {
                    if (!this.data.intentStats[intentType]) {
                        this.data.intentStats[intentType] = 0;
                    }
                    this.data.intentStats[intentType]++;
                }

                /**
                 * En çok sorulan intent'leri getir
                 */
                getTopIntents(count = 5) {
                    return Object.entries(this.data.intentStats)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, count)
                        .map(([intent, count]) => ({ intent, count }));
                }

                /**
                 * Kullanıcı profilini güncelle
                 */
                updateProfile(updates) {
                    this.data.profile = { ...this.data.profile, ...updates };
                    this.save();
                }

                /**
                 * Kullanıcı profilini getir
                 */
                getProfile() {
                    return this.data.profile;
                }

                /**
                 * Finansal içgörüleri güncelle
                 */
                updateInsights(insights) {
                    this.data.profile.insights = {
                        ...this.data.profile.insights,
                        ...insights,
                        lastUpdated: new Date().toISOString()
                    };
                    this.save();
                }

                /**
                 * Ruh hali kaydet
                 */
                saveMood(mood, context = '') {
                    this.data.moodHistory.unshift({
                        mood,
                        context,
                        timestamp: new Date().toISOString()
                    });

                    // Son 30 mood kaydı tut
                    if (this.data.moodHistory.length > 30) {
                        this.data.moodHistory = this.data.moodHistory.slice(0, 30);
                    }

                    this.save();
                }

                /**
                 * Başarı ekle
                 */
                addAchievement(achievement) {
                    if (!this.data.achievements.find(a => a.id === achievement.id)) {
                        this.data.achievements.push({
                            ...achievement,
                            unlockedAt: new Date().toISOString()
                        });
                        this.save();
                        return true;
                    }
                    return false;
                }

                /**
                 * Son etkileşimden bu yana geçen gün
                 */
                getDaysSinceLastInteraction() {
                    if (!this.data.profile.lastInteraction) return null;
                    const last = new Date(this.data.profile.lastInteraction);
                    const now = new Date();
                    return Math.floor((now - last) / (1000 * 60 * 60 * 24));
                }

                /**
                 * Kullanıcının sık sorduğu konuları analiz et
                 */
                getPreferredTopics() {
                    const topIntents = this.getTopIntents(3);
                    const topicMap = {
                        status: 'Durum Özeti',
                        advice: 'Tavsiye',
                        category: 'Kategori Analizi',
                        subscription: 'Abonelikler',
                        savings: 'Tasarruf/Yatırım',
                        forecast: 'Tahmin',
                        budget: 'Bütçe',
                        topCategory: 'Harcama Analizi',
                        compare: 'Karşılaştırma',
                        score: 'Fingo Score'
                    };

                    return topIntents.map(t => ({
                        topic: topicMap[t.intent] || t.intent,
                        count: t.count
                    }));
                }

                /**
                 * Hafızayı temizle
                 */
                clearMemory() {
                    localStorage.removeItem(this.storageKey);
                    this.data = this.load();
                }

                /**
                 * Belirli bir anahtar kelimeyi içeren konuşmaları ara
                 */
                searchConversations(keyword, count = 10) {
                    const lowerKeyword = keyword.toLocaleLowerCase('tr-TR');
                    return this.data.conversations
                        .filter(c =>
                            c.userMessage.toLocaleLowerCase('tr-TR').includes(lowerKeyword) ||
                            c.botResponse.toLocaleLowerCase('tr-TR').includes(lowerKeyword)
                        )
                        .slice(0, count);
                }
            }

            // ═══════════════════════════════════════════════════════════════════════
            // FINGO BRAIN VOCABULARY - Genişletilmiş Kelime Dağarcığı
            // ═══════════════════════════════════════════════════════════════════════

            const FINGO_VOCABULARY = {
                // Genişletilmiş selamlamalar (50+)
                greetings: [
                    "", "Dostum", "Arkadaşım", "Finans Ustası", "Değerli Kullanıcı",
                    "Patron", "Canım", "Sevgili Kullanıcı", "Kıymetli", "Finans Kahramanı",
                    "Tasarruf Şampiyonu", "Para Ustası", "Akıllı Yatırımcı", "Bütçe Savaşçısı",
                    "Finans Meraklısı", "Ekonomi Aşığı", "Birikim Uzmanı", "Değerli Dostum",
                    "Para Avcısı", "Birikim Ustası", "Harcama Takipçisi", "Gelir Gardiyenı",
                    "Finans Ninja", "Ekonomi Ustası", "Tasarruf Canavarı", "Para Filosozu",
                    "Bütçe Uzmanı", "Yatırım Gurusu", "Finans Savaşçısı", "Ekonomi Dehaısı",
                    "Cüzdan Koruyucusu", "Hesap Ustası", "Denge Sanatçısı", "Finans Atleti",
                    "Birikim Kahramanı", "Para Muhafızı", "Ekonomi Samurayı", "Tasarruf Eri"
                ],

                // Genişletilmiş açılış cümleleri (30+)
                openers: [
                    "Hemen bakıyorum...", "Bir saniye, verileri kontrol ediyorum.",
                    "İşte bulduklarım:", "Kayıtlara göz attım.", "Analizimi tamamladım.",
                    "Verilerine baktım.", "İşte senin için hazırladığım özet:",
                    "Rakamlar şunu söylüyor:", "Finansal durumun hakkında:",
                    "Tabloya baktım.", "İşlemlerini inceledim.", "Hızlıca özetliyorum:",
                    "Analiz tamamlandı, işte sonuçlar:", "Rakamları çektim, hazırız!",
                    "Verilere daldım, şimdi çıkıyorum:", "Hesaplar yapıldı:",
                    "Küçük bir araştırma yaptım:", "Senin için derinlere indim:",
                    "Baktım baktım, işte gördüklerim:", "Veriler konuşuyor:",
                    "Finansal röntgenin hazır:", "Sayılar dans ediyor, izle:",
                    "Cüzdanına baktım, şunu gördüm:", "Ekonomik analizin geldi:",
                    "Rakamlar fısıldıyor, dinle:", "Finansal check-up tamam:",
                    "Veritabanına dalış tamamlandı:", "Bütçe taraması bitti:",
                    "Harcama haritanı çıkardım:", "Gelir-gider denklemi hazır:"
                ],

                // Genişletilmiş geçiş cümleleri (25+)
                transitions: [
                    "Ayrıca,", "Bir de şunu ekleyeyim:", "Dikkat çeken bir nokta:",
                    "İlginç bir detay:", "Önemli bir not:", "Bununla birlikte,",
                    "Ek olarak,", "Bir diğer husus:", "Göze çarpan:",
                    "Şunu da belirtmeliyim:", "Öte yandan,", "Bunun yanında,",
                    "Dikkatini çekmek isterim:", "Kritik bir nokta:",
                    "Gözden kaçırmaman gereken:", "Ve şu da var:",
                    "Bonus bilgi:", "Pro tip:", "Altını çizmeliyim:",
                    "Merak edersen:", "Bu da ilginç:", "Dahası,",
                    "Üstelik,", "Buna ek olarak,", "Bir şey daha:"
                ],

                // Genişletilmiş kapanış cümleleri (30+)
                closers: [
                    "Başka bir sorun varsa buradayım!", "Yardımcı olabildiysem ne mutlu.",
                    "Daha fazla detay istersen sor.", "Finansal yolculuğunda yanındayım.",
                    "Başarılar!", "Bir şey daha soracaksan beklerim.",
                    "Elimden geleni yapıyorum.", "Umarım faydalı olmuştur.",
                    "Her zaman buradayım.", "Başka ne merak ediyorsun?",
                    "Devam edelim mi?", "Sormak istediğin başka bir şey var mı?",
                    "Finansal özgürlük yolunda yanındayım!", "Her türlü sorunda buradayım.",
                    "Bol kazançlar dilerim!", "Cüzdanın hep dolu olsun!",
                    "Tasarruflar seninle olsun!", "Akıllı harcamalar!",
                    "Bütçen daim olsun!", "Paranla barışık kal!",
                    "Finansal sağlık dileklerimle.", "Biriktirmeye devam!",
                    "Yatırımların tutturulsun!", "Sormaktan çekinme, burdayım.",
                    "Ekonomik refahın için elimden geleni yaparım.",
                    "Cüzdan dostu kalıyorum!", "Hesaplarını takip etmeye devam et!",
                    "Para yönetiminde ustalaşmaya devam!", "Başarının anahtarı disiplin!"
                ],

                // Duygu bazlı yanıtlar
                emotionalResponses: {
                    stressed: [
                        "Stresliyken en iyi karar verilmez 😌 Bir nefes al, sonra konuşalım.",
                        "Anladım, finansal stres zor olabiliyor. Birlikte çözüm bulacağız! 💪",
                        "Endişelenme, her sorunun bir çözümü var. Hadi planlayalım.",
                        "Stres normal, ama panik yapma. Adım adım ilerleyelim."
                    ],
                    worried: [
                        "Endişelerin anlaşılır, ama veriler o kadar da kötü değil 🌟",
                        "Merak etme, durumu birlikte analiz edelim.",
                        "Kaygılarını anlıyorum. Hadi rakamlara bakalım, gerçeği görelim.",
                        "Endişe yerine aksiyon alalım, ne dersin?"
                    ],
                    happy: [
                        "Harika bir ruh halinde görünüyorsun! 🎉 Bu enerjiyle neler başarırsın!",
                        "Mutlu olduğunu görmek beni de mutlu etti! Finansların da güzel gidsin! 🌈",
                        "Bu pozitif enerjiyi koruyalım! Tasarruf hedeflerin için mükemmel zaman!",
                        "Güzel bir gün! Bu motivasyonla bütçende harikalar yaratabilirsin!"
                    ],
                    frustrated: [
                        "Sinirlenmen normal, finanslar bazen stresli olabiliyor 😤",
                        "Anlıyorum, bazen rakamlar sinir bozucu. Ama çözüm yolu var!",
                        "Hayal kırıklığını anlıyorum. Sorunun ne olduğunu bulalım.",
                        "Bazen işler ters gider, ama pes etme. Birlikte düzeltiriz."
                    ],
                    hopeful: [
                        "Umut çok güzel bir şey! Hedeflerine ulaşacaksın, eminim 🌟",
                        "Bu olumlu bakışı sevdim! Finansal gelecek senin elinde!",
                        "Umutlu olmak için haklısın! Planla, uygula, başar!",
                        "Bu motivasyonu koru! Başarı kaçınılmaz!"
                    ]
                },

                // Kişilik bazlı tonlar
                personalityTones: {
                    saver: {
                        praise: ["Tasarruf şampiyonu!", "Para biriktirmede ustasın!", "Cüzdan koruyucusu gerçekten!"],
                        encourage: ["Bu tutumu koru!", "Harika gidiyorsun!", "Biriktirmeye devam!"]
                    },
                    balanced: {
                        praise: ["Dengeli yaklaşımın takdire şayan!", "Hem yaşıyor hem biriktiriyorsun, bravo!"],
                        encourage: ["Bu dengeyi koru!", "İyi yoldasın!"]
                    },
                    spender: {
                        gentle: ["Biraz fren yapma vakti gelmiş olabilir 😊", "Harcamalar biraz yüksek, birlikte kontrol edelim?"],
                        motivate: ["Küçük değişiklikler büyük farklar yaratır!", "Adım adım tasarrufa geçebilirsin!"]
                    }
                },

                // Hedef bazlı motivasyonlar
                goalMotivations: {
                    house: ["Ev almak harika bir hedef! 🏡", "Yuvanı kurmak için biriktiriyorsun, muhteşem!"],
                    car: ["Arabana kavuşacaksın! 🚗", "Araç hedefin için güzel ilerliyorsun!"],
                    vacation: ["Tatil hak edilen bir mola! 🏖️", "Tatil fonun büyüyor!"],
                    education: ["Eğitim en iyi yatırım! 📚", "Kendine yatırım yapmak harika!"],
                    retirement: ["Emeklilik planı akıllıca! 👴", "Geleceğin için düşünüyorsun, harika!"],
                    emergency: ["Acil durum fonu çok önemli! 🆘", "Güvenlik ağın oluşuyor!"],
                    investment: ["Yatırım portföyü oluşturmak harika! 📈", "Paranın çalışmasını sağlıyorsun!"]
                },

                // Zaman bazlı selamlamalar
                timeGreetings: {
                    morning: ["Günaydın", "Harika bir sabah", "Güne güzel başla", "Sabahın aydınlığında"],
                    afternoon: ["İyi günler", "Bereketli öğlen", "Gün boyu başarılar"],
                    evening: ["İyi akşamlar", "Akşamın huzuru seninle olsun", "Keyifli akşamlar"],
                    night: ["İyi geceler", "Tatlı rüyalar", "Dinlenmeyi hak ettin"]
                },

                // Başarı rozetleri
                achievements: {
                    firstChat: { id: 'first_chat', title: '🎉 İlk Sohbet', desc: 'Fingo Brain ile ilk konuşmanı yaptın!' },
                    savingsHero: { id: 'savings_hero', title: '💎 Tasarruf Kahramanı', desc: 'Aylık %20+ tasarruf oranına ulaştın!' },
                    budgetMaster: { id: 'budget_master', title: '📊 Bütçe Ustası', desc: 'Bütçeni 3 ay üst üste tuttun!' },
                    investorRookie: { id: 'investor_rookie', title: '📈 Yatırımcı Adayı', desc: 'İlk yatırımını kaydettın!' },
                    categoryKing: { id: 'category_king', title: '👑 Kategori Kralı', desc: 'Tüm kategorilerde analiz yaptın!' },
                    loyalUser: { id: 'loyal_user', title: '🌟 Sadık Kullanıcı', desc: '30 gün boyunca Fingo Brain kullandın!' },
                    questionMaster: { id: 'question_master', title: '❓ Soru Ustası', desc: '50+ soru sordun!' },
                    nightOwl: { id: 'night_owl', title: '🦉 Gece Kuşu', desc: 'Gece yarısından sonra sohbet ettin!' }
                }
            };

            /**
             * FingoBrain Class - Tamamen tarayıcı içinde çalışan zeki asistan simülasyonu
             * API kullanmadan localStorage verilerini analiz eder - V2.0 ENHANCED
             */
            class FingoBrain {
                constructor() {
                    this.name = "Fingo Brain";
                    this.version = "2.0";

                    // Hafıza sistemi başlat
                    this.memory = new FingoBrainMemory();

                    // Genişletilmiş selamlamalar (VOCABULARY'den)
                    this.greetings = FINGO_VOCABULARY.greetings;

                    // Intent patterns - V2.0 Genişletilmiş niyet algılama (20+ pattern)
                    this.intents = {
                        // Mevcut intent'ler - genişletilmiş
                        status: /durum|özet|nasıl.*gidiyor|bakiye|genel|para.*ne.*kadar|durumum|mali|finansal.*durum|bu\s*ay|paramın\s*durumu|ne\s*kadar\s*kaldı|bütçem|harcarım|cüzdan/i,
                        category: /(.+?)(?:\s|'|')?(?:ne\s*kadar|kaç|harcadım|harcama|gider|verdim|ödedim|ne\s*verdim|için\s*harcama|kategorisinde)/i,
                        advice: /tavsiye|öneri|ne\s*yapmalıyım|yardım|ipucu|fikir|öner|akıl|ne\s*dersin|senin\s*düşüncen|stratejin|fikrin|görüşün|yorumun/i,
                        subscription: /abonelik|sabit.*gider|düzenli|aylık.*ödeme|tekrarlayan|fatura|netflix|spotify|youtube/i,
                        topCategory: /en\s*çok|en\s*fazla|nereye.*harcıyorum|hangi.*kategori|en\s*büyük\s*gider/i,
                        savings: /tasarruf|biriktir|birikim|yatırım|dolar|euro|altın|portföy|varlıklarım|değer\s*kazandı|kar.*zarar|fon|hisse/i,
                        greeting: /merhaba|selam|hey|naber|nasılsın|günaydın|iyi\s*akşamlar|iyi\s*günler|ne\s*haber/i,
                        help: /ne\s*sorabilirim|komut|örnek|yardım\s*et|nasıl\s*kullan|yapabilir\s*misin|özellik|yeteneklerin/i,
                        budget: /bütçe|limit|kota|sınır|50.*30.*20|kural/i,
                        forecast: /tahmin|ay\s*sonu|gidişat|projeksiyon|gelecek\s*ay|önümüzdeki/i,
                        compare: /geçen\s*ay|önceki\s*ay|karşılaştır|fark|değişim|artış|azalış/i,
                        score: /fingo\s*score|skor|puan|risk|volatilite|finansal\s*sağlık|değerlendirme/i,

                        // YENİ INTENT'LER - V2.0
                        mood: /moralim|ruh\s*halim|stresli|endişeli|mutlu|umutlu|sinirliyim|üzgün|kaygılı|bunaldım|moral\s*bozuk|keyifsiz|heyecanlı|motivasyonum/i,
                        goal: /hedefim|planım|istek|hayal|ev\s*almak|araba|tatil|emeklilik|düğün|eğitim|yatırım\s*yapmak|biriktirmek\s*istiyorum|amacım/i,
                        learn: /öğret|anlat|nedir|nasıl|açıkla|bilgi\s*ver|ne\s*demek|fark\s*nedir|karşılaştır|avantaj|dezavantaj|mantığı/i,
                        memoryRecall: /hatırlıyor\s*musun|geçen\s*sefer|daha\s*önce|söylemiştim|konuşmuştuk|bahsetmiştim|en\s*son/i,
                        profile: /beni\s*tanı|kim.*olduğumu|hakkımda\s*ne\s*biliyorsun|profilim|analiz\s*et\s*beni|karakterim|kişiliğim/i,
                        thanks: /teşekkür|sağol|eyvallah|mükemmel|harika|çok\s*iyi|süper/i,
                        bye: /görüşürüz|hoşça\s*kal|bay\s*bay|güle\s*güle|sonra\s*görüşürüz|iyi\s*geceler/i,
                        joke: /şaka|espri|güldür|eğlence|komik|fıkra/i,

                        // YENİ INTENT'LER - V3.0 PİYASA & YATIRIM
                        marketStatus: /piyasa|borsa|endeks|bist|güncel\s*kur|gündem|ekonomi\s*nasıl|piyasalar?\s*nasıl/i,
                        currencyQuery: /dolar|euro|döviz|kur|usd|eur|sterlin|gbp/i,
                        goldQuery: /altın|gram\s*altın|çeyrek|ons|gold/i,
                        investmentAdvice: /yatırım\s*tav|nereye\s*yatır|ne\s*alsam|ne\s*yapmalı|yatırım\s*öneri|portföy\s*öneri|hangi\s*yatırım|risk\s*profil|fırsat/i,

                        // AI LAB INTENTS
                        aiExpenseAnalysis: /harcama.*analiz|gider.*analiz|neye.*harcadım|detaylı.*analiz|harcama.*özeti/i,
                        aiPortfolioSimulator: /portföy.*simülasyon|enflasyon.*tahmin|yatırım.*simüle|gelecek.*param|portföy.*geleceği/i,
                        aiFinancialForecast: /3.*ay.*tahmin|finansal.*öngörü|gelecek.*durumum|gelecek.*tahmin|3.*ay.*sonra/i
                    };

                    // Ton ve varyasyon paketleri - VOCABULARY'den genişletilmiş
                    this.tone = {
                        openers: FINGO_VOCABULARY.openers,
                        transitions: FINGO_VOCABULARY.transitions,
                        closers: FINGO_VOCABULARY.closers,
                        followUps: {
                            status: [
                                "Hangi kategoriyi detaylı incelememi istersin?",
                                "En çok harcadığın kategoriyi görmek ister misin?",
                                "Tasarruf önerileri sunayım mı?",
                                "Aboneliklerini kontrol edeyim mi?",
                                "Geçen ayla karşılaştırayım mı?",
                                "Belirli bir kategoriye bakmamı ister misin?",
                                "Yatırımlarını da özetleyeyim mi?",
                                "Bütçe planı önerileri istersen söyle.",
                                "Fingo Score'unu görmek ister misin?",
                                "Gelecek ay tahmini yapayım mı?",
                                "Finansal sağlık raporun hazır, istersen detaya girelim.",
                                "Harcama alışkanlıklarını analiz edeyim mi?"
                            ],
                            advice: [
                                "Bu önerileri uygulamaya başlamak ister misin?",
                                "Hangi maddeden başlayalım?",
                                "Daha spesifik bir alan için öneri ister misin?",
                                "Aboneliklerini optimize etmeni önerir miyim?",
                                "En büyük gider kalemini inceleyelim mi?",
                                "Tasarruf hedefi belirlemeni ister misin?",
                                "50-30-20 kuralını detaylı anlatayım mı?",
                                "Acil önlem mi yoksa uzun vadeli plan mı?",
                                "Bir tasarruf challenge'ı başlatalım mı?",
                                "Hedef belirleyip takip edelim mi?",
                                "Finansal özgürlük yolculuğunda sana eşlik edeyim mi?"
                            ],
                            category: [
                                "Başka bir kategoriyi de inceleyeyim mi?",
                                "Bu kategoride nasıl tasarruf edebileceğini anlatayım mı?",
                                "Geçen ayla karşılaştırmamı ister misin?",
                                "En çok harcanan kategorileri sıralayayım mı?",
                                "Bu kategoriye limit koymayı düşünür müsün?",
                                "Alternatif önerilerim var, duymak ister misin?",
                                "Diğer kategorilerle kıyaslayayım mı?",
                                "Aylık trend görmek ister misin?",
                                "Bu kategorideki işlemleri detaylı listeleyelim mi?",
                                "Haftalık bazda analiz yapmamı ister misin?"
                            ],
                            subscription: [
                                "Hangi aboneliğin gereksiz olduğunu düşünüyorsun?",
                                "İptal etmeyi düşündüğün bir abonelik var mı?",
                                "Alternatif seçenekleri araştırmamı ister misin?",
                                "Aile planlarına geçerek tasarruf mümkün, ilgilenir misin?",
                                "En pahalı aboneliği değerlendirmemi ister misin?",
                                "Yıllık ödeme seçenekleri tasarruf sağlar, bakmamı ister misin?",
                                "Kullanım sıklığına göre öneri yapayım mı?",
                                "Ücretsiz alternatifler önereyim mi?",
                                "Abonelik takviminiz oluşturayım mı?",
                                "Toplam aylık abonelik maliyetini hesapladık, yıllık etkisini görmek ister misin?"
                            ],
                            savings: [
                                "Yatırım çeşitliliğini artırmayı düşünür müsün?",
                                "Hedef belirlememde yardımcı olayım mı?",
                                "Dolar mı altın mı daha mantıklı, konuşalım mı?",
                                "Otomatik birikim planı kurmak ister misin?",
                                "Portföy dağılımına bakmamı ister misin?",
                                "Risk profilini değerlendirelim mi?",
                                "Acil durum fonu hakkında konuşalım mı?",
                                "Uzun vadeli hedeflerini planlamama yardım edeyim mi?",
                                "Yatırım performansını analiz edeyim mi?",
                                "Enflasyona karşı koruma stratejilerini konuşalım mı?"
                            ],
                            topCategory: [
                                "Bu kategoride kesinti yapabilir misin?",
                                "Alternatif önerilerim var, ilgilenir misin?",
                                "Diğer kategorileri de görmek ister misin?",
                                "Aylık limit belirlemeni önerir misin?",
                                "Geçen ayla karşılaştırayım mı?",
                                "Bu kategorideki işlemleri detaylı görmek ister misin?",
                                "Tasarruf stratejisi önerebilir miyim?",
                                "Hangi alt kalemlere gidiyor, bakalım mı?",
                                "Bu harcamaları azaltmak için plan yapalım mı?"
                            ],
                            greeting: [
                                "Bugün ne konuda yardımcı olabilirim?",
                                "Finansal durumunu özetleyeyim mi?",
                                "Hangi konuda merak ettiğin var?",
                                "Öneriler mi istersin, analiz mi?",
                                "Bu ayın özeti ile başlayalım mı?",
                                "Harcamalarına mı bakayım, yatırımlara mı?",
                                "Bir soru sor, hemen cevaplayayım!",
                                "Nereden başlamamı istersin?",
                                "Finansal check-up zamanı mı?",
                                "Portföyüne mi bakalım, bütçeye mi?"
                            ],
                            mood: [
                                "Daha iyi hissetmen için ne yapabilirim?",
                                "Finansal durumunu konuşmak yardımcı olur mu?",
                                "Birlikte bir plan yapalım mı?",
                                "Pozitif haberlerle başlayalım mı?",
                                "Seni motive edecek veriler var, görmek ister misin?"
                            ],
                            goal: [
                                "Bu hedefe ulaşmak için plan yapalım mı?",
                                "Ne kadar sürede ulaşmak istiyorsun?",
                                "Aylık ne kadar ayırman gerektiğini hesaplayayım mı?",
                                "Benzer hedeflere ulaşanların stratejilerini paylaşayım mı?",
                                "İlerleme takibi kuralım mı?"
                            ],
                            learn: [
                                "Başka bir konu hakkında bilgi ister misin?",
                                "Pratik örneklerle açıklayayım mı?",
                                "Senin durumuna uyarlanmış öneriler vereyim mi?",
                                "İlgili konuları da anlatayım mı?"
                            ],
                            unknown: [
                                "Gelir mi, gider mi, yoksa kategori mi bakayım?",
                                "Finansal durum özeti ister misin?",
                                "Hangi konuda yardımcı olabilirim?",
                                "Örneğin 'market ne kadar harcadım' diye sorabilirsin.",
                                "Harcama analizi mi, tavsiye mi istersin?",
                                "Belirli bir kategori sormak ister misin?",
                                "Durum özeti çıkarayım mı?",
                                "Aboneliklerini kontrol edeyim mi?",
                                "'Bana tavsiye ver' veya 'Durumum nasıl?' diye sorabilirsin.",
                                "Yatırımlarını veya tasarruflarını inceleyeyim mi?"
                            ]
                        }
                    };

                    // Kelime zenginliği - Genişletilmiş
                    this.lexicon = {
                        expense: ["harcama", "gider", "masraf", "ödeme", "harcanan", "para çıkışı", "maliyet"],
                        income: ["gelir", "kazanç", "girdi", "gelen para", "elde edilen", "maaş", "para girişi"],
                        save: ["tasarruf", "birikim", "kenara koyulan", "biriken", "yatırım", "altın", "dolar"],
                        warning: ["dikkat", "uyarı", "alarm", "risk", "tehlike", "kritik", "acil"],
                        good: ["harika", "mükemmel", "süper", "başarılı", "güzel", "iyi", "muhteşem", "tebrikler"],
                        neutral: ["normal", "orta", "idare eder", "fena değil", "stabil"],
                        action: ["azalt", "artır", "kontrol et", "takip et", "planla", "hedefle", "optimize et"]
                    };

                    // Gelişmiş bilinmeyen soru cevapları - V2.0
                    this.unknownResponses = [
                        "Bu soruyu tam anlayamadım. Ben finansal konularda uzmanım: harcamalar, gelirler, tasarruf ve bütçe gibi.\n\n💡 **Örnek sorular:**\n• \"Bu ay ne kadar harcadım?\"\n• \"Market harcamalarım ne kadar?\"\n• \"Bana tavsiye ver\"\n• \"Aboneliklerimi göster\"",
                        "Hmm, bu konuda yardımcı olamıyorum ama finansal analiz yapabilirim!\n\n🎯 Şunları sorabilirsin:\n• Genel durum özeti\n• Kategori bazlı harcama\n• Tasarruf önerileri",
                        "Bu soru uzmanlık alanımın dışında. Ama finansal durumun hakkında her şeyi söyleyebilirim!\n\n📊 \"Durumum nasıl?\" veya \"En çok neye harcıyorum?\" diye sor.",
                        "Bunu anlamadım ama sorun değil! Finans konusunda yanındayım.\n\n💰 Gelir, gider, tasarruf veya kategori analizi yapabilirim. Ne istersin?",
                        "Bu konuda bilgim yok ama bütçe takibi konusunda uzmanım!\n\n✨ \"Tavsiye ver\" veya \"Yatırımlarım nasıl?\" diye sorabilirsin.",
                        "Anlamadım ama dert etme! 🤔 Finansal konularda uzmanım.\n\n📈 Şunları deneyebilirsin:\n• \"Fingo Score'um kaç?\"\n• \"Ay sonu tahminim ne?\"\n• \"Geçen ayla karşılaştır\"",
                        "Bu benim alanım değil gibi görünüyor. Ama bütçe ve finans konusunda yardımcı olabilirim!\n\n🎯 \"Hedefim var\" veya \"Tasarruf önerisi\" diye sorabilirsin."
                    ];

                    // Finansal eğitim içerikleri - V2.0
                    this.financialEducation = {
                        '50-30-20': {
                            title: "50-30-20 Kuralı",
                            content: "Gelirinin %50'sini ihtiyaçlara (kira, fatura, market), %30'unu isteklere (eğlence, yemek dışarı), %20'sini tasarrufa ayır. Bu basit kural finansal dengeyi sağlar.",
                            emoji: "📊"
                        },
                        'acil-fon': {
                            title: "Acil Durum Fonu",
                            content: "3-6 aylık giderlerini karşılayacak bir fon oluştur. Bu fon beklenmedik durumlar için güvenlik ağın olur.",
                            emoji: "🆘"
                        },
                        'bilesik-faiz': {
                            title: "Bileşik Faiz",
                            content: "Albert Einstein'ın '8. harika' dediği bileşik faiz, paranın üzerine kazanılan faizin de faiz kazanmasıdır. Erken başlamak çok önemli!",
                            emoji: "📈"
                        },
                        'enflasyon': {
                            title: "Enflasyon ve Para",
                            content: "Enflasyon paranın satın alma gücünü azaltır. Bu yüzden paranı sadece bankada tutmak yerine enflasyonu yenecek yatırımlar düşünmelisin.",
                            emoji: "💸"
                        },
                        'cesitlendirme': {
                            title: "Yatırım Çeşitlendirme",
                            content: "Tüm yumurtaları aynı sepete koyma! Farklı yatırım araçlarına (altın, döviz, hisse, fon) dağıtarak riskleri azalt.",
                            emoji: "🥚"
                        }
                    };

                    // İlk sohbet rozetini kontrol et
                    this.checkFirstChatAchievement();
                }

                // ═══════════════════════════════════════════════════════════════
                // V2.0 YENİ METODLAR - Hafıza ve Kişiselleştirme
                // ═══════════════════════════════════════════════════════════════

                /**
                 * İlk sohbet rozetini kontrol et
                 */
                checkFirstChatAchievement() {
                    if (this.memory.data.profile.totalInteractions === 0) {
                        const achievement = FINGO_VOCABULARY.achievements.firstChat;
                        this.memory.addAchievement(achievement);
                    }
                }

                /**
                 * Zaman bazlı selamlama
                 */
                getTimeGreeting() {
                    const hour = new Date().getHours();
                    let period = 'afternoon';

                    if (hour >= 5 && hour < 12) period = 'morning';
                    else if (hour >= 12 && hour < 18) period = 'afternoon';
                    else if (hour >= 18 && hour < 22) period = 'evening';
                    else period = 'night';

                    return this.pick(FINGO_VOCABULARY.timeGreetings[period]);
                }

                /**
                 * Ruh hali algılama
                 */
                detectMood(text) {
                    const lowerText = text.toLocaleLowerCase('tr-TR');

                    if (/stres|bunaldım|sıkıntı|zor|kaygı|endişe/.test(lowerText)) return 'stressed';
                    if (/mutsuz|üzgün|kötü|moral.*bozuk|keyifsiz/.test(lowerText)) return 'worried';
                    if (/mutlu|harika|süper|iyi|güzel|heyecan/.test(lowerText)) return 'happy';
                    if (/sinir|kızgın|öfke|bıktım|hayal.*kırıklığı/.test(lowerText)) return 'frustrated';
                    if (/umut|ümit|olumlu|pozitif|iyimser/.test(lowerText)) return 'hopeful';

                    return null;
                }

                /**
                 * Harcama kişiliğini tespit et
                 */
                detectSpendingPersonality() {
                    const transactions = this.getCurrentMonthTransactions();
                    const profile = this.memory.getProfile();

                    if (transactions.length < 5) {
                        return { type: 'unknown', emoji: '🔍', label: 'Veri Yetersiz' };
                    }

                    let totalIncome = 0, totalExpense = 0;
                    transactions.forEach(t => {
                        const amount = parseFloat(t.amount) || 0;
                        if (t.type === 'income') totalIncome += amount;
                        else if (t.type === 'expense' && !isSavingsTransaction(t)) totalExpense += amount;
                    });

                    const ratio = totalIncome > 0 ? totalExpense / totalIncome : 1;

                    let personality;
                    if (ratio < 0.4) {
                        personality = { type: 'saver', emoji: '💎', label: 'Tasarrufçu', ratio };
                    } else if (ratio < 0.7) {
                        personality = { type: 'balanced', emoji: '⚖️', label: 'Dengeli', ratio };
                    } else {
                        personality = { type: 'spender', emoji: '💸', label: 'Harcamacı', ratio };
                    }

                    // Profili güncelle
                    this.memory.updateProfile({ spendingPersonality: personality.type });

                    return personality;
                }

                /**
                 * Ruh hali intent handler
                 */
                handleMoodIntent(userText) {
                    const mood = this.detectMood(userText);
                    const greeting = this.getGreeting();

                    // Mood'u kaydet
                    if (mood) {
                        this.memory.saveMood(mood, userText);
                    }

                    const emotionalResponses = FINGO_VOCABULARY.emotionalResponses[mood] || FINGO_VOCABULARY.emotionalResponses.worried;
                    const response = this.pick(emotionalResponses);

                    // Finansal duruma bağla
                    const transactions = this.getCurrentMonthTransactions();
                    let financialNote = '';

                    if (transactions.length > 0) {
                        const personality = this.detectSpendingPersonality();
                        if (personality.type === 'saver') {
                            financialNote = `\n\n💎 Bu arada, finansal durumun gayet iyi! ${personality.emoji} Harcama oranın %${(personality.ratio * 100).toFixed(0)}.`;
                        } else if (personality.type === 'spender') {
                            financialNote = `\n\n💡 Finansal olarak da bir göz atalım mı? Belki rahatlaman için plan yapabiliriz.`;
                        }
                    }

                    return `${response}${financialNote}\n\n${greeting}, finansal durumunu konuşmak ister misin?`;
                }

                /**
                 * Hedef intent handler  
                 */
                handleGoalIntent(userText) {
                    const lowerText = userText.toLocaleLowerCase('tr-TR');
                    const greeting = this.getGreeting();

                    // Hedef türünü tespit et
                    let goalType = 'general';
                    let goalMotivation = '';

                    if (/ev|daire|konut|yuva/.test(lowerText)) {
                        goalType = 'house';
                        goalMotivation = this.pick(FINGO_VOCABULARY.goalMotivations.house);
                    } else if (/araba|araç|otomobil/.test(lowerText)) {
                        goalType = 'car';
                        goalMotivation = this.pick(FINGO_VOCABULARY.goalMotivations.car);
                    } else if (/tatil|seyahat|gezi/.test(lowerText)) {
                        goalType = 'vacation';
                        goalMotivation = this.pick(FINGO_VOCABULARY.goalMotivations.vacation);
                    } else if (/eğitim|okul|kurs|öğrenim/.test(lowerText)) {
                        goalType = 'education';
                        goalMotivation = this.pick(FINGO_VOCABULARY.goalMotivations.education);
                    } else if (/emeklilik|gelecek/.test(lowerText)) {
                        goalType = 'retirement';
                        goalMotivation = this.pick(FINGO_VOCABULARY.goalMotivations.retirement);
                    } else if (/acil|güvenlik|fon/.test(lowerText)) {
                        goalType = 'emergency';
                        goalMotivation = this.pick(FINGO_VOCABULARY.goalMotivations.emergency);
                    } else if (/yatırım|portföy/.test(lowerText)) {
                        goalType = 'investment';
                        goalMotivation = this.pick(FINGO_VOCABULARY.goalMotivations.investment);
                    }

                    // Hedefi profile kaydet
                    const currentGoals = this.memory.getProfile().financialGoals || [];
                    if (!currentGoals.includes(goalType) && goalType !== 'general') {
                        currentGoals.push(goalType);
                        this.memory.updateProfile({ financialGoals: currentGoals });
                    }

                    let response = `🎯 **Hedef Analizi**\n\n`;

                    if (goalMotivation) {
                        response += `${goalMotivation}\n\n`;
                    }

                    response += `${greeting}, hedefine ulaşmak için şunları yapabiliriz:\n\n`;
                    response += `1. 📊 Mevcut finansal durumunu analiz edelim\n`;
                    response += `2. 💰 Aylık ne kadar ayırman gerektiğini hesaplayalım\n`;
                    response += `3. 📅 Hedef tarih belirleyelim\n`;
                    response += `4. 🔔 İlerleme takibi kuralım`;

                    return response;
                }

                /**
                 * Öğrenme intent handler
                 */
                handleLearnIntent(userText) {
                    const lowerText = userText.toLocaleLowerCase('tr-TR');

                    // Hangi konu hakkında bilgi istiyor?
                    let topic = null;

                    if (/50.*30.*20|bütçe.*kural/.test(lowerText)) {
                        topic = this.financialEducation['50-30-20'];
                    } else if (/acil.*fon|güvenlik.*ağ/.test(lowerText)) {
                        topic = this.financialEducation['acil-fon'];
                    } else if (/bileşik.*faiz|faiz/.test(lowerText)) {
                        topic = this.financialEducation['bilesik-faiz'];
                    } else if (/enflasyon/.test(lowerText)) {
                        topic = this.financialEducation['enflasyon'];
                    } else if (/çeşitlen|portföy.*dağ/.test(lowerText)) {
                        topic = this.financialEducation['cesitlendirme'];
                    }

                    if (topic) {
                        return `${topic.emoji} **${topic.title}**\n\n${topic.content}\n\n💬 Başka bir konu hakkında bilgi almak ister misin?`;
                    }

                    // Genel eğitim menüsü
                    let response = `📚 **Finansal Eğitim Menüsü**\n\n`;
                    response += `Şu konularda bilgi verebilirim:\n\n`;

                    Object.values(this.financialEducation).forEach(edu => {
                        response += `${edu.emoji} ${edu.title}\n`;
                    });

                    response += `\n💡 Hangi konuyu öğrenmek istersin?`;

                    return response;
                }

                /**
                 * Hafıza hatırlama intent handler
                 */
                handleMemoryRecallIntent(userText) {
                    const greeting = this.getGreeting();
                    const recentConvos = this.memory.getRecentConversations(5);
                    const topIntents = this.memory.getTopIntents(3);
                    const profile = this.memory.getProfile();

                    if (recentConvos.length === 0) {
                        return `🧠 ${greeting}, henüz bir sohbet geçmişimiz yok. Bu ilk konuşmamız! 🎉\n\nNe hakkında konuşmak istersin?`;
                    }

                    let response = `🧠 **Sohbet Hafızam**\n\n`;
                    response += `📊 Toplam ${profile.totalInteractions} kez sohbet ettik.\n\n`;

                    if (topIntents.length > 0) {
                        response += `**En çok sorduğun konular:**\n`;
                        topIntents.forEach((t, i) => {
                            const topicMap = {
                                status: 'Durum Özeti',
                                advice: 'Tavsiye',
                                category: 'Kategori Analizi',
                                savings: 'Tasarruf/Yatırım',
                                subscription: 'Abonelikler'
                            };
                            response += `${i + 1}. ${topicMap[t.intent] || t.intent} (${t.count} kez)\n`;
                        });
                    }

                    response += `\n💬 ${greeting}, geçmiş konuşmalarımızı hatırlıyorum. Devam edelim mi?`;

                    return response;
                }

                /**
                 * Profil intent handler
                 */
                handleProfileIntent(userText) {
                    const greeting = this.getGreeting();
                    const profile = this.memory.getProfile();
                    const personality = this.detectSpendingPersonality();
                    const topIntents = this.memory.getTopIntents(3);

                    let response = `👤 **Senin Finansal Profilin**\n\n`;

                    // Harcama kişiliği
                    response += `${personality.emoji} **Kişilik:** ${personality.label}\n`;

                    if (personality.type !== 'unknown') {
                        response += `📊 **Harcama Oranı:** %${(personality.ratio * 100).toFixed(0)}\n`;
                    }

                    // İstatistikler
                    response += `\n📈 **İstatistikler:**\n`;
                    response += `• Toplam sohbet: ${profile.totalInteractions}\n`;

                    if (profile.firstSeen) {
                        const firstDate = new Date(profile.firstSeen);
                        response += `• İlk görüşme: ${firstDate.toLocaleDateString('tr-TR')}\n`;
                    }

                    // En çok ilgilendiği konular
                    if (topIntents.length > 0) {
                        response += `\n🎯 **İlgi Alanların:**\n`;
                        const topicMap = {
                            status: 'Durum takibi',
                            advice: 'Finansal tavsiye',
                            category: 'Kategori analizi',
                            savings: 'Tasarruf/Yatırım',
                            subscription: 'Abonelik yönetimi'
                        };
                        topIntents.slice(0, 3).forEach(t => {
                            response += `• ${topicMap[t.intent] || t.intent}\n`;
                        });
                    }

                    // Hedefler
                    if (profile.financialGoals && profile.financialGoals.length > 0) {
                        const goalLabels = {
                            house: '🏡 Ev',
                            car: '🚗 Araba',
                            vacation: '🏖️ Tatil',
                            education: '📚 Eğitim',
                            retirement: '👴 Emeklilik',
                            emergency: '🆘 Acil Fon',
                            investment: '📈 Yatırım'
                        };
                        response += `\n🎯 **Hedeflerin:**\n`;
                        profile.financialGoals.forEach(g => {
                            response += `• ${goalLabels[g] || g}\n`;
                        });
                    }

                    response += `\n${greeting}, profil verilerini güncellemek veya detay almak ister misin?`;

                    return response;
                }

                /**
                 * Teşekkür intent handler
                 */
                handleThanksIntent() {
                    const responses = [
                        "Rica ederim! 😊 Yardımcı olabildiysem ne mutlu!",
                        "Ne demek, her zaman buradayım! 🌟",
                        "Çok naziksin! Başka bir konuda yardımcı olabilir miyim?",
                        "Ben teşekkür ederim! Finansal yolculuğunda yanındayım 💪",
                        "Rica ederim! Soru sormaktan çekinme 🎯",
                        "Ne demek! Cüzdan dostu olarak görevimin başındayım 😄"
                    ];

                    return this.pick(responses);
                }

                /**
                 * Vedalaşma intent handler
                 */
                handleByeIntent() {
                    const timeGreeting = this.getTimeGreeting();
                    const responses = [
                        `Görüşmek üzere! ${timeGreeting}! 👋`,
                        "Hoşça kal! Finansal sağlık dileklerimle 💎",
                        "Bay bay! Her zaman buradayım, unutma! 🌟",
                        "Güle güle! Tasarruflar seninle olsun! 💰",
                        `${timeGreeting}! Tekrar görüşürüz! 😊`,
                        "Kendine iyi bak! Bütçeni de 📊"
                    ];

                    return this.pick(responses);
                }

                /**
                 * Kullanıcı içgörülerini güncelle
                 */
                updateUserInsights() {
                    const transactions = this.getCurrentMonthTransactions();

                    if (transactions.length === 0) return;

                    let totalIncome = 0, totalExpense = 0, totalSavings = 0;
                    const categoryTotals = {};

                    transactions.forEach(t => {
                        const amount = parseFloat(t.amount) || 0;

                        if (t.type === 'income') {
                            totalIncome += amount;
                        } else if (t.type === 'expense') {
                            if (isSavingsTransaction(t)) {
                                totalSavings += amount;
                            } else {
                                totalExpense += amount;
                                const cat = t.category || 'Diğer';
                                categoryTotals[cat] = (categoryTotals[cat] || 0) + amount;
                            }
                        }
                    });

                    // En çok harcanan kategorileri bul
                    const topCategories = Object.entries(categoryTotals)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([category, amount]) => ({ category, amount }));

                    const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpense) / totalIncome) * 100 : 0;

                    this.memory.updateInsights({
                        avgMonthlyIncome: totalIncome,
                        avgMonthlyExpense: totalExpense,
                        savingsRate: savingsRate,
                        topCategories: topCategories
                    });
                }

                /**
                 * Rastgele selamlama seç
                 */
                getGreeting() {
                    const g = this.greetings[Math.floor(Math.random() * this.greetings.length)];
                    return g ? g : "";
                }

                /**
                 * Diziden rastgele eleman seç
                 */
                pick(arr) {
                    if (!arr || arr.length === 0) return "";
                    return arr[Math.floor(Math.random() * arr.length)];
                }

                /**
                 * Belirli olasılıkla ek cümle ekle
                 */
                maybe(arr, probability = 0.35) {
                    if (Math.random() < probability && arr && arr.length > 0) {
                        return this.pick(arr);
                    }
                    return "";
                }

                /**
                 * Cevap sarıcı - açılış, ana içerik, takip sorusu ekler
                 */
                wrapResponse(intentType, coreText, opts = {}) {
                    const parts = [];

                    // Bazen açılış ekle (50% şans)
                    if (Math.random() < 0.5 && !opts.noOpener) {
                        parts.push(this.pick(this.tone.openers));
                        parts.push("");
                    }

                    // Ana içerik
                    parts.push(coreText);

                    // Takip sorusu ekle
                    const followUpList = this.tone.followUps[intentType] || this.tone.followUps.unknown;
                    if (followUpList && followUpList.length > 0 && !opts.noFollowUp) {
                        parts.push("");
                        parts.push("💬 " + this.pick(followUpList));
                    }

                    return parts.filter(p => p !== null && p !== undefined).join("\n");
                }

                /**
                 * localStorage'dan işlemleri al - DÜZELTME: Doğru key kullanılıyor
                 */
                getTransactions() {
                    try {
                        // Önce global window.transactions'ı kontrol et (en güncel veri)
                        if (window.transactions && Array.isArray(window.transactions) && window.transactions.length > 0) {
                            return window.transactions;
                        }

                        // Yoksa localStorage'dan al - doğru key ile
                        const APP_YEAR = (typeof window.APP_YEAR !== 'undefined') ? window.APP_YEAR : new Date().getFullYear();
                        const stored = localStorage.getItem(`my_expenses_${APP_YEAR}`);
                        if (stored) {
                            return JSON.parse(stored) || [];
                        }

                        return [];
                    } catch (e) {
                        console.error('FingoBrain getTransactions error:', e);
                        return [];
                    }
                }

                /**
                 * Bu ayın işlemlerini filtrele
                 */
                getCurrentMonthTransactions() {
                    const transactions = this.getTransactions();
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();

                    return transactions.filter(t => {
                        const date = new Date(t.date);
                        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                    });
                }

                /**
                 * Niyet algılama (Intent Detection)
                 */
                detectIntent(text) {
                    const normalizedText = text.toLocaleLowerCase('tr-TR').trim();

                    if (this.intents.greeting.test(normalizedText)) return { type: 'greeting' };
                    if (this.intents.help.test(normalizedText)) return { type: 'help' };
                    if (this.intents.status.test(normalizedText)) return { type: 'status' };
                    if (this.intents.advice.test(normalizedText)) return { type: 'advice' };
                    if (this.intents.subscription.test(normalizedText)) return { type: 'subscription' };
                    if (this.intents.topCategory.test(normalizedText)) return { type: 'topCategory' };
                    if (this.intents.savings.test(normalizedText)) return { type: 'savings' };
                    if (this.intents.budget.test(normalizedText)) return { type: 'budget' };
                    if (this.intents.forecast.test(normalizedText)) return { type: 'forecast' };
                    if (this.intents.compare.test(normalizedText)) return { type: 'compare' };
                    if (this.intents.score.test(normalizedText)) return { type: 'score' };

                    // Kategori sorgusu - kategori ismini çıkar
                    const categoryMatch = normalizedText.match(this.intents.category);
                    if (categoryMatch) {
                        const categoryName = categoryMatch[1].trim();
                        return { type: 'category', category: categoryName };
                    }

                    // V3.0 PİYASA & YATIRIM INTENT'LERİ
                    if (this.intents.investmentAdvice.test(normalizedText)) return { type: 'investmentAdvice' };
                    if (this.intents.marketStatus.test(normalizedText)) return { type: 'marketStatus' };
                    if (this.intents.currencyQuery.test(normalizedText)) return { type: 'currencyQuery' };
                    if (this.intents.goldQuery.test(normalizedText)) return { type: 'goldQuery' };

                    // AI LAB INTENTS
                    if (this.intents.aiExpenseAnalysis.test(normalizedText)) return { type: 'aiExpenseAnalysis' };
                    if (this.intents.aiPortfolioSimulator.test(normalizedText)) return { type: 'aiPortfolioSimulator' };
                    if (this.intents.aiFinancialForecast.test(normalizedText)) return { type: 'aiFinancialForecast' };

                    return { type: 'unknown' };
                }

                /**
                 * Genel durum analizi
                 */
                analyzeStatus() {
                    const transactions = this.getCurrentMonthTransactions();
                    const greeting = this.getGreeting();

                    if (transactions.length === 0) {
                        return `Merhaba ${greeting}! 👋\n\nBu ay henüz hiç işlem kaydı yok. Hadi ilk işlemini ekleyerek başla! 📝\n\nFinansal yolculuğun için veri toplamam gerekiyor. 🚀`;
                    }

                    let totalIncome = 0;
                    let totalSpending = 0;
                    let totalSavings = 0;

                    transactions.forEach(t => {
                        const amount = parseFloat(t.amount) || 0;
                        if (t.type === 'income') {
                            totalIncome += amount;
                        } else if (t.type === 'expense') {
                            if (isSavingsTransaction(t)) {
                                totalSavings += amount;
                            } else {
                                totalSpending += amount;
                            }
                        }
                    });

                    const remaining = totalIncome - totalSpending; // Birikim düşülmez, sadece harcama
                    const spendingRatio = totalIncome > 0 ? (totalSpending / totalIncome) * 100 : 0;

                    let statusEmoji, statusMessage;

                    if (spendingRatio >= 80) {
                        statusEmoji = "🚨";
                        statusMessage = "DİKKAT! Harcama oranın kritik seviyede. Acil tasarruf moduna geç!";
                    } else if (spendingRatio >= 60) {
                        statusEmoji = "⚠️";
                        statusMessage = "Harcamalar biraz yüksek. Gereksiz giderleri kısmayı düşün.";
                    } else if (spendingRatio >= 40) {
                        statusEmoji = "👍";
                        statusMessage = "Dengeli bir ay geçiriyorsun. Böyle devam!";
                    } else {
                        statusEmoji = "🌟";
                        statusMessage = "HARİKA! Tasarruf şampiyonusun. Bu gidişle finansal özgürlük yakın!";
                    }

                    return `${statusEmoji} **${greeting}, İşte Bu Ayın Özeti:**\n\n` +
                        `💰 **Toplam Gelir:** ${this.formatCurrency(totalIncome)}\n` +
                        `💸 **Toplam Gider:** ${this.formatCurrency(totalSpending)}\n` +
                        `💎 **Tasarruf/Birikim:** ${this.formatCurrency(totalSavings)}\n` +
                        `📊 **Kalan Para:** ${this.formatCurrency(remaining)}\n` +
                        `📈 **Harcama Oranı:** %${spendingRatio.toFixed(1)}\n\n` +
                        `${statusMessage}`;
                }

                /**
                 * Kategori analizi
                 */
                analyzeCategory(categoryName) {
                    const transactions = this.getCurrentMonthTransactions();
                    const greeting = this.getGreeting();

                    // Kategori eşleştirme (fuzzy match)
                    const expenses = transactions.filter(t => {
                        if (t.type !== 'expense') return false;
                        if (isSavingsTransaction(t)) return false;
                        const cat = (t.category || '').toLocaleLowerCase('tr-TR');
                        const desc = (t.description || '').toLocaleLowerCase('tr-TR');
                        const search = categoryName.toLocaleLowerCase('tr-TR');
                        return cat.includes(search) || desc.includes(search) || search.includes(cat);
                    });

                    if (expenses.length === 0) {
                        return `🔍 ${greeting}, "${categoryName}" ile ilgili bu ay herhangi bir harcama bulamadım.\n\nBelki farklı bir kategori adı deneyin? 🤔`;
                    }

                    const total = expenses.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    const count = expenses.length;
                    const avg = total / count;

                    return `📊 **"${categoryName}" Kategori Analizi:**\n\n` +
                        `💸 **Toplam Harcama:** ${this.formatCurrency(total)}\n` +
                        `🔢 **İşlem Sayısı:** ${count} adet\n` +
                        `📈 **Ortalama:** ${this.formatCurrency(avg)}/işlem\n\n` +
                        `${total > 500 ? '⚠️ Bu kategoride biraz fazla harcamışsın!' : '✅ Bu kategori kontrol altında görünüyor.'} ${greeting}!`;
                }

                /**
                 * En çok harcanan kategoriyi bul ve tavsiye ver
                 */
                analyzeTopCategory() {
                    const transactions = this.getCurrentMonthTransactions();
                    const greeting = this.getGreeting();

                    const expenses = transactions.filter(t => t.type === 'expense' && !isSavingsTransaction(t));

                    if (expenses.length === 0) {
                        return `📊 ${greeting}, bu ay henüz gider kaydın yok. Harcama verisi olmadan analiz yapamıyorum! 🧐`;
                    }

                    // Kategorilere göre grupla
                    const categoryTotals = {};
                    expenses.forEach(t => {
                        const cat = t.category || 'Diğer';
                        categoryTotals[cat] = (categoryTotals[cat] || 0) + (parseFloat(t.amount) || 0);
                    });

                    // En yüksek harcamayı bul
                    let topCategory = '';
                    let topAmount = 0;
                    for (const [cat, amount] of Object.entries(categoryTotals)) {
                        if (amount > topAmount) {
                            topAmount = amount;
                            topCategory = cat;
                        }
                    }

                    const totalExpense = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
                    const percentage = ((topAmount / totalExpense) * 100).toFixed(1);

                    return `🎯 **En Çok Harcama Yapılan Kategori:**\n\n` +
                        `🏆 **${topCategory}** → ${this.formatCurrency(topAmount)}\n` +
                        `📊 Toplam giderlerin **%${percentage}**'ını oluşturuyor!\n\n` +
                        `💡 **Tavsiyem:** ${topCategory} kategorisinde biraz kısıntıya gidersen, ay sonunda cebinde daha fazla para kalır ${greeting}! 🚀`;
                }

                /**
                 * Genel tavsiye ver - SMART LAYER ENTEGRASYONu
                 */
                giveAdvice() {
                    const transactions = this.getCurrentMonthTransactions();
                    const greeting = this.getGreeting();

                    // Yeni Smart Layer ile bağlam oluştur
                    const ctx = buildFingoContext(transactions);

                    if (!ctx.hasData) {
                        return `💡 ${greeting}, tavsiye verebilmem için önce biraz veri lazım!\n\nHarcamalarını kaydetmeye başla, ben de sana özel öneriler sunayım. 📝`;
                    }

                    // En son işlemden kategori çıkar (varsa)
                    const lastTx = ctx.recentTx && ctx.recentTx.length > 0 ? ctx.recentTx[0] : null;
                    const inferred = lastTx ? inferExpenseCategory(lastTx) : { categoryKey: 'DIGER', confidence: 0, signals: [] };

                    // Smart template ile öneri üret
                    let advice = buildAdviceFromTemplates(ctx, inferred);

                    // Anti-saçmalık filtresi
                    if (!validateAdvice(advice, ctx)) {
                        // Yasaklı kalıp varsa güvenli fallback kullan
                        advice = buildAdviceFromTemplates({ ...ctx, debtInstallmentTotal: ctx.debtInstallmentTotal }, { categoryKey: 'BORC_TAKSIT', confidence: 1, signals: ['fallback'] });
                    }

                    // Gelir-gider oranı uyarısı ekle
                    const spendingRatio = ctx.incomeTotal > 0 ? (ctx.expenseTotal / ctx.incomeTotal) : 0;
                    if (spendingRatio > 0.8) {
                        advice = `🚨 **DİKKAT:** Harcamaların gelirinin %${(spendingRatio * 100).toFixed(0)}'ini oluşturuyor!\n\n` + advice;
                    }

                    return advice;
                }

                /**
                 * Abonelik/sabit gider kontrolü
                 */
                checkSubscriptions() {
                    const transactions = this.getTransactions();
                    const greeting = this.getGreeting();

                    // Son 3 ayda tekrarlayan ödemeleri bul
                    const subscriptionKeywords = ['netflix', 'spotify', 'youtube', 'amazon', 'prime', 'hbo', 'disney',
                        'apple', 'icloud', 'google', 'microsoft', 'adobe', 'gym', 'spor', 'sigorta', 'internet',
                        'telefon', 'vodafone', 'turkcell', 'türk telekom', 'exxen', 'bein', 'gamepass', 'playstation'];

                    const potentialSubs = transactions.filter(t => {
                        if (t.type !== 'expense') return false;
                        const desc = (t.description || '').toLocaleLowerCase('tr-TR');
                        const cat = (t.category || '').toLocaleLowerCase('tr-TR');
                        return subscriptionKeywords.some(kw => desc.includes(kw) || cat.includes(kw));
                    });

                    if (potentialSubs.length === 0) {
                        return `🔍 ${greeting}, kayıtlarında belirgin bir abonelik tespit edemedim.\n\nAboneliklerini "Abonelik" kategorisi altında kaydedersen daha iyi takip edebilirim! 📝`;
                    }

                    // Benzersiz abonelikleri grupla
                    const uniqueSubs = {};
                    potentialSubs.forEach(t => {
                        const key = (t.description || t.category || 'Bilinmeyen').toLocaleLowerCase('tr-TR');
                        if (!uniqueSubs[key]) {
                            uniqueSubs[key] = { name: t.description || t.category, total: 0, count: 0 };
                        }
                        uniqueSubs[key].total += parseFloat(t.amount) || 0;
                        uniqueSubs[key].count++;
                    });

                    const subList = Object.values(uniqueSubs);
                    const totalMonthly = subList.reduce((sum, s) => sum + (s.total / Math.max(s.count, 1)), 0);

                    let response = `🔄 **Tespit Edilen Abonelikler, ${greeting}:**\n\n`;

                    subList.forEach(sub => {
                        const monthly = sub.total / Math.max(sub.count, 1);
                        response += `• **${sub.name}** → ~${this.formatCurrency(monthly)}/ay\n`;
                    });

                    response += `\n💰 **Tahmini Aylık Toplam:** ${this.formatCurrency(totalMonthly)}\n`;
                    response += `📅 **Yıllık Maliyet:** ${this.formatCurrency(totalMonthly * 12)}\n\n`;
                    response += `💡 Kullanmadığın abonelikleri iptal etmeyi düşün!`;

                    return response;
                }

                /**
                 * Tasarruf/yatırım durumu
                 */
                analyzeSavings() {
                    const transactions = this.getCurrentMonthTransactions();
                    const greeting = this.getGreeting();

                    const savingsKeywords = ['dolar', 'euro', 'altın', 'çeyrek', 'yatırım', 'birikim', 'tasarruf', 'fon', 'hisse'];

                    const savings = transactions.filter(t => {
                        const cat = (t.category || '').toLocaleLowerCase('tr-TR');
                        const desc = (t.description || '').toLocaleLowerCase('tr-TR');
                        return savingsKeywords.some(kw => cat.includes(kw) || desc.includes(kw));
                    });

                    if (savings.length === 0) {
                        return `💎 ${greeting}, bu ay tasarruf veya yatırım kaydın görünmüyor.\n\n` +
                            `💡 Altın, dolar veya fon alımlarını kaydetmeyi unutma!\n\n` +
                            `🚀 Küçük yatırımlar büyük servetler yaratır!`;
                    }

                    const totalSavings = savings.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

                    return `💎 **Tasarruf & Yatırım Özeti, ${greeting}:**\n\n` +
                        `📈 **Bu Ay Biriktirilen:** ${this.formatCurrency(totalSavings)}\n` +
                        `🔢 **İşlem Sayısı:** ${savings.length}\n\n` +
                        `🌟 Yatırım yapmaya devam et! Geleceğin için en güzel hediye bu.`;
                }

                /**
                 * Selamlama yanıtı
                 */
                greet() {
                    const greeting = this.getGreeting();
                    const hour = new Date().getHours();
                    let timeGreeting = 'Merhaba';

                    if (hour >= 5 && hour < 12) timeGreeting = 'Günaydın';
                    else if (hour >= 12 && hour < 18) timeGreeting = 'İyi günler';
                    else if (hour >= 18 && hour < 22) timeGreeting = 'İyi akşamlar';
                    else timeGreeting = 'İyi geceler';

                    return `${timeGreeting} ${greeting}! 👋\n\n` +
                        `Ben Fingo Brain, senin kişisel finans asistanınım. 🧠\n\n` +
                        `Bana finansal durumunu, harcamalarını veya tasarruf tavsiyeleri sorabilirsin!\n\n` +
                        `Ne ile yardımcı olabilirim? 🚀`;
                }

                /**
                 * Para formatla
                 */
                formatCurrency(amount) {
                    return new Intl.NumberFormat('tr-TR', {
                        style: 'currency',
                        currency: 'TRY',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    }).format(amount);
                }

                // ═══════════════════════════════════════════════════════════════
                // V2.1 ADVANCED ANALYTICS ENGINE (Pulse & DNA)
                // ═══════════════════════════════════════════════════════════════

                /**
                 * Gelişmiş Fingo Score Hesaplama (0-1000)
                 * Faktörler: 
                 * 1. Tasarruf Oranı (%40)
                 * 2. Harcama Dengesi (%30)
                 * 3. Düzenli İşlem (%20)
                 * 4. Volatilite (%10)
                 */
                calculateAdvancedScore() {
                    const transactions = this.getCurrentMonthTransactions();
                    if (transactions.length < 5) return { score: 500, label: 'Veri Yetersiz', color: 'gray' };

                    let income = 0;
                    let expense = 0;
                    let savings = 0;
                    let dailySpends = {};

                    transactions.forEach(t => {
                        const amt = parseFloat(t.amount) || 0;
                        if (t.type === 'income') income += amt;
                        else if (t.type === 'expense') {
                            if (isSavingsTransaction(t)) {
                                savings += amt;
                            } else {
                                expense += amt;
                                // Günlük harcama takibi
                                const day = new Date(t.date).getDate();
                                dailySpends[day] = (dailySpends[day] || 0) + amt;
                            }
                        }
                    });

                    // 1. Tasarruf Oranı Skoru (0-400)
                    const totalIn = income || 1;
                    const savingsRate = savings / totalIn; // 0.1 = %10
                    const savingsScore = Math.min(400, savingsRate * 2000); // %20 tasarruf = 400 puan

                    // 2. Harcama Dengesi Skoru (0-300)
                    const expenseRate = expense / totalIn;
                    let expenseScore = 0;
                    if (expenseRate < 0.5) expenseScore = 300;
                    else if (expenseRate < 0.8) expenseScore = 150;
                    else if (expenseRate < 1.0) expenseScore = 50;
                    else expenseScore = 0;

                    // 3. Volatilite Skoru (0-100)
                    const days = Object.values(dailySpends);
                    let volatilityScore = 50;
                    if (days.length > 0) {
                        const mean = days.reduce((a, b) => a + b, 0) / days.length;
                        const variance = days.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / days.length;
                        const stdDev = Math.sqrt(variance);
                        // Düşük volatilite iyidir. StdDev/Mean < 0.5 ise tam puan
                        const cv = mean > 0 ? stdDev / mean : 0;
                        volatilityScore = Math.max(0, 100 - (cv * 100));
                    }

                    // 4. Bonus/Düzen (200) - Şimdilik sabit pozitif varsayalım
                    const bonusScore = 150;

                    const totalScore = Math.round(savingsScore + expenseScore + volatilityScore + bonusScore);
                    const finalScore = Math.min(1000, Math.max(0, totalScore));

                    let label = 'İyi';
                    let color = 'indigo';
                    if (finalScore >= 800) { label = 'Mükemmel'; color = 'emerald'; }
                    else if (finalScore >= 600) { label = 'İyi'; color = 'indigo'; }
                    else if (finalScore >= 400) { label = 'Orta'; color = 'orange'; }
                    else { label = 'Riskli'; color = 'red'; }

                    return {
                        score: finalScore,
                        label,
                        color,
                        details: { savingsScore, expenseScore, volatilityScore }
                    };
                }

                /**
                 * DNA Analizi: Kategori Dağılımı ve Baskın Karakter
                 */
                analyzeDNA() {
                    const transactions = this.getCurrentMonthTransactions();
                    const categories = {};
                    let totalExp = 0;

                    transactions.forEach(t => {
                        if (t.type === 'expense' && !isSavingsTransaction(t)) {
                            const amt = parseFloat(t.amount) || 0;
                            const cat = t.category || 'Diğer';
                            categories[cat] = (categories[cat] || 0) + amt;
                            totalExp += amt;
                        }
                    });

                    // Sırala
                    const sortedCats = Object.entries(categories)
                        .sort((a, b) => b[1] - a[1])
                        .map(([name, value]) => ({ name, value, percent: (value / totalExp) * 100 }));

                    const dominant = sortedCats.length > 0 ? sortedCats[0] : { name: '-', value: 0 };
                    const diversity = Object.keys(categories).length;

                    // Radar Chart Verisi Hazırla (Top 5 + Diğerleri)
                    const chartLabels = sortedCats.slice(0, 5).map(c => c.name);
                    const chartData = sortedCats.slice(0, 5).map(c => c.value);

                    return {
                        dominant,
                        diversity,
                        chart: {
                            labels: chartLabels,
                            data: chartData
                        },
                        totalExp
                    };
                }

                /**
                 * Ay Sonu Tahmin Model (Linear Regression Simplified)
                 */
                getPulseForecast() {
                    const transactions = this.getCurrentMonthTransactions();
                    const now = new Date();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const day = now.getDate();

                    let totalExp = 0;
                    transactions.forEach(t => {
                        if (t.type === 'expense' && !isSavingsTransaction(t)) {
                            totalExp += parseFloat(t.amount) || 0;
                        }
                    });

                    const dailyAvg = totalExp / Math.max(day, 1);
                    const projected = dailyAvg * daysInMonth; // Linear projection

                    // Gelecek ay için basit trend (Geçen ay verisi varsa, karşılaştır)
                    // Şimdilik sadece bu ayın projeksiyonunu dönüyoruz.
                    return {
                        current: totalExp,
                        projected: projected,
                        remainingDays: daysInMonth - day,
                        dailyAvg: dailyAvg
                    };
                }

                /**
                 * Ana mesaj işleme fonksiyonu - V2.0 Enhanced
                 */
                processMessage(userText) {
                    const intent = this.detectIntent(userText);
                    let response = '';

                    // Kullanıcı içgörülerini güncelle (arka planda)
                    this.updateUserInsights();

                    switch (intent.type) {
                        case 'greeting':
                            response = this.wrapResponse('greeting', this.greet(), { noOpener: true });
                            break;
                        case 'help':
                            response = this.showHelp();
                            break;
                        case 'status':
                            response = this.wrapResponse('status', this.analyzeStatus());
                            break;
                        case 'category':
                            response = this.wrapResponse('category', this.analyzeCategory(intent.category));
                            break;
                        case 'advice':
                            response = this.wrapResponse('advice', this.giveAdvice());
                            break;
                        case 'subscription':
                            response = this.wrapResponse('subscription', this.checkSubscriptions());
                            break;
                        case 'topCategory':
                            response = this.wrapResponse('topCategory', this.analyzeTopCategory());
                            break;
                        case 'savings':
                            response = this.wrapResponse('savings', this.analyzeSavings());
                            break;
                        case 'budget':
                            response = this.wrapResponse('advice', this.analyzeBudget());
                            break;
                        case 'forecast':
                            response = this.wrapResponse('status', this.analyzeForecast());
                            break;
                        case 'compare':
                            response = this.wrapResponse('status', this.compareMonths());
                            break;
                        case 'score':
                            response = this.wrapResponse('status', this.showScore());
                            break;

                        // V2.0 YENİ INTENT'LER
                        case 'mood':
                            response = this.handleMoodIntent(userText);
                            break;
                        case 'goal':
                            response = this.wrapResponse('goal', this.handleGoalIntent(userText));
                            break;
                        case 'learn':
                            response = this.handleLearnIntent(userText);
                            break;
                        case 'memoryRecall':
                            response = this.handleMemoryRecallIntent(userText);
                            break;
                        case 'profile':
                            response = this.handleProfileIntent(userText);
                            break;
                        case 'thanks':
                            response = this.handleThanksIntent();
                            break;
                        case 'bye':
                            response = this.handleByeIntent();
                            break;
                        case 'joke':
                            response = this.handleJokeIntent();
                            break;

                        // AI LAB HANDLERS
                        case 'aiExpenseAnalysis':
                            response = (typeof window.ExpenseAnalyzer !== 'undefined' && window.ExpenseAnalyzer.getChatResponse)
                                ? window.ExpenseAnalyzer.getChatResponse()
                                : "📊 Harcama analizi modülü şu an hazır değil.";
                            break;
                        case 'aiPortfolioSimulator':
                            response = (typeof window.PortfolioSimulator !== 'undefined' && window.PortfolioSimulator.getChatResponse)
                                ? window.PortfolioSimulator.getChatResponse()
                                : "📈 Portföy simülasyon modülü şu an hazır değil.";
                            break;
                        case 'aiFinancialForecast':
                            response = (typeof window.FinancialForecast !== 'undefined' && window.FinancialForecast.getChatResponse)
                                ? window.FinancialForecast.getChatResponse()
                                : "🔮 Finansal öngörü modülü şu an hazır değil.";
                            break;

                        // V3.0 YENİ INTENT'LER - PİYASA & YATIRIM
                        case 'marketStatus':
                            response = this.wrapResponse('market', this.analyzeMarketStatus());
                            break;
                        case 'currencyQuery':
                            response = this.wrapResponse('market', this.analyzeCurrencyStatus());
                            break;
                        case 'goldQuery':
                            response = this.wrapResponse('market', this.analyzeGoldStatus());
                            break;
                        case 'investmentAdvice':
                            response = this.wrapResponse('investment', this.generateInvestmentAdvice());
                            break;

                        default:
                            response = this.handleSmartFallback(userText);
                    }

                    // Konuşmayı hafızaya kaydet
                    try {
                        this.memory.saveConversation(userText, response, intent.type);
                    } catch (e) {
                        console.warn('Memory save error:', e);
                    }

                    return response;
                }

                /**
                 * Şaka/espri intent handler
                 */
                handleJokeIntent() {
                    const jokes = [
                        "Neden ekonomistler kötü sevgili olur? Çünkü sürekli 'düşüş trendinden' bahsederler! 😄",
                        "Para ağaçta yetişmez diyorlar... Peki salatalık nasıl yetişiyor? 🥒💰",
                        "Banka hesabımla egom arasındaki fark: Egom hiç ekside değil! 😅",
                        "Paranın konuştuğu söylenir. Benimki sadece 'güle güle' diyor! 👋💸",
                        "Zengin olmak istiyorsan iki yol var: Ya çok kazan, ya az harca. Ben ikisini de yapamıyorum! 🤷",
                        "Maaş günü: Hesabıma baktım, güldüm. Hesabım da bana güldü. 😂",
                        "Finans uzmanıyım diyorum, hesap makinesi olmadan toplama yapamıyorum! 🧮",
                        "Bütçe yapmak kolay: Gelir - Gider = Gözyaşı 😢📊"
                    ];

                    const joke = this.pick(jokes);
                    return `😄 **Biraz Gülümseyelim!**\n\n${joke}\n\n💬 Şimdi ciddi konulara dönelim mi?`;
                }

                // ═══════════════════════════════════════════════════════════════════════
                // V3.0 PİYASA ANALİZİ & YATIRIM DANIŞMANLIĞI METODLARİ
                // ═══════════════════════════════════════════════════════════════════════

                /**
                 * Piyasa kuru verilerini al
                 */
                getMarketRates() {
                    const rates = window.liveRates || { USD: 0, EUR: 0, GRAM: 0, QUARTER: 0 };
                    return {
                        usd: rates.USD || 34.50,
                        eur: rates.EUR || 37.50,
                        gram: rates.GRAM || 3200,
                        quarter: rates.QUARTER || 5200,
                        isLive: rates.USD > 0 && rates.EUR > 0
                    };
                }

                /**
                 * Genel piyasa durumu analizi
                 */
                analyzeMarketStatus() {
                    const greeting = this.getGreeting();
                    const rates = this.getMarketRates();

                    // Trend emojileri (basit simülasyon - gerçek veri yoksa)
                    const trendEmoji = (val) => val > 0 ? '📈' : val < 0 ? '📉' : '➡️';

                    let response = `📊 **Güncel Piyasa Durumu** ${greeting}!\n\n`;

                    if (rates.isLive) {
                        response += `💵 **Dolar (USD):** ${this.formatCurrency(rates.usd)}\n`;
                        response += `💶 **Euro (EUR):** ${this.formatCurrency(rates.eur)}\n`;
                        response += `🥇 **Gram Altın:** ${this.formatCurrency(rates.gram)}\n`;
                        response += `🪙 **Çeyrek Altın:** ${this.formatCurrency(rates.quarter)}\n\n`;

                        response += `🔍 **Genel Değerlendirme:**\n`;
                        response += `Piyasa verileri anlık olarak güncellendi. `;

                        // Basit analiz
                        if (rates.gram > 3000) {
                            response += `Altın fiyatları yüksek seviyelerde seyrediyor. `;
                        }
                        if (rates.usd > 34) {
                            response += `Dolar/TL kuru yükselmiş durumda. `;
                        }

                        response += `\n\n💡 Detaylı yatırım tavsiyesi için "Yatırım tavsiyesi ver" diyebilirsin!`;
                    } else {
                        response += `⚠️ Anlık piyasa verileri şu an yüklenemedi.\n\n`;
                        response += `Son bilinen yaklaşık değerler:\n`;
                        response += `💵 Dolar: ~34.50₺ | 💶 Euro: ~37.50₺ | 🥇 Gram: ~3,200₺\n\n`;
                        response += `💡 Sayfa yenilendiğinde güncel veriler yüklenecek.`;
                    }

                    return response;
                }

                /**
                 * Döviz durumu analizi
                 */
                analyzeCurrencyStatus() {
                    const greeting = this.getGreeting();
                    const rates = this.getMarketRates();

                    let response = `💱 **Döviz Kurları** ${greeting}!\n\n`;

                    response += `💵 **Amerikan Doları (USD):** ${this.formatCurrency(rates.usd)}\n`;
                    response += `💶 **Euro (EUR):** ${this.formatCurrency(rates.eur)}\n`;

                    // EUR/USD oranı
                    const eurUsdRatio = (rates.eur / rates.usd).toFixed(2);
                    response += `📊 **EUR/USD Oranı:** ${eurUsdRatio}\n\n`;

                    // Yatırım yapılmış döviz varsa göster
                    const transactions = this.getCurrentMonthTransactions();
                    const currencyInvestments = transactions.filter(t =>
                        t.type === 'expense' &&
                        (t.category?.includes('Dolar') || t.category?.includes('Euro'))
                    );

                    if (currencyInvestments.length > 0) {
                        const totalCurrency = currencyInvestments.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                        response += `💼 **Senin Döviz Yatırımların:** Bu ay ${this.formatCurrency(totalCurrency)} tutarında döviz işlemi yaptın.\n\n`;
                    }

                    response += `💡 **Tavsiye:** Döviz tutmak enflasyona karşı koruma sağlar, ancak kur dalgalanmalarını takip et!`;

                    return response;
                }

                /**
                 * Altın durumu analizi
                 */
                analyzeGoldStatus() {
                    const greeting = this.getGreeting();
                    const rates = this.getMarketRates();

                    let response = `🥇 **Altın Fiyatları** ${greeting}!\n\n`;

                    response += `🪙 **Gram Altın:** ${this.formatCurrency(rates.gram)}\n`;
                    response += `🏅 **Çeyrek Altın:** ${this.formatCurrency(rates.quarter)}\n`;
                    response += `💍 **Yarım Altın:** ~${this.formatCurrency(rates.quarter * 2)}\n`;
                    response += `👑 **Tam Altın:** ~${this.formatCurrency(rates.quarter * 4)}\n\n`;

                    // Altın yatırımı varsa göster
                    const transactions = this.getCurrentMonthTransactions();
                    const goldInvestments = transactions.filter(t =>
                        t.type === 'expense' &&
                        (t.category?.includes('Altın') || t.category?.includes('Gold'))
                    );

                    if (goldInvestments.length > 0) {
                        const totalGold = goldInvestments.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                        response += `💎 **Senin Altın Yatırımın:** Bu ay ${this.formatCurrency(totalGold)} tutarında altın yatırımı yaptın.\n\n`;
                    }

                    response += `💡 **Bilgi:** Altın, ekonomik belirsizlik dönemlerinde güvenli liman olarak değerlendirilir.`;

                    return response;
                }

                /**
                 * Kişiselleştirilmiş yatırım tavsiyesi
                 */
                generateInvestmentAdvice() {
                    const greeting = this.getGreeting();
                    const rates = this.getMarketRates();
                    const transactions = this.getCurrentMonthTransactions();

                    // Finansal durum analizi
                    let totalIncome = 0;
                    let totalExpense = 0;
                    let totalSavings = 0;

                    transactions.forEach(t => {
                        const amount = parseFloat(t.amount) || 0;
                        if (t.type === 'income') {
                            totalIncome += amount;
                        } else if (t.type === 'expense') {
                            if (this.isSavingsCategory(t.category)) {
                                totalSavings += amount;
                            } else {
                                totalExpense += amount;
                            }
                        }
                    });

                    const netRemaining = totalIncome - totalExpense;
                    const savingsCapacity = totalIncome > 0 ? ((totalIncome - totalExpense) / totalIncome * 100) : 0;

                    let response = `💡 **Sana Özel Yatırım Tavsiyem** ${greeting}!\n\n`;

                    // Finansal durum özeti
                    response += `📊 **Finansal Durumun:**\n`;
                    response += `• Aylık Gelir: ${this.formatCurrency(totalIncome)}\n`;
                    response += `• Aylık Gider: ${this.formatCurrency(totalExpense)}\n`;
                    response += `• Tasarruf Kapasitesi: %${savingsCapacity.toFixed(0)}\n`;
                    response += `• Mevcut Birikim: ${this.formatCurrency(totalSavings)}\n\n`;

                    // Kişiselleştirilmiş tavsiyeler
                    response += `🎯 **Önerilerim:**\n\n`;

                    // Acil durum fonu kontrolü
                    const emergencyFundTarget = totalExpense * 3; // 3 aylık gider

                    if (totalSavings < emergencyFundTarget) {
                        response += `1️⃣ **Acil Durum Fonu (Öncelik!):**\n`;
                        response += `   Henüz 3 aylık giderini karşılayacak acil fonun yok.\n`;
                        response += `   Hedef: ${this.formatCurrency(emergencyFundTarget)} - Mevcut: ${this.formatCurrency(totalSavings)}\n`;
                        response += `   💼 İlk birikimini yüksek faizli vadeli mevduata koy.\n\n`;
                    }

                    // Tasarruf kapasitesine göre tavsiye
                    if (savingsCapacity >= 30) {
                        response += `2️⃣ **Altın Yatırımı:**\n`;
                        response += `   Gram altın: ${this.formatCurrency(rates.gram)}\n`;
                        response += `   💡 Düzenli olarak gram altın biriktir. Uzun vadede değer korur.\n\n`;

                        response += `3️⃣ **Döviz Çeşitlendirmesi:**\n`;
                        response += `   Dolar: ${this.formatCurrency(rates.usd)} | Euro: ${this.formatCurrency(rates.eur)}\n`;
                        response += `   💡 Portföyünde %20-30 döviz bulundur.\n\n`;

                    } else if (savingsCapacity >= 15) {
                        response += `2️⃣ **Küçük Adımlarla Başla:**\n`;
                        response += `   💡 Her ay gelirinin %10-15'ini ayır.\n`;
                        response += `   💡 Gram altın veya döviz ile başla.\n\n`;

                    } else if (savingsCapacity > 0) {
                        response += `2️⃣ **Önce Tasarruf Alışkanlığı:**\n`;
                        response += `   ⚠️ Tasarruf kapasiten düşük. Önce harcamaları optimize et.\n`;
                        response += `   💡 Aboneliklerini gözden geçir, gereksiz giderleri kes.\n\n`;

                    } else {
                        response += `⚠️ **Dikkat:**\n`;
                        response += `   Şu an giderlerin gelirinden fazla. Önce bütçeni dengele.\n`;
                        response += `   💡 "Bana tavsiye ver" diyerek tasarruf önerileri alabilirsin.\n\n`;
                    }

                    // Risk uyarısı
                    response += `📈 **Risk Dağılımı Önerisi:**\n`;
                    response += `   • %40 Güvenli (Mevduat/Fon)\n`;
                    response += `   • %30 Orta Risk (Altın/Döviz)\n`;
                    response += `   • %30 Yüksek Risk (Borsa/Kripto)\n\n`;

                    // Yasal uyarı
                    response += `⚠️ *Bu bilgiler genel değerlendirmedir, yatırım tavsiyesi niteliği taşımaz. Yatırım kararlarınızı kendi araştırmanıza dayanarak veriniz.*`;

                    return response;
                }

                /**
                 * Tasarruf kategorisi kontrolü
                 */
                isSavingsCategory(category) {
                    if (!category) return false;
                    const savingsKeywords = ['altın', 'dolar', 'euro', 'birikim', 'yatırım', 'fon', 'hisse', 'kripto', 'btc', 'gold'];
                    const lowerCat = category.toLowerCase();
                    return savingsKeywords.some(kw => lowerCat.includes(kw));
                }

                // ═══════════════════════════════════════════════════════════════════════
                // AKILLI FALLBACK SİSTEMİ - Her Soruya Mantıklı Cevap
                // ═══════════════════════════════════════════════════════════════════════

                /**
                 * Ana Smart Fallback Handler
                 */
                handleSmartFallback(text) {
                    const lowerText = text.toLowerCase().trim();
                    const greeting = this.getGreeting();

                    // 1. Selamlama kontrolü
                    const greetingResponse = this.tryGreeting(lowerText);
                    if (greetingResponse) return greetingResponse;

                    // 2. Matematik hesaplama kontrolü
                    const calcResult = this.tryCalculate(text);
                    if (calcResult) return calcResult;

                    // 3. Tarih/saat kontrolü
                    const dateTimeResult = this.tryDateTime(lowerText);
                    if (dateTimeResult) return dateTimeResult;

                    // 4. Bilgi tabanı kontrolü
                    const knowledgeResult = this.tryKnowledgeBase(lowerText);
                    if (knowledgeResult) return knowledgeResult;

                    // 5. Finans yönlendirme kontrolü
                    const financeRedirect = this.tryFinanceRedirect(lowerText);
                    if (financeRedirect) return financeRedirect;

                    // 6. Genel konuşma/fikir sorusu
                    const conversationalResult = this.tryConversational(lowerText);
                    if (conversationalResult) return conversationalResult;

                    // 7. Son çare - Akıllı öneri
                    return this.generateSmartSuggestion(text);
                }

                /**
                 * Selamlama kontrolü
                 */
                tryGreeting(text) {
                    const greetings = {
                        'merhaba': ['Merhaba! 👋', 'Selam! 🌟', 'Hey! 😊'],
                        'selam': ['Selam! 👋', 'Merhaba! 🌟', 'Nasıl gidiyor? 😊'],
                        'günaydın': ['Günaydın! ☀️', 'Günaydın! Harika bir gün olsun! 🌅'],
                        'iyi akşamlar': ['İyi akşamlar! 🌙', 'İyi akşamlar, nasıl yardımcı olabilirim?'],
                        'iyi geceler': ['İyi geceler! 🌙', 'Tatlı rüyalar! 😴'],
                        'nasılsın': ['İyiyim, teşekkür ederim! 😊 Sen nasılsın?', 'Harika! Sana yardım etmek için buradayım! 🌟'],
                        'naber': ['İyilik senden naber? 😄', 'Bomba gibiyim! Sen? 🚀'],
                        'ne haber': ['İyilik! Senden ne haber? 😊', 'Her şey yolunda! Sen nasılsın?'],
                        'teşekkür': ['Rica ederim! 😊', 'Ne demek, her zaman! 🌟', 'Yardımcı olabildiysem ne mutlu! 💫'],
                        'sağol': ['Rica ederim! 😊', 'Ne demek! 🌟'],
                        'eyvallah': ['Rica ederim! 🤝', 'Her zaman! ✌️']
                    };

                    for (const [key, responses] of Object.entries(greetings)) {
                        if (text.includes(key)) {
                            const response = this.pick(responses);
                            return `${response}\n\n💬 Finansal durumun hakkında sohbet etmek ister misin?`;
                        }
                    }
                    return null;
                }

                /**
                 * Matematik hesaplama
                 */
                tryCalculate(text) {
                    // Türkçe sayıları rakama çevir
                    const turkishNumbers = {
                        'sıfır': 0, 'bir': 1, 'iki': 2, 'üç': 3, 'dört': 4,
                        'beş': 5, 'altı': 6, 'yedi': 7, 'sekiz': 8, 'dokuz': 9,
                        'on': 10, 'yirmi': 20, 'otuz': 30, 'kırk': 40, 'elli': 50,
                        'altmış': 60, 'yetmiş': 70, 'seksen': 80, 'doksan': 90,
                        'yüz': 100, 'bin': 1000, 'milyon': 1000000
                    };

                    let processedText = text.toLowerCase();
                    for (const [word, num] of Object.entries(turkishNumbers)) {
                        processedText = processedText.replace(new RegExp(word, 'g'), num);
                    }

                    // İşlem kelimelerini operatörlere çevir
                    processedText = processedText
                        .replace(/artı|toplam|ve/g, '+')
                        .replace(/eksi|çıkar|farkı/g, '-')
                        .replace(/çarpı|kere|defa/g, '*')
                        .replace(/bölü|böl/g, '/')
                        .replace(/yüzde\s*(\d+)/g, '* $1 / 100')
                        .replace(/(\d+)\s*'?(ın|in|un|ün)?\s*yüzde\s*(\d+)/g, '$1 * $3 / 100')
                        .replace(/kaç|ne kadar|eder|kaçtır|\?/g, '');

                    // Sadece sayı ve operatör içeren kısımları bul
                    const mathPattern = /[\d\s\+\-\*\/\.\(\)]+/g;
                    const matches = processedText.match(mathPattern);

                    if (matches) {
                        for (const match of matches) {
                            const cleaned = match.trim();
                            if (cleaned && /\d/.test(cleaned) && /[\+\-\*\/]/.test(cleaned)) {
                                try {
                                    // Güvenli hesaplama (eval yerine Function kullan)
                                    const sanitized = cleaned.replace(/[^0-9\+\-\*\/\.\(\)\s]/g, '');
                                    if (sanitized) {
                                        const result = Function('"use strict"; return (' + sanitized + ')')();
                                        if (typeof result === 'number' && isFinite(result)) {
                                            const formattedResult = Number.isInteger(result) ? result : result.toFixed(2);
                                            return `🧮 **Hesaplama Sonucu**\n\n` +
                                                `📝 İşlem: \`${cleaned.trim()}\`\n` +
                                                `✅ Sonuç: **${formattedResult}**\n\n` +
                                                `💬 Başka bir hesaplama yapmamı ister misin?`;
                                        }
                                    }
                                } catch (e) {
                                    // Hesaplama hatası - devam et
                                }
                            }
                        }
                    }
                    return null;
                }

                /**
                 * Tarih ve saat sorguları
                 */
                tryDateTime(text) {
                    const now = new Date();
                    const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                    const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                        'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];

                    // Saat sorgusu
                    if (text.includes('saat kaç') || text.includes('saat ne')) {
                        const hours = now.getHours().toString().padStart(2, '0');
                        const minutes = now.getMinutes().toString().padStart(2, '0');
                        return `🕐 Şu an saat **${hours}:${minutes}**\n\n💬 Başka bir konuda yardımcı olabilir miyim?`;
                    }

                    // Gün sorgusu
                    if (text.includes('bugün günlerden') || text.includes('bugün hangi gün') ||
                        text.includes('günlerden ne') || text.includes('hangi gündeyiz')) {
                        return `📅 Bugün **${days[now.getDay()]}**\n\n📆 Tarih: ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}\n\n💬 Başka bir şey sormak ister misin?`;
                    }

                    // Tarih sorgusu
                    if (text.includes('bugün tarih') || text.includes('tarih ne') || text.includes('bugünün tarihi')) {
                        return `📆 Bugünün tarihi: **${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}**\n🗓️ ${days[now.getDay()]}\n\n💬 Yardımcı olabileceğim başka bir konu var mı?`;
                    }

                    // Ay sorgusu
                    if (text.includes('hangi aydayız') || text.includes('bu ay hangi ay')) {
                        return `📅 Şu an **${months[now.getMonth()]} ${now.getFullYear()}** ayındayız.\n\n💬 Bu ayki harcamalarını merak ediyor musun?`;
                    }

                    // Yıl sorgusu
                    if (text.includes('hangi yıldayız') || text.includes('yıl kaç')) {
                        return `📆 ${now.getFullYear()} yılındayız!\n\n💬 Bu yılki finansal hedeflerini konuşmak ister misin?`;
                    }

                    return null;
                }

                /**
                 * Bilgi tabanı 
                 */
                tryKnowledgeBase(text) {
                    const knowledge = {
                        // Hava durumu
                        'hava nasıl': `🌤️ Hava durumu bilgisi için gerçek zamanlı veri servisine ihtiyacım var.\n\n💡 Bunun yerine sana finansal "hava durumunu" söyleyebilirim - bütçen nasıl gidiyor merak ediyor musun?`,
                        'hava durumu': `🌤️ Maalesef hava durumu verilerine erişimim yok.\n\n💡 Ama finansal durumunu analiz edebilirim! "Bu ay durumum nasıl?" diye sorabilirsin.`,

                        // Hayatın anlamı
                        'hayatın anlamı': `🤔 **Derin bir soru!**\n\nBence hayatın anlamı, küçük mutluluklar biriktirmekte gizli. Tıpkı birikim yapmak gibi - her gün küçük adımlar, büyük sonuçlar! 💫\n\n💬 Sen ne düşünüyorsun?`,

                        // Kim/ne soru
                        'sen kimsin': `🤖 Ben **Fingo Brain**!\n\nSenin kişisel finans asistanınım. Harcamalarını analiz eder, tasarruf önerileri sunar ve finansal hedeflerine ulaşmana yardımcı olurum.\n\n💡 Bana "yardım" diyerek neler yapabileceğimi görebilirsin!`,

                        'adın ne': `🤖 Benim adım **Fingo Brain**! Senin akıllı finans asistanınım. 🧠💰`,

                        'seni kim yaptı': `👨‍💻 Fingenda takımı tarafından, sana en iyi finansal deneyimi sunmak için geliştirildim!\n\n💡 Seninle sohbet etmek ve finansal konularda yardımcı olmak için buradayım.`,

                        // Motivasyon
                        'motive et': `💪 **Motivasyon Zamanı!**\n\n"Başarı, her gün tekrarlanan küçük çabalardan oluşur."\n\nBugün attığın her adım, yarının zenginliğinin temelidir! 🚀\n\n💰 Hadi, finansal hedeflerini birlikte konuşalım!`,

                        // Şanslı sayı
                        'şanslı sayı': `🎲 **Bugünün Şanslı Sayısı:** ${Math.floor(Math.random() * 100) + 1}\n\n😄 Ama gerçek şans, akıllı finansal kararlarla gelir!`,

                        // Aşk
                        'aşk': `💕 Aşk güzel bir şey! Ama finansal uyum da önemli - çiftlerin %40'ı para konusunda anlaşmazlık yaşıyor.\n\n💡 İpucu: Partnerinle ortak bir bütçe yapmak ilişkiyi güçlendirir!`,

                        // Sıkıldım
                        'sıkıldım': `😄 Gel biraz eğlenelim!\n\n🎯 **Mini Oyun:** Son bir haftada en büyük gereksiz harcaman neydi? Düşün ve bir dahaki sefere onu yapmamaya çalış!\n\n💡 Ya da "bana şaka yap" diyebilirsin!`,

                        // Acıktım
                        'acıktım': `🍕 Hmm, yemek zamanı!\n\n💡 Biliyor musun? Dışarıda yemek, evde yemekten ortalama 3-4 kat daha pahalı. Bu ay yemek harcamalarını kontrol etmek ister misin?`,

                        // Yorgunum
                        'yorgunum': `😴 Dinlenmek önemli!\n\nAma bir dakika - son zamanlarda stres harcamaları yapıyor olabilir misin? Yorgunken alışveriş yapmak cüzdana zarar verir! 💸\n\n💡 Biraz mola ver, kendine iyi bak!`,

                        // Teşekkür
                        'sağol': `😊 Rica ederim! Yardımcı olabildiysem ne mutlu!\n\n💬 Başka sorun varsa buradayım.`,

                        // Espri iste
                        'fıkra anlat': null, // handleJokeIntent'e yönlendir

                        // Psikolojik
                        'depresyon': `💙 Zor zamanlar geçirdiğini duyduğuma üzüldüm.\n\nBen bir finans asistanıyım ve bu konuda profesyonel destek almanı öneririm. Ama finansal stres azaltma konusunda yardımcı olabilirim.\n\n💡 Bazen maddi düzen, zihinsel düzene de yardımcı olur.`,

                        // Yapay zeka
                        'yapay zeka': `🤖 Evet, ben bir yapay zeka asistanıyım!\n\nAma endişelenme, sadece finansal konularda yardım etmek için buradayım. Dünyayı ele geçirme planım yok... şimdilik! 😄\n\n💬 Şaka şaka, nasıl yardımcı olabilirim?`
                    };

                    for (const [key, response] of Object.entries(knowledge)) {
                        if (text.includes(key)) {
                            if (response === null) {
                                return this.handleJokeIntent();
                            }
                            return response;
                        }
                    }
                    return null;
                }

                /**
                 * Finans konularına yönlendirme
                 */
                tryFinanceRedirect(text) {
                    const financeKeywords = {
                        'para': 'Para konusunda yardımcı olabilirim! "Bu ay durumum nasıl?" veya "Bana tavsiye ver" diyebilirsin.',
                        'bütçe': 'Bütçe analizi için "50-30-20 kuralı" veya "Bütçemi analiz et" diyebilirsin!',
                        'tasarruf': 'Tasarruf konusunda ipuçları için "Nasıl tasarruf ederim?" diye sorabilirsin.',
                        'kredi': 'Kredi konusunda dikkatli ol! Aylık gelirininin %30\'undan fazlasını kredi taksitine ayırmamalısın.',
                        'borç': 'Borç yönetimi önemli! "Borç hesaplayıcı" veya mali durumunu görmek için "Özet" diyebilirsin.',
                        'maaş': 'Maaş günü planlaması için "Gelirlerimi göster" diyebilirsin!',
                        'fatura': 'Fatura takibi için "Aboneliklerimi göster" veya "Sabit giderlerim" diyebilirsin.',
                        'alışveriş': 'Alışveriş harcamalarını görmek için "Market harcamalarım" diyebilirsin!'
                    };

                    for (const [key, response] of Object.entries(financeKeywords)) {
                        if (text.includes(key)) {
                            return `💰 **${key.charAt(0).toUpperCase() + key.slice(1)} Hakkında**\n\n${response}`;
                        }
                    }
                    return null;
                }

                /**
                 * Genel sohbet/fikir soruları
                 */
                tryConversational(text) {
                    // Nasıl/neden/nedir soruları
                    if (text.startsWith('nasıl') || text.includes('nasıl yap')) {
                        if (text.includes('para') || text.includes('zengin') || text.includes('tasarruf')) {
                            return `💡 **Finansal Başarının Sırrı:**\n\n1. 📊 Gelir-gider takibi yap\n2. 💰 Önce kendine öde (%20 biriktir)\n3. 🎯 Net hedefler koy\n4. 📱 Fingenda ile takip et!\n\n💬 "Bana tavsiye ver" diyerek kişisel öneriler alabilirsin.`;
                        }
                    }

                    if (text.includes('ne yapmalı') || text.includes('ne yapsam') || text.includes('önerin')) {
                        return `🤔 Hmm, genel bir tavsiye mi arıyorsun?\n\nBen finansal konularda uzmanım! Şunları sorabilirsin:\n\n💰 "Bu ay durumum nasıl?"\n📊 "Bana tavsiye ver"\n🎯 "Hedef belirle"\n\n💬 Hangi konuda yardım istersin?`;
                    }

                    // Evet/Hayır cevapları
                    if (text === 'evet' || text === 'hayır' || text === 'olur' || text === 'tamam') {
                        const positives = ['evet', 'olur', 'tamam'];
                        if (positives.includes(text)) {
                            return `👍 Harika! Nasıl yardımcı olabilirim?\n\n💡 Şunları sorabilirsin:\n• "Bu ay durumum nasıl?"\n• "Harcamalarımı göster"\n• "Yatırım tavsiyesi"`;
                        } else {
                            return `👌 Anladım! Başka bir konuda yardımcı olabilir miyim?`;
                        }
                    }

                    return null;
                }

                /**
                 * Akıllı öneri - Son çare
                 */
                generateSmartSuggestion(originalText) {
                    const greeting = this.getGreeting();

                    // Rastgele kişilikli yanıtlar
                    const responses = [
                        `🤔 Hmm, "${originalText}" hakkında ne söyleyeceğimi bilemiyorum ${greeting}.\n\nAma şu konularda çok iyiyim:\n\n📊 **Analiz:** "Bu ay durumum nasıl?"\n💡 **Tavsiye:** "Bana tavsiye ver"\n📈 **Piyasa:** "Dolar kaç?"\n🎯 **Hedef:** "Hedefim araba almak"\n\n💬 Bunlardan birini denemek ister misin?`,

                        `🧐 İlginç bir soru! Ama ben daha çok finans konularında uzmanım ${greeting}.\n\n🎯 Mesela şunları sorabilirsin:\n• "En çok neye harcıyorum?"\n• "Aboneliklerimi göster"\n• "Yatırım tavsiyesi ver"\n\n💡 Ya da sadece "yardım" de, tüm özelliklerimi göstereyim!`,

                        `😊 Bu konuda yardımcı olamıyorum ${greeting}, ama finansal konularda süper güçlerim var!\n\n💰 Dene bakalım:\n• "Geçen ayla kıyasla?"\n• "Tasarruf önerisi"\n• "Altın ne kadar?"\n\n🤖 "Yardım" yazarak tüm komutlarımı görebilirsin!`,

                        `🤷 Hmm, bu benim uzmanlık alanım dışında ${greeting}.\n\nAma para konusunda konuşursak, çok eğleniriz! 💸\n\n💡 Öneriler:\n• "Bu ay kaç lira harcadım?"\n• "Piyasalar nasıl?"\n• "Bana şaka yap" (evet, bunu da yaparım! 😄)`
                    ];

                    return this.pick(responses);
                }

                /**
                 * Yardım menüsü - V2.0 Enhanced
                 */
                showHelp() {
                    const profile = this.memory.getProfile();
                    const interactionCount = profile.totalInteractions || 0;

                    let helpText = `🤖 **Fingo Brain V2.0 Yardım Menüsü**\n\n`;
                    helpText += `Bana şunları sorabilirsin:\n\n`;
                    helpText += `📊 **Durum Analizi**\n• "Bu ay durumum nasıl?"\n• "Genel özet"\n• "Fingo Score'um kaç?"\n\n`;
                    helpText += `📂 **Kategori Sorgulama**\n• "Market ne kadar harcadım?"\n• "Yemek giderlerim"\n\n`;
                    helpText += `💡 **Tavsiye ve Öneri**\n• "Bana tavsiye ver"\n• "Ne yapmalıyım?"\n\n`;
                    helpText += `🔄 **Abonelik Takibi**\n• "Aboneliklerimi göster"\n• "Sabit giderlerim"\n\n`;
                    helpText += `💎 **Yatırım/Tasarruf**\n• "Yatırımlarım nasıl?"\n• "Portföyüm"\n\n`;
                    helpText += `📈 **Karşılaştırma**\n• "Geçen ayla karşılaştır"\n• "Ay sonu tahminim"\n\n`;

                    // V2.0 Yeni özellikler
                    helpText += `🆕 **V2.0 Yeni Özellikler**\n`;
                    helpText += `• 🎯 "Hedefim ev almak" - Hedef takibi\n`;
                    helpText += `• 📚 "50-30-20 kuralı nedir?" - Finansal eğitim\n`;
                    helpText += `• 👤 "Profilim nasıl?" - Kişisel analiz\n`;
                    helpText += `• 🧠 "Hatırlıyor musun?" - Hafıza\n`;
                    helpText += `• 😊 "Moralim bozuk" - Duygusal destek\n`;
                    helpText += `• 😄 "Bana şaka yap" - Eğlence\n\n`;

                    // V3.0 Piyasa & Yatırım özellikleri
                    helpText += `🚀 **V3.0 Piyasa & Yatırım**\n`;
                    helpText += `• 📊 "Piyasalar nasıl?" - Anlık kurlar\n`;
                    helpText += `• 💵 "Dolar kaç?" - Döviz durumu\n`;
                    helpText += `• 🥇 "Altın ne kadar?" - Altın fiyatları\n`;
                    helpText += `• 💡 "Yatırım tavsiyesi ver" - Kişisel öneri\n`;

                    helpText += `🚀 **AI Lab Özellikleri**\n`;
                    helpText += `• 📊 "Harcamalarımı analiz et" - Gider analizi\n`;
                    helpText += `• 📈 "Portföyümü simüle et" - Enflasyon tahmini\n`;
                    helpText += `• 🔮 "3 ay sonra ne olur?" - Finansal öngörü\n`;

                    if (interactionCount > 0) {
                        helpText += `\n\n📊 _Şu ana kadar ${interactionCount} kez sohbet ettik!_`;
                    }

                    return helpText;
                }

                /**
                 * Bütçe analizi
                 */
                analyzeBudget() {
                    const transactions = this.getCurrentMonthTransactions();
                    if (transactions.length === 0) {
                        return "📋 Henüz bu ay işlem kaydın yok, bütçe analizi yapamıyorum.\n\nİlk işlemini ekledikten sonra tekrar sor!";
                    }

                    const expenses = transactions.filter(t => t.type === 'expense' && !isSavingsTransaction(t));
                    const incomes = transactions.filter(t => t.type === 'income');
                    const totalExpense = expenses.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    const totalIncome = incomes.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

                    const needs = totalIncome * 0.5;
                    const wants = totalIncome * 0.3;
                    const savings = totalIncome * 0.2;

                    return `📋 **Bütçe Analizi (50-30-20 Kuralı)**\n\n` +
                        `💰 **Gelirin:** ${this.formatCurrency(totalIncome)}\n\n` +
                        `**Önerilen Dağılım:**\n` +
                        `• 🏠 İhtiyaçlar (%50): ${this.formatCurrency(needs)}\n` +
                        `• 🎁 İstekler (%30): ${this.formatCurrency(wants)}\n` +
                        `• 💎 Tasarruf (%20): ${this.formatCurrency(savings)}\n\n` +
                        `**Mevcut Durum:**\n` +
                        `• 💸 Toplam Harcama: ${this.formatCurrency(totalExpense)}\n` +
                        `• 📊 Harcama Oranı: %${totalIncome > 0 ? ((totalExpense / totalIncome) * 100).toFixed(1) : 0}`;
                }

                /**
                 * Ay sonu tahmini
                 */
                analyzeForecast() {
                    const transactions = this.getCurrentMonthTransactions();
                    const now = new Date();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const daysPassed = now.getDate();
                    const daysRemaining = daysInMonth - daysPassed;

                    if (transactions.length === 0) {
                        return "🔮 Tahmin yapabilmem için işlem verisi gerekiyor.\n\nBirkaç işlem ekledikten sonra tekrar dene!";
                    }

                    const expenses = transactions.filter(t => t.type === 'expense' && !isSavingsTransaction(t));
                    const totalExpense = expenses.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    const dailyAvg = totalExpense / Math.max(daysPassed, 1);
                    const projectedTotal = dailyAvg * daysInMonth;
                    const projectedRemaining = dailyAvg * daysRemaining;

                    return `🔮 **Ay Sonu Tahmini**\n\n` +
                        `📅 Ayın ${daysPassed}. günü, ${daysRemaining} gün kaldı.\n\n` +
                        `**Mevcut Durum:**\n` +
                        `• 💸 Şu ana kadar: ${this.formatCurrency(totalExpense)}\n` +
                        `• 📊 Günlük ortalama: ${this.formatCurrency(dailyAvg)}\n\n` +
                        `**Tahmin:**\n` +
                        `• 🎯 Ay sonu toplam: ~${this.formatCurrency(projectedTotal)}\n` +
                        `• ⏳ Kalan günler için: ~${this.formatCurrency(projectedRemaining)}`;
                }

                /**
                 * Geçen ayla karşılaştırma
                 */
                compareMonths() {
                    const transactions = this.getTransactions();
                    const now = new Date();
                    const thisMonth = now.getMonth();
                    const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
                    const thisYear = now.getFullYear();
                    const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;

                    const thisMonthTx = transactions.filter(t => {
                        const d = new Date(t.date);
                        return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
                    });

                    const lastMonthTx = transactions.filter(t => {
                        const d = new Date(t.date);
                        return d.getMonth() === lastMonth && d.getFullYear() === lastMonthYear;
                    });

                    const thisExpense = thisMonthTx.filter(t => t.type === 'expense' && !isSavingsTransaction(t))
                        .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    const lastExpense = lastMonthTx.filter(t => t.type === 'expense' && !isSavingsTransaction(t))
                        .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

                    if (lastExpense === 0) {
                        return "📊 Geçen aya ait veri bulunamadı.\n\nKarşılaştırma için en az 2 aylık veri gerekiyor.";
                    }

                    const diff = thisExpense - lastExpense;
                    const diffPercent = ((diff / lastExpense) * 100).toFixed(1);
                    const trend = diff > 0 ? "📈 Artış" : (diff < 0 ? "📉 Azalış" : "➡️ Aynı");

                    return `📊 **Aylık Karşılaştırma**\n\n` +
                        `**Geçen Ay:** ${this.formatCurrency(lastExpense)}\n` +
                        `**Bu Ay:** ${this.formatCurrency(thisExpense)}\n\n` +
                        `**Fark:** ${diff > 0 ? '+' : ''}${this.formatCurrency(diff)} (${diff > 0 ? '+' : ''}${diffPercent}%)\n` +
                        `**Trend:** ${trend}\n\n` +
                        `${diff > 0 ? '⚠️ Bu ay geçen aya göre daha fazla harcıyorsun.' : (diff < 0 ? '✅ Harika! Bu ay daha tutumlu gidiyorsun.' : '➡️ Harcama düzenin stabil görünüyor.')}`;
                }

                /**
                 * Fingo Score göster
                 */
                showScore() {
                    const scoreEl = document.getElementById('fingo-score-val');
                    let score = scoreEl ? parseInt(scoreEl.textContent) : null;

                    if (!score || isNaN(score)) {
                        const transactions = this.getCurrentMonthTransactions();
                        if (transactions.length === 0) {
                            return "📈 Fingo Score hesaplanmadı.\n\nHenüz yeterli veri yok. İşlem eklemeye devam et!";
                        }

                        // Basit skor hesaplama
                        const expenses = transactions.filter(t => t.type === 'expense' && !isSavingsTransaction(t));
                        const incomes = transactions.filter(t => t.type === 'income');
                        const totalExpense = expenses.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                        const totalIncome = incomes.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                        const ratio = totalIncome > 0 ? totalExpense / totalIncome : 1;
                        score = Math.max(0, Math.min(1000, Math.round((1 - ratio) * 1000)));
                    }

                    let level, emoji, comment;
                    if (score >= 800) { level = "Mükemmel"; emoji = "🌟"; comment = "Finansal durumun harika!"; }
                    else if (score >= 600) { level = "İyi"; emoji = "👍"; comment = "Güzel gidiyorsun, böyle devam."; }
                    else if (score >= 400) { level = "Orta"; emoji = "⚠️"; comment = "Harcamalara dikkat etmelisin."; }
                    else { level = "Riskli"; emoji = "🚨"; comment = "Acil önlem alman gerekiyor!"; }

                    return `📈 **Fingo Score**\n\n` +
                        `${emoji} **Skorun:** ${score}/1000\n` +
                        `**Seviye:** ${level}\n\n` +
                        `${comment}`;
                }

                /**
                 * Hızlı aksiyon butonları için
                 */
                quickAction(action) {
                    const queries = {
                        'durum': 'Genel durumum nasıl?',
                        'tavsiye': 'Bana tavsiye ver',
                        'abonelik': 'Aboneliklerimi göster'
                    };

                    const input = document.getElementById('fingo-chat-input');
                    if (input && queries[action]) {
                        input.value = queries[action];
                        window.sendLocalBrainRequest();
                    }
                }

                /**
                 * Sohbeti temizle
                 */
                clearChat() {
                    const messagesContainer = document.getElementById('fingo-chat-messages');
                    if (messagesContainer) {
                        // Sadece karşılama mesajını bırak
                        const welcomeMsg = messagesContainer.querySelector('.animate-fade-in');
                        messagesContainer.innerHTML = '';
                        if (welcomeMsg) {
                            messagesContainer.appendChild(welcomeMsg.cloneNode(true));
                        }
                    }
                }

                /**
                 * Verileri Tazele (App Resume için)
                 * LocalStorage'dan en güncel veriyi çeker ve hafızayı günceller
                 */
                refreshData() {
                    console.log('[FingoBrain] Refreshing brain data...');

                    // 1. Hafızayı yeniden yükle
                    this.memory.reload();

                    // 2. İçgörüleri yeniden hesapla
                    // Not: getCurrentMonthTransactions() otomatik olarak window.transactions'a bakar
                    this.updateUserInsights();

                    console.log('[FingoBrain] Brain refreshed with latest transactions and memory.');
                }
            }

            // Global instance oluştur
            window.FingoBrain = new FingoBrain();

            // ═══════════════════════════════════════════════════════════════════════
            // GLOBAL DATA REFRESH LOGIC - Handles App Resume & Data Sync
            // ═══════════════════════════════════════════════════════════════════════

            window.refreshDashboard = function () {
                console.log('[Dashboard] Refreshing dashboard data...');

                // 1. Transaction Verisini LocalStorage'dan Yenile
                try {
                    const APP_YEAR = (typeof window.APP_YEAR !== 'undefined') ? window.APP_YEAR : new Date().getFullYear();
                    const stored = localStorage.getItem(`my_expenses_${APP_YEAR}`);

                    if (stored) {
                        const freshTransactions = JSON.parse(stored);
                        if (Array.isArray(freshTransactions)) {
                            window.transactions = freshTransactions;
                            console.log(`[Dashboard] Transactions retained from storage. Count: ${freshTransactions.length}`);
                        }
                    }
                } catch (e) {
                    console.error('[Dashboard] Error refreshing transactions:', e);
                }

                // 2. Fingo Brain Verisini Yenile
                if (window.FingoBrain && typeof window.FingoBrain.refreshData === 'function') {
                    try {
                        window.FingoBrain.refreshData();
                    } catch (e) {
                        console.warn('[Dashboard] Failed to refresh FingoBrain:', e);
                    }
                }

                // 3. UI Güncellemeleri (Varsa Dashboard Render Fonskiyonları)
                // Eğer renderDashboard fonksiyonu varsa çağır
                if (typeof window.renderDashboard === 'function') {
                    window.renderDashboard();
                }

                // Eğer updateBalanceCards fonksiyonu varsa çağır (Kartlardaki bakiyeleri güncelle)
                if (typeof window.updateBalanceCards === 'function') {
                    window.updateBalanceCards(window.transactions);
                }
            };

            /**
             * Kullanıcı mesajını ekrana ekle
             */
            function addUserMessage(text) {
                const container = document.getElementById('fingo-chat-messages');
                if (!container) return;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                const savedAvatar = localStorage.getItem('user_avatar');
                const avatarContent = savedAvatar
                    ? `<img src="${savedAvatar}" class="w-full h-full object-cover rounded-xl" alt="User">`
                    : '😊';

                const msgHTML = `
                <div class="flex gap-3 justify-end animate-fade-in">
                    <div class="max-w-[85%]">
                        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl rounded-tr-md p-4 shadow-lg">
                            <p class="text-sm text-white leading-relaxed">${escapeHtml(text)}</p>
                        </div>
                        <span class="text-[10px] text-gray-400 mr-2 mt-1 block text-right">Sen • ${timeStr}</span>
                    </div>
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-gray-200 to-gray-300 dark:from-gray-600 dark:to-gray-700 flex items-center justify-center text-sm shrink-0 p-0 overflow-hidden border border-white/10">
                        ${avatarContent}
                    </div>
                </div>
            `;

                container.insertAdjacentHTML('beforeend', msgHTML);
                container.scrollTop = container.scrollHeight;
            }

            /**
             * Bot mesajını ekrana ekle
             */
            function addBotMessage(text) {
                const container = document.getElementById('fingo-chat-messages');
                if (!container) return;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                // Markdown-like formatting
                let formattedText = text
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\[(.+?)\]\(action:(.+?)\)/g, (match, label, action) => {
                        let onclick = '';
                        switch (action) {
                            case 'open_expense_modal': onclick = 'window.ExpenseAnalyzer.openModal()'; break;
                            case 'open_portfolio_modal': onclick = 'window.PortfolioSimulator.openModal()'; break;
                            case 'open_forecast_modal': onclick = 'window.FinancialForecast.openModal()'; break;
                        }
                        return `<button onclick="${onclick}" class="mt-2 block w-full py-2 px-3 bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-600 dark:text-indigo-400 font-bold rounded-xl border border-indigo-500/30 transition-all text-center text-xs">✨ ${label}</button>`;
                    })
                    .replace(/\n/g, '<br>');

                const msgHTML = `
                <div class="flex gap-3 animate-fade-in">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-sm shrink-0 shadow-lg">
                        🧠
                    </div>
                    <div class="flex-1 max-w-[85%]">
                        <div class="bg-gradient-to-br from-indigo-500/10 to-purple-500/10 dark:from-indigo-500/20 dark:to-purple-500/20 rounded-2xl rounded-tl-md p-4 border border-indigo-500/20">
                            <p class="text-sm text-gray-800 dark:text-white leading-relaxed">${formattedText}</p>
                        </div>
                        <span class="text-[10px] text-gray-400 ml-2 mt-1 block">Fingo Brain • ${timeStr}</span>
                    </div>
                </div>
            `;

                container.insertAdjacentHTML('beforeend', msgHTML);
                container.scrollTop = container.scrollHeight;
            }

            /**
             * HTML escape helper
             */
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * Ana mesaj gönderme fonksiyonu
             */
            window.sendLocalBrainRequest = function (customText) {
                const input = document.getElementById('fingo-chat-input');
                const typingIndicator = document.getElementById('fingo-typing-indicator');

                const userText = customText || (input ? input.value.trim() : '');

                if (!userText) return;

                // Input'u temizle
                if (input) input.value = '';

                // Kullanıcı mesajını ekle
                addUserMessage(userText);

                // Typing indicator göster
                if (typingIndicator) {
                    typingIndicator.classList.remove('hidden');
                    const container = document.getElementById('fingo-chat-messages');
                    if (container) container.scrollTop = container.scrollHeight;
                }

                // 1-2 saniye bekle ve cevap ver (simülasyon)
                const delay = 1000 + Math.random() * 1000;

                setTimeout(() => {
                    // Typing indicator gizle
                    if (typingIndicator) typingIndicator.classList.add('hidden');

                    // Bot cevabını al ve ekle
                    const response = window.FingoBrain.processMessage(userText);
                    addBotMessage(response);
                }, delay);
            };

            // ═══════════════════════════════════════════════════════════════════════
            // FINGOBRAIN ASSISTANT ENHANCEMENT FUNCTIONS
            // ═══════════════════════════════════════════════════════════════════════

            // ─────────────────────────────────────────────────────
            // 1. CONVERSATION MODE SYSTEM
            // ─────────────────────────────────────────────────────
            window.__fingoMode = localStorage.getItem('fingo_mode') || 'friend';

            window.setFingoMode = function (mode) {
                const modes = ['friend', 'analyst', 'coach', 'teacher'];
                if (!modes.includes(mode)) return;

                window.__fingoMode = mode;
                localStorage.setItem('fingo_mode', mode);

                // Update UI
                modes.forEach(m => {
                    const btn = document.getElementById(`fb-mode-${m}`);
                    if (btn) {
                        btn.classList.toggle('active', m === mode);
                    }
                });

                // Show toast
                const modeNames = {
                    friend: '😊 Arkadaş modu aktif',
                    analyst: '📊 Analist modu aktif',
                    coach: '🎯 Koç modu aktif',
                    teacher: '📚 Öğretmen modu aktif'
                };
                if (window.toastSuccess) window.toastSuccess(modeNames[mode]);
            };

            // Initialize mode on load
            setTimeout(() => {
                const currentMode = window.__fingoMode || 'friend';
                const btn = document.getElementById(`fb-mode-${currentMode}`);
                if (btn) btn.classList.add('active');
            }, 100);

            // ─────────────────────────────────────────────────────
            // 2. MINI FINANCE STATS UPDATE
            // ─────────────────────────────────────────────────────
            window.updateFbMiniStats = function () {
                const transactions = window.transactions || [];
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                let income = 0, expense = 0;
                let prevIncome = 0, prevExpense = 0;

                transactions.forEach(t => {
                    const d = new Date(t.date);
                    const amt = parseFloat(t.amount) || 0;

                    if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                        if (t.type === 'income') income += amt;
                        else if (t.type === 'expense') expense += amt;
                    } else if (d.getMonth() === currentMonth - 1 || (currentMonth === 0 && d.getMonth() === 11 && d.getFullYear() === currentYear - 1)) {
                        if (t.type === 'income') prevIncome += amt;
                        else if (t.type === 'expense') prevExpense += amt;
                    }
                });

                const net = income - expense;
                const prevNet = prevIncome - prevExpense;

                const fmt = (n) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(n);
                const trend = (curr, prev) => {
                    if (prev === 0) return '—';
                    const pct = ((curr - prev) / prev * 100).toFixed(0);
                    const sign = pct >= 0 ? '+' : '';
                    const arrow = pct >= 0 ? '↑' : '↓';
                    return `${sign}${pct}% ${arrow}`;
                };

                // Update DOM
                const elIncome = document.getElementById('fb-stat-income');
                const elExpense = document.getElementById('fb-stat-expense');
                const elNet = document.getElementById('fb-stat-net');
                const elIncomeTrend = document.getElementById('fb-stat-income-trend');
                const elExpenseTrend = document.getElementById('fb-stat-expense-trend');
                const elNetTrend = document.getElementById('fb-stat-net-trend');

                if (elIncome) elIncome.textContent = fmt(income);
                if (elExpense) elExpense.textContent = fmt(expense);
                if (elNet) elNet.textContent = fmt(net);
                if (elIncomeTrend) elIncomeTrend.textContent = trend(income, prevIncome);
                if (elExpenseTrend) elExpenseTrend.textContent = trend(expense, prevExpense);
                if (elNetTrend) elNetTrend.textContent = trend(net, prevNet);
            };

            // ─────────────────────────────────────────────────────
            // 3. SMART CONTEXT CARDS
            // ─────────────────────────────────────────────────────
            window.refreshContextCards = function () {
                const grid = document.getElementById('fb-context-grid');
                const titleEl = document.getElementById('fb-context-title');
                if (!grid) return;

                const hour = new Date().getHours();
                const day = new Date().getDay();
                const dayOfMonth = new Date().getDate();
                const lastDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();

                let suggestions = [];

                // Time-based suggestions
                if (hour >= 5 && hour < 12) {
                    titleEl.textContent = '☀️ Günaydın! Bugün sor';
                    suggestions.push({ emoji: '📊', text: 'Dün ne harcadım?', query: 'Dün ne harcadım?' });
                    suggestions.push({ emoji: '☕', text: 'Bugünkü bütçem?', query: 'Bugün ne kadar harcayabilirim?' });
                } else if (hour >= 12 && hour < 18) {
                    titleEl.textContent = '🌤️ İyi günler! Şimdi sor';
                    suggestions.push({ emoji: '🍽️', text: 'Öğle yemeği harcamam?', query: 'Bu ay yemek kategorisinde ne harcadım?' });
                    suggestions.push({ emoji: '📈', text: 'Haftalık özet', query: 'Bu hafta finansal durumum nasıl?' });
                } else if (hour >= 18 && hour < 22) {
                    titleEl.textContent = '🌙 İyi akşamlar! Şimdi sor';
                    suggestions.push({ emoji: '🛒', text: 'Market harcamam?', query: 'Bu ay market harcamam ne kadar?' });
                    suggestions.push({ emoji: '💡', text: 'Tasarruf tavsiyesi', query: 'Tavsiye ver' });
                } else {
                    titleEl.textContent = '✨ Gece geç! Şimdi sor';
                    suggestions.push({ emoji: '📊', text: 'Aylık özet', query: 'Bu ay durumum nasıl?' });
                    suggestions.push({ emoji: '🎯', text: 'Hedeflerim', query: 'Hedeflerim nasıl gidiyor?' });
                }

                // End of month special
                if (dayOfMonth >= lastDayOfMonth - 3) {
                    suggestions.push({ emoji: '📅', text: 'Ay sonu analizi', query: 'Ay sonu geldi, durumum ne?' });
                }

                // Weekend special
                if (day === 0 || day === 6) {
                    suggestions.push({ emoji: '🎉', text: 'Hafta sonu harcamam?', query: 'Hafta sonu ne kadar harcıyorum?' });
                }

                // Always include these
                suggestions.push({ emoji: '🔮', text: 'Geleceği tahmin et', query: 'Ay sonu tahminim nedir?' });
                suggestions.push({ emoji: '📚', text: 'Finansal bilgi öğren', query: 'Bana finansal bir kavram öğret' });

                // Limit to 4 cards
                suggestions = suggestions.slice(0, 4);

                // Render cards
                grid.innerHTML = suggestions.map(s => `
                <button onclick="window.sendLocalBrainRequest('${s.query}')" class="fb-context-card group">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${s.emoji}</span>
                        <span class="text-[11px] font-medium text-gray-700 dark:text-gray-300 line-clamp-1">${s.text}</span>
                    </div>
                </button>
            `).join('');
            };

            // ─────────────────────────────────────────────────────
            // 4. PROACTIVE AI TIPS
            // ─────────────────────────────────────────────────────
            window.__proactiveTipQuery = '';

            window.showProactiveTip = function (message, query) {
                const tipEl = document.getElementById('fb-proactive-tip');
                const textEl = document.getElementById('fb-proactive-text');
                if (!tipEl || !textEl) return;

                textEl.textContent = message;
                window.__proactiveTipQuery = query || message;
                tipEl.classList.remove('hidden');
            };

            window.dismissProactiveTip = function () {
                const tipEl = document.getElementById('fb-proactive-tip');
                if (tipEl) tipEl.classList.add('hidden');
            };

            window.acceptProactiveTip = function () {
                if (window.__proactiveTipQuery) {
                    window.sendLocalBrainRequest(window.__proactiveTipQuery);
                }
                window.dismissProactiveTip();
            };

            window.generateProactiveTip = function () {
                const transactions = window.transactions || [];
                const now = new Date();
                const today = now.toISOString().slice(0, 10);
                const yesterday = new Date(now - 86400000).toISOString().slice(0, 10);

                // Check yesterday's spending
                let yesterdayTotal = 0;
                let avgDailySpend = 0;
                let daysWithSpending = {};

                transactions.forEach(t => {
                    if (t.type !== 'expense') return;
                    const d = t.date.slice(0, 10);
                    const amt = parseFloat(t.amount) || 0;

                    if (d === yesterday) yesterdayTotal += amt;
                    daysWithSpending[d] = (daysWithSpending[d] || 0) + amt;
                });

                const dailyValues = Object.values(daysWithSpending);
                if (dailyValues.length > 0) {
                    avgDailySpend = dailyValues.reduce((a, b) => a + b, 0) / dailyValues.length;
                }

                // Show tip if yesterday was above average
                if (yesterdayTotal > avgDailySpend * 1.5 && yesterdayTotal > 0) {
                    const fmt = (n) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(n);
                    window.showProactiveTip(
                        `Dün ${fmt(yesterdayTotal)} harcadın - ortalamanın %${((yesterdayTotal / avgDailySpend - 1) * 100).toFixed(0)} üstünde!`,
                        'Dün nereye harcadım?'
                    );
                }
            };

            // ─────────────────────────────────────────────────────
            // 5. DAILY CHALLENGE SYSTEM
            // ─────────────────────────────────────────────────────
            const DAILY_CHALLENGES = [
                { id: 'no-food-out', title: 'Dışarıda yemek yeme!', xp: 50, check: (t) => !['restoran', 'cafe', 'yemek'].some(k => (t.category || '').toLowerCase().includes(k)) },
                { id: 'under-100', title: 'Günlük 100₺ altında kal', xp: 30, maxSpend: 100 },
                { id: 'no-shopping', title: 'Alışveriş yapma', xp: 40, check: (t) => !['alışveriş', 'giyim', 'market'].some(k => (t.category || '').toLowerCase().includes(k)) },
                { id: 'save-something', title: 'Bugün birikim yap', xp: 60, needsSaving: true },
                { id: 'track-all', title: 'Tüm harcamaları kaydet', xp: 25, minTransactions: 3 }
            ];

            window.initDailyChallenge = function () {
                const today = new Date().toISOString().slice(0, 10);
                const stored = localStorage.getItem('fb_daily_challenge');
                let challengeData = stored ? JSON.parse(stored) : null;

                // New day = new challenge
                if (!challengeData || challengeData.date !== today) {
                    const randomChallenge = DAILY_CHALLENGES[Math.floor(Math.random() * DAILY_CHALLENGES.length)];
                    challengeData = {
                        date: today,
                        challenge: randomChallenge,
                        completed: false,
                        progress: 0
                    };
                    localStorage.setItem('fb_daily_challenge', JSON.stringify(challengeData));
                }

                // Update UI
                const container = document.getElementById('fb-daily-challenge');
                const titleEl = document.getElementById('fb-challenge-title');
                const xpEl = document.getElementById('fb-challenge-xp');
                const progressEl = document.getElementById('fb-challenge-progress');
                const statusEl = document.getElementById('fb-challenge-status');

                if (container) container.classList.remove('hidden');
                if (titleEl) titleEl.textContent = challengeData.challenge.title;
                if (xpEl) xpEl.textContent = `+${challengeData.challenge.xp} XP`;
                if (progressEl) progressEl.style.width = `${challengeData.progress}%`;
                if (statusEl) {
                    if (challengeData.completed) {
                        statusEl.textContent = '✅ Tamamlandı!';
                        statusEl.className = 'text-[10px] text-emerald-600 dark:text-emerald-400 font-bold';
                    } else {
                        statusEl.textContent = `%${challengeData.progress} ilerleme`;
                    }
                }
            };

            window.checkChallengeProgress = function () {
                const stored = localStorage.getItem('fb_daily_challenge');
                if (!stored) return;

                const challengeData = JSON.parse(stored);
                const today = new Date().toISOString().slice(0, 10);
                const transactions = (window.transactions || []).filter(t => t.date && t.date.startsWith(today));

                let progress = 0;
                const challenge = challengeData.challenge;

                if (challenge.maxSpend) {
                    const spent = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
                    progress = Math.min(100, Math.max(0, 100 - (spent / challenge.maxSpend * 100)));
                } else if (challenge.minTransactions) {
                    progress = Math.min(100, (transactions.length / challenge.minTransactions) * 100);
                } else if (challenge.needsSaving) {
                    const hasSaving = transactions.some(t => ['birikim', 'tasarruf', 'yatırım'].some(k => (t.category || '').toLowerCase().includes(k)));
                    progress = hasSaving ? 100 : 0;
                } else if (challenge.check) {
                    const violations = transactions.filter(t => t.type === 'expense' && !challenge.check(t));
                    progress = violations.length === 0 ? 100 : Math.max(0, 100 - violations.length * 25);
                }

                challengeData.progress = Math.round(progress);
                challengeData.completed = progress >= 100;

                localStorage.setItem('fb_daily_challenge', JSON.stringify(challengeData));

                // Update XP if completed
                if (challengeData.completed) {
                    let totalXp = parseInt(localStorage.getItem('fb_total_xp') || '0');
                    const lastXpDate = localStorage.getItem('fb_last_xp_date');

                    if (lastXpDate !== today) {
                        totalXp += challenge.xp;
                        localStorage.setItem('fb_total_xp', totalXp.toString());
                        localStorage.setItem('fb_last_xp_date', today);
                        if (window.toastSuccess) window.toastSuccess(`🎉 Challenge tamamlandı! +${challenge.xp} XP kazandın!`);
                    }
                }

                window.initDailyChallenge();
            };

            // ─────────────────────────────────────────────────────
            // 6. VOICE ASSISTANT (Web Speech API)
            // ─────────────────────────────────────────────────────
            window.startVoiceInput = function () {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    if (window.toastError) window.toastError('Tarayıcınız ses tanımayı desteklemiyor');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();

                recognition.lang = 'tr-TR';
                recognition.continuous = false;
                recognition.interimResults = true;

                const micBtn = document.querySelector('[onclick*="toastInfo"][title*="Sesli"]');
                if (micBtn) {
                    micBtn.innerHTML = `
                    <div class="relative">
                        <svg class="w-5 h-5 text-red-500 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                        <span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-ping"></span>
                    </div>
                `;
                }

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');

                    const input = document.getElementById('fingo-chat-input');
                    if (input) input.value = transcript;
                };

                recognition.onend = () => {
                    if (micBtn) {
                        micBtn.innerHTML = `
                        <svg class="w-5 h-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    `;
                    }

                    const input = document.getElementById('fingo-chat-input');
                    if (input && input.value.trim()) {
                        window.sendLocalBrainRequest();
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (window.toastError) window.toastError('Ses tanıma hatası: ' + event.error);
                };

                recognition.start();
            };

            // ─────────────────────────────────────────────────────
            // 7. INITIALIZE ALL ENHANCEMENTS
            // ─────────────────────────────────────────────────────
            window.initFingoBrainEnhancements = function () {
                // Update mini stats
                window.updateFbMiniStats();

                // Generate context cards
                window.refreshContextCards();

                // Initialize daily challenge
                window.initDailyChallenge();

                // Generate proactive tip (with delay)
                setTimeout(() => {
                    window.generateProactiveTip();
                }, 2000);

                // Set initial mode
                const currentMode = window.__fingoMode || 'friend';
                const btn = document.getElementById(`fb-mode-${currentMode}`);
                if (btn) btn.classList.add('active');
            };

            // Initialize on page load if already on wallet tab
            setTimeout(() => {
                const walletTab = document.getElementById('screen-wallet');
                if (walletTab && !walletTab.classList.contains('hidden')) {
                    window.initFingoBrainEnhancements();
                }
            }, 500);

            // ═══════════════════════════════════════════════════════════════════════

            // === PREMIUM MINI-BADGE SYSTEM ===
            // data-premium-badge="PRO" attribute olan elemanları tarar ve 
            // premium olmayan kullanıcılar için otomatik PRO badge ekler
            window.refreshPremiumMiniBadges = function () {
                const isPro = localStorage.getItem('user_status') === 'pro';
                const badgeElements = document.querySelectorAll('[data-premium-badge]');

                badgeElements.forEach(el => {
                    // Mevcut auto-badge varsa kaldır (duplicate önleme)
                    const existingBadge = el.querySelector('.mini-badge--pro-auto');
                    if (existingBadge) existingBadge.remove();

                    // Premium değilse badge ekle
                    if (!isPro) {
                        const badgeType = el.getAttribute('data-premium-badge');
                        if (badgeType === 'PRO') {
                            const badge = document.createElement('span');
                            badge.className = 'mini-badge mini-badge--pro mini-badge--pro-auto';
                            badge.innerHTML = '👑 PRO';
                            // Parent'ı relative yap (zaten değilse)
                            const computedStyle = window.getComputedStyle(el);
                            if (computedStyle.position === 'static') {
                                el.style.position = 'relative';
                            }
                            el.appendChild(badge);
                        }
                    }
                });
            };

            // Sayfa yüklendiğinde mini-badge'leri uygula
            setTimeout(window.refreshPremiumMiniBadges, 200);

            // ═══════════════════════════════════════════════════════════════


        </script>
        <!-- Micro Feedback Root -->
        <div id="micro-feedback-root"></div>

        <script>
            // ═══════════════════════════════════════════════════════════════
            // MICRO FEEDBACK POSITIONING FIX
            // ═══════════════════════════════════════════════════════════════
            (function () {
                function updateMicroFeedbackBottomOffset() {
                    const nav = document.querySelector('.fixed.bottom-6') ||
                        document.getElementById('main-nav') ||
                        document.querySelector('[data-bottom-nav="true"]');

                    const docStyle = getComputedStyle(document.documentElement);
                    const safeAreaBottom = parseInt(docStyle.getPropertyValue('--safe-area-bottom')) || 0;
                    let bottomPx = safeAreaBottom + 100;

                    if (nav) {
                        const navRect = nav.getBoundingClientRect();
                        if (navRect.height > 0 && navRect.top > 0) {
                            const distance = window.innerHeight - navRect.top;
                            bottomPx = distance + 16;
                        }
                    }
                    document.documentElement.style.setProperty('--micro-feedback-bottom', `${bottomPx}px`);
                }

                window.addEventListener('resize', updateMicroFeedbackBottomOffset);
                window.addEventListener('orientationchange', updateMicroFeedbackBottomOffset);
                if (window.visualViewport) window.visualViewport.addEventListener('resize', updateMicroFeedbackBottomOffset);

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', updateMicroFeedbackBottomOffset);
                } else {
                    updateMicroFeedbackBottomOffset();
                }
                setInterval(updateMicroFeedbackBottomOffset, 1000);
                window.updateMicroFeedbackPosition = updateMicroFeedbackBottomOffset;
            })();
        </script>

        <!-- ═══════════════════════════════════════════════════════════════════════════════════ -->
        <!-- PREMIUM WELCOME TOUR - HTML Overlay                                                 -->
        <!-- ═══════════════════════════════════════════════════════════════════════════════════ -->
        <div id="premium-welcome-tour" aria-hidden="true">
            <div class="pwt-backdrop"></div>
            <div class="pwt-card">
                <button class="pwt-close" onclick="window.PWT.close()" aria-label="Kapat">✕</button>
                <div class="pwt-badge">👑 Premium Aktif</div>

                <!-- Hero -->
                <div class="pwt-hero">
                    <div class="pwt-particles">
                        <div class="pwt-particle"></div>
                        <div class="pwt-particle"></div>
                        <div class="pwt-particle"></div>
                        <div class="pwt-particle"></div>
                    </div>
                    <div class="pwt-hero-icon" id="pwt-hero-icon">👑</div>
                </div>

                <!-- Content -->
                <h2 class="pwt-title" id="pwt-title">Premium aktif 🎉</h2>
                <p class="pwt-desc" id="pwt-desc">Fingenda artık tam gücünde.</p>

                <!-- Bullets -->
                <div class="pwt-bullets" id="pwt-bullets">
                    <span class="pwt-bullet">✓ Limitsiz kayıt</span>
                    <span class="pwt-bullet">✓ Pro analiz</span>
                    <span class="pwt-bullet">✓ Özel rozetler</span>
                </div>

                <!-- Progress + CTA -->
                <div class="pwt-dots" id="pwt-dots"></div>
                <button class="pwt-cta" id="pwt-cta" onclick="window.PWT.next()">Devam Et</button>
            </div>
        </div>

        <script>
            // ═══════════════════════════════════════════════════════════════════════════════════
            // PREMIUM WELCOME TOUR - JavaScript Engine
            // ═══════════════════════════════════════════════════════════════════════════════════
            (function () {
                const PWT_SEEN_KEY = 'pwt_seen_v1';
                const PWT_PENDING_KEY = 'pwt_pending_v1';

                // Slide data
                const premiumTourSlides = [
                    {
                        icon: '👑',
                        title: 'Premium aktif 🎉',
                        desc: 'Fingenda artık tam gücünde.',
                        bullets: ['Limitsiz kayıt', 'Pro analiz', 'Özel rozetler'],
                        cta: 'Devam Et'
                    },
                    {
                        icon: '🧠',
                        title: 'FingoBrain Pro',
                        desc: 'Daha akıllı, daha doğru öneriler.',
                        bullets: ['Kategori algılama', 'Akıllı bütçe önerisi', 'Saçma öneri yok'],
                        cta: 'Devam Et'
                    },
                    {
                        icon: '📸',
                        title: 'OCR + Sesle Ekle',
                        desc: 'Fişi okut. Sesle ekle. Anında kaydet.',
                        bullets: ['Hızlı giriş', 'Daha az dokunuş', 'Daha az hata'],
                        cta: 'Devam Et'
                    },
                    {
                        icon: '📈',
                        title: 'Piyasa Pro',
                        desc: 'Canlı piyasa + trendler.',
                        bullets: ['Günlük değişim', 'Akıllı uyarılar', 'Rapor PDF'],
                        cta: 'Başla!'
                    }
                ];

                let currentSlide = 0;

                // Helper: Check if seen
                async function pwtHasSeen() {
                    try {
                        const val = await AppStorage.get(PWT_SEEN_KEY);
                        return val === '1' || val === 'true';
                    } catch (e) {
                        return localStorage.getItem(PWT_SEEN_KEY) === '1';
                    }
                }

                // Helper: Mark as seen
                async function pwtMarkSeen() {
                    try {
                        await AppStorage.set(PWT_SEEN_KEY, '1');
                        await AppStorage.remove(PWT_PENDING_KEY);
                    } catch (e) {
                        localStorage.setItem(PWT_SEEN_KEY, '1');
                        localStorage.removeItem(PWT_PENDING_KEY);
                    }
                }

                // Render current slide
                function pwtRender() {
                    const slide = premiumTourSlides[currentSlide];
                    if (!slide) return;

                    const iconEl = document.getElementById('pwt-hero-icon');
                    const titleEl = document.getElementById('pwt-title');
                    const descEl = document.getElementById('pwt-desc');
                    const bulletsEl = document.getElementById('pwt-bullets');
                    const dotsEl = document.getElementById('pwt-dots');
                    const ctaEl = document.getElementById('pwt-cta');

                    if (iconEl) iconEl.textContent = slide.icon;
                    if (titleEl) titleEl.textContent = slide.title;
                    if (descEl) descEl.textContent = slide.desc;

                    if (bulletsEl) {
                        bulletsEl.innerHTML = slide.bullets.map(b =>
                            `<span class="pwt-bullet">✓ ${b}</span>`
                        ).join('');
                    }

                    if (dotsEl) {
                        dotsEl.innerHTML = premiumTourSlides.map((_, i) =>
                            `<div class="pwt-dot ${i === currentSlide ? 'active' : ''}"></div>`
                        ).join('');
                    }

                    if (ctaEl) ctaEl.textContent = slide.cta;
                }

                // Confetti burst
                function pwtConfettiBurst() {
                    try {
                        if (typeof confetti === 'function') {
                            confetti({
                                particleCount: 120,
                                spread: 90,
                                origin: { y: 0.5 },
                                colors: ['#FFD700', '#FFA500', '#ffffff', '#6366F1', '#A855F7']
                            });
                        }
                    } catch (e) {
                        console.warn('PWT confetti error:', e);
                    }
                }

                // Check if onboarding is visible
                function isOnboardingVisible() {
                    const onb = document.getElementById('onboarding-sheet');
                    if (onb && onb.classList.contains('hidden') === false && onb.offsetParent !== null) {
                        return true;
                    }
                    return false;
                }

                // Open tour
                function pwtOpen(startIndex = 0) {
                    const overlay = document.getElementById('premium-welcome-tour');
                    if (!overlay) return;

                    // Check onboarding collision
                    if (isOnboardingVisible()) {
                        setTimeout(() => window.PWT.maybeShow(), 800);
                        return;
                    }

                    currentSlide = startIndex;
                    pwtRender();

                    // Lock body scroll
                    document.body.style.overflow = 'hidden';

                    // Show overlay with animation delay
                    requestAnimationFrame(() => {
                        overlay.classList.add('pwt-open');
                        overlay.setAttribute('aria-hidden', 'false');

                        // Confetti on first slide
                        if (currentSlide === 0) {
                            setTimeout(pwtConfettiBurst, 400);
                        }

                        // Haptics (if available)
                        try {
                            if (window.Capacitor?.Plugins?.Haptics) {
                                window.Capacitor.Plugins.Haptics.impact({ style: 'medium' });
                            }
                        } catch (e) { }
                    });
                }

                // Close tour
                function pwtClose() {
                    const overlay = document.getElementById('premium-welcome-tour');
                    if (!overlay) return;

                    overlay.classList.remove('pwt-open');
                    overlay.setAttribute('aria-hidden', 'true');
                    document.body.style.overflow = '';

                    // Mark as seen
                    pwtMarkSeen();
                }

                // Next slide
                function pwtNext() {
                    if (currentSlide < premiumTourSlides.length - 1) {
                        currentSlide++;
                        pwtRender();

                        // Re-trigger animation on hero
                        const icon = document.getElementById('pwt-hero-icon');
                        if (icon) {
                            icon.style.animation = 'none';
                            icon.offsetHeight; // Force reflow
                            icon.style.animation = '';
                        }
                    } else {
                        pwtClose();
                    }
                }

                // Previous slide
                function pwtPrev() {
                    if (currentSlide > 0) {
                        currentSlide--;
                        pwtRender();
                    }
                }

                // Maybe show (called after purchase or on init)
                async function pwtMaybeShow() {
                    try {
                        // Check if already seen
                        const seen = await pwtHasSeen();
                        if (seen) return;

                        // Check if premium is active
                        const isPremium = window.PremiumManager?.isPremium ||
                            (await AppStorage.get('premium')) === 'true' ||
                            localStorage.getItem('premium') === 'true';

                        if (!isPremium) return;

                        // Check onboarding collision
                        if (isOnboardingVisible()) {
                            setTimeout(pwtMaybeShow, 800);
                            return;
                        }

                        // Open the tour
                        pwtOpen(0);
                    } catch (e) {
                        console.warn('PWT maybeShow error:', e);
                    }
                }

                // Expose to window
                window.PWT = {
                    open: pwtOpen,
                    close: pwtClose,
                    next: pwtNext,
                    prev: pwtPrev,
                    maybeShow: pwtMaybeShow,
                    markSeen: pwtMarkSeen
                };

                // Auto-check on load (for returning premium users)
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        setTimeout(pwtMaybeShow, 1500);
                    });
                } else {
                    setTimeout(pwtMaybeShow, 1500);
                }
            })();
        </script>

        <!-- PERFORMANCE: Visibility Handler + Lazy Loaders -->
        <script>
            // Görünmüyorken animasyonları durdur (bedava performans + pil tasarrufu)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    document.documentElement.classList.add('paused');
                } else {
                    document.documentElement.classList.remove('paused');
                }
            });

            // Lazy script loader (ihtiyaç olunca yükle)
            window.__loadScriptOnce = (src) => new Promise((resolve, reject) => {
                const existing = document.querySelector(`script[data-src="${src}"]`);
                if (existing) return resolve();
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.dataset.src = src;
                s.onload = () => resolve();
                s.onerror = reject;
                document.head.appendChild(s);
            });

            window.ensureCharts = async () => {
                if (typeof Chart !== 'undefined') return; // Zaten yüklü
                await window.__loadScriptOnce("https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js");
                await window.__loadScriptOnce("https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0");
            };

            window.ensurePDF = async () => {
                if (window.jspdf) return; // Zaten yüklü
                await window.__loadScriptOnce("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
                await window.__loadScriptOnce("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js");
            };

            window.ensureConfetti = async () => {
                if (typeof confetti !== 'undefined') return; // Zaten yüklü
                await window.__loadScriptOnce("https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js");
            };

            /* === APPLE AWARD LIQUID GLASS 3D TILT ENGINE === */
            (function initPWTiltEngine() {
                'use strict';

                // Performans kontrolü
                const html = document.documentElement;
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                const isPerfMode = html.classList.contains('perf');

                if (prefersReducedMotion || isPerfMode || ('ontouchstart' in window) || navigator.maxTouchPoints > 0) {
                    console.log('[PW Tilt] Disabled: reduced motion, perf mode, or touch device');
                    return;
                }

                // Tilt widget'larını bul
                const widgets = document.querySelectorAll('.pw-widget.pw-tilt[data-pw-tilt="1"]');
                if (!widgets.length) return;

                let rafId = null;
                let lastFrameTime = 0;
                const FRAME_BUDGET = 16; // ~60fps

                widgets.forEach(widget => {
                    let isHovering = false;
                    let targetRx = 0, targetRy = 0;
                    let currentRx = 0, currentRy = 0;
                    let targetMx = 50, targetMy = 50;
                    let currentMx = 50, currentMy = 50;

                    // Animate loop
                    function animate(timestamp) {
                        if (!isHovering) {
                            rafId = null;
                            return;
                        }

                        if (timestamp - lastFrameTime < FRAME_BUDGET) {
                            rafId = requestAnimationFrame(animate);
                            return;
                        }
                        lastFrameTime = timestamp;

                        // Smooth lerp
                        const ease = 0.12;
                        currentRx += (targetRx - currentRx) * ease;
                        currentRy += (targetRy - currentRy) * ease;
                        currentMx += (targetMx - currentMx) * ease;
                        currentMy += (targetMy - currentMy) * ease;

                        widget.style.setProperty('--rx', currentRx.toFixed(2) + 'deg');
                        widget.style.setProperty('--ry', currentRy.toFixed(2) + 'deg');
                        widget.style.setProperty('--mx', currentMx.toFixed(1) + '%');
                        widget.style.setProperty('--my', currentMy.toFixed(1) + '%');

                        rafId = requestAnimationFrame(animate);
                    }

                    // Pointer move handler
                    function handleMove(e) {
                        const rect = widget.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;

                        // Tilt hesapla (max ±8 derece)
                        const maxTilt = 8;
                        targetRx = ((y - centerY) / centerY) * -maxTilt;
                        targetRy = ((x - centerX) / centerX) * maxTilt;

                        // Sheen pozisyonu
                        targetMx = (x / rect.width) * 100;
                        targetMy = (y / rect.height) * 100;
                    }

                    // Enter
                    widget.addEventListener('pointerenter', (e) => {
                        isHovering = true;
                        handleMove(e);
                        if (!rafId) rafId = requestAnimationFrame(animate);
                    }, { passive: true });

                    // Move
                    widget.addEventListener('pointermove', handleMove, { passive: true });

                    // Leave - reset
                    widget.addEventListener('pointerleave', () => {
                        isHovering = false;
                        targetRx = 0;
                        targetRy = 0;
                        targetMx = 50;
                        targetMy = 50;

                        // Smooth reset animation
                        function resetAnim() {
                            const ease = 0.08;
                            currentRx += (0 - currentRx) * ease;
                            currentRy += (0 - currentRy) * ease;
                            currentMx += (50 - currentMx) * ease;
                            currentMy += (50 - currentMy) * ease;

                            widget.style.setProperty('--rx', currentRx.toFixed(2) + 'deg');
                            widget.style.setProperty('--ry', currentRy.toFixed(2) + 'deg');
                            widget.style.setProperty('--mx', currentMx.toFixed(1) + '%');
                            widget.style.setProperty('--my', currentMy.toFixed(1) + '%');

                            if (Math.abs(currentRx) > 0.1 || Math.abs(currentRy) > 0.1) {
                                requestAnimationFrame(resetAnim);
                            } else {
                                widget.style.setProperty('--rx', '0deg');
                                widget.style.setProperty('--ry', '0deg');
                                widget.style.setProperty('--mx', '50%');
                                widget.style.setProperty('--my', '50%');
                            }
                        }
                        requestAnimationFrame(resetAnim);
                    }, { passive: true });

                    // Press effect
                    widget.addEventListener('pointerdown', () => {
                        widget.classList.add('is-pressed');
                    }, { passive: true });

                    widget.addEventListener('pointerup', () => {
                        widget.classList.remove('is-pressed');
                    }, { passive: true });

                    widget.addEventListener('pointercancel', () => {
                        widget.classList.remove('is-pressed');
                    }, { passive: true });
                });

                console.log('[PW Tilt] Initialized for', widgets.length, 'widgets');
            })();
        </script>

        <!-- PRO BADGE PERSISTENCE & BUY HANDLER -->
        <script>
            // === PRO ÜYELİK KONTROL VE HEADER DÜZELTME ===
            document.addEventListener("DOMContentLoaded", () => {
                // 1. Hafızadan durumu çek (localStorage + Global Variable fallback)
                // 'user_membership_status' yerine mevcut sistemdeki 'user_status' kullanılır
                const savedStatus = localStorage.getItem('user_status') || window.userStatus;
                const badge = document.getElementById('user-plan-badge');

                // 2. Eğer kullanıcı PRO ise
                if (savedStatus === 'pro') {
                    // Global değişkeni güncelle
                    if (typeof isPremium !== 'undefined') isPremium = true;
                    if (typeof window.userStatus !== 'undefined') window.userStatus = 'pro';

                    // 3. Header Rozetini Görsel Olarak Güncelle
                    if (badge) {
                        // İçeriği Değiştir (İkonlu)
                        badge.innerHTML = '<span class="relative z-10 flex items-center gap-1"><span>👑</span>PRO</span>';

                        // Eski stilleri temizle
                        badge.classList.remove('bg-gray-200', 'text-gray-600', 'border-gray-300');
                        // Kritik: Inline style varsa temizle (gradient'i bozmaması için)
                        badge.removeAttribute('style');

                        // Yeni "PRO" stilini ekle
                        badge.classList.add(
                            'bg-gradient-to-r',
                            'from-amber-300',
                            'to-yellow-500',
                            'text-yellow-900',
                            'border-yellow-600',
                            'shadow-[0_0_15px_rgba(251,191,36,0.6)]', // Parlama
                            'font-black',
                            'px-3'
                        );

                        console.log("✅ Premium üyelik doğrulandı: Header güncellendi.");
                    }
                }
            });

            // Satın alma fonksiyonunu da garantiye alalım
            const originalBuyPremium = window.buyPremium || function () { };
            window.buyPremium = function () {
                // Eski fonksiyonu çalıştır
                if (typeof originalBuyPremium === 'function') originalBuyPremium();

                // Durumu kaydet ve header'ı anlık boya
                localStorage.setItem('user_status', 'pro'); // 'user_membership_status' düzeltildi
                const badge = document.getElementById('user-plan-badge');

                if (badge) {
                    badge.innerHTML = '<span class="relative z-10 flex items-center gap-1"><span>👑</span>PRO</span>';
                    badge.classList.remove('bg-gray-200', 'text-gray-600');
                    badge.removeAttribute('style');
                    badge.classList.add('bg-gradient-to-r', 'from-amber-300', 'to-yellow-500', 'text-yellow-900', 'shadow-lg');
                }

                // Değişkenleri güncelle
                if (typeof isPremium !== 'undefined') isPremium = true;
                window.userStatus = 'pro';

                // Kutlama
                if (window.confetti) window.confetti();
            };
        </script>
        <!-- WIDGET OPTIMIZATION: AUTO-FIT & OVERFLOW FIXES -->
        <style>
            /* === FIX: Mobilde Gelir/Gider tutar taşması (ikon altına girme) === */
            /* Tutar satırı asla ikonun altına taşmasın */
            .widget-card-apple .widget-amount-line {
                max-width: 100%;
                overflow: hidden;
            }

            /* Tutar metni tek satır + kutunun içinde kalsın */
            .widget-card-apple .amount-fit {
                display: inline-block;
                max-width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-variant-numeric: tabular-nums;
                letter-spacing: -0.02em;
            }

            /* Mobilde tutarı estetik şekilde biraz küçült (taşmayı önler) */
            @media (max-width: 640px) {
                .widget-card-apple .amount-fit {
                    font-size: clamp(1.02rem, 4.6vw, 1.25rem);
                    line-height: 1.15;
                }
            }

            /* iPhone SE / çok dar ekran için ekstra */
            @media (max-width: 360px) {
                .widget-card-apple .amount-fit {
                    font-size: clamp(0.95rem, 4.4vw, 1.08rem);
                }
            }
        </style>

        <script>
            // === AUTO-FIT LOGIC FOR WIDGET AMOUNTS ===
            function fitAmountText(el, minPx = 14) {
                if (!el) return;

                // Base font-size (ilk değeri sakla)
                if (!el.dataset.baseFs) {
                    el.dataset.baseFs = parseFloat(getComputedStyle(el).fontSize);
                }
                const base = parseFloat(el.dataset.baseFs);

                // Reset
                el.style.fontSize = base + "px";

                // Kullanılabilir genişlik: h3 satırı
                const line = el.closest(".widget-amount-line") || el.parentElement;
                if (!line) return;

                const maxW = line.clientWidth - 2;
                const sw = el.scrollWidth;

                if (maxW > 0 && sw > maxW) {
                    const ratio = maxW / sw;
                    const newFs = Math.max(base * ratio, minPx);
                    el.style.fontSize = newFs + "px";
                }
            }

            function fitDashboardAmounts() {
                fitAmountText(document.getElementById("display-income"));
                fitAmountText(document.getElementById("display-expense"));
            }

            // HOOK into updateUI
            const originalUpdateUI = window.updateUI;
            window.updateUI = function () {
                if (originalUpdateUI) originalUpdateUI.apply(this, arguments);
                requestAnimationFrame(fitDashboardAmounts);
            };

            // Resize Listener
            window.addEventListener("resize", fitDashboardAmounts, { passive: true });

            // Initial Call
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(fitDashboardAmounts, 500);
            });
        </script>
    </body>


    <!-- ═══════════════════════════════════════════════════════════════════════════════════ -->
    <!-- FINGO BRAIN V2.1 UI INTEGRATION (PULSE & DNA) -->
    <!-- ═══════════════════════════════════════════════════════════════════════════════════ -->
    <script>
        (function () {
            // Wait for dependencies
            window.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    // Override switchAutopilotTab to enforce V2.1 Logic if needed
                    // or just piggyback if we can't find the original.
                    // Since original is elusive, we redefine it safely.

                    window.switchAutopilotTab = function (tabName) {
                        try {
                            const tabs = ['pulse', 'dna', 'ailab', 'detective', 'assistant', 'installments'];

                            // 1. Hide all tabs
                            tabs.forEach(t => {
                                const el = document.getElementById(`autopilot-tab-${t}`);
                                if (el) el.classList.add('hidden');

                                // Reset button styles (heuristic based on onclick)
                                const btn = document.querySelector(`.fb-tab[onclick*="'${t}'"]`);
                                if (btn) {
                                    // Inactive Style
                                    btn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm', 'dark:bg-white/10', 'dark:text-white');
                                    btn.classList.add('text-gray-500', 'dark:text-gray-400');
                                }
                            });

                            // 2. Show active tab
                            const activeEl = document.getElementById(`autopilot-tab-${tabName}`);
                            if (activeEl) {
                                activeEl.classList.remove('hidden');

                                // Active Button Style
                                const activeBtn = document.querySelector(`.fb-tab[onclick*="'${tabName}'"]`);
                                if (activeBtn) {
                                    activeBtn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm', 'dark:bg-white/10', 'dark:text-white');
                                    activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
                                }
                            }

                            // 3. Trigger Data Refresh
                            if (tabName === 'pulse') refreshPulseUI();
                            if (tabName === 'dna') refreshDNAUI();
                            if (tabName === 'detective') refreshDetectiveUI();
                            if (tabName === 'installments' && typeof window.renderFBInstallments === 'function') window.renderFBInstallments();

                        } catch (e) {
                            console.error("FingoBrain Tab Switch Error:", e);
                        }
                    };

                    // Initial Refresh
                    if (typeof window.ensureCharts === 'function') window.ensureCharts();
                }, 1000);
            });

            // ─── PULSE UI REFRESH ───
            window.refreshPulseUI = function () {
                if (!window.FingoBrain) return;

                const scoreData = window.FingoBrain.calculateAdvancedScore();
                const forecast = window.FingoBrain.getPulseForecast();

                // Score Value
                const scoreEl = document.getElementById('fingo-score-val');
                if (scoreEl) {
                    // Animate number
                    animateCounter(scoreEl, 0, scoreData.score, 1500);
                }

                // Score Ring
                const circleEl = document.getElementById('fingo-score-circle');
                if (circleEl) {
                    // 176 is approx circumference for r=28
                    const offset = 176 - (176 * scoreData.score / 1000);
                    circleEl.style.strokeDashoffset = offset;

                    // Color transition
                    let colorClass = 'text-indigo-500';
                    if (scoreData.color === 'emerald') colorClass = 'text-emerald-400';
                    else if (scoreData.color === 'orange') colorClass = 'text-amber-400';
                    else if (scoreData.color === 'red') colorClass = 'text-rose-500';

                    circleEl.setAttribute('class', `transition-all duration-1000 ${colorClass}`);
                }

                // Forecast Tile
                const predEl = document.getElementById('prediction-balance');
                if (predEl) {
                    predEl.textContent = "~ " + window.FingoBrain.formatCurrency(forecast.projected);
                    predEl.classList.remove('text-indigo-600', 'dark:text-indigo-400'); // reset
                    // Add conditional coloring? No, keep it clean for now.
                }

                // Volatility Tile
                const volEl = document.getElementById('prediction-volatility');
                if (volEl && scoreData.details) {
                    const vScore = scoreData.details.volatilityScore;
                    let vText = "Düşük ✅";
                    let vClass = "text-emerald-500";

                    if (vScore < 40) { vText = "Yüksek ⚠️"; vClass = "text-rose-500"; }
                    else if (vScore < 70) { vText = "Orta 📊"; vClass = "text-amber-500"; }

                    volEl.textContent = vText;
                    volEl.className = `text-xl font-bold ${vClass}`;
                }
            };

            // ─── DNA UI REFRESH ───
            window.refreshDNAUI = function () {
                if (!window.FingoBrain || typeof Chart === 'undefined') return;

                const dna = window.FingoBrain.analyzeDNA();

                // Dominant Category Card (if exists)
                // Need to find IDs for this later, but for now we focus on Radar Chart

                // Radar Chart
                const ctx = document.getElementById('radarChart');
                if (ctx) {
                    if (window.fingoRadarChart) window.fingoRadarChart.destroy();

                    window.fingoRadarChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: dna.chart.labels,
                            datasets: [{
                                label: 'Harcama Yoğunluğu',
                                data: dna.chart.data,
                                backgroundColor: 'rgba(99, 102, 241, 0.2)', // Indigo-500 optimized
                                borderColor: '#6366f1',
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#6366f1',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: '#6366f1',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: { color: 'rgba(150, 150, 150, 0.1)' },
                                    grid: { color: 'rgba(150, 150, 150, 0.1)' },
                                    pointLabels: {
                                        color: (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? '#9ca3af' : '#4b5563',
                                        font: { size: 10, family: "'Inter', sans-serif" }
                                    },
                                    ticks: { display: false, backdropColor: 'transparent' }
                                }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
            };

            // ─── DETECTIVE UI REFRESH ───
            window.refreshDetectiveUI = function () {
                if (!window.FingoBrain) return;
                // Trigger existing subscription check logic if needed
                // Or populate the subscription list
                const subsText = window.FingoBrain.checkSubscriptions(); // returns string currently, might need parsing
                // For now relying on existing detective structure or future upgrades
            };

            // Helper: Animate Counter
            function animateCounter(el, start, end, duration) {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    el.textContent = Math.floor(progress * (end - start) + start);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }

        })();
    </script>

    <!-- ══════════════════════════════════════════════════════════════════
     FINGENDA KAPSAMLI GELİŞTİRMELER - JAVASCRIPT
     v2.1 - Sparkline, Skeleton, Filter, Notifications, Pull-to-Refresh
══════════════════════════════════════════════════════════════════ -->
    <script>
        (function initFingendaEnhancements() {
            'use strict';

            // ═══════════════════════════════════════════════════════════════
            // 1. SPARKLINE MİNİ GRAFİKLERİ
            // ═══════════════════════════════════════════════════════════════
            window.renderSparkline = function (containerId, data, type = 'income') {
                const container = document.getElementById(containerId);
                if (!container || !data || data.length === 0) return;

                container.innerHTML = '';
                container.className = 'sparkline-container';

                const maxVal = Math.max(...data, 1);
                const barClass = type === 'income' ? 'income' : type === 'expense' ? 'expense' : 'neutral';

                data.forEach((value, index) => {
                    const bar = document.createElement('div');
                    bar.className = `sparkline-bar ${barClass}`;
                    bar.style.height = `${Math.max((value / maxVal) * 100, 5)}%`;
                    bar.title = `${value.toLocaleString('tr-TR')} ₺`;
                    bar.style.animationDelay = `${index * 50}ms`;
                    container.appendChild(bar);
                });
            };

            // Son 7 günlük veriyi tek seferde al (Optimize Edilmiş - O(N))
            window.getOptimizedSparklineData = function () {
                const rawData = localStorage.getItem(`my_expenses_${new Date().getFullYear()}`);
                const transactions = rawData ? JSON.parse(rawData) : [];

                const income = new Array(7).fill(0);
                const expense = new Array(7).fill(0);

                // Tarih hesaplamaları (Cache friendly)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTime = today.getTime();

                const cutoff = new Date(today);
                cutoff.setDate(cutoff.getDate() - 6);
                const cutoffTime = cutoff.getTime();

                const msPerDay = 1000 * 60 * 60 * 24;

                // Tek döngüde tüm veriyi işle
                for (let i = 0; i < transactions.length; i++) {
                    const t = transactions[i];
                    if (!t.date) continue;

                    // ISO String optimize parsing (YYYY-MM-DD...)
                    // new Date() maliyetli olabilir, ama güvenli.
                    const tDate = new Date(t.date);
                    tDate.setHours(0, 0, 0, 0);
                    const time = tDate.getTime();

                    if (time >= cutoffTime && time <= todayTime) {
                        const idx = Math.round((time - cutoffTime) / msPerDay);
                        if (idx >= 0 && idx < 7) {
                            const amount = Math.abs(parseFloat(t.amount) || 0);
                            if (t.type === 'income') income[idx] += amount;
                            else if (t.type === 'expense') expense[idx] += amount;
                        }
                    }
                }

                return { income, expense };
            };

            // Backward compatibility wrapper
            window.getLast7DaysData = function (type = 'expense') {
                const data = window.getOptimizedSparklineData();
                return type === 'income' ? data.income : data.expense;
            };

            // Dashboard kartlarına sparkline ekle
            window.updateDashboardSparklines = function () {
                // Optimize edilmiş veri çekimi
                const data = window.getOptimizedSparklineData();

                // Gelir kartına sparkline container ekle
                const incomeCard = document.querySelector('#display-income')?.closest('.widget-card-apple');
                if (incomeCard && !incomeCard.querySelector('.sparkline-container')) {
                    const container = document.createElement('div');
                    container.id = 'sparkline-income';
                    container.className = 'sparkline-container';
                    const bottomRow = incomeCard.querySelector('.mt-4.flex');
                    if (bottomRow) bottomRow.appendChild(container);
                }
                window.renderSparkline('sparkline-income', data.income, 'income');

                // Gider kartına sparkline container ekle
                const expenseCard = document.querySelector('#display-expense')?.closest('.widget-card-apple');
                if (expenseCard && !expenseCard.querySelector('.sparkline-container')) {
                    const container = document.createElement('div');
                    container.id = 'sparkline-expense';
                    container.className = 'sparkline-container';
                    const bottomRow = expenseCard.querySelector('.mt-4.flex');
                    if (bottomRow) bottomRow.appendChild(container);
                }
                window.renderSparkline('sparkline-expense', data.expense, 'expense');
            };

            // ═══════════════════════════════════════════════════════════════
            // 2. SKELETON LOADING
            // ═══════════════════════════════════════════════════════════════
            window.showSkeletonLoading = function (containerId, type = 'cards') {
                const container = document.getElementById(containerId);
                if (!container) return;

                let skeletonHTML = '';

                if (type === 'cards') {
                    skeletonHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
            `;
                } else if (type === 'transactions') {
                    skeletonHTML = `
                <div class="skeleton skeleton-transaction"></div>
                <div class="skeleton skeleton-transaction"></div>
                <div class="skeleton skeleton-transaction"></div>
            `;
                } else if (type === 'list') {
                    skeletonHTML = `
                <div class="p-4 space-y-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                    <div class="skeleton skeleton-text" style="width: 60%"></div>
                </div>
            `;
                }

                container.innerHTML = skeletonHTML;
            };

            window.hideSkeletonLoading = function (containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const skeletons = container.querySelectorAll('.skeleton');
                skeletons.forEach(s => s.remove());
            };

            // ═══════════════════════════════════════════════════════════════
            // 3. GELİŞMİŞ FİLTRELEME SİSTEMİ
            // ═══════════════════════════════════════════════════════════════
            window.advancedFilterState = {
                type: 'all', // all, income, expense
                category: [],
                minAmount: 0,
                maxAmount: Infinity,
                dateFrom: null,
                dateTo: null,
                searchText: ''
            };

            window.openAdvancedFilterModal = function () {
                let modal = document.getElementById('advanced-filter-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'advanced-filter-modal';
                    modal.className = 'fixed inset-0 z-[10000] flex items-end justify-center bg-black/55 backdrop-blur-md hidden';
                    modal.onclick = (e) => {
                        if (e.target === modal) window.closeAdvancedFilterModal();
                    };

                    const categories = window.EXPENSE_CATEGORIES || [
                        { id: 'market', name: 'Market', icon: '🛒' },
                        { id: 'ulasim', name: 'Ulaşım', icon: '🚌' },
                        { id: 'fatura', name: 'Fatura', icon: '📄' },
                        { id: 'saglik', name: 'Sağlık', icon: '💊' },
                        { id: 'eglence', name: 'Eğlence', icon: '🎬' },
                        { id: 'yemek', name: 'Yemek', icon: '🍽️' },
                        { id: 'giyim', name: 'Giyim', icon: '👕' },
                        { id: 'diger', name: 'Diğer', icon: '📦' }
                    ];

                    modal.innerHTML = `
                <div class="filter-modal-content w-full max-w-lg p-6 animate-slide-up">
                    <div class="filter-modal-header flex justify-between items-center mb-4">
                        <h3 class="text-xl font-black text-gray-800 dark:text-white">Gelişmiş Filtre</h3>
                        <button onclick="window.closeAdvancedFilterModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition">✕</button>
                    </div>

                    <div class="filter-section">
                        <span class="filter-label">İşlem Tipi</span>
                        <div class="filter-chip-group flex flex-wrap gap-2 dark:!bg-[#1e1e2d] dark:!border-[#3d3d5c]">
                            <button onclick="window.setFilterType('all')" class="filter-chip active dark:!bg-[#2d2d45] dark:!text-gray-200" data-type="all">Tümü</button>
                            <button onclick="window.setFilterType('income')" class="filter-chip dark:!bg-[#2d2d45] dark:!text-gray-200" data-type="income">💰 Gelir</button>
                            <button onclick="window.setFilterType('expense')" class="filter-chip dark:!bg-[#2d2d45] dark:!text-gray-200" data-type="expense">💸 Gider</button>
                        </div>
                    </div>

                    <div class="filter-section">
                        <span class="filter-label">Kategoriler</span>
                        <div class="filter-chip-group flex flex-wrap gap-2 dark:!bg-[#1e1e2d] dark:!border-[#3d3d5c]" id="filter-categories">
                            ${categories.map(c => `
                                <button onclick="window.toggleFilterCategory('${c.id}')" class="filter-chip dark:!bg-[#2d2d45] dark:!text-gray-200" data-category="${c.id}">
                                    ${c.icon} ${c.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="filter-section">
                        <span class="filter-label">Tutar Aralığı</span>
                        <div class="filter-range-row flex items-center gap-4">
                            <input type="number" id="filter-min-amount" placeholder="Min" class="ag-input flex-1 p-3 rounded-xl text-center" value="0">
                            <span class="text-gray-400 font-bold">—</span>
                            <input type="number" id="filter-max-amount" placeholder="Max" class="ag-input flex-1 p-3 rounded-xl text-center" value="">
                        </div>
                    </div>

                    <div class="filter-section">
                        <span class="filter-label">Tarih Aralığı</span>
                        <div class="filter-range-row flex items-center gap-4">
                            <input type="date" id="filter-date-from" class="ag-input flex-1 p-3 rounded-xl">
                            <span class="text-gray-400 font-bold">—</span>
                            <input type="date" id="filter-date-to" class="ag-input flex-1 p-3 rounded-xl">
                        </div>
                    </div>

                    <div class="filter-modal-footer flex gap-3 mt-6">
                        <button onclick="window.resetFilters()" class="flex-1 py-3.5 rounded-xl bg-gray-100 dark:bg-white/10 text-gray-600 dark:text-gray-300 font-bold transition hover:bg-gray-200">
                            Sıfırla
                        </button>
                        <button onclick="window.applyAdvancedFilters()" class="flex-1 py-3.5 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg transition hover:shadow-xl">
                            Uygula ✓
                        </button>
                    </div>
                </div>
            `;

                    document.body.appendChild(modal);
                }

                modal.classList.remove('hidden');
            };

            window.closeAdvancedFilterModal = function () {
                const modal = document.getElementById('advanced-filter-modal');
                if (modal) modal.classList.add('hidden');
            };

            window.setFilterType = function (type) {
                window.advancedFilterState.type = type;
                document.querySelectorAll('#advanced-filter-modal .filter-chip[data-type]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === type);
                });
            };

            window.toggleFilterCategory = function (categoryId) {
                const idx = window.advancedFilterState.category.indexOf(categoryId);
                if (idx > -1) {
                    window.advancedFilterState.category.splice(idx, 1);
                } else {
                    window.advancedFilterState.category.push(categoryId);
                }

                document.querySelectorAll('#filter-categories .filter-chip').forEach(btn => {
                    btn.classList.toggle('active', window.advancedFilterState.category.includes(btn.dataset.category));
                });
            };

            window.resetFilters = function () {
                window.advancedFilterState = {
                    type: 'all',
                    category: [],
                    minAmount: 0,
                    maxAmount: Infinity,
                    dateFrom: null,
                    dateTo: null,
                    searchText: ''
                };

                document.querySelectorAll('#advanced-filter-modal .filter-chip').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.type === 'all') btn.classList.add('active');
                });

                document.getElementById('filter-min-amount').value = '0';
                document.getElementById('filter-max-amount').value = '';
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';

                if (typeof window.renderFullHistory === 'function') {
                    window.renderFullHistory();
                }
            };

            window.applyAdvancedFilters = function () {
                const state = window.advancedFilterState;
                state.minAmount = parseFloat(document.getElementById('filter-min-amount')?.value) || 0;
                state.maxAmount = parseFloat(document.getElementById('filter-max-amount')?.value) || Infinity;
                state.dateFrom = document.getElementById('filter-date-from')?.value || null;
                state.dateTo = document.getElementById('filter-date-to')?.value || null;

                window.filterTransactionsAdvanced();
                window.closeAdvancedFilterModal();
            };

            window.filterTransactionsAdvanced = function () {
                const state = window.advancedFilterState;
                const year = new Date().getFullYear();
                let transactions = JSON.parse(localStorage.getItem(`my_expenses_${year}`) || '[]');

                // Type filter
                if (state.type !== 'all') {
                    transactions = transactions.filter(t => t.type === state.type);
                }

                // Category filter
                if (state.category.length > 0) {
                    transactions = transactions.filter(t => state.category.includes(t.category));
                }

                // Amount filter
                transactions = transactions.filter(t => {
                    const amount = Math.abs(t.amount || 0);
                    return amount >= state.minAmount && amount <= state.maxAmount;
                });

                // Date filter
                if (state.dateFrom) {
                    transactions = transactions.filter(t => t.date >= state.dateFrom);
                }
                if (state.dateTo) {
                    transactions = transactions.filter(t => t.date <= state.dateTo);
                }

                // Search text
                if (state.searchText) {
                    const search = state.searchText.toLowerCase();
                    transactions = transactions.filter(t =>
                        (t.description || '').toLowerCase().includes(search) ||
                        (t.category || '').toLowerCase().includes(search) ||
                        (t.notes || '').toLowerCase().includes(search)
                    );
                }

                // Render filtered results
                if (typeof window.renderFilteredHistory === 'function') {
                    window.renderFilteredHistory(transactions);
                } else if (typeof window.renderTransactionList === 'function') {
                    window.renderTransactionList(transactions, 'full-history-list');
                }

                // Show filter active badge
                const activeFiltersCount = (state.type !== 'all' ? 1 : 0) +
                    state.category.length +
                    (state.minAmount > 0 ? 1 : 0) +
                    (state.maxAmount < Infinity ? 1 : 0) +
                    (state.dateFrom ? 1 : 0) +
                    (state.dateTo ? 1 : 0);

                if (activeFiltersCount > 0) {
                    window.showMicroFeedback && window.showMicroFeedback({
                        message: `${activeFiltersCount} filtre uygulandı`,
                        type: 'success'
                    });
                }
            };

            // ═══════════════════════════════════════════════════════════════
            // 4. BÜTÇE LİMİTİ BİLDİRİMLERİ
            // ═══════════════════════════════════════════════════════════════
            window.budgetLimits = JSON.parse(localStorage.getItem('fingenda_budget_limits') || '{}');

            window.setBudgetLimit = function (category, limit) {
                window.budgetLimits[category] = limit;
                localStorage.setItem('fingenda_budget_limits', JSON.stringify(window.budgetLimits));
            };

            window.checkBudgetLimits = function () {
                const year = new Date().getFullYear();
                const month = new Date().getMonth();
                const transactions = JSON.parse(localStorage.getItem(`my_expenses_${year}`) || '[]');

                // Aylık harcamaları kategorilere göre topla
                const monthlySpending = {};
                transactions.forEach(t => {
                    if (t.type !== 'expense') return;
                    const tDate = new Date(t.date);
                    if (tDate.getMonth() !== month) return;

                    const category = t.category || 'diger';
                    monthlySpending[category] = (monthlySpending[category] || 0) + Math.abs(t.amount || 0);
                });

                // Limitleri kontrol et
                Object.keys(window.budgetLimits).forEach(category => {
                    const limit = window.budgetLimits[category];
                    const spent = monthlySpending[category] || 0;
                    const percentage = (spent / limit) * 100;

                    if (percentage >= 100) {
                        window.showBudgetAlert('danger', category, spent, limit);
                    } else if (percentage >= 80) {
                        window.showBudgetAlert('warning', category, spent, limit);
                    }
                });

                // Toplam aylık bütçeyi de kontrol et
                const totalBudget = window.budgetLimits['total'] || 0;
                if (totalBudget > 0) {
                    const totalSpent = Object.values(monthlySpending).reduce((a, b) => a + b, 0);
                    const percentage = (totalSpent / totalBudget) * 100;

                    if (percentage >= 100) {
                        window.showBudgetAlert('danger', 'toplam', totalSpent, totalBudget);
                    } else if (percentage >= 80) {
                        window.showBudgetAlert('warning', 'toplam', totalSpent, totalBudget);
                    }
                }
            };

            window.showBudgetAlert = function (type, category, spent, limit) {
                // Aynı kategoride son 1 saatte gösterilmiş mi kontrol et
                const alertKey = `budget_alert_${category}_${type}`;
                const lastShown = localStorage.getItem(alertKey);
                const now = Date.now();

                if (lastShown && (now - parseInt(lastShown)) < 3600000) return; // 1 saat içinde gösterme
                localStorage.setItem(alertKey, now.toString());

                const categoryNames = {
                    market: 'Market',
                    ulasim: 'Ulaşım',
                    fatura: 'Fatura',
                    saglik: 'Sağlık',
                    eglence: 'Eğlence',
                    yemek: 'Yemek',
                    giyim: 'Giyim',
                    diger: 'Diğer',
                    toplam: 'Toplam Bütçe'
                };

                const icons = {
                    warning: '⚠️',
                    danger: '🚨',
                    success: '✅'
                };

                const messages = {
                    warning: `${categoryNames[category] || category} limitinin %80'ine ulaştınız!`,
                    danger: `${categoryNames[category] || category} limitini aştınız!`
                };

                // Mevcut alert'i kaldır
                const existingAlert = document.querySelector('.budget-alert');
                if (existingAlert) existingAlert.remove();

                const alert = document.createElement('div');
                alert.className = `budget-alert ${type}`;
                alert.innerHTML = `
            <span class="budget-alert-icon">${icons[type]}</span>
            <div>
                <div class="font-bold">${messages[type]}</div>
                <div class="text-sm opacity-80">${spent.toLocaleString('tr-TR')} ₺ / ${limit.toLocaleString('tr-TR')} ₺</div>
            </div>
            <button class="budget-alert-close" onclick="this.parentElement.classList.remove('show'); setTimeout(() => this.parentElement.remove(), 400);">✕</button>
        `;

                document.body.appendChild(alert);

                setTimeout(() => alert.classList.add('show'), 100);
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 400);
                }, 6000);
            };

            // ═══════════════════════════════════════════════════════════════
            // 5. PULL TO REFRESH
            // ═══════════════════════════════════════════════════════════════
            window.initPullToRefresh = function () {
                const main = document.querySelector('main');
                if (!main || main.dataset.ptrInit) return;
                main.dataset.ptrInit = 'true';

                let startY = 0;
                let pulling = false;
                let indicator = null;

                // Indicator oluştur
                indicator = document.createElement('div');
                indicator.className = 'ptr-indicator';
                indicator.innerHTML = '<span class="ptr-arrow">↓</span>';
                main.prepend(indicator);

                main.addEventListener('touchstart', (e) => {
                    if (main.scrollTop <= 0) {
                        startY = e.touches[0].clientY;
                        pulling = true;
                    }
                }, { passive: true });

                main.addEventListener('touchmove', (e) => {
                    if (!pulling) return;

                    const currentY = e.touches[0].clientY;
                    const diff = currentY - startY;

                    if (diff > 0 && main.scrollTop <= 0) {
                        const progress = Math.min(diff / 100, 1);
                        indicator.classList.add('visible');
                        indicator.style.transform = `translateX(-50%) translateY(${diff * 0.5}px)`;

                        if (progress >= 1) {
                            indicator.classList.add('ready');
                        } else {
                            indicator.classList.remove('ready');
                        }
                    }
                }, { passive: true });

                main.addEventListener('touchend', () => {
                    if (!pulling) return;
                    pulling = false;

                    if (indicator.classList.contains('ready')) {
                        indicator.classList.add('refreshing');
                        indicator.classList.remove('ready');
                        indicator.innerHTML = '<span class="ptr-arrow" style="animation: ptrSpin 1s linear infinite;">↻</span>';

                        // Yenileme işlemi
                        setTimeout(() => {
                            if (typeof window.refreshAllData === 'function') {
                                window.refreshAllData();
                            } else {
                                // Temel yenileme
                                if (typeof window.fetchMarketData === 'function') window.fetchMarketData();
                                if (typeof window.ensureCharts === 'function') window.ensureCharts();
                                window.updateDashboardSparklines();
                                window.updateWeeklyComparison();
                            }

                            indicator.classList.remove('refreshing', 'visible');
                            indicator.style.transform = '';
                            indicator.innerHTML = '<span class="ptr-arrow">↓</span>';

                            window.showMicroFeedback && window.showMicroFeedback({
                                message: 'Veriler güncellendi',
                                type: 'success'
                            });
                        }, 1000);
                    }
                }, { passive: true });
            };

            // ═══════════════════════════════════════════════════════════════
            // İNİSİYALİZASYON
            // ═══════════════════════════════════════════════════════════════




















            // ═══════════════════════════════════════════════════════════════
            // İNİSİYALİZASYON
            // ═══════════════════════════════════════════════════════════════

            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    console.log('[Fingenda] Geliştirmeler yükleniyor...');

                    // Sparklines
                    window.updateDashboardSparklines();

                    // Pull to Refresh
                    window.initPullToRefresh();



                    // Bütçe Limitleri Kontrolü
                    window.checkBudgetLimits();

                    // History ekranına filtre butonu ekle
                    const historyHeader = document.querySelector('#screen-history .flex.justify-between');
                    if (historyHeader && !historyHeader.querySelector('.filter-btn')) {
                        const filterBtn = document.createElement('button');
                        filterBtn.className = 'filter-btn w-9 h-9 rounded-full bg-indigo-100 dark:bg-indigo-500/20 text-indigo-600 dark:text-indigo-400 flex items-center justify-center hover:scale-110 transition shadow-sm ml-2';
                        filterBtn.innerHTML = '🔍';
                        filterBtn.title = 'Gelişmiş Filtre';
                        filterBtn.onclick = window.openAdvancedFilterModal;

                        const exportBtns = historyHeader.querySelector('.flex.space-x-2');
                        if (exportBtns) {
                            exportBtns.insertBefore(filterBtn, exportBtns.firstChild);
                        }
                    }

                    console.log('[Fingenda] ✅ Tüm geliştirmeler yüklendi!');
                }, 1500);
            });



        })();
    </script>

    <!-- ══════════════════════════════════════════════════════════════════
     FINGO BRAIN - KENDİNİ EĞİTEN AI SİSTEMİ
     v1.0 - Kullanıcıyı Tanıyan, Öğrenen, Kişiselleştirilmiş Sohbet AI
══════════════════════════════════════════════════════════════════ -->
    <script>
        (function initFingoAI() {
            'use strict';

            // ═══════════════════════════════════════════════════════════════
            // FINGO AI - ANA SİSTEM
            // ═══════════════════════════════════════════════════════════════
            window.FingoAI = {
                version: '1.0',
                isInitialized: false,

                // Kullanıcı Profili
                profile: {
                    name: '',
                    nickname: '',
                    salary: 0,
                    goals: [],
                    preferences: [],
                    mood: 'neutral',
                    interestAreas: [],
                    chatCount: 0,
                    lastInteraction: null,
                    learnings: {},
                    personality: 'friendly'  // friendly, professional, casual
                },

                // Sohbet Geçmişi
                chatHistory: [],
                maxHistoryLength: 100,

                // Kontekst Belleği (Kısa Süreli)
                context: {
                    lastTopic: null,
                    lastIntent: null,
                    lastEntities: [],
                    conversationTurn: 0
                },

                // ═══════════════════════════════════════════════════════════
                // BAŞLATMA
                // ═══════════════════════════════════════════════════════════
                initialize: function () {
                    if (this.isInitialized) return;

                    console.log('[FingoAI] 🧠 Sistem başlatılıyor...');

                    this.loadProfile();
                    this.loadChatHistory();
                    this.updateGreeting();
                    this.hookChatInput();

                    this.isInitialized = true;
                    console.log('[FingoAI] ✅ Sistem hazır!');
                },

                // ═══════════════════════════════════════════════════════════
                // PROFİL YÖNETİMİ
                // ═══════════════════════════════════════════════════════════
                loadProfile: function () {
                    try {
                        const saved = localStorage.getItem('fingo_ai_profile');
                        if (saved) {
                            const parsed = JSON.parse(saved);
                            this.profile = { ...this.profile, ...parsed };
                            console.log('[FingoAI] Profil yüklendi:', this.profile.name || 'Anonim');
                        }
                    } catch (e) {
                        console.error('[FingoAI] Profil yüklenemedi:', e);
                    }
                },

                saveProfile: function () {
                    try {
                        this.profile.lastInteraction = new Date().toISOString();
                        localStorage.setItem('fingo_ai_profile', JSON.stringify(this.profile));
                    } catch (e) {
                        console.error('[FingoAI] Profil kaydedilemedi:', e);
                    }
                },

                loadChatHistory: function () {
                    try {
                        const saved = localStorage.getItem('fingo_ai_chat_history');
                        if (saved) {
                            this.chatHistory = JSON.parse(saved);
                        }
                    } catch (e) {
                        this.chatHistory = [];
                    }
                },

                saveChatHistory: function () {
                    try {
                        // Son 100 mesajı tut
                        if (this.chatHistory.length > this.maxHistoryLength) {
                            this.chatHistory = this.chatHistory.slice(-this.maxHistoryLength);
                        }
                        localStorage.setItem('fingo_ai_chat_history', JSON.stringify(this.chatHistory));
                    } catch (e) {
                        console.error('[FingoAI] Sohbet geçmişi kaydedilemedi');
                    }
                },

                // ═══════════════════════════════════════════════════════════
                // NLP ENGINE - DOĞAL DİL İŞLEME
                // ═══════════════════════════════════════════════════════════

                // Niyet Tespiti
                detectIntent: function (text) {
                    const lowerText = text.toLowerCase().trim();

                    // Selamlama
                    if (/^(merhaba|selam|hey|sa|slm|naber|nasıl|günaydın|iyi akşamlar|iyi geceler)/i.test(lowerText)) {
                        return 'greeting';
                    }

                    // Tanışma / İsim söyleme
                    if (/benim\s*(adım|ismim)\s*(\w+)|ben\s+(\w+)|adım\s+(\w+)/i.test(lowerText)) {
                        return 'introduce_name';
                    }

                    // Maaş/Gelir bilgisi
                    if (/(maaşım|gelirim|kazancım|aylığım).*([\d.,]+)/i.test(lowerText)) {
                        return 'share_income';
                    }

                    // Finansal durum sorusu
                    if (/(ne kadar|kaç|toplam).*(harcadım|gider|gelir|param|bakiye)/i.test(lowerText)) {
                        return 'query_finance';
                    }

                    // Tavsiye/Öneri isteme
                    if (/(nasıl|ne yapmalıyım|öner|tavsiye|yardım|ipucu).*(tasarruf|birikim|yatırım|para)/i.test(lowerText)) {
                        return 'ask_advice';
                    }

                    // Hedef belirleme
                    if (/(hedef|amaç|istiyorum|planlıyorum).*(almak|yapmak|biriktirmek|ödemek)/i.test(lowerText)) {
                        return 'set_goal';
                    }

                    // Şikayet/Dert
                    if (/(param\s*yok|zor|sıkıntı|borç|stres|endişe)/i.test(lowerText)) {
                        return 'express_concern';
                    }

                    // Teşekkür
                    if (/(teşekkür|sağol|eyv|tşk|thanks)/i.test(lowerText)) {
                        return 'thanks';
                    }

                    // Vedalaşma
                    if (/(görüşürüz|bye|hoşça\s*kal|güle\s*güle)/i.test(lowerText)) {
                        return 'goodbye';
                    }

                    // Kategori sorgusu
                    if (/(ne kadar|kaç).*(market|yemek|ulaşım|fatura|eğlence|giyim|sağlık)/i.test(lowerText)) {
                        return 'query_category';
                    }

                    // Sohbet / Genel konuşma
                    if (/(ne yapıyorsun|nasılsın|keyifler|neler yapıyorsun)/i.test(lowerText)) {
                        return 'chat_casual';
                    }

                    // Yardım talebi
                    if (/(yardım|help|ne yapabilirsin|komutlar|özellikler)/i.test(lowerText)) {
                        return 'help';
                    }

                    // Bilinmeyen - genel sohbet
                    return 'general';
                },

                // Duygu Analizi
                detectSentiment: function (text) {
                    const lowerText = text.toLowerCase();

                    const positiveWords = ['güzel', 'harika', 'süper', 'mükemmel', 'sevindim', 'mutlu', 'iyi', 'başardım', 'teşekkür', 'tşk', 'sağol'];
                    const negativeWords = ['kötü', 'berbat', 'üzgün', 'sıkıntı', 'stres', 'endişe', 'borç', 'zor', 'param yok', 'battım'];

                    let score = 0;
                    positiveWords.forEach(w => { if (lowerText.includes(w)) score++; });
                    negativeWords.forEach(w => { if (lowerText.includes(w)) score--; });

                    if (score > 0) return 'positive';
                    if (score < 0) return 'negative';
                    return 'neutral';
                },

                // Varlık Çıkarma (Entity Extraction)
                extractEntities: function (text) {
                    const entities = {};

                    // İsim çıkarma
                    const nameMatch = text.match(/(?:adım|ismim|ben)\s+(\w+)/i);
                    if (nameMatch) entities.name = nameMatch[1];

                    // Tutar çıkarma
                    const amountMatch = text.match(/([\d.,]+)\s*(tl|lira|₺|k|bin)?/gi);
                    if (amountMatch) {
                        entities.amounts = amountMatch.map(m => {
                            let num = parseFloat(m.replace(/[^\d.,]/g, '').replace(',', '.'));
                            if (/k|bin/i.test(m)) num *= 1000;
                            return num;
                        }).filter(n => !isNaN(n));
                    }

                    // Kategori çıkarma
                    const categories = ['market', 'yemek', 'ulaşım', 'fatura', 'eğlence', 'giyim', 'sağlık', 'eğitim'];
                    categories.forEach(cat => {
                        if (text.toLowerCase().includes(cat)) {
                            entities.category = cat;
                        }
                    });

                    // Tarih/Zaman çıkarma
                    if (/bu\s*ay/i.test(text)) entities.timeframe = 'this_month';
                    if (/geçen\s*ay/i.test(text)) entities.timeframe = 'last_month';
                    if (/bu\s*hafta/i.test(text)) entities.timeframe = 'this_week';
                    if (/bugün/i.test(text)) entities.timeframe = 'today';

                    return entities;
                },

                // ═══════════════════════════════════════════════════════════
                // ÖĞRENME SİSTEMİ
                // ═══════════════════════════════════════════════════════════
                learnFromMessage: function (text, intent, entities) {
                    let learned = false;

                    // İsim öğrenme
                    if (entities.name && !this.profile.name) {
                        this.profile.name = entities.name.charAt(0).toUpperCase() + entities.name.slice(1).toLowerCase();
                        this.profile.learnings.nameLearnedAt = new Date().toISOString();
                        learned = true;
                        console.log('[FingoAI] İsim öğrenildi:', this.profile.name);
                    }

                    // Gelir öğrenme
                    if (intent === 'share_income' && entities.amounts && entities.amounts.length > 0) {
                        this.profile.salary = Math.max(...entities.amounts);
                        this.profile.learnings.salaryLearnedAt = new Date().toISOString();
                        learned = true;
                        console.log('[FingoAI] Gelir öğrenildi:', this.profile.salary);
                    }

                    // Hedef öğrenme
                    if (intent === 'set_goal') {
                        const goalMatch = text.match(/(.*?)\s*(almak|yapmak|biriktirmek|ödemek)/i);
                        if (goalMatch) {
                            const goal = goalMatch[1].replace(/hedef|amaç|istiyorum|planlıyorum/gi, '').trim();
                            if (goal && !this.profile.goals.includes(goal)) {
                                this.profile.goals.push(goal);
                                learned = true;
                                console.log('[FingoAI] Hedef öğrenildi:', goal);
                            }
                        }
                    }

                    // İlgi alanı öğrenme
                    if (entities.category && !this.profile.interestAreas.includes(entities.category)) {
                        this.profile.interestAreas.push(entities.category);
                        learned = true;
                    }

                    // Ruh hali güncelleme
                    const sentiment = this.detectSentiment(text);
                    this.profile.mood = sentiment;

                    // Etkileşim sayısını artır
                    this.profile.chatCount++;

                    if (learned) {
                        this.saveProfile();
                    }

                    return learned;
                },

                // ═══════════════════════════════════════════════════════════
                // YANIT ÜRETME
                // ═══════════════════════════════════════════════════════════
                generateResponse: function (intent, entities, originalText) {
                    const name = this.profile.name;
                    const greeting = name ? `${name}, ` : '';

                    switch (intent) {
                        case 'greeting':
                            return this.getPersonalizedGreeting();

                        case 'introduce_name':
                            if (entities.name) {
                                return `Memnun oldum ${entities.name} ! 🙌 Artık seni tanıyorum.Finansal durumun hakkında konuşmak ister misin ? Bana maaşını, hedeflerini veya harcamalarını sorabilirsin.`;
                            }
                            return 'Memnun oldum! Seni tanımak güzel. 😊';

                        case 'share_income':
                            if (entities.amounts && entities.amounts.length > 0) {
                                const salary = Math.max(...entities.amounts);
                                const suggestion = salary > 10000
                                    ? `Bu iyi bir gelir ${greeting}.Gelirinin % 20'sini (${Math.round(salary * 0.2).toLocaleString('tr - TR')} ₺) biriktirmeyi hedefleyebilirsin.`
                                    : `Anladım ${greeting}. Bütçeni dikkatli yönetmek önemli. Sana tasarruf önerileri sunabilirim.`;
                                return `${salary.toLocaleString('tr-TR')} ₺ maaş bilgini kaydettim! 📝 ${suggestion}`;
                            }
                            return 'Gelir bilgini anlayamadım. "Maaşım 15000 TL" gibi yazabilir misin?';

                        case 'query_finance':
                            return this.getFinancialSummary(entities);

                        case 'query_category':
                            return this.getCategoryAnalysis(entities);

                        case 'ask_advice':
                            return this.generateAdvice();

                        case 'set_goal':
                            return `${greeting}hedefini kaydettim! 🎯 Bu hedefe ulaşman için sana yardımcı olacağım. Düzenli takip edelim mi?`;

                        case 'express_concern':
                            return this.generateSupportiveResponse();

                        case 'thanks':
                            const thanksResponses = [
                                `Rica ederim ${greeting}! Her zaman buradayım. 💙`,
                                `Ne demek ${greeting}, yardımcı olabildiysem ne mutlu! 😊`,
                                `Her zaman ${greeting}! Başka sorun olursa sor. 🌟`
                            ];
                            return thanksResponses[Math.floor(Math.random() * thanksResponses.length)];

                        case 'goodbye':
                            return `Görüşürüz ${greeting}! Finansal sağlığına dikkat et. 🚀 Tekrar beklerim!`;

                        case 'chat_casual':
                            const casualResponses = [
                                `${greeting}senin finansal verilerini analiz ediyorum! Harcamalarını takip ediyor, sana öneriler sunuyorum. Nasıl yardımcı olabilirim?`,
                                `${greeting}burada, senin için çalışıyorum! 🤖 Bugün ne konuşmak istersin?`,
                                `İyiyim ${greeting}! Senin için her an hazırım. Finansal durumunu konuşmak ister misin?`
                            ];
                            return casualResponses[Math.floor(Math.random() * casualResponses.length)];

                        case 'help':
                            return this.getHelpText();

                        default:
                            return this.generateSmartResponse(originalText);
                    }
                },

                // Kişiselleştirilmiş Selamlama
                getPersonalizedGreeting: function () {
                    const hour = new Date().getHours();
                    const name = this.profile.name;
                    const chatCount = this.profile.chatCount;

                    let timeGreeting = '';
                    if (hour >= 5 && hour < 12) timeGreeting = 'Günaydın';
                    else if (hour >= 12 && hour < 18) timeGreeting = 'İyi günler';
                    else if (hour >= 18 && hour < 22) timeGreeting = 'İyi akşamlar';
                    else timeGreeting = 'İyi geceler';

                    // Yeni kullanıcı
                    if (!name && chatCount < 3) {
                        return `${timeGreeting}! 👋 Ben Fingo, senin finansal asistanınım. Seninle tanışmak isterim. Adın ne?`;
                    }

                    // Tanıdık kullanıcı
                    if (name) {
                        if (chatCount > 10) {
                            return `${timeGreeting} ${name}! 🌟 Yine görüşmek güzel. Bugün sana nasıl yardımcı olabilirim?`;
                        }
                        return `${timeGreeting} ${name}! 😊 Hoş geldin! Finansal durumun hakkında konuşabilir veya tavsiye isteyebilirsin.`;
                    }

                    return `${timeGreeting}! 👋 Ben Fingo, finansal asistanınım. Sana nasıl yardımcı olabilirim?`;
                },

                // Finansal Özet
                getFinancialSummary: function (entities) {
                    const year = new Date().getFullYear();
                    const transactions = JSON.parse(localStorage.getItem(`my_expenses_${year}`) || '[]');
                    const month = new Date().getMonth();

                    let filtered = transactions;
                    if (entities.timeframe === 'this_month') {
                        filtered = transactions.filter(t => new Date(t.date).getMonth() === month);
                    } else if (entities.timeframe === 'last_month') {
                        filtered = transactions.filter(t => new Date(t.date).getMonth() === month - 1);
                    }

                    const income = filtered.filter(t => t.type === 'income').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
                    const expense = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
                    const balance = income - expense;

                    const name = this.profile.name ? `${this.profile.name}, ` : '';
                    const mood = balance > 0 ? '📈 Harika!' : balance === 0 ? '➖ Dengeli' : '📉 Dikkat!';

                    return `${name}işte finansal özetin:\n\n` +
                        `💰 Gelir: ${income.toLocaleString('tr-TR')} ₺\n` +
                        `💸 Gider: ${expense.toLocaleString('tr-TR')} ₺\n` +
                        `📊 Net: ${balance.toLocaleString('tr-TR')} ₺ ${mood}\n\n` +
                        `Daha detaylı analiz için "hangi kategoride ne kadar harcadım?" diye sorabilirsin.`;
                },

                // Kategori Analizi
                getCategoryAnalysis: function (entities) {
                    const year = new Date().getFullYear();
                    const transactions = JSON.parse(localStorage.getItem(`my_expenses_${year}`) || '[]');
                    const month = new Date().getMonth();

                    const monthlyTxns = transactions.filter(t =>
                        t.type === 'expense' && new Date(t.date).getMonth() === month
                    );

                    const categoryTotals = {};
                    monthlyTxns.forEach(t => {
                        const cat = t.category || 'Diğer';
                        categoryTotals[cat] = (categoryTotals[cat] || 0) + Math.abs(t.amount || 0);
                    });

                    if (Object.keys(categoryTotals).length === 0) {
                        return 'Bu ay henüz harcama kaydın yok. İşlem eklemek için + butonunu kullanabilirsin!';
                    }

                    const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
                    let response = 'Bu ay kategori bazlı harcamaların:\n\n';
                    sorted.slice(0, 5).forEach(([cat, amount], i) => {
                        const emoji = ['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][i];
                        response += `${emoji} ${cat}: ${amount.toLocaleString('tr-TR')} ₺\n`;
                    });

                    const topCat = sorted[0];
                    response += `\n💡 En çok ${topCat[0]} kategorisinde harcamışsın. Bu alanda tasarruf yapabilir misin diye düşün!`;

                    return response;
                },

                // Tavsiye Üretme
                generateAdvice: function () {
                    const year = new Date().getFullYear();
                    const transactions = JSON.parse(localStorage.getItem(`my_expenses_${year}`) || '[]');
                    const name = this.profile.name ? `${this.profile.name}, ` : '';

                    // Harcama analizi
                    const month = new Date().getMonth();
                    const thisMonth = transactions.filter(t =>
                        t.type === 'expense' && new Date(t.date).getMonth() === month
                    );
                    const lastMonth = transactions.filter(t =>
                        t.type === 'expense' && new Date(t.date).getMonth() === month - 1
                    );

                    const thisTotal = thisMonth.reduce((s, t) => s + Math.abs(t.amount || 0), 0);
                    const lastTotal = lastMonth.reduce((s, t) => s + Math.abs(t.amount || 0), 0);

                    const advices = [];

                    // Genel tasarruf önerisi
                    if (this.profile.salary > 0) {
                        const savingsTarget = Math.round(this.profile.salary * 0.2);
                        advices.push(`Maaşının %20'si olan ${savingsTarget.toLocaleString('tr-TR')} ₺'yi her ay biriktirmeyi hedefle.`);
                    }

                    // Trend bazlı öneri
                    if (thisTotal > lastTotal * 1.2) {
                        advices.push('Bu ay geçen aya göre %20+ fazla harcamışsın. Gereksiz harcamalara dikkat et!');
                    } else if (thisTotal < lastTotal * 0.8) {
                        advices.push('Bu ay geçen aya göre daha az harcamışsın. Harika gidiyorsun! 🎉');
                    }

                    // 50/30/20 kuralı
                    advices.push('50/30/20 kuralını dene: Gelirinin %50 ihtiyaçlara, %30 isteklere, %20 birikime ayır.');

                    // Hedef bazlı
                    if (this.profile.goals.length > 0) {
                        advices.push(`"${this.profile.goals[0]}" hedefin için her ay düzenli bir miktar ayırmayı unutma!`);
                    }

                    const randomAdvice = advices[Math.floor(Math.random() * advices.length)];
                    return `${name}işte sana tavsiyem:\n\n💡 ${randomAdvice}\n\nBaşka soru sormak ister misin?`;
                },

                // Destekleyici Yanıt
                generateSupportiveResponse: function () {
                    const name = this.profile.name ? `${this.profile.name}, ` : '';
                    const responses = [
                        `${name}anlıyorum, zor zamanlar olabiliyor. 💙 Ama adım adım gidersen üstesinden gelirsin. Birlikte bütçe planı yapalım mı?`,
                        `${name}finansal stres çok yaygın. 🤗 Önemli olan farkında olmak ve harekete geçmek. Sana nasıl yardımcı olabilirim?`,
                        `${name}endişelenme, ben buradayım! 💪 Önce durumunu analiz edelim, sonra çözüm yolları bulalım. Harcamalarına bakalım mı?`,
                        `${name}her şey düzelecek. 🌈 Küçük adımlar büyük değişimler yaratır. Bugün neye dikkat edebilirsin?`
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                },

                // Yardım Metni
                getHelpText: function () {
                    return `🤖 **Fingo AI Komutları**\n\n` +
                        `• "Merhaba" - Selamlaşma\n` +
                        `• "Adım X" - Kendini tanıt\n` +
                        `• "Maaşım X TL" - Gelirini paylaş\n` +
                        `• "Ne kadar harcadım?" - Finansal özet\n` +
                        `• "Market'e ne kadar harcadım?" - Kategori analizi\n` +
                        `• "Tasarruf önerisi ver" - Tavsiye al\n` +
                        `• "X almak istiyorum" - Hedef belirle\n\n` +
                        `💡 Ben seni tanıdıkça daha iyi öneriler sunacağım!`;
                },

                // Akıllı Yanıt (Fallback)
                generateSmartResponse: function (text) {
                    const name = this.profile.name ? `${this.profile.name}, ` : '';

                    // Finansal terimler içeriyorsa
                    if (/para|tl|lira|harca|gider|gelir|bütçe|tasarruf|yatırım/i.test(text)) {
                        return `${name}finansal bir konu gibi görünüyor. Daha spesifik sorabilir misin? Örneğin:\n• "Bu ay ne kadar harcadım?"\n• "Tasarruf önerisi ver"\n• "Birikim hedefi koy"`;
                    }

                    // Genel sohbet
                    const generalResponses = [
                        `${name}ilginç bir soru! 🤔 Ben finansal konularda daha iyi yardımcı olabilirim. Harcamalarını analiz edeyim mi?`,
                        `${name}hmm, bunu tam anlayamadım. 🤖 Ben Fingo, senin finansal asistanınım. "Ne yapabilirsin?" diye sorabilirsin.`,
                        `${name}bu konuda emin değilim ama finansal sorularını cevaplayabilirim! 💰 Bana bakiye, harcama veya tasarruf hakkında sorabilirsin.`
                    ];

                    return generalResponses[Math.floor(Math.random() * generalResponses.length)];
                },

                // ═══════════════════════════════════════════════════════════
                // CHAT ENTEGRASYONU
                // ═══════════════════════════════════════════════════════════
                hookChatInput: function () {
                    const self = this;

                    // Mevcut handleChatSubmit'i override et
                    const originalHandleChatSubmit = window.handleChatSubmit;

                    window.handleChatSubmit = function () {
                        const input = document.getElementById('ai-chat-input');
                        const history = document.getElementById('ai-chat-history');

                        if (!input || !history) return;

                        const userText = input.value.trim();
                        if (!userText) return;

                        // Kullanıcı mesajını ekle
                        self.addMessageToChat('user', userText);
                        input.value = '';

                        // AI yanıtı üret
                        setTimeout(() => {
                            const intent = self.detectIntent(userText);
                            const entities = self.extractEntities(userText);

                            // Öğrenme
                            self.learnFromMessage(userText, intent, entities);

                            // Yanıt üret
                            const response = self.generateResponse(intent, entities, userText);

                            // AI mesajını ekle
                            self.addMessageToChat('ai', response);

                            // Sohbet geçmişine kaydet
                            self.chatHistory.push({
                                timestamp: new Date().toISOString(),
                                userMessage: userText,
                                aiResponse: response,
                                intent: intent,
                                sentiment: self.detectSentiment(userText)
                            });
                            self.saveChatHistory();

                            // Kontekst güncelle
                            self.context.lastIntent = intent;
                            self.context.lastEntities = entities;
                            self.context.conversationTurn++;

                        }, 500 + Math.random() * 500); // Doğal gecikme
                    };
                },

                addMessageToChat: function (sender, text) {
                    const history = document.getElementById('ai-chat-history');
                    if (!history) return;

                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex items-start gap-3 animate-slide-up ${sender === 'user' ? 'flex-row-reverse' : ''}`;

                    const avatarClass = sender === 'user'
                        ? 'bg-indigo-500 text-white'
                        : 'bg-indigo-100 dark:bg-indigo-500/20 text-indigo-600 dark:text-indigo-300';

                    const bubbleClass = sender === 'user'
                        ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-md'
                        : 'ag-bubble-ai';

                    const avatar = sender === 'user' ? '👤' : '🤖';

                    // Markdown benzeri formatlama
                    let formattedText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');

                    msgDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full ${avatarClass} border border-indigo-200 dark:border-indigo-500/30 flex-shrink-0 flex items-center justify-center text-xs">
                    ${avatar}
                </div>
                <div class="${bubbleClass} p-4 max-w-[85%] text-sm leading-relaxed shadow-sm">
                    <p>${formattedText}</p>
                </div>
            `;

                    history.appendChild(msgDiv);
                    history.scrollTop = history.scrollHeight;
                },

                // Hoş Geldin Mesajını Güncelle
                updateGreeting: function () {
                    const history = document.getElementById('ai-chat-history');
                    if (!history) return;

                    // Mevcut içeriği temizle ve kişiselleştirilmiş selamlama ekle
                    const greeting = this.getPersonalizedGreeting();

                    history.innerHTML = `
                <div class="flex items-start gap-3 animate-slide-up">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-500/20 border border-indigo-200 dark:border-indigo-500/30 flex-shrink-0 flex items-center justify-center text-xs text-indigo-600 dark:text-indigo-300">
                        🤖
                    </div>
                    <div class="ag-bubble-ai p-4 max-w-[85%] text-sm leading-relaxed shadow-sm">
                        <p>${greeting}</p>
                    </div>
                </div>
            `;
                }
            };

            // ═══════════════════════════════════════════════════════════════
            // OTOMATİK BAŞLATMA
            // ═══════════════════════════════════════════════════════════════
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    window.FingoAI.initialize();
                }, 2000);
            });



        })();
    </script>


</html>

<!-- ══════════════════════════════════════════════════════════════════
     TEMA YÖNETİMİ VE GELİŞMİŞ EFEKTLER
     v1.0 - ThemeManager, Ripple, Scroll Reveal
══════════════════════════════════════════════════════════════════ -->
<script>
    (function initThemeEnhancements() {
        'use strict';

        // ═══════════════════════════════════════════════════════════════
        // THEME MANAGER - Gelişmiş Tema Yönetimi
        // ═══════════════════════════════════════════════════════════════
        window.ThemeManager = {
            currentTheme: 'default',
            availableThemes: ['default', 'oled-dark', 'sepia-mode', 'high-contrast'],

            // Tema Başlatma
            initialize: function () {
                const savedTheme = localStorage.getItem('fingenda_theme_mode');
                if (savedTheme && this.availableThemes.includes(savedTheme)) {
                    this.applyTheme(savedTheme);
                }
                console.log('[ThemeManager] ✅ Tema sistemi yüklendi');
            },

            // Tema Uygula
            applyTheme: function (themeName) {
                const html = document.documentElement;

                // Önce tüm tema sınıflarını kaldır
                this.availableThemes.forEach(theme => {
                    if (theme !== 'default') {
                        html.classList.remove(theme);
                    }
                });

                // Yeni temayı uygula
                if (themeName !== 'default') {
                    html.classList.add(themeName);
                }

                this.currentTheme = themeName;
                localStorage.setItem('fingenda_theme_mode', themeName);

                // Event trigger
                window.dispatchEvent(new CustomEvent('themeChanged', { detail: { theme: themeName } }));

                console.log('[ThemeManager] Tema değiştirildi:', themeName);
            },

            // Tema Döngüsü
            cycleTheme: function () {
                const currentIndex = this.availableThemes.indexOf(this.currentTheme);
                const nextIndex = (currentIndex + 1) % this.availableThemes.length;
                this.applyTheme(this.availableThemes[nextIndex]);
            },

            // OLED Dark Mode
            enableOLEDDark: function () {
                document.documentElement.classList.add('dark');
                this.applyTheme('oled-dark');
            },

            // Sepia Mode
            enableSepia: function () {
                document.documentElement.classList.remove('dark');
                this.applyTheme('sepia-mode');
            },

            // High Contrast
            enableHighContrast: function () {
                this.applyTheme('high-contrast');
            },

            // Normal Mode
            resetTheme: function () {
                this.applyTheme('default');
            },

            // Tema Adını Al
            getThemeName: function (themeId) {
                const names = {
                    'default': 'Varsayılan',
                    'oled-dark': 'OLED Dark',
                    'sepia-mode': 'Göz Koruma',
                    'high-contrast': 'Yüksek Kontrast'
                };
                return names[themeId] || themeId;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // RIPPLE EFFECT - Material Design Dalgalanma
        // ═══════════════════════════════════════════════════════════════
        window.RippleEffect = {
            create: function (event, element) {
                const rect = element.getBoundingClientRect();
                const ripple = document.createElement('span');

                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                ripple.className = 'ripple';
                ripple.style.cssText = `
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
            `;

                element.appendChild(ripple);

                setTimeout(() => ripple.remove(), 600);
            },

            // Otomatik bağlama
            init: function () {
                document.addEventListener('click', (e) => {
                    const target = e.target.closest('.touch-feedback, .ripple-effect');
                    if (target) {
                        target.style.position = target.style.position || 'relative';
                        target.style.overflow = target.style.overflow || 'hidden';
                        this.create(e, target);
                    }
                });
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // SCROLL REVEAL - Görünüme Girince Animasyon
        // ═══════════════════════════════════════════════════════════════
        window.ScrollReveal = {
            observer: null,

            init: function () {
                if ('IntersectionObserver' in window) {
                    this.observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('revealed');
                                entry.target.style.opacity = '1';
                                entry.target.style.transform = 'translateY(0)';
                            }
                        });
                    }, {
                        threshold: 0.1,
                        rootMargin: '0px 0px -50px 0px'
                    });

                    // .scroll-reveal sınıflı elementleri izle
                    document.querySelectorAll('.scroll-reveal').forEach(el => {
                        el.style.opacity = '0';
                        el.style.transform = 'translateY(20px)';
                        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                        this.observer.observe(el);
                    });
                }
            },

            // Manuel ekleme
            observe: function (element) {
                if (this.observer && element) {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(20px)';
                    element.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                    this.observer.observe(element);
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // PAGE TRANSITION - Sayfa Geçiş Animasyonları
        // ═══════════════════════════════════════════════════════════════
        window.PageTransition = {
            // Tab değişiminde animasyon
            transition: function (fromScreen, toScreen) {
                if (fromScreen) {
                    fromScreen.classList.add('page-exit');
                    setTimeout(() => {
                        fromScreen.classList.add('hidden');
                        fromScreen.classList.remove('page-exit');
                    }, 300);
                }

                if (toScreen) {
                    setTimeout(() => {
                        toScreen.classList.remove('hidden');
                        toScreen.classList.add('page-enter');
                        setTimeout(() => {
                            toScreen.classList.remove('page-enter');
                        }, 400);
                    }, fromScreen ? 200 : 0);
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ANIMATED COUNTER - Sayı Animasyonu
        // ═══════════════════════════════════════════════════════════════
        window.animateValue = function (element, start, end, duration, prefix = '', suffix = '') {
            if (!element) return;

            const startTime = performance.now();
            const range = end - start;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Easing function (ease-out-cubic)
                const easeProgress = 1 - Math.pow(1 - progress, 3);

                const current = start + (range * easeProgress);
                element.textContent = prefix + Math.round(current).toLocaleString('tr-TR') + suffix;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        };

        // ═══════════════════════════════════════════════════════════════
        // GRADIENT TEXT - Gradient Metin Rengi
        // ═══════════════════════════════════════════════════════════════
        window.applyGradientText = function (element, gradient) {
            if (!element) return;
            element.style.background = gradient;
            element.style.webkitBackgroundClip = 'text';
            element.style.webkitTextFillColor = 'transparent';
            element.style.backgroundClip = 'text';
        };

        // ═══════════════════════════════════════════════════════════════
        // OTOMATİK BAŞLATMA
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.ThemeManager.initialize();
                window.RippleEffect.init();
                window.ScrollReveal.init();
                console.log('[ThemeEnhancements] ✅ Tüm tema geliştirmeleri yüklendi!');
            }, 1000);
        });

    })();
</script>

<!-- ══════════════════════════════════════════════════════════════════
     KAPSAMLI ÖZELLİK PAKETİ
     v1.0 - Günlük Görevler, Streak, ML, OCR, PDF, Bildirimler
══════════════════════════════════════════════════════════════════ -->
<script>
    (function initAdvancedFeatures() {
        'use strict';
        const APP_YEAR = new Date().getFullYear();

        // ═══════════════════════════════════════════════════════════════
        // 1. GÜNLÜK GÖREVLER SİSTEMİ
        // ═══════════════════════════════════════════════════════════════
        window.DailyTasks = {
            tasks: [],
            storageKey: 'fingenda_daily_tasks',

            // Varsayılan görevler
            defaultTasks: [
                { id: 'no_impulse', title: 'Dürtüsel alışveriş yapma', emoji: '🛒', xp: 20 },
                { id: 'log_expense', title: 'En az 1 harcama kaydet', emoji: '📝', xp: 10 },
                { id: 'check_budget', title: 'Bütçeni kontrol et', emoji: '📊', xp: 5 },
                { id: 'save_money', title: 'Bugün tasarruf yap', emoji: '💰', xp: 25 },
                { id: 'review_goals', title: 'Hedeflerini gözden geçir', emoji: '🎯', xp: 15 }
            ],

            initialize: function () {
                this.loadTasks();
                this.checkNewDay();
                console.log('[DailyTasks] ✅ Günlük görevler yüklendi');
            },

            loadTasks: function () {
                const saved = localStorage.getItem(this.storageKey);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.date === this.getTodayStr()) {
                        this.tasks = data.tasks;
                        return;
                    }
                }
                this.resetTasks();
            },

            resetTasks: function () {
                this.tasks = this.defaultTasks.map(t => ({
                    ...t,
                    completed: false,
                    completedAt: null
                }));
                this.saveTasks();
            },

            saveTasks: function () {
                localStorage.setItem(this.storageKey, JSON.stringify({
                    date: this.getTodayStr(),
                    tasks: this.tasks
                }));
            },

            getTodayStr: function () {
                return new Date().toISOString().split('T')[0];
            },

            checkNewDay: function () {
                const saved = localStorage.getItem(this.storageKey);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.date !== this.getTodayStr()) {
                        this.resetTasks();
                    }
                }
            },

            completeTask: function (taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task && !task.completed) {
                    task.completed = true;
                    task.completedAt = new Date().toISOString();
                    this.saveTasks();

                    // Streak güncelle
                    window.StreakSystem.checkDailyCompletion();

                    // XP ekle
                    if (window.showMiniToast) {
                        window.showMiniToast('Görev Tamamlandı!', `+${task.xp} XP kazandın`, task.emoji);
                    }

                    return true;
                }
                return false;
            },

            getProgress: function () {
                const completed = this.tasks.filter(t => t.completed).length;
                return {
                    completed,
                    total: this.tasks.length,
                    percent: Math.round((completed / this.tasks.length) * 100),
                    totalXP: this.tasks.filter(t => t.completed).reduce((s, t) => s + t.xp, 0)
                };
            },

            renderTasksWidget: function () {
                const progress = this.getProgress();
                return `
                <div class="daily-tasks-widget glass-card p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-800 dark:text-white text-sm flex items-center gap-2">
                            📋 Günlük Görevler
                        </h3>
                        <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400">
                            ${progress.completed}/${progress.total}
                        </span>
                    </div>
                    <div class="progress-bar-premium mb-3">
                        <div class="progress-fill" style="width: ${progress.percent}%"></div>
                    </div>
                    <div class="space-y-2">
                        ${this.tasks.map(task => `
                            <div class="flex items-center gap-3 p-2 rounded-xl ${task.completed ? 'bg-green-100 dark:bg-green-900/20' : 'bg-gray-50 dark:bg-white/5'}" 
                                 onclick="DailyTasks.completeTask('${task.id}')">
                                <span class="text-lg">${task.completed ? '✅' : task.emoji}</span>
                                <span class="text-xs font-medium ${task.completed ? 'line-through text-gray-400' : 'text-gray-700 dark:text-gray-300'}">${task.title}</span>
                                <span class="ml-auto text-[10px] font-bold text-indigo-500">+${task.xp} XP</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 2. STREAK SİSTEMİ
        // ═══════════════════════════════════════════════════════════════
        window.StreakSystem = {
            storageKey: 'fingenda_streak',
            data: { currentStreak: 0, longestStreak: 0, lastActiveDate: null },

            initialize: function () {
                this.loadData();
                this.checkStreak();
                console.log('[StreakSystem] ✅ Streak sistemi yüklendi:', this.data.currentStreak, 'gün');
            },

            loadData: function () {
                const saved = localStorage.getItem(this.storageKey);
                if (saved) {
                    this.data = JSON.parse(saved);
                }
            },

            saveData: function () {
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
            },

            getTodayStr: function () {
                return new Date().toISOString().split('T')[0];
            },

            getYesterdayStr: function () {
                const d = new Date();
                d.setDate(d.getDate() - 1);
                return d.toISOString().split('T')[0];
            },

            checkStreak: function () {
                const today = this.getTodayStr();
                const yesterday = this.getYesterdayStr();

                if (!this.data.lastActiveDate) return;

                // Dün aktif değilse streak kırıldı
                if (this.data.lastActiveDate !== today && this.data.lastActiveDate !== yesterday) {
                    this.data.currentStreak = 0;
                    this.saveData();
                }
            },

            checkDailyCompletion: function () {
                const progress = window.DailyTasks.getProgress();
                const today = this.getTodayStr();

                // Tüm görevler tamamlandıysa
                if (progress.completed >= 3 && this.data.lastActiveDate !== today) {
                    if (this.data.lastActiveDate === this.getYesterdayStr()) {
                        this.data.currentStreak++;
                    } else {
                        this.data.currentStreak = 1;
                    }

                    this.data.lastActiveDate = today;

                    if (this.data.currentStreak > this.data.longestStreak) {
                        this.data.longestStreak = this.data.currentStreak;
                    }

                    this.saveData();

                    // Streak milestone rozetleri
                    if (this.data.currentStreak === 7) {
                        window.unlockBadge && window.unlockBadge('streak_week');
                    } else if (this.data.currentStreak === 30) {
                        window.unlockBadge && window.unlockBadge('streak_month');
                    }
                }
            },

            getStreakInfo: function () {
                return {
                    current: this.data.currentStreak,
                    longest: this.data.longestStreak,
                    isActive: this.data.lastActiveDate === this.getTodayStr()
                };
            },

            renderStreakBadge: function () {
                const info = this.getStreakInfo();
                return `
                <div class="streak-badge flex items-center gap-2 px-3 py-1.5 rounded-full 
                     ${info.current > 0 ? 'bg-gradient-to-r from-orange-500 to-red-500' : 'bg-gray-200 dark:bg-gray-700'}">
                    <span class="text-lg">🔥</span>
                    <span class="text-sm font-bold text-white">${info.current} gün</span>
                </div>
            `;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 3. OTURUM ZAMAN AŞIMI
        // ═══════════════════════════════════════════════════════════════
        window.SessionTimeout = {
            timeoutMinutes: 5,
            warningMinutes: 1,
            timer: null,
            warningTimer: null,
            lastActivity: Date.now(),

            initialize: function () {
                this.resetTimer();
                this.attachListeners();
                console.log('[SessionTimeout] ✅ Oturum izleme aktif');
            },

            attachListeners: function () {
                ['click', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                    document.addEventListener(event, () => this.resetTimer(), { passive: true });
                });
            },

            resetTimer: function () {
                this.lastActivity = Date.now();

                if (this.timer) clearTimeout(this.timer);
                if (this.warningTimer) clearTimeout(this.warningTimer);

                // Uyarı zamanı
                this.warningTimer = setTimeout(() => {
                    this.showWarning();
                }, (this.timeoutMinutes - this.warningMinutes) * 60 * 1000);

                // Kilitleme zamanı
                this.timer = setTimeout(() => {
                    this.lockSession();
                }, this.timeoutMinutes * 60 * 1000);
            },

            showWarning: function () {
                if (window.showMiniToast) {
                    window.showMiniToast('Oturum Uyarısı', '1 dakika içinde kilitlenecek', '⏰');
                }
            },

            lockSession: function () {
                const hasPin = localStorage.getItem('app_pin'); // Check if user has a PIN

                if (hasPin) {
                    // PIN VARSA -> Normal Kilit Ekranı
                    const pinScreen = document.getElementById('pin-lock-screen');
                    if (pinScreen) {
                        pinScreen.classList.remove('hidden');
                        if (window.showMiniToast) {
                            window.showMiniToast('Oturum Kilitlendi', 'Devam etmek için PIN girin', '🔒');
                        }
                    }
                } else {
                    // PIN YOKSA -> Smart Blur (Bulanıklaştırma)
                    const blurOverlay = document.getElementById('blur-overlay');
                    if (blurOverlay) {
                        blurOverlay.classList.remove('hidden');
                        // Blur aktifken scroll engelle
                        document.body.style.overflow = 'hidden';
                    }
                }
            },

            setTimeoutMinutes: function (minutes) {
                this.timeoutMinutes = minutes;
                this.resetTimer();
                localStorage.setItem('fingenda_session_timeout', minutes);
            }
        };

        // Global Dismiss Function for Smart Blur
        window.dismissBlurOverlay = function () {
            const blurOverlay = document.getElementById('blur-overlay');
            if (blurOverlay) {
                blurOverlay.classList.add('hidden');
                document.body.style.overflow = ''; // Scroll kilidini aç

                // Reset timers
                if (window.SessionTimeout) {
                    window.SessionTimeout.resetTimer();
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 4. ANOMALİ TESPİTİ
        // ═══════════════════════════════════════════════════════════════
        window.AnomalyDetection = {
            threshold: 0.5, // %50 sapma

            analyze: function () {
                const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                const expenses = transactions.filter(t => t.type === 'expense');

                if (expenses.length < 10) return [];

                // Kategori bazlı ortalama
                const categoryAvg = {};
                const categoryCounts = {};

                expenses.forEach(t => {
                    const cat = t.category || 'Diğer';
                    categoryAvg[cat] = (categoryAvg[cat] || 0) + Math.abs(t.amount);
                    categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
                });

                Object.keys(categoryAvg).forEach(cat => {
                    categoryAvg[cat] = categoryAvg[cat] / categoryCounts[cat];
                });

                // Son 7 günün işlemlerini kontrol et
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);

                const anomalies = [];
                expenses.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate >= weekAgo) {
                        const cat = t.category || 'Diğer';
                        const avg = categoryAvg[cat] || 0;
                        const amount = Math.abs(t.amount);

                        if (avg > 0 && (amount - avg) / avg > this.threshold) {
                            anomalies.push({
                                transaction: t,
                                avgAmount: avg,
                                deviation: ((amount - avg) / avg * 100).toFixed(0)
                            });
                        }
                    }
                });

                return anomalies;
            },

            getAlerts: function () {
                const anomalies = this.analyze();
                return anomalies.map(a => ({
                    title: `Yüksek Harcama: ${a.transaction.description || a.transaction.category}`,
                    message: `Bu harcama ortalamanın %${a.deviation} üzerinde`,
                    amount: a.transaction.amount,
                    category: a.transaction.category
                }));
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 5. ML HARCAMA TAHMİNİ (Basit Lineer Regresyon)
        // ═══════════════════════════════════════════════════════════════
        window.SpendingPredictor = {
            predict: function () {
                const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                const today = new Date();

                // Son 3 ayın aylık toplamları
                const monthlyTotals = [];
                for (let i = 2; i >= 0; i--) {
                    const targetMonth = today.getMonth() - i;
                    const monthExpenses = transactions.filter(t => {
                        const d = new Date(t.date);
                        return d.getMonth() === targetMonth && t.type === 'expense';
                    }).reduce((s, t) => s + Math.abs(t.amount), 0);

                    monthlyTotals.push(monthExpenses);
                }

                if (monthlyTotals.every(m => m === 0)) {
                    return { predicted: 0, trend: 'stable', confidence: 0 };
                }

                // Basit lineer regresyon
                const n = monthlyTotals.length;
                const sumX = (n * (n - 1)) / 2;
                const sumY = monthlyTotals.reduce((a, b) => a + b, 0);
                const sumXY = monthlyTotals.reduce((s, y, x) => s + x * y, 0);
                const sumX2 = Array.from({ length: n }, (_, i) => i * i).reduce((a, b) => a + b, 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                const predicted = Math.max(0, intercept + slope * n);
                const avg = sumY / n;

                let trend = 'stable';
                if (slope > avg * 0.1) trend = 'increasing';
                else if (slope < -avg * 0.1) trend = 'decreasing';

                return {
                    predicted: Math.round(predicted),
                    trend,
                    monthlyHistory: monthlyTotals,
                    confidence: Math.min(100, Math.round((1 - Math.abs(slope) / avg) * 100))
                };
            },

            renderPredictionCard: function () {
                const pred = this.predict();
                const trendEmoji = { increasing: '📈', decreasing: '📉', stable: '➖' };
                const trendText = { increasing: 'Artış', decreasing: 'Azalış', stable: 'Stabil' };
                const trendColor = {
                    increasing: 'text-red-500',
                    decreasing: 'text-green-500',
                    stable: 'text-gray-500'
                };

                return `
                <div class="prediction-card glass-card p-4 rounded-2xl mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl">🔮</span>
                        <h3 class="font-bold text-gray-800 dark:text-white text-sm">Gelecek Ay Tahmini</h3>
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-2xl font-black text-gray-800 dark:text-white">
                                ${pred.predicted.toLocaleString('tr-TR')} ₺
                            </p>
                            <p class="text-xs ${trendColor[pred.trend]} font-bold flex items-center gap-1">
                                ${trendEmoji[pred.trend]} ${trendText[pred.trend]} trendi
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-500 dark:text-gray-400">Güven</p>
                            <p class="text-sm font-bold text-indigo-600 dark:text-indigo-400">%${pred.confidence}</p>
                        </div>
                    </div>
                </div>
            `;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 6. KARBON AYAK İZİ HESABICI
        // ═══════════════════════════════════════════════════════════════
        window.CarbonFootprint = {
            // kg CO2 per TL (tahmini değerler)
            categoryEmissions: {
                'Ulaşım': 0.15,
                'Benzin': 0.25,
                'Market': 0.05,
                'Yemek': 0.08,
                'Eğlence': 0.02,
                'Giyim': 0.03,
                'Fatura': 0.1,
                'Diğer': 0.04
            },

            calculate: function (timeframe = 'month') {
                const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                const today = new Date();
                let startDate;

                if (timeframe === 'month') {
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                } else if (timeframe === 'year') {
                    startDate = new Date(today.getFullYear(), 0, 1);
                }

                let totalCO2 = 0;
                const categoryBreakdown = {};

                transactions.forEach(t => {
                    if (t.type === 'expense' && new Date(t.date) >= startDate) {
                        const cat = t.category || 'Diğer';
                        const emission = (this.categoryEmissions[cat] || 0.04) * Math.abs(t.amount);
                        totalCO2 += emission;
                        categoryBreakdown[cat] = (categoryBreakdown[cat] || 0) + emission;
                    }
                });

                return {
                    totalKg: Math.round(totalCO2),
                    breakdown: categoryBreakdown,
                    trees: Math.round(totalCO2 / 20), // 1 ağaç ≈ 20kg CO2/yıl
                    comparison: this.getComparison(totalCO2)
                };
            },

            getComparison: function (kg) {
                if (kg < 50) return { text: 'Düşük', emoji: '🌱', color: 'text-green-500' };
                if (kg < 150) return { text: 'Orta', emoji: '🌿', color: 'text-yellow-500' };
                return { text: 'Yüksek', emoji: '🏭', color: 'text-red-500' };
            },

            renderWidget: function () {
                const data = this.calculate('month');
                return `
                <div class="carbon-widget glass-card p-4 rounded-2xl">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-800 dark:text-white text-sm flex items-center gap-2">
                            🌍 Karbon Ayak İzi
                        </h3>
                        <span class="${data.comparison.color} text-lg">${data.comparison.emoji}</span>
                    </div>
                    <p class="text-2xl font-black text-gray-800 dark:text-white">${data.totalKg} kg CO₂</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Bu ay ~${data.trees} ağaç dikilmeli
                    </p>
                </div>
            `;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 7. PDF RAPOR OLUŞTURUCU
        // ═══════════════════════════════════════════════════════════════
        window.PDFReportGenerator = {
            generate: async function (month = new Date().getMonth()) {
                if (typeof jspdf === 'undefined') {
                    console.error('jsPDF yüklenmemiş');
                    return;
                }

                const { jsPDF } = jspdf;
                const doc = new jsPDF();
                const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');

                const monthNames = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                    'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];

                const monthTxns = transactions.filter(t => new Date(t.date).getMonth() === month);
                const income = monthTxns.filter(t => t.type === 'income').reduce((s, t) => s + Math.abs(t.amount), 0);
                const expense = monthTxns.filter(t => t.type === 'expense').reduce((s, t) => s + Math.abs(t.amount), 0);

                // Başlık
                doc.setFontSize(24);
                doc.setTextColor(99, 102, 241);
                doc.text('Fingenda Finansal Rapor', 20, 25);

                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text(`${monthNames[month]} ${APP_YEAR}`, 20, 35);

                // Özet
                doc.setFontSize(16);
                doc.setTextColor(0);
                doc.text('Finansal Özet', 20, 55);

                doc.setFontSize(12);
                doc.text(`Toplam Gelir: ${income.toLocaleString('tr-TR')} TL`, 20, 70);
                doc.text(`Toplam Gider: ${expense.toLocaleString('tr-TR')} TL`, 20, 80);
                doc.text(`Net Bakiye: ${(income - expense).toLocaleString('tr-TR')} TL`, 20, 90);

                // İşlem tablosu
                if (monthTxns.length > 0 && typeof doc.autoTable === 'function') {
                    doc.autoTable({
                        startY: 110,
                        head: [['Tarih', 'Açıklama', 'Kategori', 'Tutar']],
                        body: monthTxns.slice(0, 20).map(t => [
                            new Date(t.date).toLocaleDateString('tr-TR'),
                            t.description || '-',
                            t.category || '-',
                            `${t.type === 'income' ? '+' : '-'}${Math.abs(t.amount).toLocaleString('tr-TR')} TL`
                        ]),
                        theme: 'striped',
                        headStyles: { fillColor: [99, 102, 241] }
                    });
                }

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Fingenda - Premium Finans Yönetimi', 20, 280);

                doc.save(`Fingenda_Rapor_${monthNames[month]}_${APP_YEAR}.pdf`);

                if (window.showMiniToast) {
                    window.showMiniToast('PDF Oluşturuldu', 'Rapor indirildi', '📄');
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 8. CSV/EXCEL IMPORT
        // ═══════════════════════════════════════════════════════════════
        window.DataImporter = {
            import: function (file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

                        const transactions = [];

                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            if (values.length < 2) continue;

                            const row = {};
                            headers.forEach((h, idx) => {
                                row[h] = values[idx]?.trim();
                            });

                            // Format algılama
                            const tx = {
                                date: this.parseDate(row.tarih || row.date || row.datum),
                                amount: this.parseAmount(row.tutar || row.amount || row.miktar),
                                type: this.parseType(row.tip || row.type || row.tutar),
                                category: row.kategori || row.category || 'Diğer',
                                description: row.aciklama || row.description || row.not || ''
                            };

                            if (tx.date && tx.amount) {
                                transactions.push(tx);
                            }
                        }

                        resolve(transactions);
                    };

                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            },

            parseDate: function (str) {
                if (!str) return null;
                // Farklı formatları dene
                const formats = [
                    /(\d{2})\.(\d{2})\.(\d{4})/, // DD.MM.YYYY
                    /(\d{4})-(\d{2})-(\d{2})/,   // YYYY-MM-DD
                    /(\d{2})\/(\d{2})\/(\d{4})/  // DD/MM/YYYY
                ];

                for (const fmt of formats) {
                    const match = str.match(fmt);
                    if (match) {
                        if (fmt === formats[1]) { // YYYY-MM-DD
                            return `${match[1]}-${match[2]}-${match[3]}`;
                        }
                        return `${match[3]}-${match[2]}-${match[1]}`;
                    }
                }
                return str;
            },

            parseAmount: function (str) {
                if (!str) return 0;
                return Math.abs(parseFloat(str.replace(/[^\d.,-]/g, '').replace(',', '.'))) || 0;
            },

            parseType: function (str) {
                if (!str) return 'expense';
                const lower = str.toLowerCase();
                if (lower.includes('gelir') || lower.includes('income') || str.includes('+')) {
                    return 'income';
                }
                return 'expense';
            },

            saveImported: function (transactions) {
                const existing = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                const merged = [...existing, ...transactions];
                localStorage.setItem(`my_expenses_${APP_YEAR}`, JSON.stringify(merged));

                if (window.showMiniToast) {
                    window.showMiniToast('Veri İçe Aktarıldı', `${transactions.length} işlem eklendi`, '📥');
                }

                return merged.length;
            },

            showImportDialog: function () {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.txt';

                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const txns = await this.import(file);
                            if (txns.length > 0) {
                                this.saveImported(txns);
                                window.renderTransactionList && window.renderTransactionList();
                            } else {
                                window.alertMessage && window.alertMessage('Uyarı', 'Dosyada geçerli işlem bulunamadı', 'yellow');
                            }
                        } catch (err) {
                            window.alertMessage && window.alertMessage('Hata', 'Dosya okunamadı', 'red');
                        }
                    }
                };

                input.click();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 9. OCR FATURA TARAMA (Tesseract.js)
        // ═══════════════════════════════════════════════════════════════
        window.ReceiptScanner = {
            isReady: false,

            ensureLoaded: async function () {
                if (typeof Tesseract === 'undefined') {
                    // Lazy load
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }
                this.isReady = true;
            },

            scan: async function (imageFile) {
                await this.ensureLoaded();

                if (window.showMiniToast) {
                    window.showMiniToast('Taranıyor...', 'Lütfen bekleyin', '🔍');
                }

                try {
                    const result = await Tesseract.recognize(imageFile, 'tur', {
                        logger: m => console.log(m)
                    });

                    const text = result.data.text;
                    return this.extractData(text);
                } catch (err) {
                    console.error('OCR hatası:', err);
                    return null;
                }
            },

            extractData: function (text) {
                const lines = text.split('\n');
                const data = {
                    amount: null,
                    date: null,
                    merchant: null
                };

                // Tutar arama (TL, ₺, TOPLAM)
                const amountPatterns = [
                    /TOPLAM[:\s]*([0-9.,]+)/i,
                    /GENEL\s*TOPLAM[:\s]*([0-9.,]+)/i,
                    /([0-9]+[.,][0-9]{2})\s*TL/i,
                    /₺\s*([0-9.,]+)/
                ];

                for (const pattern of amountPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        data.amount = parseFloat(match[1].replace(',', '.'));
                        break;
                    }
                }

                // Tarih arama
                const dateMatch = text.match(/(\d{2})[.\/](\d{2})[.\/](\d{4})/);
                if (dateMatch) {
                    data.date = `${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}`;
                }

                // İşyeri adı (genellikle ilk satırlar)
                for (const line of lines.slice(0, 5)) {
                    if (line.trim().length > 3 && !/[0-9]/.test(line.slice(0, 3))) {
                        data.merchant = line.trim();
                        break;
                    }
                }

                return data;
            },

            showScanDialog: function () {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';

                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const data = await this.scan(file);
                        if (data && data.amount) {
                            window.showMiniToast && window.showMiniToast(
                                'Fatura Tarandı',
                                `${data.amount} TL tespit edildi`,
                                '✅'
                            );

                            // İşlem ekleme formunu doldur
                            const amountInput = document.getElementById('input-amount');
                            const descInput = document.getElementById('input-description');

                            if (amountInput) amountInput.value = data.amount;
                            if (descInput && data.merchant) descInput.value = data.merchant;
                        } else {
                            window.alertMessage && window.alertMessage('Sonuç', 'Tutar tespit edilemedi', 'yellow');
                        }
                    }
                };

                input.click();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 10. BİLDİRİM SİSTEMİ
        // ═══════════════════════════════════════════════════════════════
        window.NotificationSystem = {
            isEnabled: false,
            notifications: [],
            unreadCount: 0,

            initialize: async function () {
                // Load saved notifications
                this.notifications = JSON.parse(localStorage.getItem('fingo_notifications') || '[]');
                this.unreadCount = this.notifications.filter(n => !n.read).length;

                // Capacitor varsa
                if (window.Capacitor?.Plugins?.LocalNotifications) {
                    const perm = await window.Capacitor.Plugins.LocalNotifications.requestPermissions();
                    this.isEnabled = perm.display === 'granted';
                }
                // Web Notification
                else if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        this.isEnabled = true;
                    } else if (Notification.permission !== 'denied') {
                        const perm = await Notification.requestPermission();
                        this.isEnabled = perm === 'granted';
                    }
                }

                // Create notification center UI
                this.createNotificationCenter();
                this.updateBadge();

                // Run smart checks
                setTimeout(() => this.runSmartChecks(), 2000);

                console.log('[Notifications]', this.isEnabled ? '✅ Aktif' : '❌ Devre dışı', `(${this.notifications.length} bildirim)`);
            },

            // Create notification center UI
            createNotificationCenter: function () {
                // Notification button for header (can be placed anywhere)
                const bellBtn = document.createElement('div');
                bellBtn.id = 'notification-bell';
                bellBtn.className = 'notification-bell';
                bellBtn.innerHTML = `
                    <button onclick="window.NotificationSystem.togglePanel()" class="notification-bell-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"/>
                        </svg>
                        <span class="notification-badge" id="notification-badge">0</span>
                    </button>
                `;
                document.body.appendChild(bellBtn);

                // Notification panel
                const panel = document.createElement('div');
                panel.id = 'notification-panel';
                panel.className = 'notification-panel';
                panel.innerHTML = `
                    <div class="notification-panel-header">
                        <h3>🔔 Bildirimler</h3>
                        <div class="notification-panel-actions">
                            <button onclick="window.NotificationSystem.markAllRead()" class="notif-action-btn">Tümünü Okundu İşaretle</button>
                            <button onclick="window.NotificationSystem.togglePanel()" class="notif-close-btn">✕</button>
                        </div>
                    </div>
                    <div class="notification-list" id="notification-list">
                        <div class="notification-empty">
                            <span class="text-4xl">🔕</span>
                            <p>Henüz bildirim yok</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(panel);

                // Add styles
                this.injectStyles();
            },

            injectStyles: function () {
                const style = document.createElement('style');
                style.textContent = `
                    /* Notification Bell */
                    .notification-bell {
                        position: fixed;
                        top: 16px;
                        right: 16px;
                        z-index: 9999;
                    }
                    .notification-bell-btn {
                        width: 48px;
                        height: 48px;
                        border-radius: 50%;
                        background: rgba(255,255,255,0.9);
                        backdrop-filter: blur(20px);
                        border: 1px solid rgba(0,0,0,0.08);
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        color: #374151;
                        transition: all 0.3s ease;
                        position: relative;
                    }
                    html.dark .notification-bell-btn,
                    body.dark .notification-bell-btn {
                        background: rgba(30,30,40,0.9);
                        border-color: rgba(255,255,255,0.1);
                        color: #e5e7eb;
                    }
                    .notification-bell-btn:hover {
                        transform: scale(1.08);
                        box-shadow: 0 6px 25px rgba(99,102,241,0.25);
                    }
                    .notification-badge {
                        position: absolute;
                        top: -4px;
                        right: -4px;
                        min-width: 20px;
                        height: 20px;
                        border-radius: 10px;
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                        font-size: 11px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 0 6px;
                        box-shadow: 0 2px 8px rgba(239,68,68,0.4);
                        opacity: 0;
                        transform: scale(0);
                        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    }
                    .notification-badge.visible {
                        opacity: 1;
                        transform: scale(1);
                    }

                    /* Notification Panel */
                    .notification-panel {
                        position: fixed;
                        top: 76px;
                        right: 16px;
                        width: 360px;
                        max-width: calc(100vw - 32px);
                        max-height: 70vh;
                        background: rgba(255,255,255,0.95);
                        backdrop-filter: blur(30px);
                        border-radius: 24px;
                        border: 1px solid rgba(0,0,0,0.08);
                        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                        z-index: 9998;
                        display: flex;
                        flex-direction: column;
                        opacity: 0;
                        transform: translateY(-20px) scale(0.95);
                        pointer-events: none;
                        transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
                    }
                    html.dark .notification-panel,
                    body.dark .notification-panel {
                        background: rgba(20,20,30,0.95);
                        border-color: rgba(255,255,255,0.1);
                    }
                    .notification-panel.open {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                        pointer-events: auto;
                    }
                    .notification-panel-header {
                        padding: 20px;
                        border-bottom: 1px solid rgba(0,0,0,0.06);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    html.dark .notification-panel-header {
                        border-color: rgba(255,255,255,0.08);
                    }
                    .notification-panel-header h3 {
                        font-size: 18px;
                        font-weight: 800;
                        color: #111827;
                    }
                    html.dark .notification-panel-header h3 {
                        color: #f3f4f6;
                    }
                    .notification-panel-actions {
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    }
                    .notif-action-btn {
                        font-size: 11px;
                        font-weight: 600;
                        color: #6366f1;
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 4px 8px;
                        border-radius: 8px;
                        transition: background 0.2s;
                    }
                    .notif-action-btn:hover {
                        background: rgba(99,102,241,0.1);
                    }
                    .notif-close-btn {
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        background: rgba(0,0,0,0.05);
                        border: none;
                        cursor: pointer;
                        font-size: 14px;
                        color: #6b7280;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    html.dark .notif-close-btn {
                        background: rgba(255,255,255,0.1);
                        color: #9ca3af;
                    }
                    .notif-close-btn:hover {
                        background: rgba(239,68,68,0.1);
                        color: #ef4444;
                    }

                    /* Notification List */
                    .notification-list {
                        flex: 1;
                        overflow-y: auto;
                        padding: 12px;
                    }
                    .notification-empty {
                        text-align: center;
                        padding: 40px 20px;
                        color: #9ca3af;
                    }
                    .notification-empty p {
                        margin-top: 12px;
                        font-size: 14px;
                    }
                    .notification-item {
                        padding: 14px 16px;
                        background: rgba(0,0,0,0.02);
                        border-radius: 16px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        border-left: 3px solid transparent;
                    }
                    html.dark .notification-item {
                        background: rgba(255,255,255,0.04);
                    }
                    .notification-item:hover {
                        background: rgba(99,102,241,0.08);
                    }
                    .notification-item.unread {
                        background: rgba(99,102,241,0.08);
                        border-left-color: #6366f1;
                    }
                    html.dark .notification-item.unread {
                        background: rgba(99,102,241,0.15);
                    }
                    .notification-item-header {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin-bottom: 6px;
                    }
                    .notification-icon {
                        font-size: 20px;
                        flex-shrink: 0;
                    }
                    .notification-title {
                        font-size: 14px;
                        font-weight: 700;
                        color: #111827;
                        flex: 1;
                    }
                    html.dark .notification-title {
                        color: #f3f4f6;
                    }
                    .notification-time {
                        font-size: 11px;
                        color: #9ca3af;
                    }
                    .notification-body {
                        font-size: 13px;
                        color: #6b7280;
                        line-height: 1.5;
                        padding-left: 30px;
                    }
                    html.dark .notification-body {
                        color: #9ca3af;
                    }
                `;
                document.head.appendChild(style);
            },

            // Toggle panel visibility
            togglePanel: function () {
                const panel = document.getElementById('notification-panel');
                if (panel) {
                    panel.classList.toggle('open');
                    if (panel.classList.contains('open')) {
                        this.renderNotifications();
                    }
                }
            },

            // Update badge count
            updateBadge: function () {
                const badge = document.getElementById('notification-badge');
                if (badge) {
                    badge.textContent = this.unreadCount;
                    badge.classList.toggle('visible', this.unreadCount > 0);
                }
            },

            // Render notifications list
            renderNotifications: function () {
                const list = document.getElementById('notification-list');
                if (!list) return;

                if (this.notifications.length === 0) {
                    list.innerHTML = `
                        <div class="notification-empty">
                            <span class="text-4xl">🔕</span>
                            <p>Henüz bildirim yok</p>
                        </div>
                    `;
                    return;
                }

                // Sort by date, newest first
                const sorted = [...this.notifications].sort((a, b) => new Date(b.date) - new Date(a.date));

                list.innerHTML = sorted.map(n => `
                    <div class="notification-item ${n.read ? '' : 'unread'}" onclick="window.NotificationSystem.markRead('${n.id}')">
                        <div class="notification-item-header">
                            <span class="notification-icon">${n.icon || '🔔'}</span>
                            <span class="notification-title">${n.title}</span>
                            <span class="notification-time">${this.formatTime(n.date)}</span>
                        </div>
                        <div class="notification-body">${n.body}</div>
                    </div>
                `).join('');
            },

            // Format time ago
            formatTime: function (date) {
                const now = new Date();
                const diff = now - new Date(date);
                const mins = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (mins < 1) return 'Şimdi';
                if (mins < 60) return `${mins}dk`;
                if (hours < 24) return `${hours}sa`;
                if (days < 7) return `${days}g`;
                return new Date(date).toLocaleDateString('tr-TR');
            },

            // Add in-app notification
            addNotification: function (title, body, icon = '🔔', type = 'info') {
                const notif = {
                    id: 'notif_' + Date.now(),
                    title,
                    body,
                    icon,
                    type,
                    date: new Date().toISOString(),
                    read: false
                };

                this.notifications.unshift(notif);
                this.unreadCount++;
                this.save();
                this.updateBadge();

                // Show toast as well
                if (window.showPremiumToast) {
                    window.showPremiumToast({
                        type: type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info',
                        title: title,
                        message: body,
                        duration: 4000
                    });
                }

                return notif;
            },

            // Mark single notification as read
            markRead: function (id) {
                const notif = this.notifications.find(n => n.id === id);
                if (notif && !notif.read) {
                    notif.read = true;
                    this.unreadCount = Math.max(0, this.unreadCount - 1);
                    this.save();
                    this.updateBadge();
                    this.renderNotifications();
                }
            },

            // Mark all as read
            markAllRead: function () {
                this.notifications.forEach(n => n.read = true);
                this.unreadCount = 0;
                this.save();
                this.updateBadge();
                this.renderNotifications();
            },

            // Save to localStorage
            save: function () {
                localStorage.setItem('fingo_notifications', JSON.stringify(this.notifications.slice(0, 50)));
            },

            // Run smart checks
            runSmartChecks: function () {
                this.checkBudgetLimits();
                this.checkStreakStatus();
                this.checkSavingsGoals();
            },

            // Check budget limits
            checkBudgetLimits: function () {
                try {
                    const APP_YEAR = new Date().getFullYear();
                    const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                    const budgets = JSON.parse(localStorage.getItem('fingo_category_budgets') || '{}');
                    const currentMonth = new Date().getMonth();

                    const monthlyExpenses = {};
                    transactions.filter(t => {
                        const d = new Date(t.date);
                        return t.type === 'expense' && d.getMonth() === currentMonth;
                    }).forEach(t => {
                        const cat = t.category || 'Diğer';
                        monthlyExpenses[cat] = (monthlyExpenses[cat] || 0) + Math.abs(t.amount);
                    });

                    Object.keys(budgets).forEach(cat => {
                        const limit = budgets[cat];
                        const spent = monthlyExpenses[cat] || 0;
                        const percent = (spent / limit) * 100;

                        if (percent >= 90 && percent < 100) {
                            this.addNotification(
                                'Bütçe Uyarısı',
                                `${cat} bütçenizin %${Math.round(percent)}'ini kullandınız. Dikkatli olun!`,
                                '⚠️',
                                'warning'
                            );
                        } else if (percent >= 100) {
                            this.addNotification(
                                'Bütçe Aşıldı!',
                                `${cat} bütçenizi aştınız! (₺${spent.toLocaleString('tr-TR')} / ₺${limit.toLocaleString('tr-TR')})`,
                                '🚨',
                                'error'
                            );
                        }
                    });
                } catch (e) {
                    console.warn('[Notifications] Budget check failed:', e);
                }
            },

            // Check streak status
            checkStreakStatus: function () {
                try {
                    const streak = JSON.parse(localStorage.getItem('fingo_streak') || '{}');
                    const today = new Date().toDateString();
                    const lastEntry = streak.lastEntryDate;

                    if (lastEntry && lastEntry !== today) {
                        const lastDate = new Date(lastEntry);
                        const diff = Math.floor((new Date() - lastDate) / 86400000);

                        if (diff === 1 && streak.count > 3) {
                            this.addNotification(
                                'Streak Uyarısı',
                                `🔥 ${streak.count} günlük streak'ini kaybetme! Bugün henüz kayıt yapmadın.`,
                                '🔥',
                                'warning'
                            );
                        }
                    }
                } catch (e) {
                    console.warn('[Notifications] Streak check failed:', e);
                }
            },

            // Check savings goals
            checkSavingsGoals: function () {
                try {
                    const goals = JSON.parse(localStorage.getItem('fingo_savings_goals') || '[]');

                    goals.forEach(goal => {
                        const percent = (goal.current / goal.target) * 100;
                        if (percent >= 90 && percent < 100) {
                            this.addNotification(
                                'Hedefe Yaklaştın!',
                                `"${goal.name}" hedefine %${Math.round(100 - percent)} kaldı! 🎯`,
                                '🎯',
                                'success'
                            );
                        }
                    });
                } catch (e) {
                    console.warn('[Notifications] Savings check failed:', e);
                }
            },

            // Send native/web notification
            send: async function (title, body, options = {}) {
                if (!this.isEnabled) return;

                // Capacitor
                if (window.Capacitor?.Plugins?.LocalNotifications) {
                    await window.Capacitor.Plugins.LocalNotifications.schedule({
                        notifications: [{
                            id: Date.now(),
                            title,
                            body,
                            schedule: { at: options.at || new Date() }
                        }]
                    });
                }
                // Web
                else if ('Notification' in window) {
                    new Notification(title, { body, icon: 'Logo.jpg' });
                }
            },

            scheduleDailyReminder: async function (hour = 20, minute = 0) {
                if (!this.isEnabled) return;

                const now = new Date();
                const scheduled = new Date();
                scheduled.setHours(hour, minute, 0, 0);

                if (scheduled <= now) {
                    scheduled.setDate(scheduled.getDate() + 1);
                }

                await this.send(
                    'Günlük Hatırlatma',
                    'Bugünkü harcamalarını kaydetmeyi unutma! 📝',
                    { at: scheduled }
                );
            },

            // Demo notifications
            showDemo: function () {
                // Clear existing
                this.notifications = [];
                this.unreadCount = 0;

                // Add demo notifications
                const demos = [
                    { title: 'Haftalık Özet', body: 'Bu hafta ₺2,450 harcadınız. Geçen haftadan %12 daha az! 👏', icon: '📊', type: 'success' },
                    { title: 'Bütçe Uyarısı', body: 'Yeme-İçme bütçenizin %85\'ini kullandınız. Dikkatli olun!', icon: '⚠️', type: 'warning' },
                    { title: 'Streak Başarısı', body: '🔥 7 günlük streak! Harika gidiyorsun!', icon: '🔥', type: 'success' },
                    { title: 'Hedefe Yaklaştın', body: '"Tatil Fonu" hedefine %8 kaldı! 🎯', icon: '🎯', type: 'success' },
                    { title: 'Fatura Hatırlatma', body: 'Netflix ödemesi yarın. ₺64.99', icon: '📅', type: 'info' },
                    { title: 'Yeni Rozet', body: '🏆 "Birikim Ustası" rozetini kazandınız!', icon: '🏆', type: 'success' }
                ];

                demos.forEach((d, i) => {
                    setTimeout(() => {
                        this.addNotification(d.title, d.body, d.icon, d.type);
                    }, i * 300);
                });

                console.log('[Notifications] ✨ Demo bildirimler oluşturuldu');
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 11. AKILLI HATIRLATICILAR
        // ═══════════════════════════════════════════════════════════════
        window.SmartReminders = {
            patterns: [],

            analyze: function () {
                const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                const patterns = {};

                // Tekrarlayan işlemleri bul
                transactions.forEach(t => {
                    if (t.type !== 'expense') return;

                    const key = (t.description || t.category || '').toLowerCase();
                    if (!patterns[key]) {
                        patterns[key] = { dates: [], amounts: [] };
                    }

                    patterns[key].dates.push(new Date(t.date).getDate());
                    patterns[key].amounts.push(Math.abs(t.amount));
                });

                // Pattern tespit et
                this.patterns = [];
                Object.keys(patterns).forEach(key => {
                    const p = patterns[key];
                    if (p.dates.length >= 2) {
                        // Aynı gün tekrarı var mı?
                        const dayMode = this.getMode(p.dates);
                        const avgAmount = p.amounts.reduce((a, b) => a + b, 0) / p.amounts.length;

                        if (dayMode) {
                            this.patterns.push({
                                name: key,
                                day: dayMode,
                                avgAmount: Math.round(avgAmount),
                                count: p.dates.length
                            });
                        }
                    }
                });

                return this.patterns;
            },

            getMode: function (arr) {
                const freq = {};
                arr.forEach(v => freq[v] = (freq[v] || 0) + 1);

                let maxCount = 0;
                let mode = null;

                Object.keys(freq).forEach(k => {
                    if (freq[k] > maxCount && freq[k] >= 2) {
                        maxCount = freq[k];
                        mode = parseInt(k);
                    }
                });

                return mode;
            },

            getSuggestions: function () {
                const patterns = this.analyze();
                const today = new Date();
                const currentDay = today.getDate();

                return patterns
                    .filter(p => p.day >= currentDay && p.day <= currentDay + 7)
                    .map(p => ({
                        title: p.name.charAt(0).toUpperCase() + p.name.slice(1),
                        day: p.day,
                        amount: p.avgAmount,
                        daysUntil: p.day - currentDay
                    }));
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // 12. YENİ ROZETLER & PHASE 4 UPDATES
        // ═══════════════════════════════════════════════════════════════

        // PHASE 4: GLOBAL CHART DEFAULTS (NEON GLOW)
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    Chart.defaults.color = '#94A3B8';
                    Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
                    Chart.defaults.font.family = "'Inter', sans-serif";
                    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.9)';
                    Chart.defaults.plugins.tooltip.padding = 12;
                    Chart.defaults.plugins.tooltip.cornerRadius = 12;
                }
            }, 1000);
        });

        // ═══════════════════════════════════════════════════════════════
        window.ExtendedBadges = {
            definitions: [
                { id: 'streak_week', name: '7 Gün Serisi', emoji: '🔥', desc: '7 gün üst üste görev tamamla' },
                { id: 'streak_month', name: '30 Gün Serisi', emoji: '🌟', desc: '30 gün üst üste aktif ol' },
                { id: 'first_goal', name: 'İlk Hedef', emoji: '🎯', desc: 'İlk hedefini oluştur' },
                { id: 'goal_complete', name: 'Hedef Avcısı', emoji: '🏆', desc: 'Bir hedefe ulaş' },
                { id: 'big_saver', name: 'Büyük Tasarrufçu', emoji: '💎', desc: 'Tek seferde 1000₺+ tasarruf' },
                { id: 'category_master', name: 'Kategori Ustası', emoji: '📊', desc: 'Tüm kategorilerde işlem yap' },
                { id: 'early_bird', name: 'Erken Kuş', emoji: '🌅', desc: 'Sabah 6\'dan önce işlem ekle' },
                { id: 'night_owl', name: 'Gece Kuşu', emoji: '🦉', desc: 'Gece yarısından sonra işlem ekle' },
                { id: 'budget_hero', name: 'Bütçe Kahramanı', emoji: '🦸', desc: 'Tüm ay bütçede kal' },
                { id: 'zero_impulse', name: 'Sabırlı', emoji: '🧘', desc: '7 gün dürtüsel alışveriş yapma' },
                { id: 'eco_warrior', name: 'Çevreci', emoji: '🌱', desc: 'Karbon ayak izini azalt' },
                { id: 'data_driven', name: 'Veri Odaklı', emoji: '📈', desc: 'İlk PDF raporunu oluştur' },
                { id: 'import_pro', name: 'İçe Aktarıcı', emoji: '📥', desc: 'CSV dosyası içe aktar' },
                { id: 'scanner', name: 'Tarayıcı', emoji: '📷', desc: 'İlk faturayı tara' },
                { id: 'premium_member', name: 'Premium Üye', emoji: '👑', desc: 'Premium\'a geç' }
            ],

            register: function () {
                // Mevcut rozet sistemine ekle
                if (window.BADGE_DEFINITIONS) {
                    this.definitions.forEach(badge => {
                        if (!window.BADGE_DEFINITIONS.find(b => b.id === badge.id)) {
                            window.BADGE_DEFINITIONS.push(badge);
                        }
                    });
                }
                console.log('[ExtendedBadges] ✅', this.definitions.length, 'yeni rozet kaydedildi');
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // OTOMATİK BAŞLATMA
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.DailyTasks.initialize();
                window.StreakSystem.initialize();
                window.SessionTimeout.initialize();
                window.ExtendedBadges.register();
                // window.NotificationSystem.initialize(); // Bell icon disabled

                console.log('[AdvancedFeatures] ✅ Tüm gelişmiş özellikler yüklendi!');
            }, 2500);
        });

        // Global erişim için
        window.AdvancedFeatures = {
            DailyTasks: window.DailyTasks,
            StreakSystem: window.StreakSystem,
            AnomalyDetection: window.AnomalyDetection,
            SpendingPredictor: window.SpendingPredictor,
            CarbonFootprint: window.CarbonFootprint,
            PDFReportGenerator: window.PDFReportGenerator,
            DataImporter: window.DataImporter,
            ReceiptScanner: window.ReceiptScanner,
            NotificationSystem: window.NotificationSystem,
            SmartReminders: window.SmartReminders
        };

    })();
</script>

<!-- ══════════════════════════════════════════════════════════════════
     BİRİKİM/TASARRUF İŞARETLEME SİSTEMİ
══════════════════════════════════════════════════════════════════ -->
<script>
    (function initSavingsMarker() {
        'use strict';
        const APP_YEAR = new Date().getFullYear();

        window.SavingsMarker = {
            storageKey: `fingenda_savings_marked_${APP_YEAR}`,
            markedIds: new Set(),
            // Sadece kesin birikim kategorileri (kısa kelimeler çakışma yaratabilir)
            savingsCategories: ['💵 Dolar', '💶 Euro', '🟡 Altın Gr.', '🪙 Çeyrek Altın', '💹 Yatırım', '💰 Birikim', 'Yatırım Fonu', 'Vadeli Mevduat', 'Kripto'],

            initialize: function () {
                this.loadMarked();
                this.injectHelpers();
                console.log('[SavingsMarker] ✅ Birikim işaretleyici yüklendi,', this.markedIds.size, 'işlem');
            },

            loadMarked: function () {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) this.markedIds = new Set(JSON.parse(saved));
                } catch (e) { console.warn(e); }
            },

            saveMarked: function () {
                localStorage.setItem(this.storageKey, JSON.stringify([...this.markedIds]));
            },

            toggle: function (txId) {
                if (!txId) return;
                this.markedIds.has(txId) ? this.markedIds.delete(txId) : this.markedIds.add(txId);
                this.saveMarked();
                window.renderTransactionList?.(); window.updateDashboard?.(); window.renderFullHistory?.();
                window.showMiniToast?.('Güncellendi', this.markedIds.has(txId) ? 'Birikim olarak işaretlendi' : 'İşaret kaldırıldı', '💰');
                return this.markedIds.has(txId);
            },

            isSavings: function (t) {
                if (!t) return false;
                // 1. Manuel işaretlenmiş mi?
                if (t.id && this.markedIds.has(t.id)) return true;
                // 2. isSavings bayrağı var mı?
                if (t.isSavings === true) return true;
                // 3. SADECE kategori kontrolü (açıklama değil - telefon/fon gibi çakışmalar önlenir)
                const cat = (t.category || '');
                for (const kw of this.savingsCategories) {
                    if (cat.includes(kw)) return true;
                }
                return false;
            },

            injectHelpers: function () {
                // Override KALDIRILDI - tüm mantık ana isSavingsTransaction fonksiyonunda
                // setTimeout(() => console.log('[SavingsMarker] Helpers loaded'), 100);
            },

            renderToggleButton: function (t) {
                if (!t || t.type !== 'expense') return '';
                const active = this.isSavings(t);
                return `<button onclick="event.stopPropagation();SavingsMarker.toggle('${t.id}')" class="savings-toggle-btn ${active ? 'active' : ''}" title="${active ? 'Birikim işaretini kaldır' : 'Birikim olarak işaretle'}">${active ? '💰' : '💸'}</button>`;
            },

            addSavingsTransaction: function (amt, cat, desc) {
                const txs = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                const tx = { id: 'sav_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9), date: new Date().toISOString(), amount: Math.abs(amt), type: 'expense', category: cat || '💰 Birikim', description: desc || 'Tasarruf', isSavings: true, createdAt: Date.now() };
                txs.push(tx);
                localStorage.setItem(`my_expenses_${APP_YEAR}`, JSON.stringify(txs));
                window.renderTransactionList?.(); window.updateDashboard?.();
                window.showMiniToast?.('Birikim Eklendi', `${amt.toLocaleString('tr-TR')} ₺`, '💰');
                return tx;
            },

            showQuickSaveModal: function () {
                const html = `<div id="quick-save-modal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4" onclick="if(event.target===this)this.remove()"><div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div><div class="relative glass-card p-6 rounded-3xl max-w-sm w-full animate-fade-in-up"><h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">💰 Hızlı Birikim</h3><div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Tutar (₺)</label><input type="number" id="quick-save-amount" placeholder="0" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800 text-lg font-bold mt-1"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Kategori</label><select id="quick-save-category" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800 text-sm mt-1"><option value="💰 Birikim">💰 Genel Birikim</option><option value="💵 Dolar">💵 Dolar</option><option value="💶 Euro">💶 Euro</option><option value="🟡 Altın Gr.">🟡 Altın (Gram)</option><option value="🪙 Çeyrek Altın">🪙 Çeyrek Altın</option><option value="💹 Yatırım Fonu">💹 Yatırım Fonu</option></select></div><div><label class="text-xs font-bold text-gray-500 uppercase">Not</label><input type="text" id="quick-save-note" placeholder="Örn: Aylık birikim" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800 text-sm mt-1"></div></div><div class="flex gap-3 mt-6"><button onclick="document.getElementById('quick-save-modal').remove()" class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold">Vazgeç</button><button onclick="SavingsMarker.submitQuickSave()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold shadow-lg">💰 Kaydet</button></div></div></div>`;
                document.body.insertAdjacentHTML('beforeend', html);
                document.getElementById('quick-save-amount').focus();
            },

            submitQuickSave: function () {
                const amt = parseFloat(document.getElementById('quick-save-amount').value);
                if (!amt || amt <= 0) { window.alertMessage?.('Hata', 'Geçerli tutar girin', 'red'); return; }
                this.addSavingsTransaction(amt, document.getElementById('quick-save-category').value, document.getElementById('quick-save-note').value);
                document.getElementById('quick-save-modal').remove();
            }
        };

        // CSS
        const s = document.createElement('style');
        s.textContent = `.savings-toggle-btn{width:28px;height:28px;border-radius:50%;border:none;background:rgba(0,0,0,.05);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:all .2s;flex-shrink:0}.savings-toggle-btn:hover{transform:scale(1.15);background:rgba(16,185,129,.15)}.savings-toggle-btn.active{background:linear-gradient(135deg,rgba(16,185,129,.2),rgba(52,211,153,.2));box-shadow:0 0 12px rgba(16,185,129,.3)}html.dark .savings-toggle-btn{background:rgba(255,255,255,.05)}html.dark .savings-toggle-btn.active{background:rgba(16,185,129,.25)}.transaction-item.is-savings,.transaction-card.is-savings{border-left:3px solid #10b981!important;background:linear-gradient(90deg,rgba(16,185,129,.08),transparent)!important}`;
        document.head.appendChild(s);

        document.addEventListener('DOMContentLoaded', () => setTimeout(() => window.SavingsMarker.initialize(), 3000));
    })();
</script>

<!-- HOLOGRAPHIC PULSE WIDGET UPDATER -->
<script>
    (function initHoloPulseWidget() {
        'use strict';

        function formatCurrency(val) {
            if (typeof val !== 'number' || isNaN(val)) return '0 ₺';
            return val.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';
        }

        function formatCurrencyShort(val) {
            if (typeof val !== 'number' || isNaN(val)) return '0₺';
            if (Math.abs(val) >= 1000000) return (val / 1000000).toFixed(1) + 'M₺';
            if (Math.abs(val) >= 1000) return (val / 1000).toFixed(1) + 'K₺';
            return val.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + '₺';
        }

        window.updateHoloPulseWidget = function () {
            try {
                const APP_YEAR = new Date().getFullYear();
                const APP_MONTH = new Date().getMonth() + 1;
                const txKey = `fingenda_transactions_${APP_YEAR}`;
                const allTx = JSON.parse(localStorage.getItem(txKey) || '[]');

                // Filter current month transactions
                const monthTx = allTx.filter(t => {
                    if (!t.date) return false;
                    const d = new Date(t.date);
                    return d.getMonth() + 1 === APP_MONTH && d.getFullYear() === APP_YEAR;
                });

                let income = 0, expense = 0, savings = 0;

                monthTx.forEach(t => {
                    const amt = parseFloat(t.amount) || 0;
                    const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : false;

                    if (t.type === 'income') {
                        income += amt;
                    } else if (t.type === 'expense') {
                        if (isSavings) {
                            savings += amt;
                        } else {
                            expense += amt;
                        }
                    }
                });

                const netChange = income - expense - savings;

                // Update DOM
                const pulseVal = document.getElementById('holo-pulse-value');
                const incomeMini = document.getElementById('holo-income-mini');
                const expenseMini = document.getElementById('holo-expense-mini');
                const savingsMini = document.getElementById('holo-savings-mini');

                if (pulseVal) {
                    const span = pulseVal.querySelector('span');
                    if (span) span.textContent = formatCurrency(netChange);
                }
                if (incomeMini) incomeMini.textContent = formatCurrencyShort(income);
                if (expenseMini) expenseMini.textContent = formatCurrencyShort(expense);
                if (savingsMini) savingsMini.textContent = formatCurrencyShort(savings);

            } catch (e) {
                console.warn('[HoloPulse] Update failed:', e);
            }
        };

        // Auto-update after page load and on transaction changes
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(window.updateHoloPulseWidget, 1500);
        });

        // Listen for custom events that might update transactions
        ['fingenda_data_updated', 'storage'].forEach(evt => {
            window.addEventListener(evt, () => setTimeout(window.updateHoloPulseWidget, 500));
        });

        console.log('[HoloPulseWidget] ✅ Holografik Nabız Widget yüklendi');
    })();
</script>

<!--
═══════════════════════════════════════════════════════════════════════════════
            APPLE AWARD DESIGN SYSTEM v2 - NE DEĞİŞTİ?
            Soft Neumorphism + Frosted Glass + Capsule UI
═══════════════════════════════════════════════════════════════════════════════

📦 YENİ TOKEN'LAR (~100 değişken):
─────────────────────────────────
--neo-space-*     : 8px grid spacing sistemi (1-12)
--neo-r-*         : Radius: base(24), card(28), sheet(36), capsule(9999)
--neo-text-*      : Typography: xs(11)-3xl(28), weight: regular-bold
--neo-bg/surface  : Arkaplan ve yüzey renkleri
--neo-stroke      : Border renkleri (light/strong)
--neo-text-*      : Primary, secondary, tertiary, muted metinler
--neo-accent-*    : Apple-style accent colors (indigo, purple, success, danger)
--neo-shadow-*    : ambient, lift, soft, inset, inner-highlight, float, pressed
--glass-bg        : Frosted glass backgrounds (normal/elevated)
--glass-blur      : blur(18px) + saturate(150%)
--glass-border    : Cam efekti border

🎨 YENİ UTILITY CLASSLAR:
────────────────────────
.soft-surface     : Sayfa arkaplanı (aurora gradient)
.soft-card        : Neumorphic glass kart
.capsule          : Pill shape (44-52px min height)
.capsule-item     : Liste satırı (transaction list için)
.soft-btn         : Primary/secondary buton
.chip-badge       : Pro/Free/New badge'leri
.icon-bubble      : Yuvarlak ikon container
.glass-sheet      : Modal arkaplanı
.search-capsule   : Arama çubuğu
.neo-title/value  : Tipografi helpers

🔧 OVERRİDE EDİLEN BİLEŞENLER:
─────────────────────────────
.glass-card       → neo-tokens ile güncellendi
.widget-card-apple→ lift shadow + press animation
.pw-widget        → neo-tokens entegrasyonu
.transaction-card → capsule-style
#user-plan-badge  → chip-badge stili
.month-pill       → capsule radius
.modal-content    → glass-sheet tokens
#app-nav          → floating glass nav
button[bg-indigo] → soft-btn gradient

⚙️ PERFORMANS:
──────────────
html.perf: blur(8px) fallback
@media reduced-motion: animasyonlar iptal

═══════════════════════════════════════════════════════════════════════════════
                        TEST CHECKLIST
═══════════════════════════════════════════════════════════════════════════════
[ ] 1. Light/Dark geçişi: Kartlar ve metinler okunuyor mu?
[ ] 2. Press animasyonları: Kartlara basınca scale(0.98) çalışıyor mu?
[ ] 3. Modal blur: glass-sheet efekti düzgün mü?
[ ] 4. Mobil safe-area: Alt nav padding doğru mu?
[ ] 5. Performans: Scroll ederken FPS düşüşü yok mu?
[ ] 6. Typography: Value/label kontrast yeterli mi?
═══════════════════════════════════════════════════════════════════════════════
-->
<style>
    /* Floating Navigation Bar Redesign */
    #nav-container {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        border-top: none !important;
        box-shadow: none !important;
        margin-bottom: constant(safe-area-inset-bottom);
        margin-bottom: env(safe-area-inset-bottom);
        padding-bottom: constant(safe-area-inset-bottom) !important;
        padding-bottom: env(safe-area-inset-bottom) !important;
    }

    html.dark #nav-container {
        background: transparent !important;
        border-top: none !important;
        box-shadow: none !important;
    }

    #nav-blob {
        background: linear-gradient(135deg, var(--neo-accent-indigo), var(--neo-accent-purple)) !important;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.5) !important;
        opacity: 0.9;
    }

    canvas {
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.1));
    }
</style>

<!-- DASHBOARD WIDGET REORDERING SYSTEM -->
<style>
    /* Drag & Drop Visuals */
    .dashboard-widget {
        transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.2s, opacity 0.2s;
        cursor: grab;
    }

    .dashboard-widget:active {
        cursor: grabbing;
    }

    .dashboard-widget.dragging {
        opacity: 0.4;
        transform: scale(0.95);
        border: 2px dashed #6366f1;
        box-shadow: none !important;
    }

    .dashboard-drop-zone {
        transition: background-color 0.2s, border-radius 0.2s;
        min-height: 100px;
        /* Ensure empty zones are targetable */
    }

    .dashboard-drop-zone.zone-active {
        /* Optional: Highlight potential drop zones during drag */
        opacity: 1;
        /* Prevents empty ruleset warning */
    }

    .dashboard-drop-zone.drag-over {
        background-color: rgba(99, 102, 241, 0.05);
        /* Light Indigo Tint */
        border-radius: 20px;
        position: relative;
    }

    .dashboard-drop-zone.drag-over::after {
        content: '';
        position: absolute;
        inset: 0;
        border: 2px dashed #6366f1;
        border-radius: 20px;
        pointer-events: none;
        opacity: 0.3;
    }
</style>

<script>
    (function initDashboardDragManager() {
        'use strict';
        const STORAGE_KEY = 'fingenda_dashboard_layout_v1';

        // --- 1. Selectors & Init ---
        // USER REQ: Using Array.from to correct NodeList handling
        const getWidgets = () => Array.from(document.querySelectorAll('.dashboard-widget'));
        const getDropZones = () => Array.from(document.querySelectorAll('.dashboard-drop-zone'));

        let draggedItem = null;

        function init() {
            // Restore Layout first to prevent visual jump
            loadWidgetOrder();

            // Attach Widget Listeners
            const widgets = getWidgets();
            widgets.forEach(w => {
                w.setAttribute('draggable', 'true'); // Ensure attribute
                w.addEventListener('dragstart', handleDragStart);
                w.addEventListener('dragend', handleDragEnd);
            });

            // Attach Zone Listeners
            const zones = getDropZones();
            zones.forEach(z => {
                z.addEventListener('dragover', handleDragOver);
                z.addEventListener('dragenter', handleDragEnter);
                z.addEventListener('dragleave', handleDragLeave);
                z.addEventListener('drop', handleDrop);
            });

            console.log('[DragManager] Initialized for', widgets.length, 'widgets.');
        }

        // --- 2. Event Handlers ---
        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.widgetId);

            // Optional: Haptic feedback if available via Navigator
            if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(10);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedItem = null;
            getDropZones().forEach(z => {
                z.classList.remove('drag-over');
                z.classList.remove('zone-active');
            });
        }

        function handleDragEnter(e) {
            e.preventDefault();
            // Highlight the Drop Zone
            if (this.classList.contains('dashboard-drop-zone')) {
                this.classList.add('drag-over');
            }
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragLeave(e) {
            if (this.classList.contains('dashboard-drop-zone')) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();

            this.classList.remove('drag-over');

            if (draggedItem && this.classList.contains('dashboard-drop-zone')) {
                // Determine insertion position based on Y coordinate
                const afterElement = getDragAfterElement(this, e.clientY);

                if (afterElement == null) {
                    this.appendChild(draggedItem);
                } else {
                    this.insertBefore(draggedItem, afterElement);
                }

                // Save the new order
                saveWidgetOrder();
            }
            return false;
        }

        // Helper: Find closest sibling to drop position
        function getDragAfterElement(container, y) {
            // Get all other draggable elements in this container
            const draggableElements = [...container.querySelectorAll('.dashboard-widget:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                // Check distance to vertical center of child
                const offset = y - box.top - box.height / 2;

                // We want the element where we are *above* its center (offset < 0)
                // and closest to 0 (largest negative number)
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- 3. Persistence Logic ---
        function saveWidgetOrder() {
            const layout = {};
            const zones = getDropZones();

            zones.forEach(zone => {
                if (zone.id) {
                    // USER REQ: Array.from equivalent logic
                    const widgets = Array.from(zone.querySelectorAll('.dashboard-widget'));
                    layout[zone.id] = widgets.map(w => w.dataset.widgetId).filter(Boolean);
                }
            });

            localStorage.setItem(STORAGE_KEY, JSON.stringify(layout));
            // Optional: Notify dashboard to re-init specific widgets if needed (e.g. charts resize)
            // window.dispatchEvent(new Event('dashboard_layout_changed'));
        }

        function loadWidgetOrder() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            try {
                const layout = JSON.parse(saved);
                const allWidgets = getWidgets();
                const widgetMap = {}; // Map ID -> Element

                allWidgets.forEach(w => {
                    if (w.dataset.widgetId) widgetMap[w.dataset.widgetId] = w;
                });

                Object.keys(layout).forEach(zoneId => {
                    const targetZone = document.getElementById(zoneId);
                    if (targetZone) {
                        const widgetIds = layout[zoneId];
                        widgetIds.forEach(wId => {
                            const widget = widgetMap[wId];
                            if (widget) {
                                targetZone.appendChild(widget); // Moves existing element to new parent/position
                            }
                        });
                    }
                });
            } catch (err) {
                console.warn('[DragManager] Layout restore failed:', err);
            }
        }

        // --- 4. Boot ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
</script>

<script>
    (function disablePullToRefresh() {
        'use strict';

        // 1. Prevent iOS/Chrome overscroll reload logic
        // Only prevent if we are at the top of the page AND pulling down
        let startY = 0;

        document.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            const y = e.touches[0].clientY;
            // Handle cases where scrollTop might be on body or html
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;

            // If at top and pulling down
            if (scrollTop <= 0 && y > startY) {
                // Ensure this isn't a scrollable inner container
                const target = e.target;
                const scrollableParent = target.closest && target.closest('.overflow-y-auto, .overflow-auto, .scrollable');

                if (!scrollableParent || scrollableParent.scrollTop === 0) {
                    if (e.cancelable) e.preventDefault();
                }
            }
        }, { passive: false }); // passive: false is critical for preventDefault
        console.log('[System] Pull-to-refresh disabled.');
    })();
</script>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- KAPSAMLI GELİŞTİRME MODÜLÜ v1.0                                             -->
<!-- Skeleton Loading, Pull-to-Refresh, Swipe Actions, Quick Actions            -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<style>
    /* ══════════════════════════════════════════════════════════════════ */
    /* 1. SKELETON LOADING                                                 */
    /* ══════════════════════════════════════════════════════════════════ */
    .skeleton {
        background: linear-gradient(90deg,
                rgba(200, 200, 200, 0.2) 0%,
                rgba(200, 200, 200, 0.4) 50%,
                rgba(200, 200, 200, 0.2) 100%);
        background-size: 200% 100%;
        animation: skeletonShimmer 1.5s ease-in-out infinite;
        border-radius: 8px;
    }

    html.dark .skeleton {
        background: linear-gradient(90deg,
                rgba(255, 255, 255, 0.05) 0%,
                rgba(255, 255, 255, 0.12) 50%,
                rgba(255, 255, 255, 0.05) 100%);
        background-size: 200% 100%;
    }

    @keyframes skeletonShimmer {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    .skeleton-text {
        height: 14px;
        margin-bottom: 8px;
    }

    .skeleton-title {
        height: 24px;
        width: 60%;
        margin-bottom: 12px;
    }

    .skeleton-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
    }

    .skeleton-card {
        padding: 20px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        margin-bottom: 12px;
    }

    html.dark .skeleton-card {
        background: rgba(30, 30, 40, 0.6);
    }

    /* ══════════════════════════════════════════════════════════════════ */
    /* 2. PULL-TO-REFRESH                                                  */
    /* ══════════════════════════════════════════════════════════════════ */
    .ptr-container {
        position: relative;
        overflow-y: auto;
        overscroll-behavior-y: contain;
    }

    .ptr-indicator {
        position: absolute;
        top: -60px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(99, 102, 241, 0.15);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 100;
    }

    .ptr-indicator.visible {
        opacity: 1;
        top: 20px;
    }

    .ptr-indicator.refreshing .ptr-icon {
        animation: ptrSpin 0.8s linear infinite;
    }

    .ptr-icon {
        width: 24px;
        height: 24px;
        color: #6366f1;
        transition: transform 0.2s ease;
    }

    @keyframes ptrSpin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* ══════════════════════════════════════════════════════════════════ */
    /* 3. SWIPE ACTIONS                                                    */
    /* ══════════════════════════════════════════════════════════════════ */
    .swipe-container {
        position: relative;
        overflow: hidden;
        touch-action: pan-y;
    }

    .swipe-content {
        position: relative;
        z-index: 2;
        background: inherit;
        transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .swipe-actions {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        display: flex;
        align-items: stretch;
        z-index: 1;
    }

    .swipe-action {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 80px;
        font-size: 12px;
        font-weight: 700;
        color: white;
        cursor: pointer;
    }

    .swipe-action-edit {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .swipe-action-delete {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    /* ══════════════════════════════════════════════════════════════════ */
    /* 4. QUICK ACTIONS WIDGET                                             */
    /* ══════════════════════════════════════════════════════════════════ */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        padding: 16px;
        margin: 16px 0;
    }

    .quick-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px 8px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    html.dark .quick-action-btn {
        background: rgba(40, 40, 50, 0.8);
        border-color: rgba(255, 255, 255, 0.08);
    }

    .quick-action-btn:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
    }

    .quick-action-btn:active {
        transform: scale(0.95);
    }

    .quick-action-icon {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
    }

    .quick-action-icon.income {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .quick-action-icon.expense {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .quick-action-icon.transfer {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
    }

    .quick-action-icon.scan {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .quick-action-label {
        font-size: 11px;
        font-weight: 600;
        color: #374151;
        text-align: center;
    }

    html.dark .quick-action-label {
        color: #d1d5db;
    }

    /* ══════════════════════════════════════════════════════════════════ */
    /* 5. MINI SPARKLINE                                                   */
    /* ══════════════════════════════════════════════════════════════════ */
    .sparkline {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 30px;
        padding: 4px 0;
    }

    .sparkline-bar {
        flex: 1;
        min-width: 4px;
        max-width: 8px;
        border-radius: 2px;
        background: rgba(99, 102, 241, 0.3);
        transition: height 0.3s ease, background 0.3s ease;
    }

    .sparkline-bar.positive {
        background: linear-gradient(to top, #10b981, #34d399);
    }

    .sparkline-bar.negative {
        background: linear-gradient(to top, #ef4444, #f87171);
    }

    /* ══════════════════════════════════════════════════════════════════ */
    /* 6. ENHANCED SEARCH                                                  */
    /* ══════════════════════════════════════════════════════════════════ */
    .search-enhanced {
        position: relative;
    }

    .search-enhanced input {
        width: 100%;
        padding: 14px 48px 14px 48px;
        border-radius: 16px;
        border: 2px solid transparent;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        font-size: 15px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    html.dark .search-enhanced input {
        background: rgba(30, 30, 40, 0.9);
        color: #f3f4f6;
    }

    .search-enhanced input:focus {
        border-color: rgba(99, 102, 241, 0.5);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .search-enhanced .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }

    .search-enhanced .search-clear {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.1);
        border: none;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #6b7280;
    }

    .search-enhanced input:not(:placeholder-shown)+.search-icon+.search-clear {
        display: flex;
    }

    /* ══════════════════════════════════════════════════════════════════ */
    /* 7. KEYBOARD FOCUS STYLES                                            */
    /* ══════════════════════════════════════════════════════════════════ */
    .focus-visible-ring:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
    }

    [tabindex]:focus-visible {
        outline: 2px solid #6366f1;
        outline-offset: 2px;
    }
</style>

<script>
    (function () {
        'use strict';

        // ══════════════════════════════════════════════════════════════════
        // ENHANCEMENT MODULE v1.0
        // ══════════════════════════════════════════════════════════════════

        // ─────────────────────────────────────────────────────────────────
        // 1. SKELETON LOADING SYSTEM
        // ─────────────────────────────────────────────────────────────────
        window.SkeletonLoader = {
            create: function (type = 'card', count = 3) {
                const skeletons = [];
                for (let i = 0; i < count; i++) {
                    const div = document.createElement('div');
                    if (type === 'card') {
                        div.className = 'skeleton-card';
                        div.innerHTML = `
                        <div class="flex items-center gap-3 mb-3">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="flex-1">
                                <div class="skeleton skeleton-text" style="width:70%"></div>
                                <div class="skeleton skeleton-text" style="width:40%"></div>
                            </div>
                        </div>
                        <div class="skeleton skeleton-text" style="width:90%"></div>
                        <div class="skeleton skeleton-text" style="width:60%"></div>
                    `;
                    } else if (type === 'list') {
                        div.className = 'flex items-center gap-3 p-4';
                        div.innerHTML = `
                        <div class="skeleton" style="width:40px;height:40px;border-radius:12px"></div>
                        <div class="flex-1">
                            <div class="skeleton skeleton-text" style="width:60%"></div>
                            <div class="skeleton skeleton-text" style="width:40%"></div>
                        </div>
                        <div class="skeleton" style="width:60px;height:20px"></div>
                    `;
                    }
                    skeletons.push(div);
                }
                return skeletons;
            },

            show: function (container, type = 'card', count = 3) {
                if (!container) return;
                container.innerHTML = '';
                this.create(type, count).forEach(s => container.appendChild(s));
            },

            hide: function (container) {
                if (!container) return;
                container.querySelectorAll('.skeleton-card, .skeleton').forEach(s => s.remove());
            }
        };

        // ─────────────────────────────────────────────────────────────────
        // 2. PULL-TO-REFRESH
        // ─────────────────────────────────────────────────────────────────
        window.PullToRefresh = {
            threshold: 80,

            init: function (container, onRefresh) {
                if (!container || !('ontouchstart' in window)) return;

                let startY = 0;
                let currentY = 0;
                let pulling = false;

                // Create indicator
                const indicator = document.createElement('div');
                indicator.className = 'ptr-indicator';
                indicator.innerHTML = `
                <svg class="ptr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            `;
                container.style.position = 'relative';
                container.insertBefore(indicator, container.firstChild);

                container.addEventListener('touchstart', (e) => {
                    if (container.scrollTop <= 0) {
                        startY = e.touches[0].pageY;
                        pulling = true;
                    }
                }, { passive: true });

                container.addEventListener('touchmove', (e) => {
                    if (!pulling) return;
                    currentY = e.touches[0].pageY;
                    const diff = currentY - startY;

                    if (diff > 0 && container.scrollTop <= 0) {
                        const progress = Math.min(diff / this.threshold, 1);
                        indicator.classList.add('visible');
                        indicator.style.transform = `translateX(-50%) translateY(${diff * 0.4}px)`;
                        indicator.querySelector('.ptr-icon').style.transform = `rotate(${progress * 180}deg)`;
                    }
                }, { passive: true });

                container.addEventListener('touchend', async () => {
                    if (!pulling) return;
                    pulling = false;
                    const diff = currentY - startY;

                    if (diff > this.threshold && container.scrollTop <= 0) {
                        indicator.classList.add('refreshing');

                        // Haptic feedback
                        if (window.HapticFeedback) window.HapticFeedback.impact('medium');

                        if (onRefresh) await onRefresh();

                        await new Promise(r => setTimeout(r, 500));
                    }

                    indicator.classList.remove('visible', 'refreshing');
                    indicator.style.transform = 'translateX(-50%)';
                }, { passive: true });
            }
        };

        // ─────────────────────────────────────────────────────────────────
        // 3. HAPTIC FEEDBACK
        // ─────────────────────────────────────────────────────────────────
        window.HapticFeedback = {
            isSupported: function () {
                return 'vibrate' in navigator ||
                    (window.Capacitor?.Plugins?.Haptics);
            },

            impact: function (style = 'light') {
                const durations = { light: 10, medium: 20, heavy: 30 };

                if (window.Capacitor?.Plugins?.Haptics) {
                    window.Capacitor.Plugins.Haptics.impact({ style: style.toUpperCase() });
                } else if ('vibrate' in navigator) {
                    navigator.vibrate(durations[style] || 10);
                }
            },

            selection: function () {
                this.impact('light');
            },

            notification: function (type = 'success') {
                const patterns = {
                    success: [10, 50, 10],
                    warning: [20, 40, 20],
                    error: [30, 30, 30, 30, 30]
                };

                if ('vibrate' in navigator) {
                    navigator.vibrate(patterns[type] || patterns.success);
                }
            }
        };

        // ─────────────────────────────────────────────────────────────────
        // 4. SWIPE ACTIONS
        // ─────────────────────────────────────────────────────────────────
        window.SwipeActions = {
            init: function (element, actions = {}) {
                if (!element) return;

                let startX = 0;
                let currentX = 0;
                let isDragging = false;
                const threshold = 80;

                // Wrap content
                const content = element.querySelector('.swipe-content') || element;

                // Create actions container
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'swipe-actions';

                if (actions.edit) {
                    const editBtn = document.createElement('div');
                    editBtn.className = 'swipe-action swipe-action-edit';
                    editBtn.innerHTML = '✏️<br>Düzenle';
                    editBtn.onclick = () => {
                        this.reset(element);
                        actions.edit();
                    };
                    actionsDiv.appendChild(editBtn);
                }

                if (actions.delete) {
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'swipe-action swipe-action-delete';
                    deleteBtn.innerHTML = '🗑️<br>Sil';
                    deleteBtn.onclick = () => {
                        this.reset(element);
                        actions.delete();
                    };
                    actionsDiv.appendChild(deleteBtn);
                }

                element.classList.add('swipe-container');
                element.insertBefore(actionsDiv, element.firstChild);

                element.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].pageX;
                    isDragging = true;
                    content.style.transition = 'none';
                }, { passive: true });

                element.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].pageX;
                    const diff = Math.min(0, currentX - startX);
                    const maxSwipe = -160;
                    const translateX = Math.max(diff, maxSwipe);
                    content.style.transform = `translateX(${translateX}px)`;
                }, { passive: true });

                element.addEventListener('touchend', () => {
                    isDragging = false;
                    content.style.transition = '';
                    const diff = currentX - startX;

                    if (diff < -threshold) {
                        content.style.transform = 'translateX(-160px)';
                        window.HapticFeedback?.selection();
                    } else {
                        this.reset(element);
                    }
                }, { passive: true });
            },

            reset: function (element) {
                const content = element.querySelector('.swipe-content') || element;
                content.style.transform = 'translateX(0)';
            }
        };

        // ─────────────────────────────────────────────────────────────────
        // 5. QUICK ACTIONS WIDGET
        // ─────────────────────────────────────────────────────────────────
        window.QuickActions = {
            create: function () {
                const container = document.createElement('div');
                container.className = 'quick-actions';
                container.id = 'quick-actions-widget';

                const actions = [
                    { icon: '💰', label: 'Gelir', class: 'income', action: () => { window.switchTab?.('add'); window.setRecordType?.('income'); } },
                    { icon: '💸', label: 'Gider', class: 'expense', action: () => { window.switchTab?.('add'); window.setRecordType?.('expense'); } },
                    { icon: '🔄', label: 'Aktarım', class: 'transfer', action: () => { window.showToast?.('Aktarım', 'info'); } },
                    { icon: '📷', label: 'Fatura', class: 'scan', action: () => { window.toggleOCRModal?.(); } }
                ];

                actions.forEach(a => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-action-btn';
                    btn.innerHTML = `
                    <div class="quick-action-icon ${a.class}">${a.icon}</div>
                    <span class="quick-action-label">${a.label}</span>
                `;
                    btn.onclick = () => {
                        window.HapticFeedback?.selection();
                        a.action();
                    };
                    container.appendChild(btn);
                });

                return container;
            },

            inject: function () {
                const dashboard = document.getElementById('screen-dashboard');
                if (!dashboard || document.getElementById('quick-actions-widget')) return;

                const firstWidget = dashboard.querySelector('.grid, .space-y-3');
                if (firstWidget) {
                    dashboard.insertBefore(this.create(), firstWidget);
                }
            }
        };

        // ─────────────────────────────────────────────────────────────────
        // 6. AUTO CATEGORY PREDICTION
        // ─────────────────────────────────────────────────────────────────
        window.AutoCategory = {
            patterns: {
                'Yeme-İçme': ['restoran', 'cafe', 'kahve', 'yemek', 'market', 'migros', 'bim', 'a101', 'şok', 'carrefour', 'starbucks', 'mcdonalds', 'burger', 'pizza', 'kebap', 'döner'],
                'Ulaşım': ['uber', 'taksi', 'benzin', 'akaryakıt', 'shell', 'opet', 'bp', 'petrol', 'otopark', 'metro', 'otobüs', 'bilet', 'havaalanı'],
                'Faturalar': ['elektrik', 'su', 'doğalgaz', 'internet', 'telefon', 'turkcell', 'vodafone', 'türk telekom', 'fatura', 'abonelik'],
                'Alışveriş': ['amazon', 'trendyol', 'hepsiburada', 'n11', 'gittigidiyor', 'lcw', 'zara', 'h&m', 'mağaza', 'kıyafet', 'giyim'],
                'Eğlence': ['sinema', 'netflix', 'spotify', 'youtube', 'oyun', 'steam', 'konser', 'tiyatro', 'eğlence'],
                'Sağlık': ['eczane', 'hastane', 'doktor', 'ilaç', 'muayene', 'sağlık', 'diş', 'göz'],
                'Eğitim': ['udemy', 'coursera', 'kitap', 'kurs', 'eğitim', 'okul', 'üniversite']
            },

            predict: function (description) {
                if (!description) return null;
                const lower = description.toLowerCase();

                for (const [category, keywords] of Object.entries(this.patterns)) {
                    for (const keyword of keywords) {
                        if (lower.includes(keyword)) {
                            return category;
                        }
                    }
                }
                return null;
            },

            attachToInput: function (inputId, selectId) {
                const input = document.getElementById(inputId);
                const select = document.getElementById(selectId);
                if (!input || !select) return;

                let debounceTimer;
                input.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        const predicted = this.predict(input.value);
                        if (predicted) {
                            const option = Array.from(select.options).find(o => o.text === predicted);
                            if (option && !select.dataset.userChanged) {
                                select.value = option.value;
                                select.style.borderColor = '#10b981';
                                setTimeout(() => select.style.borderColor = '', 1000);
                            }
                        }
                    }, 500);
                });

                select.addEventListener('change', () => {
                    select.dataset.userChanged = 'true';
                });
            }
        };

        // ─────────────────────────────────────────────────────────────────
        // 7. MINI SPARKLINE GENERATOR
        // ─────────────────────────────────────────────────────────────────
        window.Sparkline = {
            create: function (data = [], options = {}) {
                const container = document.createElement('div');
                container.className = 'sparkline';

                if (!data.length) return container;

                const max = Math.max(...data.map(Math.abs));

                data.forEach(value => {
                    const bar = document.createElement('div');
                    bar.className = 'sparkline-bar';
                    const height = max > 0 ? (Math.abs(value) / max) * 100 : 0;
                    bar.style.height = `${Math.max(height, 10)}%`;
                    bar.classList.add(value >= 0 ? 'positive' : 'negative');
                    container.appendChild(bar);
                });

                return container;
            },

            getLast7DaysData: function (type = 'expense') {
                const APP_YEAR = new Date().getFullYear();
                const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
                const data = [];

                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];

                    const dayTotal = transactions
                        .filter(t => t.date === dateStr && t.type === type)
                        .reduce((sum, t) => sum + Math.abs(t.amount || 0), 0);

                    data.push(type === 'income' ? dayTotal : -dayTotal);
                }

                return data;
            }
        };

        // ─────────────────────────────────────────────────────────────────
        // 8. KEYBOARD NAVIGATION
        // ─────────────────────────────────────────────────────────────────
        window.KeyboardNav = {
            init: function () {
                // Add tabindex to interactive elements
                document.querySelectorAll('.widget-card-apple, .glass-card, .transaction-item, button:not([tabindex])').forEach((el, i) => {
                    if (!el.hasAttribute('tabindex')) {
                        el.setAttribute('tabindex', '0');
                    }
                });

                // Handle Enter key on focusable elements
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.target.hasAttribute('tabindex')) {
                        e.target.click();
                    }
                });

                // Tab navigation indicators
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        document.body.classList.add('keyboard-nav');
                    }
                });

                document.addEventListener('mousedown', () => {
                    document.body.classList.remove('keyboard-nav');
                });
            }
        };

        // ─────────────────────────────────────────────────────────────────
        // INITIALIZE ALL ENHANCEMENTS
        // ─────────────────────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize keyboard navigation
            window.KeyboardNav.init();

            // Quick Actions disabled per user request
            // setTimeout(() => {
            //     window.QuickActions.inject();
            // }, 500);

            // Pull-to-Refresh disabled per user request
            // setTimeout(() => {
            //     const dashboard = document.getElementById('screen-dashboard');
            //     if (dashboard) {
            //         window.PullToRefresh.init(dashboard, async () => {
            //             if (window.updateUI) await window.updateUI();
            //             if (window.showPremiumToast) {
            //                 window.showPremiumToast({
            //                     type: 'success',
            //                     title: 'Yenilendi',
            //                     message: 'Veriler güncellendi',
            //                     duration: 2000
            //                 });
            //             }
            //         });
            //     }
            // }, 1000);

            // Attach auto-category to add form
            setTimeout(() => {
                window.AutoCategory.attachToInput('input-desc', 'input-category');
            }, 500);

            // Initialize Budget Limits check
            setTimeout(() => {
                window.BudgetLimits?.check();
            }, 2000);

            console.log('[Enhancements] ✅ All enhancements initialized');
        });
    })();

    // ═══════════════════════════════════════════════════════════════════
    // ADDITIONAL SMART FEATURES v1.1
    // ═══════════════════════════════════════════════════════════════════

    // ─────────────────────────────────────────────────────────────────
    // 9. BUDGET LIMITS MANAGER
    // ─────────────────────────────────────────────────────────────────
    window.BudgetLimits = {
        limits: {},

        load: function () {
            this.limits = JSON.parse(localStorage.getItem('fingo_category_budgets') || '{}');
        },

        save: function () {
            localStorage.setItem('fingo_category_budgets', JSON.stringify(this.limits));
        },

        set: function (category, limit) {
            this.limits[category] = limit;
            this.save();
        },

        get: function (category) {
            return this.limits[category] || 0;
        },

        check: function () {
            this.load();
            const APP_YEAR = new Date().getFullYear();
            const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
            const currentMonth = new Date().getMonth();

            const monthlyExpenses = {};
            transactions.filter(t => {
                const d = new Date(t.date);
                return t.type === 'expense' && d.getMonth() === currentMonth;
            }).forEach(t => {
                const cat = t.category || 'Diğer';
                monthlyExpenses[cat] = (monthlyExpenses[cat] || 0) + Math.abs(t.amount);
            });

            const warnings = [];
            Object.keys(this.limits).forEach(cat => {
                const limit = this.limits[cat];
                const spent = monthlyExpenses[cat] || 0;
                const percent = (spent / limit) * 100;

                if (percent >= 80 && percent < 100) {
                    warnings.push({ cat, percent: Math.round(percent), type: 'warning' });
                } else if (percent >= 100) {
                    warnings.push({ cat, percent: Math.round(percent), type: 'danger' });
                }
            });

            return warnings;
        },

        showModal: function () {
            this.load();
            const categories = ['Yeme-İçme', 'Ulaşım', 'Faturalar', 'Alışveriş', 'Eğlence', 'Sağlık', 'Eğitim', 'Diğer'];

            const html = `
                <div class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" id="budget-limits-modal" onclick="if(event.target===this)this.remove()">
                    <div class="bg-white dark:bg-gray-900 rounded-3xl w-full max-w-md p-6 shadow-2xl">
                        <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">💰 Kategori Bütçeleri</h3>
                        <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                            ${categories.map(cat => `
                                <div class="flex items-center gap-3">
                                    <span class="w-24 text-sm font-medium text-gray-600 dark:text-gray-300">${cat}</span>
                                    <input type="number" 
                                        class="flex-1 px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border-2 border-transparent focus:border-indigo-500 outline-none text-gray-800 dark:text-white"
                                        placeholder="Limit (₺)"
                                        value="${this.limits[cat] || ''}"
                                        data-category="${cat}"
                                    >
                                </div>
                            `).join('')}
                        </div>
                        <button class="w-full mt-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold rounded-2xl" 
                            onclick="window.BudgetLimits.saveFromModal()">
                            Kaydet
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        },

        saveFromModal: function () {
            const modal = document.getElementById('budget-limits-modal');
            if (!modal) return;

            modal.querySelectorAll('input[data-category]').forEach(input => {
                const cat = input.dataset.category;
                const val = parseInt(input.value) || 0;
                if (val > 0) {
                    this.limits[cat] = val;
                } else {
                    delete this.limits[cat];
                }
            });

            this.save();
            modal.remove();

            if (window.showPremiumToast) {
                window.showPremiumToast({
                    type: 'success',
                    title: 'Kaydedildi',
                    message: 'Bütçe limitleri güncellendi',
                    duration: 2000
                });
            }
        }
    };

    // ─────────────────────────────────────────────────────────────────
    // 10. COMPARISON CHART
    // ─────────────────────────────────────────────────────────────────
    window.ComparisonChart = {
        create: function (thisMonth, lastMonth, label = 'Bu Ay vs Geçen Ay') {
            const container = document.createElement('div');
            container.className = 'comparison-chart';
            container.style.cssText = 'display:flex;flex-direction:column;gap:8px;padding:12px;';

            const max = Math.max(thisMonth, lastMonth, 1);
            const thisPercent = (thisMonth / max) * 100;
            const lastPercent = (lastMonth / max) * 100;

            container.innerHTML = `
                <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:4px">${label}</div>
                <div style="display:flex;align-items:center;gap:8px">
                    <span style="width:60px;font-size:11px;color:#374151">Bu Ay</span>
                    <div style="flex:1;height:24px;background:rgba(0,0,0,0.05);border-radius:12px;overflow:hidden">
                        <div style="height:100%;width:${thisPercent}%;background:linear-gradient(90deg,#6366f1,#8b5cf6);border-radius:12px;transition:width 0.5s ease"></div>
                    </div>
                    <span style="width:80px;font-size:12px;font-weight:700;text-align:right;color:#374151">₺${thisMonth.toLocaleString('tr-TR')}</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                    <span style="width:60px;font-size:11px;color:#9ca3af">Geçen Ay</span>
                    <div style="flex:1;height:24px;background:rgba(0,0,0,0.05);border-radius:12px;overflow:hidden">
                        <div style="height:100%;width:${lastPercent}%;background:linear-gradient(90deg,#94a3b8,#cbd5e1);border-radius:12px;transition:width 0.5s ease"></div>
                    </div>
                    <span style="width:80px;font-size:12px;font-weight:500;text-align:right;color:#9ca3af">₺${lastMonth.toLocaleString('tr-TR')}</span>
                </div>
                ${thisMonth !== lastMonth ? `
                    <div style="text-align:right;font-size:11px;font-weight:600;color:${thisMonth > lastMonth ? '#ef4444' : '#10b981'}">
                        ${thisMonth > lastMonth ? '▲' : '▼'} ${Math.abs(Math.round((thisMonth - lastMonth) / (lastMonth || 1) * 100))}%
                    </div>
                ` : ''}
            `;

            return container;
        },

        getMonthlyTotals: function (type = 'expense') {
            const APP_YEAR = new Date().getFullYear();
            const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');
            const currentMonth = new Date().getMonth();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;

            let thisMonthTotal = 0;
            let lastMonthTotal = 0;

            transactions.forEach(t => {
                if (t.type !== type) return;
                const d = new Date(t.date);
                const month = d.getMonth();
                const amount = Math.abs(t.amount || 0);

                if (month === currentMonth) thisMonthTotal += amount;
                else if (month === lastMonth) lastMonthTotal += amount;
            });

            return { thisMonth: thisMonthTotal, lastMonth: lastMonthTotal };
        }
    };

    // ─────────────────────────────────────────────────────────────────
    // 11. ENHANCED SEARCH
    // ─────────────────────────────────────────────────────────────────
    window.EnhancedSearch = {
        create: function (onSearch, placeholder = 'Ara...') {
            const container = document.createElement('div');
            container.className = 'search-enhanced';
            container.innerHTML = `
                <input type="text" placeholder="${placeholder}" id="enhanced-search-input">
                <svg class="search-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <button class="search-clear" type="button" onclick="this.previousElementSibling.previousElementSibling.value='';this.previousElementSibling.previousElementSibling.dispatchEvent(new Event('input'))">✕</button>
            `;

            let debounce;
            container.querySelector('input').addEventListener('input', (e) => {
                clearTimeout(debounce);
                debounce = setTimeout(() => {
                    if (onSearch) onSearch(e.target.value);
                }, 300);
            });

            return container;
        },

        filterTransactions: function (query) {
            if (!query) return null;
            const lower = query.toLowerCase();
            const APP_YEAR = new Date().getFullYear();
            const transactions = JSON.parse(localStorage.getItem(`my_expenses_${APP_YEAR}`) || '[]');

            return transactions.filter(t => {
                const desc = (t.description || '').toLowerCase();
                const cat = (t.category || '').toLowerCase();
                const amount = String(t.amount || '');
                return desc.includes(lower) || cat.includes(lower) || amount.includes(query);
            });
        }
    };

    // ─────────────────────────────────────────────────────────────────
    // 12. LAZY LOADING FOR LISTS
    // ─────────────────────────────────────────────────────────────────
    window.LazyList = {
        pageSize: 20,

        init: function (container, items, renderFn) {
            if (!container || !items.length) return;

            let page = 0;
            const loadMore = () => {
                const start = page * this.pageSize;
                const end = start + this.pageSize;
                const chunk = items.slice(start, end);

                chunk.forEach(item => {
                    const el = renderFn(item);
                    if (el) container.appendChild(el);
                });

                page++;
                return chunk.length === this.pageSize;
            };

            // Initial load
            loadMore();

            // Infinite scroll
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    const hasMore = loadMore();
                    if (!hasMore) observer.disconnect();
                }
            }, { rootMargin: '100px' });

            // Create sentinel
            const sentinel = document.createElement('div');
            sentinel.className = 'lazy-sentinel';
            sentinel.style.height = '1px';
            container.appendChild(sentinel);
            observer.observe(sentinel);

            return { loadMore, observer };
        }
    };

    // ─────────────────────────────────────────────────────────────────
    // 13. ARIA SCREEN READER IMPROVEMENTS
    // ─────────────────────────────────────────────────────────────────
    window.A11yHelper = {
        announceToScreenReader: function (message) {
            let announcer = document.getElementById('sr-announcer');
            if (!announcer) {
                announcer = document.createElement('div');
                announcer.id = 'sr-announcer';
                announcer.setAttribute('role', 'status');
                announcer.setAttribute('aria-live', 'polite');
                announcer.setAttribute('aria-atomic', 'true');
                announcer.style.cssText = 'position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden';
                document.body.appendChild(announcer);
            }
            announcer.textContent = message;
        },

        init: function () {
            // Add aria-labels to important sections
            const sections = [
                { id: 'screen-dashboard', label: 'Ana Sayfa' },
                { id: 'screen-notes', label: 'Notlar' },
                { id: 'screen-history', label: 'Geçmiş İşlemler' },
                { id: 'screen-wallet', label: 'Cüzdan' },
                { id: 'screen-add', label: 'İşlem Ekle' }
            ];

            sections.forEach(s => {
                const el = document.getElementById(s.id);
                if (el && !el.hasAttribute('aria-label')) {
                    el.setAttribute('aria-label', s.label);
                    el.setAttribute('role', 'region');
                }
            });
        }
    };

    // Initialize remaining features
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            window.BudgetLimits?.load();
            window.A11yHelper?.init();
        }, 1500);
    });
</script>

<style>
    /* --- Liquid Glass realism upgrade (override) --- */
    .nav-liquid-blob {
        will-change: left, transform, filter;
        transform: translate3d(0, -50%, 0) scale(1);
        backface-visibility: hidden;
        isolation: isolate;

        /* Daha hacimli “jel gövde” */
        background:
            radial-gradient(120% 140% at 30% 18%,
                rgba(255, 255, 255, .85) 0%,
                rgba(255, 255, 255, .20) 26%,
                rgba(255, 255, 255, 0) 55%),
            radial-gradient(120% 140% at 70% 85%,
                rgba(255, 255, 255, .18) 0%,
                rgba(255, 255, 255, 0) 60%),
            linear-gradient(135deg,
                color-mix(in srgb, var(--accent-primary) 70%, transparent),
                color-mix(in srgb, var(--accent-secondary) 70%, transparent));

        /* Jel kalınlığı + daha gerçekçi gölge */
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, .55),
            inset 0 -10px 24px rgba(0, 0, 0, .14),
            0 10px 30px rgba(0, 0, 0, .22),
            0 25px 80px var(--accent-glow);

        border: 1px solid rgba(255, 255, 255, .28);
        backdrop-filter: blur(14px) saturate(1.25);
        -webkit-backdrop-filter: blur(14px) saturate(1.25);

        /* Camı “alive” yapan micro ayar */
        filter: saturate(1.18) contrast(1.06);
        transition:
            left 520ms cubic-bezier(.22, 1, .36, 1),
            transform 520ms cubic-bezier(.22, 1, .36, 1),
            filter 650ms ease,
            opacity 200ms ease;
    }

    html.dark .nav-liquid-blob {
        border-color: rgba(255, 255, 255, .16);
        filter: saturate(1.12) contrast(1.04);
    }

    /* Pseudo’lara “hareket” ver (soft sheen) */
    @keyframes blobSheenDrift {

        0%,
        100% {
            transform: translate3d(0, 0, 0);
            opacity: .90;
        }

        50% {
            transform: translate3d(2px, -1px, 0);
            opacity: .78;
        }
    }

    @keyframes blobCaustics {

        0%,
        100% {
            transform: translate3d(0, 0, 0) scale(1);
            opacity: .55;
        }

        50% {
            transform: translate3d(-2px, 1px, 0) scale(1.06);
            opacity: .42;
        }
    }

    .nav-liquid-blob::before {
        animation: blobSheenDrift 4.2s ease-in-out infinite;
    }

    .nav-liquid-blob::after {
        animation: blobCaustics 5.6s ease-in-out infinite;
    }

    /* Drag sırasında “jelly” daha gerçekçi olsun */
    .nav-dragging .nav-liquid-blob {
        filter: saturate(1.25) contrast(1.08);
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, .58),
            inset 0 -12px 28px rgba(0, 0, 0, .16),
            0 12px 34px rgba(0, 0, 0, .24),
            0 28px 90px var(--accent-glow);
    }

    /* Motion-safe (iOS kullanıcıları için şart) */
    @media (prefers-reduced-motion: reduce) {

        .nav-liquid-blob,
        .nav-liquid-blob::before,
        .nav-liquid-blob::after {
            animation: none !important;
            transition: opacity .15s ease, left .15s ease, transform .15s ease !important;
        }
    }
</style>
<script>
    // ─────────────────────────────────────────────────────────────────────────────
    // PREMIUM BOTTOM SHEET POLYFILL (iOS Style)
    // ─────────────────────────────────────────────────────────────────────────────
    window.openBottomSheet = function ({ title, body, icon, confirmText, onConfirm }) {
        let overlay = document.getElementById('fingo-bs-overlay');

        // 1. Create Layout if missing
        if (!overlay) {
            const html = `
                <div id="fingo-bs-overlay" class="fixed inset-0 z-[60] hidden">
                    <!-- Backdrop -->
                    <div id="fingo-bs-backdrop" class="absolute inset-0 bg-black/40 backdrop-blur-[2px] opacity-0 transition-opacity duration-300" onclick="window.closeBottomSheet()"></div>
                    
                    <!-- Sheet Container -->
                    <div id="fingo-bs-sheet" class="absolute bottom-0 left-0 w-full bg-white/95 dark:bg-[#1c1c1e]/95 backdrop-blur-xl rounded-t-[24px] shadow-2xl transform translate-y-full transition-transform duration-300 ease-[cubic-bezier(0.32,0.72,0,1)] flex flex-col max-h-[85vh] pb-safe">
                        
                        <!-- Drag Handle -->
                        <div class="w-full flex justify-center pt-3 pb-1" onclick="window.closeBottomSheet()">
                            <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full opacity-50"></div>
                        </div>

                        <!-- Header -->
                        <div class="px-6 py-4 flex items-center justify-between border-b border-gray-100 dark:border-white/5 mx-2">
                             <div class="flex items-center gap-3">
                                <span id="fingo-bs-icon" class="text-2xl">${icon || '✨'}</span>
                                <h3 id="fingo-bs-title" class="text-lg font-bold text-gray-900 dark:text-white tracking-tight">${title || 'Detaylar'}</h3>
                             </div>
                             <button onclick="window.closeBottomSheet()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                             </button>
                        </div>

                        <!-- Content (Scrollable) -->
                        <div class="px-8 py-6 overflow-y-auto overscroll-contain text-gray-700 dark:text-gray-300 space-y-4 text-sm leading-relaxed" id="fingo-bs-body">
                            <!-- Dynamic Content -->
                        </div>

                        <!-- Footer Actions -->
                        <div class="p-6 pt-2 border-t border-gray-100 dark:border-white/5 flex gap-3 pb-8">
                             <button onclick="window.closeBottomSheet()" class="flex-1 py-3.5 rounded-2xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold text-sm transition active:scale-95">Kapat</button>
                             <button id="fingo-bs-confirm" class="flex-[2] py-3.5 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold text-sm shadow-lg shadow-indigo-500/30 transition active:scale-95 flex items-center justify-center gap-2">
                                <span>👍</span> <span id="fingo-bs-confirm-text">Tamam</span>
                             </button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            overlay = document.getElementById('fingo-bs-overlay');
        }

        // 2. Populate Data
        document.getElementById('fingo-bs-title').innerText = title || 'Bilgi';
        document.getElementById('fingo-bs-icon').innerText = icon || '💡';
        document.getElementById('fingo-bs-confirm-text').innerText = confirmText || 'Tamam';

        // Body Content (Plain text processing just in case)
        const bodyEl = document.getElementById('fingo-bs-body');
        bodyEl.innerText = body; // Using innerText to enforce plain text rendering!

        // Confirm Action
        const confirmBtn = document.getElementById('fingo-bs-confirm');
        confirmBtn.onclick = () => {
            if (onConfirm) onConfirm();
            window.closeBottomSheet();
        };

        // 3. Animate In
        overlay.classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('fingo-bs-backdrop').classList.remove('opacity-0');
            document.getElementById('fingo-bs-sheet').classList.remove('translate-y-full');
        }, 10);

        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    };

    window.closeBottomSheet = function () {
        const overlay = document.getElementById('fingo-bs-overlay');
        if (!overlay) return;

        document.getElementById('fingo-bs-backdrop').classList.add('opacity-0');
        document.getElementById('fingo-bs-sheet').classList.add('translate-y-full');

        setTimeout(() => {
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Wait for transition
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // SAFE MODE / SESSION TIMEOUT MANAGER
    // ─────────────────────────────────────────────────────────────────────────────
    window.SessionTimeout = {
        timer: null,
        timeoutMs: 60000, // 60 seconds idle timeout

        init: function () {
            this.resetTimer();
            // Listen for user activity
            ['click', 'touchstart', 'keydown', 'scroll', 'mousemove'].forEach(evt => {
                document.addEventListener(evt, () => this.resetTimer(), { passive: true });
            });
        },

        resetTimer: function () {
            if (this.timer) clearTimeout(this.timer);
            this.timer = setTimeout(() => this.lockSession(), this.timeoutMs);
        },

        lockSession: function () {
            const blurOverlay = document.getElementById('blur-overlay');
            if (blurOverlay) {
                blurOverlay.classList.remove('hidden');

                // ✅ Safe mode blur class ON
                document.documentElement.classList.add('safe-mode-active');

                // Blur aktifken scroll engelle
                document.body.style.overflow = 'hidden';
            }
        }
    };

    // ✅ Dismiss Blur Overlay (Tap to Resume)
    window.dismissBlurOverlay = function () {
        const blurOverlay = document.getElementById('blur-overlay');
        if (blurOverlay) {
            blurOverlay.classList.add('hidden');

            // ✅ Safe mode blur class OFF
            document.documentElement.classList.remove('safe-mode-active');

            // Scroll kilidini aç
            document.body.style.overflow = '';

            // Reset timers
            if (window.SessionTimeout) {
                window.SessionTimeout.resetTimer();
            }
        }
    };

    // Auto-init SessionTimeout on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            window.SessionTimeout.init();
        }, 2000);
    });
</script>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- WIDGET INFO MODAL SYSTEM - Fingo Brain Metric Explanations -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="widget-info-modal" class="fixed inset-0 z-[9999] hidden" aria-modal="true" role="dialog">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/50 backdrop-blur-xl" onclick="window.closeWidgetInfo()"></div>

    <!-- Modal Content - Bottom Sheet Style -->
    <div class="absolute bottom-0 left-0 right-0 p-4 pb-8 transform transition-transform duration-300 ease-out"
        id="widget-info-sheet">
        <div class="glass-card rounded-3xl p-6 max-w-md mx-auto shadow-2xl border border-white/20 dark:border-white/10">
            <!-- Drag Handle -->
            <div class="w-10 h-1 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-4"></div>

            <!-- Header -->
            <div id="widget-info-header" class="flex items-center gap-3 mb-5">
                <div id="widget-info-icon"
                    class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center text-3xl shadow-inner">
                </div>
                <div class="flex-1">
                    <h3 id="widget-info-title" class="text-lg font-bold text-gray-800 dark:text-white"></h3>
                    <p id="widget-info-subtitle" class="text-xs text-gray-500 dark:text-gray-400"></p>
                </div>
            </div>

            <!-- Content -->
            <div id="widget-info-content" class="space-y-4 text-sm text-gray-600 dark:text-gray-300 leading-relaxed">
            </div>

            <!-- Close Button -->
            <button onclick="window.closeWidgetInfo()"
                class="w-full mt-6 py-3.5 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40 transition-all duration-200 active:scale-[0.98]">
                Anladım 👍
            </button>
        </div>
    </div>
</div>

<style>
    /* Widget Info Modal Animations */
    #widget-info-modal.show #widget-info-sheet {
        transform: translateY(0);
    }

    #widget-info-modal:not(.show) #widget-info-sheet {
        transform: translateY(100%);
    }

    /* Info content styling */
    #widget-info-content strong {
        color: var(--neo-text-primary, #1f2937);
    }

    html.dark #widget-info-content strong {
        color: #f3f4f6;
    }

    #widget-info-content ul {
        list-style-type: disc;
        padding-left: 1.25rem;
    }

    #widget-info-content li {
        margin-bottom: 0.25rem;
    }

    /* Tip boxes */
    .widget-tip-box {
        padding: 0.875rem;
        border-radius: 0.875rem;
        margin-top: 0.75rem;
    }

    .widget-tip-box p {
        font-size: 0.75rem;
    }
</style>

<script>
    // ═══════════════════════════════════════════════════════════════════════════
    // WIDGET INFO MODAL SYSTEM
    // ═══════════════════════════════════════════════════════════════════════════
    (function initWidgetInfoSystem() {
        'use strict';

        // Widget Info Content Data
        window.widgetInfoData = {
            prediction: {
                icon: '🔮',
                title: 'Ay Sonu Tahmini',
                subtitle: 'Tahmini bakiye hesaplaması',
                content: `
                    <div class="space-y-4">
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-white mb-2">📌 Ne anlama geliyor?</p>
                            <p>Bu değer, mevcut harcama hızınıza göre <strong>ay sonunda tahmini bakiyenizi</strong> gösterir.</p>
                        </div>
                        
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-white mb-2">🧮 Nasıl hesaplanıyor?</p>
                            <ul class="text-xs space-y-1.5">
                                <li>Günlük ortalama harcama = Toplam harcama ÷ Geçen gün sayısı</li>
                                <li>Tahmini gider = Günlük ort. × Kalan gün sayısı</li>
                                <li><strong>Tahmin = Gelir - Mevcut gider - Tahmini gider</strong></li>
                            </ul>
                        </div>
                        
                        <div class="widget-tip-box bg-indigo-50 dark:bg-indigo-500/10 border border-indigo-100 dark:border-indigo-500/20">
                            <p><strong>💡 İpucu:</strong> Negatif değer görüyorsan, ay sonunda bütçe açığı olabileceğini gösterir. Gereksiz harcamalarını gözden geçirmeni öneririz!</p>
                        </div>
                    </div>
                `
            },
            volatility: {
                icon: '📊',
                title: 'Volatilite (Değişkenlik)',
                subtitle: 'Harcama düzensizliği ölçümü',
                content: `
                    <div class="space-y-4">
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-white mb-2">📌 Ne anlama geliyor?</p>
                            <p>Volatilite, <strong>günlük harcamalarındaki dalgalanmayı</strong> ölçer. Düşük volatilite, tutarlı ve öngörülebilir harcama alışkanlıkları demektir.</p>
                        </div>
                        
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-white mb-2">🎨 Seviye Anlamları:</p>
                            <div class="space-y-2.5">
                                <div class="flex items-start gap-2.5 p-2.5 bg-emerald-50 dark:bg-emerald-500/10 rounded-xl">
                                    <span class="w-3 h-3 rounded-full bg-emerald-500 mt-0.5 shrink-0"></span>
                                    <div>
                                        <strong class="text-emerald-700 dark:text-emerald-400">Düşük</strong>
                                        <p class="text-xs text-emerald-600 dark:text-emerald-300/80">Harcamalar tutarlı, bütçe planlaması kolay</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-2.5 p-2.5 bg-amber-50 dark:bg-amber-500/10 rounded-xl">
                                    <span class="w-3 h-3 rounded-full bg-amber-500 mt-0.5 shrink-0"></span>
                                    <div>
                                        <strong class="text-amber-700 dark:text-amber-400">Orta</strong>
                                        <p class="text-xs text-amber-600 dark:text-amber-300/80">Bazı günlerde ani değişimler mevcut</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-2.5 p-2.5 bg-red-50 dark:bg-red-500/10 rounded-xl">
                                    <span class="w-3 h-3 rounded-full bg-red-500 mt-0.5 shrink-0"></span>
                                    <div>
                                        <strong class="text-red-700 dark:text-red-400">Yüksek</strong>
                                        <p class="text-xs text-red-600 dark:text-red-300/80">Beklenmedik harcamalar sık, dikkatli ol!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="widget-tip-box bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20">
                            <p><strong>💡 İpucu:</strong> Düşük volatilite hedefle! Her gün benzer miktarda harcamak, bütçeni kontrol altında tutmanı kolaylaştırır.</p>
                        </div>
                    </div>
                `
            }
        };

        // Show Widget Info Modal
        window.showWidgetInfo = function (type) {
            const data = window.widgetInfoData[type];
            if (!data) return;

            const modal = document.getElementById('widget-info-modal');
            const iconEl = document.getElementById('widget-info-icon');
            const titleEl = document.getElementById('widget-info-title');
            const subtitleEl = document.getElementById('widget-info-subtitle');
            const contentEl = document.getElementById('widget-info-content');

            if (iconEl) iconEl.textContent = data.icon;
            if (titleEl) titleEl.textContent = data.title;
            if (subtitleEl) subtitleEl.textContent = data.subtitle;
            if (contentEl) contentEl.innerHTML = data.content;

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Trigger animation
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });

            console.log('[WidgetInfo] Opened:', type);
        };

        // Close Widget Info Modal
        window.closeWidgetInfo = function () {
            const modal = document.getElementById('widget-info-modal');
            modal.classList.remove('show');

            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        };

        console.log('[WidgetInfoSystem] ✅ Widget info modal sistemi yüklendi');
    })();

    // ═══════════════════════════════════════════════════════════════════════════
    // ENHANCED FINGO BRAIN PREDICTION & VOLATILITY CALCULATION
    // ═══════════════════════════════════════════════════════════════════════════
    (function initFingoBrainPrediction() {
        'use strict';

        window.updateFingoBrainPrediction = function () {
            try {
                const APP_YEAR = new Date().getFullYear();
                const APP_MONTH = new Date().getMonth() + 1;
                const txKey = `fingenda_transactions_${APP_YEAR}`;
                const allTx = JSON.parse(localStorage.getItem(txKey) || '[]');

                // Filter current month transactions
                const monthTx = allTx.filter(t => {
                    if (!t.date) return false;
                    const d = new Date(t.date);
                    return d.getMonth() + 1 === APP_MONTH && d.getFullYear() === APP_YEAR;
                });

                let income = 0, expense = 0;
                const dailyExpenses = {};

                monthTx.forEach(t => {
                    const amt = parseFloat(t.amount) || 0;
                    const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : false;

                    if (t.type === 'income') {
                        income += amt;
                    } else if (t.type === 'expense' && !isSavings) {
                        expense += amt;
                        // Track daily spending for volatility calculation
                        const dateKey = t.date.split('T')[0];
                        dailyExpenses[dateKey] = (dailyExpenses[dateKey] || 0) + amt;
                    }
                });

                // === PREDICTION CALCULATION ===
                const today = new Date();
                const dayOfMonth = today.getDate();
                const daysInMonth = new Date(APP_YEAR, APP_MONTH, 0).getDate();
                const daysRemaining = daysInMonth - dayOfMonth;

                const dailyAvg = dayOfMonth > 1 ? expense / dayOfMonth : 0;
                const projectedExpense = expense + (dailyAvg * daysRemaining);
                const predictedBalance = income - projectedExpense;

                // === VOLATILITY CALCULATION (Coefficient of Variation) ===
                const dailyValues = Object.values(dailyExpenses);
                let volatilityLevel = 'Düşük';
                let volatilityColor = 'text-emerald-500 dark:text-emerald-400';
                let cv = 0;

                if (dailyValues.length >= 3) {
                    const mean = dailyValues.reduce((a, b) => a + b, 0) / dailyValues.length;
                    const variance = dailyValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / dailyValues.length;
                    const stdDev = Math.sqrt(variance);
                    cv = mean > 0 ? (stdDev / mean) * 100 : 0;

                    if (cv > 60) {
                        volatilityLevel = 'Yüksek';
                        volatilityColor = 'text-red-500 dark:text-red-400';
                    } else if (cv > 30) {
                        volatilityLevel = 'Orta';
                        volatilityColor = 'text-amber-500 dark:text-amber-400';
                    }
                } else if (dailyValues.length === 0) {
                    volatilityLevel = '--';
                    volatilityColor = 'text-gray-400';
                }

                // === UPDATE DOM ===
                const balanceEl = document.getElementById('prediction-balance');
                const volatilityEl = document.getElementById('prediction-volatility');
                const detailEl = document.getElementById('prediction-detail');
                const volDetailEl = document.getElementById('volatility-detail');

                if (balanceEl) {
                    if (monthTx.length === 0) {
                        balanceEl.textContent = 'Veri yok';
                        balanceEl.className = 'text-xl font-bold text-gray-400 truncate';
                    } else {
                        balanceEl.textContent = predictedBalance.toLocaleString('tr-TR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }) + ' ₺';
                        balanceEl.className = `text-xl font-bold truncate ${predictedBalance >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-500 dark:text-red-400'}`;
                    }
                }

                if (detailEl) {
                    if (monthTx.length === 0) {
                        detailEl.textContent = 'İşlem ekleyin';
                    } else {
                        detailEl.textContent = `Günlük ort: ${dailyAvg.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}₺ • ${daysRemaining} gün kaldı`;
                    }
                }

                if (volatilityEl) {
                    volatilityEl.textContent = volatilityLevel;
                    volatilityEl.className = `text-xl font-bold ${volatilityColor}`;
                }

                if (volDetailEl) {
                    if (dailyValues.length === 0) {
                        volDetailEl.textContent = 'Hesaplama için veri gerekli';
                    } else if (dailyValues.length < 3) {
                        volDetailEl.textContent = `${dailyValues.length} gün • min 3 gün gerekli`;
                    } else {
                        volDetailEl.textContent = `${dailyValues.length} gün analiz edildi`;
                    }
                }

                console.log('[FingoBrainPrediction] ✅ Updated:', { predicted: predictedBalance, volatility: volatilityLevel, cv: cv.toFixed(1) });

            } catch (e) {
                console.warn('[FingoBrainPrediction] Update failed:', e);
            }
        };

        // Auto-update on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(window.updateFingoBrainPrediction, 2000);
        });

        // Listen for data changes
        ['fingenda_data_updated', 'storage'].forEach(evt => {
            window.addEventListener(evt, () => setTimeout(window.updateFingoBrainPrediction, 500));
        });

        console.log('[FingoBrainPrediction] ✅ Prediction ve Volatility sistemi yüklendi');
    })();
</script>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- DNA WIDGET ENHANCEMENT SYSTEM - CSS & JavaScript -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<style>
    /* DNA Category Pills */
    .dna-pill {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 14px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        min-width: 150px;
        flex-shrink: 0;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    html.dark .dna-pill {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.08);
    }

    .dna-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    html.dark .dna-pill:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .dna-pill-emoji {
        font-size: 18px;
        flex-shrink: 0;
    }

    .dna-pill-info {
        flex: 1;
        min-width: 0;
    }

    .dna-pill-name {
        font-size: 11px;
        font-weight: 600;
        color: #374151;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    html.dark .dna-pill-name {
        color: #f3f4f6;
    }

    .dna-pill-bar {
        height: 4px;
        background: rgba(0, 0, 0, 0.08);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
    }

    html.dark .dna-pill-bar {
        background: rgba(255, 255, 255, 0.1);
    }

    .dna-pill-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.6s ease;
    }

    .dna-pill-percent {
        font-size: 11px;
        font-weight: 700;
        color: #6366f1;
        flex-shrink: 0;
    }

    html.dark .dna-pill-percent {
        color: #818cf8;
    }

    /* DNA Stat Card animation */
    .dna-stat-card {
        position: relative;
        overflow: hidden;
    }

    .dna-stat-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent 60%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .dna-stat-card:hover::after {
        opacity: 1;
    }
</style>

<script>
    // ═══════════════════════════════════════════════════════════════════════════
    // DNA WIDGET INFO DATA - Add to widgetInfoData
    // ═══════════════════════════════════════════════════════════════════════════
    (function addDNAWidgetInfo() {
        if (!window.widgetInfoData) window.widgetInfoData = {};

        window.widgetInfoData['dna-dominant'] = {
            icon: '🏆',
            title: 'Baskın Kategori',
            subtitle: 'En çok harcama yaptığın alan',
            content: `
                <div class="space-y-4">
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white mb-2">📌 Ne anlama geliyor?</p>
                        <p>Bu değer, toplam harcamalarında <strong>en büyük paya sahip kategoriyi</strong> gösterir.</p>
                    </div>
                    
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white mb-2">🧮 Nasıl hesaplanıyor?</p>
                        <p class="text-xs">Tüm gider işlemleriniz kategorilere göre toplanır ve en yüksek tutara sahip kategori "Baskın" olarak belirlenir.</p>
                    </div>
                    
                    <div class="widget-tip-box bg-rose-50 dark:bg-rose-500/10 border border-rose-100 dark:border-rose-500/20">
                        <p><strong>💡 İpucu:</strong> Baskın kategorin beklediğinden farklıysa, harcama alışkanlıklarını gözden geçirmek iyi bir fikir!</p>
                    </div>
                </div>
            `
        };

        window.widgetInfoData['dna-active'] = {
            icon: '📊',
            title: 'Aktif Kategoriler',
            subtitle: 'Kullanılan kategori sayısı',
            content: `
                <div class="space-y-4">
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white mb-2">📌 Ne anlama geliyor?</p>
                        <p>Bu ay toplam <strong>kaç farklı kategoride harcama</strong> yaptığını gösterir.</p>
                    </div>
                    
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white mb-2">🎯 Neden önemli?</p>
                        <ul class="text-xs space-y-1.5">
                            <li><strong>Düşük (1-3):</strong> Odaklı harcama, kolaylıkla takip edilir</li>
                            <li><strong>Orta (4-6):</strong> Dengeli bir dağılım</li>
                            <li><strong>Yüksek (7+):</strong> Çeşitli ihtiyaçlar, detaylı analiz gerekebilir</li>
                        </ul>
                    </div>
                    
                    <div class="widget-tip-box bg-indigo-50 dark:bg-indigo-500/10 border border-indigo-100 dark:border-indigo-500/20">
                        <p><strong>💡 İpucu:</strong> Kategorileri düzgün kullanmak, finansal analizlerinin daha doğru olmasını sağlar!</p>
                    </div>
                </div>
            `
        };

        window.widgetInfoData['dna-diversity'] = {
            icon: '🧬',
            title: 'Çeşitlilik Skoru',
            subtitle: 'Harcama dağılım endeksi',
            content: `
                <div class="space-y-4">
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white mb-2">📌 Ne anlama geliyor?</p>
                        <p>Harcamalarının kategoriler arasında <strong>ne kadar eşit dağıldığını</strong> gösterir (Simpson Çeşitlilik Endeksi).</p>
                    </div>
                    
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white mb-2">🎨 Skor Anlamları:</p>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-white/5 rounded-lg">
                                <span class="font-bold text-purple-600 dark:text-purple-400">0-30%</span>
                                <span class="text-xs">Tek kategoriye odaklı</span>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-white/5 rounded-lg">
                                <span class="font-bold text-purple-600 dark:text-purple-400">31-60%</span>
                                <span class="text-xs">Birkaç kategori ağırlıklı</span>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-white/5 rounded-lg">
                                <span class="font-bold text-purple-600 dark:text-purple-400">61-100%</span>
                                <span class="text-xs">Dengeli ve çeşitli dağılım</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-tip-box bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20">
                        <p><strong>💡 İpucu:</strong> Yüksek çeşitlilik mutlaka iyi değil, tek kategoriye yüksek harcama da sorun olabilir. Dengeli bir yapı hedefle!</p>
                    </div>
                </div>
            `
        };

        console.log('[DNAWidgetInfo] ✅ DNA widget info içerikleri eklendi');
    })();

    // ═══════════════════════════════════════════════════════════════════════════
    // DNA WIDGET UPDATE SYSTEM
    // ═══════════════════════════════════════════════════════════════════════════
    (function initDNAWidgetSystem() {
        'use strict';

        // Category emoji mapping
        const categoryEmojis = {
            'Market': '🛒',
            'Yeme-İçme': '🍽️',
            'Ulaşım': '🚗',
            'Fatura': '📄',
            'Sağlık': '💊',
            'Eğlence': '🎬',
            'Giyim': '👕',
            'Eğitim': '📚',
            'Kira': '🏠',
            'Teknoloji': '💻',
            'Spor': '🏋️',
            'Hediye': '🎁',
            'Birikim': '💰',
            'Yatırım': '📈',
            'Diğer': '📌'
        };

        // Get gradient class for category
        function getCategoryGradient(index) {
            const gradients = [
                'linear-gradient(90deg, #6366f1, #8b5cf6)',
                'linear-gradient(90deg, #ec4899, #f43f5e)',
                'linear-gradient(90deg, #10b981, #14b8a6)',
                'linear-gradient(90deg, #f59e0b, #f97316)',
                'linear-gradient(90deg, #3b82f6, #0ea5e9)',
                'linear-gradient(90deg, #8b5cf6, #a855f7)',
                'linear-gradient(90deg, #ef4444, #f97316)',
                'linear-gradient(90deg, #14b8a6, #22d3d8)'
            ];
            return gradients[index % gradients.length];
        }

        // Render category list/pills
        window.renderDNACategoryPills = function (sortedCategories, total) {
            // Try both possible container IDs
            const container = document.getElementById('dna-category-list') || document.getElementById('dna-category-pills');
            const emptyState = document.getElementById('dna-pills-empty');
            const countEl = document.getElementById('dna-category-count');

            if (!container) return;

            // Update count
            if (countEl) {
                countEl.textContent = `${sortedCategories.length} kategori`;
            }

            // Show empty state if no data
            if (sortedCategories.length === 0) {
                if (emptyState) emptyState.style.display = 'flex';
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-3">📊</div>
                        <p class="text-sm font-medium">Henüz harcama yok</p>
                        <p class="text-xs mt-1">Gider ekledikten sonra kategoriler burada görünecek</p>
                    </div>
                `;
                return;
            }

            if (emptyState) emptyState.style.display = 'none';

            // Clear and render category cards
            container.innerHTML = '';

            // Format currency
            const formatCurrency = (amt) => amt.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';

            sortedCategories.forEach(([cat, amount], index) => {
                const percent = total > 0 ? Math.round((amount / total) * 100) : 0;
                const emoji = categoryEmojis[cat] || '📌';
                const gradient = getCategoryGradient(index);

                const card = document.createElement('div');
                card.className = 'relative overflow-hidden rounded-2xl p-4 bg-white/80 dark:bg-white/[0.04] border border-gray-100 dark:border-white/[0.06] shadow-sm cursor-pointer transition-all duration-200 hover:shadow-md hover:scale-[1.01] active:scale-[0.99]';
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-11 h-11 rounded-xl flex items-center justify-center text-xl shrink-0" 
                             style="background: ${gradient}; box-shadow: 0 4px 12px ${gradient.includes('6366f1') ? 'rgba(99,102,241,0.25)' : 'rgba(0,0,0,0.1)'};">
                            <span class="filter drop-shadow-sm">${emoji}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-bold text-gray-800 dark:text-white truncate">${cat}</span>
                                <span class="text-sm font-black text-gray-700 dark:text-gray-200">${formatCurrency(amount)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex-1 h-1.5 bg-gray-100 dark:bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-500" 
                                         style="width: ${percent}%; background: ${gradient};"></div>
                                </div>
                                <span class="text-[10px] font-bold text-gray-500 dark:text-gray-400 w-8 text-right">${percent}%</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        // Spending Personality Definitions - Premium 3D Icon Characters
        const spendingPersonalities = {
            'Market': {
                icon: '🛒',
                icon3d: '🛒',
                title: 'Ev Ekonomisti',
                desc: 'Market ve ev ihtiyaçlarına öncelik veriyorsun. Planlı ve tutumlu bir alışverişçisin! Bütçeni ustalıkla yönetiyorsun.',
                color: 'from-emerald-500 to-teal-600'
            },
            'Yeme-İçme': {
                icon: '🍽️',
                icon3d: '👨‍🍳',
                title: 'Gurme Kaşif',
                desc: 'Lezzetlerin peşinde koşuyorsun! Restoran ve kafeler senin ikinci evin. Damak tadın gelişmiş, yeni tatlar keşfetmeyi seviyorsun.',
                color: 'from-orange-500 to-red-600'
            },
            'Ulaşım': {
                icon: '🚗',
                icon3d: '🚀',
                title: 'Yolların Efendisi',
                desc: 'Hareket halinde bir yaşam! Ulaşım senin için özgürlük demek. Şehri karış karış gezmeyi seviyorsun.',
                color: 'from-blue-500 to-indigo-600'
            },
            'Fatura': {
                icon: '📄',
                icon3d: '💡',
                title: 'Düzen Ustası',
                desc: 'Sabit giderlerini aksatmadan ödersin. Sorumluluk sahibi ve güvenilir birisin. Finansal disiplin senin güçlü yanın!',
                color: 'from-slate-500 to-gray-600'
            },
            'Sağlık': {
                icon: '💊',
                icon3d: '🏥',
                title: 'Sağlık Savaşçısı',
                desc: 'Kendine yatırım yapıyorsun! Sağlık harcamaların senin için öncelik. Bedene ve zihne önem veriyorsun.',
                color: 'from-rose-500 to-pink-600'
            },
            'Eğlence': {
                icon: '🎬',
                icon3d: '🎭',
                title: 'Eğlence Kralı',
                desc: 'Hayatın tadını çıkarmayı biliyorsun! Sosyal aktiviteler, konserler, sinemalar... Her anın kıymetini bilirsin.',
                color: 'from-purple-500 to-fuchsia-600'
            },
            'Giyim': {
                icon: '👕',
                icon3d: '👔',
                title: 'Moda İkonu',
                desc: 'Stil senin imzan! Giyim ve aksesuarlara değer veriyorsun. Görünüşün, özgüveninin yansıması.',
                color: 'from-pink-500 to-rose-600'
            },
            'Eğitim': {
                icon: '📚',
                icon3d: '🎓',
                title: 'Bilgi Avcısı',
                desc: 'Öğrenmeye aşıksın! Eğitim ve kişisel gelişim senin için yatırım demek. Sürekli kendini geliştiriyorsun.',
                color: 'from-amber-500 to-yellow-600'
            },
            'Kira': {
                icon: '🏠',
                icon3d: '🏰',
                title: 'Yuva Mimarı',
                desc: 'Ev ve barınma senin güvenli limanın. Yaşam alanın sana çok önemli. Konforundan ödün vermezsin.',
                color: 'from-cyan-500 to-blue-600'
            },
            'Teknoloji': {
                icon: '💻',
                icon3d: '🤖',
                title: 'Teknoloji Gurusu',
                desc: 'Dijital dünya senin oyun alanın! Son teknolojileri takip eder, yeniliklere ilk sen ulaşırsın.',
                color: 'from-violet-500 to-purple-600'
            },
            'Spor': {
                icon: '🏋️',
                icon3d: '🏆',
                title: 'Fitness Şampiyonu',
                desc: 'Sağlıklı yaşam senin motton! Spor ve aktiviteye yatırım yapıyorsun. Enerjin ve formun takdire şayan.',
                color: 'from-green-500 to-emerald-600'
            },
            'Hediye': {
                icon: '🎁',
                icon3d: '🎁',
                title: 'Cömert Kalp',
                desc: 'Sevdiklerini mutlu etmeyi seversin! Hediye almak senin için bir keyif. Paylaşmak seni zengin kılıyor.',
                color: 'from-red-500 to-rose-600'
            },
            'Diğer': {
                icon: '✨',
                icon3d: '🌈',
                title: 'Çok Yönlü Yıldız',
                desc: 'Dengeli bir harcama profilin var! Farklı alanlara yatırım yapıyorsun. Esneklik senin güçlü yanın.',
                color: 'from-indigo-500 to-purple-600'
            }
        };

        // Default personality when no data
        const defaultPersonality = {
            icon: '✨',
            icon3d: '🔮',
            title: 'Keşfediliyor...',
            desc: 'Harcama verilerini bekliyoruz. İlk giderini ekleyince karakterin ortaya çıkacak!',
            color: 'from-gray-500 to-slate-600'
        };

        // Main update function
        window.updateDNAWidget = function () {
            try {
                const APP_YEAR = new Date().getFullYear();
                const APP_MONTH = new Date().getMonth() + 1;

                // FIXED: Correct localStorage key - was fingenda_transactions_, should be my_expenses_
                const txKey = `my_expenses_${APP_YEAR}`;
                const allTx = JSON.parse(localStorage.getItem(txKey) || '[]');

                // Filter this month's expense transactions
                const monthExpenses = allTx.filter(t => {
                    if (!t.date || t.type !== 'expense') return false;
                    const d = new Date(t.date);
                    if (d.getMonth() + 1 !== APP_MONTH || d.getFullYear() !== APP_YEAR) return false;

                    // Exclude savings
                    const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : false;
                    return !isSavings;
                });

                // Calculate category totals
                const categoryTotals = {};
                monthExpenses.forEach(t => {
                    const cat = t.category || 'Diğer';
                    const amt = Math.abs(parseFloat(t.amount) || 0);
                    categoryTotals[cat] = (categoryTotals[cat] || 0) + amt;
                });

                // Sort by amount descending
                const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
                const total = sorted.reduce((sum, [, v]) => sum + v, 0);

                // Get dominant category
                const dominantCat = sorted[0]?.[0] || '--';

                // Get active count
                const activeCount = sorted.length;

                // Calculate diversity (Simpson's Diversity Index = 1 - HHI)
                let diversityScore = 0;
                if (total > 0 && sorted.length > 1) {
                    const hhi = sorted.reduce((sum, [, v]) => {
                        const p = v / total;
                        return sum + (p * p);
                    }, 0);
                    diversityScore = Math.round((1 - hhi) * 100);
                } else if (sorted.length === 1) {
                    diversityScore = 0; // Single category = no diversity
                }

                // Update DOM elements
                const domCatEl = document.getElementById('dna-dominant-cat');
                const totalCatsEl = document.getElementById('dna-total-cats');
                const diversityEl = document.getElementById('dna-diversity-score');

                if (domCatEl) {
                    domCatEl.textContent = dominantCat;
                }

                if (totalCatsEl) {
                    totalCatsEl.textContent = activeCount > 0 ? activeCount : '--';
                }

                if (diversityEl) {
                    diversityEl.textContent = activeCount > 0 ? `${diversityScore}%` : '--';
                }

                // Render category pills
                window.renderDNACategoryPills(sorted, total);

                // Update dominant card text
                const domTextEl = document.getElementById('dna-dominant-text');
                if (domTextEl) {
                    const emoji = categoryEmojis[dominantCat] || '📌';
                    domTextEl.textContent = activeCount > 0 ? `${emoji} ${dominantCat}` : 'Analiz ediliyor...';
                }

                // ═══════════════════════════════════════════════════════════════════
                // SPENDING PERSONALITY CARD UPDATE ("Harcama Karakterin" widget)
                // ═══════════════════════════════════════════════════════════════════
                // Try to find persona elements by ID first, then by fallback query selector
                let personaIconEl = document.getElementById('dna-persona-icon');
                let personaTitleEl = document.getElementById('dna-persona-title');
                let personaDescEl = document.getElementById('dna-persona-desc');

                // Fallback: Find the persona container by various methods
                let personaContainer = document.querySelector('[data-persona-widget]') ||
                    document.querySelector('.harcama-karakter-widget') ||
                    document.querySelector('.spending-personality-card');

                // Ultimate fallback: Find by text content "Analiz Ediliyor" and get parent 
                if (!personaContainer && !personaTitleEl) {
                    // Find all h3 or heading elements that contain "Analiz" 
                    const allHeadings = document.querySelectorAll('h3, h2, .text-xl');
                    for (const el of allHeadings) {
                        if (el.textContent && el.textContent.includes('Analiz')) {
                            // Found it - get the card container (usually 2-3 levels up)
                            personaContainer = el.closest('.rounded-2xl') ||
                                el.closest('.rounded-3xl') ||
                                el.closest('[class*="card"]') ||
                                el.parentElement?.parentElement;
                            if (personaContainer) {
                                console.log('[DNAWidget] Found persona container via text search');
                                break;
                            }
                        }
                    }
                }

                // Determine personality based on data
                let personality;
                if (activeCount > 0 && dominantCat !== '--') {
                    personality = spendingPersonalities[dominantCat] || spendingPersonalities['Diğer'];
                } else {
                    personality = defaultPersonality;
                }

                // Get 3D icon or fallback to regular icon
                const displayIcon = personality.icon3d || personality.icon;
                const gradientColor = personality.color || 'from-indigo-500 to-purple-600';

                // PRIORITY 1: Update via ID refs (most reliable for existing elements)
                if (personaTitleEl) {
                    if (personaIconEl) {
                        personaIconEl.className = "text-5xl mb-6 filter drop-shadow-xl animate-bounce-slow leading-relaxed";
                        personaIconEl.innerHTML = displayIcon;
                    }

                    personaTitleEl.textContent = personality.title;
                    // Enforce new styling
                    personaTitleEl.className = "text-2xl font-black tracking-tight mb-2 drop-shadow-md";

                    if (personaDescEl) {
                        personaDescEl.textContent = personality.desc;
                        personaDescEl.className = "text-xs font-medium text-white/80 max-w-[90%] leading-relaxed";
                    }

                    // Ensure container has padding
                    if (personaIconEl && personaIconEl.parentElement) {
                        personaIconEl.parentElement.classList.add('pt-2');
                    }

                    // Update card gradient if possible
                    const cardEl = document.getElementById('dna-personality-card');
                    if (cardEl) {
                        cardEl.className = `relative overflow-hidden rounded-3xl p-6 bg-gradient-to-br ${gradientColor} text-white shadow-xl shadow-indigo-500/20 card-lift transition-all duration-500`;
                    }
                    console.log('[DNAWidget] ✅ Updated via ID refs:', personality.title);
                }
                // PRIORITY 2: Find container and update via innerHTML
                else if (personaContainer) {
                    personaContainer.innerHTML = `
                                <div class="relative z-10 flex flex-col items-center text-center pt-2">
                                    <div id="dna-persona-icon" class="text-5xl mb-6 filter drop-shadow-xl animate-bounce-slow leading-relaxed">
                                        ${displayIcon}
                                    </div>
                                    <h3 class="text-[10px] font-bold text-white/70 uppercase tracking-[0.2em] mb-2">Harcama Karakterin</h3>
                                    <h2 id="dna-persona-title" class="text-2xl font-black tracking-tight mb-2 drop-shadow-md">${personality.title}</h2>
                                    <p id="dna-persona-desc" class="text-xs font-medium text-white/80 max-w-[90%] leading-relaxed">
                                        ${personality.desc}
                                    </p>
                                </div>
                            `;
                    console.log('[DNAWidget] ✅ Updated via innerHTML:', personality.title);
                }

                // ═══════════════════════════════════════════════════════════════════
                // MONTH COMPARISON CARD UPDATE ("Geçen Aya Göre" widget)
                // ═══════════════════════════════════════════════════════════════════
                const monthCompEl = document.getElementById('dna-month-comparison');
                if (monthCompEl) {
                    // Calculate last month's expenses
                    const lastMonth = APP_MONTH === 1 ? 12 : APP_MONTH - 1;
                    const lastMonthYear = APP_MONTH === 1 ? APP_YEAR - 1 : APP_YEAR;
                    // FIXED: Correct localStorage key - was fingenda_transactions_, should be my_expenses_
                    const lastMonthTxKey = `my_expenses_${lastMonthYear}`;
                    const lastMonthAllTx = JSON.parse(localStorage.getItem(lastMonthTxKey) || '[]');

                    const lastMonthExpenses = lastMonthAllTx.filter(t => {
                        if (!t.date || t.type !== 'expense') return false;
                        const d = new Date(t.date);
                        if (d.getMonth() + 1 !== lastMonth || d.getFullYear() !== lastMonthYear) return false;
                        const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : false;
                        return !isSavings;
                    });

                    const lastMonthTotal = lastMonthExpenses.reduce((sum, t) => sum + Math.abs(parseFloat(t.amount) || 0), 0);
                    const thisMonthTotal = total;

                    // Calculate change
                    let changePercent = 0;
                    let changeDirection = 'equal';

                    if (lastMonthTotal > 0) {
                        changePercent = Math.round(((thisMonthTotal - lastMonthTotal) / lastMonthTotal) * 100);
                        changeDirection = changePercent > 0 ? 'up' : (changePercent < 0 ? 'down' : 'equal');
                    } else if (thisMonthTotal > 0) {
                        changePercent = 100;
                        changeDirection = 'up';
                    }

                    // Format amounts
                    const formatAmount = (amt) => amt.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';

                    // Determine styling based on direction (for expenses: down is good, up is bad)
                    let badgeClass, badgeText, arrowIcon;
                    if (changeDirection === 'down') {
                        badgeClass = 'bg-emerald-100 text-emerald-600 dark:bg-emerald-500/20 dark:text-emerald-400';
                        badgeText = `↓ %${Math.abs(changePercent)} Düşüş`;
                        arrowIcon = '📉';
                    } else if (changeDirection === 'up') {
                        badgeClass = 'bg-rose-100 text-rose-600 dark:bg-rose-500/20 dark:text-rose-400';
                        badgeText = `↑ %${Math.abs(changePercent)} Artış`;
                        arrowIcon = '📈';
                    } else {
                        badgeClass = 'bg-gray-100 text-gray-500 dark:bg-gray-500/20 dark:text-gray-400';
                        badgeText = 'Değişim Yok';
                        arrowIcon = '➖';
                    }

                    // Check if we have enough data
                    if (activeCount === 0 && lastMonthTotal === 0) {
                        monthCompEl.innerHTML = `
                            <h3 class="text-lg font-black text-gray-900 dark:text-white">--</h3>
                            <span class="text-xs font-bold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 dark:bg-gray-500/20 dark:text-gray-400">Veri Yok</span>
                        `;
                    } else {
                        monthCompEl.innerHTML = `
                            <h3 class="text-lg font-black text-gray-900 dark:text-white">${formatAmount(thisMonthTotal)}</h3>
                            <span class="text-xs font-bold px-2 py-0.5 rounded-full ${badgeClass}">${badgeText}</span>
                        `;
                    }
                }

                console.log('[DNAWidget] ✅ Updated:', { dominant: dominantCat, active: activeCount, diversity: diversityScore });

            } catch (e) {
                console.warn('[DNAWidget] Update failed:', e);
            }
        };

        // Auto-update on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(window.updateDNAWidget, 2500);
        });

        // Listen for data changes
        ['fingenda_data_updated', 'storage'].forEach(evt => {
            window.addEventListener(evt, () => setTimeout(window.updateDNAWidget, 500));
        });

        console.log('[DNAWidgetSystem] ✅ DNA widget sistemi yüklendi');
    })();
</script>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- FINGO CHAT V2 ENHANCED STYLES -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<style>
    /* Custom Animation for Character Widget */
    @keyframes bounce-slow {

        0%,
        100% {
            transform: translateY(-3%);
            animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }

        50% {
            transform: translateY(3%);
            animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
    }

    .animate-bounce-slow {
        animation: bounce-slow 3s infinite;
    }
</style>
<style>
    /* V2 Message Bubbles */
    .fb-message-v2 {
        padding: 14px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.5;
    }

    .fb-message-ai-v2 {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.05));
        backdrop-filter: blur(8px);
        border: 1px solid rgba(99, 102, 241, 0.1);
        color: #374151;
    }

    html.dark .fb-message-ai-v2 {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.08));
        border-color: rgba(139, 92, 246, 0.15);
        color: #f3f4f6;
    }

    .fb-message-user-v2 {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        margin-left: auto;
    }

    /* V2 Typing Dots */
    .fb-typing-dot-v2 {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        animation: typingBounceV2 1.4s infinite ease-in-out both;
    }

    @keyframes typingBounceV2 {

        0%,
        80%,
        100% {
            transform: scale(0.6);
            opacity: 0.5;
        }

        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* V2 Chip Styles */
    .fb-chip-v2 {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        background: white;
        border: 1.5px solid transparent;
        transition: all 0.2s ease;
        cursor: pointer;
        white-space: nowrap;
    }

    html.dark .fb-chip-v2 {
        background: rgba(30, 30, 40, 0.8) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .fb-chip-v2:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    html.dark .fb-chip-v2:hover {
        background: rgba(40, 40, 55, 0.9) !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        border-color: rgba(255, 255, 255, 0.2) !important;
    }

    /* Chip Color Variants */
    .fb-chip-v2--indigo {
        border-color: rgba(99, 102, 241, 0.3);
        color: #6366f1;
    }

    .fb-chip-v2--indigo:hover {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05));
        border-color: #6366f1;
    }

    .fb-chip-v2--purple {
        border-color: rgba(139, 92, 246, 0.3);
        color: #8b5cf6;
    }

    .fb-chip-v2--purple:hover {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
        border-color: #8b5cf6;
    }

    .fb-chip-v2--orange {
        border-color: rgba(249, 115, 22, 0.3);
        color: #f97316;
    }

    .fb-chip-v2--orange:hover {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(249, 115, 22, 0.05));
        border-color: #f97316;
    }

    .fb-chip-v2--emerald {
        border-color: rgba(16, 185, 129, 0.3);
        color: #10b981;
    }

    .fb-chip-v2--emerald:hover {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        border-color: #10b981;
    }

    .fb-chip-v2--cyan {
        border-color: rgba(6, 182, 212, 0.3);
        color: #06b6d4;
    }

    .fb-chip-v2--cyan:hover {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(6, 182, 212, 0.05));
        border-color: #06b6d4;
    }

    .fb-chip-v2--rose {
        border-color: rgba(244, 63, 94, 0.3);
        color: #f43f5e;
    }

    .fb-chip-v2--rose:hover {
        background: linear-gradient(135deg, rgba(244, 63, 94, 0.1), rgba(244, 63, 94, 0.05));
        border-color: #f43f5e;
    }

    .fb-chip-v2--amber {
        border-color: rgba(245, 158, 11, 0.3);
        color: #f59e0b;
    }

    .fb-chip-v2--amber:hover {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
        border-color: #f59e0b;
    }

    .fb-chip-v2--teal {
        border-color: rgba(20, 184, 166, 0.3);
        color: #14b8a6;
    }

    .fb-chip-v2--teal:hover {
        background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(20, 184, 166, 0.05));
        border-color: #14b8a6;
    }

    /* Dark mode chip colors */
    html.dark .fb-chip-v2--indigo {
        color: #818cf8;
        border-color: rgba(129, 140, 248, 0.3);
    }

    html.dark .fb-chip-v2--purple {
        color: #a78bfa;
        border-color: rgba(167, 139, 250, 0.3);
    }

    html.dark .fb-chip-v2--orange {
        color: #fb923c;
        border-color: rgba(251, 146, 60, 0.3);
    }

    html.dark .fb-chip-v2--emerald {
        color: #34d399;
        border-color: rgba(52, 211, 153, 0.3);
    }

    html.dark .fb-chip-v2--cyan {
        color: #22d3ee;
        border-color: rgba(34, 211, 238, 0.3);
    }

    html.dark .fb-chip-v2--rose {
        color: #fb7185;
        border-color: rgba(251, 113, 133, 0.3);
    }

    html.dark .fb-chip-v2--amber {
        color: #fbbf24;
        border-color: rgba(251, 191, 36, 0.3);
    }

    html.dark .fb-chip-v2--teal {
        color: #2dd4bf;
        border-color: rgba(45, 212, 191, 0.3);
    }

    /* Active chip state */
    .fb-chip-v2:active {
        transform: scale(0.95);
    }

    /* Chat input v2 focus state */
    .fb-chat-input-v2:focus {
        background: white;
    }

    html.dark .fb-chat-input-v2:focus {
        background: rgba(255, 255, 255, 0.08);
    }

    /* Send button animation */
    .fb-send-btn-v2 svg {
        transition: transform 0.2s ease;
    }

    .fb-send-btn-v2:hover svg {
        transform: translateY(-2px) rotate(-45deg);
    }

    /* ════════════════════════════════════════════════════════════════════ */
    /* FINGOBRAIN ASSISTANT ENHANCEMENT STYLES                              */
    /* ════════════════════════════════════════════════════════════════════ */

    /* Mode Button Styles */
    .fb-mode-btn {
        background: transparent;
        color: #6b7280;
        border: none;
    }

    .fb-mode-btn.active {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .fb-mode-btn:not(.active):hover {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
    }

    html.dark .fb-mode-btn {
        color: #9ca3af;
    }

    html.dark .fb-mode-btn.active {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
    }

    html.dark .fb-mode-btn:not(.active):hover {
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
    }

    /* Shimmer Animation for Challenge Widget */
    @keyframes shimmer {
        0% {
            transform: translateX(-100%);
        }

        100% {
            transform: translateX(100%);
        }
    }

    .animate-shimmer {
        animation: shimmer 2s infinite;
    }

    /* Context Card Styles */
    .fb-context-card {
        padding: 0.625rem;
        border-radius: 1rem;
        background: rgba(249, 250, 251, 0.8);
        border: 1px solid rgba(229, 231, 235, 0.5);
        transition: all 0.2s ease;
        text-align: left;
        cursor: pointer;
    }

    .fb-context-card:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .fb-context-card:active {
        transform: scale(0.98);
    }

    html.dark .fb-context-card {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    html.dark .fb-context-card:hover {
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Rich Response Bar Styles */
    .fb-response-bar {
        height: 0.5rem;
        border-radius: 9999px;
        background: #e5e7eb;
        overflow: hidden;
    }

    .fb-response-bar-fill {
        height: 100%;
        border-radius: 9999px;
        transition: width 0.5s ease;
    }

    html.dark .fb-response-bar {
        background: rgba(255, 255, 255, 0.1);
    }

    /* ════════════════════════════════════════════════════════════════════ */
    /* MOBILE NAVIGATION BAR FIX (Truly Transparent Floating Glass)         */
    /* ════════════════════════════════════════════════════════════════════ */

    /* Fix: Remove solid background from glass-card-strong for nav bar */
    #main-nav.glass-card-strong {
        background-color: transparent !important;
        background-image: none !important;
    }

    /* Parent wrapper should be transparent */
    #main-nav {
        /* Transparent glass effect - same as header */
        background: rgba(255, 255, 255, 0.65) !important;
        backdrop-filter: blur(24px) saturate(180%) !important;
        -webkit-backdrop-filter: blur(24px) saturate(180%) !important;
        border: 1px solid rgba(255, 255, 255, 0.4) !important;
        box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(255, 255, 255, 0.2) inset !important;
    }

    html.dark #main-nav {
        /* Dark mode: truly transparent glass like header */
        background: rgba(30, 27, 56, 0.6) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important;
        backdrop-filter: blur(24px) saturate(180%) !important;
        -webkit-backdrop-filter: blur(24px) saturate(180%) !important;
    }

    @media (max-width: 768px) {

        /* Parent wrapper - must be transparent */
        #main-nav {
            /* Floating Position - REMOVE any fixed wrapper backgrounds */
            position: fixed !important;
            bottom: max(20px, env(safe-area-inset-bottom)) !important;
            left: 16px !important;
            right: 16px !important;
            width: auto !important;
            height: auto !important;
            min-height: 70px !important;

            /* Shape - Capsule */
            border-radius: 24px !important;

            /* TRANSPARENT Glass Effect - Like Header */
            background: rgba(255, 255, 255, 0.45) !important;
            background-color: rgba(255, 255, 255, 0.45) !important;
            backdrop-filter: blur(28px) saturate(200%) !important;
            -webkit-backdrop-filter: blur(28px) saturate(200%) !important;

            /* Clean border */
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            box-shadow:
                0 8px 32px -4px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6) !important;

            /* Layout */
            display: flex !important;
            justify-content: space-around !important;
            align-items: center !important;
            padding: 0 10px !important;
            z-index: 9999 !important;
            margin: 0 !important;

            /* Ensure no clip-path hides blur effects */
            clip-path: none !important;
            -webkit-clip-path: none !important;
            overflow: visible !important;
        }

        /* Dark Mode - TRULY TRANSPARENT like header */
        html.dark #main-nav {
            /* Much more transparent - content behind should be blurred but visible */
            background: rgba(20, 17, 40, 0.55) !important;
            background-color: rgba(20, 17, 40, 0.55) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            box-shadow:
                0 8px 32px -4px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(28px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(28px) saturate(180%) !important;
        }

        /* Nav Items Adjustment */
        #main-nav .nav-item {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
            transform: scale(0.95);
        }

        /* Remove any pseudo-elements that might create solid backgrounds */
        #main-nav::before,
        #main-nav::after {
            display: none !important;
            background: transparent !important;
        }

        /* Override glass-card-strong styles specifically for nav */
        #main-nav.glass-card-strong,
        .glass-card-strong#main-nav {
            background-color: transparent !important;
            background: transparent !important;
        }

        /* Nav wrapper must be completely transparent */
        #nav-wrapper {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            pointer-events: none !important;
            /* Allow clicks to pass through unused areas */
        }

        /* Re-enable pointer events on the actual nav pill */
        #nav-wrapper #main-nav {
            pointer-events: auto !important;
        }

        /* Ensure no pseudo-elements creating black background */
        #nav-wrapper::before,
        #nav-wrapper::after {
            display: none !important;
            content: none !important;
            background: transparent !important;
        }

        /* Hide any other potential bottom bars */
        .safe-area-bg,
        #bottom-safe-area {
            display: none !important;
            opacity: 0 !important;
        }
    }
</style>



<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- FINGO ONBOARDING v4.0 — Premium Feature Spotlight                         -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->

<style>
    /* FINGO ONBOARDING v4.0 */

    :root {
        --fo-slide1: #6366F1;
        --fo-slide1-light: #E0E7FF;
        --fo-slide1-bg: linear-gradient(160deg, #eef2ff 0%, #e0e7ff 40%, #c7d2fe 100%);
        --fo-slide2: #10B981;
        --fo-slide2-light: #D1FAE5;
        --fo-slide2-bg: linear-gradient(160deg, #ecfdf5 0%, #d1fae5 40%, #a7f3d0 100%);
        --fo-slide3: #3B82F6;
        --fo-slide3-light: #DBEAFE;
        --fo-slide3-bg: linear-gradient(160deg, #eff6ff 0%, #dbeafe 40%, #bfdbfe 100%);
        --fo-slide4: #F59E0B;
        --fo-slide4-light: #FEF3C7;
        --fo-slide4-bg: linear-gradient(160deg, #fffbeb 0%, #fef3c7 40%, #fde68a 100%);
        --fo-slide5: #8B5CF6;
        --fo-slide5-light: #EDE9FE;
        --fo-slide5-bg: linear-gradient(160deg, #f5f3ff 0%, #ede9fe 40%, #ddd6fe 100%);
        --fo-slide6: #EC4899;
        --fo-slide6-light: #FCE7F3;
        --fo-slide6-bg: linear-gradient(160deg, #fdf2f8 0%, #fce7f3 40%, #fbcfe8 100%);
    }

    html.dark {
        --fo-slide1-bg: linear-gradient(160deg, #0f0d1a 0%, #1e1b4b 40%, #1e1b4b 100%);
        --fo-slide2-bg: linear-gradient(160deg, #022c22 0%, #064e3b 40%, #065f46 100%);
        --fo-slide3-bg: linear-gradient(160deg, #0c1929 0%, #1e3a5f 40%, #1e40af 100%);
        --fo-slide4-bg: linear-gradient(160deg, #1c1407 0%, #451a03 40%, #78350f 100%);
        --fo-slide5-bg: linear-gradient(160deg, #0f0720 0%, #2e1065 40%, #3b0764 100%);
        --fo-slide6-bg: linear-gradient(160deg, #1a0a14 0%, #4a0e2e 40%, #831843 100%);
    }

    #fingo-onboarding {
        position: fixed;
        inset: 0;
        z-index: 999999;
        display: flex;
        flex-direction: column;
        background: var(--fo-slide1-bg);
        opacity: 1;
        overflow: hidden;
        transition: background 0.6s ease, opacity 0.5s ease;
        -webkit-user-select: none;
        user-select: none;
        font-family: -apple-system, 'SF Pro Display', 'Helvetica Neue', system-ui, sans-serif;
    }

    #fingo-onboarding.fo-hidden {
        display: none !important;
    }

    #fingo-onboarding.fo-fadeout {
        opacity: 0;
        pointer-events: none;
    }

    #fingo-onboarding::before {
        content: '';
        position: absolute;
        inset: 0;
        opacity: 0.02;
        z-index: 0;
        pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        background-size: 200px;
    }

    .fo-topbar {
        position: relative;
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: max(12px, env(safe-area-inset-top, 12px)) 24px 0;
    }

    .fo-skip {
        background: none;
        border: none;
        font-size: 15px;
        font-weight: 500;
        color: rgba(0, 0, 0, 0.35);
        cursor: pointer;
        padding: 8px 0;
        transition: color 0.2s;
    }

    .fo-skip:active {
        transform: scale(0.95);
    }

    html.dark .fo-skip {
        color: rgba(255, 255, 255, 0.35);
    }

    .fo-counter {
        font-size: 13px;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.25);
        letter-spacing: 0.05em;
    }

    html.dark .fo-counter {
        color: rgba(255, 255, 255, 0.25);
    }

    .fo-progress-wrap {
        padding: 10px 24px 0;
        position: relative;
        z-index: 10;
    }

    .fo-progress-track {
        width: 100%;
        height: 3px;
        border-radius: 2px;
        background: rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    html.dark .fo-progress-track {
        background: rgba(255, 255, 255, 0.08);
    }

    .fo-progress-fill {
        height: 100%;
        border-radius: 2px;
        width: 16.66%;
        background: var(--fo-slide1);
        transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1), background 0.5s ease;
    }

    .fo-slides {
        flex: 1;
        position: relative;
        z-index: 1;
        display: flex;
        overflow: hidden;
        touch-action: pan-y;
    }

    .fo-slides-track {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        will-change: transform;
    }

    .fo-slides-track.dragging {
        transition: none;
    }

    .fo-slide {
        min-width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0 28px;
        box-sizing: border-box;
    }

    .fo-phone {
        width: 160px;
        height: 220px;
        border-radius: 28px;
        background: white;
        box-shadow: 0 16px 48px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.04);
        position: relative;
        overflow: hidden;
        margin-bottom: 16px;
        flex-shrink: 0;
        animation: fo-phone-float 5s ease-in-out infinite;
    }

    html.dark .fo-phone {
        background: #1a1a2e;
        box-shadow: 0 20px 60px -15px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06);
    }

    .fo-phone-notch {
        width: 80px;
        height: 20px;
        margin: 0 auto;
        background: rgba(0, 0, 0, 0.08);
        border-radius: 0 0 14px 14px;
    }

    html.dark .fo-phone-notch {
        background: rgba(0, 0, 0, 0.4);
    }

    .fo-phone-content {
        padding: 12px;
        height: calc(100% - 20px);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .fo-ph-bar {
        height: 8px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.05);
    }

    html.dark .fo-ph-bar {
        background: rgba(255, 255, 255, 0.06);
    }

    .fo-ph-card {
        border-radius: 12px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.03);
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    html.dark .fo-ph-card {
        background: rgba(255, 255, 255, 0.04);
    }

    .fo-ph-row {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .fo-ph-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .fo-ph-line {
        height: 6px;
        border-radius: 3px;
        background: rgba(0, 0, 0, 0.06);
        flex: 1;
    }

    html.dark .fo-ph-line {
        background: rgba(255, 255, 255, 0.06);
    }

    .fo-ph-chart {
        flex: 1;
        display: flex;
        align-items: flex-end;
        gap: 4px;
        padding-top: 8px;
    }

    .fo-ph-chart-bar {
        flex: 1;
        border-radius: 4px 4px 0 0;
        min-height: 10px;
    }

    @keyframes fo-phone-float {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-6px);
        }
    }

    .fo-text-area {
        text-align: center;
        width: 100%;
        max-width: 340px;
        margin-bottom: 10px;
    }

    .fo-headline {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: -0.03em;
        line-height: 1.15;
        color: #111;
        margin-bottom: 6px;
    }

    html.dark .fo-headline {
        color: #f1f1f5;
    }

    .fo-subtext {
        font-size: 14px;
        font-weight: 400;
        line-height: 1.4;
        color: rgba(0, 0, 0, 0.5);
        max-width: 300px;
        margin: 0 auto;
    }

    html.dark .fo-subtext {
        color: rgba(255, 255, 255, 0.45);
    }

    .fo-features {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
        max-width: 320px;
        margin-bottom: 12px;
    }

    .fo-feat {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.65);
        border: 1px solid rgba(0, 0, 0, 0.04);
        opacity: 0;
        transform: translateY(8px);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }

    html.dark .fo-feat {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .fo-feat.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .fo-feat-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
    }

    .fo-feat-text {
        font-size: 13px;
        font-weight: 500;
        color: #333;
        line-height: 1.35;
    }

    html.dark .fo-feat-text {
        color: #ddd;
    }

    .fo-cta-area {
        position: relative;
        z-index: 10;
        padding: 0 24px max(20px, env(safe-area-inset-bottom, 20px));
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .fo-cta {
        width: 100%;
        max-width: 360px;
        height: 48px;
        border: none;
        border-radius: 14px;
        font-size: 15px;
        font-weight: 600;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .fo-cta::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(to bottom, rgba(255, 255, 255, 0.18), transparent);
        border-radius: 16px 16px 0 0;
        pointer-events: none;
    }

    .fo-cta:active {
        transform: scale(0.97);
    }

    .fo-cta-secondary {
        width: 100%;
        max-width: 360px;
        height: 44px;
        background: none;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        color: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .fo-cta-secondary:active {
        transform: scale(0.97);
    }

    html.dark .fo-cta-secondary {
        color: rgba(255, 255, 255, 0.35);
    }

    .fo-slide[data-slide="1"] .fo-feat-icon {
        background: rgba(99, 102, 241, 0.12);
    }

    .fo-slide[data-slide="2"] .fo-feat-icon {
        background: rgba(16, 185, 129, 0.12);
    }

    .fo-slide[data-slide="3"] .fo-feat-icon {
        background: rgba(59, 130, 246, 0.12);
    }

    .fo-slide[data-slide="4"] .fo-feat-icon {
        background: rgba(245, 158, 11, 0.12);
    }

    .fo-slide[data-slide="5"] .fo-feat-icon {
        background: rgba(139, 92, 246, 0.12);
    }

    .fo-slide[data-slide="6"] .fo-feat-icon {
        background: rgba(236, 72, 153, 0.12);
    }

    @media (max-height: 680px) {
        .fo-phone {
            width: 160px;
            height: 220px;
            margin-bottom: 20px;
        }

        .fo-headline {
            font-size: 22px;
        }

        .fo-feat {
            padding: 8px 12px;
        }
    }

    @media (max-height: 560px) {
        .fo-phone {
            width: 120px;
            height: 170px;
            margin-bottom: 14px;
            border-radius: 22px;
        }

        .fo-headline {
            font-size: 20px;
        }

        .fo-subtext {
            font-size: 13px;
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .fo-phone {
            animation: none !important;
        }

        .fo-slides-track {
            transition-duration: 0.2s !important;
        }

        .fo-feat {
            transition: none !important;
            opacity: 1 !important;
            transform: none !important;
        }
    }
</style>

<div id="fingo-onboarding" class="fo-hidden">
    <div class="fo-topbar">
        <button class="fo-skip" onclick="fingoOnboarding.skip()">Atla</button>
        <span class="fo-counter" id="fo-counter">1 / 6</span>
    </div>
    <div class="fo-progress-wrap">
        <div class="fo-progress-track">
            <div class="fo-progress-fill" id="fo-progress"></div>
        </div>
    </div>
    <div class="fo-slides" id="fo-slides">
        <div class="fo-slides-track" id="fo-track">

            <!-- Slide 1: Welcome -->
            <div class="fo-slide" data-slide="1">
                <div class="fo-phone">
                    <div class="fo-phone-notch"></div>
                    <div class="fo-phone-content">
                        <div class="fo-ph-bar" style="width:40%;"></div>
                        <div class="fo-ph-card">
                            <div class="fo-ph-row">
                                <div class="fo-ph-dot" style="background:#6366F1;"></div>
                                <div class="fo-ph-line" style="width:60%;"></div>
                            </div>
                            <div style="font-size:28px;text-align:center;margin:12px 0;">&#x1F4B0;</div>
                            <div class="fo-ph-bar" style="width:70%; margin:0 auto;"></div>
                            <div class="fo-ph-bar" style="width:50%; margin:4px auto 0;"></div>
                        </div>
                        <div class="fo-ph-card" style="flex:0.6;">
                            <div class="fo-ph-row">
                                <div class="fo-ph-dot" style="background:#10B981;"></div>
                                <div class="fo-ph-line" style="width:45%;"></div>
                            </div>
                            <div class="fo-ph-row">
                                <div class="fo-ph-dot" style="background:#F59E0B;"></div>
                                <div class="fo-ph-line" style="width:55%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fo-text-area">
                    <h2 class="fo-headline">Fingo'ya Ho&#x15F; Geldin</h2>
                    <p class="fo-subtext">Ki&#x15F;isel finans&#x131;n&#x131; y&#xF6;netmenin en ak&#x131;ll&#x131; ve
                        en &#x15F;&#x131;k yolu.</p>
                </div>
                <div class="fo-features">
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F4CA;</div>
                        <div class="fo-feat-text">Gelir, gider ve birikimlerini tek ekranda g&#xF6;r</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F916;</div>
                        <div class="fo-feat-text">Yapay zeka destekli finansal analiz</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F512;</div>
                        <div class="fo-feat-text">Veriler cihaz&#x131;nda &#x2014; %100 gizli ve g&#xFC;venli</div>
                    </div>
                </div>
            </div>

            <!-- Slide 2: Dashboard -->
            <div class="fo-slide" data-slide="2">
                <div class="fo-phone">
                    <div class="fo-phone-notch"></div>
                    <div class="fo-phone-content">
                        <div class="fo-ph-bar" style="width:50%;"></div>
                        <div style="display:flex;gap:6px;">
                            <div
                                style="flex:1;text-align:center;padding:6px;border-radius:8px;background:rgba(16,185,129,0.1);font-size:10px;color:#10B981;font-weight:600;">
                                Gelir</div>
                            <div
                                style="flex:1;text-align:center;padding:6px;border-radius:8px;background:rgba(239,68,68,0.1);font-size:10px;color:#EF4444;font-weight:600;">
                                Gider</div>
                            <div
                                style="flex:1;text-align:center;padding:6px;border-radius:8px;background:rgba(245,158,11,0.1);font-size:10px;color:#F59E0B;font-weight:600;">
                                Birikim</div>
                        </div>
                        <div class="fo-ph-chart">
                            <div class="fo-ph-chart-bar" style="height:70%;background:#34D399;"></div>
                            <div class="fo-ph-chart-bar" style="height:50%;background:#F87171;"></div>
                            <div class="fo-ph-chart-bar" style="height:30%;background:#FBBF24;"></div>
                            <div class="fo-ph-chart-bar" style="height:85%;background:#34D399;opacity:0.6;"></div>
                            <div class="fo-ph-chart-bar" style="height:40%;background:#F87171;opacity:0.6;"></div>
                        </div>
                    </div>
                </div>
                <div class="fo-text-area">
                    <h2 class="fo-headline">Gelir &amp; Gider Takibi</h2>
                    <p class="fo-subtext">Ayl&#x131;k finansal durumunu grafikler ve analizlerle takip et.</p>
                </div>
                <div class="fo-features">
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F4C8;</div>
                        <div class="fo-feat-text">&#x130;nteraktif grafikler ile gelir-gider
                            kar&#x15F;&#x131;la&#x15F;t&#x131;rmas&#x131;</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F3F7;&#xFE0F;</div>
                        <div class="fo-feat-text">Kategori bazl&#x131; harcama analizi ve pasta grafik</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F4C5;</div>
                        <div class="fo-feat-text">Ayl&#x131;k ve y&#x131;ll&#x131;k g&#xF6;r&#xFC;n&#xFC;m ile trend
                            takibi</div>
                    </div>
                </div>
            </div>

            <!-- Slide 3: Transactions -->
            <div class="fo-slide" data-slide="3">
                <div class="fo-phone">
                    <div class="fo-phone-notch"></div>
                    <div class="fo-phone-content">
                        <div class="fo-ph-bar" style="width:35%;"></div>
                        <div class="fo-ph-card" style="flex:0;padding:8px 10px;">
                            <div class="fo-ph-row">
                                <div class="fo-ph-dot" style="background:#EF4444;"></div>
                                <div class="fo-ph-line" style="width:50%;"></div>
                                <div style="font-size:9px;color:#EF4444;font-weight:700;">-&#x20BA;1.250</div>
                            </div>
                        </div>
                        <div class="fo-ph-card" style="flex:0;padding:8px 10px;">
                            <div class="fo-ph-row">
                                <div class="fo-ph-dot" style="background:#10B981;"></div>
                                <div class="fo-ph-line" style="width:45%;"></div>
                                <div style="font-size:9px;color:#10B981;font-weight:700;">+&#x20BA;8.500</div>
                            </div>
                        </div>
                        <div class="fo-ph-card" style="flex:0;padding:8px 10px;">
                            <div class="fo-ph-row">
                                <div class="fo-ph-dot" style="background:#F59E0B;"></div>
                                <div class="fo-ph-line" style="width:55%;"></div>
                                <div style="font-size:9px;color:#F59E0B;font-weight:700;">&#x20BA;2.000</div>
                            </div>
                        </div>
                        <div
                            style="margin-top:auto;height:28px;border-radius:8px;background:linear-gradient(135deg,#3B82F6,#6366F1);display:flex;align-items:center;justify-content:center;">
                            <span style="color:white;font-size:14px;font-weight:600;">+</span>
                        </div>
                    </div>
                </div>
                <div class="fo-text-area">
                    <h2 class="fo-headline">Ak&#x131;ll&#x131; &#x130;&#x15F;lem Y&#xF6;netimi</h2>
                    <p class="fo-subtext">Gelir, gider ve yat&#x131;r&#x131;mlar&#x131;n&#x131; saniyeler i&#xE7;inde
                        kaydet.</p>
                </div>
                <div class="fo-features">
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x26A1;</div>
                        <div class="fo-feat-text">H&#x131;zl&#x131; ekleme ile gelir, gider veya yat&#x131;r&#x131;m
                            kayd&#x131;</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F504;</div>
                        <div class="fo-feat-text">Tekrarlayan i&#x15F;lemler: maa&#x15F;, kira, abonelikler</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F48E;</div>
                        <div class="fo-feat-text">Alt&#x131;n, dolar, euro yat&#x131;r&#x131;m takibi</div>
                    </div>
                </div>
            </div>

            <!-- Slide 4: Markets -->
            <div class="fo-slide" data-slide="4">
                <div class="fo-phone">
                    <div class="fo-phone-notch"></div>
                    <div class="fo-phone-content">
                        <div class="fo-ph-bar" style="width:45%;"></div>
                        <div class="fo-ph-card" style="flex:0;padding:8px 10px;">
                            <div class="fo-ph-row"><span style="font-size:12px;">&#x1F1FA;&#x1F1F8;</span>
                                <div class="fo-ph-line" style="width:30%;"></div>
                                <div style="font-size:9px;color:#10B981;font-weight:700;">&#x20BA;38.45 &#x2191;</div>
                            </div>
                        </div>
                        <div class="fo-ph-card" style="flex:0;padding:8px 10px;">
                            <div class="fo-ph-row"><span style="font-size:12px;">&#x1F1EA;&#x1F1FA;</span>
                                <div class="fo-ph-line" style="width:30%;"></div>
                                <div style="font-size:9px;color:#EF4444;font-weight:700;">&#x20BA;41.20 &#x2193;</div>
                            </div>
                        </div>
                        <div class="fo-ph-card" style="flex:0;padding:8px 10px;">
                            <div class="fo-ph-row"><span style="font-size:12px;">&#x1F947;</span>
                                <div class="fo-ph-line" style="width:30%;"></div>
                                <div style="font-size:9px;color:#F59E0B;font-weight:700;">&#x20BA;3.250</div>
                            </div>
                        </div>
                        <div class="fo-ph-chart" style="flex:1;">
                            <div class="fo-ph-chart-bar" style="height:45%;background:#F59E0B;"></div>
                            <div class="fo-ph-chart-bar" style="height:55%;background:#F59E0B;opacity:0.8;"></div>
                            <div class="fo-ph-chart-bar" style="height:70%;background:#F59E0B;opacity:0.7;"></div>
                            <div class="fo-ph-chart-bar" style="height:60%;background:#F59E0B;opacity:0.6;"></div>
                            <div class="fo-ph-chart-bar" style="height:80%;background:#F59E0B;"></div>
                        </div>
                    </div>
                </div>
                <div class="fo-text-area">
                    <h2 class="fo-headline">Piyasa &amp; D&#xF6;viz</h2>
                    <p class="fo-subtext">Anl&#x131;k d&#xF6;viz kurlar&#x131; ve alt&#x131;n fiyatlar&#x131;n&#x131;
                        takip et.</p>
                </div>
                <div class="fo-features">
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F4B5;</div>
                        <div class="fo-feat-text">Dolar, Euro ve di&#x11F;er d&#xF6;viz kurlar&#x131; anl&#x131;k</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1FA99;</div>
                        <div class="fo-feat-text">Gram alt&#x131;n, &#xE7;eyrek alt&#x131;n fiyat takibi</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F504;</div>
                        <div class="fo-feat-text">D&#xF6;viz &#xE7;evirici ile h&#x131;zl&#x131; hesaplama</div>
                    </div>
                </div>
            </div>

            <!-- Slide 5: Fingo Brain -->
            <div class="fo-slide" data-slide="5">
                <div class="fo-phone">
                    <div class="fo-phone-notch"></div>
                    <div class="fo-phone-content">
                        <div class="fo-ph-bar" style="width:55%;"></div>
                        <div style="display:flex;gap:4px;margin:4px 0;">
                            <div
                                style="flex:1;padding:4px;border-radius:6px;background:rgba(139,92,246,0.15);font-size:8px;text-align:center;color:#8B5CF6;font-weight:600;">
                                Pulse</div>
                            <div
                                style="flex:1;padding:4px;border-radius:6px;font-size:8px;text-align:center;color:rgba(0,0,0,0.3);">
                                DNA</div>
                            <div
                                style="flex:1;padding:4px;border-radius:6px;font-size:8px;text-align:center;color:rgba(0,0,0,0.3);">
                                AI Lab</div>
                        </div>
                        <div class="fo-ph-card"
                            style="background:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(99,102,241,0.05));">
                            <div style="font-size:9px;font-weight:600;color:#8B5CF6;margin-bottom:4px;">FingoScore</div>
                            <div class="fo-ph-bar"
                                style="width:75%;background:linear-gradient(90deg,#8B5CF6,#6366F1);height:6px;border-radius:3px;">
                            </div>
                            <div class="fo-ph-row" style="margin-top:4px;">
                                <div class="fo-ph-line" style="width:80%;"></div>
                            </div>
                        </div>
                        <div class="fo-ph-card" style="flex:0.5;">
                            <div style="font-size:8px;color:rgba(0,0,0,0.4);margin-bottom:2px;">AI Tahmin</div>
                            <div class="fo-ph-row">
                                <div class="fo-ph-dot" style="background:#8B5CF6;width:6px;height:6px;"></div>
                                <div class="fo-ph-line" style="width:65%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fo-text-area">
                    <h2 class="fo-headline">Fingo Brain &#x1F9E0;</h2>
                    <p class="fo-subtext">Yapay zeka finansal asistan&#x131;n ile para y&#xF6;netimini
                        ustala&#x15F;t&#x131;r.</p>
                </div>
                <div class="fo-features">
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F3AF;</div>
                        <div class="fo-feat-text">FingoScore ile finansal sa&#x11F;l&#x131;k puan&#x131;n</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F52E;</div>
                        <div class="fo-feat-text">3 ayl&#x131;k gelecek tahmini ve enflasyon sim&#xFC;lat&#xF6;r&#xFC;
                        </div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F9EC;</div>
                        <div class="fo-feat-text">Finansal DNA analizi: harcama al&#x131;&#x15F;kanl&#x131;klar&#x131;n
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide 6: Get Started -->
            <div class="fo-slide" data-slide="6">
                <div class="fo-phone">
                    <div class="fo-phone-notch"></div>
                    <div class="fo-phone-content" style="align-items:center;justify-content:center;">
                        <div style="font-size:40px;margin-bottom:8px;">&#x1F680;</div>
                        <div style="font-size:11px;font-weight:700;color:#EC4899;text-align:center;">
                            Haz&#x131;rs&#x131;n!</div>
                        <div class="fo-ph-bar" style="width:60%;margin:6px auto 0;"></div>
                    </div>
                </div>
                <div class="fo-text-area">
                    <h2 class="fo-headline">Ba&#x15F;lamaya Haz&#x131;rs&#x131;n</h2>
                    <p class="fo-subtext">Premium ile t&#xFC;m &#xF6;zelliklere s&#x131;n&#x131;rs&#x131;z eri&#x15F;,
                        veya &#xFC;cretsiz ke&#x15F;fet.</p>
                </div>
                <div class="fo-features">
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F451;</div>
                        <div class="fo-feat-text">Premium: Fingo Brain, s&#x131;n&#x131;rs&#x131;z analiz,
                            reklams&#x131;z</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x2728;</div>
                        <div class="fo-feat-text">&#xDC;cretsiz: Gelir-gider takibi, d&#xF6;viz, grafikler</div>
                    </div>
                    <div class="fo-feat">
                        <div class="fo-feat-icon">&#x1F510;</div>
                        <div class="fo-feat-text">&#x130;stedi&#x11F;in zaman Premium'a y&#xFC;kseltilebilir</div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="fo-cta-area" id="fo-cta-area">
        <button class="fo-cta" id="fo-cta-btn" onclick="fingoOnboarding.next()"
            style="background:linear-gradient(135deg,#6366F1,#4F46E5);box-shadow:0 8px 24px -6px rgba(99,102,241,0.45);">Devam
            Et</button>
    </div>
</div>

<script>
    const fingoOnboarding = {
        current: 0, total: 6,
        overlay: null, track: null, progress: null, counter: null, ctaArea: null,
        startX: 0, currentX: 0, isDragging: false,
        colors: [
            { main: '#6366F1', shadow: 'rgba(99,102,241,0.45)' },
            { main: '#10B981', shadow: 'rgba(16,185,129,0.45)' },
            { main: '#3B82F6', shadow: 'rgba(59,130,246,0.45)' },
            { main: '#F59E0B', shadow: 'rgba(245,158,11,0.45)' },
            { main: '#8B5CF6', shadow: 'rgba(139,92,246,0.45)' },
            { main: '#EC4899', shadow: 'rgba(236,72,153,0.45)' }
        ],
        init() {
            this.overlay = document.getElementById('fingo-onboarding');
            this.track = document.getElementById('fo-track');
            this.progress = document.getElementById('fo-progress');
            this.counter = document.getElementById('fo-counter');
            this.ctaArea = document.getElementById('fo-cta-area');
            if (localStorage.getItem('fingo_onboarding_completed') === 'true') { this.overlay.classList.add('fo-hidden'); return; }
            this.overlay.classList.remove('fo-hidden');
            this.setupTouch();
            this.updateUI();
            this.revealFeatures();
        },
        setupTouch() {
            var self = this;
            var slides = document.getElementById('fo-slides');
            slides.addEventListener('touchstart', function (e) { self.startX = e.touches[0].clientX; self.isDragging = true; self.track.classList.add('dragging'); }, { passive: true });
            slides.addEventListener('touchmove', function (e) {
                if (!self.isDragging) return;
                self.currentX = e.touches[0].clientX;
                var diff = self.currentX - self.startX;
                var offset = -(self.current * 100) + (diff / window.innerWidth * 100);
                self.track.style.transform = 'translateX(' + offset + '%)';
            }, { passive: true });
            slides.addEventListener('touchend', function () {
                self.isDragging = false; self.track.classList.remove('dragging');
                var diff = self.currentX - self.startX;
                if (Math.abs(diff) > 50) { diff < 0 ? self.next() : self.prev(); }
                else { self.track.style.transform = 'translateX(-' + (self.current * 100) + '%)'; }
            });
        },
        goTo(index) {
            if (index < 0 || index >= this.total) return;
            this.current = index;
            this.updateUI();
            this.revealFeatures();
        },
        updateUI() {
            this.track.style.transform = 'translateX(-' + (this.current * 100) + '%)';
            var pct = ((this.current + 1) / this.total) * 100;
            this.progress.style.width = pct + '%';
            this.progress.style.background = this.colors[this.current].main;
            this.counter.textContent = (this.current + 1) + ' / ' + this.total;
            this.overlay.style.background = 'var(--fo-slide' + (this.current + 1) + '-bg)';
            var c = this.colors[this.current];
            if (this.current === this.total - 1) {
                this.ctaArea.innerHTML = '<button class="fo-cta" onclick="fingoOnboarding.buyPremium()" style="background:linear-gradient(135deg,' + c.main + ',' + this.colors[0].main + ');box-shadow:0 8px 24px -6px ' + c.shadow + ';">Premium\'a Ge\u00e7 \uD83D\uDC51</button><button class="fo-cta-secondary" onclick="fingoOnboarding.complete()">\u00DCcretsiz Ba\u015Fla</button>';
            } else {
                this.ctaArea.innerHTML = '<button class="fo-cta" id="fo-cta-btn" onclick="fingoOnboarding.next()" style="background:linear-gradient(135deg,' + c.main + ',' + c.main + 'dd);box-shadow:0 8px 24px -6px ' + c.shadow + ';">Devam Et</button>';
            }
        },
        revealFeatures() {
            var slide = this.track.children[this.current];
            var feats = slide.querySelectorAll('.fo-feat');
            feats.forEach(function (f, i) {
                f.classList.remove('visible');
                setTimeout(function () { f.classList.add('visible'); }, 150 + i * 120);
            });
        },
        next() { if (this.current < this.total - 1) this.goTo(this.current + 1); else this.complete(); },
        prev() { if (this.current > 0) this.goTo(this.current - 1); },
        skip() { this.complete(); },
        complete() {
            localStorage.setItem('fingo_onboarding_completed', 'true');
            var pm = document.getElementById('premium-modal');
            if (pm) pm.classList.add('hidden');
            this.overlay.classList.add('fo-fadeout');
            var ov = this.overlay;
            setTimeout(function () { ov.classList.add('fo-hidden'); }, 500);
        },
        buyPremium() {
            this.complete();
            setTimeout(function () {
                var pm = document.getElementById('premium-modal');
                if (pm) pm.classList.remove('hidden');
                else if (typeof window.buyPremium === 'function') window.buyPremium();
                else if (window.PremiumManager && window.PremiumManager.showPaywall) window.PremiumManager.showPaywall();
            }, 350);
        },
        reset() {
            localStorage.removeItem('fingo_onboarding_completed');
            this.current = 0;
            this.overlay.classList.remove('fo-hidden', 'fo-fadeout');
            this.updateUI();
            this.revealFeatures();
        }
    };
    window.fingoOnboarding = fingoOnboarding;
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', function () { fingoOnboarding.init(); });
    else fingoOnboarding.init();
</script>





<!-- INSIGHT DETAIL MODAL -->
<div id="insight-detail-modal"
    class="hidden fixed inset-0 z-[99999] flex items-end justify-center sm:items-center p-4 transition-opacity duration-300"
    style="background-color: rgba(0, 0, 0, 0.85);">
    <div class="w-full max-w-md rounded-t-[32px] sm:rounded-[32px] overflow-hidden shadow-2xl transform transition-transform duration-300 relative max-h-[90vh] flex flex-col bg-[#f8f8f8] dark:bg-gray-900/95 dark:backdrop-blur-xl dark:border dark:border-white/10"
        style="backdrop-filter: none;">

        <!-- Header -->
        <div class="relative p-6 pb-2 shrink-0 z-10 bg-[#f8f8f8] dark:bg-transparent">
            <div class="flex items-center justify-between">
                <div class="w-10 h-10 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-xl shadow-sm"
                    id="insight-modal-icon-wrapper">
                    <span id="insight-modal-icon">💡</span>
                </div>
                <button onclick="window.closeInsightModal()"
                    class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <h3 id="insight-modal-title" class="text-2xl font-black text-gray-900 dark:text-white mt-4 tracking-tight">
                İçgörü Detayı</h3>
            <p id="insight-modal-subtitle" class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-1">Detaylı
                analiz ve rapor</p>
        </div>

        <!-- Scrollable Content -->
        <div id="insight-modal-body"
            class="p-6 pt-4 overflow-y-auto custom-scrollbar space-y-4 bg-[#f8f8f8] dark:bg-[#1c1c1e]">
            <!-- Dynamic Content will be injected here -->
        </div>

        <!-- Footer Actions -->
        <div class="p-6 pt-2 shrink-0 z-10 bg-[#f8f8f8] dark:bg-[#1c1c1e]">
            <button onclick="window.closeInsightModal()"
                class="w-full py-3.5 rounded-2xl bg-gray-200 dark:bg-white/10 text-gray-900 dark:text-white font-bold text-sm hover:scale-[1.02] active:scale-95 transition-all">
                Tamam
            </button>
        </div>
    </div>
</div>

<script>
    /**
     * INSIGHT DETAIL LOGIC
     * Handles clicks on dashboard insight widgets to show detailed analysis.
     */
    window.handleInsightClick = function (index, type) {
        // Prevent generic popups if any
        if (window.event) window.event.stopPropagation();

        const modal = document.getElementById('insight-detail-modal');
        const titleEl = document.getElementById('insight-modal-title');
        const subtitleEl = document.getElementById('insight-modal-subtitle');
        const iconEl = document.getElementById('insight-modal-icon');
        const bodyEl = document.getElementById('insight-modal-body');

        if (!modal || !bodyEl) return;

        // Common formatters
        const formatMoney = (amount) => amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺';

        let contentHTML = '';

        // --- 1. SAVINGS ANALYSIS ---
        if (type === 'savings') {
            // Calculate savings the SAME way as the widget does
            const now = new Date();
            const currentMonth = now.getMonth();
            const thisYear = now.getFullYear();

            // Get transactions from window or localStorage
            let transactions = window.transactions || [];
            if (transactions.length === 0) {
                try {
                    const stored = localStorage.getItem(`my_expenses_${thisYear}`);
                    if (stored) transactions = JSON.parse(stored);
                } catch (e) { console.error('Veri okuma hatası:', e); }
            }

            // Filter this month's transactions
            const monthTx = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === currentMonth && d.getFullYear() === thisYear;
            });

            let totalIncome = 0;
            let totalExpense = 0;
            let totalSavings = 0;

            monthTx.forEach(t => {
                const amount = parseFloat(t.amount) || 0;
                const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : (t.isSavings === true);

                if (t.type === 'income') {
                    totalIncome += amount;
                } else if (t.type === 'expense') {
                    if (isSavings) {
                        totalSavings += amount;
                    } else {
                        totalExpense += amount;
                    }
                }
            });

            // Calculate savings rate (same formula as widget)
            let savingsRate = 0;
            if (totalIncome > 0) {
                savingsRate = (totalSavings / totalIncome) * 100;
            }

            // Get total portfolio value (accumulated savings: dolar, euro, altın, etc.)
            let portfolioValue = 0;
            if (window.getUserTotalSavingsTL) {
                portfolioValue = window.getUserTotalSavingsTL();
            } else if (window.getIndexedSavingsValue && window.transactions) {
                portfolioValue = window.getIndexedSavingsValue(window.transactions, 0);
            }

            // Get user's target savings rate from localStorage (default 20%)
            const targetRate = parseInt(localStorage.getItem('fingenda_target_savings_rate') || '20');
            const isGood = savingsRate >= targetRate;
            const hasPortfolio = portfolioValue > 0;

            titleEl.textContent = "Tasarruf Analizi";
            subtitleEl.textContent = "Birikim performansın ve toplam varlığın";
            iconEl.textContent = "💰";

            contentHTML = `
                ${hasPortfolio ? `
                <div class="p-5 rounded-2xl bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 border border-indigo-100 dark:border-indigo-500/30 flex flex-col items-center text-center mb-3">
                    <p class="text-xs font-bold uppercase tracking-widest text-indigo-500 dark:text-indigo-400 mb-2">💎 TOPLAM BİRİKİMİN</p>
                    <div class="text-4xl font-black text-indigo-600 dark:text-indigo-400 mb-1">${formatMoney(portfolioValue)}</div>
                    <p class="text-xs font-medium text-indigo-700/70 dark:text-indigo-300/70">Dolar, Euro, Altın ve diğer varlıklar</p>
                </div>
                ` : ''}

                <div class="p-5 rounded-2xl ${isGood ? 'bg-emerald-50 dark:bg-emerald-900/20' : 'bg-orange-50 dark:bg-orange-900/20'} border ${isGood ? 'border-emerald-100 dark:border-emerald-500/30' : 'border-orange-100 dark:border-orange-500/30'} flex flex-col items-center text-center">
                    <p class="text-xs font-bold uppercase tracking-widest ${isGood ? 'text-emerald-500' : 'text-orange-500'} mb-2">BU AY TASARRUF ORANI</p>
                    <div class="text-5xl font-black ${isGood ? 'text-emerald-600 dark:text-emerald-400' : 'text-orange-600 dark:text-orange-400'} mb-2">%${Math.max(0, savingsRate).toFixed(1)}</div>
                    <p class="text-xs font-medium opacity-70 ${isGood ? 'text-emerald-800 dark:text-emerald-200' : 'text-orange-800 dark:text-orange-200'}">Hedeflenen oran: %${targetRate}</p>
                </div>

                <!-- Target Rate Slider -->
                <div class="p-4 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/10">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">🎯 Hedef Oran</span>
                        <span id="target-rate-display" class="text-sm font-black text-indigo-600 dark:text-indigo-400">%${targetRate}</span>
                    </div>
                    <input 
                        type="range" 
                        id="target-rate-slider" 
                        min="5" 
                        max="50" 
                        step="5" 
                        value="${targetRate}"
                        class="w-full h-2 rounded-full appearance-none cursor-pointer"
                        style="background: linear-gradient(to right, #6366f1, #8b5cf6);"
                        oninput="
                            const val = this.value;
                            document.getElementById('target-rate-display').textContent = '%' + val;
                            localStorage.setItem('fingenda_target_savings_rate', val);
                        "
                    >
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                        <span>%5</span>
                        <span>%20</span>
                        <span>%35</span>
                        <span>%50</span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div class="p-3 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">GELİR</p>
                        <p class="text-sm font-black text-gray-800 dark:text-white">${formatMoney(totalIncome)}</p>
                    </div>
                    <div class="p-3 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">GİDER</p>
                        <p class="text-sm font-black text-gray-800 dark:text-white">${formatMoney(totalExpense)}</p>
                    </div>
                    <div class="p-3 rounded-2xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-500/20">
                        <p class="text-[10px] text-emerald-500 font-bold uppercase mb-1">BU AY</p>
                        <p class="text-sm font-black text-emerald-600 dark:text-emerald-400">${formatMoney(totalSavings)}</p>
                    </div>
                </div>

                <div class="p-4 rounded-2xl bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-500/20">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">💡</span>
                        <div>
                            <p class="text-xs font-bold text-blue-600 dark:text-blue-400 mb-1">Fingo İpucu</p>
                            <p class="text-xs text-blue-800 dark:text-blue-200 leading-relaxed">
                                ${hasPortfolio && portfolioValue > 10000
                    ? `Toplam ${formatMoney(portfolioValue)} birikiminle sağlam bir temel oluşturmuşsun! ${savingsRate >= targetRate ? 'Bu oranı koruyarak servetini büyütmeye devam et.' : `Aylık tasarruf oranını %${targetRate}'ye çıkarmayı hedefle.`}`
                    : savingsRate >= targetRate
                        ? `Harika gidiyorsun! Gelirinin %${targetRate}'sinden fazlasını biriktiriyorsun. Bu disiplini koru.`
                        : savingsRate > 0
                            ? `Birikim yapıyorsun, iyi gidiyorsun! Hedefin %${targetRate} oranına ulaşmak olmalı.`
                            : "Bu ay henüz birikim yapmadın. 'Birikim' kategorisine gider ekleyerek tasarruf oranını takip et."}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 2. SPENDING ANALYSIS ---
        else if (type === 'spending') {
            const snap = window.getFinanceSnapshot ? window.getFinanceSnapshot('month') : { filtered: [] };
            // Calculate top categories manually
            const catTotals = {};
            snap.filtered.filter(t => t.type === 'expense' && !window.isSavingsTransaction(t)).forEach(t => {
                const cat = t.category || 'Diğer';
                catTotals[cat] = (catTotals[cat] || 0) + parseFloat(t.amount);
            });
            const sortedCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]).slice(0, 4);

            titleEl.textContent = "Harcama Analizi";
            subtitleEl.textContent = "Paran nereye gidiyor?";
            iconEl.textContent = "📊";

            let catsHTML = '';
            if (sortedCats.length > 0) {
                const maxVal = sortedCats[0][1];
                sortedCats.forEach(([cat, val]) => {
                    const percent = (val / maxVal) * 100;
                    catsHTML += `
                        <div class="mb-3">
                            <div class="flex justify-between text-xs font-bold mb-1">
                                <span class="text-gray-700 dark:text-gray-300">${cat}</span>
                                <span class="text-gray-900 dark:text-white">${formatMoney(val)}</span>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-white/10 rounded-full h-2 overflow-hidden">
                                <div class="bg-indigo-500 h-full rounded-full" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                });
            } else {
                catsHTML = '<p class="text-center text-gray-400 text-sm py-4">Henüz harcama verisi yok.</p>';
            }

            contentHTML = `
                <div class="p-4 rounded-2xl bg-white dark:bg-white/5 border border-gray-100 dark:border-white/10 shadow-sm">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">EN ÇOK HARCANANLAR</h4>
                    ${catsHTML}
                </div>
                
                <button onclick="window.closeInsightModal(); window.location.hash='#transactions'" class="w-full py-3 rounded-xl border border-gray-200 dark:border-white/10 text-xs font-bold text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                    Tüm İşlemleri Gör
                </button>
            `;
        }

        // --- 3. FORECAST ---
        else if (type === 'forecast') {
            const snap = window.getFinanceSnapshot ? window.getFinanceSnapshot('month') : { expense: 0, income: 0 };
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const daysPassed = Math.max(1, now.getDate());
            const daysRemaining = daysInMonth - daysPassed;

            const dailyAvg = snap.expense / daysPassed;
            const projectedExpense = snap.expense + (dailyAvg * daysRemaining);
            const projectedNet = snap.income - projectedExpense;

            titleEl.textContent = "Ay Sonu Tahmini";
            subtitleEl.textContent = "Mevcut hızla giderse...";
            iconEl.textContent = "🔮"; // Crystal ball

            contentHTML = `
                <div class="p-5 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-lg text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/10 mix-blend-overlay"></div>
                    <p class="relative text-xs font-bold uppercase tracking-widest opacity-80 mb-1">TAHMİNİ KALAN BAKİYE</p>
                    <h2 class="relative text-4xl font-black tracking-tight">${projectedNet.toLocaleString('tr-TR', { maximumFractionDigits: 0 })} ₺</h2>
                    <p class="relative text-[10px] font-medium mt-2 opacity-70">${daysRemaining} gün kaldı • Günde ort. ${dailyAvg.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}₺ harcıyorsun</p>
                </div>

                <div class="space-y-3 pt-2">
                    <div class="flex justify-between items-center p-3 rounded-xl bg-gray-50 dark:bg-white/5">
                        <span class="text-xs font-bold text-gray-500">Mevcut Gider</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white">${formatMoney(snap.expense)}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-xl bg-gray-50 dark:bg-white/5">
                        <span class="text-xs font-bold text-gray-500">Tahmini Ek Gider</span>
                        <span class="text-sm font-bold text-gray-400">+${formatMoney(dailyAvg * daysRemaining)}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-xl bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-500/20">
                        <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400">Tahmini Toplam</span>
                        <span class="text-sm font-black text-indigo-700 dark:text-indigo-300">${formatMoney(projectedExpense)}</span>
                    </div>
                </div>
            `;
        }

        // --- 4. GOALS ---
        else if (type === 'goal') {
            const currentYear = (typeof APP_YEAR !== 'undefined') ? APP_YEAR : new Date().getFullYear();
            const goals = JSON.parse(localStorage.getItem(`my_goals_${currentYear}`) || '[]');

            titleEl.textContent = "Hedef Kumbarası";
            subtitleEl.textContent = `${goals.length} aktif hedefin var`;
            iconEl.textContent = "🎯";

            let goalsHTML = '';
            if (goals.length > 0) {
                goals.sort((a, b) => (b.currentAmount / b.targetAmount) - (a.currentAmount / a.targetAmount)); // Sort by progress
                goals.forEach(g => {
                    const percent = Math.min(100, (g.currentAmount / g.targetAmount) * 100);
                    goalsHTML += `
                        <div class="p-4 rounded-2xl bg-white dark:bg-white/5 border border-gray-100 dark:border-white/10 shadow-[0_2px_10px_rgba(0,0,0,0.03)] dark:shadow-none">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="text-sm font-bold text-gray-800 dark:text-white capitalize">${g.title}</h4>
                                <span class="bg-gray-100 dark:bg-white/10 text-gray-600 dark:text-gray-300 text-[10px] font-bold px-2 py-0.5 rounded-md">%${percent.toFixed(0)}</span>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-white/10 rounded-full h-2 mb-2 overflow-hidden">
                                <div class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-full rounded-full" style="width: ${percent}%"></div>
                            </div>
                            <div class="flex justify-between text-[10px] font-mono text-gray-400">
                                <span>${formatMoney(g.currentAmount)}</span>
                                <span>${formatMoney(g.targetAmount)}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                goalsHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 dark:bg-white/5 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl grayscale opacity-50">🎯</div>
                        <p class="text-sm text-gray-500 font-medium">Henüz bir hedefin yok.</p>
                    </div>
                `;
            }

            contentHTML = `
                ${goalsHTML}
                <button onclick="window.closeInsightModal(); window.openModal('goals')" class="w-full mt-2 py-3 dashed-border rounded-xl text-xs font-bold text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors flex items-center justify-center gap-2">
                    <span>+</span> Yeni Hedef Ekle
                </button>
            `;
        }

        bodyEl.innerHTML = contentHTML;

        // Show modal
        modal.classList.remove('hidden');
        // Animate in
        setTimeout(() => {
            modal.querySelector('div').classList.remove('translate-y-full', 'scale-95', 'opacity-0');
        }, 10);
    };

    window.closeInsightModal = function () {
        const modal = document.getElementById('insight-detail-modal');
        if (!modal) return;

        // Animate out
        // modal.querySelector('div').classList.add('translate-y-full'); // optional fancy exit
        modal.classList.add('hidden');
    };

    // Fallback for openDetailedStats if not defined (covers spending/income clicks too)
    if (typeof window.openDetailedStats === 'undefined') {
        window.openDetailedStats = function (type) {
            if (type === 'income') { /* could add specific income modal logic here */ console.log('Income details clicked'); }
            else if (type === 'expense') window.handleInsightClick(1, 'spending');
        };
    }
    // ═══════════════════════════════════════════════════════════════
    // INSIGHT WIDGET CONTROLLER (BUGÜNÜN İÇGÖRÜSÜ)
    // ═══════════════════════════════════════════════════════════════
    window.updateInsightWidgets = function () {
        // console.log('[INSIGHT] Widget verileri güncelleniyor...');

        // 1. Veri Kaynağı (Transactions)
        const currentYear = new Date().getFullYear();
        let transactions = window.transactions || [];

        // Eğer window.transactions boşsa localStorage'dan dene
        if (transactions.length === 0) {
            try {
                const stored = localStorage.getItem(`fingo_transactions_${currentYear}`);
                if (stored) transactions = JSON.parse(stored);
            } catch (e) { console.error('Veri okuma hatası:', e); }
        }

        // Yardımcı: Format Money
        const formatMoney = (amount) => {
            return amount.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ₺';
        };

        // --- WIDGET 1: TASARRUF ORANI ---
        // Bu ay filtresi
        const now = new Date();
        const currentMonth = now.getMonth();
        const thisYear = now.getFullYear();

        const monthTx = transactions.filter(t => {
            const d = new Date(t.date);
            return d.getMonth() === currentMonth && d.getFullYear() === thisYear;
        });

        let totalIncome = 0;
        let totalExpense = 0;
        let totalSavings = 0;

        monthTx.forEach(t => {
            const amount = parseFloat(t.amount) || 0;
            const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : (t.isSavings === true);

            if (t.type === 'income') {
                totalIncome += amount;
            } else if (t.type === 'expense') {
                if (isSavings) {
                    totalSavings += amount;
                } else {
                    totalExpense += amount;
                }
            }
        });

        // Tasarruf Oranı Hesabı (Birikim / Gelir)
        let savingsRate = 0;
        if (totalIncome > 0) {
            savingsRate = (totalSavings / totalIncome) * 100;
        }

        // Get user's target savings rate from localStorage (default 20%)
        const targetRate = parseInt(localStorage.getItem('fingenda_target_savings_rate') || '20');

        const w1Value = document.getElementById('insight-value-0');
        const w1Desc = document.getElementById('insight-desc-0');

        if (w1Value && w1Desc) {
            if (monthTx.length === 0) {
                w1Value.textContent = "--";
                w1Desc.textContent = "Veri yok. İşlem ekleyerek analizi başlatın.";
            } else if (totalIncome === 0) {
                w1Value.textContent = "%0";
                w1Desc.textContent = "Bu ay gelir kaydı yok. Gelir ekleyerek tasarruf oranını takip et.";
            } else {
                w1Value.textContent = `%${Math.max(0, savingsRate).toFixed(0)}`;
                // Renk sınıflarını temizle ve yenisini ekle
                w1Value.className = 'insight-value';
                if (savingsRate >= targetRate) w1Value.classList.add('value-success');
                else if (savingsRate > 0) w1Value.classList.add('value-warning');
                else w1Value.classList.add('text-rose-500');

                if (savingsRate >= targetRate) w1Desc.textContent = `Mükemmel! Gelirinizin %${savingsRate.toFixed(0)}'ini biriktirdiniz. Böyle devam et!`;
                else if (savingsRate >= targetRate * 0.5) w1Desc.textContent = `İyi gidiyorsun! Gelirinin %${savingsRate.toFixed(0)}'ini biriktirdin.`;
                else if (savingsRate > 0) w1Desc.textContent = `Az da olsa birikim yapıyorsun. Hedefini %${targetRate}'ye çıkarmayı dene!`;
                else w1Desc.textContent = "Bu ay henüz birikim yapmadın. Küçük bir miktar bile fark yaratır!";
            }
        }

        // --- WIDGET 2: EN YÜKSEK HARCAMA ---
        const catTotals = {};
        transactions.filter(t => t.type === 'expense').forEach(t => {
            // Kategori ismini al (emoji varsa ayıkla)
            let cat = t.category || 'Diğer';
            catTotals[cat] = (catTotals[cat] || 0) + parseFloat(t.amount);
        });

        let topCat = 'Veri Yok';
        let topCatAmount = 0;

        Object.entries(catTotals).forEach(([cat, amount]) => {
            if (amount > topCatAmount) {
                topCatAmount = amount;
                topCat = cat;
            }
        });

        const w2Value = document.getElementById('insight-value-1');
        const w2Desc = document.getElementById('insight-desc-1');

        if (w2Value && w2Desc) {
            if (topCatAmount > 0) {
                w2Value.textContent = topCat;
                w2Desc.textContent = `Bu ay en çok ${topCat} için harcama yaptınız (${formatMoney(topCatAmount)}).`;
            } else {
                w2Value.textContent = "--";
                w2Desc.textContent = "Harcama verisi bulunamadı.";
            }
        }

        // --- WIDGET 3: AY SONU TAHMİNİ ---
        // MANTIK: Kullanıcı gelirini aylık olarak girer (maaş, kira geliri vb.)
        // Sadece harcamalar günlük ortalamaya göre tahmin edilir
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        const dayOfMonth = now.getDate();
        const daysRemaining = daysInMonth - dayOfMonth;

        const w3Value = document.getElementById('insight-value-2');
        const w3Desc = document.getElementById('insight-desc-2');

        if (w3Value && w3Desc) {
            // Gelir zaten aylık (maaş, kira vs.) - günlük tahmine çevirmeye gerek yok
            const monthlyIncome = totalIncome;

            // Harcamalar günlük ortalamaya göre tahmin edilir
            if (dayOfMonth > 0 && totalExpense > 0) {
                const dailyAvgExpense = totalExpense / dayOfMonth;
                const projectedRemainingExpense = dailyAvgExpense * daysRemaining;
                const projectedTotalExpense = totalExpense + projectedRemainingExpense;

                // Ay sonu bakiye: Aylık Gelir - Toplam Tahmini Harcama
                const estimatedMonthEndBalance = monthlyIncome - projectedTotalExpense;

                w3Value.textContent = formatMoney(estimatedMonthEndBalance);

                if (estimatedMonthEndBalance > 0) {
                    const savingsPercent = ((estimatedMonthEndBalance / monthlyIncome) * 100).toFixed(0);
                    w3Desc.textContent = `Bu hızla devam edersen ay sonunda gelirinin %${savingsPercent}'i artıda kalabilir.`;
                } else {
                    w3Desc.textContent = `Dikkat! Harcama hızını kontrol etmelisin. Ay sonunda eksiye düşebilirsin.`;
                }
            } else if (monthlyIncome > 0 && totalExpense === 0) {
                // Henüz harcama yok ama gelir var
                w3Value.textContent = formatMoney(monthlyIncome);
                w3Desc.textContent = "Henüz harcama kaydı yok. Tüm gelirin artıda görünüyor.";
            } else {
                w3Value.textContent = "--";
                w3Desc.textContent = "Tahmin için gelir ve harcama verisi gerekli.";
            }
        }

        // --- WIDGET 4: BİRİKİM HEDEFİ ---
        // Widget 4 is handled by updateInsightCards to avoid duplicate/conflicting updates
        // Just trigger the main insight cards update to handle this widget
        if (typeof window.updateInsightCards === 'function') {
            // Don't call directly to avoid infinite loop - let it handle via its own timing
            // The updateInsightCards function has the correct goal calculation logic
        }
        // Note: updateInsightCards handles insight-value-3 with proper goal data from Hedef Kumbarası
    };

    // Insight Widget'larını Başlat
    document.addEventListener('DOMContentLoaded', () => {
        // Biraz gecikmeli başlat ki veriler yüklensin
        setTimeout(window.updateInsightWidgets, 1000);
        // updateInsightCards handles Widget 4 (savings goal) correctly
        setTimeout(() => {
            if (typeof window.updateInsightCards === 'function') {
                window.updateInsightCards();
            }
        }, 1500);

        // Ayrıca her 5 saniyede bir güncelle (basit reaktivite için)
        setInterval(() => {
            window.updateInsightWidgets();
            // Also call updateInsightCards to keep Widget 4 in sync
            if (typeof window.updateInsightCards === 'function') {
                window.updateInsightCards();
            }
        }, 5000);
    });
</script>

<!-- DNA DETAIL MODAL -->
<div id="dna-detail-modal"
    class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity"
        onclick="document.getElementById('dna-detail-modal').classList.add('hidden'); document.getElementById('dna-detail-modal').classList.add('pointer-events-none');">
    </div>

    <!-- Content -->
    <div
        class="pointer-events-auto bg-white dark:bg-[#1c1c1e] w-full sm:w-[400px] h-[85vh] sm:h-auto sm:max-h-[80vh] rounded-t-[32px] sm:rounded-[32px] flex flex-col shadow-2xl overflow-hidden transform transition-transform duration-300">
        <!-- Header -->
        <div class="relative p-6 pt-8 pb-4 shrink-0 z-10 bg-white dark:bg-[#1c1c1e]">
            <div
                class="absolute top-0 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-gray-300 dark:bg-white/20 rounded-full mt-3">
            </div>
            <div class="flex items-center gap-4">
                <div id="dna-detail-icon"
                    class="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl shadow-lg transition-colors">
                </div>
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Kategori Detayı</p>
                    <h2 id="dna-detail-title" class="text-2xl font-black text-gray-900 dark:text-white"></h2>
                </div>
            </div>
            <button
                onclick="document.getElementById('dna-detail-modal').classList.add('hidden'); document.getElementById('dna-detail-modal').classList.add('pointer-events-none');"
                class="absolute top-6 right-6 w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:bg-gray-200 dark:hover:bg-white/20 transition-colors">✕</button>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 pt-0 space-y-6">
            <!-- Stats -->
            <div class="flex gap-4">
                <div
                    class="flex-1 p-4 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Toplam</p>
                    <p id="dna-detail-total" class="text-xl font-black text-gray-900 dark:text-white mt-1">--</p>
                </div>
                <div
                    class="flex-1 p-4 rounded-2xl bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-white/5">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Pay</p>
                    <p id="dna-detail-pct" class="text-xl font-black text-gray-900 dark:text-white mt-1">--</p>
                </div>
            </div>

            <!-- Transactions List -->
            <div>
                <h3 class="text-sm font-bold text-gray-900 dark:text-white mb-3">Son İşlemler</h3>
                <div id="dna-detail-list" class="space-y-3 pb-6">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    window.openCategoryDetailModal = function (catName) {
        const modal = document.getElementById('dna-detail-modal');
        if (!modal) return;

        const categoryConfig = {
            'Market': { emoji: '🛒', color: '#10b981' },
            'Fatura': { emoji: '🧾', color: '#f59e0b' },
            'Ulaşım': { emoji: '🚌', color: '#3b82f6' },
            'Eğlence': { emoji: '🎬', color: '#ec4899' },
            'Giyim': { emoji: '👕', color: '#8b5cf6' },
            'Sağlık': { emoji: '💊', color: '#ef4444' },
            'Eğitim': { emoji: '🎓', color: '#06b6d4' },
            'Diğer': { emoji: '📦', color: '#6b7280' }
        };

        // Config
        const config = categoryConfig[catName] || { emoji: '📦', color: '#6b7280' };
        const txns = window.transactions || [];

        // Filter
        const catTxns = txns.filter(t => t.type === 'expense' && (t.category || '').includes(catName));
        const total = catTxns.reduce((a, b) => a + parseFloat(b.amount), 0);
        const allTotal = txns.filter(t => t.type === 'expense').reduce((a, b) => a + parseFloat(b.amount), 0);
        const pct = allTotal > 0 ? Math.round((total / allTotal) * 100) : 0;

        // UI Updates
        const iconEl = document.getElementById('dna-detail-icon');
        iconEl.innerText = config.emoji;
        iconEl.style.backgroundColor = config.color + '20';
        iconEl.style.color = config.color;

        document.getElementById('dna-detail-title').innerText = catName;
        document.getElementById('dna-detail-total').innerText = window.formatTRY ? window.formatTRY(total) : total.toLocaleString('tr-TR') + ' ₺';
        document.getElementById('dna-detail-pct').innerText = '%' + pct;

        // List
        const listEl = document.getElementById('dna-detail-list');
        let html = '';
        catTxns.sort((a, b) => {
            const dA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.date);
            const dB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.date);
            return dB - dA;
        }).slice(0, 50).forEach(t => { // Last 50 items
            const dateRaw = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
            const dateStr = dateRaw ? dateRaw.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' }) : '';
            html += `
            <div class="flex items-center justify-between p-3 rounded-xl bg-gray-50/50 dark:bg-white/[0.02] border border-gray-100 dark:border-white/5">
                <div>
                    <p class="text-xs font-bold text-gray-900 dark:text-white truncate max-w-[150px]">${t.description || 'İşlem'}</p>
                    <p class="text-[10px] text-gray-400">${dateStr}</p>
                </div>
                <p class="text-sm font-bold text-gray-900 dark:text-white">${window.formatTRY ? window.formatTRY(t.amount) : parseFloat(t.amount).toLocaleString('tr-TR') + ' ₺'}</p>
            </div>`;
        });
        listEl.innerHTML = html || '<div class="text-center text-xs text-gray-400 py-4">Bu kategoride işlem bulunamadı.</div>';

        // Show
        modal.classList.remove('hidden');
        modal.classList.remove('pointer-events-none');
    }
</script>
<script>
    // ═══════════════════════════════════════════════════════════════════════
    // GLOBAL APP LIFECYCLE LISTENERS
    // ═══════════════════════════════════════════════════════════════════════
    if (window.AppLifecycle) {
        window.AppLifecycle.onForeground(() => {
            console.log('[App] Resumed from background. Refreshing data...');
            if (window.refreshDashboard) window.refreshDashboard();
        });
    }
</script>
<style>
    /* ═══════════════════════════════════════════════════════════════════════════════ */
    /* GHOST LAYER ELIMINATION FIX - COMPREHENSIVE FLOATING NAV SOLUTION              */
    /* Fixes: stacking context, min-height conflicts, scroll behavior, iOS Safari     */
    /* ═══════════════════════════════════════════════════════════════════════════════ */

    /* ─────────────────────────────────────────────────────────────────────────────── */
    /* 1. NAV WRAPPER - Complete transparency, removed from document flow              */
    /* ─────────────────────────────────────────────────────────────────────────────── */
    #nav-wrapper {
        /* Position - Fixed, removed from document flow */
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        height: auto !important;

        /* Completely transparent - NO background at all */
        background: none !important;
        background-color: transparent !important;
        background-image: none !important;

        /* No visual artifacts */
        box-shadow: none !important;
        border: none !important;
        outline: none !important;

        /* Click-through on empty areas */
        pointer-events: none !important;

        /* NO stacking context creation - avoid transform/filter */
        transform: none !important;
        filter: none !important;

        /* Safe area padding on wrapper */
        padding-bottom: env(safe-area-inset-bottom, 0px) !important;
        padding-left: env(safe-area-inset-left, 0px) !important;
        padding-right: env(safe-area-inset-right, 0px) !important;

        /* High z-index but not crazy */
        z-index: 9000 !important;

        /* Flex container to center the nav pill */
        display: flex !important;
        justify-content: center !important;
        align-items: flex-end !important;
    }

    /* Remove ALL pseudo-elements from wrapper */
    #nav-wrapper::before,
    #nav-wrapper::after {
        display: none !important;
        content: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        width: 0 !important;
        height: 0 !important;
        background: transparent !important;
    }

    /* ─────────────────────────────────────────────────────────────────────────────── */
    /* 2. MAIN NAV PILL - Floating glass element with proper glassmorphism            */
    /* ─────────────────────────────────────────────────────────────────────────────── */
    #main-nav {
        /* Enable pointer events on the actual nav */
        pointer-events: auto !important;

        /* Sizing */
        width: calc(100% - 32px) !important;
        max-width: 420px !important;
        margin-bottom: 20px !important;

        /* Glassmorphism */
        background: rgba(255, 255, 255, 0.72) !important;
        backdrop-filter: blur(24px) saturate(180%) !important;
        -webkit-backdrop-filter: blur(24px) saturate(180%) !important;

        /* Border & Shadow */
        border: 1px solid rgba(255, 255, 255, 0.5) !important;
        border-radius: 28px !important;
        box-shadow:
            0 8px 32px -4px rgba(0, 0, 0, 0.08),
            0 4px 16px -2px rgba(0, 0, 0, 0.04),
            inset 0 1px 0 rgba(255, 255, 255, 0.6) !important;

        /* Layout */
        display: flex !important;
        justify-content: space-around !important;
        align-items: center !important;
        padding: 8px 12px !important;
        min-height: 70px !important;

        /* Ensure no clip issues */
        overflow: visible !important;
        clip-path: none !important;
        -webkit-clip-path: none !important;

        /* No stacking context issues */
        isolation: auto !important;
    }

    /* Dark mode nav pill */
    html.dark #main-nav {
        background: rgba(30, 30, 40, 0.72) !important;
        border: 1px solid rgba(255, 255, 255, 0.12) !important;
        box-shadow:
            0 8px 32px -4px rgba(0, 0, 0, 0.3),
            0 4px 16px -2px rgba(0, 0, 0, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
    }

    /* Remove glass-card-strong overrides for nav */
    #main-nav.glass-card-strong {
        background-color: unset !important;
        background-image: unset !important;
    }

    /* Remove nav pseudo-elements */
    #main-nav::before,
    #main-nav::after {
        display: none !important;
        content: none !important;
    }

    /* ─────────────────────────────────────────────────────────────────────────────── */
    /* 3. SCROLL CONTAINER - Proper padding, no reserved nav height                    */
    /* ─────────────────────────────────────────────────────────────────────────────── */

    /* Body does NOT need min-height: 100vh when position: fixed */
    /* This was causing the ghost layer conflict */
    body {
        /* Already has position: fixed from earlier styles */
        min-height: unset !important;
        height: 100% !important;
        background: var(--bg-primary, #f5f5f7) !important;
    }

    html.dark body {
        background: #0a0a0f !important;
    }

    /* App container should fill body and allow scroll */
    #app-container {
        height: 100% !important;
        min-height: unset !important;
        display: flex !important;
        flex-direction: column !important;
        background: inherit !important;
    }

    /* Main content area - single padding-bottom for nav clearance */
    #app-container>main {
        flex: 1 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;

        /* Single padding-bottom: nav height (~90px) + safe area */
        padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px)) !important;
    }

    /* ─────────────────────────────────────────────────────────────────────────────── */
    /* 4. HIDE ROGUE ELEMENTS                                                          */
    /* ─────────────────────────────────────────────────────────────────────────────── */
    #app-nav,
    .bottom-nav,
    #bottom-bar,
    .tab-bar-bg,
    footer:not(#mail-footer),
    .footer,
    .safe-area-spacer,
    #safe-area-bottom,
    .navigation-background,
    .safe-area-bg {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        height: 0 !important;
        width: 0 !important;
        background: transparent !important;
    }

    /* ─────────────────────────────────────────────────────────────────────────────── */
    /* 5. iOS SAFARI SPECIFIC FIXES                                                    */
    /* ─────────────────────────────────────────────────────────────────────────────── */
    @supports (-webkit-touch-callout: none) {

        /* iOS Safari detection */
        #nav-wrapper {
            /* Use padding instead of bottom for iOS */
            bottom: 0 !important;
            padding-bottom: max(20px, env(safe-area-inset-bottom)) !important;
        }

        #main-nav {
            margin-bottom: 0 !important;
        }
    }

    /* ─────────────────────────────────────────────────────────────────────────────── */
    /* 6. ENSURE CONTENT SCROLLS BEHIND NAV (Z-INDEX HIERARCHY)                        */
    /* ─────────────────────────────────────────────────────────────────────────────── */
    #app-container>main {
        z-index: 1 !important;
        position: relative !important;
    }

    /* ─────────────────────────────────────────────────────────────────────────────── */
    /* 7. HEADER - Fixed floating glass (NO background layer behind)                   */
    /* ─────────────────────────────────────────────────────────────────────────────── */
    #main-header {
        /* Fixed position */
        position: fixed !important;
        z-index: 8000 !important;

        /* Glassmorphism - True transparent, NO solid background */
        background: rgba(255, 255, 255, 0.72) !important;
        background-color: transparent !important;
        backdrop-filter: blur(24px) saturate(180%) !important;
        -webkit-backdrop-filter: blur(24px) saturate(180%) !important;

        /* Clean styling */
        border: 1px solid rgba(255, 255, 255, 0.5) !important;
        box-shadow:
            0 4px 24px -4px rgba(0, 0, 0, 0.06),
            0 2px 12px -2px rgba(0, 0, 0, 0.04),
            inset 0 1px 0 rgba(255, 255, 255, 0.6) !important;

        /* NO stacking context creation */
        transform: none !important;
        filter: none !important;
        isolation: auto !important;
    }

    /* Dark mode header */
    html.dark #main-header {
        background: rgba(30, 30, 40, 0.72) !important;
        border: 1px solid rgba(255, 255, 255, 0.12) !important;
        box-shadow:
            0 4px 24px -4px rgba(0, 0, 0, 0.25),
            0 2px 12px -2px rgba(0, 0, 0, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
    }

    /* Remove header pseudo-elements */
    #main-header::before,
    #main-header::after {
        display: none !important;
        content: none !important;
        background: transparent !important;
    }

    #nav-wrapper {
        z-index: 9000 !important;
    }

    /* Modals should be above nav */
    [id*="modal"] {
        z-index: 10000 !important;
    }

    /* ─────────────────────────────────────────────────────────────────────────────── */
    /* 8. MOBILE LAYOUT FIXES - Content spacing and nav position                       */
    /* ─────────────────────────────────────────────────────────────────────────────── */

    /* Main content needs enough padding-top for fixed header */
    #app-container>main {
        padding-top: calc(150px + env(safe-area-inset-top, 0px)) !important;
    }

    /* Nav bar sits properly at bottom */
    #main-nav {
        margin-bottom: 12px !important;
    }

    /* iOS devices with home indicator */
    @supports (-webkit-touch-callout: none) {
        #app-container>main {
            padding-top: calc(160px + env(safe-area-inset-top, 0px)) !important;
        }

        #main-nav {
            margin-bottom: 8px !important;
        }

        #nav-wrapper {
            padding-bottom: max(16px, env(safe-area-inset-bottom)) !important;
        }
    }

    /* Small screen height */
    @media (max-height: 700px) {
        #app-container>main {
            padding-top: calc(120px + env(safe-area-inset-top, 0px)) !important;
        }
    }
</style>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- DYNAMIC ISLAND TOAST NOTIFICATION SYSTEM                                    -->
<!-- Toast görünürken header gizlenir, toast kapanınca header geri gelir          -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<style>
    /* === DYNAMIC ISLAND TOAST CONTAINER === */
    #dynamic-island-toast-container {
        position: fixed;
        top: calc(16px + env(safe-area-inset-top, 0px));
        left: 50%;
        transform: translateX(-50%);
        z-index: 10100;
        pointer-events: none;
        display: flex;
        justify-content: center;
        width: auto;
        max-width: calc(100% - 32px);
    }

    /* === DYNAMIC ISLAND TOAST === */
    .dynamic-island-toast {
        pointer-events: auto;
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 20px 14px 16px;
        min-width: 280px;
        max-width: 380px;
        background: #1c1c1e !important;
        border-radius: 50px !important;
        box-shadow:
            0 10px 40px rgba(0, 0, 0, 0.5),
            0 4px 12px rgba(0, 0, 0, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.08) !important;
        color: white !important;
        transform: translateY(-120%) scale(0.8);
        opacity: 0;
        transition:
            transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
            opacity 0.3s ease;
        will-change: transform, opacity;
    }

    /* Light mode - still dark like Dynamic Island */
    html:not(.dark) .dynamic-island-toast {
        background: #1c1c1e !important;
        color: white !important;
    }

    /* Dark mode */
    html.dark .dynamic-island-toast {
        background: #1c1c1e !important;
        box-shadow:
            0 10px 50px rgba(0, 0, 0, 0.7),
            0 4px 16px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
    }

    /* Toast visible state */
    .dynamic-island-toast.show {
        transform: translateY(0) scale(1);
        opacity: 1;
    }

    /* Toast exit animation */
    .dynamic-island-toast.hide {
        transform: translateY(-80%) scale(0.9);
        opacity: 0;
        transition:
            transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.25s ease;
    }

    /* === TOAST ICON === */
    .dynamic-island-toast-icon {
        width: 36px;
        height: 36px;
        border-radius: 50% !important;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 18px;
        font-weight: bold;
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
    }

    /* Success Icon - Green Badge */
    .dynamic-island-toast-success .dynamic-island-toast-icon {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4) !important;
    }

    /* Error Icon - Red Badge */
    .dynamic-island-toast-error .dynamic-island-toast-icon {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4) !important;
    }

    /* Info Icon - Blue Badge */
    .dynamic-island-toast-info .dynamic-island-toast-icon {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
    }

    /* Warning Icon - Amber Badge */
    .dynamic-island-toast-warning .dynamic-island-toast-icon {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4) !important;
    }

    /* === TOAST CONTENT === */
    .dynamic-island-toast-content {
        flex: 1;
        min-width: 0;
        overflow: hidden;
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
    }

    .dynamic-island-toast-title {
        font-weight: 700;
        font-size: 15px;
        line-height: 1.3;
        color: #ffffff !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        margin-bottom: 2px;
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
    }

    .dynamic-island-toast-message {
        font-size: 13px;
        font-weight: 500;
        line-height: 1.35;
        color: rgba(255, 255, 255, 0.65) !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
    }

    /* === HEADER HIDE/SHOW ANIMATION === */
    #main-header {
        transition:
            transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.3s ease !important;
    }

    #main-header.header-hidden {
        transform: translateY(-100%) scale(0.95) !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    /* === RESPONSIVE === */
    @media (max-width: 420px) {
        .dynamic-island-toast {
            min-width: 260px;
            max-width: calc(100vw - 40px);
            padding: 12px 16px 12px 14px;
            gap: 12px;
        }

        .dynamic-island-toast-icon {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }

        .dynamic-island-toast-title {
            font-size: 14px;
        }

        .dynamic-island-toast-message {
            font-size: 12px;
        }
    }

    /* === REDUCED MOTION === */
    @media (prefers-reduced-motion: reduce) {

        .dynamic-island-toast,
        #main-header {
            transition: opacity 0.2s ease !important;
        }

        .dynamic-island-toast.show {
            transform: translateY(0) scale(1);
        }
    }
</style>

<!-- Dynamic Island Toast Container -->
<div id="dynamic-island-toast-container"></div>

<script>
    (function () {
        'use strict';

        // Store reference to header
        const header = document.getElementById('main-header');
        let activeToastCount = 0;
        let toastHideTimeout = null;

        // === SHOW HEADER ===
        function showHeader() {
            if (header && activeToastCount === 0) {
                header.classList.remove('header-hidden');
            }
        }

        // === HIDE HEADER ===
        function hideHeader() {
            if (header) {
                header.classList.add('header-hidden');
            }
        }

        // === DYNAMIC ISLAND TOAST ===
        window.showDynamicIslandToast = function (title, message, type = 'success', duration = 3500) {
            const container = document.getElementById('dynamic-island-toast-container');
            if (!container) {
                console.warn('[DynamicIslandToast] Container not found');
                return;
            }

            // Hide header when toast appears
            activeToastCount++;
            hideHeader();

            // Determine icon based on type
            let icon = '✓';
            let typeClass = 'dynamic-island-toast-success';

            switch (type) {
                case 'error':
                    icon = '✕';
                    typeClass = 'dynamic-island-toast-error';
                    break;
                case 'info':
                    icon = 'ℹ';
                    typeClass = 'dynamic-island-toast-info';
                    break;
                case 'warning':
                    icon = '!';
                    typeClass = 'dynamic-island-toast-warning';
                    break;
                default:
                    icon = '✓';
                    typeClass = 'dynamic-island-toast-success';
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `dynamic-island-toast ${typeClass}`;
            toast.innerHTML = `
                <div class="dynamic-island-toast-icon">${icon}</div>
                <div class="dynamic-island-toast-content">
                    <span class="dynamic-island-toast-title">${title}</span>
                    <div class="dynamic-island-toast-message">${message}</div>
                </div>
            `;

            // Clear existing toasts
            container.innerHTML = '';
            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });
            });

            // Setup auto-hide
            if (toastHideTimeout) {
                clearTimeout(toastHideTimeout);
            }

            toastHideTimeout = setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');

                // After animation, remove and show header
                setTimeout(() => {
                    toast.remove();
                    activeToastCount = Math.max(0, activeToastCount - 1);
                    showHeader();
                }, 400);
            }, duration);

            // Allow click to dismiss
            toast.addEventListener('click', () => {
                if (toastHideTimeout) {
                    clearTimeout(toastHideTimeout);
                }
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => {
                    toast.remove();
                    activeToastCount = Math.max(0, activeToastCount - 1);
                    showHeader();
                }, 300);
            });
        };

        // === OVERRIDE GLOBAL showToast ===
        // Store original if exists
        window._originalShowToast = window.showToast;

        window.showToast = function (messageOrType, typeOrUndefined) {
            // Handle both calling conventions:
            // showToast(message, type) - old style
            // showToast(type, message) - some places use this

            let message, type;

            if (typeof typeOrUndefined === 'undefined') {
                // Single argument - treat as message with info type
                message = messageOrType;
                type = 'info';
            } else if (['success', 'error', 'info', 'warning'].includes(messageOrType)) {
                // First arg is type
                type = messageOrType;
                message = typeOrUndefined;
            } else {
                // First arg is message
                message = messageOrType;
                type = typeOrUndefined || 'info';
            }

            // Handle object messages - extract useful string
            if (message && typeof message === 'object') {
                // Try common message property names
                if (message.message && typeof message.message === 'string') {
                    message = message.message;
                } else if (message.text && typeof message.text === 'string') {
                    message = message.text;
                } else if (message.msg && typeof message.msg === 'string') {
                    message = message.msg;
                } else if (message.error && typeof message.error === 'string') {
                    message = message.error;
                } else if (message.description && typeof message.description === 'string') {
                    message = message.description;
                } else {
                    // Fallback - try to get a meaningful string
                    try {
                        const stringified = JSON.stringify(message);
                        // If it's a simple object, use the JSON
                        if (stringified.length < 100) {
                            message = stringified;
                        } else {
                            message = 'İşlem tamamlandı';
                        }
                    } catch (e) {
                        message = 'İşlem tamamlandı';
                    }
                }
            }

            // Ensure message is a string
            if (typeof message !== 'string') {
                message = String(message);
            }

            // If message is empty, provide default based on type
            if (!message || message === 'undefined' || message === 'null') {
                switch (type) {
                    case 'success':
                        message = 'İşlem başarıyla tamamlandı';
                        break;
                    case 'error':
                        message = 'Bir hata oluştu';
                        break;
                    case 'warning':
                        message = 'Dikkat edilmesi gereken bir durum var';
                        break;
                    default:
                        message = 'Bilgilendirme';
                }
            }

            // Determine title based on type
            let title;
            switch (type) {
                case 'success':
                    title = 'Başarılı!';
                    break;
                case 'error':
                    title = 'Hata';
                    break;
                case 'warning':
                    title = 'Uyarı';
                    break;
                default:
                    title = 'Bilgi';
            }

            window.showDynamicIslandToast(title, message, type);
        };

        // === OVERRIDE showMicroFeedback ===
        window.showMicroFeedback = function (input) {
            // Handle object input: { message: '...', type: '...' }
            let msg, type = 'success';
            if (input && typeof input === 'object') {
                msg = input.message || input.text || input.msg || input.title || '';
                type = input.type || 'success';
            } else {
                msg = String(input || 'İşlem tamamlandı');
            }

            // Determine title based on type
            const titles = {
                success: 'Başarılı!',
                error: 'Hata',
                warning: 'Uyarı',
                info: 'Bilgi'
            };
            const title = titles[type] || 'Başarılı!';

            window.showDynamicIslandToast(title, msg, type, 2500);
        };

        // === OVERRIDE showNeumorphicToast for backwards compatibility ===
        window.showNeumorphicToast = function (message, type = 'success', title = null) {
            const defaultTitles = {
                success: 'Başarılı!',
                error: 'Hata',
                info: 'Bilgi',
                warning: 'Uyarı'
            };
            const finalTitle = title || defaultTitles[type] || 'Bilgi';
            window.showDynamicIslandToast(finalTitle, message, type);
        };

        console.log('[DynamicIslandToast] ✅ Toast system initialized with header coordination');
    })();
</script>
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- AMBIENT LIGHTING FOR TRANSACTION BUTTONS                                     -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<style>
    .ambient-glow-red {
        box-shadow: 0 0 25px rgba(239, 68, 68, 0.45) !important;
        border-color: rgba(239, 68, 68, 0.5) !important;
        z-index: 50 !important;
    }

    html.dark .ambient-glow-red {
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.35) !important;
        border-color: rgba(239, 68, 68, 0.4) !important;
    }

    .ambient-glow-green {
        box-shadow: 0 0 25px rgba(16, 185, 129, 0.45) !important;
        border-color: rgba(16, 185, 129, 0.5) !important;
        z-index: 50 !important;
    }

    html.dark .ambient-glow-green {
        box-shadow: 0 0 30px rgba(16, 185, 129, 0.35) !important;
        border-color: rgba(16, 185, 129, 0.4) !important;
    }
</style>

<script>
    (function () {
        'use strict';

        // Wait for main scripts to load
        setTimeout(() => {
            if (window.setTransactionType) {
                const originalSetType = window.setTransactionType;

                window.setTransactionType = function (type) {
                    // Call original logic
                    originalSetType(type);

                    // Apply Ambient Glow
                    const btnExpense = document.getElementById('btn-type-expense');
                    const btnIncome = document.getElementById('btn-type-income');

                    if (type === 'expense') {
                        if (btnExpense) {
                            btnExpense.classList.add('ambient-glow-red');
                            btnExpense.classList.remove('ambient-glow-green');
                        }
                        if (btnIncome) {
                            btnIncome.classList.remove('ambient-glow-green', 'ambient-glow-red');
                        }
                    } else if (type === 'income') {
                        if (btnIncome) {
                            btnIncome.classList.add('ambient-glow-green');
                            btnIncome.classList.remove('ambient-glow-red');
                        }
                        if (btnExpense) {
                            btnExpense.classList.remove('ambient-glow-red', 'ambient-glow-green');
                        }
                    }
                };

                console.log('[AmbientLighting] ✅ Transaction buttons enhanced with ambient glow');

                const btnExpense = document.getElementById('btn-type-expense');
                if (btnExpense && !btnExpense.classList.contains('ambient-glow-red')) {
                    // NO-OP: Don't force click, just let it be. 
                }

            } else {
                console.warn('[AmbientLighting] ⚠️ setTransactionType not found');
            }
        }, 1500); // Wait enough time for app to boot
    })();
    /* ═══════════════════════════════════════════════════════════════════════════
       SWIPE-TO-ACTION GESTURE HANDLER - Premium Mobile Experience
       ═══════════════════════════════════════════════════════════════════════════ */
    (function () {
        'use strict';

        // Configuration
        const SWIPE_THRESHOLD = 50;      // Minimum swipe distance to trigger action reveal
        const MAX_SWIPE = 80;            // Maximum swipe distance (width of action button)
        const VELOCITY_THRESHOLD = 0.3;  // Velocity threshold for quick swipes

        // State tracking
        let activeSwipeContainer = null;
        let startX = 0;
        let startY = 0;
        let currentX = 0;
        let startTime = 0;
        let isSwiping = false;
        let isScrolling = false;

        // Initialize swipe handlers
        function initSwipeHandlers() {
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });

            // Close swipe actions when clicking outside
            document.addEventListener('click', handleDocumentClick, true);

            console.log('[SwipeActions] ✅ Gesture handlers initialized');
        }

        function handleTouchStart(e) {
            const container = e.target.closest('.swipe-container');

            // If there's an open container and we're touching elsewhere, close it
            if (activeSwipeContainer && activeSwipeContainer !== container) {
                resetSwipeContainer(activeSwipeContainer);
            }

            if (!container) return;

            // Only enable on mobile
            if (window.innerWidth > 768) return;

            const content = container.querySelector('.swipe-content');
            if (!content) return;

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            startTime = Date.now();
            currentX = 0;
            isSwiping = false;
            isScrolling = false;

            // Check if content is already swiped
            const currentTransform = getComputedStyle(content).transform;
            if (currentTransform !== 'none') {
                const matrix = new DOMMatrix(currentTransform);
                currentX = matrix.m41; // Current translateX value
            }

            activeSwipeContainer = container;
            content.classList.add('swiping');
        }

        function handleTouchMove(e) {
            if (!activeSwipeContainer) return;

            const content = activeSwipeContainer.querySelector('.swipe-content');
            if (!content) return;

            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - startX;
            const deltaY = touchY - startY;

            // Determine if this is a horizontal swipe or vertical scroll
            if (!isSwiping && !isScrolling) {
                if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 10) {
                    // Vertical scroll - let it happen
                    isScrolling = true;
                    content.classList.remove('swiping');
                    return;
                } else if (Math.abs(deltaX) > 10) {
                    isSwiping = true;
                }
            }

            if (isScrolling) return;
            if (!isSwiping) return;

            e.preventDefault();

            let newX = currentX + deltaX;

            // Apply resistance at boundaries
            if (newX > MAX_SWIPE) {
                newX = MAX_SWIPE + (newX - MAX_SWIPE) * 0.2;
            } else if (newX < -MAX_SWIPE) {
                newX = -MAX_SWIPE + (newX + MAX_SWIPE) * 0.2;
            }

            content.style.transform = `translateX(${newX}px)`;

            // Show/hide action buttons based on swipe direction
            const editAction = activeSwipeContainer.querySelector('.swipe-action-edit');
            const deleteAction = activeSwipeContainer.querySelector('.swipe-action-delete');

            if (newX > SWIPE_THRESHOLD * 0.5) {
                // Swiping right - show edit
                editAction?.classList.add('visible');
                deleteAction?.classList.remove('visible', 'threshold-reached');

                if (newX >= SWIPE_THRESHOLD) {
                    editAction?.classList.add('threshold-reached');
                } else {
                    editAction?.classList.remove('threshold-reached');
                }
            } else if (newX < -SWIPE_THRESHOLD * 0.5) {
                // Swiping left - show delete
                deleteAction?.classList.add('visible');
                editAction?.classList.remove('visible', 'threshold-reached');

                if (newX <= -SWIPE_THRESHOLD) {
                    deleteAction?.classList.add('threshold-reached');
                } else {
                    deleteAction?.classList.remove('threshold-reached');
                }
            } else {
                // Near center - hide both
                editAction?.classList.remove('visible', 'threshold-reached');
                deleteAction?.classList.remove('visible', 'threshold-reached');
            }
        }

        function handleTouchEnd(e) {
            if (!activeSwipeContainer || isScrolling) {
                isScrolling = false;
                return;
            }

            const content = activeSwipeContainer.querySelector('.swipe-content');
            if (!content) return;

            content.classList.remove('swiping');

            const currentTransform = getComputedStyle(content).transform;
            let finalX = 0;
            if (currentTransform !== 'none') {
                const matrix = new DOMMatrix(currentTransform);
                finalX = matrix.m41;
            }

            const deltaTime = Date.now() - startTime;
            const velocity = Math.abs(finalX - currentX) / deltaTime;

            const editAction = activeSwipeContainer.querySelector('.swipe-action-edit');
            const deleteAction = activeSwipeContainer.querySelector('.swipe-action-delete');

            // Determine final position
            let targetX = 0;

            if (velocity > VELOCITY_THRESHOLD) {
                // Fast swipe - commit to action
                if (finalX > SWIPE_THRESHOLD * 0.3) {
                    targetX = MAX_SWIPE;
                } else if (finalX < -SWIPE_THRESHOLD * 0.3) {
                    targetX = -MAX_SWIPE;
                }
            } else {
                // Slow swipe - check threshold
                if (finalX >= SWIPE_THRESHOLD) {
                    targetX = MAX_SWIPE;
                } else if (finalX <= -SWIPE_THRESHOLD) {
                    targetX = -MAX_SWIPE;
                }
            }

            // Animate to target position
            content.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            content.style.transform = `translateX(${targetX}px)`;

            // Update action button visibility
            if (targetX > 0) {
                content.classList.add('swiped-right');
                content.classList.remove('swiped-left');
                editAction?.classList.add('visible');
                deleteAction?.classList.remove('visible');
            } else if (targetX < 0) {
                content.classList.add('swiped-left');
                content.classList.remove('swiped-right');
                deleteAction?.classList.add('visible');
                editAction?.classList.remove('visible');
            } else {
                content.classList.remove('swiped-left', 'swiped-right');
                editAction?.classList.remove('visible', 'threshold-reached');
                deleteAction?.classList.remove('visible', 'threshold-reached');
                activeSwipeContainer = null;
            }

            // Remove threshold indicator
            editAction?.classList.remove('threshold-reached');
            deleteAction?.classList.remove('threshold-reached');

            // Clean up transition after animation
            setTimeout(() => {
                if (content) {
                    content.style.transition = '';
                }
            }, 300);

            isSwiping = false;
        }

        function handleDocumentClick(e) {
            // If clicking on action buttons, let them handle it
            if (e.target.closest('.swipe-action-edit-btn') || e.target.closest('.swipe-action-delete-btn')) {
                // Close after action (with small delay)
                setTimeout(() => {
                    if (activeSwipeContainer) {
                        resetSwipeContainer(activeSwipeContainer);
                    }
                }, 100);
                return;
            }

            // If clicking on a different container or outside, close active one
            const clickedContainer = e.target.closest('.swipe-container');
            if (activeSwipeContainer && activeSwipeContainer !== clickedContainer) {
                resetSwipeContainer(activeSwipeContainer);
            }
        }

        function resetSwipeContainer(container) {
            if (!container) return;

            const content = container.querySelector('.swipe-content');
            const editAction = container.querySelector('.swipe-action-edit');
            const deleteAction = container.querySelector('.swipe-action-delete');

            if (content) {
                content.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                content.style.transform = 'translateX(0)';
                content.classList.remove('swiped-left', 'swiped-right', 'swiping');

                setTimeout(() => {
                    content.style.transition = '';
                }, 300);
            }

            editAction?.classList.remove('visible', 'threshold-reached');
            deleteAction?.classList.remove('visible', 'threshold-reached');

            if (activeSwipeContainer === container) {
                activeSwipeContainer = null;
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSwipeHandlers);
        } else {
            initSwipeHandlers();
        }

        // Expose reset function globally for external use
        window.resetAllSwipeContainers = function () {
            document.querySelectorAll('.swipe-container').forEach(resetSwipeContainer);
        };

    })();

    // ===== NOTES MANAGEMENT SYSTEM - Apple Award UI =====
    (function () {
        // Notes data store
        window.currentNotesFilter = 'all';

        // Note: toggleNotesModal is already defined earlier in the file (line ~31431)

        window.closeNotesModal = function () {
            const modal = document.getElementById('notes-modal');
            if (!modal) return;

            const content = document.getElementById('notes-modal-content');

            if (content) {
                // New modal structure - animate out
                content.style.transform = 'translateY(100%)';
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                }, 300);
            } else {
                // Old modal structure - just hide
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
        };

        window.selectNoteCategory = function (category) {
            document.querySelectorAll('.note-cat-btn').forEach(btn => {
                btn.classList.remove('border-amber-500', 'border-emerald-500', 'border-purple-500', 'border-blue-500');
                btn.classList.add('border-transparent');
            });
            const activeBtn = document.querySelector(`.note-cat-btn[data-category="${category}"]`);
            if (activeBtn) {
                const colors = {
                    'todo': 'border-emerald-500',
                    'important': 'border-amber-500',
                    'idea': 'border-purple-500',
                    'financial': 'border-blue-500'
                };
                activeBtn.classList.remove('border-transparent');
                activeBtn.classList.add(colors[category] || 'border-amber-500');
            }
            document.getElementById('note-category').value = category;
        };

        window.saveNote = function () {
            const editId = document.getElementById('note-edit-id').value;
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value.trim();
            const category = document.getElementById('note-category').value;

            if (!title) {
                alert('Lütfen bir başlık girin!');
                return;
            }

            let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');

            if (editId) {
                const index = notes.findIndex(n => n.id === editId);
                if (index !== -1) {
                    notes[index] = { ...notes[index], title, content, category, updatedAt: Date.now() };
                }
            } else {
                notes.push({
                    id: 'note_' + Date.now(),
                    title,
                    content,
                    category,
                    completed: false,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                });
            }

            localStorage.setItem('fingo_notes', JSON.stringify(notes));
            window.closeNotesModal();
            window.renderNotes();
        };

        window.toggleNoteComplete = function (noteId) {
            let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');
            const note = notes.find(n => n.id === noteId);
            if (note) {
                note.completed = !note.completed;
                note.updatedAt = Date.now();
                localStorage.setItem('fingo_notes', JSON.stringify(notes));
                window.renderNotes();
            }
        };

        window.deleteNote = function (noteId) {
            if (!confirm('Bu notu silmek istediğinize emin misiniz?')) return;
            let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');
            notes = notes.filter(n => n.id !== noteId);
            localStorage.setItem('fingo_notes', JSON.stringify(notes));
            window.renderNotes();
        };

        window.editNote = function (noteId) {
            const notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');
            const note = notes.find(n => n.id === noteId);
            if (note) {
                window.toggleNotesModal(note);
            }
        };

        window.filterNotes = function (filter) {
            window.currentNotesFilter = filter;

            // Update filter buttons
            document.querySelectorAll('.notes-filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.remove('bg-white/60', 'dark:bg-white/10', 'text-gray-600', 'dark:text-gray-400');
                    btn.classList.add('bg-amber-500', 'text-white', 'shadow-md', 'shadow-amber-500/25');
                } else {
                    btn.classList.add('bg-white/60', 'dark:bg-white/10', 'text-gray-600', 'dark:text-gray-400');
                    btn.classList.remove('bg-amber-500', 'text-white', 'shadow-md', 'shadow-amber-500/25');
                }
            });

            window.renderNotes();
        };

        window.renderNotes = function () {
            const container = document.getElementById('notes-task-list');
            const emptyState = document.getElementById('notes-empty-state');
            if (!container) return;

            let notes = JSON.parse(localStorage.getItem('fingo_notes') || '[]');

            // Update stats
            const totalEl = document.getElementById('notes-total-count');
            const completedEl = document.getElementById('notes-completed-count');
            const pendingEl = document.getElementById('notes-pending-count');

            if (totalEl) totalEl.textContent = notes.length;
            if (completedEl) completedEl.textContent = notes.filter(n => n.completed).length;
            if (pendingEl) pendingEl.textContent = notes.filter(n => !n.completed).length;

            // Filter notes
            if (window.currentNotesFilter !== 'all') {
                notes = notes.filter(n => n.category === window.currentNotesFilter);
            }

            // Sort by date (newest first)
            notes.sort((a, b) => b.createdAt - a.createdAt);

            if (notes.length === 0) {
                container.innerHTML = '';
                if (emptyState) emptyState.classList.remove('hidden');
                return;
            }

            if (emptyState) emptyState.classList.add('hidden');

            const categoryStyles = {
                'todo': { icon: '✅', gradient: 'from-emerald-400 to-teal-500', bg: 'bg-emerald-50 dark:bg-emerald-900/20', border: 'border-emerald-200/50 dark:border-emerald-500/30', text: 'text-emerald-600 dark:text-emerald-400' },
                'important': { icon: '⭐', gradient: 'from-amber-400 to-orange-500', bg: 'bg-amber-50 dark:bg-amber-900/20', border: 'border-amber-200/50 dark:border-amber-500/30', text: 'text-amber-600 dark:text-amber-400' },
                'idea': { icon: '💡', gradient: 'from-purple-400 to-pink-500', bg: 'bg-purple-50 dark:bg-purple-900/20', border: 'border-purple-200/50 dark:border-purple-500/30', text: 'text-purple-600 dark:text-purple-400' },
                'financial': { icon: '💰', gradient: 'from-blue-400 to-indigo-500', bg: 'bg-blue-50 dark:bg-blue-900/20', border: 'border-blue-200/50 dark:border-blue-500/30', text: 'text-blue-600 dark:text-blue-400' }
            };

            container.innerHTML = notes.map(note => {
                const style = categoryStyles[note.category] || categoryStyles.todo;
                const completedClass = note.completed ? 'opacity-60' : '';
                const strikeClass = note.completed ? 'line-through' : '';

                return `
                    <div class="relative overflow-hidden rounded-2xl ${style.bg} border ${style.border} p-4 ${completedClass} transition-all duration-300 hover:shadow-lg group">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br ${style.gradient} opacity-10 rounded-full blur-xl -translate-y-1/2 translate-x-1/2"></div>
                        
                        <div class="relative flex items-start gap-3">
                            <button onclick="window.toggleNoteComplete('${note.id}')" 
                                class="flex-shrink-0 w-7 h-7 rounded-lg bg-gradient-to-br ${note.completed ? style.gradient : 'from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600'} flex items-center justify-center text-white text-sm shadow-md hover:scale-110 active:scale-95 transition-transform">
                                ${note.completed ? '✓' : ''}
                            </button>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-sm">${style.icon}</span>
                                    <h4 class="font-bold text-gray-900 dark:text-white ${strikeClass} truncate">${note.title}</h4>
                                </div>
                                ${note.content ? `<p class="text-sm text-gray-600 dark:text-gray-400 ${strikeClass} line-clamp-2">${note.content}</p>` : ''}
                                <p class="text-[10px] text-gray-400 dark:text-gray-500 mt-2">${new Date(note.createdAt).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' })}</p>
                            </div>
                            
                            <div class="flex-shrink-0 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="window.editNote('${note.id}')" class="w-8 h-8 rounded-lg bg-white/80 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors">
                                    ✏️
                                </button>
                                <button onclick="window.deleteNote('${note.id}')" class="w-8 h-8 rounded-lg bg-white/80 dark:bg-white/10 flex items-center justify-center text-gray-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // Initialize notes on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.renderNotes);
        } else {
            window.renderNotes();
        }
    })();

</script>
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- NOTES SECTION - LIGHT MODE PREMIUM STYLING                                  -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<style>
    /* ═══════════════════════════════════════════════════════════════════════════
       NOTES SECTION - LIGHT MODE REFINEMENTS
       Premium Apple-inspired design with warm amber accents
    ═══════════════════════════════════════════════════════════════════════════ */

    /* === NOTES HEADER CARD === */
    html:not(.dark) #screen-notes>div:first-child {
        background: linear-gradient(135deg,
                rgba(251, 191, 36, 0.15) 0%,
                rgba(249, 115, 22, 0.08) 50%,
                rgba(254, 243, 199, 0.2) 100%) !important;
        border: 1px solid rgba(251, 191, 36, 0.25) !important;
        box-shadow:
            0 4px 20px -4px rgba(251, 191, 36, 0.15),
            0 2px 8px -2px rgba(0, 0, 0, 0.05),
            inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
        backdrop-filter: blur(12px) !important;
        -webkit-backdrop-filter: blur(12px) !important;
    }

    /* === STATS BOXES === */
    html:not(.dark) #screen-notes .flex-1.text-center.p-2.rounded-xl {
        background: linear-gradient(145deg, #ffffff 0%, #fef3c7 100%) !important;
        border: 1px solid rgba(251, 191, 36, 0.2) !important;
        box-shadow:
            0 2px 8px -2px rgba(251, 191, 36, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
        transition: all 0.2s ease !important;
    }

    html:not(.dark) #screen-notes .flex-1.text-center.p-2.rounded-xl:hover {
        transform: translateY(-1px) !important;
        box-shadow:
            0 4px 12px -3px rgba(251, 191, 36, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
    }

    /* === FILTER TABS CONTAINER === */
    html:not(.dark) #screen-notes>.flex.gap-2.overflow-x-auto {
        padding: 2px 4px !important;
    }

    /* === INACTIVE FILTER TABS === */
    html:not(.dark) .notes-filter-btn:not(.active) {
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%) !important;
        border: 1px solid rgba(0, 0, 0, 0.08) !important;
        color: #374151 !important;
        box-shadow:
            0 2px 6px -2px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
        transition: all 0.2s ease !important;
    }

    html:not(.dark) .notes-filter-btn:not(.active):hover {
        background: linear-gradient(145deg, #fefce8 0%, #fef9c3 100%) !important;
        border-color: rgba(251, 191, 36, 0.3) !important;
        color: #92400e !important;
        box-shadow:
            0 4px 10px -3px rgba(251, 191, 36, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
        transform: translateY(-1px) !important;
    }

    /* === ACTIVE FILTER TAB === */
    html:not(.dark) .notes-filter-btn.active {
        background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%) !important;
        border: none !important;
        color: white !important;
        box-shadow:
            0 4px 14px -3px rgba(245, 158, 11, 0.4),
            0 2px 6px -2px rgba(234, 88, 12, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    }

    /* === EMPTY STATE CARD === */
    html:not(.dark) #notes-empty-state>div {
        background: linear-gradient(145deg,
                #ffffff 0%,
                rgba(254, 252, 232, 0.6) 50%,
                rgba(254, 243, 199, 0.4) 100%) !important;
        border: 1px solid rgba(251, 191, 36, 0.2) !important;
        box-shadow:
            0 8px 30px -8px rgba(251, 191, 36, 0.12),
            0 4px 12px -4px rgba(0, 0, 0, 0.05),
            inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
    }

    /* === EMPTY STATE ICON BOX === */
    html:not(.dark) #notes-empty-state .w-20.h-20.rounded-3xl {
        background: linear-gradient(145deg,
                rgba(254, 243, 199, 1) 0%,
                rgba(253, 230, 138, 0.8) 100%) !important;
        border: 1px solid rgba(251, 191, 36, 0.3) !important;
        box-shadow:
            0 8px 24px -6px rgba(251, 191, 36, 0.25),
            inset 0 2px 4px rgba(255, 255, 255, 0.8) !important;
    }

    /* === EMPTY STATE TITLE === */
    html:not(.dark) #notes-empty-state h4 {
        color: #1f2937 !important;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5) !important;
    }

    /* === EMPTY STATE SUBTITLE === */
    html:not(.dark) #notes-empty-state p {
        color: #6b7280 !important;
    }

    /* === ADD NOTE BUTTON === */
    html:not(.dark) #notes-empty-state button,
    html:not(.dark) #screen-notes button[onclick*="toggleNotesModal"]:not(.notes-filter-btn) {
        background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%) !important;
        box-shadow:
            0 6px 20px -4px rgba(245, 158, 11, 0.45),
            0 3px 8px -2px rgba(234, 88, 12, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.25) !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15) !important;
    }

    html:not(.dark) #notes-empty-state button:hover,
    html:not(.dark) #screen-notes button[onclick*="toggleNotesModal"]:not(.notes-filter-btn):hover {
        box-shadow:
            0 10px 30px -5px rgba(245, 158, 11, 0.5),
            0 4px 12px -3px rgba(234, 88, 12, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
    }

    /* === NOTES LIST ITEMS (when notes exist) === */
    html:not(.dark) #notes-task-list>div {
        background: linear-gradient(145deg, #ffffff 0%, #fefce8 100%) !important;
        border: 1px solid rgba(251, 191, 36, 0.15) !important;
        box-shadow:
            0 2px 8px -2px rgba(0, 0, 0, 0.06),
            0 1px 3px -1px rgba(251, 191, 36, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
        transition: all 0.2s ease !important;
    }

    html:not(.dark) #notes-task-list>div:hover {
        transform: translateY(-2px) !important;
        box-shadow:
            0 8px 20px -4px rgba(0, 0, 0, 0.08),
            0 4px 10px -2px rgba(251, 191, 36, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
    }

    /* === PAGE BACKGROUND ENHANCEMENT === */
    html:not(.dark) #screen-notes {
        position: relative;
    }

    html:not(.dark) #screen-notes::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
            radial-gradient(ellipse at top right, rgba(254, 243, 199, 0.3) 0%, transparent 50%),
            radial-gradient(ellipse at bottom left, rgba(254, 215, 170, 0.2) 0%, transparent 50%);
        pointer-events: none;
        z-index: -1;
    }

    /* === NOTES MODAL LIGHT MODE === */
    html:not(.dark) #notes-modal-content {
        background: linear-gradient(180deg, #ffffff 0%, #fffbeb 100%) !important;
        border-top: 1px solid rgba(251, 191, 36, 0.2) !important;
    }

    html:not(.dark) #notes-modal input,
    html:not(.dark) #notes-modal textarea {
        background: linear-gradient(145deg, #f9fafb 0%, #fef3c7 100%) !important;
        border: 1px solid rgba(251, 191, 36, 0.2) !important;
    }

    html:not(.dark) #notes-modal input:focus,
    html:not(.dark) #notes-modal textarea:focus {
        border-color: #f59e0b !important;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15) !important;
    }
</style>

<!-- STATIC NOTES MODAL FRAMEWORK -->
<div id="notes-modal" class="fixed inset-0 z-[9999] flex items-end justify-center" style="display:none;">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="window.closeNotesModal()"></div>
    <div class="relative w-full bg-white dark:bg-gray-900 rounded-t-[2rem] p-6 max-h-[85vh] overflow-y-auto transform translate-y-full transition-transform duration-300 ease-out"
        id="notes-modal-content">
        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-5"></div>
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-xl font-black text-gray-900 dark:text-white">✍️ Yeni Not</h3>
            <button onclick="window.closeNotesModal()"
                class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">✕</button>
        </div>
        <input type="hidden" id="note-edit-id" value="">
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase">Başlık</label>
                <input type="text" id="note-title" placeholder="Not başlığı..."
                    class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white font-medium border-0 focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase">İçerik</label>
                <textarea id="note-content" rows="4" placeholder="Notunuzu yazın..."
                    class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white font-medium border-0 focus:ring-2 focus:ring-amber-500 resize-none outline-none"></textarea>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase">Kategori</label>
                <div class="flex gap-2 flex-wrap">
                    <button type="button" data-category="todo" onclick="window.selectNoteCategory('todo')"
                        class="note-cat-btn px-4 py-2 rounded-xl text-sm font-bold bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 border-2 border-transparent hover:border-emerald-500 transition-all">✅
                        Yapılacak</button>
                    <button type="button" data-category="important" onclick="window.selectNoteCategory('important')"
                        class="note-cat-btn px-4 py-2 rounded-xl text-sm font-bold bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 border-2 border-transparent hover:border-amber-500 transition-all">⭐
                        Önemli</button>
                    <button type="button" data-category="idea" onclick="window.selectNoteCategory('idea')"
                        class="note-cat-btn px-4 py-2 rounded-xl text-sm font-bold bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 border-2 border-transparent hover:border-purple-500 transition-all">💡
                        Fikir</button>
                    <button type="button" data-category="financial" onclick="window.selectNoteCategory('financial')"
                        class="note-cat-btn px-4 py-2 rounded-xl text-sm font-bold bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border-2 border-transparent hover:border-blue-500 transition-all">💰
                        Finansal</button>
                </div>
                <input type="hidden" id="note-category" value="todo">
            </div>
            <button onclick="window.saveNote()"
                class="w-full py-4 rounded-2xl bg-gradient-to-r from-amber-400 to-orange-500 text-white font-bold text-base shadow-lg shadow-amber-500/30 hover:shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all duration-200">
                💾 Kaydet
            </button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
</div>

<!-- NOTE CATEGORY SELECTION SCRIPT -->
<script>
    window.selectNoteCategory = function (category) {
        // Update hidden input
        const input = document.getElementById('note-category');
        if (input) input.value = category;

        // Reset all buttons
        document.querySelectorAll('.note-cat-btn').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-offset-2', 'dark:ring-offset-gray-900', 'ring-emerald-500', 'ring-amber-500', 'ring-purple-500', 'ring-blue-500');
            btn.style.transform = '';
        });

        // Highlight active button
        const activeBtn = document.querySelector(`.note-cat-btn[data-category="${category}"]`);
        if (activeBtn) {
            // Add common active classes
            activeBtn.classList.add('ring-2', 'ring-offset-2', 'dark:ring-offset-gray-900');

            // Add color specific ring
            if (category === 'todo') activeBtn.classList.add('ring-emerald-500');
            else if (category === 'important') activeBtn.classList.add('ring-amber-500');
            else if (category === 'idea') activeBtn.classList.add('ring-purple-500');
            else if (category === 'financial') activeBtn.classList.add('ring-blue-500');

            // Add simple pulse/scale effect
            activeBtn.style.transform = 'scale(0.95)';
            setTimeout(() => {
                activeBtn.style.transform = 'scale(1)';
            }, 150);
        }
    };

    // Initialize default selection
    document.addEventListener('DOMContentLoaded', () => {
        const defaultCat = document.getElementById('note-category')?.value || 'todo';
        if (window.selectNoteCategory) window.selectNoteCategory(defaultCat);
    });
</script>

</html>

<!-- SWIPE-TO-ACTION SYSTEM - Apple iOS Style -->
<style>
    /* ═══════════════════════════════════════════════════════════════════════════
   SWIPE-TO-ACTION - APPLE iOS STYLE
   ═══════════════════════════════════════════════════════════════════════════ */

    .swipe-container {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
        margin-bottom: 8px;
        touch-action: pan-y pinch-zoom;
    }

    .swipe-wrapper {
        display: flex;
        position: relative;
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
    }

    .swipe-wrapper.swiping {
        transition: none;
    }

    .swipe-actions {
        position: absolute;
        top: 0;
        bottom: 0;
        display: flex;
        align-items: stretch;
        z-index: 1;
    }

    .swipe-actions-left {
        left: 0;
        transform: translateX(-100%);
    }

    .swipe-actions-right {
        right: 0;
        transform: translateX(100%);
    }

    .swipe-content {
        flex-shrink: 0;
        width: 100%;
        position: relative;
        z-index: 2;
        background: var(--neo-bg-elevated, rgba(255, 255, 255, 0.9));
        border-radius: 16px;
    }

    html.dark .swipe-content {
        background: var(--neo-bg-elevated, rgba(30, 30, 40, 0.9));
    }

    .swipe-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 80px;
        padding: 12px 16px;
        border: none;
        font-weight: 700;
        font-size: 11px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.15s ease;
        gap: 4px;
    }

    .swipe-btn-edit {
        background: linear-gradient(135deg, #3B82F6, #2563EB);
        color: white;
    }

    .swipe-btn-delete {
        background: linear-gradient(135deg, #EF4444, #DC2626);
        color: white;
    }

    .swipe-btn .swipe-icon {
        font-size: 20px;
        margin-bottom: 2px;
    }

    .swipe-container.swipe-active-left .swipe-wrapper {
        transform: translateX(-80px);
    }

    .swipe-container.swipe-active-right .swipe-wrapper {
        transform: translateX(80px);
    }

    .swipe-actions-left .swipe-btn:first-child {
        border-top-left-radius: 16px;
        border-bottom-left-radius: 16px;
    }

    .swipe-actions-right .swipe-btn:last-child {
        border-top-right-radius: 16px;
        border-bottom-right-radius: 16px;
    }

    .swipe-container.swipe-active-left .swipe-content,
    .swipe-container.swipe-active-right .swipe-content {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    html.dark .swipe-container.swipe-active-left .swipe-content,
    html.dark .swipe-container.swipe-active-right .swipe-content {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }
</style>

<script>
    // ═══════════════════════════════════════════════════════════════════════════
    // SWIPE-TO-ACTION HANDLER - Apple iOS Style
    // ═══════════════════════════════════════════════════════════════════════════
    (function () {
        'use strict';

        const SWIPE_THRESHOLD = 50;
        const ACTION_WIDTH = 80;
        let activeSwipeContainer = null;
        let startX = 0;
        let startY = 0;
        let currentX = 0;
        let isDragging = false;
        let isHorizontalSwipe = false;

        window.initSwipeActions = function () {
            const containers = document.querySelectorAll('.swipe-container');
            containers.forEach(container => {
                if (container.dataset.swipeInit) return;
                container.dataset.swipeInit = 'true';

                const wrapper = container.querySelector('.swipe-wrapper');
                if (!wrapper) return;

                wrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
                wrapper.addEventListener('touchmove', handleTouchMove, { passive: false });
                wrapper.addEventListener('touchend', handleTouchEnd, { passive: true });
                wrapper.addEventListener('mousedown', handleMouseDown);
            });
        };

        function handleTouchStart(e) {
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            currentX = 0;
            isDragging = true;
            isHorizontalSwipe = false;

            const container = e.currentTarget.closest('.swipe-container');
            if (activeSwipeContainer && activeSwipeContainer !== container) {
                resetSwipe(activeSwipeContainer);
            }
            e.currentTarget.classList.add('swiping');
        }

        function handleTouchMove(e) {
            if (!isDragging) return;

            const touch = e.touches[0];
            const deltaX = touch.clientX - startX;
            const deltaY = touch.clientY - startY;

            if (!isHorizontalSwipe && Math.abs(deltaX) > 10) {
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    isHorizontalSwipe = true;
                }
            }

            if (!isHorizontalSwipe) return;
            e.preventDefault();
            currentX = deltaX;

            const wrapper = e.currentTarget;
            const maxSwipe = ACTION_WIDTH + 20;
            let translateX = Math.max(-maxSwipe, Math.min(maxSwipe, deltaX));

            if (Math.abs(translateX) > ACTION_WIDTH) {
                const overflow = Math.abs(translateX) - ACTION_WIDTH;
                translateX = translateX > 0 ? ACTION_WIDTH + (overflow * 0.3) : -(ACTION_WIDTH + (overflow * 0.3));
            }
            wrapper.style.transform = `translateX(${translateX}px)`;
        }

        function handleTouchEnd(e) {
            if (!isDragging) return;
            isDragging = false;

            const wrapper = e.currentTarget;
            wrapper.classList.remove('swiping');
            wrapper.style.transform = '';

            const container = wrapper.closest('.swipe-container');

            if (isHorizontalSwipe) {
                if (currentX < -SWIPE_THRESHOLD) {
                    container.classList.remove('swipe-active-right');
                    container.classList.add('swipe-active-left');
                    activeSwipeContainer = container;
                    if (window.FingoHaptics?.light) window.FingoHaptics.light();
                } else if (currentX > SWIPE_THRESHOLD) {
                    container.classList.remove('swipe-active-left');
                    container.classList.add('swipe-active-right');
                    activeSwipeContainer = container;
                    if (window.FingoHaptics?.light) window.FingoHaptics.light();
                } else {
                    resetSwipe(container);
                }
            }
            currentX = 0;
            isHorizontalSwipe = false;
        }

        function handleMouseDown(e) {
            startX = e.clientX;
            startY = e.clientY;
            currentX = 0;
            isDragging = true;
            isHorizontalSwipe = false;

            const container = e.currentTarget.closest('.swipe-container');
            if (activeSwipeContainer && activeSwipeContainer !== container) {
                resetSwipe(activeSwipeContainer);
            }
            e.currentTarget.classList.add('swiping');

            const wrapper = e.currentTarget;

            const handleMouseMove = (moveE) => {
                if (!isDragging) return;
                const deltaX = moveE.clientX - startX;
                const deltaY = moveE.clientY - startY;

                if (!isHorizontalSwipe && Math.abs(deltaX) > 10) {
                    if (Math.abs(deltaX) > Math.abs(deltaY)) isHorizontalSwipe = true;
                }
                if (!isHorizontalSwipe) return;

                currentX = deltaX;
                const maxSwipe = ACTION_WIDTH + 20;
                let translateX = Math.max(-maxSwipe, Math.min(maxSwipe, deltaX));
                if (Math.abs(translateX) > ACTION_WIDTH) {
                    const overflow = Math.abs(translateX) - ACTION_WIDTH;
                    translateX = translateX > 0 ? ACTION_WIDTH + (overflow * 0.3) : -(ACTION_WIDTH + (overflow * 0.3));
                }
                wrapper.style.transform = `translateX(${translateX}px)`;
            };

            const handleMouseUp = () => {
                isDragging = false;
                wrapper.classList.remove('swiping');
                wrapper.style.transform = '';

                if (isHorizontalSwipe) {
                    if (currentX < -SWIPE_THRESHOLD) {
                        container.classList.remove('swipe-active-right');
                        container.classList.add('swipe-active-left');
                        activeSwipeContainer = container;
                    } else if (currentX > SWIPE_THRESHOLD) {
                        container.classList.remove('swipe-active-left');
                        container.classList.add('swipe-active-right');
                        activeSwipeContainer = container;
                    } else {
                        resetSwipe(container);
                    }
                }
                currentX = 0;
                isHorizontalSwipe = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function resetSwipe(container) {
            if (!container) return;
            container.classList.remove('swipe-active-left', 'swipe-active-right');
            if (activeSwipeContainer === container) activeSwipeContainer = null;
        }

        document.addEventListener('click', (e) => {
            if (activeSwipeContainer && !activeSwipeContainer.contains(e.target)) {
                resetSwipe(activeSwipeContainer);
            }
        });

        window.wrapTransactionForSwipe = function (transactionId, innerHtml) {
            return `
            <div class="swipe-container" data-transaction-id="${transactionId}">
                <div class="swipe-actions swipe-actions-right">
                    <button class="swipe-btn swipe-btn-delete" onclick="event.stopPropagation(); window.SwipeActions.delete('${transactionId}')">
                        <span class="swipe-icon">🗑️</span>Sil
                    </button>
                </div>
                <div class="swipe-wrapper">
                    <div class="swipe-content">${innerHtml}</div>
                </div>
                <div class="swipe-actions swipe-actions-left">
                    <button class="swipe-btn swipe-btn-edit" onclick="event.stopPropagation(); window.SwipeActions.edit('${transactionId}')">
                        <span class="swipe-icon">✏️</span>Düzenle
                    </button>
                </div>
            </div>
        `;
        };

        window.SwipeActions = {
            edit: function (id) {
                if (activeSwipeContainer) resetSwipe(activeSwipeContainer);
                if (window.FingoHaptics?.medium) window.FingoHaptics.medium();
                if (window.editTransaction) window.editTransaction(id);
            },
            delete: function (id) {
                if (window.FingoHaptics?.warning) window.FingoHaptics.warning();
                // Use the existing requestDelete system for beautiful confirmation modal
                if (window.requestDelete) {
                    window.requestDelete('transaction', id);
                } else {
                    // Fallback to simple confirm
                    if (confirm('Bu işlemi silmek istediğinize emin misiniz?')) {
                        // Try to find and call executeDelete if available
                        if (window.executeDelete) {
                            window.executeDelete();
                        }
                    }
                }
                if (activeSwipeContainer) resetSwipe(activeSwipeContainer);
            }
        };


        // LEAGCY SWIPE DISABLED - REPLACED BY AppleSwipeHandler
        // document.addEventListener('DOMContentLoaded', () => setTimeout(window.initSwipeActions, 1000));

        // const originalRenderTransactionList = window.renderTransactionList;
        // if (originalRenderTransactionList) {
        //     window.renderTransactionList = function (...args) {
        //         const result = originalRenderTransactionList.apply(this, args);
        //         setTimeout(window.initSwipeActions, 100);
        //         return result;
        //     };
        // }

        console.log('[SwipeActions] ✅ Swipe-to-Action sistem yüklendi (LEGACY DISABLED)');
    })();
</script>

<!-- INSTALLMENT DASHBOARD WIDGET UPDATER -->
<script>
    (function initInstallmentWidget() {
        'use strict';

        const APP_YEAR = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;

        window.updateInstallmentDashboardWidget = function () {
            try {
                const widget = document.getElementById('installment-dashboard-widget');
                const countEl = document.getElementById('installment-widget-count');
                const monthlyEl = document.getElementById('installment-widget-monthly');

                if (!widget) return;

                // Get installments from localStorage
                const installments = JSON.parse(localStorage.getItem(`my_installments_${APP_YEAR}`) || '[]');

                // Filter active installments (not fully paid)
                const activeInstallments = installments.filter(inst => {
                    const paid = parseInt(inst.paidCount) || 0;
                    const total = parseInt(inst.totalCount) || 1;
                    return paid < total;
                });

                const activeCount = activeInstallments.length;

                // Calculate this month's total payment
                let monthlyTotal = 0;
                activeInstallments.forEach(inst => {
                    const monthlyAmount = parseFloat(inst.monthlyAmount) || 0;
                    monthlyTotal += monthlyAmount;
                });

                // Update widget content
                if (countEl) {
                    countEl.textContent = activeCount === 0
                        ? 'Taksit Yok'
                        : `${activeCount} Aktif Taksit`;
                }

                if (monthlyEl) {
                    monthlyEl.textContent = monthlyTotal.toLocaleString('tr-TR', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }) + ' ₺';
                }

                // Show/hide widget based on active installments
                if (activeCount > 0) {
                    widget.classList.remove('hidden');
                } else {
                    widget.classList.add('hidden');
                }

            } catch (e) {
                console.warn('[InstallmentWidget] Update failed:', e);
            }
        };

        // Auto-update on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(window.updateInstallmentDashboardWidget, 500);
        });

        // Wrap renderNotes to auto-update installment widget
        const originalRenderNotes = window.renderNotes;
        if (originalRenderNotes) {
            window.renderNotes = function (...args) {
                const result = originalRenderNotes.apply(this, args);
                setTimeout(window.updateInstallmentDashboardWidget, 100);
                return result;
            };
        }

        console.log('[InstallmentWidget] ✅ Dashboard taksit widget sistemi yüklendi');
    })();
</script>

<!-- FINGO BRAIN 2.0 LOGIC (Apple Design Award Style) -->
<script>
    (function initFingoBrain() {
        'use strict';

        console.log('[FingoBrain] 🧠 Başlatılıyor...');

        // ═══════════════════════════════════════════════════════════════
        // STATE MANAGEMENT
        // ═══════════════════════════════════════════════════════════════
        const state = {
            activeTab: 'pulse', // pulse, dna, detective, installments, assistant
            timeRange: 'month', // day, week, month
            charts: {
                burnRate: null,
                radar: null
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // TAB SWITCHING LOGIC
        // ═══════════════════════════════════════════════════════════════
        window.switchAutopilotTab = function (tabId) {
            console.log('[FingoBrain] Tab değiştiriliyor:', tabId);
            // Update State
            state.activeTab = tabId;

            // 1. Update Buttons
            document.querySelectorAll('.fb-segment-btn').forEach(btn => {
                const isActive = btn.id === `tab-btn-${tabId}`;
                btn.setAttribute('aria-selected', isActive);
                if (isActive) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // 2. Hide All Contents with Fade Out
            const allTabs = document.querySelectorAll('[id^="autopilot-tab-"]');
            allTabs.forEach(tab => {
                tab.classList.add('hidden');
            });

            // 3. Show Active Content with Fade In
            const activeContent = document.getElementById(`autopilot-tab-${tabId}`);
            if (activeContent) {
                activeContent.classList.remove('hidden');

                // Trigger specific renders
                if (tabId === 'dna') {
                    window.renderRadarChart();
                    window.populateDnaList();
                }
                if (tabId === 'pulse') window.renderBurnRateChart();
                if (tabId === 'detective') window.renderDetective();
                if (tabId === 'installments' && window.updateInstallmentDashboardWidget) {
                    window.updateInstallmentDashboardWidget();
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // DATA POPULATION (MOCK)
        // ═══════════════════════════════════════════════════════════════
        window.populateDnaList = function () {
            const list = document.getElementById('dna-category-list');
            if (!list) return;

            // Mock Data
            const categories = [
                { name: 'Eğlence', amount: 1250, percent: 35, color: 'text-purple-500', icon: '🎮' },
                { name: 'Gıda', amount: 850, percent: 25, color: 'text-orange-500', icon: '🍔' },
                { name: 'Market', amount: 600, percent: 15, color: 'text-emerald-500', icon: '🛒' },
            ];

            list.innerHTML = categories.map(cat => `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-sm">
                            ${cat.icon}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-900 dark:text-white">${cat.name}</p>
                            <div class="flex items-center gap-1.5 mt-0.5">
                                <div class="w-16 h-1 bg-gray-100 dark:bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-current ${cat.color}" style="width: ${cat.percent}%"></div>
                                </div>
                                <span class="text-[9px] text-gray-400">%${cat.percent}</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm font-bold text-gray-900 dark:text-white">${cat.amount}₺</p>
                </div>
            `).join('');

            // Update Comparison
            const comp = document.getElementById('dna-month-comparison');
            if (comp) {
                comp.innerHTML = `
                    <h3 class="text-lg font-black text-gray-900 dark:text-white">%12</h3>
                    <span class="text-xs font-bold px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400">↑ Artış</span>
                 `;
            }
        };

        window.renderDetective = function () {
            const list = document.getElementById('subscription-list');
            const totalEl = document.getElementById('detective-monthly-total');
            const emptyState = document.getElementById('detective-empty-state');

            if (!list) return;

            // Mock Data
            const subs = [
                { name: 'Netflix', price: 299.99, date: 'Her ayın 15\'i', icon: '🎬' },
                { name: 'Spotify', price: 69.99, date: 'Her ayın 20\'si', icon: '🎵' },
                { name: 'iCloud', price: 12.99, date: 'Her ayın 1\'i', icon: '☁️' }
            ];

            const total = subs.reduce((acc, curr) => acc + curr.price, 0);
            if (totalEl) totalEl.textContent = total.toLocaleString('tr-TR') + ' ₺';

            if (subs.length > 0) {
                if (emptyState) emptyState.classList.add('hidden');

                list.innerHTML = subs.map(sub => `
                    <div class="p-4 flex items-center justify-between group hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-red-50 dark:bg-red-500/10 text-red-500 flex items-center justify-center text-xl shadow-sm">
                                ${sub.icon}
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-900 dark:text-white">${sub.name}</h4>
                                <p class="text-[10px] text-gray-500 font-medium">${sub.date}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black text-gray-900 dark:text-white">${sub.price} ₺</p>
                            <span class="text-[9px] font-bold text-emerald-500 bg-emerald-50 dark:bg-emerald-500/10 px-1.5 py-0.5 rounded">Aktif</span>
                        </div>
                    </div>
                `).join('');
            } else {
                if (emptyState) emptyState.classList.remove('hidden');
                list.innerHTML = '';
                list.appendChild(emptyState);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // CHART RENDERING (WRAPPER)
        // ═══════════════════════════════════════════════════════════════
        window.renderBurnRateChart = function () {
            const ctx = document.getElementById('burnRateChart');
            if (!ctx) return;

            // Destroy existing if any
            if (state.charts.burnRate) {
                state.charts.burnRate.destroy();
                state.charts.burnRate = null;
            }

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.warn('[FingoBrain] Chart.js yüklenemedi!');
                return;
            }

            // Create new Chart (Mock Data for Visuals)
            state.charts.burnRate = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'],
                    datasets: [{
                        label: 'Harcama Hızı',
                        data: [120, 190, 30, 50, 20, 300, 100],
                        borderColor: '#6366f1', // Indigo 500
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { display: false }
                    }
                }
            });
        };

        window.renderRadarChart = function () {
            const ctx = document.getElementById('radarChart');
            if (!ctx) return;

            if (state.charts.radar) {
                state.charts.radar.destroy();
                state.charts.radar = null;
            }

            if (typeof Chart === 'undefined') return;

            state.charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Gıda', 'Ulaşım', 'Eğlence', 'Fatura', 'Market', 'Diğer'],
                    datasets: [{
                        label: 'Harcama DNA',
                        data: [85, 60, 90, 45, 70, 30],
                        backgroundColor: 'rgba(139, 92, 246, 0.2)', // Purple
                        borderColor: '#8b5cf6',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#8b5cf6',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0,0,0,0.05)' },
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            pointLabels: {
                                font: { size: 11, family: 'system-ui' },
                                color: '#9ca3af'
                            },
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Setup stats
            const domCat = document.getElementById('dna-dominant-cat');
            if (domCat) domCat.textContent = 'Eğlence';

            const divScore = document.getElementById('dna-diversity-score');
            if (divScore) divScore.textContent = '8.4/10';

            const totCats = document.getElementById('dna-total-cats');
            if (totCats) totCats.textContent = '6 Kategori';
        };

        // ═══════════════════════════════════════════════════════════════
        // WIDGET INTERACTION
        // ═══════════════════════════════════════════════════════════════
        window.showWidgetInfo = function (type) {
            if (window.FingoHaptics?.light) window.FingoHaptics.light();

            if (type === 'prediction') {
                const content = `
                    <div class="space-y-4">
                        <p class="text-sm leading-relaxed">
                            <span class="font-bold text-indigo-600 dark:text-indigo-400">Nasıl Çalışır?</span><br>
                            Yapay zeka, geçmiş 3 aylık harcama alışkanlıklarınızı, düzenli ödemelerinizi ve yaklaşan taksitlerinizi analiz ederek ay sonundaki muhtemel bakiyenizi tahmin eder.
                        </p>
                        <div class="bg-indigo-50 dark:bg-indigo-500/10 p-3 rounded-xl border border-indigo-100 dark:border-indigo-500/20">
                            <h4 class="text-xs font-bold text-indigo-900 dark:text-indigo-300 mb-2 uppercase tracking-wide">Analiz Kriterleri</h4>
                            <ul class="text-xs space-y-1.5 text-gray-600 dark:text-gray-400">
                                <li class="flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span>
                                    Geçmiş Harcama Ortalaması
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>
                                    Aktif Taksitler & Abonelikler
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                    Beklenen Düzenli Gelirler
                                </li>
                            </ul>
                        </div>
                    </div>
                `;
                window.createPremiumModal('widget-info-prediction', 'Ay Sonu Tahmini', '🔮', content, [
                    { label: 'Anlaşıldı', action: "document.getElementById('widget-info-prediction').remove()", variant: 'primary' }
                ]);
            } else if (type === 'volatility') {
                const content = `
                    <div class="space-y-4">
                        <p class="text-sm leading-relaxed">
                            <span class="font-bold text-orange-600 dark:text-orange-400">Finansal Risk Nedir?</span><br>
                            Harcamalarınızdaki düzensizliği ve ani sapmaları ölçer. Yüksek volatilite, bütçenizin dengesiz olduğunu ve sürpriz harcamaların sık yaşandığını gösterir.
                        </p>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 rounded-xl bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-100 dark:border-emerald-500/20">
                                <div class="text-lg mb-1">🛡️</div>
                                <div class="text-xs font-bold text-emerald-700 dark:text-emerald-400">Düşük Risk</div>
                                <div class="text-[10px] text-emerald-600/70 dark:text-emerald-400/70 leading-tight mt-1">Dengeli ve planlı harcama yapısı.</div>
                            </div>
                            <div class="p-3 rounded-xl bg-red-50 dark:bg-red-500/10 border border-red-100 dark:border-red-500/20">
                                <div class="text-lg mb-1">⚡</div>
                                <div class="text-xs font-bold text-red-700 dark:text-red-400">Yüksek Risk</div>
                                <div class="text-[10px] text-red-600/70 dark:text-red-400/70 leading-tight mt-1">Ani ve planlanmamış büyük harcamalar.</div>
                            </div>
                        </div>
                    </div>
                `;
                window.createPremiumModal('widget-info-volatility', 'Risk Analizi', '📊', content, [
                    { label: 'Tamam', action: "document.getElementById('widget-info-volatility').remove()", variant: 'primary' }
                ]);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // PREMIUM MODAL UTILITY
        // ═══════════════════════════════════════════════════════════════
        window.createPremiumModal = function (id, title, icon, contentHTML, buttons = []) {
            // Remove existing
            const existing = document.getElementById(id);
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = id;
            modal.className = 'fixed inset-0 z-[9999] flex items-end sm:items-center justify-center pointer-events-none';

            // Generate Buttons HTML
            let buttonsHTML = '';
            if (buttons && buttons.length > 0) {
                buttonsHTML = `<div class="p-5 pt-2 flex gap-3">`;
                buttons.forEach(btn => {
                    const variantClass = btn.variant === 'primary'
                        ? 'bg-gradient-to-r from-gray-900 to-black dark:from-white dark:to-gray-200 text-white dark:text-black shadow-lg shadow-gray-900/20'
                        : 'bg-gray-100 dark:bg-white/10 text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-white/20';

                    buttonsHTML += `
                        <button onclick="${btn.action}" class="flex-1 py-3.5 rounded-xl font-bold text-sm transition-transform active:scale-95 ${variantClass}">
                            ${btn.label}
                        </button>
                    `;
                });
                buttonsHTML += `</div>`;
            }

            modal.innerHTML = `
                <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity opacity-0 pointer-events-auto" 
                     onclick="document.getElementById('${id}').remove()"></div>
                <div class="relative w-full max-w-sm mx-4 mb-6 sm:mb-0 bg-white dark:bg-[#1C1C1E] rounded-[32px] shadow-2xl overflow-hidden transform transition-all translate-y-full sm:translate-y-10 opacity-0 pointer-events-auto scale-95 ring-1 ring-black/5 dark:ring-white/10">
                    <!-- Header -->
                    <div class="p-5 pb-0 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-xl">
                                ${icon}
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">${title}</h3>
                        </div>
                        <button onclick="document.getElementById('${id}').remove()" class="w-8 h-8 rounded-full bg-gray-50 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="p-5 text-gray-600 dark:text-gray-300">
                        ${contentHTML}
                    </div>

                    <!-- Actions -->
                    ${buttonsHTML}
                </div>
            `;

            document.body.appendChild(modal);

            // Animate In
            requestAnimationFrame(() => {
                const backdrop = modal.firstElementChild;
                const card = modal.lastElementChild;

                backdrop.classList.remove('opacity-0');
                card.classList.remove('translate-y-full', 'sm:translate-y-10', 'opacity-0', 'scale-95');
            });
        };

        // Modal Openers - Full Implementation
        // Modal Openers - Full Implementation
        window.openCurrencyModal = function () {
            if (window.FingoHaptics?.light) window.FingoHaptics.light();

            const content = `
                <div class="space-y-4">
                    <!-- From -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Kaynak</label>
                        <div class="flex gap-2">
                            <select id="currency-from" class="flex-1 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-3 py-3 font-medium outline-none text-sm transition-colors focus:border-emerald-500/50">
                                <option value="USD">🇺🇸 USD</option>
                                <option value="EUR">🇪🇺 EUR</option>
                                <option value="GBP">🇬🇧 GBP</option>
                                <option value="TRY" selected>🇹🇷 TRY</option>
                            </select>
                            <input type="number" id="currency-amount" value="1000" class="w-24 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-3 py-3 font-bold text-center outline-none transition-colors focus:border-emerald-500/50">
                        </div>
                    </div>

                    <!-- Swap -->
                    <div class="flex justify-center -my-2 relative z-10">
                        <button onclick="window.swapCurrencies()" class="w-8 h-8 rounded-full bg-white dark:bg-[#2C2C2E] border border-gray-100 dark:border-white/10 shadow-sm flex items-center justify-center text-emerald-500 hover:scale-110 transition-transform">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                        </button>
                    </div>

                    <!-- To -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Hedef</label>
                        <select id="currency-to" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-3 py-3 font-medium outline-none text-sm transition-colors focus:border-emerald-500/50">
                            <option value="USD" selected>🇺🇸 USD</option>
                            <option value="EUR">🇪🇺 EUR</option>
                            <option value="GBP">🇬🇧 GBP</option>
                            <option value="TRY">🇹🇷 TRY</option>
                        </select>
                    </div>

                    <!-- Result -->
                    <div class="bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-100 dark:border-emerald-500/20 rounded-2xl p-4 text-center">
                        <div class="text-xs text-emerald-600/70 dark:text-emerald-400/70 font-semibold uppercase mb-1">Sonuç</div>
                        <div id="currency-result" class="text-2xl font-black text-emerald-600 dark:text-emerald-400 tracking-tight">Hesaplanıyor...</div>
                        <div id="currency-rate" class="text-[10px] text-emerald-600/50 dark:text-emerald-400/50 font-medium mt-1">Kur bilgisi yükleniyor</div>
                    </div>
                </div>
            `;

            window.createPremiumModal('currency-modal', 'Döviz Çevirici', '💱', content, [
                { label: 'Çevir', action: 'window.convertCurrency()', variant: 'primary' }
            ]);

            // Initial conversion
            setTimeout(() => window.convertCurrency(), 100);
        };

        window.closeCurrencyModal = function () {
            const modal = document.getElementById('currency-modal');
            if (modal) modal.remove();
        };

        window.swapCurrencies = function () {
            const from = document.getElementById('currency-from');
            const to = document.getElementById('currency-to');
            const temp = from.value;
            from.value = to.value;
            to.value = temp;
            window.convertCurrency();
        };

        window.convertCurrency = function () {
            // Canlı kurları kullan (fetchMarketData'dan gelen liveRates global değişkeni)
            // Eğer kurlar henüz yüklenmediyse varsayılanları kullan
            const rates = {
                'USD': liveRates.USD || 34.50,
                'EUR': liveRates.EUR || 37.50,
                'GBP': liveRates.GBP || 44.20,
                'TRY': 1
            };

            const from = document.getElementById('currency-from').value;
            const to = document.getElementById('currency-to').value;
            const amount = parseFloat(document.getElementById('currency-amount').value) || 0;

            // TRY bazlı hesaplama: 
            // 1 Birim -> TRY Karşılığı -> Hedef Birim
            // Örn: 100 USD -> (100 * 34.50) TRY -> (3450 / 37.50) EUR
            const fromRate = rates[from] || 1;
            const toRate = rates[to] || 1;

            const resultValue = (amount * fromRate) / toRate;
            const currentRate = fromRate / toRate;

            const resultEl = document.getElementById('currency-result');
            const rateEl = document.getElementById('currency-rate');

            if (resultEl) resultEl.textContent = `${resultValue.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${to}`;
            if (rateEl) rateEl.textContent = `1 ${from} = ${currentRate.toFixed(4)} ${to}`;
        };

        window.openLoanModal = function () {
            if (window.FingoHaptics?.light) window.FingoHaptics.light();

            const content = `
                <div class="space-y-4">
                    <!-- Amount -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Kredi Tutarı</label>
                        <div class="relative">
                            <input type="number" id="loan-amount" value="50000" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-bold outline-none transition-colors focus:border-indigo-500/50 pl-10">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">₺</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <!-- Rate -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Faiz Oranı</label>
                            <div class="relative">
                                <input type="number" id="loan-rate" value="3.5" step="0.01" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50 pl-8">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">%</span>
                            </div>
                        </div>

                        <!-- Term -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Vade</label>
                            <div class="relative">
                                <select id="loan-term" class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-3 font-medium outline-none transition-colors focus:border-indigo-500/50 appearance-none">
                                    <option value="12">12 Ay</option>
                                    <option value="24">24 Ay</option>
                                    <option value="36" selected>36 Ay</option>
                                    <option value="48">48 Ay</option>
                                    <option value="60">60 Ay</option>
                                </select>
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Result -->
                    <div class="bg-indigo-50 dark:bg-indigo-500/10 border border-indigo-100 dark:border-indigo-500/20 rounded-2xl p-4">
                        <div class="text-center mb-4">
                            <div class="text-xs text-indigo-600/70 dark:text-indigo-400/70 font-semibold uppercase mb-1">Aylık Taksit</div>
                            <div id="loan-monthly" class="text-3xl font-black text-indigo-600 dark:text-indigo-400 tracking-tight">Hesaplanıyor...</div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-4 border-t border-indigo-100 dark:border-indigo-500/20">
                            <div>
                                <div class="text-[10px] text-gray-400 font-bold uppercase">Toplam Geri Ödeme</div>
                                <div id="loan-total" class="font-bold text-gray-700 dark:text-gray-200">...</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-gray-400 font-bold uppercase">Toplam Faiz</div>
                                <div id="loan-interest" class="font-bold text-gray-700 dark:text-gray-200">...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            window.createPremiumModal('loan-modal', 'Kredi Hesaplama', '🏦', content, [
                { label: 'Hesapla', action: 'window.calculateLoan()', variant: 'primary' }
            ]);

            // Initial calculation
            setTimeout(() => window.calculateLoan(), 100);
        };

        // Removed window.closeLoanModal as it's handled by createPremiumModal
        // Removed window.setLoanTerm as we use select now

        window.calculateLoan = function () {
            const principal = parseFloat(document.getElementById('loan-amount').value) || 0;
            const annualRate = parseFloat(document.getElementById('loan-rate').value) || 0;
            const months = parseInt(document.getElementById('loan-term').value) || 36;

            // Simple Monthly Payment Formula: P * (r(1+r)^n) / ((1+r)^n - 1)
            // Monthly Rate = Annual Rate / 12 / 100
            const monthlyRate = annualRate / 12 / 100;

            let monthlyPayment = 0;
            if (monthlyRate === 0) {
                monthlyPayment = principal / months;
            } else {
                monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
            }

            const totalPayment = monthlyPayment * months;
            const totalInterest = totalPayment - principal;

            const formatMoney = (amount) => {
                return amount.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';
            };

            document.getElementById('loan-monthly').textContent = formatMoney(monthlyPayment);
            document.getElementById('loan-total').textContent = formatMoney(totalPayment);
            document.getElementById('loan-interest').textContent = formatMoney(totalInterest);
        };

        window.setFingoBrainRange = function (range) {
            state.timeRange = range;
            // Visual update
            document.querySelectorAll('.fingo-range-pill').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', false);
            });
            const btn = document.getElementById(`range-${range}`);
            if (btn) {
                btn.classList.add('active');
                btn.setAttribute('aria-selected', true);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════
        setTimeout(() => {
            // Initialize default tab
            window.switchAutopilotTab('pulse');
            console.log('[FingoBrain] ✅ 2.0 Sistem Yüklendi ve Başlatıldı');
        }, 500);

    })();
</script>
<script>
    /* ═══════════════════════════════════════════════════════════════
       iOS NATIVE EXPERIENCE ENHANCEMENTS
       ═══════════════════════════════════════════════════════════════ */

    // 2. Enhanced Haptic Feedback
    window.FingoHaptics = {
        success: () => {
            if (window.navigator && window.navigator.vibrate) try { window.navigator.vibrate([70, 40, 70]); } catch (e) { }
        },
        error: () => {
            if (window.navigator && window.navigator.vibrate) try { window.navigator.vibrate([100, 50, 100]); } catch (e) { }
        },
        light: () => {
            if (window.navigator && window.navigator.vibrate) try { window.navigator.vibrate(10); } catch (e) { }
        },
        medium: () => {
            if (window.navigator && window.navigator.vibrate) try { window.navigator.vibrate(20); } catch (e) { }
        },
        heavy: () => {
            if (window.navigator && window.navigator.vibrate) try { window.navigator.vibrate(40); } catch (e) { }
        },
        selection: () => {
            if (window.navigator && window.navigator.vibrate) try { window.navigator.vibrate(5); } catch (e) { }
        }
    };

    // 8. Prevent Swipe Gesture Conflicts & Zoom
    document.addEventListener('touchmove', (e) => {
        if (e.touches.length > 1) {
            e.preventDefault(); // Prevent multi-touch zoom/pan
        }
    }, { passive: false });

    // 9. iOS Keyboard Viewport Handling
    if (window.visualViewport) {
        const setViewportHeight = () => {
            document.documentElement.style.setProperty(
                '--viewport-height',
                `${window.visualViewport.height}px`
            );
        };

        window.visualViewport.addEventListener('resize', setViewportHeight);
        window.visualViewport.addEventListener('scroll', setViewportHeight);
        setViewportHeight();
    }
</script>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- AUTOMATIC EXPENSE ANALYSIS ENGINE v1.0                                      -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<script>
    (function () {
        'use strict';

        // ═════════════════════════════════════════════════════════════════════
        // CORE ANALYZER MODULE
        // ═════════════════════════════════════════════════════════════════════
        const ExpenseAnalyzer = {
            _cache: {},

            // 1. Fetch & Parse Data
            _getData: function () {
                try {
                    // Check global transactions first
                    if (Array.isArray(window.transactions) && window.transactions.length > 0) {
                        return window.transactions;
                    }
                    // Fallback to year-based localStorage key
                    const APP_YEAR = new Date().getFullYear();
                    const txKey = `my_expenses_${APP_YEAR}`;
                    const raw = localStorage.getItem(txKey);
                    return raw ? JSON.parse(raw) : [];
                } catch (e) {
                    console.error('[ExpenseAnalyzer] Data parse error:', e);
                    return [];
                }
            },

            // 2. Clear Cache
            clearCache: function () {
                this._cache = {};
            },

            // 3. Core Analysis Logic
            analyze: function (month, year) {
                const cacheKey = `${month}-${year}`;
                if (this._cache[cacheKey]) return this._cache[cacheKey];

                const allTxns = this._getData();
                if (!allTxns.length) return null;

                // Filter for Target Month
                const targetTxns = allTxns.filter(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    if (isNaN(tDate.getTime())) return false;

                    const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : (t.isSavings === true);
                    return t.type === 'expense' &&
                        !isSavings &&
                        tDate.getMonth() === month &&
                        tDate.getFullYear() === year;
                });

                // Filter for Previous Month (for MoM)
                let prevMonth = month - 1;
                let prevYear = year;
                if (prevMonth < 0) { prevMonth = 11; prevYear--; }

                const prevTxns = allTxns.filter(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    if (isNaN(tDate.getTime())) return false;

                    const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : (t.isSavings === true);
                    return t.type === 'expense' &&
                        !isSavings &&
                        tDate.getMonth() === prevMonth &&
                        tDate.getFullYear() === prevYear;
                });

                // --- CALCULATIONS ---

                // A. Totals
                const totalExpense = targetTxns.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const prevTotal = prevTxns.reduce((sum, t) => sum + parseFloat(t.amount), 0);

                // B. Growth
                let momChange = 0;
                if (prevTotal > 0) {
                    momChange = ((totalExpense - prevTotal) / prevTotal) * 100;
                } else if (totalExpense > 0) {
                    momChange = 100;
                }

                // C. Categories
                const catMap = {};
                targetTxns.forEach(t => {
                    const cat = t.category || 'Diğer';
                    catMap[cat] = (catMap[cat] || 0) + parseFloat(t.amount);
                });

                const topCategories = Object.entries(catMap)
                    .map(([name, amount]) => ({ name, amount, pct: (amount / totalExpense) * 100 }))
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 3);

                // D. Daily Average
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date().getDate();
                // If current month, use passed days, else all days
                const isCurrent = new Date().getMonth() === month && new Date().getFullYear() === year;
                const divisor = isCurrent ? Math.max(1, today) : daysInMonth;
                const dailyAvg = totalExpense / divisor;

                // E. Anomaly/Spike Detection (Simple 2x avg rule for now)
                const anomalies = targetTxns.filter(t => parseFloat(t.amount) > (dailyAvg * 2.5));

                const result = {
                    total: totalExpense,
                    prevTotal,
                    momChange,
                    topCategories,
                    dailyAvg,
                    anomalies,
                    txnCount: targetTxns.length,
                    month,
                    year
                };

                this._cache[cacheKey] = result;
                return result;
            },

            // 4. Public API: Get Markdown Summary for Chatbot
            getChatResponse: function () {
                const now = new Date();
                const data = this.analyze(now.getMonth(), now.getFullYear());

                if (!data || data.total === 0) {
                    return "Bu ay henüz yeterli harcama verisi bulunmuyor. Harcama ekledikçe analiz yapabilirim! 📉";
                }

                const trendEmoji = data.momChange > 0 ? "📈" : "📉";
                const trendText = data.momChange > 0 ? "Artış" : "Azalış";
                const fmt = (n) => n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺';

                let response = `
### 📊 Bu Ayın Harcama Özeti

**Toplam Harcama:** ${fmt(data.total)}
**Geçen Aya Göre:** %${Math.abs(data.momChange).toFixed(1)} ${trendText} ${trendEmoji}

**🏆 En Çok Harcananlar:**
${data.topCategories.map((c, i) => `${i + 1}. **${c.name}**: ${fmt(c.amount)} (%${c.pct.toFixed(0)})`).join('\n')}

**📅 Günlük Ortalama:** ${fmt(data.dailyAvg)}
`;

                if (data.anomalies.length > 0) {
                    response += `\n**⚠️ Dikkat Çeken Harcamalar:**\n${data.anomalies.slice(0, 2).map(t => `- ${t.description || t.category}: ${fmt(parseFloat(t.amount))}`).join('\n')}`;
                }

                // Add button action hint
                response += `\n\n[Detaylı Analiz tablosunu açmak için buraya tıklayın](action:open_expense_modal)`;

                return response.trim();
            },

            // 5. Public API: Open UI Modal
            openModal: function () {
                const now = new Date();
                const data = this.analyze(now.getMonth(), now.getFullYear());
                if (!data) {
                    window.showToast?.('Görüntülenecek veri yok', 'warning');
                    return;
                }
                this._renderModal(data);
            },

            _renderModal: function (data) {
                const modal = document.getElementById('expense-analysis-modal');
                if (!modal) return;

                const fmt = (n) => n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                // Populate DOM
                document.getElementById('ea-total').textContent = fmt(data.total) + ' ₺';

                const momEl = document.getElementById('ea-mom');
                const isUp = data.momChange > 0;
                momEl.textContent = `%${Math.abs(data.momChange).toFixed(1)} ${isUp ? 'Artış' : 'Azalış'}`;
                momEl.className = `text-xs font-bold px-2 py-1 rounded-lg ${isUp ? 'bg-rose-100 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400' : 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400'}`;

                document.getElementById('ea-daily').textContent = fmt(data.dailyAvg) + ' ₺';

                // Render Bars
                const barsContainer = document.getElementById('ea-bars');
                barsContainer.innerHTML = data.topCategories.map(c => `
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-bold text-gray-700 dark:text-gray-300">${c.name}</span>
                            <span class="text-gray-500">${fmt(c.amount)} ₺</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full" style="width: ${c.pct}%"></div>
                        </div>
                    </div>
                `).join('');

                // Render Anomalies
                const anomalyContainer = document.getElementById('ea-anomalies');
                if (data.anomalies.length > 0) {
                    anomalyContainer.innerHTML = data.anomalies.slice(0, 3).map(t => `
                        <div class="flex items-center justify-between p-2 bg-red-50 dark:bg-red-900/10 rounded-lg border border-red-100 dark:border-red-900/30">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">⚠️</span>
                                <div>
                                    <p class="text-xs font-bold text-gray-800 dark:text-gray-200">${t.description || t.category}</p>
                                    <p class="text-[10px] text-gray-500">${new Date(t.date).toLocaleDateString('tr-TR')}</p>
                                </div>
                            </div>
                            <span class="text-xs font-black text-rose-600 dark:text-rose-400">-${fmt(parseFloat(t.amount))} ₺</span>
                        </div>
                     `).join('');
                    document.getElementById('ea-anomaly-section').classList.remove('hidden');
                } else {
                    document.getElementById('ea-anomaly-section').classList.add('hidden');
                }

                // Show Modal
                modal.classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('ea-modal-content').classList.remove('translate-y-full');
                }, 10);
            }
        };

        // Expose to window
        window.ExpenseAnalyzer = ExpenseAnalyzer;

        // Make close function global
        window.closeExpenseModal = function () {
            const content = document.getElementById('ea-modal-content');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('expense-analysis-modal').classList.add('hidden');
            }, 300);
        };

    })();
</script>

<style>
    /* Premium Modal Styles */
    #ea-modal-content {
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
</style>

<!-- EXPENSE ANALYSIS MODAL -->
<div id="expense-analysis-modal" class="fixed inset-0 z-[10001] flex items-end justify-center hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="window.closeExpenseModal()"></div>
    <div id="ea-modal-content"
        class="relative w-full max-w-md bg-white dark:bg-gray-900 rounded-t-[32px] p-6 transform translate-y-full max-h-[90vh] overflow-y-auto">

        <!-- Handle -->
        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>

        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="text-2xl font-black text-gray-900 dark:text-white tracking-tight">Harcama Analizi</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">Bu ayın finansal öngörüleri</p>
            </div>
            <div
                class="w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-xl">
                📊
            </div>
        </div>

        <!-- Summary Card -->
        <div
            class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-5 text-white shadow-xl shadow-indigo-500/30 mb-6">
            <p class="text-indigo-100 text-sm font-medium mb-1">Toplam Harcama</p>
            <div class="flex items-end gap-3 mb-2">
                <h2 class="text-3xl font-black" id="ea-total">0,00 ₺</h2>
            </div>
            <div class="flex items-center gap-2">
                <span id="ea-mom" class="bg-white/20 backdrop-blur-md px-2 py-1 rounded-lg text-xs font-bold"></span>
                <span class="text-xs opacity-80">geçen aya göre</span>
            </div>
        </div>

        <!-- Daily Average -->
        <div
            class="flex items-center justify-between p-4 bg-gray-50 dark:bg-white/5 rounded-2xl border border-gray-100 dark:border-white/5 mb-6">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center text-amber-600">
                    📅
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase">Günlük Ortalama</p>
                    <p class="text-lg font-black text-gray-900 dark:text-white" id="ea-daily">0,00 ₺</p>
                </div>
            </div>
        </div>

        <!-- Top Categories -->
        <div class="mb-6">
            <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                🏆 En Çok Harcananlar
            </h4>
            <div id="ea-bars" class="space-y-2">
                <!-- Bars injected via JS -->
            </div>
        </div>

        <!-- Anomalies -->
        <div id="ea-anomaly-section" class="hidden">
            <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                ⚠️ Dikkat Çekenler
            </h4>
            <div id="ea-anomalies" class="space-y-2">
                <!-- Anomalies injected via JS -->
            </div>
        </div>

        <!-- Close Button -->
        <button onclick="window.closeExpenseModal()"
            class="w-full mt-8 py-4 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white font-bold hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            Kapat
        </button>
    </div>
</div>


<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- INFLATION-ADJUSTED PORTFOLIO SIMULATOR v1.0                                 -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<script>
    (function () {
        'use strict';

        // ═════════════════════════════════════════════════════════════════════
        // CORE SIMULATOR MODULE
        // ═════════════════════════════════════════════════════════════════════
        const PortfolioSimulator = {

            // 1. Core Simulation Logic
            simulate: function (params) {
                // Validate & Clamp Inputs
                const initial = Math.max(0, Number(params.initialAmount) || 0);
                const monthly = Math.max(0, Number(params.monthlyContribution) || 0);
                const rate = Math.min(100, Math.max(-50, Number(params.annualReturnRate) || 0)) / 100;
                const inflation = Math.min(100, Math.max(0, Number(params.annualInflationRate) || 0)) / 100;
                const months = Math.min(240, Math.max(1, parseInt(params.durationMonths) || 60)); // Max 20 years

                const monthlyRate = rate / 12;
                const monthlyInflation = inflation / 12;

                const data = [];
                let currentNominal = initial;
                let totalInvested = initial;

                for (let m = 0; m <= months; m++) {
                    const year = Math.floor(m / 12);

                    // Simple Compound Interest
                    if (m > 0) {
                        currentNominal = (currentNominal * (1 + monthlyRate)) + monthly;
                        totalInvested += monthly;
                    }

                    // Inflation Discounting
                    // Real = Nominal / (1 + inflation)^years
                    const discountFactor = Math.pow(1 + inflation, m / 12);
                    const currentReal = currentNominal / discountFactor;

                    // Push Data Point (every 6 months or end)
                    if (m % 6 === 0 || m === months) {
                        data.push({
                            month: m,
                            year: (m / 12).toFixed(1),
                            nominal: Math.round(currentNominal),
                            real: Math.round(currentReal),
                            invested: Math.round(totalInvested)
                        });
                    }
                }

                return {
                    initial,
                    monthly,
                    rate: rate * 100,
                    inflation: inflation * 100,
                    duration: months,
                    finalNominal: data[data.length - 1].nominal,
                    finalReal: data[data.length - 1].real,
                    totalInvested: data[data.length - 1].invested,
                    purchasingPowerPct: ((data[data.length - 1].real / data[data.length - 1].nominal) * 100).toFixed(0),
                    data
                };
            },

            // 2. Report Generation for Chatbot
            getChatResponse: function (userMessage) {
                // Try to extract numbers from message, otherwise defaults
                // Regex looks for "X bin", "X tl", percentages
                // For now, use sensible defaults if not explicit
                const defaults = {
                    initialAmount: 100000,
                    monthlyContribution: 10000,
                    annualReturnRate: 25, // BIST/Gold avg
                    annualInflationRate: 40, // TR Inflation
                    durationMonths: 36 // 3 years
                };

                const sim = this.simulate(defaults);
                const fmt = (n) => n.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';

                return `
### 📈 Portföy Simülasyonu (3 Yıllık)

**Varsayımlar:**
Dolar/Altın/Borsa Getirisi: %${sim.rate}
Enflasyon: %${sim.inflation}

**📊 Sonuçlar:**
**Görünen Para (Nominal):** ${fmt(sim.finalNominal)}
**Gerçek Alım Gücü (Reel):** ${fmt(sim.finalReal)} 📉

**💡 Özet:**
Paranız rakam olarak büyüse de, enflasyon nedeniyle alım gücünüzün **%${100 - sim.purchasingPowerPct}** erimesi riskine dikkat edin.

[Simülatörü açıp kendi rakamlarını girmek için tıkla](action:open_portfolio_modal)
`;
            },

            // 3. UI Modal Integration
            openModal: function () {
                const modal = document.getElementById('portfolio-modal');
                if (!modal) return;

                // Set Defaults
                document.getElementById('ps-initial').value = 10000;
                document.getElementById('ps-monthly').value = 5000;
                document.getElementById('ps-rate').value = 30;
                document.getElementById('ps-inflation').value = 45;
                document.getElementById('ps-years').value = 3;

                // Initial Recalc
                this.updateUI();

                modal.classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('ps-modal-content').classList.remove('translate-y-full');
                }, 10);
            },

            updateUI: function () {
                const params = {
                    initialAmount: document.getElementById('ps-initial').value,
                    monthlyContribution: document.getElementById('ps-monthly').value,
                    annualReturnRate: document.getElementById('ps-rate').value,
                    annualInflationRate: document.getElementById('ps-inflation').value,
                    durationMonths: document.getElementById('ps-years').value * 12
                };

                const res = this.simulate(params);
                const fmt = (n) => n.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';

                // Update Cards
                document.getElementById('ps-val-nominal').textContent = fmt(res.finalNominal);
                document.getElementById('ps-val-real').textContent = fmt(res.finalReal);
                document.getElementById('ps-val-invested').textContent = fmt(res.totalInvested);

                // Update Chart
                this.renderChart(res.data);
            },

            renderChart: function (data) {
                const svg = document.getElementById('ps-chart');
                if (!svg) return;

                const width = svg.clientWidth;
                const height = svg.clientHeight;
                const padding = 20;

                // 1. Scale
                const maxVal = Math.max(...data.map(d => d.nominal));
                const minVal = 0;

                const xScale = (i) => padding + (i / (data.length - 1)) * (width - padding * 2);
                const yScale = (v) => height - padding - ((v - minVal) / (maxVal - minVal)) * (height - padding * 2);

                // 2. Paths
                const nominalPath = data.map((d, i) => `${i === 0 ? 'M' : 'L'} ${xScale(i)} ${yScale(d.nominal)}`).join(' ');
                const realPath = data.map((d, i) => `${i === 0 ? 'M' : 'L'} ${xScale(i)} ${yScale(d.real)}`).join(' ');

                // 3. Render
                svg.innerHTML = `
                    <!-- Grid -->
                    <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#e5e7eb" stroke-width="1" />
                    <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#e5e7eb" stroke-width="1" />
                    
                    <!-- Nominal Line (Purple) -->
                    <path d="${nominalPath}" fill="none" stroke="#8b5cf6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                    
                    <!-- Real Line (Rose/Dashed) -->
                    <path d="${realPath}" fill="none" stroke="#f43f5e" stroke-width="3" stroke-dasharray="4,4" stroke-linecap="round" stroke-linejoin="round" />

                    <!-- End Dots -->
                    <circle cx="${xScale(data.length - 1)}" cy="${yScale(data[data.length - 1].nominal)}" r="4" fill="#8b5cf6" />
                    <circle cx="${xScale(data.length - 1)}" cy="${yScale(data[data.length - 1].real)}" r="4" fill="#f43f5e" />
                `;
            }
        };

        window.PortfolioSimulator = PortfolioSimulator;

        window.closePortfolioModal = function () {
            const content = document.getElementById('ps-modal-content');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('portfolio-modal').classList.add('hidden');
            }, 300);
        };

        // Attach Input Listeners
        window.initPortfolioListeners = function () {
            const inputs = ['ps-initial', 'ps-monthly', 'ps-rate', 'ps-inflation', 'ps-years'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', () => window.PortfolioSimulator.updateUI());
            });
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initPortfolioListeners);
        } else {
            window.initPortfolioListeners();
        }

    })();
</script>

<!-- PORTFOLIO SIMULATION MODAL -->
<div id="portfolio-modal" class="fixed inset-0 z-[10002] flex items-end justify-center hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="window.closePortfolioModal()"></div>
    <div id="ps-modal-content"
        class="relative w-full max-w-md bg-white dark:bg-gray-900 rounded-t-[32px] p-6 transform translate-y-full max-h-[95vh] overflow-y-auto transition-transform duration-300">

        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>

        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-black text-gray-900 dark:text-white tracking-tight">Portföy Simülatörü</h3>
            <button onclick="window.closePortfolioModal()"
                class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">✕</button>
        </div>

        <!-- Inputs Grid -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Başlangıç (TL)</label>
                <input type="number" id="ps-initial"
                    class="w-full mt-1 px-3 py-2 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold dark:text-white"
                    value="10000">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Aylık Ekleme</label>
                <input type="number" id="ps-monthly"
                    class="w-full mt-1 px-3 py-2 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold dark:text-white"
                    value="5000">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Yıllık Getiri %</label>
                <input type="number" id="ps-rate"
                    class="w-full mt-1 px-3 py-2 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold text-indigo-600"
                    value="30">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Enflasyon %</label>
                <input type="number" id="ps-inflation"
                    class="w-full mt-1 px-3 py-2 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold text-rose-500"
                    value="45">
            </div>
        </div>

        <div class="mb-6">
            <label class="text-xs font-bold text-gray-500 uppercase">Süre: <span id="ps-years-val">3</span> Yıl</label>
            <input type="range" id="ps-years" min="1" max="20" value="3" class="w-full mt-2"
                oninput="document.getElementById('ps-years-val').innerText = this.value">
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div
                class="p-4 rounded-2xl bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-900/30">
                <p class="text-xs text-indigo-500 font-bold mb-1">GÖRÜNEN DEĞER</p>
                <p class="text-lg font-black text-indigo-700 dark:text-indigo-300" id="ps-val-nominal">0 ₺</p>
            </div>
            <div class="p-4 rounded-2xl bg-rose-50 dark:bg-rose-900/20 border border-rose-100 dark:border-rose-900/30">
                <p class="text-xs text-rose-500 font-bold mb-1">REEL DEĞER (BUGÜN)</p>
                <p class="text-lg font-black text-rose-700 dark:text-rose-300" id="ps-val-real">0 ₺</p>
            </div>
        </div>

        <div class="text-center mb-4">
            <p class="text-xs text-gray-400">Toplam Yatırılan Ana Para: <span id="ps-val-invested"
                    class="font-bold text-gray-600 dark:text-gray-300"></span></p>
        </div>

        <!-- Chart Container -->
        <div class="h-48 w-full bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-2 relative overflow-hidden">
            <svg id="ps-chart" width="100%" height="100%" viewBox="0 0 350 180" preserveAspectRatio="none"
                class="w-full h-full overflow-visible"></svg>
        </div>

        <div class="flex justify-center gap-4 mt-2 text-[10px] font-bold">
            <div class="flex items-center gap-1">
                <div class="w-3 h-1 bg-indigo-500 rounded-full"></div> Nominal
            </div>
            <div class="flex items-center gap-1">
                <div class="w-3 h-1 bg-rose-500 rounded-full border border-dashed"></div> Reel (Enflasyondan
                Arındırılmış)
            </div>
        </div>

    </div>
</div>


<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- FINANCIAL FORECAST ENGINE (3-MONTH) v1.0                                    -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<script>
    (function () {
        'use strict';

        const FinancialForecast = {

            _getData: function () {
                try {
                    if (Array.isArray(window.transactions) && window.transactions.length > 0) {
                        return window.transactions;
                    }
                    const APP_YEAR = new Date().getFullYear();
                    const txKey = `my_expenses_${APP_YEAR}`;
                    return JSON.parse(localStorage.getItem(txKey) || '[]');
                } catch (e) { return []; }
            },

            // 1. Core Forecasting Logic
            analyze: function () {
                const txs = this._getData();
                if (txs.length === 0) return null;

                // Group by Month (YYYY-MM)
                const monthly = {};
                txs.forEach(t => {
                    const tDate = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate() : new Date(t.date);
                    if (isNaN(tDate.getTime())) return;

                    const k = `${tDate.getFullYear()}-${tDate.getMonth() + 1}`;
                    if (!monthly[k]) monthly[k] = { income: 0, expense: 0 };

                    const amt = parseFloat(t.amount) || 0;
                    const isSavings = window.isSavingsTransaction ? window.isSavingsTransaction(t) : (t.isSavings === true);

                    if (t.type === 'income') {
                        monthly[k].income += amt;
                    } else if (t.type === 'expense' && !isSavings) {
                        monthly[k].expense += amt;
                    }
                });

                const months = Object.values(monthly);
                if (months.length === 0) return null;

                // Averages
                const avgIncome = months.reduce((s, m) => s + m.income, 0) / months.length;
                const avgExpense = months.reduce((s, m) => s + m.expense, 0) / months.length;
                const avgSavings = avgIncome - avgExpense;
                const savingsRate = avgIncome > 0 ? (avgSavings / avgIncome) : 0;

                // Volatility (Std Dev of Expenses)
                const variance = months.reduce((s, m) => s + Math.pow(m.expense - avgExpense, 2), 0) / months.length;
                const volatility = Math.sqrt(variance);
                const volatilityPct = avgExpense > 0 ? (volatility / avgExpense) : 0;

                // Risk/Health Score (0-100)
                // Base 100.
                // Penalty 1: Low Savings Rate (< 20%) -> up to -40 pts
                // Penalty 2: High Volatility (> 10%) -> up to -30 pts
                // Penalty 3: Negative Cashflow -> -50 pts

                let score = 100;
                if (avgSavings < 0) score -= 50;
                else if (savingsRate < 0.20) score -= (20 - (savingsRate * 100)) * 2;

                if (volatilityPct > 0.10) score -= Math.min(30, (volatilityPct - 0.10) * 100);

                score = Math.max(0, Math.min(100, Math.round(score)));

                // 3-Month Projection
                // Get current balance (simulated or from profile - using static simulation base for now or last known)
                // Ideally reading real balance, but let's assume "Expected Savings Addition"
                const projectedSavings = avgSavings * 3;

                // Scenarios
                const bestCase = (avgSavings + volatility) * 3;
                const worstCase = (avgSavings - volatility) * 3;

                return {
                    avgIncome,
                    avgExpense,
                    avgSavings,
                    volatility,
                    score,
                    forecast: {
                        expected: projectedSavings,
                        best: bestCase,
                        worst: worstCase
                    },
                    insights: [
                        savingsRate < 0.1 ? "⚠️ Tasarruf oranın %10'un altında. Riskli bölge." : "✅ Tasarruf alışkanlığın sağlıklı.",
                        volatilityPct > 0.2 ? "⚠️ Harcamalarında yüksek dalgalanma var (Dengesiz)." : "✅ Harcama dengen istikrarlı.",
                        avgSavings < 0 ? "🚨 Gelirinden fazla harcıyorsun! Acil planlama şart." : "💰 Her ay düzenli artıdasın."
                    ]
                };
            },

            // 2. Chatbot Integration
            getChatResponse: function () {
                const data = this.analyze();
                if (!data) return "Yeterli işlem verisi olmadığı için 3 aylık tahmin yapamıyorum. Lütfen önce biraz işlem ekle.";

                const fmt = (n) => (n > 0 ? '+' : '') + n.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';

                return `
### 🔮 3 Aylık Finansal Tahmin

**Finansal Sağlık Skoru:** ${data.score}/100
(Bu skor harcama dengene ve tasarruf oranına göre hesaplandı)

**3 Ay Sonra Beklenen Durum:**
🔹 **Beklenen:** ${fmt(data.forecast.expected)} (Mevcut birikimine eklenecek)
🚀 **İyi Senaryo:** ${fmt(data.forecast.best)}
⚠️ **Kötü Senaryo:** ${fmt(data.forecast.worst)}

**Tespitler:**
${data.insights.map(i => `- ${i}`).join('\n')}

[Detaylı Rapor ve Risk Analizi İçin Tıkla](action:open_forecast_modal)
`;
            },

            // 3. UI Integration
            openModal: function () {
                const modal = document.getElementById('forecast-modal');
                if (!modal) return;

                const data = this.analyze();
                if (!data) {
                    window.showToast?.('Görüntülenecek veri yok', 'warning');
                    return;
                }

                // Update UI
                this._renderGauge(data.score);

                const fmt = (n) => (n > 0 ? '+' : '') + n.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';

                document.getElementById('ff-expected').innerText = fmt(data.forecast.expected);
                document.getElementById('ff-best').innerText = fmt(data.forecast.best);
                document.getElementById('ff-worst').innerText = fmt(data.forecast.worst);

                const insightsHtml = data.insights.map(i =>
                    `<li class="flex items-start gap-2 text-sm text-gray-600 dark:text-gray-300">
                        <span class="mt-1">●</span> ${i}
                    </li>`
                ).join('');
                document.getElementById('ff-insights').innerHTML = insightsHtml;

                // Show
                modal.classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('ff-modal-content').classList.remove('translate-y-full');
                }, 10);
            },

            _renderGauge: function (score) {
                const circle = document.getElementById('ff-gauge-path');
                const text = document.getElementById('ff-score-text');
                if (!circle || !text) return;

                // Score 0-100
                // Color mapping: 0-40 Red, 40-70 Yellow, 70-100 Green
                let color = '#ef4444'; // Red
                if (score >= 70) color = '#22c55e'; // Green
                else if (score >= 40) color = '#f59e0b'; // Yellow

                // Circle Dasharray (Approx for half circle or full)
                // Let's do a 180 degree arc
                // Circumference = 2 * pi * 40 = ~251
                // We want half circle = 126
                const maxDash = 126;
                const dash = (score / 100) * maxDash;

                circle.style.strokeDasharray = `${dash}, 251`;
                circle.style.stroke = color;
                text.innerText = score;
                text.style.fill = color;
            }
        };

        window.FinancialForecast = FinancialForecast;

        window.closeForecastModal = function () {
            const content = document.getElementById('ff-modal-content');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('forecast-modal').classList.add('hidden');
            }, 300);
        };

    })();
</script>

<!-- FORECAST MODAL -->
<div id="forecast-modal" class="fixed inset-0 z-[10002] flex items-end justify-center hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="window.closeForecastModal()"></div>
    <div id="ff-modal-content"
        class="relative w-full max-w-md bg-white dark:bg-gray-900 rounded-t-[32px] p-6 transform translate-y-full max-h-[95vh] overflow-y-auto transition-transform duration-300">

        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>

        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-black text-gray-900 dark:text-white tracking-tight">Gelecek Tahmini</h3>
            <button onclick="window.closeForecastModal()"
                class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">✕</button>
        </div>

        <!-- Risk Score Gauge -->
        <div class="flex flex-col items-center justify-center mb-8 relative">
            <svg width="180" height="100" viewBox="0 0 100 60" class="overflow-visible">
                <!-- Background Track -->
                <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e5e7eb" stroke-width="8"
                    stroke-linecap="round" class="dark:stroke-gray-800" />
                <!-- Score Track -->
                <path id="ff-gauge-path" d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#22c55e" stroke-width="8"
                    stroke-linecap="round" stroke-dasharray="0, 251"
                    style="transition: stroke-dasharray 1s ease-out;" />
                <!-- Score Text -->
                <text id="ff-score-text" x="50" y="45" text-anchor="middle" font-size="22" font-weight="900"
                    fill="#22c55e">0</text>
                <text x="50" y="60" text-anchor="middle" font-size="8"
                    class="fill-gray-400 font-bold uppercase tracking-wider">Finansal Sağlık</text>
            </svg>
        </div>

        <!-- 3 Scenarios -->
        <div class="space-y-3 mb-8">
            <!-- Best -->
            <div
                class="flex items-center justify-between p-4 rounded-2xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-900/30">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-800 text-emerald-600 flex items-center justify-center text-sm">
                        🚀</div>
                    <div>
                        <p class="text-xs font-bold text-emerald-600">İYİ SENARYO</p>
                        <p class="text-[10px] text-gray-500">Tasarruf + Düşük Harcama</p>
                    </div>
                </div>
                <p class="text-lg font-black text-emerald-700 dark:text-emerald-400" id="ff-best">+0 ₺</p>
            </div>

            <!-- Expected -->
            <div
                class="flex items-center justify-between p-4 rounded-2xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/30 transform scale-[1.02] shadow-lg shadow-blue-500/10">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-800 text-blue-600 flex items-center justify-center text-sm">
                        🔹</div>
                    <div>
                        <p class="text-xs font-bold text-blue-600">BEKLENEN (3 AY)</p>
                        <p class="text-[10px] text-gray-500">Mevcut Ortalamaya Göre</p>
                    </div>
                </div>
                <p class="text-xl font-black text-blue-700 dark:text-blue-400" id="ff-expected">+0 ₺</p>
            </div>

            <!-- Worst -->
            <div
                class="flex items-center justify-between p-4 rounded-2xl bg-rose-50 dark:bg-rose-900/20 border border-rose-100 dark:border-rose-900/30">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-rose-100 dark:bg-rose-800 text-rose-600 flex items-center justify-center text-sm">
                        ⚠️</div>
                    <div>
                        <p class="text-xs font-bold text-rose-600">KÖTÜ SENARYO</p>
                        <p class="text-[10px] text-gray-500">Yüksek Harcama Volatilitesi</p>
                    </div>
                </div>
                <p class="text-lg font-black text-rose-700 dark:text-rose-400" id="ff-worst">+0 ₺</p>
            </div>
        </div>

        <!-- Insights -->
        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-5 mb-8">
            <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-3">💡 Yapay Zeka Tespitleri</h4>
            <ul class="space-y-2" id="ff-insights">
                <!-- Insights injected here -->
            </ul>
        </div>

        <button onclick="window.closeForecastModal()"
            class="w-full py-4 rounded-2xl bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold text-lg hover:scale-[0.98] transition-transform">
            Tamam, Anlaşıldı
        </button>

    </div>
</div>

<!-- AI LAB FAB REMOVED -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- APPLE SWIPEABLE LIST COMPONENT (iOS Mail Style)                             -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<style>
    .apple-swipe-container {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
        /* Match card radius */
        background-color: var(--fb-bg-secondary, #ffffff);
        touch-action: pan-y;
        /* Allow vertical scroll, handle horizontal in JS */
        user-select: none;
        -webkit-user-select: none;
        margin-bottom: 12px;
        /* Spacing between items */
    }

    /* Background Actions Layer */
    .apple-swipe-actions {
        position: absolute;
        inset: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 0;
    }

    .apple-action-left {
        background-color: #34C759;
        /* Green for Edit/Action */
        width: 50%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding-left: 24px;
        transform-origin: left;
    }

    .apple-action-right {
        background-color: #FF3B30;
        /* Red for Delete */
        width: 50%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 24px;
        transform-origin: right;
    }

    /* Icons */
    .apple-swipe-icon {
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        font-weight: 600;
        font-size: 11px;
        transform: scale(0.5);
        opacity: 0;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s ease;
    }

    .apple-swipe-icon svg {
        width: 24px;
        height: 24px;
        stroke-width: 2.5;
    }

    /* Foreground Content Layer */
    .apple-swipe-content {
        position: relative;
        z-index: 10;
        background-color: var(--fb-bg-secondary, #ffffff);
        /* Ensure it covers background */
        transition: transform 0s;
        /* Default no transition for drag */
    }

    html.dark .apple-swipe-content {
        background-color: rgba(30, 27, 56, 1);
        /* Match dark card bg */
    }

    /* Transaction Item Styling (Apple Style) */
    .apple-transaction-item {
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    html.dark .apple-transaction-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .apple-icon-box {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        background-color: var(--fb-bg-primary);
        flex-shrink: 0;
    }

    .apple-tx-info {
        flex: 1;
        min-width: 0;
    }

    .apple-tx-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--fb-text-primary);
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .apple-tx-subtitle {
        font-size: 13px;
        color: var(--fb-text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .apple-tx-amount {
        font-size: 16px;
        font-weight: 700;
        color: var(--fb-text-primary);
        text-align: right;
        flex-shrink: 0;
        font-feature-settings: "tnum";
    }

    .apple-tx-amount.expense {
        color: var(--fb-text-primary);
    }

    .apple-tx-amount.income {
        color: var(--apple-green);
    }
</style>

<script>
    class AppleSwipeableItem {
        constructor(element, onRightAction, onLeftAction) {
            this.el = element;
            this.content = element.querySelector('.apple-swipe-content');
            this.leftIcon = element.querySelector('.apple-swipe-action-left .apple-swipe-icon'); // The icon shown when swiping RIGHT (Edit)
            this.rightIcon = element.querySelector('.apple-swipe-action-right .apple-swipe-icon'); // The icon shown when swiping LEFT (Delete)

            // NOTE: In iOS, "Swipe Left" reveals the Right Action (Delete)
            //       "Swipe Right" reveals the Left Action (Edit/Select)

            this.onRightAction = onRightAction; // DELETE (Red)
            this.onLeftAction = onLeftAction;   // EDIT (Green/Blue)

            this.startX = 0;
            this.currentX = 0;
            this.isDragging = false;
            this.threshold = 80;
            this.maxDrag = 120;
            this.hapticsTriggered = false;

            this.addListeners();
        }

        addListeners() {
            this.content.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
            this.content.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
            this.content.addEventListener('touchend', this.handleTouchEnd.bind(this));
            // Add mouse support for debugging
            this.content.addEventListener('mousedown', this.handleMouseDown.bind(this));
        }

        handleTouchStart(e) {
            this.startX = e.touches[0].clientX;
            this.isDragging = true;
            this.content.style.transition = 'none';
            this.hapticsTriggered = false;
        }

        handleMouseDown(e) {
            this.startX = e.clientX;
            this.isDragging = true;
            this.content.style.transition = 'none';
            this.hapticsTriggered = false;

            const mouseMove = (ev) => {
                if (!this.isDragging) return;
                const deltaX = ev.clientX - this.startX;
                this.updateSwipe(deltaX);
            };

            const mouseUp = () => {
                this.isDragging = false;
                window.removeEventListener('mousemove', mouseMove);
                window.removeEventListener('mouseup', mouseUp);
                this.finalizeSwipe(this.currentX);
            };

            window.addEventListener('mousemove', mouseMove);
            window.addEventListener('mouseup', mouseUp);
        }

        handleTouchMove(e) {
            if (!this.isDragging) return;
            const x = e.touches[0].clientX;
            const deltaX = x - this.startX;

            // Determine if horizontal scroll
            if (Math.abs(deltaX) > 5) {
                if (e.cancelable) e.preventDefault(); // Lock vertical scroll
                this.updateSwipe(deltaX);
            }
        }

        handleTouchEnd(e) {
            if (!this.isDragging) return;
            this.isDragging = false;
            this.finalizeSwipe(this.currentX);
        }

        updateSwipe(deltaX) {
            // Resistance / Rubber banding
            // Logarithmic resistance
            const resistance = 0.4;
            let visualDelta = deltaX;

            // Limit Drag if needed, or apply resistance
            if (visualDelta > this.maxDrag) {
                visualDelta = this.maxDrag + (visualDelta - this.maxDrag) * 0.2;
            } else if (visualDelta < -this.maxDrag) {
                visualDelta = -this.maxDrag + (visualDelta + this.maxDrag) * 0.2;
            }

            this.currentX = visualDelta;
            this.content.style.transform = `translateX(${visualDelta}px)`;

            // Haptic & Icon Logic
            const absDelta = Math.abs(visualDelta);
            const progress = Math.min(1, absDelta / this.threshold);

            // Scale Icons
            // If swiping LEFT (deltaX < 0), we are revealing RIGHT action (Delete)
            if (deltaX < 0) {
                if (this.rightIcon) {
                    this.rightIcon.style.transform = `scale(${0.5 + 0.5 * progress})`;
                    this.rightIcon.style.opacity = progress;
                }
                if (this.leftIcon) this.leftIcon.style.opacity = 0;
            } else {
                if (this.leftIcon) {
                    this.leftIcon.style.transform = `scale(${0.5 + 0.5 * progress})`;
                    this.leftIcon.style.opacity = progress;
                }
                if (this.rightIcon) this.rightIcon.style.opacity = 0;
            }

            // Haptics at threshold
            if (absDelta > this.threshold && !this.hapticsTriggered) {
                if (window.FingoHaptics && window.FingoHaptics.medium) {
                    window.FingoHaptics.medium();
                } else if (navigator.vibrate) {
                    navigator.vibrate(15);
                }
                this.hapticsTriggered = true;
            } else if (absDelta < this.threshold && this.hapticsTriggered) {
                this.hapticsTriggered = false;
            }
        }

        finalizeSwipe(deltaX) {
            this.content.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            if (deltaX < -this.threshold) {
                // Triggered Left Swipe (Revealed Right Action - Delete)
                // Option: Swipe full to delete OR snap back and ask confirm
                // User requirement: "Swipe Left triggers Delete action". 
                // We'll snap back and call action (classic behave) or let it persist.
                // Let's snap back for now to keep UI clean, or simulate "item disappeared".

                this.content.style.transform = `translateX(-100%)`; // Swipe away effect
                setTimeout(() => {
                    if (this.onRightAction) this.onRightAction();
                    // If action cancelled, we might need to reset. 
                    // But assume deleted. 
                }, 200);

            } else if (deltaX > this.threshold) {
                // Triggered Right Swipe (Revealed Left Action - Edit)
                this.content.style.transform = `translateX(0px)`;
                if (this.onLeftAction) this.onLeftAction();
            } else {
                // Spring back
                this.content.style.transform = 'translateX(0px)';
                if (this.leftIcon) this.leftIcon.style.opacity = 0;
                if (this.rightIcon) this.rightIcon.style.opacity = 0;
            }
        }
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // RENDER ENGINE FOR TRANSACTIONS
    // ─────────────────────────────────────────────────────────────────────────────

    window.renderAppleTransactions = function () {
        const container = document.getElementById('recent-transactions-list');
        if (!container) return;

        // Fetch Data
        let transactions = [];
        if (typeof window.getTransactions === 'function') {
            transactions = window.getTransactions();
        } else if (Array.isArray(window.transactions)) {
            transactions = window.transactions;
        } else {
            try {
                transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            } catch (e) { transactions = []; }
        }

        // Sort & Slice
        transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = transactions.slice(0, 5); // Show top 5

        container.innerHTML = '';

        if (recent.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 text-gray-400">
                    <span class="text-3xl mb-2 opacity-50">📂</span>
                    <p class="text-xs">Henüz işlem yok</p>
                </div>
            `;
            return;
        }

        recent.forEach(t => {
            const el = document.createElement('div');
            el.className = 'apple-swipe-container';

            // Format Amount
            const amt = parseFloat(t.amount).toLocaleString('tr-TR', { minimumFractionDigits: 2 });
            const isExp = t.type === 'expense';
            const sign = isExp ? '-' : '+';

            // Icons
            const categoryIcon = t.icon || (isExp ? '💸' : '💰');

            el.innerHTML = `
                <div class="apple-swipe-actions">
                    <!-- Right Swipe reveals Left Action (Green - Edit) -->
                    <div class="apple-action-left">
                        <div class="apple-swipe-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                            <span>Düzenle</span>
                        </div>
                    </div>
                    
                    <!-- Left Swipe reveals Right Action (Red - Delete) -->
                    <div class="apple-action-right">
                        <div class="apple-swipe-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            <span>Sil</span>
                        </div>
                    </div>
                </div>
                
                <div class="apple-swipe-content apple-transaction-item">
                     <div class="apple-icon-box shadow-sm">
                        ${categoryIcon}
                     </div>
                     <div class="apple-tx-info">
                        <h4 class="apple-tx-title">${t.category || 'İşlem'}</h4>
                        <div class="apple-tx-subtitle">
                             <span class="text-[10px] bg-gray-100 dark:bg-white/10 px-1.5 py-0.5 rounded text-gray-500">${new Date(t.date).toLocaleDateString('tr-TR')}</span>
                             <span>${t.description || ''}</span>
                        </div>
                     </div>
                     <div class="apple-tx-amount ${t.type}">
                        ${sign}${amt} ₺
                     </div>
                </div>
            `;

            container.appendChild(el);

            // Init Swipe Logic
            new AppleSwipeableItem(
                el,
                // Right Action (Delete)
                () => {
                    if (window.confirm('Bu işlemi silmek istediğinize emin misiniz?')) {
                        if (window.deleteTransaction) window.deleteTransaction(t.id);
                        // Re-render handled by event listeners usually
                        // But let's force re-render if needed or rely on listeners
                        setTimeout(window.renderAppleTransactions, 300);
                    } else {
                        // Reset swipe
                        el.querySelector('.apple-swipe-content').style.transform = 'translateX(0)';
                    }
                },
                // Left Action (Edit)
                () => {
                    if (window.editTransaction) window.editTransaction(t.id);
                }
            );
        });
    };

    // Auto Init
    document.addEventListener('DOMContentLoaded', () => {
        // Wait a bit for other scripts to load data
        setTimeout(window.renderAppleTransactions, 500);
    });

    // Listen for global updates
    window.addEventListener('transaction-added', () => setTimeout(window.renderAppleTransactions, 100));
    window.addEventListener('transaction-deleted', () => setTimeout(window.renderAppleTransactions, 100));
    window.addEventListener('transaction-updated', () => setTimeout(window.renderAppleTransactions, 100));
    // Also listen to custom events if they exist
    window.addEventListener('transaction:change', () => setTimeout(window.renderAppleTransactions, 100));

</script>
</body>

</html>